/**!
Copyright Â© 2016-2019 - Convergence Labs, Inc.
@version 1.0.0-rc.5
@license Licensed under the terms of the GNU Lesser General Public License version 3 (GPLv3). See https://www.gnu.org/licenses/lgpl-3.0.html
*/
var Convergence=function(e){var t={};function s(i){if(t[i])return t[i].exports;var n=t[i]={i:i,l:!1,exports:{}};return e[i].call(n.exports,n,n.exports,s),n.l=!0,n.exports}return s.m=e,s.c=t,s.d=function(e,t,i){s.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},s.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"h",{value:!0})},s.t=function(e,t){if(1&t&&(e=s(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.h)return e;var i=Object.create(null);if(s.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)s.d(i,n,function(t){return e[t]}.bind(null,n));return i},s.n=function(e){var t=e&&e.h?function(){return e.default}:function(){return e};return s.d(t,"a",t),t},s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},s.p="",s(s.s=44)}([function(e,t){e.exports=rxjs.operators},function(e,t,s){"use strict";var i,n,r=e.exports=s(2),o=s(16);r.codegen=s(41),r.fetch=s(42),r.path=s(43),r.fs=r.inquire("fs"),r.toArray=function(e){if(e){for(var t=Object.keys(e),s=new Array(t.length),i=0;i<t.length;)s[i]=e[t[i++]];return s}return[]},r.toObject=function(e){for(var t={},s=0;s<e.length;){var i=e[s++],n=e[s++];void 0!==n&&(t[i]=n)}return t};var a=/\\/g,c=/"/g;r.isReserved=function(e){return/^(?:do|if|in|for|let|new|try|var|case|else|enum|eval|false|null|this|true|void|with|break|catch|class|const|super|throw|while|yield|delete|export|import|public|return|static|switch|typeof|default|extends|finally|package|private|continue|debugger|function|arguments|interface|protected|implements|instanceof)$/.test(e)},r.safeProp=function(e){return!/^[$\w_]+$/.test(e)||r.isReserved(e)?'["'+e.replace(a,"\\\\").replace(c,'\\"')+'"]':"."+e},r.ucFirst=function(e){return e.charAt(0).toUpperCase()+e.substring(1)};var h=/_([a-z])/g;r.camelCase=function(e){return e.substring(0,1)+e.substring(1).replace(h,(function(e,t){return t.toUpperCase()}))},r.compareFieldsById=function(e,t){return e.id-t.id},r.decorateType=function(e,t){if(e.$type)return t&&e.$type.name!==t&&(r.decorateRoot.remove(e.$type),e.$type.name=t,r.decorateRoot.add(e.$type)),e.$type;i||(i=s(18));var n=new i(t||e.name);return r.decorateRoot.add(n),n.ctor=e,Object.defineProperty(e,"$type",{value:n,enumerable:!1}),Object.defineProperty(e.prototype,"$type",{value:n,enumerable:!1}),n};var u=0;r.decorateEnum=function(e){if(e.$type)return e.$type;n||(n=s(3));var t=new n("Enum"+u++,e);return r.decorateRoot.add(t),Object.defineProperty(e,"$type",{value:t,enumerable:!1}),t},Object.defineProperty(r,"decorateRoot",{get:function(){return o.decorated||(o.decorated=new(s(26)))}})},function(e,t,s){"use strict";(function(e){var i=t;function n(e,t,s){for(var i=Object.keys(t),n=0;n<i.length;++n)void 0!==e[i[n]]&&s||(e[i[n]]=t[i[n]]);return e}function r(e){function t(e,s){if(!(this instanceof t))return new t(e,s);Object.defineProperty(this,"message",{get:function(){return e}}),Error.captureStackTrace?Error.captureStackTrace(this,t):Object.defineProperty(this,"stack",{value:(new Error).stack||""}),s&&n(this,s)}return(t.prototype=Object.create(Error.prototype)).constructor=t,Object.defineProperty(t.prototype,"name",{get:function(){return e}}),t.prototype.toString=function(){return this.name+": "+this.message},t}i.asPromise=s(13),i.base64=s(32),i.EventEmitter=s(33),i.float=s(34),i.inquire=s(14),i.utf8=s(35),i.pool=s(36),i.LongBits=s(37),i.global="undefined"!=typeof window&&window||void 0!==e&&e||"undefined"!=typeof self&&self||this,i.emptyArray=Object.freeze?Object.freeze([]):[],i.emptyObject=Object.freeze?Object.freeze({}):{},i.isNode=Boolean(i.global.process&&i.global.process.versions&&i.global.process.versions.node),i.isInteger=Number.isInteger||function(e){return"number"==typeof e&&isFinite(e)&&Math.floor(e)===e},i.isString=function(e){return"string"==typeof e||e instanceof String},i.isObject=function(e){return e&&"object"==typeof e},i.isset=i.isSet=function(e,t){var s=e[t];return!(null==s||!e.hasOwnProperty(t))&&("object"!=typeof s||(Array.isArray(s)?s.length:Object.keys(s).length)>0)},i.Buffer=function(){try{var e=i.inquire("buffer").Buffer;return e.prototype.utf8Write?e:null}catch(e){return null}}(),i.u=null,i.g=null,i.newBuffer=function(e){return"number"==typeof e?i.Buffer?i.g(e):new i.Array(e):i.Buffer?i.u(e):"undefined"==typeof Uint8Array?e:new Uint8Array(e)},i.Array="undefined"!=typeof Uint8Array?Uint8Array:Array,i.Long=i.global.dcodeIO&&i.global.dcodeIO.Long||i.global.Long||i.inquire("long"),i.key2Re=/^true|false|0|1$/,i.key32Re=/^-?(?:0|[1-9][0-9]*)$/,i.key64Re=/^(?:[\\x00-\\xff]{8}|-?(?:0|[1-9][0-9]*))$/,i.longToHash=function(e){return e?i.LongBits.from(e).toHash():i.LongBits.zeroHash},i.longFromHash=function(e,t){var s=i.LongBits.fromHash(e);return i.Long?i.Long.fromBits(s.lo,s.hi,t):s.toNumber(Boolean(t))},i.merge=n,i.lcFirst=function(e){return e.charAt(0).toLowerCase()+e.substring(1)},i.newError=r,i.ProtocolError=r("ProtocolError"),i.oneOfGetter=function(e){for(var t={},s=0;s<e.length;++s)t[e[s]]=1;return function(){for(var e=Object.keys(this),s=e.length-1;s>-1;--s)if(1===t[e[s]]&&void 0!==this[e[s]]&&null!==this[e[s]])return e[s]}},i.oneOfSetter=function(e){return function(t){for(var s=0;s<e.length;++s)e[s]!==t&&delete this[e[s]]}},i.toJSONOptions={longs:String,enums:String,bytes:String,json:!0},i.v=function(){var e=i.Buffer;e?(i.u=e.from!==Uint8Array.from&&e.from||function(t,s){return new e(t,s)},i.g=e.allocUnsafe||function(t){return new e(t)}):i.u=i.g=null}}).call(this,s(31))},function(e,t,s){"use strict";e.exports=o;var i=s(5);((o.prototype=Object.create(i.prototype)).constructor=o).className="Enum";var n=s(7),r=s(1);function o(e,t,s,n,r){if(i.call(this,e,s),t&&"object"!=typeof t)throw TypeError("values must be an object");if(this.valuesById={},this.values=Object.create(this.valuesById),this.comment=n,this.comments=r||{},this.reserved=void 0,t)for(var o=Object.keys(t),a=0;a<o.length;++a)"number"==typeof t[o[a]]&&(this.valuesById[this.values[o[a]]=t[o[a]]]=o[a])}o.fromJSON=function(e,t){var s=new o(e,t.values,t.options,t.comment,t.comments);return s.reserved=t.reserved,s},o.prototype.toJSON=function(e){var t=!!e&&Boolean(e.keepComments);return r.toObject(["options",this.options,"values",this.values,"reserved",this.reserved&&this.reserved.length?this.reserved:void 0,"comment",t?this.comment:void 0,"comments",t?this.comments:void 0])},o.prototype.add=function(e,t,s){if(!r.isString(e))throw TypeError("name must be a string");if(!r.isInteger(t))throw TypeError("id must be an integer");if(void 0!==this.values[e])throw Error("duplicate name '"+e+"' in "+this);if(this.isReservedId(t))throw Error("id "+t+" is reserved in "+this);if(this.isReservedName(e))throw Error("name '"+e+"' is reserved in "+this);if(void 0!==this.valuesById[t]){if(!this.options||!this.options.allow_alias)throw Error("duplicate id "+t+" in "+this);this.values[e]=t}else this.valuesById[this.values[e]=t]=e;return this.comments[e]=s||null,this},o.prototype.remove=function(e){if(!r.isString(e))throw TypeError("name must be a string");var t=this.values[e];if(null==t)throw Error("name '"+e+"' does not exist in "+this);return delete this.valuesById[t],delete this.values[e],delete this.comments[e],this},o.prototype.isReservedId=function(e){return n.isReservedId(this.reserved,e)},o.prototype.isReservedName=function(e){return n.isReservedName(this.reserved,e)}},function(e,t){e.exports=rxjs},function(e,t,s){"use strict";e.exports=r,r.className="ReflectionObject";var i,n=s(1);function r(e,t){if(!n.isString(e))throw TypeError("name must be a string");if(t&&!n.isObject(t))throw TypeError("options must be an object");this.options=t,this.name=e,this.parent=null,this.resolved=!1,this.comment=null,this.filename=null}Object.defineProperties(r.prototype,{root:{get:function(){for(var e=this;null!==e.parent;)e=e.parent;return e}},fullName:{get:function(){for(var e=[this.name],t=this.parent;t;)e.unshift(t.name),t=t.parent;return e.join(".")}}}),r.prototype.toJSON=function(){throw Error()},r.prototype.onAdd=function(e){this.parent&&this.parent!==e&&this.parent.remove(this),this.parent=e,this.resolved=!1;var t=e.root;t instanceof i&&t.O(this)},r.prototype.onRemove=function(e){var t=e.root;t instanceof i&&t.R(this),this.parent=null,this.resolved=!1},r.prototype.resolve=function(){return this.resolved?this:(this.root instanceof i&&(this.resolved=!0),this)},r.prototype.getOption=function(e){if(this.options)return this.options[e]},r.prototype.setOption=function(e,t,s){return s&&this.options&&void 0!==this.options[e]||((this.options||(this.options={}))[e]=t),this},r.prototype.setOptions=function(e,t){if(e)for(var s=Object.keys(e),i=0;i<s.length;++i)this.setOption(s[i],e[s[i]],t);return this},r.prototype.toString=function(){var e=this.constructor.className,t=this.fullName;return t.length?e+" "+t:e},r.v=function(e){i=e}},function(e,t,s){"use strict";e.exports=h;var i=s(5);((h.prototype=Object.create(i.prototype)).constructor=h).className="Field";var n,r=s(3),o=s(8),a=s(1),c=/^required|optional|repeated$/;function h(e,t,s,n,r,h,u){if(a.isObject(n)?(u=r,h=n,n=r=void 0):a.isObject(r)&&(u=h,h=r,r=void 0),i.call(this,e,h),!a.isInteger(t)||t<0)throw TypeError("id must be a non-negative integer");if(!a.isString(s))throw TypeError("type must be a string");if(void 0!==n&&!c.test(n=n.toString().toLowerCase()))throw TypeError("rule must be a string rule");if(void 0!==r&&!a.isString(r))throw TypeError("extend must be a string");this.rule=n&&"optional"!==n?n:void 0,this.type=s,this.id=t,this.extend=r||void 0,this.required="required"===n,this.optional=!this.required,this.repeated="repeated"===n,this.map=!1,this.message=null,this.partOf=null,this.typeDefault=null,this.defaultValue=null,this.long=!!a.Long&&void 0!==o.long[s],this.bytes="bytes"===s,this.resolvedType=null,this.extensionField=null,this.declaringField=null,this.M=null,this.comment=u}h.fromJSON=function(e,t){return new h(e,t.id,t.type,t.rule,t.extend,t.options,t.comment)},Object.defineProperty(h.prototype,"packed",{get:function(){return null===this.M&&(this.M=!1!==this.getOption("packed")),this.M}}),h.prototype.setOption=function(e,t,s){return"packed"===e&&(this.M=null),i.prototype.setOption.call(this,e,t,s)},h.prototype.toJSON=function(e){var t=!!e&&Boolean(e.keepComments);return a.toObject(["rule","optional"!==this.rule&&this.rule||void 0,"type",this.type,"id",this.id,"extend",this.extend,"options",this.options,"comment",t?this.comment:void 0])},h.prototype.resolve=function(){if(this.resolved)return this;if(void 0===(this.typeDefault=o.defaults[this.type])&&(this.resolvedType=(this.declaringField?this.declaringField.parent:this.parent).lookupTypeOrEnum(this.type),this.resolvedType instanceof n?this.typeDefault=null:this.typeDefault=this.resolvedType.values[Object.keys(this.resolvedType.values)[0]]),this.options&&null!=this.options.default&&(this.typeDefault=this.options.default,this.resolvedType instanceof r&&"string"==typeof this.typeDefault&&(this.typeDefault=this.resolvedType.values[this.typeDefault])),this.options&&(!0!==this.options.packed&&(void 0===this.options.packed||!this.resolvedType||this.resolvedType instanceof r)||delete this.options.packed,Object.keys(this.options).length||(this.options=void 0)),this.long)this.typeDefault=a.Long.fromNumber(this.typeDefault,"u"===this.type.charAt(0)),Object.freeze&&Object.freeze(this.typeDefault);else if(this.bytes&&"string"==typeof this.typeDefault){var e;a.base64.test(this.typeDefault)?a.base64.decode(this.typeDefault,e=a.newBuffer(a.base64.length(this.typeDefault)),0):a.utf8.write(this.typeDefault,e=a.newBuffer(a.utf8.length(this.typeDefault)),0),this.typeDefault=e}return this.map?this.defaultValue=a.emptyObject:this.repeated?this.defaultValue=a.emptyArray:this.defaultValue=this.typeDefault,this.parent instanceof n&&(this.parent.ctor.prototype[this.name]=this.defaultValue),i.prototype.resolve.call(this)},h.d=function(e,t,s,i){return"function"==typeof t?t=a.decorateType(t).name:t&&"object"==typeof t&&(t=a.decorateEnum(t).name),function(n,r){a.decorateType(n.constructor).add(new h(r,e,t,s,{default:i}))}},h.v=function(e){n=e}},function(e,t,s){"use strict";e.exports=u;var i=s(5);((u.prototype=Object.create(i.prototype)).constructor=u).className="Namespace";var n,r,o,a=s(6),c=s(1);function h(e,t){if(e&&e.length){for(var s={},i=0;i<e.length;++i)s[e[i].name]=e[i].toJSON(t);return s}}function u(e,t){i.call(this,e,t),this.nested=void 0,this.I=null}function d(e){return e.I=null,e}u.fromJSON=function(e,t){return new u(e,t.options).addJSON(t.nested)},u.arrayToJSON=h,u.isReservedId=function(e,t){if(e)for(var s=0;s<e.length;++s)if("string"!=typeof e[s]&&e[s][0]<=t&&e[s][1]>=t)return!0;return!1},u.isReservedName=function(e,t){if(e)for(var s=0;s<e.length;++s)if(e[s]===t)return!0;return!1},Object.defineProperty(u.prototype,"nestedArray",{get:function(){return this.I||(this.I=c.toArray(this.nested))}}),u.prototype.toJSON=function(e){return c.toObject(["options",this.options,"nested",h(this.nestedArray,e)])},u.prototype.addJSON=function(e){if(e)for(var t,s=Object.keys(e),i=0;i<s.length;++i)t=e[s[i]],this.add((void 0!==t.fields?n.fromJSON:void 0!==t.values?o.fromJSON:void 0!==t.methods?r.fromJSON:void 0!==t.id?a.fromJSON:u.fromJSON)(s[i],t));return this},u.prototype.get=function(e){return this.nested&&this.nested[e]||null},u.prototype.getEnum=function(e){if(this.nested&&this.nested[e]instanceof o)return this.nested[e].values;throw Error("no such enum: "+e)},u.prototype.add=function(e){if(!(e instanceof a&&void 0!==e.extend||e instanceof n||e instanceof o||e instanceof r||e instanceof u))throw TypeError("object must be a valid nested object");if(this.nested){var t=this.get(e.name);if(t){if(!(t instanceof u&&e instanceof u)||t instanceof n||t instanceof r)throw Error("duplicate name '"+e.name+"' in "+this);for(var s=t.nestedArray,i=0;i<s.length;++i)e.add(s[i]);this.remove(t),this.nested||(this.nested={}),e.setOptions(t.options,!0)}}else this.nested={};return this.nested[e.name]=e,e.onAdd(this),d(this)},u.prototype.remove=function(e){if(!(e instanceof i))throw TypeError("object must be a ReflectionObject");if(e.parent!==this)throw Error(e+" is not a member of "+this);return delete this.nested[e.name],Object.keys(this.nested).length||(this.nested=void 0),e.onRemove(this),d(this)},u.prototype.define=function(e,t){if(c.isString(e))e=e.split(".");else if(!Array.isArray(e))throw TypeError("illegal path");if(e&&e.length&&""===e[0])throw Error("path must be relative");for(var s=this;e.length>0;){var i=e.shift();if(s.nested&&s.nested[i]){if(!((s=s.nested[i])instanceof u))throw Error("path conflicts with non-namespace objects")}else s.add(s=new u(i))}return t&&s.addJSON(t),s},u.prototype.resolveAll=function(){for(var e=this.nestedArray,t=0;t<e.length;)e[t]instanceof u?e[t++].resolveAll():e[t++].resolve();return this.resolve()},u.prototype.lookup=function(e,t,s){if("boolean"==typeof t?(s=t,t=void 0):t&&!Array.isArray(t)&&(t=[t]),c.isString(e)&&e.length){if("."===e)return this.root;e=e.split(".")}else if(!e.length)return this;if(""===e[0])return this.root.lookup(e.slice(1),t);var i=this.get(e[0]);if(i){if(1===e.length){if(!t||t.indexOf(i.constructor)>-1)return i}else if(i instanceof u&&(i=i.lookup(e.slice(1),t,!0)))return i}else for(var n=0;n<this.nestedArray.length;++n)if(this.I[n]instanceof u&&(i=this.I[n].lookup(e,t,!0)))return i;return null===this.parent||s?null:this.parent.lookup(e,t)},u.prototype.lookupType=function(e){var t=this.lookup(e,[n]);if(!t)throw Error("no such type: "+e);return t},u.prototype.lookupEnum=function(e){var t=this.lookup(e,[o]);if(!t)throw Error("no such Enum '"+e+"' in "+this);return t},u.prototype.lookupTypeOrEnum=function(e){var t=this.lookup(e,[n,o]);if(!t)throw Error("no such Type or Enum '"+e+"' in "+this);return t},u.prototype.lookupService=function(e){var t=this.lookup(e,[r]);if(!t)throw Error("no such Service '"+e+"' in "+this);return t},u.v=function(e,t,s){n=e,r=t,o=s}},function(e,t,s){"use strict";var i=t,n=s(1),r=["double","float","int32","uint32","sint32","fixed32","sfixed32","int64","uint64","sint64","fixed64","sfixed64","bool","string","bytes"];function o(e,t){var s=0,i={};for(t|=0;s<e.length;)i[r[s+t]]=e[s++];return i}i.basic=o([1,5,0,0,0,5,5,0,0,0,1,1,0,2,2]),i.defaults=o([0,0,0,0,0,0,0,0,0,0,0,0,!1,"",n.emptyArray,null]),i.long=o([0,0,0,1,1],7),i.mapKey=o([0,0,0,5,5,0,0,0,1,1,0,2],2),i.packed=o([1,5,0,0,0,5,5,0,0,0,1,1,0])},function(e,t,s){"use strict";e.exports=d;var i,n=s(2),r=n.LongBits,o=n.base64,a=n.utf8;function c(e,t,s){this.fn=e,this.len=t,this.next=void 0,this.val=s}function h(){}function u(e){this.head=e.head,this.tail=e.tail,this.len=e.len,this.next=e.states}function d(){this.len=0,this.head=new c(h,0,0),this.tail=this.head,this.states=null}function l(e,t,s){t[s]=255&e}function p(e,t){this.len=e,this.next=void 0,this.val=t}function f(e,t,s){for(;e.hi;)t[s++]=127&e.lo|128,e.lo=(e.lo>>>7|e.hi<<25)>>>0,e.hi>>>=7;for(;e.lo>127;)t[s++]=127&e.lo|128,e.lo=e.lo>>>7;t[s++]=e.lo}function m(e,t,s){t[s]=255&e,t[s+1]=e>>>8&255,t[s+2]=e>>>16&255,t[s+3]=e>>>24}d.create=n.Buffer?function(){return(d.create=function(){return new i})()}:function(){return new d},d.alloc=function(e){return new n.Array(e)},n.Array!==Array&&(d.alloc=n.pool(d.alloc,n.Array.prototype.subarray)),d.prototype.S=function(e,t,s){return this.tail=this.tail.next=new c(e,t,s),this.len+=t,this},p.prototype=Object.create(c.prototype),p.prototype.fn=function(e,t,s){for(;e>127;)t[s++]=127&e|128,e>>>=7;t[s]=e},d.prototype.uint32=function(e){return this.len+=(this.tail=this.tail.next=new p((e>>>=0)<128?1:e<16384?2:e<2097152?3:e<268435456?4:5,e)).len,this},d.prototype.int32=function(e){return e<0?this.S(f,10,r.fromNumber(e)):this.uint32(e)},d.prototype.sint32=function(e){return this.uint32((e<<1^e>>31)>>>0)},d.prototype.uint64=function(e){var t=r.from(e);return this.S(f,t.length(),t)},d.prototype.int64=d.prototype.uint64,d.prototype.sint64=function(e){var t=r.from(e).zzEncode();return this.S(f,t.length(),t)},d.prototype.bool=function(e){return this.S(l,1,e?1:0)},d.prototype.fixed32=function(e){return this.S(m,4,e>>>0)},d.prototype.sfixed32=d.prototype.fixed32,d.prototype.fixed64=function(e){var t=r.from(e);return this.S(m,4,t.lo).S(m,4,t.hi)},d.prototype.sfixed64=d.prototype.fixed64,d.prototype.float=function(e){return this.S(n.float.writeFloatLE,4,e)},d.prototype.double=function(e){return this.S(n.float.writeDoubleLE,8,e)};var g=n.Array.prototype.set?function(e,t,s){t.set(e,s)}:function(e,t,s){for(var i=0;i<e.length;++i)t[s+i]=e[i]};d.prototype.bytes=function(e){var t=e.length>>>0;if(!t)return this.S(l,1,0);if(n.isString(e)){var s=d.alloc(t=o.length(e));o.decode(e,s,0),e=s}return this.uint32(t).S(g,t,e)},d.prototype.string=function(e){var t=a.length(e);return t?this.uint32(t).S(a.write,t,e):this.S(l,1,0)},d.prototype.fork=function(){return this.states=new u(this),this.head=this.tail=new c(h,0,0),this.len=0,this},d.prototype.reset=function(){return this.states?(this.head=this.states.head,this.tail=this.states.tail,this.len=this.states.len,this.states=this.states.next):(this.head=this.tail=new c(h,0,0),this.len=0),this},d.prototype.ldelim=function(){var e=this.head,t=this.tail,s=this.len;return this.reset().uint32(s),s&&(this.tail.next=e.next,this.tail=t,this.len+=s),this},d.prototype.finish=function(){for(var e=this.head.next,t=this.constructor.alloc(this.len),s=0;e;)e.fn(e.val,t,s),s+=e.len,e=e.next;return t},d.v=function(e){i=e}},function(e,t,s){"use strict";e.exports=c;var i,n=s(2),r=n.LongBits,o=n.utf8;function a(e,t){return RangeError("index out of range: "+e.pos+" + "+(t||1)+" > "+e.len)}function c(e){this.buf=e,this.pos=0,this.len=e.length}var h,u="undefined"!=typeof Uint8Array?function(e){if(e instanceof Uint8Array||Array.isArray(e))return new c(e);throw Error("illegal buffer")}:function(e){if(Array.isArray(e))return new c(e);throw Error("illegal buffer")};function d(){var e=new r(0,0),t=0;if(!(this.len-this.pos>4)){for(;t<3;++t){if(this.pos>=this.len)throw a(this);if(e.lo=(e.lo|(127&this.buf[this.pos])<<7*t)>>>0,this.buf[this.pos++]<128)return e}return e.lo=(e.lo|(127&this.buf[this.pos++])<<7*t)>>>0,e}for(;t<4;++t)if(e.lo=(e.lo|(127&this.buf[this.pos])<<7*t)>>>0,this.buf[this.pos++]<128)return e;if(e.lo=(e.lo|(127&this.buf[this.pos])<<28)>>>0,e.hi=(e.hi|(127&this.buf[this.pos])>>4)>>>0,this.buf[this.pos++]<128)return e;if(t=0,this.len-this.pos>4){for(;t<5;++t)if(e.hi=(e.hi|(127&this.buf[this.pos])<<7*t+3)>>>0,this.buf[this.pos++]<128)return e}else for(;t<5;++t){if(this.pos>=this.len)throw a(this);if(e.hi=(e.hi|(127&this.buf[this.pos])<<7*t+3)>>>0,this.buf[this.pos++]<128)return e}throw Error("invalid varint encoding")}function l(e,t){return(e[t-4]|e[t-3]<<8|e[t-2]<<16|e[t-1]<<24)>>>0}function p(){if(this.pos+8>this.len)throw a(this,8);return new r(l(this.buf,this.pos+=4),l(this.buf,this.pos+=4))}c.create=n.Buffer?function(e){return(c.create=function(e){return n.Buffer.isBuffer(e)?new i(e):u(e)})(e)}:u,c.prototype.C=n.Array.prototype.subarray||n.Array.prototype.slice,c.prototype.uint32=(h=4294967295,function(){if(h=(127&this.buf[this.pos])>>>0,this.buf[this.pos++]<128)return h;if(h=(h|(127&this.buf[this.pos])<<7)>>>0,this.buf[this.pos++]<128)return h;if(h=(h|(127&this.buf[this.pos])<<14)>>>0,this.buf[this.pos++]<128)return h;if(h=(h|(127&this.buf[this.pos])<<21)>>>0,this.buf[this.pos++]<128)return h;if(h=(h|(15&this.buf[this.pos])<<28)>>>0,this.buf[this.pos++]<128)return h;if((this.pos+=5)>this.len)throw this.pos=this.len,a(this,10);return h}),c.prototype.int32=function(){return 0|this.uint32()},c.prototype.sint32=function(){var e=this.uint32();return e>>>1^-(1&e)|0},c.prototype.bool=function(){return 0!==this.uint32()},c.prototype.fixed32=function(){if(this.pos+4>this.len)throw a(this,4);return l(this.buf,this.pos+=4)},c.prototype.sfixed32=function(){if(this.pos+4>this.len)throw a(this,4);return 0|l(this.buf,this.pos+=4)},c.prototype.float=function(){if(this.pos+4>this.len)throw a(this,4);var e=n.float.readFloatLE(this.buf,this.pos);return this.pos+=4,e},c.prototype.double=function(){if(this.pos+8>this.len)throw a(this,4);var e=n.float.readDoubleLE(this.buf,this.pos);return this.pos+=8,e},c.prototype.bytes=function(){var e=this.uint32(),t=this.pos,s=this.pos+e;if(s>this.len)throw a(this,e);return this.pos+=e,Array.isArray(this.buf)?this.buf.slice(t,s):t===s?new this.buf.constructor(0):this.C.call(this.buf,t,s)},c.prototype.string=function(){var e=this.bytes();return o.read(e,0,e.length)},c.prototype.skip=function(e){if("number"==typeof e){if(this.pos+e>this.len)throw a(this,e);this.pos+=e}else do{if(this.pos>=this.len)throw a(this)}while(128&this.buf[this.pos++]);return this},c.prototype.skipType=function(e){switch(e){case 0:this.skip();break;case 1:this.skip(8);break;case 2:this.skip(this.uint32());break;case 3:for(;4!=(e=7&this.uint32());)this.skipType(e);break;case 5:this.skip(4);break;default:throw Error("invalid wire type "+e+" at offset "+this.pos)}return this},c.v=function(e){i=e;var t=n.Long?"toLong":"toNumber";n.merge(c.prototype,{int64:function(){return d.call(this)[t](!1)},uint64:function(){return d.call(this)[t](!0)},sint64:function(){return d.call(this).zzDecode()[t](!1)},fixed64:function(){return p.call(this)[t](!0)},sfixed64:function(){return p.call(this)[t](!1)}})}},function(e,t,s){"use strict";e.exports=o;var i=s(5);((o.prototype=Object.create(i.prototype)).constructor=o).className="OneOf";var n=s(6),r=s(1);function o(e,t,s,n){if(Array.isArray(t)||(s=t,t=void 0),i.call(this,e,s),void 0!==t&&!Array.isArray(t))throw TypeError("fieldNames must be an Array");this.oneof=t||[],this.fieldsArray=[],this.comment=n}function a(e){if(e.parent)for(var t=0;t<e.fieldsArray.length;++t)e.fieldsArray[t].parent||e.parent.add(e.fieldsArray[t])}o.fromJSON=function(e,t){return new o(e,t.oneof,t.options,t.comment)},o.prototype.toJSON=function(e){var t=!!e&&Boolean(e.keepComments);return r.toObject(["options",this.options,"oneof",this.oneof,"comment",t?this.comment:void 0])},o.prototype.add=function(e){if(!(e instanceof n))throw TypeError("field must be a Field");return e.parent&&e.parent!==this.parent&&e.parent.remove(e),this.oneof.push(e.name),this.fieldsArray.push(e),e.partOf=this,a(this),this},o.prototype.remove=function(e){if(!(e instanceof n))throw TypeError("field must be a Field");var t=this.fieldsArray.indexOf(e);if(t<0)throw Error(e+" is not a member of "+this);return this.fieldsArray.splice(t,1),(t=this.oneof.indexOf(e.name))>-1&&this.oneof.splice(t,1),e.partOf=null,this},o.prototype.onAdd=function(e){i.prototype.onAdd.call(this,e);for(var t=0;t<this.oneof.length;++t){var s=e.get(this.oneof[t]);s&&!s.partOf&&(s.partOf=this,this.fieldsArray.push(s))}a(this)},o.prototype.onRemove=function(e){for(var t,s=0;s<this.fieldsArray.length;++s)(t=this.fieldsArray[s]).parent&&t.parent.remove(t);i.prototype.onRemove.call(this,e)},o.d=function(){for(var e=new Array(arguments.length),t=0;t<arguments.length;)e[t]=arguments[t++];return function(t,s){r.decorateType(t.constructor).add(new o(s,e)),Object.defineProperty(t,s,{get:r.oneOfGetter(e),set:r.oneOfSetter(e)})}}},function(e,t,s){"use strict";e.exports=n;var i=s(2);function n(e){if(e)for(var t=Object.keys(e),s=0;s<t.length;++s)this[t[s]]=e[t[s]]}n.create=function(e){return this.$type.create(e)},n.encode=function(e,t){return this.$type.encode(e,t)},n.encodeDelimited=function(e,t){return this.$type.encodeDelimited(e,t)},n.decode=function(e){return this.$type.decode(e)},n.decodeDelimited=function(e){return this.$type.decodeDelimited(e)},n.verify=function(e){return this.$type.verify(e)},n.fromObject=function(e){return this.$type.fromObject(e)},n.toObject=function(e,t){return this.$type.toObject(e,t)},n.prototype.toJSON=function(){return this.$type.toObject(this,i.toJSONOptions)}},function(e,t,s){"use strict";e.exports=function(e,t){var s=new Array(arguments.length-1),i=0,n=2,r=!0;for(;n<arguments.length;)s[i++]=arguments[n++];return new Promise((function(n,o){s[i]=function(e){if(r)if(r=!1,e)o(e);else{for(var t=new Array(arguments.length-1),s=0;s<t.length;)t[s++]=arguments[s];n.apply(null,t)}};try{e.apply(t||null,s)}catch(e){r&&(r=!1,o(e))}}))}},function(module,exports,__webpack_require__){"use strict";function inquire(moduleName){try{var mod=eval("quire".replace(/^/,"re"))(moduleName);if(mod&&(mod.length||Object.keys(mod).length))return mod}catch(e){}return null}module.exports=inquire},function(e,t,s){"use strict";t.Service=s(40)},function(e,t,s){"use strict";e.exports={}},function(e,t,s){"use strict";e.exports=function(e){for(var t,s=r.codegen(["m","w"],e.name+"$encode")("if(!w)")("w=Writer.create()"),a=e.fieldsArray.slice().sort(r.compareFieldsById),c=0;c<a.length;++c){var h=a[c].resolve(),u=e.D.indexOf(h),d=h.resolvedType instanceof i?"int32":h.type,l=n.basic[d];t="m"+r.safeProp(h.name),h.map?(s("if(%s!=null&&m.hasOwnProperty(%j)){",t,h.name)("for(var ks=Object.keys(%s),i=0;i<ks.length;++i){",t)("w.uint32(%i).fork().uint32(%i).%s(ks[i])",(h.id<<3|2)>>>0,8|n.mapKey[h.keyType],h.keyType),void 0===l?s("types[%i].encode(%s[ks[i]],w.uint32(18).fork()).ldelim().ldelim()",u,t):s(".uint32(%i).%s(%s[ks[i]]).ldelim()",16|l,d,t),s("}")("}")):h.repeated?(s("if(%s!=null&&%s.length){",t,t),h.packed&&void 0!==n.packed[d]?s("w.uint32(%i).fork()",(h.id<<3|2)>>>0)("for(var i=0;i<%s.length;++i)",t)("w.%s(%s[i])",d,t)("w.ldelim()"):(s("for(var i=0;i<%s.length;++i)",t),void 0===l?o(s,h,u,t+"[i]"):s("w.uint32(%i).%s(%s[i])",(h.id<<3|l)>>>0,d,t)),s("}")):(h.optional&&s("if(%s!=null&&m.hasOwnProperty(%j))",t,h.name),void 0===l?o(s,h,u,t):s("w.uint32(%i).%s(%s)",(h.id<<3|l)>>>0,d,t))}return s("return w")};var i=s(3),n=s(8),r=s(1);function o(e,t,s,i){return t.resolvedType.group?e("types[%i].encode(%s,w.uint32(%i)).uint32(%i)",s,i,(t.id<<3|3)>>>0,(t.id<<3|4)>>>0):e("types[%i].encode(%s,w.uint32(%i).fork()).ldelim()",s,i,(t.id<<3|2)>>>0)}},function(e,t,s){"use strict";e.exports=y;var i=s(7);((y.prototype=Object.create(i.prototype)).constructor=y).className="Type";var n=s(3),r=s(11),o=s(6),a=s(19),c=s(20),h=s(12),u=s(10),d=s(9),l=s(1),p=s(17),f=s(22),m=s(23),g=s(24),v=s(25);function y(e,t){i.call(this,e,t),this.fields={},this.oneofs=void 0,this.extensions=void 0,this.reserved=void 0,this.group=void 0,this._=null,this.D=null,this.P=null,this.A=null}function w(e){return e._=e.D=e.P=null,delete e.encode,delete e.decode,delete e.verify,e}Object.defineProperties(y.prototype,{fieldsById:{get:function(){if(this._)return this._;this._={};for(var e=Object.keys(this.fields),t=0;t<e.length;++t){var s=this.fields[e[t]],i=s.id;if(this._[i])throw Error("duplicate id "+i+" in "+this);this._[i]=s}return this._}},fieldsArray:{get:function(){return this.D||(this.D=l.toArray(this.fields))}},oneofsArray:{get:function(){return this.P||(this.P=l.toArray(this.oneofs))}},ctor:{get:function(){return this.A||(this.ctor=y.generateConstructor(this)())},set:function(e){var t=e.prototype;t instanceof h||((e.prototype=new h).constructor=e,l.merge(e.prototype,t)),e.$type=e.prototype.$type=this,l.merge(e,h,!0),this.A=e;for(var s=0;s<this.fieldsArray.length;++s)this.D[s].resolve();var i={};for(s=0;s<this.oneofsArray.length;++s)i[this.P[s].resolve().name]={get:l.oneOfGetter(this.P[s].oneof),set:l.oneOfSetter(this.P[s].oneof)};s&&Object.defineProperties(e.prototype,i)}}}),y.generateConstructor=function(e){for(var t,s=l.codegen(["p"],e.name),i=0;i<e.fieldsArray.length;++i)(t=e.D[i]).map?s("this%s={}",l.safeProp(t.name)):t.repeated&&s("this%s=[]",l.safeProp(t.name));return s("if(p)for(var ks=Object.keys(p),i=0;i<ks.length;++i)if(p[ks[i]]!=null)")("this[ks[i]]=p[ks[i]]")},y.fromJSON=function(e,t){var s=new y(e,t.options);s.extensions=t.extensions,s.reserved=t.reserved;for(var h=Object.keys(t.fields),u=0;u<h.length;++u)s.add((void 0!==t.fields[h[u]].keyType?a.fromJSON:o.fromJSON)(h[u],t.fields[h[u]]));if(t.oneofs)for(h=Object.keys(t.oneofs),u=0;u<h.length;++u)s.add(r.fromJSON(h[u],t.oneofs[h[u]]));if(t.nested)for(h=Object.keys(t.nested),u=0;u<h.length;++u){var d=t.nested[h[u]];s.add((void 0!==d.id?o.fromJSON:void 0!==d.fields?y.fromJSON:void 0!==d.values?n.fromJSON:void 0!==d.methods?c.fromJSON:i.fromJSON)(h[u],d))}return t.extensions&&t.extensions.length&&(s.extensions=t.extensions),t.reserved&&t.reserved.length&&(s.reserved=t.reserved),t.group&&(s.group=!0),t.comment&&(s.comment=t.comment),s},y.prototype.toJSON=function(e){var t=i.prototype.toJSON.call(this,e),s=!!e&&Boolean(e.keepComments);return l.toObject(["options",t&&t.options||void 0,"oneofs",i.arrayToJSON(this.oneofsArray,e),"fields",i.arrayToJSON(this.fieldsArray.filter((function(e){return!e.declaringField})),e)||{},"extensions",this.extensions&&this.extensions.length?this.extensions:void 0,"reserved",this.reserved&&this.reserved.length?this.reserved:void 0,"group",this.group||void 0,"nested",t&&t.nested||void 0,"comment",s?this.comment:void 0])},y.prototype.resolveAll=function(){for(var e=this.fieldsArray,t=0;t<e.length;)e[t++].resolve();var s=this.oneofsArray;for(t=0;t<s.length;)s[t++].resolve();return i.prototype.resolveAll.call(this)},y.prototype.get=function(e){return this.fields[e]||this.oneofs&&this.oneofs[e]||this.nested&&this.nested[e]||null},y.prototype.add=function(e){if(this.get(e.name))throw Error("duplicate name '"+e.name+"' in "+this);if(e instanceof o&&void 0===e.extend){if(this._?this._[e.id]:this.fieldsById[e.id])throw Error("duplicate id "+e.id+" in "+this);if(this.isReservedId(e.id))throw Error("id "+e.id+" is reserved in "+this);if(this.isReservedName(e.name))throw Error("name '"+e.name+"' is reserved in "+this);return e.parent&&e.parent.remove(e),this.fields[e.name]=e,e.message=this,e.onAdd(this),w(this)}return e instanceof r?(this.oneofs||(this.oneofs={}),this.oneofs[e.name]=e,e.onAdd(this),w(this)):i.prototype.add.call(this,e)},y.prototype.remove=function(e){if(e instanceof o&&void 0===e.extend){if(!this.fields||this.fields[e.name]!==e)throw Error(e+" is not a member of "+this);return delete this.fields[e.name],e.parent=null,e.onRemove(this),w(this)}if(e instanceof r){if(!this.oneofs||this.oneofs[e.name]!==e)throw Error(e+" is not a member of "+this);return delete this.oneofs[e.name],e.parent=null,e.onRemove(this),w(this)}return i.prototype.remove.call(this,e)},y.prototype.isReservedId=function(e){return i.isReservedId(this.reserved,e)},y.prototype.isReservedName=function(e){return i.isReservedName(this.reserved,e)},y.prototype.create=function(e){return new this.ctor(e)},y.prototype.setup=function(){for(var e=this.fullName,t=[],s=0;s<this.fieldsArray.length;++s)t.push(this.D[s].resolve().resolvedType);this.encode=p(this)({Writer:d,types:t,util:l}),this.decode=f(this)({Reader:u,types:t,util:l}),this.verify=m(this)({types:t,util:l}),this.fromObject=g.fromObject(this)({types:t,util:l}),this.toObject=g.toObject(this)({types:t,util:l});var i=v[e];if(i){var n=Object.create(this);n.fromObject=this.fromObject,this.fromObject=i.fromObject.bind(n),n.toObject=this.toObject,this.toObject=i.toObject.bind(n)}return this},y.prototype.encode=function(e,t){return this.setup().encode(e,t)},y.prototype.encodeDelimited=function(e,t){return this.encode(e,t&&t.len?t.fork():t).ldelim()},y.prototype.decode=function(e,t){return this.setup().decode(e,t)},y.prototype.decodeDelimited=function(e){return e instanceof u||(e=u.create(e)),this.decode(e,e.uint32())},y.prototype.verify=function(e){return this.setup().verify(e)},y.prototype.fromObject=function(e){return this.setup().fromObject(e)},y.prototype.toObject=function(e,t){return this.setup().toObject(e,t)},y.d=function(e){return function(t){l.decorateType(t,e)}}},function(e,t,s){"use strict";e.exports=o;var i=s(6);((o.prototype=Object.create(i.prototype)).constructor=o).className="MapField";var n=s(8),r=s(1);function o(e,t,s,n,o,a){if(i.call(this,e,t,n,void 0,void 0,o,a),!r.isString(s))throw TypeError("keyType must be a string");this.keyType=s,this.resolvedKeyType=null,this.map=!0}o.fromJSON=function(e,t){return new o(e,t.id,t.keyType,t.type,t.options,t.comment)},o.prototype.toJSON=function(e){var t=!!e&&Boolean(e.keepComments);return r.toObject(["keyType",this.keyType,"type",this.type,"id",this.id,"extend",this.extend,"options",this.options,"comment",t?this.comment:void 0])},o.prototype.resolve=function(){if(this.resolved)return this;if(void 0===n.mapKey[this.keyType])throw Error("invalid key type: "+this.keyType);return i.prototype.resolve.call(this)},o.d=function(e,t,s){return"function"==typeof s?s=r.decorateType(s).name:s&&"object"==typeof s&&(s=r.decorateEnum(s).name),function(i,n){r.decorateType(i.constructor).add(new o(n,e,t,s))}}},function(e,t,s){"use strict";e.exports=a;var i=s(7);((a.prototype=Object.create(i.prototype)).constructor=a).className="Service";var n=s(21),r=s(1),o=s(15);function a(e,t){i.call(this,e,t),this.methods={},this.T=null}function c(e){return e.T=null,e}a.fromJSON=function(e,t){var s=new a(e,t.options);if(t.methods)for(var i=Object.keys(t.methods),r=0;r<i.length;++r)s.add(n.fromJSON(i[r],t.methods[i[r]]));return t.nested&&s.addJSON(t.nested),s.comment=t.comment,s},a.prototype.toJSON=function(e){var t=i.prototype.toJSON.call(this,e),s=!!e&&Boolean(e.keepComments);return r.toObject(["options",t&&t.options||void 0,"methods",i.arrayToJSON(this.methodsArray,e)||{},"nested",t&&t.nested||void 0,"comment",s?this.comment:void 0])},Object.defineProperty(a.prototype,"methodsArray",{get:function(){return this.T||(this.T=r.toArray(this.methods))}}),a.prototype.get=function(e){return this.methods[e]||i.prototype.get.call(this,e)},a.prototype.resolveAll=function(){for(var e=this.methodsArray,t=0;t<e.length;++t)e[t].resolve();return i.prototype.resolve.call(this)},a.prototype.add=function(e){if(this.get(e.name))throw Error("duplicate name '"+e.name+"' in "+this);return e instanceof n?(this.methods[e.name]=e,e.parent=this,c(this)):i.prototype.add.call(this,e)},a.prototype.remove=function(e){if(e instanceof n){if(this.methods[e.name]!==e)throw Error(e+" is not a member of "+this);return delete this.methods[e.name],e.parent=null,c(this)}return i.prototype.remove.call(this,e)},a.prototype.create=function(e,t,s){for(var i,n=new o.Service(e,t,s),a=0;a<this.methodsArray.length;++a){var c=r.lcFirst((i=this.T[a]).resolve().name).replace(/[^$\w_]/g,"");n[c]=r.codegen(["r","c"],r.isReserved(c)?c+"_":c)("return this.rpcCall(m,q,s,r,c)")({m:i,q:i.resolvedRequestType.ctor,s:i.resolvedResponseType.ctor})}return n}},function(e,t,s){"use strict";e.exports=r;var i=s(5);((r.prototype=Object.create(i.prototype)).constructor=r).className="Method";var n=s(1);function r(e,t,s,r,o,a,c,h){if(n.isObject(o)?(c=o,o=a=void 0):n.isObject(a)&&(c=a,a=void 0),void 0!==t&&!n.isString(t))throw TypeError("type must be a string");if(!n.isString(s))throw TypeError("requestType must be a string");if(!n.isString(r))throw TypeError("responseType must be a string");i.call(this,e,c),this.type=t||"rpc",this.requestType=s,this.requestStream=!!o||void 0,this.responseType=r,this.responseStream=!!a||void 0,this.resolvedRequestType=null,this.resolvedResponseType=null,this.comment=h}r.fromJSON=function(e,t){return new r(e,t.type,t.requestType,t.responseType,t.requestStream,t.responseStream,t.options,t.comment)},r.prototype.toJSON=function(e){var t=!!e&&Boolean(e.keepComments);return n.toObject(["type","rpc"!==this.type&&this.type||void 0,"requestType",this.requestType,"requestStream",this.requestStream,"responseType",this.responseType,"responseStream",this.responseStream,"options",this.options,"comment",t?this.comment:void 0])},r.prototype.resolve=function(){return this.resolved?this:(this.resolvedRequestType=this.parent.lookupType(this.requestType),this.resolvedResponseType=this.parent.lookupType(this.responseType),i.prototype.resolve.call(this))}},function(e,t,s){"use strict";e.exports=function(e){var t=r.codegen(["r","l"],e.name+"$decode")("if(!(r instanceof Reader))")("r=Reader.create(r)")("var c=l===undefined?r.len:r.pos+l,m=new this.ctor"+(e.fieldsArray.filter((function(e){return e.map})).length?",k":""))("while(r.pos<c){")("var t=r.uint32()");e.group&&t("if((t&7)===4)")("break");t("switch(t>>>3){");for(var s=0;s<e.fieldsArray.length;++s){var a=e.D[s].resolve(),c=a.resolvedType instanceof i?"int32":a.type,h="m"+r.safeProp(a.name);t("case %i:",a.id),a.map?(t("r.skip().pos++")("if(%s===util.emptyObject)",h)("%s={}",h)("k=r.%s()",a.keyType)("r.pos++"),void 0!==n.long[a.keyType]?void 0===n.basic[c]?t('%s[typeof k==="object"?util.longToHash(k):k]=types[%i].decode(r,r.uint32())',h,s):t('%s[typeof k==="object"?util.longToHash(k):k]=r.%s()',h,c):void 0===n.basic[c]?t("%s[k]=types[%i].decode(r,r.uint32())",h,s):t("%s[k]=r.%s()",h,c)):a.repeated?(t("if(!(%s&&%s.length))",h,h)("%s=[]",h),void 0!==n.packed[c]&&t("if((t&7)===2){")("var c2=r.uint32()+r.pos")("while(r.pos<c2)")("%s.push(r.%s())",h,c)("}else"),void 0===n.basic[c]?t(a.resolvedType.group?"%s.push(types[%i].decode(r))":"%s.push(types[%i].decode(r,r.uint32()))",h,s):t("%s.push(r.%s())",h,c)):void 0===n.basic[c]?t(a.resolvedType.group?"%s=types[%i].decode(r)":"%s=types[%i].decode(r,r.uint32())",h,s):t("%s=r.%s()",h,c),t("break")}for(t("default:")("r.skipType(t&7)")("break")("}")("}"),s=0;s<e.D.length;++s){var u=e.D[s];u.required&&t("if(!m.hasOwnProperty(%j))",u.name)("throw util.ProtocolError(%j,{instance:m})",o(u))}return t("return m")};var i=s(3),n=s(8),r=s(1);function o(e){return"missing required '"+e.name+"'"}},function(e,t,s){"use strict";e.exports=function(e){var t=n.codegen(["m"],e.name+"$verify")('if(typeof m!=="object"||m===null)')("return%j","object expected"),s=e.oneofsArray,i={};s.length&&t("var p={}");for(var c=0;c<e.fieldsArray.length;++c){var h=e.D[c].resolve(),u="m"+n.safeProp(h.name);if(h.optional&&t("if(%s!=null&&m.hasOwnProperty(%j)){",u,h.name),h.map)t("if(!util.isObject(%s))",u)("return%j",r(h,"object"))("var k=Object.keys(%s)",u)("for(var i=0;i<k.length;++i){"),a(t,h,"k[i]"),o(t,h,c,u+"[k[i]]")("}");else if(h.repeated)t("if(!Array.isArray(%s))",u)("return%j",r(h,"array"))("for(var i=0;i<%s.length;++i){",u),o(t,h,c,u+"[i]")("}");else{if(h.partOf){var d=n.safeProp(h.partOf.name);1===i[h.partOf.name]&&t("if(p%s===1)",d)("return%j",h.partOf.name+": multiple values"),i[h.partOf.name]=1,t("p%s=1",d)}o(t,h,c,u)}h.optional&&t("}")}return t("return null")};var i=s(3),n=s(1);function r(e,t){return e.name+": "+t+(e.repeated&&"array"!==t?"[]":e.map&&"object"!==t?"{k:"+e.keyType+"}":"")+" expected"}function o(e,t,s,n){if(t.resolvedType)if(t.resolvedType instanceof i){e("switch(%s){",n)("default:")("return%j",r(t,"enum value"));for(var o=Object.keys(t.resolvedType.values),a=0;a<o.length;++a)e("case %i:",t.resolvedType.values[o[a]]);e("break")("}")}else e("{")("var e=types[%i].verify(%s);",s,n)("if(e)")("return%j+e",t.name+".")("}");else switch(t.type){case"int32":case"uint32":case"sint32":case"fixed32":case"sfixed32":e("if(!util.isInteger(%s))",n)("return%j",r(t,"integer"));break;case"int64":case"uint64":case"sint64":case"fixed64":case"sfixed64":e("if(!util.isInteger(%s)&&!(%s&&util.isInteger(%s.low)&&util.isInteger(%s.high)))",n,n,n,n)("return%j",r(t,"integer|Long"));break;case"float":case"double":e('if(typeof %s!=="number")',n)("return%j",r(t,"number"));break;case"bool":e('if(typeof %s!=="boolean")',n)("return%j",r(t,"boolean"));break;case"string":e("if(!util.isString(%s))",n)("return%j",r(t,"string"));break;case"bytes":e('if(!(%s&&typeof %s.length==="number"||util.isString(%s)))',n,n,n)("return%j",r(t,"buffer"))}return e}function a(e,t,s){switch(t.keyType){case"int32":case"uint32":case"sint32":case"fixed32":case"sfixed32":e("if(!util.key32Re.test(%s))",s)("return%j",r(t,"integer key"));break;case"int64":case"uint64":case"sint64":case"fixed64":case"sfixed64":e("if(!util.key64Re.test(%s))",s)("return%j",r(t,"integer|Long key"));break;case"bool":e("if(!util.key2Re.test(%s))",s)("return%j",r(t,"boolean key"))}return e}},function(e,t,s){"use strict";var i=t,n=s(3),r=s(1);function o(e,t,s,i){if(t.resolvedType)if(t.resolvedType instanceof n){e("switch(d%s){",i);for(var r=t.resolvedType.values,o=Object.keys(r),a=0;a<o.length;++a)t.repeated&&r[o[a]]===t.typeDefault&&e("default:"),e("case%j:",o[a])("case %i:",r[o[a]])("m%s=%j",i,r[o[a]])("break");e("}")}else e('if(typeof d%s!=="object")',i)("throw TypeError(%j)",t.fullName+": object expected")("m%s=types[%i].fromObject(d%s)",i,s,i);else{var c=!1;switch(t.type){case"double":case"float":e("m%s=Number(d%s)",i,i);break;case"uint32":case"fixed32":e("m%s=d%s>>>0",i,i);break;case"int32":case"sint32":case"sfixed32":e("m%s=d%s|0",i,i);break;case"uint64":c=!0;case"int64":case"sint64":case"fixed64":case"sfixed64":e("if(util.Long)")("(m%s=util.Long.fromValue(d%s)).unsigned=%j",i,i,c)('else if(typeof d%s==="string")',i)("m%s=parseInt(d%s,10)",i,i)('else if(typeof d%s==="number")',i)("m%s=d%s",i,i)('else if(typeof d%s==="object")',i)("m%s=new util.LongBits(d%s.low>>>0,d%s.high>>>0).toNumber(%s)",i,i,i,c?"true":"");break;case"bytes":e('if(typeof d%s==="string")',i)("util.base64.decode(d%s,m%s=util.newBuffer(util.base64.length(d%s)),0)",i,i,i)("else if(d%s.length)",i)("m%s=d%s",i,i);break;case"string":e("m%s=String(d%s)",i,i);break;case"bool":e("m%s=Boolean(d%s)",i,i)}}return e}function a(e,t,s,i){if(t.resolvedType)t.resolvedType instanceof n?e("d%s=o.enums===String?types[%i].values[m%s]:m%s",i,s,i,i):e("d%s=types[%i].toObject(m%s,o)",i,s,i);else{var r=!1;switch(t.type){case"double":case"float":e("d%s=o.json&&!isFinite(m%s)?String(m%s):m%s",i,i,i,i);break;case"uint64":r=!0;case"int64":case"sint64":case"fixed64":case"sfixed64":e('if(typeof m%s==="number")',i)("d%s=o.longs===String?String(m%s):m%s",i,i,i)("else")("d%s=o.longs===String?util.Long.prototype.toString.call(m%s):o.longs===Number?new util.LongBits(m%s.low>>>0,m%s.high>>>0).toNumber(%s):m%s",i,i,i,i,r?"true":"",i);break;case"bytes":e("d%s=o.bytes===String?util.base64.encode(m%s,0,m%s.length):o.bytes===Array?Array.prototype.slice.call(m%s):m%s",i,i,i,i,i);break;default:e("d%s=m%s",i,i)}}return e}i.fromObject=function(e){var t=e.fieldsArray,s=r.codegen(["d"],e.name+"$fromObject")("if(d instanceof this.ctor)")("return d");if(!t.length)return s("return new this.ctor");s("var m=new this.ctor");for(var i=0;i<t.length;++i){var a=t[i].resolve(),c=r.safeProp(a.name);a.map?(s("if(d%s){",c)('if(typeof d%s!=="object")',c)("throw TypeError(%j)",a.fullName+": object expected")("m%s={}",c)("for(var ks=Object.keys(d%s),i=0;i<ks.length;++i){",c),o(s,a,i,c+"[ks[i]]")("}")("}")):a.repeated?(s("if(d%s){",c)("if(!Array.isArray(d%s))",c)("throw TypeError(%j)",a.fullName+": array expected")("m%s=[]",c)("for(var i=0;i<d%s.length;++i){",c),o(s,a,i,c+"[i]")("}")("}")):(a.resolvedType instanceof n||s("if(d%s!=null){",c),o(s,a,i,c),a.resolvedType instanceof n||s("}"))}return s("return m")},i.toObject=function(e){var t=e.fieldsArray.slice().sort(r.compareFieldsById);if(!t.length)return r.codegen()("return {}");for(var s=r.codegen(["m","o"],e.name+"$toObject")("if(!o)")("o={}")("var d={}"),i=[],o=[],c=[],h=0;h<t.length;++h)t[h].partOf||(t[h].resolve().repeated?i:t[h].map?o:c).push(t[h]);if(i.length){for(s("if(o.arrays||o.defaults){"),h=0;h<i.length;++h)s("d%s=[]",r.safeProp(i[h].name));s("}")}if(o.length){for(s("if(o.objects||o.defaults){"),h=0;h<o.length;++h)s("d%s={}",r.safeProp(o[h].name));s("}")}if(c.length){for(s("if(o.defaults){"),h=0;h<c.length;++h){var u=c[h],d=r.safeProp(u.name);if(u.resolvedType instanceof n)s("d%s=o.enums===String?%j:%j",d,u.resolvedType.valuesById[u.typeDefault],u.typeDefault);else if(u.long)s("if(util.Long){")("var n=new util.Long(%i,%i,%j)",u.typeDefault.low,u.typeDefault.high,u.typeDefault.unsigned)("d%s=o.longs===String?n.toString():o.longs===Number?n.toNumber():n",d)("}else")("d%s=o.longs===String?%j:%i",d,u.typeDefault.toString(),u.typeDefault.toNumber());else if(u.bytes){var l="["+Array.prototype.slice.call(u.typeDefault).join(",")+"]";s("if(o.bytes===String)d%s=%j",d,String.fromCharCode.apply(String,u.typeDefault))("else{")("d%s=%s",d,l)("if(o.bytes!==Array)d%s=util.newBuffer(d%s)",d,d)("}")}else s("d%s=%j",d,u.typeDefault)}s("}")}var p=!1;for(h=0;h<t.length;++h){u=t[h];var f=e.D.indexOf(u);d=r.safeProp(u.name);u.map?(p||(p=!0,s("var ks2")),s("if(m%s&&(ks2=Object.keys(m%s)).length){",d,d)("d%s={}",d)("for(var j=0;j<ks2.length;++j){"),a(s,u,f,d+"[ks2[j]]")("}")):u.repeated?(s("if(m%s&&m%s.length){",d,d)("d%s=[]",d)("for(var j=0;j<m%s.length;++j){",d),a(s,u,f,d+"[j]")("}")):(s("if(m%s!=null&&m.hasOwnProperty(%j)){",d,u.name),a(s,u,f,d),u.partOf&&s("if(o.oneofs)")("d%s=%j",r.safeProp(u.partOf.name),u.name)),s("}")}return s("return d")}},function(e,t,s){"use strict";var i=t,n=s(12);i[".google.protobuf.Any"]={fromObject:function(e){if(e&&e["@type"]){var t=this.lookup(e["@type"]);if(t){var s="."===e["@type"].charAt(0)?e["@type"].substr(1):e["@type"];return this.create({type_url:"/"+s,value:t.encode(t.fromObject(e)).finish()})}}return this.fromObject(e)},toObject:function(e,t){if(t&&t.json&&e.type_url&&e.value){var s=e.type_url.substring(e.type_url.lastIndexOf("/")+1),i=this.lookup(s);i&&(e=i.decode(e.value))}if(!(e instanceof this.ctor)&&e instanceof n){var r=e.$type.toObject(e,t);return r["@type"]=e.$type.fullName,r}return this.toObject(e,t)}}},function(e,t,s){"use strict";e.exports=d;var i=s(7);((d.prototype=Object.create(i.prototype)).constructor=d).className="Root";var n,r,o,a=s(6),c=s(3),h=s(11),u=s(1);function d(e){i.call(this,"",e),this.deferred=[],this.files=[]}function l(){}d.fromJSON=function(e,t){return t||(t=new d),e.options&&t.setOptions(e.options),t.addJSON(e.nested)},d.prototype.resolvePath=u.path.resolve,d.prototype.load=function e(t,s,i){"function"==typeof s&&(i=s,s=void 0);var n=this;if(!i)return u.asPromise(e,n,t,s);var a=i===l;function c(e,t){if(i){var s=i;if(i=null,a)throw e;s(e,t)}}function h(e,t){try{if(u.isString(t)&&"{"===t.charAt(0)&&(t=JSON.parse(t)),u.isString(t)){r.filename=e;var i,o=r(t,n,s),h=0;if(o.imports)for(;h<o.imports.length;++h)(i=n.resolvePath(e,o.imports[h]))&&d(i);if(o.weakImports)for(h=0;h<o.weakImports.length;++h)(i=n.resolvePath(e,o.weakImports[h]))&&d(i,!0)}else n.setOptions(t.options).addJSON(t.nested)}catch(e){c(e)}a||p||c(null,n)}function d(e,t){var s=e.lastIndexOf("google/protobuf/");if(s>-1){var r=e.substring(s);r in o&&(e=r)}if(!(n.files.indexOf(e)>-1))if(n.files.push(e),e in o)a?h(e,o[e]):(++p,setTimeout((function(){--p,h(e,o[e])})));else if(a){var d;try{d=u.fs.readFileSync(e).toString("utf8")}catch(e){return void(t||c(e))}h(e,d)}else++p,u.fetch(e,(function(s,r){--p,i&&(s?t?p||c(null,n):c(s):h(e,r))}))}var p=0;u.isString(t)&&(t=[t]);for(var f,m=0;m<t.length;++m)(f=n.resolvePath("",t[m]))&&d(f);if(a)return n;p||c(null,n)},d.prototype.loadSync=function(e,t){if(!u.isNode)throw Error("not supported");return this.load(e,t,l)},d.prototype.resolveAll=function(){if(this.deferred.length)throw Error("unresolvable extensions: "+this.deferred.map((function(e){return"'extend "+e.extend+"' in "+e.parent.fullName})).join(", "));return i.prototype.resolveAll.call(this)};var p=/^[A-Z]/;function f(e,t){var s=t.parent.lookup(t.extend);if(s){var i=new a(t.fullName,t.id,t.type,t.rule,void 0,t.options);return i.declaringField=t,t.extensionField=i,s.add(i),!0}return!1}d.prototype.O=function(e){if(e instanceof a)void 0===e.extend||e.extensionField||f(0,e)||this.deferred.push(e);else if(e instanceof c)p.test(e.name)&&(e.parent[e.name]=e.values);else if(!(e instanceof h)){if(e instanceof n)for(var t=0;t<this.deferred.length;)f(0,this.deferred[t])?this.deferred.splice(t,1):++t;for(var s=0;s<e.nestedArray.length;++s)this.O(e.I[s]);p.test(e.name)&&(e.parent[e.name]=e)}},d.prototype.R=function(e){if(e instanceof a){if(void 0!==e.extend)if(e.extensionField)e.extensionField.parent.remove(e.extensionField),e.extensionField=null;else{var t=this.deferred.indexOf(e);t>-1&&this.deferred.splice(t,1)}}else if(e instanceof c)p.test(e.name)&&delete e.parent[e.name];else if(e instanceof i){for(var s=0;s<e.nestedArray.length;++s)this.R(e.I[s]);p.test(e.name)&&delete e.parent[e.name]}},d.v=function(e,t,s){n=e,r=t,o=s}},function(e){e.exports=JSON.parse('{"nested":{"com":{"nested":{"convergencelabs":{"nested":{"convergence":{"nested":{"proto":{"nested":{"ConvergenceMessage":{"oneofs":{"body":{"oneof":["ok","error","ping","pong","handshakeRequest","handshakeResponse","authenticationRequest","authenticationResponse","getClientPermissionsRequest","getClientPermissionsResponse","addPermissionsRequest","addPermissionsResponse","removePermissionsRequest","removePermissionsResponse","setPermissionsRequest","setPermissionsResponse","getWorldPermissionsRequest","getWorldPermissionsResponse","getAllUserPermissionsRequest","getAllUserPermissionsResponse","getUserPermissionsRequest","getUserPermissionsResponse","getAllGroupPermissionsRequest","getAllGroupPermissionsResponse","getGroupPermissionsRequest","getGroupPermissionsResponse","openRealTimeModelRequest","openRealTimeModelResponse","closeRealTimeModelRequest","closeRealTimeModelResponse","createRealTimeModelRequest","createRealTimeModelResponse","deleteRealtimeModelRequest","deleteRealtimeModelResponse","forceCloseRealTimeModel","remoteClientOpenedModel","remoteClientClosedModel","modelAutoCreateConfigRequest","modelAutoCreateConfigResponse","remoteOperation","operationSubmission","operationAck","shareReference","setReference","clearReference","unshareReference","referenceShared","referenceSet","referenceCleared","referenceUnshared","modelsQueryRequest","modelsQueryResponse","getModelPermissionsRequest","getModelPermissionsResponse","setModelPermissionsRequest","setModelPermissionsResponse","modelPermissionsChanged","modelResyncRequest","modelResyncResponse","modelResyncClientComplete","modelResyncServerComplete","remoteClientResyncStarted","remoteClientResyncCompleted","modelOfflineSubscriptionChange","modelOfflineUpdated","historicalDataRequest","historicalDataResponse","historicalOperationsRequest","historicalOperationsResponse","identityCacheUpdate","usersGetRequest","userSearchRequest","userListResponse","userGroupsRequest","userGroupsResponse","userGroupsForUsersRequest","userGroupsForUsersResponse","activityParticipantsRequest","activityParticipantsResponse","activityJoinRequest","activityJoinResponse","activityLeaveRequest","activitySessionJoined","activitySessionLeft","activityUpdateState","activityStateUpdated","presenceSetState","presenceRemoveState","presenceClearState","presenceStateSet","presenceStateRemoved","presenceStateCleared","presenceAvailabilityChanged","presenceRequest","presenceResponse","presenceSubscribeRequest","presenceSubscribeResponse","presenceUnsubscribe","createChatRequest","createChatResponse","removeChatRequest","removeChatResponse","chatRemoved","getChatsRequest","getChatsResponse","chatsExistRequest","chatsExistResponse","getDirectChatsRequest","getDirectChatsResponse","getJoinedChatsRequest","getJoinedChatsResponse","joinChatRequest","joinChatResponse","userJoinedChat","leaveChatRequest","leaveChatResponse","userLeftChat","addUserToChatChannelRequest","addUserToChatChannelResponse","userAddedToChatChannel","removeUserFromChatChannelRequest","removeUserFromChatChannelResponse","userRemovedFromChatChannel","setChatNameRequest","setChatNameResponse","chatNameChanged","setChatTopicRequest","setChatTopicResponse","chatTopicChanged","markChatEventsSeenRequest","markChatEventsSeenResponse","chatEventsMarkedSeen","publishChatMessageRequest","publishChatMessageResponse","remoteChatMessage","getChatHistoryRequest","getChatHistoryResponse"]}},"fields":{"requestId":{"type":"google.protobuf.Int32Value","id":1},"responseId":{"type":"google.protobuf.Int32Value","id":2},"ok":{"type":"core.OkResponse","id":3},"error":{"type":"core.ErrorMessage","id":4},"ping":{"type":"core.PingMessage","id":5},"pong":{"type":"core.PongMessage","id":6},"handshakeRequest":{"type":"core.HandshakeRequestMessage","id":7},"handshakeResponse":{"type":"core.HandshakeResponseMessage","id":8},"authenticationRequest":{"type":"core.AuthenticationRequestMessage","id":9},"authenticationResponse":{"type":"core.AuthenticationResponseMessage","id":10},"getClientPermissionsRequest":{"type":"core.GetClientPermissionsRequestMessage","id":601},"getClientPermissionsResponse":{"type":"core.GetClientPermissionsResponseMessage","id":602},"addPermissionsRequest":{"type":"core.AddPermissionsRequestMessage","id":603},"addPermissionsResponse":{"type":"core.AddPermissionsResponseMessage","id":604},"removePermissionsRequest":{"type":"core.RemovePermissionsRequestMessage","id":605},"removePermissionsResponse":{"type":"core.RemovePermissionsResponseMessage","id":606},"setPermissionsRequest":{"type":"core.SetPermissionsRequestMessage","id":607},"setPermissionsResponse":{"type":"core.SetPermissionsResponseMessage","id":608},"getWorldPermissionsRequest":{"type":"core.GetWorldPermissionsRequestMessage","id":609},"getWorldPermissionsResponse":{"type":"core.GetWorldPermissionsResponseMessage","id":610},"getAllUserPermissionsRequest":{"type":"core.GetAllUserPermissionsRequestMessage","id":611},"getAllUserPermissionsResponse":{"type":"core.GetAllUserPermissionsResponseMessage","id":612},"getUserPermissionsRequest":{"type":"core.GetUserPermissionsRequestMessage","id":613},"getUserPermissionsResponse":{"type":"core.GetUserPermissionsResponseMessage","id":614},"getAllGroupPermissionsRequest":{"type":"core.GetAllGroupPermissionsRequestMessage","id":615},"getAllGroupPermissionsResponse":{"type":"core.GetAllGroupPermissionsResponseMessage","id":616},"getGroupPermissionsRequest":{"type":"core.GetGroupPermissionsRequestMessage","id":617},"getGroupPermissionsResponse":{"type":"core.GetGroupPermissionsResponseMessage","id":618},"openRealTimeModelRequest":{"type":"model.OpenRealtimeModelRequestMessage","id":100},"openRealTimeModelResponse":{"type":"model.OpenRealtimeModelResponseMessage","id":101},"closeRealTimeModelRequest":{"type":"model.CloseRealtimeModelRequestMessage","id":102},"closeRealTimeModelResponse":{"type":"model.CloseRealTimeModelResponseMessage","id":103},"createRealTimeModelRequest":{"type":"model.CreateRealtimeModelRequestMessage","id":104},"createRealTimeModelResponse":{"type":"model.CreateRealtimeModelResponseMessage","id":105},"deleteRealtimeModelRequest":{"type":"model.DeleteRealtimeModelRequestMessage","id":106},"deleteRealtimeModelResponse":{"type":"model.DeleteRealtimeModelResponseMessage","id":107},"forceCloseRealTimeModel":{"type":"model.ModelForceCloseMessage","id":108},"remoteClientOpenedModel":{"type":"model.RemoteClientOpenedMessage","id":109},"remoteClientClosedModel":{"type":"model.RemoteClientClosedMessage","id":110},"modelAutoCreateConfigRequest":{"type":"model.AutoCreateModelConfigRequestMessage","id":111},"modelAutoCreateConfigResponse":{"type":"model.AutoCreateModelConfigResponseMessage","id":112},"remoteOperation":{"type":"model.RemoteOperationMessage","id":113},"operationSubmission":{"type":"model.OperationSubmissionMessage","id":114},"operationAck":{"type":"model.OperationAcknowledgementMessage","id":115},"shareReference":{"type":"model.ShareReferenceMessage","id":116},"setReference":{"type":"model.SetReferenceMessage","id":117},"clearReference":{"type":"model.ClearReferenceMessage","id":118},"unshareReference":{"type":"model.UnshareReferenceMessage","id":119},"referenceShared":{"type":"model.RemoteReferenceSharedMessage","id":120},"referenceSet":{"type":"model.RemoteReferenceSetMessage","id":121},"referenceCleared":{"type":"model.RemoteReferenceClearedMessage","id":122},"referenceUnshared":{"type":"model.RemoteReferenceUnsharedMessage","id":123},"modelsQueryRequest":{"type":"model.ModelsQueryRequestMessage","id":124},"modelsQueryResponse":{"type":"model.ModelsQueryResponseMessage","id":125},"getModelPermissionsRequest":{"type":"model.GetModelPermissionsRequestMessage","id":126},"getModelPermissionsResponse":{"type":"model.GetModelPermissionsResponseMessage","id":127},"setModelPermissionsRequest":{"type":"model.SetModelPermissionsRequestMessage","id":128},"setModelPermissionsResponse":{"type":"model.SetModelPermissionsResponseMessage","id":129},"modelPermissionsChanged":{"type":"model.ModelPermissionsChangedMessage","id":130},"modelResyncRequest":{"type":"model.ModelResyncRequestMessage","id":131},"modelResyncResponse":{"type":"model.ModelResyncResponseMessage","id":132},"modelResyncClientComplete":{"type":"model.ModelResyncClientCompleteMessage","id":133},"modelResyncServerComplete":{"type":"model.ModelResyncServerCompleteMessage","id":134},"remoteClientResyncStarted":{"type":"model.RemoteClientResyncStartedMessage","id":135},"remoteClientResyncCompleted":{"type":"model.RemoteClientResyncCompletedMessage","id":136},"modelOfflineSubscriptionChange":{"type":"model.ModelOfflineSubscriptionChangeRequestMessage","id":137},"modelOfflineUpdated":{"type":"model.OfflineModelUpdatedMessage","id":138},"historicalDataRequest":{"type":"model.HistoricalDataRequestMessage","id":139},"historicalDataResponse":{"type":"model.HistoricalDataResponseMessage","id":140},"historicalOperationsRequest":{"type":"model.HistoricalOperationRequestMessage","id":141},"historicalOperationsResponse":{"type":"model.HistoricalOperationsResponseMessage","id":142},"identityCacheUpdate":{"type":"identity.IdentityCacheUpdateMessage","id":200},"usersGetRequest":{"type":"identity.GetUsersMessage","id":201},"userSearchRequest":{"type":"identity.UserSearchMessage","id":202},"userListResponse":{"type":"identity.UserListMessage","id":203},"userGroupsRequest":{"type":"identity.UserGroupsRequestMessage","id":204},"userGroupsResponse":{"type":"identity.UserGroupsResponseMessage","id":205},"userGroupsForUsersRequest":{"type":"identity.UserGroupsForUsersRequestMessage","id":206},"userGroupsForUsersResponse":{"type":"identity.UserGroupsForUsersResponseMessage","id":207},"activityParticipantsRequest":{"type":"activity.ActivityParticipantsRequestMessage","id":300},"activityParticipantsResponse":{"type":"activity.ActivityParticipantsResponseMessage","id":301},"activityJoinRequest":{"type":"activity.ActivityJoinRequestMessage","id":302},"activityJoinResponse":{"type":"activity.ActivityJoinResponseMessage","id":303},"activityLeaveRequest":{"type":"activity.ActivityLeaveMessage","id":304},"activitySessionJoined":{"type":"activity.ActivitySessionJoinedMessage","id":306},"activitySessionLeft":{"type":"activity.ActivitySessionLeftMessage","id":307},"activityUpdateState":{"type":"activity.ActivityUpdateStateMessage","id":308},"activityStateUpdated":{"type":"activity.ActivityStateUpdatedMessage","id":309},"presenceSetState":{"type":"presence.PresenceSetStateMessage","id":400},"presenceRemoveState":{"type":"presence.PresenceRemoveStateMessage","id":401},"presenceClearState":{"type":"presence.PresenceClearStateMessage","id":402},"presenceStateSet":{"type":"presence.PresenceStateSetMessage","id":403},"presenceStateRemoved":{"type":"presence.PresenceStateRemovedMessage","id":404},"presenceStateCleared":{"type":"presence.PresenceStateClearedMessage","id":405},"presenceAvailabilityChanged":{"type":"presence.PresenceAvailabilityChangedMessage","id":406},"presenceRequest":{"type":"presence.PresenceRequestMessage","id":407},"presenceResponse":{"type":"presence.PresenceResponseMessage","id":408},"presenceSubscribeRequest":{"type":"presence.SubscribePresenceRequestMessage","id":409},"presenceSubscribeResponse":{"type":"presence.SubscribePresenceResponseMessage","id":410},"presenceUnsubscribe":{"type":"presence.UnsubscribePresenceMessage","id":411},"createChatRequest":{"type":"chat.CreateChatRequestMessage","id":500},"createChatResponse":{"type":"chat.CreateChatResponseMessage","id":501},"removeChatRequest":{"type":"chat.RemoveChatRequestMessage","id":502},"removeChatResponse":{"type":"chat.RemoveChatResponseMessage","id":503},"chatRemoved":{"type":"chat.ChatRemovedMessage","id":504},"getChatsRequest":{"type":"chat.GetChatsRequestMessage","id":505},"getChatsResponse":{"type":"chat.GetChatsResponseMessage","id":506},"chatsExistRequest":{"type":"chat.ChatsExistRequestMessage","id":507},"chatsExistResponse":{"type":"chat.ChatsExistResponseMessage","id":508},"getDirectChatsRequest":{"type":"chat.GetDirectChatsRequestMessage","id":509},"getDirectChatsResponse":{"type":"chat.GetDirectChatsResponseMessage","id":510},"getJoinedChatsRequest":{"type":"chat.GetJoinedChatsRequestMessage","id":511},"getJoinedChatsResponse":{"type":"chat.GetJoinedChatsResponseMessage","id":512},"joinChatRequest":{"type":"chat.JoinChatRequestMessage","id":515},"joinChatResponse":{"type":"chat.JoinChatResponseMessage","id":516},"userJoinedChat":{"type":"chat.UserJoinedChatMessage","id":517},"leaveChatRequest":{"type":"chat.LeaveChatRequestMessage","id":518},"leaveChatResponse":{"type":"chat.LeaveChatResponseMessage","id":519},"userLeftChat":{"type":"chat.UserLeftChatMessage","id":520},"addUserToChatChannelRequest":{"type":"chat.AddUserToChatChannelRequestMessage","id":521},"addUserToChatChannelResponse":{"type":"chat.AddUserToChatChannelResponseMessage","id":522},"userAddedToChatChannel":{"type":"chat.UserAddedToChatChannelMessage","id":523},"removeUserFromChatChannelRequest":{"type":"chat.RemoveUserFromChatChannelRequestMessage","id":524},"removeUserFromChatChannelResponse":{"type":"chat.RemoveUserFromChatChannelResponseMessage","id":525},"userRemovedFromChatChannel":{"type":"chat.UserRemovedFromChatChannelMessage","id":526},"setChatNameRequest":{"type":"chat.SetChatNameRequestMessage","id":527},"setChatNameResponse":{"type":"chat.SetChatNameResponseMessage","id":528},"chatNameChanged":{"type":"chat.ChatNameSetMessage","id":529},"setChatTopicRequest":{"type":"chat.SetChatTopicRequestMessage","id":530},"setChatTopicResponse":{"type":"chat.SetChatTopicResponseMessage","id":531},"chatTopicChanged":{"type":"chat.ChatTopicSetMessage","id":532},"markChatEventsSeenRequest":{"type":"chat.MarkChatEventsSeenRequestMessage","id":533},"markChatEventsSeenResponse":{"type":"chat.MarkChatEventsSeenResponseMessage","id":534},"chatEventsMarkedSeen":{"type":"chat.ChatEventsMarkedSeenMessage","id":535},"publishChatMessageRequest":{"type":"chat.PublishChatRequestMessage","id":536},"publishChatMessageResponse":{"type":"chat.PublishChatResponseMessage","id":537},"remoteChatMessage":{"type":"chat.RemoteChatMessageMessage","id":538},"getChatHistoryRequest":{"type":"chat.ChatHistoryRequestMessage","id":539},"getChatHistoryResponse":{"type":"chat.ChatHistoryResponseMessage","id":540}}},"core":{"nested":{"AuthenticationRequestMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ClientMessage"},"oneofs":{"auth":{"oneof":["password","jwt","anonymous","reconnect"]}},"fields":{"password":{"type":"PasswordAuthRequestData","id":1},"jwt":{"type":"JwtAuthRequestData","id":2},"anonymous":{"type":"AnonymousAuthRequestData","id":3},"reconnect":{"type":"ReconnectTokenAuthRequestData","id":4}},"nested":{"PasswordAuthRequestData":{"fields":{"username":{"type":"string","id":1},"password":{"type":"string","id":2}}},"JwtAuthRequestData":{"fields":{"jwt":{"type":"string","id":1}}},"ReconnectTokenAuthRequestData":{"fields":{"token":{"type":"string","id":1}}},"AnonymousAuthRequestData":{"fields":{"displayName":{"type":"google.protobuf.StringValue","id":1}}}}},"AuthenticationResponseMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"oneofs":{"response":{"oneof":["success","failure"]}},"fields":{"success":{"type":"AuthSuccessData","id":1},"failure":{"type":"AuthFailureData","id":2}},"nested":{"AuthSuccessData":{"fields":{"user":{"type":"DomainUserData","id":1},"sessionId":{"type":"string","id":2},"reconnectToken":{"type":"string","id":3},"presenceState":{"keyType":"string","type":"google.protobuf.Value","id":4}}},"AuthFailureData":{"fields":{"message":{"type":"string","id":1}}}}},"PingMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{}},"PongMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{}},"HandshakeRequestMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ClientMessage"},"fields":{"reconnect":{"type":"bool","id":1},"reconnectToken":{"type":"google.protobuf.StringValue","id":2},"client":{"type":"string","id":3},"clientVersion":{"type":"string","id":4}}},"HandshakeResponseMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{"success":{"type":"bool","id":1},"error":{"type":"ErrorData","id":2},"retryOk":{"type":"bool","id":3},"namespace":{"type":"string","id":4},"id":{"type":"string","id":5},"protocolConfig":{"type":"ProtocolConfigData","id":6}},"nested":{"ErrorData":{"fields":{"code":{"type":"string","id":1},"details":{"type":"string","id":2}}},"ProtocolConfigData":{"fields":{"heartbeatEnabled":{"type":"bool","id":1}}}}},"PermissionType":{"values":{"PERMISSION_TYPE_NOT_SET":0,"CHAT":1}},"UserPermissionsEntry":{"fields":{"user":{"type":"DomainUserIdData","id":1},"permissions":{"rule":"repeated","type":"string","id":2}}},"PermissionsList":{"fields":{"values":{"rule":"repeated","type":"string","id":1}}},"AddPermissionsRequestMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ClientMessage"},"fields":{"idType":{"type":"PermissionType","id":1},"id":{"type":"string","id":2},"world":{"rule":"repeated","type":"string","id":3},"user":{"rule":"repeated","type":"UserPermissionsEntry","id":4},"group":{"keyType":"string","type":"PermissionsList","id":5}}},"AddPermissionsResponseMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{}},"RemovePermissionsRequestMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ClientMessage"},"fields":{"idType":{"type":"PermissionType","id":1},"id":{"type":"string","id":2},"world":{"rule":"repeated","type":"string","id":3},"user":{"rule":"repeated","type":"UserPermissionsEntry","id":4},"group":{"keyType":"string","type":"PermissionsList","id":5}}},"RemovePermissionsResponseMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{}},"SetPermissionsRequestMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ClientMessage"},"fields":{"idType":{"type":"PermissionType","id":1},"id":{"type":"string","id":2},"world":{"rule":"repeated","type":"string","id":3},"user":{"rule":"repeated","type":"UserPermissionsEntry","id":4},"group":{"keyType":"string","type":"PermissionsList","id":5}}},"SetPermissionsResponseMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{}},"GetClientPermissionsRequestMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ClientMessage"},"fields":{"idType":{"type":"PermissionType","id":1},"id":{"type":"string","id":2}}},"GetClientPermissionsResponseMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{"permissions":{"rule":"repeated","type":"string","id":1}}},"GetWorldPermissionsRequestMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ClientMessage"},"fields":{"idType":{"type":"PermissionType","id":1},"id":{"type":"string","id":2}}},"GetWorldPermissionsResponseMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{"permissions":{"rule":"repeated","type":"string","id":1}}},"GetAllUserPermissionsRequestMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ClientMessage"},"fields":{"idType":{"type":"PermissionType","id":1},"id":{"type":"string","id":2}}},"GetAllUserPermissionsResponseMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{"users":{"rule":"repeated","type":"UserPermissionsEntry","id":1}}},"GetAllGroupPermissionsRequestMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ClientMessage"},"fields":{"idType":{"type":"PermissionType","id":1},"id":{"type":"string","id":2}}},"GetAllGroupPermissionsResponseMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{"groups":{"keyType":"string","type":"PermissionsList","id":1}}},"GetUserPermissionsRequestMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ClientMessage"},"fields":{"idType":{"type":"PermissionType","id":1},"id":{"type":"string","id":2},"user":{"type":"DomainUserIdData","id":3}}},"GetUserPermissionsResponseMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{"permissions":{"rule":"repeated","type":"string","id":1}}},"GetGroupPermissionsRequestMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ClientMessage"},"fields":{"idType":{"type":"PermissionType","id":1},"id":{"type":"string","id":2},"groupId":{"type":"string","id":3}}},"GetGroupPermissionsResponseMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{"permissions":{"rule":"repeated","type":"string","id":1}}},"DomainUserTypeData":{"values":{"Normal":0,"Convergence":1,"Anonymous":2}},"DomainUserIdData":{"fields":{"userType":{"type":"DomainUserTypeData","id":1},"username":{"type":"string","id":2}}},"DomainUserIdList":{"fields":{"values":{"rule":"repeated","type":"DomainUserIdData","id":1}}},"DomainUserData":{"fields":{"userId":{"type":"DomainUserIdData","id":1},"firstName":{"type":"google.protobuf.StringValue","id":2},"lastName":{"type":"google.protobuf.StringValue","id":3},"displayName":{"type":"google.protobuf.StringValue","id":4},"email":{"type":"google.protobuf.StringValue","id":5},"disabled":{"type":"bool","id":6},"deleted":{"type":"bool","id":7},"deletedUsername":{"type":"google.protobuf.StringValue","id":8}}},"ErrorMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{"code":{"type":"string","id":1},"message":{"type":"string","id":2},"details":{"keyType":"string","type":"google.protobuf.Value","id":3}}},"OkResponse":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{}},"StringList":{"fields":{"values":{"rule":"repeated","type":"string","id":1}}},"Int32List":{"fields":{"values":{"rule":"repeated","type":"int32","id":1}}}}},"activity":{"nested":{"ActivityJoinRequestMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ClientMessage"},"fields":{"activityId":{"type":"string","id":1},"state":{"keyType":"string","type":"google.protobuf.Value","id":2}}},"ActivityJoinResponseMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{"state":{"keyType":"string","type":"ActivityStateData","id":1}}},"ActivityLeaveMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ClientMessage"},"fields":{"activityId":{"type":"string","id":1}}},"ActivityParticipantsRequestMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ClientMessage"},"fields":{"activityId":{"type":"string","id":1}}},"ActivityParticipantsResponseMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{"state":{"keyType":"string","type":"ActivityStateData","id":1}}},"ActivitySessionJoinedMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{"activityId":{"type":"string","id":1},"sessionId":{"type":"string","id":2},"state":{"keyType":"string","type":"google.protobuf.Value","id":3}}},"ActivitySessionLeftMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{"activityId":{"type":"string","id":1},"sessionId":{"type":"string","id":2}}},"ActivityUpdateStateMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ClientMessage"},"fields":{"activityId":{"type":"string","id":1},"set":{"keyType":"string","type":"google.protobuf.Value","id":2},"complete":{"type":"bool","id":3},"removed":{"rule":"repeated","type":"string","id":4}}},"ActivityStateUpdatedMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{"activityId":{"type":"string","id":1},"sessionId":{"type":"string","id":2},"set":{"keyType":"string","type":"google.protobuf.Value","id":3},"complete":{"type":"bool","id":4},"removed":{"rule":"repeated","type":"string","id":5}}},"ActivityStateData":{"fields":{"state":{"keyType":"string","type":"google.protobuf.Value","id":1}}}}},"chat":{"nested":{"PublishChatRequestMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ClientMessage"},"fields":{"chatId":{"type":"string","id":1},"message":{"type":"string","id":2}}},"PublishChatResponseMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{}},"RemoteChatMessageMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{"chatId":{"type":"string","id":1},"eventNumber":{"type":"int64","id":2},"timestamp":{"type":"google.protobuf.Timestamp","id":3},"sessionId":{"type":"string","id":4},"message":{"type":"string","id":5}}},"CreateChatRequestMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ClientMessage"},"fields":{"chatId":{"type":"google.protobuf.StringValue","id":1},"chatType":{"type":"string","id":2},"membership":{"type":"string","id":3},"name":{"type":"string","id":4},"topic":{"type":"string","id":5},"members":{"rule":"repeated","type":"com.convergencelabs.convergence.proto.core.DomainUserIdData","id":6}}},"CreateChatResponseMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{"chatId":{"type":"string","id":1}}},"RemoveChatRequestMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ClientMessage"},"fields":{"chatId":{"type":"string","id":1}}},"RemoveChatResponseMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{}},"ChatRemovedMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{"chatId":{"type":"string","id":1}}},"JoinChatRequestMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ClientMessage"},"fields":{"chatId":{"type":"string","id":1}}},"JoinChatResponseMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{"chatInfo":{"type":"ChatInfoData","id":1}}},"UserJoinedChatMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{"chatId":{"type":"string","id":1},"eventNumber":{"type":"int64","id":2},"timestamp":{"type":"google.protobuf.Timestamp","id":3},"user":{"type":"com.convergencelabs.convergence.proto.core.DomainUserIdData","id":4}}},"AddUserToChatChannelRequestMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ClientMessage"},"fields":{"chatId":{"type":"string","id":1},"userToAdd":{"type":"com.convergencelabs.convergence.proto.core.DomainUserIdData","id":2}}},"AddUserToChatChannelResponseMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{}},"UserAddedToChatChannelMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{"chatId":{"type":"string","id":1},"eventNumber":{"type":"int64","id":2},"timestamp":{"type":"google.protobuf.Timestamp","id":3},"user":{"type":"com.convergencelabs.convergence.proto.core.DomainUserIdData","id":4},"addedUser":{"type":"com.convergencelabs.convergence.proto.core.DomainUserIdData","id":5}}},"ChatJoinedMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{"chatId":{"type":"string","id":1}}},"LeaveChatRequestMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ClientMessage"},"fields":{"chatId":{"type":"string","id":1}}},"LeaveChatResponseMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{}},"UserLeftChatMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{"chatId":{"type":"string","id":1},"eventNumber":{"type":"int64","id":2},"timestamp":{"type":"google.protobuf.Timestamp","id":3},"user":{"type":"com.convergencelabs.convergence.proto.core.DomainUserIdData","id":4}}},"RemoveUserFromChatChannelRequestMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ClientMessage"},"fields":{"chatId":{"type":"string","id":1},"userToRemove":{"type":"com.convergencelabs.convergence.proto.core.DomainUserIdData","id":2}}},"RemoveUserFromChatChannelResponseMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{}},"UserRemovedFromChatChannelMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{"chatId":{"type":"string","id":1},"eventNumber":{"type":"int64","id":2},"timestamp":{"type":"google.protobuf.Timestamp","id":3},"user":{"type":"com.convergencelabs.convergence.proto.core.DomainUserIdData","id":4},"removedUser":{"type":"com.convergencelabs.convergence.proto.core.DomainUserIdData","id":5}}},"ChatLeftMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{"chatId":{"type":"string","id":1}}},"SetChatNameRequestMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ClientMessage"},"fields":{"chatId":{"type":"string","id":1},"name":{"type":"string","id":2}}},"SetChatNameResponseMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{}},"ChatNameSetMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{"chatId":{"type":"string","id":1},"eventNumber":{"type":"int64","id":2},"timestamp":{"type":"google.protobuf.Timestamp","id":3},"user":{"type":"com.convergencelabs.convergence.proto.core.DomainUserIdData","id":4},"name":{"type":"string","id":5}}},"SetChatTopicRequestMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ClientMessage"},"fields":{"chatId":{"type":"string","id":1},"topic":{"type":"string","id":2}}},"SetChatTopicResponseMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{}},"ChatTopicSetMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{"chatId":{"type":"string","id":1},"eventNumber":{"type":"int64","id":2},"timestamp":{"type":"google.protobuf.Timestamp","id":3},"user":{"type":"com.convergencelabs.convergence.proto.core.DomainUserIdData","id":4},"topic":{"type":"string","id":5}}},"MarkChatEventsSeenRequestMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ClientMessage"},"fields":{"chatId":{"type":"string","id":1},"eventNumber":{"type":"int64","id":2}}},"MarkChatEventsSeenResponseMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{}},"ChatEventsMarkedSeenMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{"chatId":{"type":"string","id":1},"user":{"type":"com.convergencelabs.convergence.proto.core.DomainUserIdData","id":2},"eventNumber":{"type":"int64","id":3}}},"GetJoinedChatsRequestMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ClientMessage"},"fields":{}},"GetJoinedChatsResponseMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{"chatInfo":{"rule":"repeated","type":"ChatInfoData","id":1}}},"GetChatsRequestMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ClientMessage"},"fields":{"chatIds":{"rule":"repeated","type":"string","id":1}}},"GetChatsResponseMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{"chatInfo":{"rule":"repeated","type":"ChatInfoData","id":1}}},"GetDirectChatsRequestMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ClientMessage"},"fields":{"userLists":{"rule":"repeated","type":"com.convergencelabs.convergence.proto.core.DomainUserIdList","id":1}}},"GetDirectChatsResponseMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{"chatInfo":{"rule":"repeated","type":"ChatInfoData","id":1}}},"ChatHistoryRequestMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ClientMessage"},"fields":{"chatId":{"type":"string","id":1},"limit":{"type":"google.protobuf.Int32Value","id":2},"startEvent":{"type":"google.protobuf.Int64Value","id":3},"forward":{"type":"google.protobuf.BoolValue","id":4},"eventFilter":{"rule":"repeated","type":"string","id":5}}},"ChatHistoryResponseMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{"eventData":{"rule":"repeated","type":"ChatEventData","id":1}}},"ChatsExistRequestMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ClientMessage"},"fields":{"chatIds":{"rule":"repeated","type":"string","id":1}}},"ChatsExistResponseMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{"exists":{"rule":"repeated","type":"bool","id":1}}},"ChatMemberData":{"fields":{"user":{"type":"com.convergencelabs.convergence.proto.core.DomainUserIdData","id":1},"maxSeenEventNumber":{"type":"int64","id":2}}},"ChatInfoData":{"fields":{"id":{"type":"string","id":1},"chatType":{"type":"string","id":2},"membership":{"type":"string","id":3},"name":{"type":"string","id":4},"topic":{"type":"string","id":5},"createdTime":{"type":"google.protobuf.Timestamp","id":6},"lastEventTime":{"type":"google.protobuf.Timestamp","id":7},"lastEventNumber":{"type":"int64","id":8},"members":{"rule":"repeated","type":"ChatMemberData","id":9}}},"ChatCreatedEventData":{"fields":{"chatId":{"type":"string","id":1},"eventNumber":{"type":"int64","id":2},"timestamp":{"type":"google.protobuf.Timestamp","id":3},"user":{"type":"com.convergencelabs.convergence.proto.core.DomainUserIdData","id":4},"name":{"type":"string","id":5},"topic":{"type":"string","id":6},"members":{"rule":"repeated","type":"com.convergencelabs.convergence.proto.core.DomainUserIdData","id":7}}},"ChatMessageEventData":{"fields":{"chatId":{"type":"string","id":1},"eventNumber":{"type":"int64","id":2},"timestamp":{"type":"google.protobuf.Timestamp","id":3},"user":{"type":"com.convergencelabs.convergence.proto.core.DomainUserIdData","id":4},"message":{"type":"string","id":5}}},"ChatUserJoinedEventData":{"fields":{"chatId":{"type":"string","id":1},"eventNumber":{"type":"int64","id":2},"timestamp":{"type":"google.protobuf.Timestamp","id":3},"user":{"type":"com.convergencelabs.convergence.proto.core.DomainUserIdData","id":4}}},"ChatUserLeftEventData":{"fields":{"chatId":{"type":"string","id":1},"eventNumber":{"type":"int64","id":2},"timestamp":{"type":"google.protobuf.Timestamp","id":3},"user":{"type":"com.convergencelabs.convergence.proto.core.DomainUserIdData","id":4}}},"ChatUserAddedEventData":{"fields":{"chatId":{"type":"string","id":1},"eventNumber":{"type":"int64","id":2},"timestamp":{"type":"google.protobuf.Timestamp","id":3},"user":{"type":"com.convergencelabs.convergence.proto.core.DomainUserIdData","id":4},"addedUser":{"type":"com.convergencelabs.convergence.proto.core.DomainUserIdData","id":5}}},"ChatUserRemovedEventData":{"fields":{"chatId":{"type":"string","id":1},"eventNumber":{"type":"int64","id":2},"timestamp":{"type":"google.protobuf.Timestamp","id":3},"user":{"type":"com.convergencelabs.convergence.proto.core.DomainUserIdData","id":4},"removedUser":{"type":"com.convergencelabs.convergence.proto.core.DomainUserIdData","id":5}}},"ChatNameChangedEventData":{"fields":{"chatId":{"type":"string","id":1},"eventNumber":{"type":"int64","id":2},"timestamp":{"type":"google.protobuf.Timestamp","id":3},"user":{"type":"com.convergencelabs.convergence.proto.core.DomainUserIdData","id":4},"name":{"type":"string","id":5}}},"ChatTopicChangedEventData":{"fields":{"chatId":{"type":"string","id":1},"eventNumber":{"type":"int64","id":2},"timestamp":{"type":"google.protobuf.Timestamp","id":3},"user":{"type":"com.convergencelabs.convergence.proto.core.DomainUserIdData","id":4},"topic":{"type":"string","id":5}}},"ChatEventData":{"oneofs":{"event":{"oneof":["created","message","userJoined","userLeft","userAdded","userRemoved","nameChanged","topicChanged"]}},"fields":{"created":{"type":"ChatCreatedEventData","id":1},"message":{"type":"ChatMessageEventData","id":2},"userJoined":{"type":"ChatUserJoinedEventData","id":3},"userLeft":{"type":"ChatUserLeftEventData","id":4},"userAdded":{"type":"ChatUserAddedEventData","id":5},"userRemoved":{"type":"ChatUserRemovedEventData","id":6},"nameChanged":{"type":"ChatNameChangedEventData","id":7},"topicChanged":{"type":"ChatTopicChangedEventData","id":8}}}}},"identity":{"nested":{"GetUsersMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.IdentityMessage"},"fields":{"userIds":{"rule":"repeated","type":"com.convergencelabs.convergence.proto.core.DomainUserIdData","id":1}}},"UserSearchMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.IdentityMessage"},"fields":{"fields":{"rule":"repeated","type":"UserField","id":1},"value":{"type":"string","id":2},"offset":{"type":"google.protobuf.Int32Value","id":3},"limit":{"type":"google.protobuf.Int32Value","id":4},"orderField":{"type":"UserField","id":5},"ascending":{"type":"bool","id":6}}},"UserListMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.IdentityMessage"},"fields":{"userData":{"rule":"repeated","type":"com.convergencelabs.convergence.proto.core.DomainUserData","id":1}}},"UserGroupsRequestMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.IdentityMessage"},"fields":{"ids":{"rule":"repeated","type":"string","id":1}}},"UserGroupsResponseMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.IdentityMessage"},"fields":{"groupData":{"rule":"repeated","type":"UserGroupData","id":1}}},"UserGroupsForUsersRequestMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.IdentityMessage"},"fields":{"users":{"rule":"repeated","type":"com.convergencelabs.convergence.proto.core.DomainUserIdData","id":1}}},"UserGroupsForUsersResponseMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.IdentityMessage"},"fields":{"userGroups":{"rule":"repeated","type":"UserGroupsEntry","id":1}}},"IdentityCacheUpdateMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.IdentityMessage"},"fields":{"sessions":{"keyType":"string","type":"com.convergencelabs.convergence.proto.core.DomainUserIdData","id":1},"users":{"rule":"repeated","type":"com.convergencelabs.convergence.proto.core.DomainUserData","id":2}}},"UserField":{"values":{"FIELD_NOT_SET":0,"USERNAME":1,"EMAIL":2,"FIRST_NAME":3,"LAST_NAME":4,"DISPLAY_NAME":5}},"UserGroupData":{"fields":{"id":{"type":"string","id":1},"description":{"type":"string","id":2},"members":{"rule":"repeated","type":"com.convergencelabs.convergence.proto.core.DomainUserIdData","id":3}}},"UserGroupsEntry":{"fields":{"user":{"type":"com.convergencelabs.convergence.proto.core.DomainUserIdData","id":1},"groups":{"rule":"repeated","type":"string","id":2}}}}},"model":{"nested":{"OpenRealtimeModelRequestMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ClientMessage"},"fields":{"modelId":{"type":"google.protobuf.StringValue","id":1},"autoCreateId":{"type":"google.protobuf.Int32Value","id":2}}},"OpenRealtimeModelResponseMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{"resourceId":{"type":"string","id":1},"modelId":{"type":"string","id":2},"collection":{"type":"string","id":3},"valueIdPrefix":{"type":"string","id":4},"version":{"type":"int64","id":5},"createdTime":{"type":"google.protobuf.Timestamp","id":6},"modifiedTime":{"type":"google.protobuf.Timestamp","id":7},"data":{"type":"ObjectValue","id":8},"connectedClients":{"rule":"repeated","type":"string","id":9},"resyncingClients":{"rule":"repeated","type":"string","id":10},"references":{"rule":"repeated","type":"ReferenceData","id":11},"permissions":{"type":"ModelPermissionsData","id":12}}},"CloseRealtimeModelRequestMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ClientMessage"},"fields":{"resourceId":{"type":"string","id":1}}},"CloseRealTimeModelResponseMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{}},"AutoCreateModelConfigRequestMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{"autoCreateId":{"type":"int32","id":1}}},"AutoCreateModelConfigResponseMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ClientMessage"},"fields":{"collection":{"type":"string","id":1},"data":{"type":"ObjectValue","id":2},"overridePermissions":{"type":"bool","id":3},"worldPermissions":{"type":"ModelPermissionsData","id":4},"userPermissions":{"rule":"repeated","type":"UserModelPermissionsData","id":5},"ephemeral":{"type":"bool","id":6}}},"RemoteClientClosedMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{"resourceId":{"type":"string","id":1},"sessionId":{"type":"string","id":2}}},"RemoteClientOpenedMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{"resourceId":{"type":"string","id":1},"sessionId":{"type":"string","id":2}}},"ModelForceCloseMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{"resourceId":{"type":"string","id":1},"reason":{"type":"string","id":2},"reasonCode":{"type":"int32","id":3}}},"CreateRealtimeModelRequestMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ClientMessage"},"fields":{"collectionId":{"type":"string","id":1},"modelId":{"type":"google.protobuf.StringValue","id":2},"data":{"type":"ObjectValue","id":3},"overrideWorldPermissions":{"type":"bool","id":4},"worldPermissions":{"type":"ModelPermissionsData","id":5},"userPermissions":{"rule":"repeated","type":"UserModelPermissionsData","id":6}}},"CreateRealtimeModelResponseMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{"modelId":{"type":"string","id":1}}},"DeleteRealtimeModelRequestMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ClientMessage"},"fields":{"modelId":{"type":"string","id":1}}},"DeleteRealtimeModelResponseMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{}},"ModelResyncRequestMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ClientMessage"},"fields":{"modelId":{"type":"string","id":1},"contextVersion":{"type":"int64","id":2}}},"ModelResyncResponseMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{"resourceId":{"type":"string","id":1},"currentVersion":{"type":"int64","id":2},"permissions":{"type":"ModelPermissionsData","id":3}}},"ModelResyncClientCompleteMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ClientMessage"},"fields":{"resourceId":{"type":"string","id":1},"open":{"type":"bool","id":2}}},"ModelResyncServerCompleteMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{"resourceId":{"type":"string","id":1},"connectedClients":{"rule":"repeated","type":"string","id":2},"resyncingClients":{"rule":"repeated","type":"string","id":3},"references":{"rule":"repeated","type":"ReferenceData","id":4}}},"RemoteClientResyncStartedMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{"resourceId":{"type":"string","id":1},"sessionId":{"type":"string","id":2}}},"RemoteClientResyncCompletedMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{"resourceId":{"type":"string","id":1},"sessionId":{"type":"string","id":2}}},"GetModelPermissionsRequestMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ClientMessage"},"fields":{"modelId":{"type":"string","id":1}}},"GetModelPermissionsResponseMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{"overridesCollection":{"type":"bool","id":1},"worldPermissions":{"type":"ModelPermissionsData","id":2},"userPermissions":{"rule":"repeated","type":"UserModelPermissionsData","id":3}}},"SetModelPermissionsRequestMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ClientMessage"},"fields":{"modelId":{"type":"string","id":1},"overrideCollection":{"type":"google.protobuf.BoolValue","id":2},"worldPermissions":{"type":"ModelPermissionsData","id":3},"removeAllUserPermissionsBeforeSet":{"type":"bool","id":4},"setUserPermissions":{"rule":"repeated","type":"UserModelPermissionsData","id":5},"removedUserPermissions":{"rule":"repeated","type":"com.convergencelabs.convergence.proto.core.DomainUserIdData","id":6}}},"SetModelPermissionsResponseMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{}},"ModelPermissionsChangedMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{"resourceId":{"type":"string","id":1},"permissions":{"type":"ModelPermissionsData","id":2}}},"ModelsQueryRequestMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ClientMessage"},"fields":{"query":{"type":"string","id":1}}},"ModelsQueryResponseMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{"models":{"rule":"repeated","type":"ModelResult","id":1},"offset":{"type":"int64","id":2},"totalResults":{"type":"int64","id":3}},"nested":{"ModelResult":{"fields":{"collectionId":{"type":"string","id":1},"modelId":{"type":"string","id":2},"createdTime":{"type":"google.protobuf.Timestamp","id":3},"modifiedTime":{"type":"google.protobuf.Timestamp","id":4},"version":{"type":"int64","id":5},"data":{"type":"google.protobuf.Struct","id":6}}}}},"OperationSubmissionMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ClientMessage"},"fields":{"resourceId":{"type":"string","id":1},"sequenceNumber":{"type":"int32","id":2},"contextVersion":{"type":"int64","id":3},"operation":{"type":"OperationData","id":4}}},"OperationAcknowledgementMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{"resourceId":{"type":"string","id":1},"sequenceNumber":{"type":"int32","id":2},"version":{"type":"int64","id":3},"timestamp":{"type":"google.protobuf.Timestamp","id":4}}},"RemoteOperationMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{"resourceId":{"type":"string","id":1},"sessionId":{"type":"string","id":2},"contextVersion":{"type":"int64","id":3},"timestamp":{"type":"google.protobuf.Timestamp","id":4},"operation":{"type":"OperationData","id":5}}},"ShareReferenceMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ClientMessage"},"fields":{"resourceId":{"type":"string","id":1},"valueId":{"type":"google.protobuf.StringValue","id":2},"key":{"type":"string","id":3},"references":{"type":"ReferenceValues","id":4},"version":{"type":"int64","id":5}}},"RemoteReferenceSharedMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{"resourceId":{"type":"string","id":1},"valueId":{"type":"google.protobuf.StringValue","id":2},"key":{"type":"string","id":3},"references":{"type":"ReferenceValues","id":4},"sessionId":{"type":"string","id":5}}},"UnshareReferenceMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ClientMessage"},"fields":{"resourceId":{"type":"string","id":1},"valueId":{"type":"google.protobuf.StringValue","id":2},"key":{"type":"string","id":3}}},"RemoteReferenceUnsharedMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{"resourceId":{"type":"string","id":1},"valueId":{"type":"google.protobuf.StringValue","id":2},"key":{"type":"string","id":3},"sessionId":{"type":"string","id":4}}},"SetReferenceMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ClientMessage"},"fields":{"resourceId":{"type":"string","id":1},"valueId":{"type":"google.protobuf.StringValue","id":2},"key":{"type":"string","id":3},"references":{"type":"ReferenceValues","id":4},"version":{"type":"int64","id":5}}},"RemoteReferenceSetMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{"resourceId":{"type":"string","id":1},"valueId":{"type":"google.protobuf.StringValue","id":2},"key":{"type":"string","id":3},"references":{"type":"ReferenceValues","id":4},"sessionId":{"type":"string","id":5}}},"ClearReferenceMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ClientMessage"},"fields":{"resourceId":{"type":"string","id":1},"valueId":{"type":"google.protobuf.StringValue","id":2},"key":{"type":"string","id":3}}},"RemoteReferenceClearedMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{"resourceId":{"type":"string","id":1},"valueId":{"type":"google.protobuf.StringValue","id":2},"key":{"type":"string","id":3},"sessionId":{"type":"string","id":4}}},"ModelOfflineSubscriptionChangeRequestMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ClientMessage"},"fields":{"subscribe":{"rule":"repeated","type":"ModelOfflineSubscriptionData","id":1},"unsubscribe":{"rule":"repeated","type":"string","id":2},"all":{"type":"bool","id":3}},"nested":{"ModelOfflineSubscriptionData":{"fields":{"modelId":{"type":"string","id":1},"currentVersion":{"type":"int64","id":2},"currentPermissions":{"type":"ModelPermissionsData","id":3}}}}},"OfflineModelUpdatedMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"oneofs":{"action":{"oneof":["deleted","permissionRevoked","updated","initial"]}},"fields":{"modelId":{"type":"string","id":1},"deleted":{"type":"bool","id":2},"permissionRevoked":{"type":"bool","id":3},"updated":{"type":"OfflineModelUpdateData","id":4},"initial":{"type":"OfflineModelInitialData","id":5}},"nested":{"OfflineModelInitialData":{"fields":{"collection":{"type":"string","id":1},"valueIdPrefix":{"type":"string","id":2},"model":{"type":"ModelUpdateData","id":3},"permissions":{"type":"ModelPermissionsData","id":4}}},"OfflineModelUpdateData":{"fields":{"model":{"type":"ModelUpdateData","id":1},"permissions":{"type":"ModelPermissionsData","id":2}}},"ModelUpdateData":{"fields":{"version":{"type":"int64","id":1},"createdTime":{"type":"google.protobuf.Timestamp","id":2},"modifiedTime":{"type":"google.protobuf.Timestamp","id":3},"data":{"type":"ObjectValue","id":4}}}}},"HistoricalDataRequestMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ClientMessage"},"fields":{"modelId":{"type":"string","id":1}}},"HistoricalDataResponseMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{"collectionId":{"type":"string","id":1},"data":{"type":"ObjectValue","id":2},"version":{"type":"int64","id":3},"createdTime":{"type":"google.protobuf.Timestamp","id":4},"modifiedTime":{"type":"google.protobuf.Timestamp","id":5}}},"HistoricalOperationRequestMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ClientMessage"},"fields":{"modelId":{"type":"string","id":1},"first":{"type":"int64","id":2},"last":{"type":"int64","id":3}}},"HistoricalOperationsResponseMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{"operations":{"rule":"repeated","type":"ModelOperationData","id":1}},"nested":{"ModelOperationData":{"fields":{"modelId":{"type":"string","id":1},"version":{"type":"int64","id":2},"timestamp":{"type":"google.protobuf.Timestamp","id":3},"sessionId":{"type":"string","id":4},"operation":{"type":"AppliedOperationData","id":5}}}}},"ObjectValue":{"fields":{"id":{"type":"string","id":1},"children":{"keyType":"string","type":"DataValue","id":2}}},"ArrayValue":{"fields":{"id":{"type":"string","id":1},"children":{"rule":"repeated","type":"DataValue","id":2}}},"BooleanValue":{"fields":{"id":{"type":"string","id":1},"value":{"type":"bool","id":2}}},"DoubleValue":{"fields":{"id":{"type":"string","id":1},"value":{"type":"double","id":2}}},"NullValue":{"fields":{"id":{"type":"string","id":1}}},"StringValue":{"fields":{"id":{"type":"string","id":1},"value":{"type":"string","id":2}}},"DateValue":{"fields":{"id":{"type":"string","id":1},"value":{"type":"google.protobuf.Timestamp","id":2}}},"DataValue":{"oneofs":{"value":{"oneof":["objectValue","arrayValue","booleanValue","doubleValue","nullValue","stringValue","dateValue"]}},"fields":{"objectValue":{"type":"ObjectValue","id":1},"arrayValue":{"type":"ArrayValue","id":2},"booleanValue":{"type":"BooleanValue","id":3},"doubleValue":{"type":"DoubleValue","id":4},"nullValue":{"type":"NullValue","id":5},"stringValue":{"type":"StringValue","id":6},"dateValue":{"type":"DateValue","id":7}}},"StringInsertOperationData":{"fields":{"id":{"type":"string","id":1},"noOp":{"type":"bool","id":2},"index":{"type":"int32","id":3},"value":{"type":"string","id":4}}},"StringRemoveOperationData":{"fields":{"id":{"type":"string","id":1},"noOp":{"type":"bool","id":2},"index":{"type":"int32","id":3},"value":{"type":"string","id":4}}},"StringSetOperationData":{"fields":{"id":{"type":"string","id":1},"noOp":{"type":"bool","id":2},"value":{"type":"string","id":3}}},"ArrayInsertOperationData":{"fields":{"id":{"type":"string","id":1},"noOp":{"type":"bool","id":2},"index":{"type":"int32","id":3},"value":{"type":"DataValue","id":4}}},"ArrayRemoveOperationData":{"fields":{"id":{"type":"string","id":1},"noOp":{"type":"bool","id":2},"index":{"type":"int32","id":3}}},"ArrayReplaceOperationData":{"fields":{"id":{"type":"string","id":1},"noOp":{"type":"bool","id":2},"index":{"type":"int32","id":3},"value":{"type":"DataValue","id":4}}},"ArrayMoveOperationData":{"fields":{"id":{"type":"string","id":1},"noOp":{"type":"bool","id":2},"fromIndex":{"type":"int32","id":3},"toIndex":{"type":"int32","id":4}}},"ArraySetOperationData":{"fields":{"id":{"type":"string","id":1},"noOp":{"type":"bool","id":2},"values":{"rule":"repeated","type":"DataValue","id":3}}},"ObjectAddPropertyOperationData":{"fields":{"id":{"type":"string","id":1},"noOp":{"type":"bool","id":2},"key":{"type":"string","id":3},"value":{"type":"DataValue","id":4}}},"ObjectSetPropertyOperationData":{"fields":{"id":{"type":"string","id":1},"noOp":{"type":"bool","id":2},"key":{"type":"string","id":3},"value":{"type":"DataValue","id":4}}},"ObjectRemovePropertyOperationData":{"fields":{"id":{"type":"string","id":1},"noOp":{"type":"bool","id":2},"key":{"type":"string","id":3}}},"ObjectSetOperationData":{"fields":{"id":{"type":"string","id":1},"noOp":{"type":"bool","id":2},"values":{"keyType":"string","type":"DataValue","id":3}}},"NumberDeltaOperationData":{"fields":{"id":{"type":"string","id":1},"noOp":{"type":"bool","id":2},"delta":{"type":"double","id":3}}},"NumberSetOperationData":{"fields":{"id":{"type":"string","id":1},"noOp":{"type":"bool","id":2},"value":{"type":"double","id":3}}},"BooleanSetOperationData":{"fields":{"id":{"type":"string","id":1},"noOp":{"type":"bool","id":2},"value":{"type":"bool","id":3}}},"DateSetOperationData":{"fields":{"id":{"type":"string","id":1},"noOp":{"type":"bool","id":2},"value":{"type":"google.protobuf.Timestamp","id":3}}},"DiscreteOperationData":{"oneofs":{"operation":{"oneof":["stringInsertOperation","stringRemoveOperation","stringSetOperation","arrayInsertOperation","arrayRemoveOperation","arrayReplaceOperation","arrayMoveOperation","arraySetOperation","objectAddPropertyOperation","objectSetPropertyOperation","objectRemovePropertyOperation","objectSetOperation","numberDeltaOperation","numberSetOperation","booleanSetOperation","dateSetOperation"]}},"fields":{"stringInsertOperation":{"type":"StringInsertOperationData","id":1},"stringRemoveOperation":{"type":"StringRemoveOperationData","id":2},"stringSetOperation":{"type":"StringSetOperationData","id":3},"arrayInsertOperation":{"type":"ArrayInsertOperationData","id":4},"arrayRemoveOperation":{"type":"ArrayRemoveOperationData","id":5},"arrayReplaceOperation":{"type":"ArrayReplaceOperationData","id":6},"arrayMoveOperation":{"type":"ArrayMoveOperationData","id":7},"arraySetOperation":{"type":"ArraySetOperationData","id":8},"objectAddPropertyOperation":{"type":"ObjectAddPropertyOperationData","id":9},"objectSetPropertyOperation":{"type":"ObjectSetPropertyOperationData","id":10},"objectRemovePropertyOperation":{"type":"ObjectRemovePropertyOperationData","id":11},"objectSetOperation":{"type":"ObjectSetOperationData","id":12},"numberDeltaOperation":{"type":"NumberDeltaOperationData","id":13},"numberSetOperation":{"type":"NumberSetOperationData","id":14},"booleanSetOperation":{"type":"BooleanSetOperationData","id":15},"dateSetOperation":{"type":"DateSetOperationData","id":16}}},"CompoundOperationData":{"fields":{"operations":{"rule":"repeated","type":"DiscreteOperationData","id":1}}},"OperationData":{"oneofs":{"operation":{"oneof":["discreteOperation","compoundOperation"]}},"fields":{"discreteOperation":{"type":"DiscreteOperationData","id":1},"compoundOperation":{"type":"CompoundOperationData","id":2}}},"ModelPermissionsData":{"fields":{"read":{"type":"bool","id":1},"write":{"type":"bool","id":2},"remove":{"type":"bool","id":3},"manage":{"type":"bool","id":4}}},"UserModelPermissionsData":{"fields":{"user":{"type":"com.convergencelabs.convergence.proto.core.DomainUserIdData","id":1},"permissions":{"type":"ModelPermissionsData","id":2}}},"AppliedStringInsertOperationData":{"fields":{"id":{"type":"string","id":1},"noOp":{"type":"bool","id":2},"index":{"type":"int32","id":3},"value":{"type":"string","id":4}}},"AppliedStringRemoveOperationData":{"fields":{"id":{"type":"string","id":1},"noOp":{"type":"bool","id":2},"index":{"type":"int32","id":3},"length":{"type":"int32","id":4},"oldValue":{"type":"string","id":5}}},"AppliedStringSetOperationData":{"fields":{"id":{"type":"string","id":1},"noOp":{"type":"bool","id":2},"value":{"type":"string","id":3},"oldValue":{"type":"string","id":4}}},"AppliedArrayInsertOperationData":{"fields":{"id":{"type":"string","id":1},"noOp":{"type":"bool","id":2},"index":{"type":"int32","id":3},"value":{"type":"DataValue","id":4}}},"AppliedArrayRemoveOperationData":{"fields":{"id":{"type":"string","id":1},"noOp":{"type":"bool","id":2},"index":{"type":"int32","id":3},"oldValue":{"type":"DataValue","id":4}}},"AppliedArrayReplaceOperationData":{"fields":{"id":{"type":"string","id":1},"noOp":{"type":"bool","id":2},"index":{"type":"int32","id":3},"value":{"type":"DataValue","id":4},"oldValue":{"type":"DataValue","id":5}}},"AppliedArrayMoveOperationData":{"fields":{"id":{"type":"string","id":1},"noOp":{"type":"bool","id":2},"fromIndex":{"type":"int32","id":3},"toIndex":{"type":"int32","id":4}}},"AppliedArraySetOperationData":{"fields":{"id":{"type":"string","id":1},"noOp":{"type":"bool","id":2},"values":{"rule":"repeated","type":"DataValue","id":3},"oldValues":{"rule":"repeated","type":"DataValue","id":4}}},"AppliedObjectAddPropertyOperationData":{"fields":{"id":{"type":"string","id":1},"noOp":{"type":"bool","id":2},"key":{"type":"string","id":3},"value":{"type":"DataValue","id":4}}},"AppliedObjectSetPropertyOperationData":{"fields":{"id":{"type":"string","id":1},"noOp":{"type":"bool","id":2},"key":{"type":"string","id":3},"value":{"type":"DataValue","id":4},"oldValue":{"type":"DataValue","id":5}}},"AppliedObjectRemovePropertyOperationData":{"fields":{"id":{"type":"string","id":1},"noOp":{"type":"bool","id":2},"key":{"type":"string","id":3},"oldValue":{"type":"DataValue","id":4}}},"AppliedObjectSetOperationData":{"fields":{"id":{"type":"string","id":1},"noOp":{"type":"bool","id":2},"values":{"keyType":"string","type":"DataValue","id":3},"oldValues":{"keyType":"string","type":"DataValue","id":4}}},"AppliedNumberDeltaOperationData":{"fields":{"id":{"type":"string","id":1},"noOp":{"type":"bool","id":2},"delta":{"type":"double","id":3}}},"AppliedNumberSetOperationData":{"fields":{"id":{"type":"string","id":1},"noOp":{"type":"bool","id":2},"value":{"type":"double","id":3},"oldValue":{"type":"double","id":4}}},"AppliedBooleanSetOperationData":{"fields":{"id":{"type":"string","id":1},"noOp":{"type":"bool","id":2},"value":{"type":"bool","id":3},"oldValue":{"type":"bool","id":4}}},"AppliedDateSetOperationData":{"fields":{"id":{"type":"string","id":1},"noOp":{"type":"bool","id":2},"value":{"type":"google.protobuf.Timestamp","id":3},"oldValue":{"type":"google.protobuf.Timestamp","id":4}}},"AppliedDiscreteOperationData":{"oneofs":{"operation":{"oneof":["stringInsertOperation","stringRemoveOperation","stringSetOperation","arrayInsertOperation","arrayRemoveOperation","arrayReplaceOperation","arrayMoveOperation","arraySetOperation","objectAddPropertyOperation","objectSetPropertyOperation","objectRemovePropertyOperation","objectSetOperation","numberDeltaOperation","numberSetOperation","booleanSetOperation","dateSetOperation"]}},"fields":{"stringInsertOperation":{"type":"AppliedStringInsertOperationData","id":1},"stringRemoveOperation":{"type":"AppliedStringRemoveOperationData","id":2},"stringSetOperation":{"type":"AppliedStringSetOperationData","id":3},"arrayInsertOperation":{"type":"AppliedArrayInsertOperationData","id":4},"arrayRemoveOperation":{"type":"AppliedArrayRemoveOperationData","id":5},"arrayReplaceOperation":{"type":"AppliedArrayReplaceOperationData","id":6},"arrayMoveOperation":{"type":"AppliedArrayMoveOperationData","id":7},"arraySetOperation":{"type":"AppliedArraySetOperationData","id":8},"objectAddPropertyOperation":{"type":"AppliedObjectAddPropertyOperationData","id":9},"objectSetPropertyOperation":{"type":"AppliedObjectSetPropertyOperationData","id":10},"objectRemovePropertyOperation":{"type":"AppliedObjectRemovePropertyOperationData","id":11},"objectSetOperation":{"type":"AppliedObjectSetOperationData","id":12},"numberDeltaOperation":{"type":"AppliedNumberDeltaOperationData","id":13},"numberSetOperation":{"type":"AppliedNumberSetOperationData","id":14},"booleanSetOperation":{"type":"AppliedBooleanSetOperationData","id":15},"dateSetOperation":{"type":"AppliedDateSetOperationData","id":16}}},"AppliedCompoundOperationData":{"fields":{"operations":{"rule":"repeated","type":"AppliedDiscreteOperationData","id":1}}},"AppliedOperationData":{"oneofs":{"operation":{"oneof":["discreteOperation","compoundOperation"]}},"fields":{"discreteOperation":{"type":"AppliedDiscreteOperationData","id":1},"compoundOperation":{"type":"AppliedCompoundOperationData","id":2}}},"IndexRange":{"fields":{"startIndex":{"type":"int32","id":1},"endIndex":{"type":"int32","id":2}}},"IndexRangeList":{"fields":{"values":{"rule":"repeated","type":"IndexRange","id":1}}},"ReferenceValues":{"oneofs":{"values":{"oneof":["indices","ranges","properties","elements"]}},"fields":{"indices":{"type":"com.convergencelabs.convergence.proto.core.Int32List","id":1},"ranges":{"type":"IndexRangeList","id":2},"properties":{"type":"com.convergencelabs.convergence.proto.core.StringList","id":3},"elements":{"type":"com.convergencelabs.convergence.proto.core.StringList","id":4}}},"ReferenceData":{"fields":{"sessionId":{"type":"string","id":1},"valueId":{"type":"google.protobuf.StringValue","id":2},"key":{"type":"string","id":3},"reference":{"type":"ReferenceValues","id":4}}}}},"presence":{"nested":{"PresenceRequestMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.PresenceMessage"},"fields":{"users":{"rule":"repeated","type":"com.convergencelabs.convergence.proto.core.DomainUserIdData","id":1}}},"PresenceResponseMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.PresenceMessage"},"fields":{"userPresences":{"rule":"repeated","type":"UserPresenceData","id":1}}},"SubscribePresenceRequestMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.PresenceMessage"},"fields":{"users":{"rule":"repeated","type":"com.convergencelabs.convergence.proto.core.DomainUserIdData","id":1}}},"SubscribePresenceResponseMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.PresenceMessage"},"fields":{"userPresences":{"rule":"repeated","type":"UserPresenceData","id":1}}},"UnsubscribePresenceMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.PresenceMessage"},"fields":{"users":{"rule":"repeated","type":"com.convergencelabs.convergence.proto.core.DomainUserIdData","id":1}}},"PresenceSetStateMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.PresenceMessage"},"fields":{"state":{"keyType":"string","type":"google.protobuf.Value","id":1}}},"PresenceRemoveStateMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.PresenceMessage"},"fields":{"keys":{"rule":"repeated","type":"string","id":1}}},"PresenceClearStateMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.PresenceMessage"},"fields":{}},"PresenceStateSetMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.PresenceMessage"},"fields":{"user":{"type":"com.convergencelabs.convergence.proto.core.DomainUserIdData","id":1},"state":{"keyType":"string","type":"google.protobuf.Value","id":2}}},"PresenceStateRemovedMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.PresenceMessage"},"fields":{"user":{"type":"com.convergencelabs.convergence.proto.core.DomainUserIdData","id":1},"keys":{"rule":"repeated","type":"string","id":2}}},"PresenceStateClearedMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.PresenceMessage"},"fields":{"user":{"type":"com.convergencelabs.convergence.proto.core.DomainUserIdData","id":1}}},"PresenceAvailabilityChangedMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.PresenceMessage"},"fields":{"user":{"type":"com.convergencelabs.convergence.proto.core.DomainUserIdData","id":1},"available":{"type":"bool","id":2}}},"UserPresenceData":{"fields":{"user":{"type":"com.convergencelabs.convergence.proto.core.DomainUserIdData","id":1},"available":{"type":"bool","id":2},"state":{"keyType":"string","type":"google.protobuf.Value","id":3}}}}}}}}}}}}},"google":{"nested":{"protobuf":{"nested":{"DoubleValue":{"fields":{"value":{"type":"double","id":1}}},"FloatValue":{"fields":{"value":{"type":"float","id":1}}},"Int64Value":{"fields":{"value":{"type":"int64","id":1}}},"UInt64Value":{"fields":{"value":{"type":"uint64","id":1}}},"Int32Value":{"fields":{"value":{"type":"int32","id":1}}},"UInt32Value":{"fields":{"value":{"type":"uint32","id":1}}},"BoolValue":{"fields":{"value":{"type":"bool","id":1}}},"StringValue":{"fields":{"value":{"type":"string","id":1}}},"BytesValue":{"fields":{"value":{"type":"bytes","id":1}}},"Struct":{"fields":{"fields":{"keyType":"string","type":"Value","id":1}}},"Value":{"oneofs":{"kind":{"oneof":["nullValue","numberValue","stringValue","boolValue","structValue","listValue"]}},"fields":{"nullValue":{"type":"NullValue","id":1},"numberValue":{"type":"double","id":2},"stringValue":{"type":"string","id":3},"boolValue":{"type":"bool","id":4},"structValue":{"type":"Struct","id":5},"listValue":{"type":"ListValue","id":6}}},"NullValue":{"values":{"NULL_VALUE":0}},"ListValue":{"fields":{"values":{"rule":"repeated","type":"Value","id":1}}},"Timestamp":{"fields":{"seconds":{"type":"int64","id":1},"nanos":{"type":"int32","id":2}}}}}}}}}')},function(e,t,s){"use strict";e.exports=s(29)},function(e,t,s){"use strict";var i=e.exports=s(30);i.build="light",i.load=function(e,t,s){return"function"==typeof t?(s=t,t=new i.Root):t||(t=new i.Root),t.load(e,s)},i.loadSync=function(e,t){return t||(t=new i.Root),t.loadSync(e)},i.encoder=s(17),i.decoder=s(22),i.verifier=s(23),i.converter=s(24),i.ReflectionObject=s(5),i.Namespace=s(7),i.Root=s(26),i.Enum=s(3),i.Type=s(18),i.Field=s(6),i.OneOf=s(11),i.MapField=s(19),i.Service=s(20),i.Method=s(21),i.Message=s(12),i.wrappers=s(25),i.types=s(8),i.util=s(1),i.ReflectionObject.v(i.Root),i.Namespace.v(i.Type,i.Service,i.Enum),i.Root.v(i.Type),i.Field.v(i.Type)},function(e,t,s){"use strict";var i=t;function n(){i.Reader.v(i.BufferReader),i.util.v()}i.build="minimal",i.Writer=s(9),i.BufferWriter=s(38),i.Reader=s(10),i.BufferReader=s(39),i.util=s(2),i.rpc=s(15),i.roots=s(16),i.configure=n,i.Writer.v(i.BufferWriter),n()},function(e,t){var s;s=function(){return this}();try{s=s||new Function("return this")()}catch(e){"object"==typeof window&&(s=window)}e.exports=s},function(e,t,s){"use strict";var i=t;i.length=function(e){var t=e.length;if(!t)return 0;for(var s=0;--t%4>1&&"="===e.charAt(t);)++s;return Math.ceil(3*e.length)/4-s};for(var n=new Array(64),r=new Array(123),o=0;o<64;)r[n[o]=o<26?o+65:o<52?o+71:o<62?o-4:o-59|43]=o++;i.encode=function(e,t,s){for(var i,r=null,o=[],a=0,c=0;t<s;){var h=e[t++];switch(c){case 0:o[a++]=n[h>>2],i=(3&h)<<4,c=1;break;case 1:o[a++]=n[i|h>>4],i=(15&h)<<2,c=2;break;case 2:o[a++]=n[i|h>>6],o[a++]=n[63&h],c=0}a>8191&&((r||(r=[])).push(String.fromCharCode.apply(String,o)),a=0)}return c&&(o[a++]=n[i],o[a++]=61,1===c&&(o[a++]=61)),r?(a&&r.push(String.fromCharCode.apply(String,o.slice(0,a))),r.join("")):String.fromCharCode.apply(String,o.slice(0,a))};i.decode=function(e,t,s){for(var i,n=s,o=0,a=0;a<e.length;){var c=e.charCodeAt(a++);if(61===c&&o>1)break;if(void 0===(c=r[c]))throw Error("invalid encoding");switch(o){case 0:i=c,o=1;break;case 1:t[s++]=i<<2|(48&c)>>4,i=c,o=2;break;case 2:t[s++]=(15&i)<<4|(60&c)>>2,i=c,o=3;break;case 3:t[s++]=(3&i)<<6|c,o=0}}if(1===o)throw Error("invalid encoding");return s-n},i.test=function(e){return/^(?:[A-Za-z0-9+/]{4})*(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=)?$/.test(e)}},function(e,t,s){"use strict";function i(){this.j={}}e.exports=i,i.prototype.on=function(e,t,s){return(this.j[e]||(this.j[e]=[])).push({fn:t,ctx:s||this}),this},i.prototype.off=function(e,t){if(void 0===e)this.j={};else if(void 0===t)this.j[e]=[];else for(var s=this.j[e],i=0;i<s.length;)s[i].fn===t?s.splice(i,1):++i;return this},i.prototype.emit=function(e){var t=this.j[e];if(t){for(var s=[],i=1;i<arguments.length;)s.push(arguments[i++]);for(i=0;i<t.length;)t[i].fn.apply(t[i++].ctx,s)}return this}},function(e,t,s){"use strict";function i(e){return"undefined"!=typeof Float32Array?function(){var t=new Float32Array([-0]),s=new Uint8Array(t.buffer),i=128===s[3];function n(e,i,n){t[0]=e,i[n]=s[0],i[n+1]=s[1],i[n+2]=s[2],i[n+3]=s[3]}function r(e,i,n){t[0]=e,i[n]=s[3],i[n+1]=s[2],i[n+2]=s[1],i[n+3]=s[0]}function o(e,i){return s[0]=e[i],s[1]=e[i+1],s[2]=e[i+2],s[3]=e[i+3],t[0]}function a(e,i){return s[3]=e[i],s[2]=e[i+1],s[1]=e[i+2],s[0]=e[i+3],t[0]}e.writeFloatLE=i?n:r,e.writeFloatBE=i?r:n,e.readFloatLE=i?o:a,e.readFloatBE=i?a:o}():function(){function t(e,t,s,i){var n=t<0?1:0;if(n&&(t=-t),0===t)e(1/t>0?0:2147483648,s,i);else if(isNaN(t))e(2143289344,s,i);else if(t>34028234663852886e22)e((n<<31|2139095040)>>>0,s,i);else if(t<11754943508222875e-54)e((n<<31|Math.round(t/1401298464324817e-60))>>>0,s,i);else{var r=Math.floor(Math.log(t)/Math.LN2);e((n<<31|r+127<<23|8388607&Math.round(t*Math.pow(2,-r)*8388608))>>>0,s,i)}}function s(e,t,s){var i=e(t,s),n=2*(i>>31)+1,r=i>>>23&255,o=8388607&i;return 255===r?o?NaN:n*(1/0):0===r?1401298464324817e-60*n*o:n*Math.pow(2,r-150)*(o+8388608)}e.writeFloatLE=t.bind(null,n),e.writeFloatBE=t.bind(null,r),e.readFloatLE=s.bind(null,o),e.readFloatBE=s.bind(null,a)}(),"undefined"!=typeof Float64Array?function(){var t=new Float64Array([-0]),s=new Uint8Array(t.buffer),i=128===s[7];function n(e,i,n){t[0]=e,i[n]=s[0],i[n+1]=s[1],i[n+2]=s[2],i[n+3]=s[3],i[n+4]=s[4],i[n+5]=s[5],i[n+6]=s[6],i[n+7]=s[7]}function r(e,i,n){t[0]=e,i[n]=s[7],i[n+1]=s[6],i[n+2]=s[5],i[n+3]=s[4],i[n+4]=s[3],i[n+5]=s[2],i[n+6]=s[1],i[n+7]=s[0]}function o(e,i){return s[0]=e[i],s[1]=e[i+1],s[2]=e[i+2],s[3]=e[i+3],s[4]=e[i+4],s[5]=e[i+5],s[6]=e[i+6],s[7]=e[i+7],t[0]}function a(e,i){return s[7]=e[i],s[6]=e[i+1],s[5]=e[i+2],s[4]=e[i+3],s[3]=e[i+4],s[2]=e[i+5],s[1]=e[i+6],s[0]=e[i+7],t[0]}e.writeDoubleLE=i?n:r,e.writeDoubleBE=i?r:n,e.readDoubleLE=i?o:a,e.readDoubleBE=i?a:o}():function(){function t(e,t,s,i,n,r){var o=i<0?1:0;if(o&&(i=-i),0===i)e(0,n,r+t),e(1/i>0?0:2147483648,n,r+s);else if(isNaN(i))e(0,n,r+t),e(2146959360,n,r+s);else if(i>17976931348623157e292)e(0,n,r+t),e((o<<31|2146435072)>>>0,n,r+s);else{var a;if(i<22250738585072014e-324)e((a=i/5e-324)>>>0,n,r+t),e((o<<31|a/4294967296)>>>0,n,r+s);else{var c=Math.floor(Math.log(i)/Math.LN2);1024===c&&(c=1023),e(4503599627370496*(a=i*Math.pow(2,-c))>>>0,n,r+t),e((o<<31|c+1023<<20|1048576*a&1048575)>>>0,n,r+s)}}}function s(e,t,s,i,n){var r=e(i,n+t),o=e(i,n+s),a=2*(o>>31)+1,c=o>>>20&2047,h=4294967296*(1048575&o)+r;return 2047===c?h?NaN:a*(1/0):0===c?5e-324*a*h:a*Math.pow(2,c-1075)*(h+4503599627370496)}e.writeDoubleLE=t.bind(null,n,0,4),e.writeDoubleBE=t.bind(null,r,4,0),e.readDoubleLE=s.bind(null,o,0,4),e.readDoubleBE=s.bind(null,a,4,0)}(),e}function n(e,t,s){t[s]=255&e,t[s+1]=e>>>8&255,t[s+2]=e>>>16&255,t[s+3]=e>>>24}function r(e,t,s){t[s]=e>>>24,t[s+1]=e>>>16&255,t[s+2]=e>>>8&255,t[s+3]=255&e}function o(e,t){return(e[t]|e[t+1]<<8|e[t+2]<<16|e[t+3]<<24)>>>0}function a(e,t){return(e[t]<<24|e[t+1]<<16|e[t+2]<<8|e[t+3])>>>0}e.exports=i(i)},function(e,t,s){"use strict";var i=t;i.length=function(e){for(var t=0,s=0,i=0;i<e.length;++i)(s=e.charCodeAt(i))<128?t+=1:s<2048?t+=2:55296==(64512&s)&&56320==(64512&e.charCodeAt(i+1))?(++i,t+=4):t+=3;return t},i.read=function(e,t,s){if(s-t<1)return"";for(var i,n=null,r=[],o=0;t<s;)(i=e[t++])<128?r[o++]=i:i>191&&i<224?r[o++]=(31&i)<<6|63&e[t++]:i>239&&i<365?(i=((7&i)<<18|(63&e[t++])<<12|(63&e[t++])<<6|63&e[t++])-65536,r[o++]=55296+(i>>10),r[o++]=56320+(1023&i)):r[o++]=(15&i)<<12|(63&e[t++])<<6|63&e[t++],o>8191&&((n||(n=[])).push(String.fromCharCode.apply(String,r)),o=0);return n?(o&&n.push(String.fromCharCode.apply(String,r.slice(0,o))),n.join("")):String.fromCharCode.apply(String,r.slice(0,o))},i.write=function(e,t,s){for(var i,n,r=s,o=0;o<e.length;++o)(i=e.charCodeAt(o))<128?t[s++]=i:i<2048?(t[s++]=i>>6|192,t[s++]=63&i|128):55296==(64512&i)&&56320==(64512&(n=e.charCodeAt(o+1)))?(i=65536+((1023&i)<<10)+(1023&n),++o,t[s++]=i>>18|240,t[s++]=i>>12&63|128,t[s++]=i>>6&63|128,t[s++]=63&i|128):(t[s++]=i>>12|224,t[s++]=i>>6&63|128,t[s++]=63&i|128);return s-r}},function(e,t,s){"use strict";e.exports=function(e,t,s){var i=s||8192,n=i>>>1,r=null,o=i;return function(s){if(s<1||s>n)return e(s);o+s>i&&(r=e(i),o=0);var a=t.call(r,o,o+=s);return 7&o&&(o=1+(7|o)),a}}},function(e,t,s){"use strict";e.exports=n;var i=s(2);function n(e,t){this.lo=e>>>0,this.hi=t>>>0}var r=n.zero=new n(0,0);r.toNumber=function(){return 0},r.zzEncode=r.zzDecode=function(){return this},r.length=function(){return 1};var o=n.zeroHash="\0\0\0\0\0\0\0\0";n.fromNumber=function(e){if(0===e)return r;var t=e<0;t&&(e=-e);var s=e>>>0,i=(e-s)/4294967296>>>0;return t&&(i=~i>>>0,s=~s>>>0,++s>4294967295&&(s=0,++i>4294967295&&(i=0))),new n(s,i)},n.from=function(e){if("number"==typeof e)return n.fromNumber(e);if(i.isString(e)){if(!i.Long)return n.fromNumber(parseInt(e,10));e=i.Long.fromString(e)}return e.low||e.high?new n(e.low>>>0,e.high>>>0):r},n.prototype.toNumber=function(e){if(!e&&this.hi>>>31){var t=1+~this.lo>>>0,s=~this.hi>>>0;return t||(s=s+1>>>0),-(t+4294967296*s)}return this.lo+4294967296*this.hi},n.prototype.toLong=function(e){return i.Long?new i.Long(0|this.lo,0|this.hi,Boolean(e)):{low:0|this.lo,high:0|this.hi,unsigned:Boolean(e)}};var a=String.prototype.charCodeAt;n.fromHash=function(e){return e===o?r:new n((a.call(e,0)|a.call(e,1)<<8|a.call(e,2)<<16|a.call(e,3)<<24)>>>0,(a.call(e,4)|a.call(e,5)<<8|a.call(e,6)<<16|a.call(e,7)<<24)>>>0)},n.prototype.toHash=function(){return String.fromCharCode(255&this.lo,this.lo>>>8&255,this.lo>>>16&255,this.lo>>>24,255&this.hi,this.hi>>>8&255,this.hi>>>16&255,this.hi>>>24)},n.prototype.zzEncode=function(){var e=this.hi>>31;return this.hi=((this.hi<<1|this.lo>>>31)^e)>>>0,this.lo=(this.lo<<1^e)>>>0,this},n.prototype.zzDecode=function(){var e=-(1&this.lo);return this.lo=((this.lo>>>1|this.hi<<31)^e)>>>0,this.hi=(this.hi>>>1^e)>>>0,this},n.prototype.length=function(){var e=this.lo,t=(this.lo>>>28|this.hi<<4)>>>0,s=this.hi>>>24;return 0===s?0===t?e<16384?e<128?1:2:e<2097152?3:4:t<16384?t<128?5:6:t<2097152?7:8:s<128?9:10}},function(e,t,s){"use strict";e.exports=o;var i=s(9);(o.prototype=Object.create(i.prototype)).constructor=o;var n=s(2),r=n.Buffer;function o(){i.call(this)}o.alloc=function(e){return(o.alloc=n.g)(e)};var a=r&&r.prototype instanceof Uint8Array&&"set"===r.prototype.set.name?function(e,t,s){t.set(e,s)}:function(e,t,s){if(e.copy)e.copy(t,s,0,e.length);else for(var i=0;i<e.length;)t[s++]=e[i++]};function c(e,t,s){e.length<40?n.utf8.write(e,t,s):t.utf8Write(e,s)}o.prototype.bytes=function(e){n.isString(e)&&(e=n.u(e,"base64"));var t=e.length>>>0;return this.uint32(t),t&&this.S(a,t,e),this},o.prototype.string=function(e){var t=r.byteLength(e);return this.uint32(t),t&&this.S(c,t,e),this}},function(e,t,s){"use strict";e.exports=r;var i=s(10);(r.prototype=Object.create(i.prototype)).constructor=r;var n=s(2);function r(e){i.call(this,e)}n.Buffer&&(r.prototype.C=n.Buffer.prototype.slice),r.prototype.string=function(){var e=this.uint32();return this.buf.utf8Slice(this.pos,this.pos=Math.min(this.pos+e,this.len))}},function(e,t,s){"use strict";e.exports=n;var i=s(2);function n(e,t,s){if("function"!=typeof e)throw TypeError("rpcImpl must be a function");i.EventEmitter.call(this),this.rpcImpl=e,this.requestDelimited=Boolean(t),this.responseDelimited=Boolean(s)}(n.prototype=Object.create(i.EventEmitter.prototype)).constructor=n,n.prototype.rpcCall=function e(t,s,n,r,o){if(!r)throw TypeError("request must be specified");var a=this;if(!o)return i.asPromise(e,a,t,s,n,r);if(a.rpcImpl)try{return a.rpcImpl(t,s[a.requestDelimited?"encodeDelimited":"encode"](r).finish(),(function(e,s){if(e)return a.emit("error",e,t),o(e);if(null!==s){if(!(s instanceof n))try{s=n[a.responseDelimited?"decodeDelimited":"decode"](s)}catch(e){return a.emit("error",e,t),o(e)}return a.emit("data",s,t),o(null,s)}a.end(!0)}))}catch(e){return a.emit("error",e,t),void setTimeout((function(){o(e)}),0)}else setTimeout((function(){o(Error("already ended"))}),0)},n.prototype.end=function(e){return this.rpcImpl&&(e||this.rpcImpl(null,null,null),this.rpcImpl=null,this.emit("end").off()),this}},function(e,t,s){"use strict";function i(e,t){"string"==typeof e&&(t=e,e=void 0);var s=[];function n(e){if("string"!=typeof e){var t=r();if(i.verbose&&console.log("codegen: "+t),t="return "+t,e){for(var o=Object.keys(e),a=new Array(o.length+1),c=new Array(o.length),h=0;h<o.length;)a[h]=o[h],c[h]=e[o[h++]];return a[h]=t,Function.apply(null,a).apply(null,c)}return Function(t)()}for(var u=new Array(arguments.length-1),d=0;d<u.length;)u[d]=arguments[++d];if(d=0,e=e.replace(/%([%dfijs])/g,(function(e,t){var s=u[d++];switch(t){case"d":case"f":return String(Number(s));case"i":return String(Math.floor(s));case"j":return JSON.stringify(s);case"s":return String(s)}return"%"})),d!==u.length)throw Error("parameter count mismatch");return s.push(e),n}function r(i){return"function "+(i||t||"")+"("+(e&&e.join(",")||"")+"){\n  "+s.join("\n  ")+"\n}"}return n.toString=r,n}e.exports=i,i.verbose=!1},function(e,t,s){"use strict";e.exports=r;var i=s(13),n=s(14)("fs");function r(e,t,s){return"function"==typeof t?(s=t,t={}):t||(t={}),s?!t.xhr&&n&&n.readFile?n.readFile(e,(function(i,n){return i&&"undefined"!=typeof XMLHttpRequest?r.xhr(e,t,s):i?s(i):s(null,t.binary?n:n.toString("utf8"))})):r.xhr(e,t,s):i(r,this,e,t)}r.xhr=function(e,t,s){var i=new XMLHttpRequest;i.onreadystatechange=function(){if(4===i.readyState){if(0!==i.status&&200!==i.status)return s(Error("status "+i.status));if(t.binary){var e=i.response;if(!e){e=[];for(var n=0;n<i.responseText.length;++n)e.push(255&i.responseText.charCodeAt(n))}return s(null,"undefined"!=typeof Uint8Array?new Uint8Array(e):e)}return s(null,i.responseText)}},t.binary&&("overrideMimeType"in i&&i.overrideMimeType("text/plain; charset=x-user-defined"),i.responseType="arraybuffer"),i.open("GET",e),i.send()}},function(e,t,s){"use strict";var i=t,n=i.isAbsolute=function(e){return/^(?:\/|\w+:)/.test(e)},r=i.normalize=function(e){var t=(e=e.replace(/\\/g,"/").replace(/\/{2,}/g,"/")).split("/"),s=n(e),i="";s&&(i=t.shift()+"/");for(var r=0;r<t.length;)".."===t[r]?r>0&&".."!==t[r-1]?t.splice(--r,2):s?t.splice(r,1):++r:"."===t[r]?t.splice(r,1):++r;return i+t.join("/")};i.resolve=function(e,t,s){return s||(t=r(t)),n(t)?t:(s||(e=r(e)),(e=e.replace(/(?:\/|^)[^/]+$/,"")).length?r(e+"/"+t):t)}},function(e,t,s){"use strict";var i;s.r(t),function(e){e.TRACE="trace",e.DEBUG="debug",e.INFO="info",e.WARN="warn",e.ERROR="error",e.SILENT="silent"}(i||(i={}));class n{static make(e){"object"==typeof e&&(Object.freeze(e),Object.keys(e).forEach((e,t,s)=>{n.make(e)}))}static copy(e,t){const s={};return Object.keys(e).forEach((i,n,r)=>{s[i]=void 0!==t[i]?t[i]:e[i]}),Object.freeze(s),s}static getOrDefault(e,t){return void 0===e?t:e}static update(e,t){return void 0!==t?t:e}}class r{constructor(e,t,s,i,r){this.timestamp=e,this.logger=t,this.level=s,this.message=i,this.error=r,n.make(this)}}class o{static isArray(e){return Array.isArray(e)}static isBoolean(e){return"boolean"==typeof e}static isDate(e){return e instanceof Date||"Date"===e.constructor.name}static isError(e){return e instanceof Error&&void 0!==e.message}static isFunction(e){return"function"==typeof e}static isNull(e){return null===e}static isNumber(e){return"number"==typeof e&&isFinite(e)}static isObject(e){return e&&"object"==typeof e&&e.constructor===Object}static isString(e){return"string"==typeof e||e instanceof String}static isSymbol(e){return"symbol"==typeof e}static isRegExp(e){return e&&"object"==typeof e&&e.constructor===RegExp}static isUndefined(e){return void 0===e}static isSet(e){return!o.isNull(e)&&!o.isUndefined(e)}static isNotSet(e){return!o.isSet(e)}static switch(e,t){if(o.isUndefined(t)||o.isNull(t))throw new Error("matcher must be defined.");if(o.isArray(e)&&!o.isUndefined(t.array))t.array(e);else if(o.isBoolean(e)&&!o.isUndefined(t.boolean))t.boolean(e);else if(o.isError(e)&&!o.isUndefined(t.error))t.error(e);else if(o.isDate(e)&&!o.isUndefined(t.date))t.date(e);else if(o.isFunction(e)&&!o.isUndefined(t.function))t.function(e);else if(o.isNull(e)&&!o.isUndefined(t.null))t.null();else if(o.isNumber(e)&&!o.isUndefined(t.number))t.number(e);else if(o.isObject(e)&&!o.isUndefined(t.object))t.object(e);else if(o.isRegExp(e)&&!o.isUndefined(t.regexp))t.regexp(e);else if(o.isString(e)&&!o.isUndefined(t.string))t.string(e);else if(o.isSymbol(e)&&!o.isUndefined(t.symbol))t.symbol(e);else if(o.isUndefined(e)&&!o.isUndefined(t.undefined))t.undefined();else{const s=o.isArray(t.custom)?t.custom.find(t=>o.isFunction(t.test)&&o.isFunction(t.callback)&&t.test(e)):void 0;o.isUndefined(s)?o.isUndefined(t.default)||t.default(e):s.callback(e)}}}const a={SILENT:-1,TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4};class c{constructor(e,t,s){this.N=e,this.U=s,this.setLevel(t)}getId(){return this.N}getLevel(){return this.k}setLevel(e){this.k=e,this.V=a[this.k.toUpperCase()]}trace(e){if(a.TRACE>=this.V){const t=new r(new Date,this.N,i.TRACE,this.L(e));this.G(t)}}debug(e){if(a.DEBUG>=this.V){const t=new r(new Date,this.N,i.DEBUG,this.L(e));this.G(t)}}info(e){if(a.INFO>=this.V){const t=new r(new Date,this.N,i.INFO,this.L(e));this.G(t)}}warn(e){if(a.WARN>=this.V){const t=new r(new Date,this.N,i.WARN,this.L(e));this.G(t)}}error(e,t){if(a.ERROR>=this.V){const s=new r(new Date,this.N,i.ERROR,this.L(e),t);this.G(s)}}G(e){this.U.forEach(t=>t.writeLog(e))}L(e){return o.isFunction(e)?e():e}}function h(e,t){return Object.keys(e).reduce((s,i)=>(s[i]=t(e[i]),s),{})}function u(e,t){return Object.keys(e).forEach(s=>{t(s,e[s])})}function d(e){const t=typeof e;if(null==e||"string"===t||"number"===t||"boolean"===t)return e;if(e instanceof Date)return new Date(e.getTime());if(Array.isArray(e))return e.map(e=>d(e));if(e instanceof Map){const t=new Map;return e.forEach((e,s)=>{t.set(s,d(e))}),t}if(e instanceof Set){const t=new Set;return e.forEach(e=>t.add(d(e))),t}if(e.constructor===Object){const t={};return Object.keys(e).forEach(s=>{t[s]=d(e[s])}),t}const s=e.constructor.name||e.constructor.toString();throw new Error("Can not clone unknown type: "+s)}class l{static isSet(e){return!l.isNotSet(e)}static isNotSet(e){return null==e}static nonEmptyString(e){return"string"==typeof e&&e.length>0}static assertNonEmptyString(e,t){if(void 0===t&&(t="value"),!l.nonEmptyString(e))throw new Error(t+" must be a non-empty string: "+typeof e)}static assertString(e,t){if("string"!=typeof e)throw new Error(`${l.getValueName(t)} must be a string: ${typeof e}`)}static assertValidStringIndex(e,t,s,i){l.assertValidIndex(e,0,s?t.length+1:t.length,i)}static assertNumber(e,t){if("number"!=typeof e)throw new Error(`${l.getValueName(t)} must be a number: ${typeof e}`)}static assertArray(e,t){if(!Array.isArray(e))throw new Error(`${l.getValueName(t)} must be an array: ${typeof e}`)}static assertNonEmptyArray(e,t){if(l.assertArray(e,t),0===e.length)throw new Error(`${l.getValueName(t)} must be a non-empty array: ${typeof e}`)}static assertValidArrayIndex(e,t,s){l.assertValidIndex(e,0,t.length,s)}static assertValidIndex(e,t,s,i){if(l.assertNumber(e,i),e<t||e>=s)throw i=l.getValueName(i),new Error(`Index out of bounds. ${i} must be > 0 and <= ${s}: ${e}`)}static assertBoolean(e,t){if("boolean"!=typeof e)throw new Error(`${l.getValueName(t)} must be a boolean but was: ${typeof e}`)}static assertDate(e,t){if(!o.isDate(e))throw new Error(`${l.getValueName(t)} must be a Date but was: ${e.constructor.name}`)}static getValueName(e,t){return e||t||"value"}}class p{constructor(e){this.$=new Map,o.isSet(e.loggers)&&u(e.loggers,(e,t)=>{if(!l.nonEmptyString(e))throw new Error("A logger's id must be a non-empty string");this.$.set(e,this.F(t))}),this.$.set(p.ROOT_LOGGER_ID,this.F(e.root))}resolveLoggerConfig(e){let t=e,s=this.$.get(t);for(;void 0===s&&""!==t;){const e=t.lastIndexOf(".");t=t.substring(0,e),s=this.$.get(t)}return void 0!==s?s:this.$.get(p.ROOT_LOGGER_ID)}F(e){return o.isString(e)?{level:e}:e}}p.ROOT_LOGGER_ID="";class f{constructor(e){this.J=e||f.DEFAULT_PATTERN}H(e){return`${this.B(e.level.toUpperCase(),5," ",!1)} ${this.W(e)} ${e.message}`}W(e){const t=e.timestamp;return this.B(t.getHours(),2,"0")+":"+this.B(t.getMinutes(),2,"0")+":"+this.B(t.getSeconds(),2,"0")+"."+this.B(t.getMilliseconds(),3,"0")}B(e,t,s,i=!0){let n=String(e);for(;n.length<t;)n=i?s+n:n+s;return n}}f.FIELDS={LOG_NAME:"%l",MESSAGE:"%m",DATE_TIME:"%t",LOG_LEVEL:"%p"},f.DEFAULT_PATTERN="%t %p %m";class m extends f{constructor(e){super(e)}writeLog(e){switch(e.level){case i.TRACE:case i.DEBUG:console.debug(this.H(e));break;case i.INFO:console.info(this.H(e));break;case i.WARN:console.warn(this.H(e));break;case i.ERROR:e.error?console.error(this.H(e)+"\n",e.error):console.error(this.H(e))}}}const g={root:{level:i.WARN}};const v=new class{constructor(e){this.configure(e||{}),this.Y=new m("")}configure(e){const t=Object.assign(Object.assign({},g),e);this.K=new p(t),this.$=new Map}root(){return this.logger()}logger(e){if(null==e&&(e=p.ROOT_LOGGER_ID),!this.$.has(e)){const t=this.K.resolveLoggerConfig(e);this.$.set(e,new c(e,t.level,[this.Y]))}return this.$.get(e)}};class y{constructor(e,t,s){this.Z=e,this.X=t,this.ee=s,this.te=!1,this.se=v.logger("heartbeat")}setPingInterval(e){this.X=e}getPingInterval(){return this.X}setPongTimeout(e){this.ee=e}getPongTimeout(){return this.ee}messageReceived(){this.te&&(this.cancelPongTimeout(),this.restartPingTimeout())}start(){if(null==this.Z)throw new Error("Can't start the HeartbeatManager unless the callback is set.");this.se.debug(()=>"HeartbeatHelper started with Ping Interval "+this.X+" and Pong Timeout "+this.ee),this.te=!0,this.messageReceived()}stop(){this.te=!1,this.stopPingTimer(),this.cancelPongTimeout(),this.se.debug(()=>"HeartbeatHelper stopped.")}get started(){return this.te}get stopped(){return!this.te}dispose(){this.stop()}sendPing(){this.Z.sendPing(),this.schedulePongTimeout()}schedulePongTimeout(){this.ie=setTimeout(()=>{this.Z.onTimeout()},1e3*this.ee)}cancelPongTimeout(){null!=this.ie&&(clearTimeout(this.ie),this.ie=null)}stopPingTimer(){null!=this.ne&&(clearTimeout(this.ne),this.ne=null)}restartPingTimeout(){this.stopPingTimer(),this.ne=setTimeout(()=>{this.sendPing()},1e3*this.X)}}var w=s(4),b=s(0);class O extends Error{constructor(e,t,s){super(e),this.re=t,this.oe=s||{},this.name="ConvergenceError",Object.setPrototypeOf(this,O.prototype)}get code(){return this.re}get details(){return this.oe}}class R{constructor(){this.ae=new w.Subject,this.ce=this.ae.asObservable().pipe(Object(b.share)()),this.j={}}static he(e){if("string"==typeof e)return e.toLowerCase();throw new Error("Event names must be strings")}addListener(e,t){if("function"!=typeof t)throw new TypeError("Listeners must be functions");e=R.he(e);let s=this.j[e];if(void 0===s)s=[],this.j[e]=s;else if(void 0!==s.find(e=>e.listener===t))return this;const i=this.ce.pipe(Object(b.filter)(t=>t.name.toLowerCase()===e)).subscribe(e=>{t(e)});return s.push({listener:t,subscription:i}),this}on(e,t){return this.addListener(e,t)}once(e,t){const s=i=>{this.removeListener(e,s),t(i)};return this.addListener(e,s)}removeAllListeners(){return Object.keys(this.j).forEach(e=>this.removeListeners(e)),this}removeListeners(e){return e=R.he(e),this.j[e].forEach(e=>e.subscription.unsubscribe()),delete this.j[e],this}removeListener(e,t){e=R.he(e);const s=this.j[e];if(void 0!==s){const e=s.findIndex(e=>e.listener===t);if(-1!==e){const t=s[e];s.splice(e,1),t.subscription.unsubscribe()}}return this}off(e,t){return this.removeListener(e,t)}events(){return this.ce}ue(e){return e.subscribe(e=>{this.ae.next(e)},e=>{this.ae.error(e)})}de(e){if(l.isNotSet(e.name))throw new O("An event must have a name.");this.ae.next(e)}le(){this.ae.complete()}}class M extends Error{constructor(e,t,s){super(e),this.re=t,this.oe=s,Object.setPrototypeOf(this,M.prototype)}get code(){return this.re}get details(){return this.oe}}class E{constructor(){this.pe=null,this.fe=!1}static create(){return new E}cancel(){if(null===this.pe)throw new Error("The cancellation token must be bound before calling cancel.");if(this.fe)throw new Error("The cancellation token has already been cancelled.");this.pe(),this.fe=!0}isBound(){return null!==this.pe}me(e){if("function"!=typeof e)throw new Error("callback must be a function");if(null!==this.pe)throw new Error("The cancellation token was already bound");this.pe=e}}class I{constructor(e,t,s){this.data=e,this.offset=t,this.totalResults=s,Object.freeze(this),Object.freeze(e)}}class S{constructor(){this.ge=!1,this.ve=!1}isPending(){return!this.ve&&!this.ge}isRejected(){return this.ge}isResolved(){return this.ve}resolve(e){this.ge=!1,this.ve=!0}reject(e){this.ge=!0,this.ve=!1}resolveFromPromise(e){e.then(e=>this.resolve(e)).catch(e=>this.reject(e))}}class C extends S{constructor(){super(),this.ye=new Promise((e,t)=>{this.we=e,this.be=t})}resolve(e){super.resolve(e),this.we(e)}reject(e){super.reject(e),this.be(e)}promise(){return this.ye}}class x extends R{constructor(e,t,s){super(),this.se=v.logger("socket");let i=e;i=(i=i.replace(/https:/i,"wss:")).replace(/http:/i,"ws:"),this.Oe=i,this.Re=null,this.Me=null!==t?t:WebSocket,this.Ee=null!==s?s:e=>new this.Me(e)}get url(){return this.Oe}open(){if(this.Ie=new C,this.Re&&this.Re.readyState===this.Me.CONNECTING)throw new Error("Socket already in the process of opening.");if(this.Re&&this.Re.readyState===this.Me.OPEN)throw new Error("Can not call connect on a socket that is already connected.");if(this.Re&&this.Re.readyState===this.Me.CLOSING)throw new Error("Can not call connect on a socket that is in the process of closing.");return this.Re=this.Ee(this.Oe),this.Re.binaryType="arraybuffer",this.Se(this.Re),this.Ie.promise()}close(){this.Ce(!0)}terminate(e){this.Ce(!1,e)}isOpen(){return null!==this.Re&&this.Re.readyState===this.Me.OPEN}isConnecting(){return null===this.Re||this.Re.readyState===this.Me.CONNECTING}isClosed(){return null===this.Re||this.Re.readyState===this.Me.CLOSED}send(e){if(!this.isOpen())throw new Error("Can't send messages because the WebSocket is not open.");this.Re.send(e)}Ce(e,t){if(!this.Re||this.Re.readyState===this.Me.CLOSED)throw this.se.debug("Can't close a closed WebSocket."),new Error("Can not close on a WebSocket in the CLOSED state.");if(this.Re.readyState===this.Me.CLOSING)throw this.se.debug("Attempted to close a WebSocket that was already closing."),new Error("Connection is already closing.");{this.se.debug("Closing a connecting Web Socket."),this.xe(this.Re);const s=this.Re;if(this.Re=null,e?(this.se.debug("Closing Web Socket normally."),s.close(1e3)):(this.se.debug("Closing Web Socket abnormally."),s.close(4006,t)),null!==this.Ie){const e=this.Ie;this.Ie=null,e.reject(new Error("Web Socket connection closed while opening."))}const i={name:x.Events.CLOSE,reason:"close requested by client"};this.de(i)}}xe(e){e.onmessage=void 0,e.onopen=void 0,e.onerror=void 0,e.onclose=void 0}Se(e){e.onmessage=e=>{try{if(!(e.data instanceof ArrayBuffer))throw new O("Convergence protocol does not accept text frames: "+e.data);{const t=new Uint8Array(e.data);this.de({name:x.Events.MESSAGE,message:t})}}catch(e){this.de({name:x.Events.ERROR,error:e}),this.se.error("Error handling  web socket frame",e)}},e.onopen=e=>{if(this.Ie){this.se.debug("Web Socket connection opened");try{this.Ie.resolve()}catch(e){this.se.error("Error resolving WebSocket Open Promise.",e)}this.Ie=null}else{const e={name:x.Events.ERROR,error:new O("Received onOpen event while in state: "+this.Re.readyState)};this.de(e)}},e.onerror=e=>{if(void 0===this.Re||this.Re.readyState===this.Me.CONNECTING){this.se.debug("Web Socket error.");try{const e={name:x.Events.ERROR,error:new O("Unknown web socket error")};this.de(e)}catch(e){this.se.error("Error handling WebSocket error.",e)}}},e.onclose=t=>{this.se.debug(()=>`Web Socket close event: {code: ${t.code}, reason: "${t.reason}"}`),this.xe(e),this.Re=null;try{if(this.Ie)this.se.debug(()=>`Web Socket connection failed: {code: ${t.code}, reason: "${t.reason}"}`),this.Ie.reject(new Error(`Could not connect. The WebSocket closed while connecting: {code: ${t.code}, reason: "${t.reason}"}`)),this.Ie=null;else{this.se.debug(()=>`Web Socket connection unexpectedly closed: {code: ${t.code}, reason: "${t.reason}"}`);const e={name:x.Events.CLOSE,reason:"unexpected Web Socket closure."};this.de(e)}}catch(e){this.se.error("Error handling web socket close event.",e)}}}}x.Events={MESSAGE:"message",ERROR:"error",CLOSE:"close"};var D=s(27),_=s.t(D,2);const P=s(28).Root.fromJSON(_);class A{static decode(e){const t=A.De.decode(e);return A.De.toObject(t)}static encode(e){const t=A.De.fromObject(e);return A.De.encode(t).finish()}}A.De=P.lookupType("com.convergencelabs.convergence.proto.ConvergenceMessage");const T={REQUEST_TIMEOUT:"request_timeout",AUTHENTICATION_FAILED:"authentication_failed",OFFLINE:"offline",CHAT_NOT_JOINED:"chat_not_joined"};n.make(T);class j extends R{constructor(e,t){super(),this._e=0,this.Pe=!1,this.Ae=v.logger("protocol.messages"),this.Te=v.logger("protocol.ping"),this.je=t,this.Re=e,this.Re.on(x.Events.MESSAGE,e=>{this.Ne(e.message)}),this.Re.on(x.Events.ERROR,e=>{this.Ue(e.error)}),this.Re.on(x.Events.CLOSE,e=>{this.Pe?this.qe(e.reason):this.ke()}),this.Ve=new Map}connect(){return this.Re.open()}handshake(e){const t={reconnectToken:void 0!==e?{value:e}:null,client:"JavaScript",clientVersion:"1.0.0-rc.5"};return this.request({handshakeRequest:t}).then(e=>{const t=e.handshakeResponse,s={sendPing:()=>{this.sendMessage({ping:{}})},onTimeout:()=>{this.abort("pong timeout")}};return this.Le=new y(s,this.je.heartbeatConfig.pingInterval,this.je.heartbeatConfig.pongTimeout),this.je.heartbeatConfig.enabled&&this.Le.start(),t})}send(e){this.sendMessage(e)}request(e,t){const s=this._e;this._e++;const i=new C,n=1e3*(void 0!==t?t:this.je.defaultRequestTimeout),r=setTimeout(()=>{const t=this.Ve.get(s);t&&t.replyDeferred.reject(new O("A request timeout occurred.",T.REQUEST_TIMEOUT,{message:e}))},n);return this.Ve.set(s,{reqId:s,replyDeferred:i,timeoutTask:r}),this.sendMessage(Object.assign(Object.assign({},e),{requestId:{value:s}})),i.promise()}abort(e){this.Le&&this.Le.started&&this.Le.stop(),(this.Re.isOpen()||this.Re.isConnecting())&&this.Re.terminate(e),this.ke()}close(){this.Pe=!0,this.removeAllListeners(),void 0!==this.Le&&this.Le.started&&this.Le.stop(),this.Re.close()}sendMessage(e){(e.ping||e.pong?this.Te:this.Ae).debug(()=>"SND: "+JSON.stringify(e));try{const t=A.encode(e);this.Re.send(t)}catch(e){throw this.Ue(e),e}}Ne(e){const t=A.decode(e);this.je.heartbeatConfig.enabled&&this.Le&&this.Le.messageReceived(),(t.ping||t.pong?this.Te:this.Ae).debug(()=>"RCV: "+JSON.stringify(t)),t.ping?this.Ge():t.pong||(void 0!==t.requestId?this.$e(t):void 0!==t.responseId?this.Fe(t):this.Je(t))}qe(e){this.Le&&this.Le.started&&this.Le.stop();const t={name:j.Events.CLOSED,reason:e};this.de(t)}ke(){this.Le&&this.Le.started&&this.Le.stop(),this.de({name:j.Events.DROPPED})}Ue(e){const t={name:j.Events.ERROR,error:e};this.de(t)}Je(e){Promise.resolve().then(()=>{const t={name:"message",request:!1,message:e};this.de(t)})}$e(e){const t=e.requestId.value||0,s={name:"message",request:!0,callback:new N(t,this),message:e};this.de(s)}Fe(e){const t=e.responseId.value||0,s=this.Ve.get(t);if(this.Ve.delete(t),s)if(clearTimeout(s.timeoutTask),e.error){const t=e.error;s.replyDeferred.reject(new M(t.message,t.code,t.details))}else s.replyDeferred.resolve(e)}Ge(){this.sendMessage({pong:{}})}}j.Events={MESSAGE:"message",ERROR:"error",CLOSED:"close",DROPPED:"dropped"};class N{constructor(e,t){this.He=e,this.Be=t}reply(e){this.Be.sendMessage(Object.assign(Object.assign({},e),{responseId:{value:this.He}}))}unknownError(){this.unexpectedError("An unknown error has occurred")}unexpectedError(e){this.expectedError("unknown",e)}expectedError(e,t,s){const i={code:e,message:t,details:s=s||{}};this.Be.sendMessage({error:i,responseId:{value:this.He}})}}class U{constructor(e,t,s,i,n){this.We=e,this.ze=i,this.Ye=s,this.Qe=n,this.Ke=t}domain(){return this.We}sessionId(){return this.ze}user(){return this.Ye}reconnectToken(){return this.Qe}isAuthenticated(){return this.Ke.isAuthenticated()}isConnected(){return this.Ke.isConnected()}assertOnline(){if(!this.isAuthenticated()){throw new O("Cannot perform this action while offline",T.OFFLINE)}}Ze(e){this.ze=e}Xe(e){this.Ye=e}et(e){this.Qe=e}}var q;!function(e){e.NORMAL="normal",e.CONVERGENCE="convergence",e.ANONYMOUS="anonymous"}(q||(q={}));class k{constructor(e,t){this.userType=e,this.username=t,this.tt=k.guid(this.userType,this.username),Object.freeze(this)}static normal(e){return new k(q.NORMAL,e)}static anonymous(e){return new k(q.ANONYMOUS,e)}static guid(e,t){return`${e}:${t}`}static toDomainUserId(e){return e instanceof k?e:k.normal(e)}toGuid(){return this.tt}equals(e){return this.username===e.username&&this.userType===e.userType}}class V{constructor(e,t,s,i,n,r){this.userType=e,this.username=t,this.firstName=s,this.lastName=i,this.displayName=n,this.email=r,this.anonymous=e===q.ANONYMOUS,this.convergence=e===q.CONVERGENCE,this.normal=e===q.NORMAL,this.userId=new k(this.userType,this.username),Object.freeze(this)}}class L{constructor(e,t,s){this.id=e,this.description=t,this.members=s,Object.freeze(this)}}function G(e){switch(e){case"username":return 1;case"email":return 2;case"firstName":return 3;case"lastName":return 4;case"displayName":return 5;default:throw new O("Invalid user field: "+e)}}function $(e){return new V(re(e.userId.userType),e.userId.username,Z(e.firstName),Z(e.lastName),Z(e.displayName),Z(e.email))}const F=["username","email","firstName","lastName","displayName"];class J{constructor(e){this.Ke=e}session(){return this.Ke.session()}profile(){return this.user(this.Ke.session().user().userId)}userExists(e){return this.user(e).then(e=>void 0!==e)}user(e){return l.isNotSet(e)?Promise.reject("Must specify a user id."):this.users([e]).then(e=>0===e.length?Promise.resolve(void 0):1===e.length?Promise.resolve(e[0]):Promise.reject(new Error("Error getting user.")))}users(e){if(l.assertArray(e,"users"),0===e.length)return Promise.resolve([]);const t=e.map(e=>e instanceof k?e:k.normal(e)),s={usersGetRequest:{userIds:Array.from(new Set(t)).map(ne)}};return this.Ke.request(s).then(H)}search(e){if(void 0===e.fields||null===e.fields||Array.isArray(e.fields)&&0===e.fields.length)return Promise.reject(new Error("Must specify at least one field to search"));if(void 0===e.term||null===e.term)return Promise.reject(new Error("Must specify a search term"));{const t=Array.isArray(e.fields)?e.fields:[e.fields],s=e.orderBy||{field:"username",ascending:!0},i={userSearchRequest:{fields:this.st(t),value:e.term,offset:K(e.offset),limit:K(e.limit),orderField:G(s.field||"username"),ascending:s.ascending}};return this.Ke.request(i).then(H)}}groups(e){l.assertNonEmptyArray(e,"ids");const t={userGroupsRequest:{ids:e}};return this.Ke.request(t).then(e=>{const{userGroupsResponse:t}=e;return t.groupData.map(e=>(function(e){return new L(e.id,e.description,e.members?e.members.map(e=>ie(e).username):[])})(e))})}group(e){return this.groups([e]).then(e=>e[0])}groupsForUser(e){return this.groupsForUsers([e]).then(t=>t[e])}groupsForUsers(e){const t={userGroupsForUsersRequest:{users:e.map(e=>ne(k.normal(e)))}};return this.Ke.request(t).then(e=>{const{userGroupsForUsersResponse:t}=e,s={};return t.userGroups.forEach(e=>{if(e.hasOwnProperty("user")){let t=ie(e.user);s[t.username]=e.groups}}),s})}st(e){const t=[];return e.forEach(e=>{if(F.indexOf(e)<0)throw new Error("Invalid user search field: "+e);const s=G(e);t.indexOf(s)<0&&t.push(s)}),t}}function H(e){const{userListResponse:t}=e;return Y(t.userData).map($)}function B(e){return null==e?0:"number"==typeof e?e:e.toNumber()}function W(e){return e||!1}function z(e){return e||""}function Y(e){return e||[]}function Q(e){return e||{}}function K(e){return void 0===e?null:{value:e}}function Z(e){return e?e.value:null}function X(e){const t=B(e.seconds),s=B(e.nanos),i=Math.round(s/1e6);return new Date(1e3*t+i)}function ee(e){const t=e.getTime(),s=Math.floor(t/1e3);return{seconds:s,nanos:1e6*(t-1e3*s)}}function te(e){if(void 0!==e.nullValue)return null;if(void 0!==e.boolValue)return W(e.boolValue);if(void 0!==e.stringValue)return z(e.stringValue);if(void 0!==e.numberValue)return B(e.numberValue);if(void 0!==e.structValue)return h(Q(e.structValue.fields),te);if(void 0!==e.listValue)return Y(e.listValue.values).map(te);throw new O("Could not deserialize json value: "+JSON.stringify(e))}function se(e){if(null===e)return{nullValue:0};if("boolean"==typeof e)return{boolValue:e};if("string"==typeof e)return{stringValue:e};if("number"==typeof e)return{numberValue:e};if(Array.isArray(e))return{listValue:{values:e.map(se)}};if(void 0!==e&&e.constructor===Object)return{structValue:{fields:h(e,se)}};throw new O("Can not serialize unknown data type: "+e)}function ie(e){return new k(re(e.userType),z(e.username))}function ne(e){return{userType:oe(e.userType),username:e.username}}function re(e){switch(e){case 0:case void 0:return q.NORMAL;case 1:return q.CONVERGENCE;case 2:return q.ANONYMOUS}}function oe(e){switch(e){case q.NORMAL:return 0;case q.CONVERGENCE:return 1;case q.ANONYMOUS:return 2}}class ae{constructor(){this.it=new C,this.fe=!1,this.nt=null,this.rt=null,this.ot=null}challenge(){return{password:e=>{this.at(e)},jwt:e=>{this.ct(e)},anonymous:e=>{this.ht(e)},cancel:()=>{this.ut()}}}fulfilled(){return this.it.promise()}isCompleted(){return this.dt}isPassword(){return null!==this.nt}isJwt(){return null!==this.rt}isAnonymous(){return null!==this.ot}isCanceled(){return this.fe}getPassword(){return this.nt}getJwt(){return this.rt}getDisplayName(){return this.ot}at(e){this.dt=!0,this.lt(e).then(e=>{this.nt=e,this.it.resolve()})}ct(e){this.dt=!0,this.lt(e).then(e=>{this.rt=e,this.it.resolve()})}ht(e){this.dt=!0,this.lt(e).then(e=>{this.ot=e,this.it.resolve()})}ut(){this.dt=!0,this.fe=!0,this.it.resolve()}lt(e){try{return o.isFunction(e)?Promise.resolve(e()):o.isFunction(e.then)?e:Promise.resolve(e)}catch(e){return Promise.reject(e)}}}var ce,he;!function(e){e.ANONYMOUS="anonymous",e.PASSWORD="password",e.JWT="jwt",e.RECONNECT="reconnect"}(ce||(ce={}));class ue{constructor(e,t){if(e<1)throw new Error;if(t.length<2)throw new Error;this.pt=t,this.ft=e}nextString(){let e="";for(let t=0;t<this.ft;t++)e+=this.pt.charAt(Math.floor(Math.random()*this.ft));return e}}ue.UpperCaseLetters="ABCDEFGHIJKLMNOPQRSTUVWXYZ",ue.LowerCaseLetters=ue.UpperCaseLetters.toLowerCase(),ue.Digits="0123456789",ue.AlphaNumeric=ue.UpperCaseLetters+ue.LowerCaseLetters+ue.Digits,ue.Base64=ue.AlphaNumeric+"/+";class de extends R{constructor(e,t,s){super(),this.se=v.logger("connection"),this.gt=e=>{this.se.debug(()=>"Browser connectivity changed, restarting connection schedule."),this.vt===he.CONNECTING&&(this.yt=0,this.wt())},this.Oe=e.trim().toLowerCase();if(!/^(https?|wss?):\/{2}.+\/.+\/.+/g.test(this.Oe))throw new Error(`Invalid domain connection url: ${this.Oe}`);this.bt=s,this.Oe=e,this.Ot=!1,this.yt=0,this.vt=he.DISCONNECTED;const i="offline:"+de.Rt.nextString();this.Mt=new U(t,this,null,i,null),"undefined"!=typeof window&&window.addEventListener("online",this.gt)}url(){return this.Oe}session(){return this.Mt}connect(){if(this.vt!==he.DISCONNECTED&&this.vt!==he.INTERRUPTED)throw new Error("Can only call connect on a disconnected or interrupted connection.");return this.yt=0,this.Et=new C,this.vt=he.CONNECTING,this.wt(),this.Et.promise()}disconnect(){if(null!==this.It&&(clearTimeout(this.It),this.It=null),null!==this.St&&(clearTimeout(this.St),this.St=null),null!==this.Et&&(this.Et.reject(new Error("Connection canceled by user")),this.Et=null),this.vt===he.DISCONNECTED)throw new Error("Connection is already disconnected.");this.vt=he.DISCONNECTING,this.Ot=!1,this.Be.close(),this.Ct(),"undefined"!=typeof window&&window.removeEventListener("online",this.gt)}reconnect(){if(this.vt!==he.INTERRUPTED&&this.vt!==he.DISCONNECTED)throw new Error("Can only call reconnect on an disconnected connection.");return this.connect().then(()=>this.authenticateWithReconnectToken(this.Mt.reconnectToken())).then(()=>{})}isConnected(){return this.vt===he.CONNECTED}isDisconnected(){return this.vt===he.DISCONNECTED}isAuthenticated(){return this.Ot}isOnline(){return this.isAuthenticated()}send(e){this.Be.send(e)}request(e,t){return this.Be.request(e,t)}authenticateWithPassword(e){const t={username:e.username,password:e.password};return this.xt({password:t}).catch(e=>(this.disconnect(),Promise.reject(e)))}authenticateWithJwt(e){const t={jwt:e};return this.xt({jwt:t}).catch(e=>(this.disconnect(),Promise.reject(e)))}authenticateWithReconnectToken(e){const t={token:e};return this.xt({reconnect:t}).catch(e=>{if(!(e instanceof O&&e.code===T.AUTHENTICATION_FAILED))return Promise.resolve(e);if(!o.isFunction(this.bt.fallbackAuth))return Promise.resolve(e);{const t=new ae;if(this.bt.fallbackAuth(t.challenge()),!t.isCompleted())return Promise.reject(new Error("You must call one of the auth challenge methods."));t.fulfilled().then(()=>{if(t.isPassword()){const e=this.session().user().username,s=t.getPassword();return this.authenticateWithPassword({username:e,password:s})}return t.isJwt()?this.authenticateWithJwt(t.getJwt()):t.isAnonymous()?this.authenticateAnonymously(t.getDisplayName()):(t.isCanceled(),Promise.reject(e))})}}).catch(e=>(this.disconnect(),Promise.reject(e)))}authenticateAnonymously(e){const t={displayName:K(e)};return this.xt({anonymous:t}).catch(e=>(this.disconnect(),Promise.reject(e)))}messages(){return this.events().pipe(Object(b.filter)(e=>"message"===e.name))}xt(e){return this.Mt.isAuthenticated()?Promise.reject(new O("User already authenticated.")):this.isConnected()?this.Dt(e):null!=this.Et?this.Et.promise().then(()=>this.Dt(e)):Promise.reject(new O("Must be connected or connecting to authenticate."))}Dt(e){let t=null;e.anonymous?t=ce.ANONYMOUS:e.password?t=ce.PASSWORD:e.jwt?t=ce.JWT:e.reconnect&&(t=ce.RECONNECT);const s={name:de.Events.AUTHENTICATING,method:t};return this.de(s),this.request({authenticationRequest:e}).then(e=>{const s=e.authenticationResponse;if(s.success){const e=s.success;this.Mt.Xe($(e.user)),this.Mt.Ze(e.sessionId),this.Mt.et(e.reconnectToken),this.Ot=!0;const i={name:de.Events.AUTHENTICATED,method:t,state:Q(e.presenceState)};return this.de(i),Promise.resolve()}{const e={name:de.Events.AUTHENTICATION_FAILED,method:t};return this.de(e),Promise.reject(new O("Authentication failed",T.AUTHENTICATION_FAILED))}})}wt(){null!==this.St&&(clearTimeout(this.St),this.St=null),this.yt++,this.se.debug(()=>`Attempting to open web socket connection to: ${this.Oe}`);const e=1e3*this.bt.connectionTimeout;this.It=setTimeout(()=>{this.Be.abort("connection timeout exceeded")},e),this.de({name:de.Events.CONNECTING});const t=new x(this.Oe,this.bt.webSocketClass,this.bt.webSocketFactory);this.Be=new j(t,{defaultRequestTimeout:this.bt.defaultRequestTimeout,heartbeatConfig:{enabled:this.bt.heartbeatEnabled,pingInterval:this.bt.pingInterval,pongTimeout:this.bt.pongTimeout}}),this.Be.events().subscribe(e=>{switch(e.name){case j.Events.ERROR:{const t=e,s={name:de.Events.ERROR,error:t.error};this.de(s);break}case j.Events.DROPPED:this._t();break;case j.Events.CLOSED:this.Ct();break;case j.Events.MESSAGE:{const t=e,s={name:de.Events.MESSAGE,request:t.request,callback:t.callback,message:t.message};this.de(s);break}}}),this.Be.connect().then(()=>(this.se.debug("Connection succeeded, handshaking."),this.Be.handshake().then(e=>{clearTimeout(this.It),null!==this.Et&&(e.success?(this.vt=he.CONNECTED,this.de({name:de.Events.CONNECTED}),this.Et.resolve(),this.Et=null,this.yt=0):(this.de({name:de.Events.CONNECTION_FAILED}),this.Be.close(),e.retryOk?this.Pt():(this.Ct(),this.Et.reject(new O(e.error.details,e.error.code)),this.Et=null)))}).catch(e=>(this.se.error("Handshake failed",e),this.Be.close(),this.Be=null,Promise.reject(e))))).catch(e=>{clearTimeout(this.It),this.de({name:de.Events.CONNECTION_FAILED}),this.Pt()})}Pt(){if(this.vt===he.CONNECTING){const e=Math.min(this.yt,this.bt.reconnectIntervals.length-1),t=this.bt.reconnectIntervals[e];this.se.debug(()=>`Scheduling web socket connection in ${t} seconds.`);const s={name:de.Events.CONNECTION_SCHEDULED,delay:t};this.de(s),this.St=setTimeout(()=>this.wt(),1e3*t)}}Ct(){this.vt!==he.DISCONNECTED&&(this.vt=he.DISCONNECTED,this.de({name:de.Events.DISCONNECTED}))}_t(){this.Ot=!1,this.vt=he.INTERRUPTED,this.de({name:de.Events.INTERRUPTED}),this.bt.autoReconnect&&this.Mt.reconnectToken()&&this.reconnect().catch(e=>this.se.error("Unexpected error reconnecting",e))}}de.Events={MESSAGE:"message",CONNECTION_SCHEDULED:"connection_scheduled",CONNECTING:"connecting",CONNECTED:"connected",CONNECTION_FAILED:"connection_failed",AUTHENTICATING:"authenticating",AUTHENTICATED:"authenticated",AUTHENTICATION_FAILED:"authentication_failed",INTERRUPTED:"interrupted",DISCONNECTED:"disconnected",ERROR:"error"},de.Rt=new ue(32,ue.AlphaNumeric),function(e){e[e.DISCONNECTED=0]="DISCONNECTED",e[e.CONNECTING=1]="CONNECTING",e[e.CONNECTED=2]="CONNECTED",e[e.INTERRUPTED=3]="INTERRUPTED",e[e.DISCONNECTING=4]="DISCONNECTING"}(he||(he={}));class le{constructor(e){this.type=e}}const pe={COMPOUND:"Compound",ARRAY_INSERT:"ArrayInsert",ARRAY_REORDER:"ArrayReorder",ARRAY_REMOVE:"ArrayRemove",ARRAY_SET:"ArraySet",ARRAY_VALUE:"ArrayValue",BOOLEAN_VALUE:"BooleanValue",NUMBER_DELTA:"NumberDelta",NUMBER_VALUE:"NumberValue",OBJECT_ADD:"ObjectAdd",OBJECT_REMOVE:"ObjectRemove",OBJECT_SET:"ObjectSet",OBJECT_VALUE:"ObjectValue",STRING_INSERT:"StringInsert",STRING_REMOVE:"StringRemove",STRING_VALUE:"StringValue",DATE_VALUE:"DateValue"};Object.freeze(pe);const fe=pe;class me extends le{constructor(e){super(fe.COMPOUND),this.ops=e,Object.freeze(this)}copy(e){return new me(n.update(this.ops,e.ops))}}class ge{constructor(e,t){this.serverOp=e,this.clientOp=t,Object.freeze(this)}}class ve{constructor(e){this.At=e}transform(e,t){return e instanceof me?this.transformServerCompoundOperation(e,t):t instanceof me?this.transformClientCompoundOperation(e,t):this.transformTwoDiscreteOps(e,t)}transformClientCompoundOperation(e,t){let s=e;const i=t.ops.map(e=>{const t=this.transform(s,e);return s=t.serverOp,t.clientOp});return new ge(s,new me(i))}transformServerCompoundOperation(e,t){let s=t;const i=e.ops.map(e=>{const t=this.transform(e,s);return s=t.clientOp,t.serverOp});return new ge(new me(i),s)}transformTwoDiscreteOps(e,t){return e.noOp||t.noOp?new ge(e,t):e.id===t.id?this.transformIdenticalPathOperations(e,t):new ge(e,t)}transformIdenticalPathOperations(e,t){const s=this.At.getOperationTransformationFunction(e,t);if(s)return s(e,t);throw new Error(`No function found for: (${e.type},${e.type})`)}}const ye=(e,t)=>e.index<=t.index?new ge(e,t.copy({index:t.index+1})):new ge(e.copy({index:e.index+1}),t),we=(e,t)=>e.index<=t.index?new ge(e,t.copy({index:t.index+1})):new ge(e.copy({index:e.index-1}),t),be=(e,t)=>e.index<=t.index?new ge(e,t.copy({index:t.index+1})):new ge(e,t);class Oe{static getRangeIndexRelationship(e,t,s){return s<e?Re.Before:s>t?Re.After:s===e?Re.Start:s===t?Re.End:Re.Within}static getRangeRangeRelationship(e,t,s,i){return e===s?t===i?Me.EqualTo:i>t?Me.Starts:Me.StartedBy:e>s?e>i?Me.PrecededBy:i===t?Me.Finishes:t<i?Me.ContainedBy:e===i?Me.MetBy:Me.OverlappedBy:t<s?Me.Precedes:i===t?Me.FinishedBy:t>i?Me.Contains:t===s?Me.Meets:Me.Overlaps}}var Re,Me,Ee;!function(e){e[e.Before=0]="Before",e[e.Start=1]="Start",e[e.Within=2]="Within",e[e.End=3]="End",e[e.After=4]="After"}(Re||(Re={})),function(e){e[e.Precedes=0]="Precedes",e[e.PrecededBy=1]="PrecededBy",e[e.Meets=2]="Meets",e[e.MetBy=3]="MetBy",e[e.Overlaps=4]="Overlaps",e[e.OverlappedBy=5]="OverlappedBy",e[e.Starts=6]="Starts",e[e.StartedBy=7]="StartedBy",e[e.Contains=8]="Contains",e[e.ContainedBy=9]="ContainedBy",e[e.Finishes=10]="Finishes",e[e.FinishedBy=11]="FinishedBy",e[e.EqualTo=12]="EqualTo"}(Me||(Me={}));class Ie{static isForwardMove(e){return e.fromIndex<e.toIndex}static isBackwardMoveMove(e){return e.fromIndex>e.toIndex}static isIdentityMove(e){return e.fromIndex===e.toIndex}static getMoveDirection(e){return this.isForwardMove(e)?Ee.Forward:this.isBackwardMoveMove(e)?Ee.Backward:Ee.Identity}static indexBeforeRange(e,t){return t<this.getRangeMin(e)}static indexAfterRange(e,t){return t>this.getRangeMax(e)}static indexWithinRange(e,t){return t>this.getRangeMin(e)&&t<this.getRangeMax(e)}static getRangeIndexRelationship(e,t){return Oe.getRangeIndexRelationship(this.getRangeMin(e),this.getRangeMax(e),t)}static getRangeRelationship(e,t){return Oe.getRangeRangeRelationship(this.getRangeMin(e),this.getRangeMax(e),this.getRangeMin(t),this.getRangeMax(t))}static getRangeMin(e){return Math.min(e.fromIndex,e.toIndex)}static getRangeMax(e){return Math.max(e.fromIndex,e.toIndex)}}!function(e){e[e.Forward=0]="Forward",e[e.Backward=1]="Backward",e[e.Identity=2]="Identity"}(Ee||(Ee={}));const Se=(e,t)=>{switch(Ie.getMoveDirection(t)){case Ee.Forward:return function(e,t){switch(Ie.getRangeIndexRelationship(t,e.index)){case Re.Before:case Re.Start:return new ge(e,t.copy({fromIndex:t.fromIndex+1,toIndex:t.toIndex+1}));case Re.Within:case Re.End:return new ge(e.copy({index:e.index-1}),t.copy({toIndex:t.toIndex+1}));case Re.After:return new ge(e,t);default:throw new Error("Invalid range-index relationship")}}(e,t);case Ee.Backward:return function(e,t){switch(Ie.getRangeIndexRelationship(t,e.index)){case Re.Before:case Re.Start:return new ge(e,t.copy({fromIndex:t.fromIndex+1,toIndex:t.toIndex+1}));case Re.Within:case Re.End:return new ge(e.copy({index:e.index+1}),t.copy({fromIndex:t.fromIndex+1}));case Re.After:return new ge(e,t);default:throw new Error("Invalid range-index relationship")}}(e,t);case Ee.Identity:return function(e,t){switch(Ie.getRangeIndexRelationship(t,e.index)){case Re.After:return new ge(e,t);default:return new ge(e,t.copy({fromIndex:t.fromIndex+1,toIndex:t.toIndex+1}))}}(e,t);default:throw new Error("Invalid move direction")}};const Ce=(e,t)=>new ge(e.copy({noOp:!0}),t),xe=(e,t)=>e.index<t.index?new ge(e,t.copy({index:t.index-1})):new ge(e.copy({index:e.index+1}),t),De=(e,t)=>e.index===t.index?new ge(e.copy({noOp:!0}),t.copy({noOp:!0})):e.index<t.index?new ge(e,t.copy({index:t.index-1})):new ge(e.copy({index:e.index-1}),t);class _e extends le{constructor(e,t,s){super(e),this.id=t,this.noOp=s}}class Pe extends _e{constructor(e,t,s,i){super(fe.ARRAY_INSERT,e,t),this.index=s,this.value=i,Object.freeze(this)}copy(e){return new Pe(n.update(this.id,e.id),n.update(this.noOp,e.noOp),n.update(this.index,e.index),n.update(this.value,e.value))}}const Ae=(e,t)=>e.index<t.index?new ge(e,t.copy({index:t.index-1})):e.index===t.index?new ge(e.copy({noOp:!0}),new Pe(t.id,t.noOp,t.index,t.value)):new ge(e,t),Te=(e,t)=>{switch(Ie.getMoveDirection(t)){case Ee.Forward:return function(e,t){switch(Ie.getRangeIndexRelationship(t,e.index)){case Re.Before:return new ge(e,t.copy({fromIndex:t.fromIndex-1,toIndex:t.toIndex-1}));case Re.Start:return new ge(e.copy({index:t.toIndex}),t.copy({noOp:!0}));case Re.Within:case Re.End:return new ge(e.copy({index:e.index-1}),t.copy({toIndex:t.toIndex-1}));case Re.After:return new ge(e,t);default:throw new Error("Invalid range-index relationship")}}(e,t);case Ee.Backward:return function(e,t){switch(Ie.getRangeIndexRelationship(t,e.index)){case Re.Before:return new ge(e,t.copy({fromIndex:t.fromIndex-1,toIndex:t.toIndex-1}));case Re.Start:case Re.Within:return new ge(e.copy({index:e.index+1}),t.copy({fromIndex:t.fromIndex-1}));case Re.End:return new ge(e.copy({index:t.toIndex}),t.copy({noOp:!0}));case Re.After:return new ge(e,t);default:throw new Error("Invalid range-index relationship")}}(e,t);case Ee.Identity:return function(e,t){switch(Ie.getRangeIndexRelationship(t,e.index)){case Re.Before:return new ge(e,t.copy({fromIndex:t.fromIndex-1,toIndex:t.toIndex-1}));case Re.Start:case Re.Within:case Re.End:return new ge(e,t.copy({noOp:!0}));default:return new ge(e,t)}}(e,t);default:throw new Error("Invalid move direction")}};const je=(e,t)=>new ge(e.copy({noOp:!0}),t),Ne=(e,t)=>e.index<t.index?new ge(e,t):new ge(e.copy({index:e.index+1}),t),Ue=(e,t)=>e.index<t.index?new ge(e,t):e.index===t.index?new ge(new Pe(e.id,e.noOp,e.index,e.value),t.copy({noOp:!0})):new ge(e.copy({index:e.index-1}),t);class qe{static deepEquals(e,t){let s;if(isNaN(e)&&isNaN(t)&&"number"==typeof e&&"number"==typeof t)return!0;if(e===t)return!0;if("function"==typeof e&&"function"==typeof t||e instanceof Date&&t instanceof Date||e instanceof RegExp&&t instanceof RegExp||e instanceof String&&t instanceof String||e instanceof Number&&t instanceof Number)return e.toString()===t.toString();if(!(e instanceof Object&&t instanceof Object))return!1;if(e.isPrototypeOf(t)||t.isPrototypeOf(e))return!1;if(e.constructor!==t.constructor)return!1;if(e.prototype!==t.prototype)return!1;for(s in t){if(t.hasOwnProperty(s)!==e.hasOwnProperty(s))return!1;if(typeof t[s]!=typeof e[s])return!1}for(s in e){if(t.hasOwnProperty(s)!==e.hasOwnProperty(s))return!1;if(typeof t[s]!=typeof e[s])return!1;switch(typeof e[s]){case"object":case"function":if(!this.deepEquals(e[s],t[s]))return!1;break;default:if(e[s]!==t[s])return!1}}return!0}}const ke=(e,t)=>e.index!==t.index?new ge(e,t):qe.deepEquals(e.value,t.value)?new ge(e.copy({noOp:!0}),t.copy({noOp:!0})):new ge(e,t.copy({noOp:!0})),Ve=(e,t)=>{switch(Ie.getMoveDirection(t)){case Ee.Forward:return function(e,t){switch(Ie.getRangeIndexRelationship(t,e.index)){case Re.Before:case Re.After:return new ge(e,t);case Re.Start:return new ge(e.copy({index:t.toIndex}),t);case Re.Within:case Re.End:return new ge(e.copy({index:e.index-1}),t);default:throw new Error("Invalid range-index relationship")}}(e,t);case Ee.Backward:return function(e,t){switch(Ie.getRangeIndexRelationship(t,e.index)){case Re.Before:case Re.After:return new ge(e,t);case Re.End:return new ge(e.copy({index:t.toIndex}),t);case Re.Within:case Re.Start:return new ge(e.copy({index:e.index+1}),t);default:throw new Error("Invalid range-index relationship")}}(e,t);case Ee.Identity:return function(e,t){return new ge(e,t)}(e,t);default:throw new Error("Invalid move direction")}};const Le=(e,t)=>new ge(e.copy({noOp:!0}),t),Ge=(e,t)=>{switch(Ie.getMoveDirection(e)){case Ee.Forward:return function(e,t){switch(Ie.getRangeIndexRelationship(e,t.index)){case Re.Before:case Re.Start:return new ge(e.copy({fromIndex:e.fromIndex+1,toIndex:e.toIndex+1}),t);case Re.Within:case Re.End:return new ge(e.copy({toIndex:e.toIndex+1}),t.copy({index:t.index-1}));case Re.After:return new ge(e,t);default:throw new Error("Invalid range-index relationship")}}(e,t);case Ee.Backward:return function(e,t){switch(Ie.getRangeIndexRelationship(e,t.index)){case Re.Before:case Re.Start:return new ge(e.copy({fromIndex:e.fromIndex+1,toIndex:e.toIndex+1}),t);case Re.Within:case Re.End:return new ge(e.copy({fromIndex:e.fromIndex+1}),t.copy({index:t.index+1}));case Re.After:return new ge(e,t);default:throw new Error("Invalid range-index relationship")}}(e,t);case Ee.Identity:return function(e,t){switch(Ie.getRangeIndexRelationship(e,t.index)){case Re.After:return new ge(e,t);default:return new ge(e.copy({fromIndex:e.fromIndex+1,toIndex:e.toIndex+1}),t)}}(e,t);default:throw new Error("Invalid move direction")}};const $e=(e,t)=>{switch(Ie.getMoveDirection(e)){case Ee.Forward:return function(e,t){switch(Ie.getRangeIndexRelationship(e,t.index)){case Re.Before:return new ge(e.copy({fromIndex:e.fromIndex-1,toIndex:e.toIndex-1}),t);case Re.Start:return new ge(e.copy({noOp:!0}),t.copy({index:e.toIndex}));case Re.Within:case Re.End:return new ge(e.copy({toIndex:e.toIndex-1}),t.copy({index:t.index-1}));case Re.After:return new ge(e,t);default:throw new Error("Invalid range-index relationship")}}(e,t);case Ee.Backward:return function(e,t){switch(Ie.getRangeIndexRelationship(e,t.index)){case Re.Before:return new ge(e.copy({fromIndex:e.fromIndex-1,toIndex:e.toIndex-1}),t);case Re.Start:case Re.Within:return new ge(e.copy({fromIndex:e.fromIndex-1}),t.copy({index:t.index+1}));case Re.End:return new ge(e.copy({noOp:!0}),t.copy({index:e.toIndex}));case Re.After:return new ge(e,t);default:throw new Error("Invalid range-index relationship")}}(e,t);case Ee.Identity:return function(e,t){switch(Ie.getRangeIndexRelationship(e,t.index)){case Re.Before:return new ge(e.copy({fromIndex:e.fromIndex-1,toIndex:e.toIndex-1}),t);case Re.Start:case Re.Within:case Re.End:return new ge(e.copy({noOp:!0}),t);case Re.After:return new ge(e,t);default:throw new Error("Invalid range-index relationship")}}(e,t);default:throw new Error("Invalid move direction")}};const Fe=(e,t)=>{switch(Ie.getMoveDirection(e)){case Ee.Forward:return function(e,t){switch(Ie.getRangeIndexRelationship(e,t.index)){case Re.Before:case Re.After:return new ge(e,t);case Re.Start:return new ge(e,t.copy({index:e.toIndex}));case Re.Within:case Re.End:return new ge(e,t.copy({index:t.index-1}));default:throw new Error("Invalid range-index relationship")}}(e,t);case Ee.Backward:return function(e,t){switch(Ie.getRangeIndexRelationship(e,t.index)){case Re.Before:case Re.After:return new ge(e,t);case Re.End:return new ge(e,t.copy({index:e.toIndex}));case Re.Start:case Re.Within:return new ge(e,t.copy({index:t.index+1}));default:throw new Error("Invalid range-index relationship")}}(e,t);case Ee.Identity:return function(e,t){return new ge(e,t)}(e,t);default:throw new Error("Invalid move direction")}};const Je=(e,t)=>{const s=Ie.getMoveDirection(e),i=Ie.getMoveDirection(t);return s===Ee.Forward?i===Ee.Forward?function(e,t){switch(Ie.getRangeRelationship(e,t)){case Me.Precedes:case Me.PrecededBy:return new ge(e,t);case Me.Meets:return new ge(e.copy({toIndex:e.toIndex-1}),t.copy({fromIndex:t.fromIndex-1}));case Me.MetBy:return new ge(e.copy({fromIndex:e.fromIndex-1}),t.copy({toIndex:t.toIndex-1}));case Me.Overlaps:return new ge(e.copy({toIndex:e.toIndex-1}),t.copy({fromIndex:t.fromIndex-1}));case Me.OverlappedBy:return new ge(e.copy({fromIndex:e.fromIndex-1}),t.copy({toIndex:t.toIndex-1}));case Me.Starts:case Me.StartedBy:return new ge(e.copy({fromIndex:t.toIndex}),t.copy({noOp:!0}));case Me.Contains:return new ge(e,t.copy({fromIndex:t.fromIndex-1,toIndex:t.toIndex-1}));case Me.ContainedBy:return new ge(e.copy({fromIndex:e.fromIndex-1,toIndex:e.toIndex-1}),t);case Me.Finishes:return new ge(e.copy({fromIndex:e.fromIndex-1}),t.copy({toIndex:t.toIndex-1}));case Me.FinishedBy:return new ge(e,t.copy({fromIndex:t.fromIndex-1,toIndex:t.toIndex-1}));case Me.EqualTo:return new ge(e.copy({noOp:!0}),t.copy({noOp:!0}));default:throw new Error("Invalid range-range relationship")}}(e,t):i===Ee.Backward?function(e,t){switch(Ie.getRangeRelationship(e,t)){case Me.Precedes:case Me.PrecededBy:return new ge(e,t);case Me.Meets:return new ge(e.copy({toIndex:e.toIndex+1}),t.copy({toIndex:t.toIndex-1}));case Me.MetBy:return new ge(e.copy({fromIndex:t.toIndex}),t.copy({noOp:!0}));case Me.Overlaps:return new ge(e.copy({toIndex:e.toIndex+1}),t.copy({toIndex:t.toIndex-1}));case Me.OverlappedBy:return new ge(e.copy({fromIndex:e.fromIndex+1}),t.copy({fromIndex:t.fromIndex-1}));case Me.Starts:return new ge(e.copy({fromIndex:e.fromIndex+1,toIndex:e.toIndex+1}),t);case Me.StartedBy:return new ge(e.copy({fromIndex:e.fromIndex+1}),t.copy({fromIndex:t.fromIndex-1}));case Me.Contains:return new ge(e,t.copy({fromIndex:t.fromIndex-1,toIndex:t.toIndex-1}));case Me.ContainedBy:return new ge(e.copy({fromIndex:e.fromIndex+1,toIndex:e.toIndex+1}),t);case Me.Finishes:return new ge(e.copy({fromIndex:e.fromIndex+1}),t.copy({fromIndex:t.fromIndex-1}));case Me.FinishedBy:return new ge(e,t.copy({fromIndex:t.fromIndex-1,toIndex:t.toIndex-1}));case Me.EqualTo:return new ge(e.copy({fromIndex:e.fromIndex+1}),t.copy({fromIndex:t.fromIndex-1}));default:throw new Error("Invalid range-range relationship")}}(e,t):function(e,t){switch(Ie.getRangeIndexRelationship(e,t.fromIndex)){case Re.Before:case Re.After:return new ge(e,t);case Re.Start:return new ge(e,t.copy({fromIndex:e.toIndex,toIndex:e.toIndex}));case Re.Within:case Re.End:return new ge(e,t.copy({fromIndex:t.fromIndex-1,toIndex:t.toIndex-1}));default:throw new Error("Invalid range-index relationship")}}(e,t):s===Ee.Backward?i===Ee.Forward?function(e,t){switch(Ie.getRangeRelationship(e,t)){case Me.Precedes:case Me.PrecededBy:return new ge(e,t);case Me.Meets:return new ge(e.copy({fromIndex:t.toIndex}),t.copy({noOp:!0}));case Me.MetBy:return new ge(e.copy({toIndex:e.toIndex-1}),t.copy({toIndex:t.toIndex+1}));case Me.Overlaps:return new ge(e.copy({fromIndex:e.fromIndex-1}),t.copy({fromIndex:t.fromIndex+1}));case Me.OverlappedBy:return new ge(e.copy({toIndex:e.toIndex-1}),t.copy({toIndex:t.toIndex+1}));case Me.Starts:return new ge(e.copy({fromIndex:e.fromIndex-1}),t.copy({fromIndex:t.fromIndex+1}));case Me.StartedBy:case Me.Contains:return new ge(e,t.copy({fromIndex:t.fromIndex+1,toIndex:t.toIndex+1}));case Me.ContainedBy:case Me.Finishes:return new ge(e.copy({fromIndex:e.fromIndex-1,toIndex:e.toIndex-1}),t);case Me.FinishedBy:case Me.EqualTo:return new ge(e.copy({fromIndex:e.fromIndex-1}),t.copy({fromIndex:t.fromIndex+1}));default:throw new Error("Invalid range-range relationship")}}(e,t):i===Ee.Backward?function(e,t){switch(Ie.getRangeRelationship(e,t)){case Me.Precedes:case Me.PrecededBy:return new ge(e,t);case Me.Meets:return new ge(e.copy({fromIndex:e.fromIndex+1}),t.copy({toIndex:t.toIndex+1}));case Me.MetBy:return new ge(e.copy({toIndex:e.toIndex+1}),t.copy({fromIndex:t.fromIndex+1}));case Me.Overlaps:return new ge(e.copy({fromIndex:e.fromIndex+1}),t.copy({toIndex:t.toIndex+1}));case Me.OverlappedBy:return new ge(e.copy({toIndex:e.toIndex+1}),t.copy({fromIndex:t.fromIndex+1}));case Me.Starts:return new ge(e.copy({fromIndex:e.fromIndex+1,toIndex:e.toIndex+1}),t);case Me.StartedBy:case Me.Contains:return new ge(e,t.copy({fromIndex:t.fromIndex+1,toIndex:t.toIndex+1}));case Me.ContainedBy:return new ge(e.copy({fromIndex:e.fromIndex+1,toIndex:e.toIndex+1}),t);case Me.Finishes:case Me.FinishedBy:return new ge(e.copy({fromIndex:t.toIndex}),t.copy({noOp:!0}));case Me.EqualTo:return new ge(e.copy({noOp:!0}),t.copy({noOp:!0}));default:throw new Error("Invalid range-range relationship")}}(e,t):function(e,t){switch(Ie.getRangeIndexRelationship(e,t.fromIndex)){case Re.Before:case Re.After:return new ge(e,t);case Re.Start:case Re.Within:return new ge(e,t.copy({fromIndex:t.fromIndex+1,toIndex:t.toIndex+1}));case Re.End:return new ge(e,t.copy({fromIndex:e.toIndex,toIndex:e.toIndex}));default:throw new Error("Invalid range-index relationship")}}(e,t):i===Ee.Forward?function(e,t){switch(Ie.getRangeIndexRelationship(t,e.fromIndex)){case Re.Before:case Re.After:return new ge(e,t);case Re.Start:return new ge(e.copy({fromIndex:t.toIndex,toIndex:t.toIndex}),t);case Re.Within:case Re.End:return new ge(e.copy({fromIndex:e.fromIndex-1,toIndex:e.toIndex-1}),t);default:throw new Error("Invalid range-index relationship")}}(e,t):i===Ee.Backward?function(e,t){switch(Ie.getRangeIndexRelationship(t,e.fromIndex)){case Re.Before:case Re.After:return new ge(e,t);case Re.Start:case Re.Within:return new ge(e.copy({fromIndex:e.fromIndex+1,toIndex:e.toIndex+1}),t);case Re.End:return new ge(e.copy({fromIndex:t.toIndex,toIndex:t.toIndex}),t);default:throw new Error("Invalid range-index relationship")}}(e,t):function(e,t){return new ge(e,t)}(e,t)};const He=(e,t)=>new ge(e.copy({noOp:!0}),t),Be=(e,t)=>new ge(e,t.copy({noOp:!0})),We=(e,t)=>new ge(e,t.copy({noOp:!0})),ze=(e,t)=>new ge(e,t.copy({noOp:!0})),Ye=(e,t)=>new ge(e,t.copy({noOp:!0})),Qe=(e,t)=>qe.deepEquals(e.value,t.value)?new ge(e.copy({noOp:!0}),t.copy({noOp:!0})):new ge(e,t.copy({noOp:!0})),Ke=(e,t)=>e.index<=t.index?new ge(e,t.copy({index:t.index+e.value.length})):new ge(e.copy({index:e.index+t.value.length}),t),Ze=(e,t)=>{if(e.index<=t.index)return new ge(e,t.copy({index:t.index+e.value.length}));if(e.index>=t.index+t.value.length)return new ge(e.copy({index:e.index-t.value.length}),t);{const s=e.index-t.index;return new ge(e.copy({noOp:!0}),t.copy({value:t.value.substring(0,s)+e.value+t.value.substring(s,t.value.length)}))}},Xe=(e,t)=>new ge(e.copy({noOp:!0}),t),et=(e,t)=>{if(t.index<=e.index)return new ge(e.copy({index:e.index+t.value.length}),t);if(t.index>=e.index+e.value.length)return new ge(e,t.copy({index:t.index-e.value.length}));{const s=t.index-e.index;return new ge(e.copy({value:e.value.substring(0,s)+t.value+e.value.substring(s,e.value.length)}),t.copy({noOp:!0}))}},tt=(e,t)=>{const s=t.index,i=t.index+t.value.length,n=e.index,r=e.index+e.value.length;let o,a,c;switch(Oe.getRangeRangeRelationship(n,r,s,i)){case Me.Precedes:return new ge(e,t.copy({index:t.index-e.value.length}));case Me.PrecededBy:return new ge(e.copy({index:e.index-t.value.length}),t);case Me.Meets:case Me.Overlaps:return o=t.index-e.index,new ge(e.copy({value:e.value.substring(0,o)}),t.copy({index:e.index,value:t.value.substring(e.value.length-o,t.value.length)}));case Me.MetBy:case Me.OverlappedBy:return o=e.index-t.index,new ge(e.copy({index:t.index,value:e.value.substring(t.value.length-o,e.value.length)}),t.copy({value:t.value.substring(0,o)}));case Me.Starts:return new ge(e.copy({noOp:!0}),t.copy({value:t.value.substring(e.value.length,t.value.length)}));case Me.StartedBy:return new ge(e.copy({value:e.value.substring(t.value.length,e.value.length)}),t.copy({noOp:!0}));case Me.Contains:return c=(a=t.index-e.index)+t.value.length,new ge(e.copy({value:e.value.substring(0,a)+e.value.substring(c,e.value.length)}),t.copy({noOp:!0}));case Me.ContainedBy:return c=(a=e.index-t.index)+e.value.length,new ge(e.copy({noOp:!0}),t.copy({value:t.value.substring(0,a)+t.value.substring(c,t.value.length)}));case Me.Finishes:return new ge(e.copy({noOp:!0}),t.copy({value:t.value.substring(0,t.value.length-e.value.length)}));case Me.FinishedBy:return new ge(e.copy({value:e.value.substring(0,e.value.length-t.value.length)}),t.copy({noOp:!0}));case Me.EqualTo:return new ge(e.copy({noOp:!0}),t.copy({noOp:!0}));default:throw new Error("invalid range range relationship")}},st=(e,t)=>new ge(e.copy({noOp:!0}),t),it=(e,t)=>new ge(e,t.copy({noOp:!0})),nt=(e,t)=>new ge(e,t.copy({noOp:!0})),rt=(e,t)=>e.value===t.value?new ge(e.copy({noOp:!0}),e.copy({noOp:!0})):new ge(e,t.copy({noOp:!0})),ot=(e,t)=>new ge(e,t),at=(e,t)=>new ge(e.copy({noOp:!0}),t),ct=(e,t)=>new ge(e,t.copy({noOp:!0})),ht=(e,t)=>e.value===t.value?new ge(e.copy({noOp:!0}),e.copy({noOp:!0})):new ge(e,t.copy({noOp:!0})),ut=(e,t)=>e.value===t.value?new ge(e.copy({noOp:!0}),e.copy({noOp:!0})):new ge(e,t.copy({noOp:!0}));class dt extends _e{constructor(e,t,s,i){super(fe.OBJECT_SET,e,t),this.prop=s,this.value=i,Object.freeze(this)}copy(e){return new dt(n.update(this.id,e.id),n.update(this.noOp,e.noOp),n.update(this.prop,e.prop),n.update(this.value,e.value))}}const lt=(e,t)=>e.prop!==t.prop?new ge(e,t):e.value!==t.value?new ge(new dt(e.id,e.noOp,e.prop,e.value),t.copy({noOp:!0})):new ge(e.copy({noOp:!0}),t.copy({noOp:!0})),pt=(e,t)=>{if(e.prop!==t.prop)return new ge(e,t);throw new Error("Add property and set property can not target the same property")},ft=(e,t)=>{if(e.prop!==t.prop)return new ge(e,t);throw new Error("Add property and Remove property can not target the same property")},mt=(e,t)=>{if(e.prop!==t.prop)return new ge(e,t);throw new Error("Remove property and add property can not target the same property")};class gt extends _e{constructor(e,t,s,i){super(fe.OBJECT_ADD,e,t),this.prop=s,this.value=i,Object.freeze(this)}copy(e){return new gt(n.update(this.id,e.id),n.update(this.noOp,e.noOp),n.update(this.prop,e.prop),n.update(this.value,e.value))}}const vt=(e,t)=>e.prop!==t.prop?new ge(e,t):new ge(e.copy({noOp:!0}),new gt(t.id,t.noOp,t.prop,t.value)),yt=(e,t)=>e.prop!==t.prop?new ge(e,t):new ge(e.copy({noOp:!0}),t.copy({noOp:!0})),wt=(e,t)=>new ge(e.copy({noOp:!0}),t),bt=(e,t)=>new ge(e.copy({noOp:!0}),t),Ot=(e,t)=>{if(e.prop!==t.prop)return new ge(e,t);throw new Error("Set property and add property can not target the same property")},Rt=(e,t)=>e.prop!==t.prop?new ge(e,t):e.value!==t.value?new ge(e,t.copy({noOp:!0})):new ge(e.copy({noOp:!0}),t.copy({noOp:!0})),Mt=(e,t)=>e.prop!==t.prop?new ge(e,t):new ge(new gt(e.id,e.noOp,e.prop,e.value),t.copy({noOp:!0})),Et=(e,t)=>new ge(e.copy({noOp:!0}),t),It=(e,t)=>new ge(e,t.copy({noOp:!0})),St=(e,t)=>new ge(e,t.copy({noOp:!0})),Ct=(e,t)=>new ge(e,t.copy({noOp:!0})),xt=(e,t)=>qe.deepEquals(e.value,t.value)?new ge(e.copy({noOp:!0}),t.copy({noOp:!0})):new ge(e,t.copy({noOp:!0}));class Dt{constructor(e,t,s,i,n){this.src=e,this.oldValues=t,this.addedValues=s,this.removedValues=i,this.synthetic=n,this.name=Dt.NAME,t.length>0&&(this.oldValue=t[0]),Object.freeze(this)}}Dt.NAME="set";class _t{constructor(e,t){this.src=e,this.oldValues=t,this.name=_t.NAME,t.length>0&&(this.oldValue=t[0]),Object.freeze(this)}}_t.NAME="cleared";class Pt{constructor(e){this.src=e,this.name=Pt.NAME,Object.freeze(this)}}Pt.NAME="disposed";class At extends R{constructor(e,t,s,i,n,r,o){super(),this.Tt=e,this.jt=!1,this.Nt=[],this.Ut=t,this.qt=s,this.kt=i,this.Ye=n,this.ze=r,this.Vt=o}type(){return this.Ut}key(){return this.qt}source(){return this.kt}isLocal(){return this.Vt}user(){return this.Ye}sessionId(){return this.ze}isDisposed(){return this.jt}Lt(){this.jt=!0;const e=new Pt(this);this.de(e),this.removeAllListeners(),this.Tt.Gt(this)}value(){return this.Nt[0]}values(){return this.Nt}isSet(){return this.Nt.length>0}$t(e,t){const s=this.Nt;this.Nt=e;const i=this.Nt.filter(e=>!s.includes(e)),n=s.filter(e=>!this.Nt.includes(e)),r=new Dt(this,s,i,n,t);this.de(r)}Ft(){const e=this.Nt;this.Nt=[];const t=new _t(this,e);this.de(t)}Jt(e,t){qe.deepEquals(this.Nt,e)||this.$t(e,t)}}At.Events={SET:Dt.NAME,CLEARED:_t.NAME,DISPOSED:Pt.NAME},At.Types={INDEX:"index",RANGE:"range",PROPERTY:"property",ELEMENT:"element"},Object.freeze(At.Events),Object.freeze(At.Types);class Tt{static handleInsert(e,t,s){return e.map(e=>e>=t?e+s:e)}static handleReorder(e,t,s){return e.map(e=>e>=s&&e<t?e+1:e>=t&&e<s?e-1:e)}static handleRemove(e,t,s){return e.map(e=>e>t?e-Math.min(e-t,s):e)}}const jt=(e,t)=>{const s=Tt.handleInsert(t.values,e.index,e.value.length);return n.copy(t,{values:s})},Nt=(e,t)=>{const s=Tt.handleRemove(t.values,e.index,e.value.length);return n.copy(t,{values:s})},Ut=(e,t)=>null;class qt{static handleInsert(e,t,s){return e.map(e=>{const i=qt.Ht(e),n=Tt.handleInsert(i,t,s);return qt.Bt(n)})}static handleReorder(e,t,s){return e.map(e=>{const i=qt.Ht(e),n=Tt.handleReorder(i,t,s);return qt.Bt(n)})}static handleRemove(e,t,s){return e.map(e=>{const i=qt.Ht(e),n=Tt.handleRemove(i,t,s);return qt.Bt(n)})}static Ht(e){return[e.start,e.end]}static Bt(e){return{start:e[0],end:e[1]}}}const kt=(e,t)=>{const s=qt.handleInsert(t.values,e.index,e.value.length);return n.copy(t,{values:s})},Vt=(e,t)=>{const s=qt.handleRemove(t.values,e.index,e.value.length);return n.copy(t,{values:s})},Lt=(e,t)=>null,Gt=(e,t)=>e.value.getTime()===t.value.getTime()?new ge(e.copy({noOp:!0}),e.copy({noOp:!0})):new ge(e,t.copy({noOp:!0}));class $t{constructor(){this.Wt={},this.zt={},this.registerOtf(fe.STRING_INSERT,fe.STRING_INSERT,Ke),this.registerOtf(fe.STRING_INSERT,fe.STRING_REMOVE,Ze),this.registerOtf(fe.STRING_INSERT,fe.STRING_VALUE,Xe),this.registerOtf(fe.STRING_REMOVE,fe.STRING_INSERT,et),this.registerOtf(fe.STRING_REMOVE,fe.STRING_REMOVE,tt),this.registerOtf(fe.STRING_REMOVE,fe.STRING_VALUE,st),this.registerOtf(fe.STRING_VALUE,fe.STRING_INSERT,it),this.registerOtf(fe.STRING_VALUE,fe.STRING_REMOVE,nt),this.registerOtf(fe.STRING_VALUE,fe.STRING_VALUE,rt),this.registerOtf(fe.OBJECT_ADD,fe.OBJECT_ADD,lt),this.registerOtf(fe.OBJECT_ADD,fe.OBJECT_SET,pt),this.registerOtf(fe.OBJECT_ADD,fe.OBJECT_REMOVE,ft),this.registerOtf(fe.OBJECT_ADD,fe.OBJECT_VALUE,wt),this.registerOtf(fe.OBJECT_REMOVE,fe.OBJECT_ADD,mt),this.registerOtf(fe.OBJECT_REMOVE,fe.OBJECT_SET,vt),this.registerOtf(fe.OBJECT_REMOVE,fe.OBJECT_REMOVE,yt),this.registerOtf(fe.OBJECT_REMOVE,fe.OBJECT_VALUE,bt),this.registerOtf(fe.OBJECT_SET,fe.OBJECT_ADD,Ot),this.registerOtf(fe.OBJECT_SET,fe.OBJECT_SET,Rt),this.registerOtf(fe.OBJECT_SET,fe.OBJECT_REMOVE,Mt),this.registerOtf(fe.OBJECT_SET,fe.OBJECT_VALUE,Et),this.registerOtf(fe.OBJECT_VALUE,fe.OBJECT_ADD,It),this.registerOtf(fe.OBJECT_VALUE,fe.OBJECT_SET,St),this.registerOtf(fe.OBJECT_VALUE,fe.OBJECT_REMOVE,Ct),this.registerOtf(fe.OBJECT_VALUE,fe.OBJECT_VALUE,xt),this.registerOtf(fe.ARRAY_INSERT,fe.ARRAY_INSERT,ye),this.registerOtf(fe.ARRAY_INSERT,fe.ARRAY_REMOVE,we),this.registerOtf(fe.ARRAY_INSERT,fe.ARRAY_SET,be),this.registerOtf(fe.ARRAY_INSERT,fe.ARRAY_REORDER,Se),this.registerOtf(fe.ARRAY_INSERT,fe.ARRAY_VALUE,Ce),this.registerOtf(fe.ARRAY_REMOVE,fe.ARRAY_INSERT,xe),this.registerOtf(fe.ARRAY_REMOVE,fe.ARRAY_REMOVE,De),this.registerOtf(fe.ARRAY_REMOVE,fe.ARRAY_SET,Ae),this.registerOtf(fe.ARRAY_REMOVE,fe.ARRAY_REORDER,Te),this.registerOtf(fe.ARRAY_REMOVE,fe.ARRAY_VALUE,je),this.registerOtf(fe.ARRAY_SET,fe.ARRAY_INSERT,Ne),this.registerOtf(fe.ARRAY_SET,fe.ARRAY_REMOVE,Ue),this.registerOtf(fe.ARRAY_SET,fe.ARRAY_SET,ke),this.registerOtf(fe.ARRAY_SET,fe.ARRAY_REORDER,Ve),this.registerOtf(fe.ARRAY_SET,fe.ARRAY_VALUE,Le),this.registerOtf(fe.ARRAY_REORDER,fe.ARRAY_INSERT,Ge),this.registerOtf(fe.ARRAY_REORDER,fe.ARRAY_REMOVE,$e),this.registerOtf(fe.ARRAY_REORDER,fe.ARRAY_SET,Fe),this.registerOtf(fe.ARRAY_REORDER,fe.ARRAY_REORDER,Je),this.registerOtf(fe.ARRAY_REORDER,fe.ARRAY_VALUE,He),this.registerOtf(fe.ARRAY_VALUE,fe.ARRAY_INSERT,Be),this.registerOtf(fe.ARRAY_VALUE,fe.ARRAY_REMOVE,We),this.registerOtf(fe.ARRAY_VALUE,fe.ARRAY_SET,ze),this.registerOtf(fe.ARRAY_VALUE,fe.ARRAY_REORDER,Ye),this.registerOtf(fe.ARRAY_VALUE,fe.ARRAY_VALUE,Qe),this.registerOtf(fe.NUMBER_DELTA,fe.NUMBER_DELTA,ot),this.registerOtf(fe.NUMBER_DELTA,fe.NUMBER_VALUE,at),this.registerOtf(fe.NUMBER_VALUE,fe.NUMBER_DELTA,ct),this.registerOtf(fe.NUMBER_VALUE,fe.NUMBER_VALUE,ht),this.registerOtf(fe.BOOLEAN_VALUE,fe.BOOLEAN_VALUE,ut),this.registerOtf(fe.DATE_VALUE,fe.DATE_VALUE,Gt),this.registerRtf(At.Types.INDEX,fe.STRING_INSERT,jt),this.registerRtf(At.Types.INDEX,fe.STRING_REMOVE,Nt),this.registerRtf(At.Types.INDEX,fe.STRING_VALUE,Ut),this.registerRtf(At.Types.RANGE,fe.STRING_INSERT,kt),this.registerRtf(At.Types.RANGE,fe.STRING_REMOVE,Vt),this.registerRtf(At.Types.RANGE,fe.STRING_VALUE,Lt)}registerOtf(e,t,s){const i=e+t;if(this.Wt[i])throw new Error("Function already registered for "+e+", "+t);this.Wt[i]=s}registerRtf(e,t,s){const i=t+e;if(this.zt[i])throw new Error("Function already registered for "+t+", "+e);this.zt[i]=s}getOperationTransformationFunction(e,t){const s=e.type+t.type;return this.Wt[s]}getReferenceTransformationFunction(e,t){const s=e.type+t.type;return this.zt[s]}}class Ft{constructor(e,t,s,i,n){this.sessionId=e,this.seqNo=t,this.contextVersion=s,this.timestamp=i,this.operation=n,Object.freeze(this)}copy(e){return e=n.getOrDefault(e,{}),new Ft(n.getOrDefault(e.sessionId,this.sessionId),n.getOrDefault(e.seqNo,this.seqNo),n.getOrDefault(e.contextVersion,this.contextVersion),n.getOrDefault(e.timestamp,this.timestamp),n.getOrDefault(e.operation,this.operation))}}class Jt extends R{constructor(e,t,s,i,n){super(),this.ze=e,this.Yt=s,this.Qt=t,this.Kt=[],this.Zt=[],this.Xt=i,this.es=n,this.ts=!1,this.ss=[]}lastSequenceNumber(){return this.Yt}setState(e,t,s){this.Qt=e,this.Yt=t,this.Zt.length=0,this.Zt.push(...s)}contextVersion(){return this.Qt}isCommitted(){return!this.hasInflightOperation()}hasInflightOperation(){return this.Zt.length>0}firstInFlightOperation(){return this.Zt[0]}getInFlightOperations(){return this.Zt.slice(0)}hasNextIncomingOperation(){return 0!==this.Kt.length}getNextIncomingOperation(){return 0===this.Kt.length?null:this.Kt.shift()}hasNextRemoteReference(){return 0!==this.Kt.length}getNextRemoteReferenceSetEvent(){return 0===this.Kt.length?null:this.Kt.shift()}startBatchOperation(){if(this.ts)throw new Error("Batch operation already in progress.");this.ss=[],this.ts=!0}cancelBatchOperation(){if(!this.ts)throw new Error("Batch operation not in progress.");if(0!==this.ss.length)throw new Error("Can not cancel a batch operation if operations have been issued.");this.ts=!1}completeBatchOperation(){if(!this.ts)throw new Error("Batch operation not in progress.");if(this.ts=!1,0===this.ss.length)throw new Error("A Batch operation must have at least one operation.");const e=new me(this.ss);this.ss=[];const t=++this.Yt,s=new Ft(this.ze(),t,this.Qt,new Date,e);return this.Zt.push(s),s}batchSize(){return this.ss.length}isBatchOperationInProgress(){return this.ts}processOutgoingOperation(e){if(this.ts&&!(e instanceof _e))throw new Error("Can't process a compound operation that is in progress");const t=this.transformOutgoing(this.Kt,e);if(0===this.Zt.length&&0===this.ss.length){const e={name:Jt.Events.COMMIT_STATE_CHANGED,committed:!1};this.de(e)}if(this.ts)return this.ss.push(t),null;{const e=new Ft(this.ze(),++this.Yt,this.Qt,new Date,t);return this.Zt.push(e),e}}processOutgoingSetReference(e){for(let t=0;t<this.Kt.length&&e;t++)e=this.es.transform(this.Kt[t].operation,e);return e}dispose(){}processAcknowledgement(e,t){if(0===this.Zt.length)throw new Error("Received an acknowledgment, but had no uncommitted operations.");if(this.Qt!==e)throw new Error(`Acknowledgement did not meet expected context version of ${this.Qt}: ${e}`);const s=this.Zt.shift();if(void 0!==t&&s.seqNo!==t)throw new Error(`Acknowledgement did not meet expected sequence number of ${s.seqNo}: ${t}`);if(this.Qt++,0===this.Zt.length&&0===this.ss.length){const e={name:Jt.Events.COMMIT_STATE_CHANGED,committed:!0};this.de(e)}return s}processRemoteOperation(e){if(e.version!==this.Qt)throw new Error(`Invalid version of ${e.version}, expected ${this.Qt}.`);e=this.transformInflightOperations(e),e=this.transformPendingCompoundOperations(e),this.Qt++,this.Kt.push(e)}processRemoteReferenceSet(e){for(let t=0;t<this.Zt.length&&e;t++)e=this.es.transform(this.Zt[t].operation,e);return e}transformInflightOperations(e){let t=e.operation;for(let s=0;s<this.Zt.length;s++){const i=this.Zt[s],n=this.Xt.transform(t,i.operation);t=n.serverOp,this.Zt[s]=i.copy({contextVersion:e.version+1,operation:n.clientOp})}return e.copy({operation:t})}transformPendingCompoundOperations(e){let t=e.operation;for(let e=0;e<this.ss.length;e++){const s=this.ss[e],i=this.Xt.transform(t,s);t=i.serverOp,this.ss[e]=i.clientOp}return e.copy({operation:t})}transformOutgoing(e,t){let s=t;for(let t=0;t<e.length;t++){const i=e[t],n=this.Xt.transform(i.operation,s);e[t]=i.copy({operation:n.serverOp}),s=n.clientOp}return s}}Jt.Events={COMMIT_STATE_CHANGED:"commitStateChanged"};class Ht{constructor(e){this.At=e}transform(e,t){return e instanceof me?this.transformCompoundOperation(e,t):this.transformDiscreteOperation(e,t)}transformCompoundOperation(e,t){let s=t;for(let t=0;t<e.ops.length&&s;t++)s=this.transform(e.ops[t],s);return s}transformDiscreteOperation(e,t){return e.noOp?t:e.id===t.valueId?this.transformWithIdenticalPathOperation(e,t):t}transformWithIdenticalPathOperation(e,t){const s=this.At.getReferenceTransformationFunction(e,t);if(s)return s(e,t);throw new Error(`No function found for: (${e.type},${t.type})`)}}class Bt{constructor(e){this.idGenerator=e}createDataValue(e){const t=this.idGenerator(),s=typeof e;if(null===e){return{id:t,type:"null",value:null}}if("string"===s){return{id:t,type:s,value:e}}if(e instanceof Date){return{id:t,type:"date",value:e}}if(Array.isArray(e)){return{id:t,type:"array",value:e.map(e=>this.createDataValue(e))}}if("object"===s){if(e.hasOwnProperty("$convergenceType")){if("date"===e.$convergenceType){if(e.hasOwnProperty("value")){return{id:t,type:"date",value:new Date(e.delta)}}throw new Error("Invalid convergence data type: "+s+" delta field missing.")}throw new Error("Invalid convergence data type: "+s+" supported types are [date].")}{const i={};return Object.getOwnPropertyNames(e).forEach(t=>{i[t]=this.createDataValue(e[t])}),{id:t,type:s,value:i}}}if("number"===s){return{id:t,type:s,value:e}}if("boolean"===s){return{id:t,type:s,value:e}}throw new Error("Invalid data type: "+s)}}class Wt{constructor(e,t,s,i,n,r){this.element=e,this.user=t,this.sessionId=s,this.local=i,this.index=n,this.value=r,this.name=Wt.NAME,Object.freeze(this)}}Wt.NAME="insert";class zt{constructor(e,t,s,i,n,r){this.element=e,this.user=t,this.sessionId=s,this.local=i,this.index=n,this.oldValue=r,this.name=zt.NAME,Object.freeze(this)}}zt.NAME="remove";class Yt{constructor(e,t,s,i,n,r){this.element=e,this.user=t,this.sessionId=s,this.local=i,this.fromIndex=n,this.toIndex=r,this.name=Yt.NAME,Object.freeze(this)}}Yt.NAME="reorder";class Qt{constructor(e,t,s,i,n,r,o){this.element=e,this.user=t,this.sessionId=s,this.local=i,this.index=n,this.value=r,this.oldValue=o,this.name=Qt.NAME,Object.freeze(this)}}Qt.NAME="set";class Kt{constructor(e,t,s,i){this.element=e,this.user=t,this.sessionId=s,this.local=i,this.name=Kt.NAME,Object.freeze(this)}}Kt.NAME="value";class Zt{constructor(e,t,s,i,n,r){this.element=e,this.user=t,this.sessionId=s,this.local=i,this.key=n,this.oldValue=r,this.name=Zt.NAME,Object.freeze(this)}}Zt.NAME="remove";class Xt{constructor(e,t,s,i,n,r,o){this.element=e,this.user=t,this.sessionId=s,this.local=i,this.key=n,this.value=r,this.oldValue=o,this.name=Xt.NAME,Object.freeze(this)}}Xt.NAME="set";class es{constructor(e,t,s,i){this.element=e,this.user=t,this.sessionId=s,this.local=i,this.name=es.NAME,Object.freeze(this)}}es.NAME="value";class ts{constructor(e,t,s,i){this.element=e,this.user=t,this.sessionId=s,this.local=i,this.name=ts.NAME,Object.freeze(this)}}ts.NAME="value";class ss{constructor(e,t,s,i){this.element=e,this.user=t,this.sessionId=s,this.local=i,this.name=ss.NAME,Object.freeze(this)}}ss.NAME="value";class is{constructor(e,t,s,i){this.element=e,this.user=t,this.sessionId=s,this.local=i,this.name=is.NAME,Object.freeze(this)}}is.NAME="value";class ns{constructor(e,t,s,i,n){this.element=e,this.user=t,this.sessionId=s,this.local=i,this.value=n,this.name=ns.NAME,Object.freeze(this)}}ns.NAME="delta";class rs{constructor(e,t,s,i,n,r){this.element=e,this.user=t,this.sessionId=s,this.local=i,this.index=n,this.value=r,this.name=rs.NAME,Object.freeze(this)}}rs.NAME="insert";class os{constructor(e,t,s,i,n,r){this.element=e,this.user=t,this.sessionId=s,this.local=i,this.index=n,this.value=r,this.name=os.NAME,Object.freeze(this)}}os.NAME="remove";class as{constructor(e,t,s,i){this.element=e,this.user=t,this.sessionId=s,this.local=i,this.name=as.NAME,Object.freeze(this)}}as.NAME="value";class cs{constructor(e){this.src=e,this.name=cs.NAME}}cs.NAME="detached";class hs{constructor(e,t,s,i,n,r){this.element=e,this.user=t,this.sessionId=s,this.local=i,this.relativePath=n,this.childEvent=r,this.name=hs.NAME,Object.freeze(this)}}hs.NAME="model_changed";class us{constructor(e,t,s){this.src=e,this.local=t,this.reason=s,this.name=us.NAME,Object.freeze(this)}}us.NAME="closed";class ds{constructor(e,t,s){this.src=e,this.local=t,this.reason=s,this.name=ds.NAME,Object.freeze(this)}}ds.NAME="deleted";class ls{constructor(e,t,s){this.model=e,this.permissions=t,this.changes=s,this.name=ls.NAME,Object.freeze(this)}}ls.NAME="permissions_changed";class ps{constructor(e,t){this.src=e,this.version=t,this.name=ps.NAME,Object.freeze(this)}}ps.NAME="version_changed";class fs{constructor(e){this.src=e,this.name=fs.NAME,Object.freeze(this)}}fs.NAME="online";class ms{constructor(e){this.src=e,this.name=ms.NAME,Object.freeze(this)}}ms.NAME="offline";class gs{constructor(e){this.src=e,this.name=gs.NAME,Object.freeze(this)}}gs.NAME="reconnecting";class vs{constructor(e){this.src=e,this.name=vs.NAME,Object.freeze(this)}}vs.NAME="resync_started";class ys{constructor(e){this.src=e,this.name=ys.NAME,Object.freeze(this)}}ys.NAME="resync_completed";class ws{constructor(e,t){this.src=e,this.message=t,this.name=ws.NAME,Object.freeze(this)}}ws.NAME="resync_error";class bs{constructor(e,t,s){this.reference=e,this.model=t,this.element=s,this.name=bs.NAME,Object.freeze(this)}}bs.NAME="reference";class Os{constructor(e,t,s){this.model=e,this.sessionId=t,this.user=s,this.name=Os.NAME,Object.freeze(this)}}Os.NAME="remote_resync_started";class Rs{constructor(e,t,s){this.model=e,this.sessionId=t,this.user=s,this.name=Rs.NAME,Object.freeze(this)}}Rs.NAME="remote_resync_completed";class Ms{constructor(e,t){this.src=e,this.collaborator=t,this.name=Ms.NAME,Object.freeze(this)}}Ms.NAME="collaborator_opened";class Es{constructor(e,t){this.src=e,this.collaborator=t,this.name=Es.NAME,Object.freeze(this)}}Es.NAME="collaborator_closed";class Is{constructor(e){this.src=e,this.name=Is.NAME,Object.freeze(this)}}Is.NAME="committed";class Ss{constructor(e){this.src=e,this.name=Ss.NAME,Object.freeze(this)}}Ss.NAME="modified";class Cs{constructor(){this.name=Cs.NAME,Object.freeze(this)}}Cs.NAME="offline_model_download_pending";class xs{constructor(){this.name=xs.NAME,Object.freeze(this)}}xs.NAME="offline_model_download_completed";class Ds{constructor(){this.name=Ds.NAME,Object.freeze(this)}}Ds.NAME="offline_model_sync_started";class _s{constructor(){this.name=_s.NAME,Object.freeze(this)}}_s.NAME="offline_model_sync_completed";class Ps{constructor(e,t){this.reason=e,this.code=t,this.name=Ps.NAME,Object.freeze(this)}}Ps.NAME="offline_model_sync_aborted";class As{constructor(e,t,s){this.modelId=e,this.message=t,this.model=s,this.name=As.NAME,Object.freeze(this)}}As.NAME="offline_model_sync_error";class Ts{constructor(e){this.id=e,this.name=Ts.NAME,Object.freeze(this)}}Ts.NAME="offline_model_deleted";class js{constructor(e){this.id=e,this.name=js.NAME,Object.freeze(this)}}js.NAME="offline_model_permissions_revoked";class Ns{constructor(e,t){this.src=e,this.local=t,this.name=Ns.NAME}}Ns.NAME="detached";class Us{constructor(e,t,s,i,n,r){this.src=e,this.local=t,this.relativePath=s,this.childEvent=i,this.sessionId=n,this.user=r,this.name=Us.NAME,Object.freeze(this)}}Us.NAME="node_changed";class qs{constructor(e,t,s,i,n,r){this.src=e,this.local=t,this.index=s,this.value=i,this.sessionId=n,this.user=r,this.name=qs.NAME,Object.freeze(this)}}qs.NAME="insert";class ks{constructor(e,t,s,i,n,r){this.src=e,this.local=t,this.index=s,this.oldValue=i,this.sessionId=n,this.user=r,this.name=ks.NAME,Object.freeze(this)}}ks.NAME="remove";class Vs{constructor(e,t,s,i,n,r,o){this.src=e,this.local=t,this.index=s,this.value=i,this.oldValue=n,this.sessionId=r,this.user=o,this.name=Vs.NAME,Object.freeze(this)}}Vs.NAME="set";class Ls{constructor(e,t,s,i,n,r){this.src=e,this.local=t,this.fromIndex=s,this.toIndex=i,this.sessionId=n,this.user=r,this.name=Ls.NAME,Object.freeze(this)}}Ls.NAME="reorder";class Gs{constructor(e,t,s,i,n){this.src=e,this.local=t,this.value=s,this.sessionId=i,this.user=n,this.name=Gs.NAME,Object.freeze(this)}}Gs.NAME="value";class $s{constructor(e,t,s,i,n){this.src=e,this.local=t,this.value=s,this.sessionId=i,this.user=n,this.name=$s.NAME,Object.freeze(this)}}$s.NAME="value";class Fs{constructor(e,t,s,i,n){this.src=e,this.local=t,this.value=s,this.sessionId=i,this.user=n,this.name=Fs.NAME,Object.freeze(this)}}Fs.NAME="value";class Js{constructor(e,t,s,i,n){this.src=e,this.local=t,this.value=s,this.sessionId=i,this.user=n,this.name=Js.NAME,Object.freeze(this)}}Js.NAME="delta";class Hs{constructor(e,t,s,i,n,r,o){this.src=e,this.local=t,this.key=s,this.value=i,this.oldValue=n,this.sessionId=r,this.user=o,this.name=Hs.NAME,Object.freeze(this)}}Hs.NAME="set";class Bs{constructor(e,t,s,i,n,r){this.src=e,this.local=t,this.key=s,this.oldValue=i,this.sessionId=n,this.user=r,this.name=Bs.NAME,Object.freeze(this)}}Bs.NAME="remove";class Ws{constructor(e,t,s,i,n){this.src=e,this.local=t,this.value=s,this.sessionId=i,this.user=n,this.name=Ws.NAME,Object.freeze(this)}}Ws.NAME="value";class zs{constructor(e,t,s,i,n,r){this.src=e,this.local=t,this.index=s,this.value=i,this.sessionId=n,this.user=r,this.name=zs.NAME,Object.freeze(this)}}zs.NAME="insert";class Ys{constructor(e,t,s,i,n,r){this.src=e,this.local=t,this.index=s,this.value=i,this.sessionId=n,this.user=r,this.name=Ys.NAME,Object.freeze(this)}}Ys.NAME="remove";class Qs{constructor(e,t,s,i,n){this.src=e,this.local=t,this.value=s,this.sessionId=i,this.user=n,this.name=Qs.NAME,Object.freeze(this)}}Qs.NAME="value";class Ks{constructor(e,t,s,i,n){this.src=e,this.local=t,this.value=s,this.sessionId=i,this.user=n,this.name=Ks.NAME,Object.freeze(this)}}Ks.NAME="value";class Zs{static convertEvent(e,t){if(e instanceof Ns)return new cs(t.wrap(e.src));if(e instanceof Us)return new hs(t.wrap(e.src),e.user,e.sessionId,e.local,e.relativePath,this.convertEvent(e.childEvent,t));if(e instanceof qs)return new Wt(t.wrap(e.src),e.user,e.sessionId,e.local,e.index,t.wrap(e.value));if(e instanceof ks)return new zt(t.wrap(e.src),e.user,e.sessionId,e.local,e.index,t.wrap(e.oldValue));if(e instanceof Ls)return new Yt(t.wrap(e.src),e.user,e.sessionId,e.local,e.fromIndex,e.toIndex);if(e instanceof Vs)return new Qt(t.wrap(e.src),e.user,e.sessionId,e.local,e.index,t.wrap(e.value),t.wrap(e.oldValue));if(e instanceof Gs)return new Kt(t.wrap(e.src),e.user,e.sessionId,e.local);if(e instanceof $s)return new ts(t.wrap(e.src),e.user,e.sessionId,e.local);if(e instanceof Fs)return new is(t.wrap(e.src),e.user,e.sessionId,e.local);if(e instanceof Js)return new ns(t.wrap(e.src),e.user,e.sessionId,e.local,e.value);if(e instanceof Ws)return new es(t.wrap(e.src),e.user,e.sessionId,e.local);if(e instanceof Bs)return new Zt(t.wrap(e.src),e.user,e.sessionId,e.local,e.key,t.wrap(e.oldValue));if(e instanceof Hs)return new Xt(t.wrap(e.src),e.user,e.sessionId,e.local,e.key,t.wrap(e.value),t.wrap(e.oldValue));if(e instanceof zs)return new rs(t.wrap(e.src),e.user,e.sessionId,e.local,e.index,e.value);if(e instanceof Ys)return new os(t.wrap(e.src),e.user,e.sessionId,e.local,e.index,e.value);if(e instanceof Qs)return new as(t.wrap(e.src),e.user,e.sessionId,e.local);if(e instanceof Ks)return new ss(t.wrap(e.src),e.user,e.sessionId,e.local);throw new Error("Unable to convert event: "+e.name)}}class Xs{constructor(){this.ns=new Map}put(e){const t=e.sessionId(),s=e.key();let i=this.ns.get(t);if(o.isUndefined(i)&&(i=new Map,this.ns.set(t,i)),i.has(s))throw new Error(`Reference with key "${s}" already exists for session "${t}".`);i.set(s,e)}get(e,t){const s=this.ns.get(e);return o.isUndefined(s)?void 0:s.get(t)}getAll(e){o.isUndefined(e)&&(e={});const t=[];return(o.isSet(e.sessionId)?[e.sessionId]:Array.from(this.ns.keys())).forEach(s=>{const i=this.ns.get(s);(o.isSet(e.key)?[e.key]:Array.from(i.keys())).forEach(e=>{const s=i.get(e);o.isUndefined(s)||t.push(s)})}),t}removeAll(){this.ns.clear()}remove(e,t){const s=this.ns.get(e);if(void 0!==s){const e=s.get(t);return s.delete(t),e}}removeBySession(e){this.ns.delete(e)}removeByKey(e){this.ns.forEach(t=>{t.delete(e)})}}class ei extends At{constructor(e,t,s,i,n,r){super(e,At.Types.INDEX,t,s,i,n,r)}rs(e,t){this.Jt(Tt.handleInsert(this.Nt,e,t),!0)}R(e,t){this.Jt(Tt.handleRemove(this.Nt,e,t),!0)}os(e,t){this.Jt(Tt.handleReorder(this.Nt,e,t),!0)}}class ti extends At{constructor(e,t,s,i,n,r){super(e,At.Types.RANGE,t,s,i,n,r)}rs(e,t){this.Jt(qt.handleInsert(this.Nt,e,t),!0)}R(e,t){this.Jt(qt.handleRemove(this.Nt,e,t),!0)}os(e,t){this.Jt(qt.handleReorder(this.Nt,e,t),!0)}}class si extends At{constructor(e,t,s,i,n,r){super(e,At.Types.ELEMENT,t,s,i,n,r),this.as=e=>{this.cs(e.src)}}$t(e,t){for(const e of this.values())e.removeListener(di.Events.DETACHED,this.as);for(const t of e)t.addListener(di.Events.DETACHED,this.as);super.$t(e,t)}Ft(){for(const e of this.values())e.removeListener(di.Events.DETACHED,this.as);super.Ft()}cs(e){const t=this.Nt.indexOf(e,0);if(t>-1){const e=this.Nt.slice(0);e.splice(t,1),this.$t(e,!0)}}}class ii extends At{constructor(e,t,s,i,n,r){super(e,At.Types.PROPERTY,t,s,i,n,r)}hs(e){const t=this.Nt.indexOf(e,0);if(t>-1){const e=this.Nt.slice(0);e.splice(t,1),this.$t(e,!0)}}}class ni{constructor(e,t,s,i){this.sessionId=e,this.resourceId=t,this.valueId=s,this.key=i}}class ri extends ni{constructor(e,t,s,i,n,r){super(e,t,s,i),this.referenceType=n,this.values=r}}class oi extends ni{constructor(e,t,s,i){super(e,t,s,i)}}class ai extends ni{constructor(e,t,s,i,n){super(e,t,s,i),this.values=n}}class ci extends ni{constructor(e,t,s,i){super(e,t,s,i)}}class hi{constructor(e,t,s,i){this.us=new Xs,this.ds=new Map,this.ls=t,this.kt=e,this.ps=s,this.ms=i}get(e,t){return this.us.get(e,t)}getAll(e){return this.us.getAll(e)}removeAll(){this.getAll().forEach(e=>e.Lt())}addLocalReference(e){const t=e.reference().key();if(this.ds.has(t))throw new Error(`Local reference already set for key: ${t}`);this.ds.set(t,e),this.us.put(e.reference())}removeLocalReference(e){const t=this.ds.get(e);void 0!==t&&t.dispose()}removeAllLocalReferences(){this.ds.forEach((e,t)=>{this.removeLocalReference(t)})}getLocalReference(e){return this.ds.get(e)}localReferences(){return new Map(this.ds)}handleRemoteReferenceEvent(e){if(e instanceof ri)this.gs(e);else if(e instanceof ai)this.vs(e);else if(e instanceof ci)this.ys(e);else{if(!(e instanceof oi))throw new Error("Invalid reference event.");this.ws(e)}}reshare(){this.ds.forEach(e=>{e.isShared()&&e.share()})}Gt(e){this.us.remove(e.sessionId(),e.key()),e.isLocal()&&this.ds.delete(e.key())}gs(e){const t=this.ms.getUserForSession(e.sessionId);let s;const i=e.values;if(this.bs(e.referenceType),"index"===e.referenceType)s=new ei(this,e.key,this.kt,t,e.sessionId,!1);else if("range"===e.referenceType)s=new ti(this,e.key,this.kt,t,e.sessionId,!1);else if("element"===e.referenceType)s=new si(this,e.key,this.kt,t,e.sessionId,!1);else{if("property"!==e.referenceType)throw new O("Invalid reference message: "+e);s=new ii(this,e.key,this.kt,t,e.sessionId,!1)}null!==i&&this.Os(s,i),this.us.put(s),this.ps(s)}bs(e){if(!this.ls.includes(e))throw new Error(`Invalid reference type: ${e}`)}ws(e){this.us.remove(e.sessionId,e.key).Lt()}ys(e){this.us.get(e.sessionId,e.key).Ft()}vs(e){const t=this.us.get(e.sessionId,e.key);this.Os(t,e.values)}Os(e,t){if(e.type()===At.Types.ELEMENT){const s=[];for(const e of t){const t=this.kt.Rs(e);void 0!==t&&s.push(t)}e.$t(s,!1)}else e.$t(t,!1)}}const ui={VALUE:"value",DETACHED:"detached",REFERENCE:"reference",MODEL_CHANGED:"model_changed"};Object.freeze(ui);class di extends R{constructor(e,t,s,i,n,r){super(),this.Ms=e,this.Es=t,this.Is=s,this.Ss=i;this.Tt=new hi(this,n,e=>{this.Cs(e)},r),this.Ms.events().pipe(Object(b.filter)(e=>this.Ss.emitLocalEvents()||!e.local||e instanceof Ns)).subscribe(e=>{const t=Zs.convertEvent(e,this.Is);this.de(t)})}model(){return this.Ss}id(){return this.Ms.id()}type(){return this.Ms.type()}path(){return this.Ms.path()}parent(){const e=this.Ms.path().slice(0);return e.pop(),this.Ss.elementAt(e)}relativePath(){const e=this.Ms.path().slice(0);return e.length>0?e.pop():null}removeFromParent(){this.xs();const e=this.Ms.path().slice(0);if(0===e.length)throw new Error("Can not remove the root object from the model");const t=e.pop();this.Ss.elementAt(e).Ds(t)}isDetached(){return this.Ms.isDetached()}isAttached(){return!this.Ms.isDetached()}value(e){return 0===arguments.length?this.Ms.data():(this.xs(),void this.Ms.data(e))}toJSON(){return this.Ms.toJson()}reference(e,t){return this.Tt.get(e,t)}references(e){return this.Tt.getAll(e)}_s(e){this.Tt.handleRemoteReferenceEvent(e)}Ps(e){this.Es.sendOperationCallback(e)}xs(){if(!this.Ss.permissions().write)throw new Error("The user does not have write permissions for the model.");this.As()}As(){if(this.isDetached())throw Error("Can not perform actions on a detached RealTimeElement.")}Cs(e){this.de(new bs(e,this.model(),this))}}di.Events=ui,Object.freeze(di.Events);class li extends _e{constructor(e,t,s,i){super(fe.ARRAY_SET,e,t),this.index=s,this.value=i,Object.freeze(this)}copy(e){return new li(n.update(this.id,e.id),n.update(this.noOp,e.noOp),n.update(this.index,e.index),n.update(this.value,e.value))}}class pi extends _e{constructor(e,t,s){super(fe.ARRAY_REMOVE,e,t),this.index=s,Object.freeze(this)}copy(e){return new pi(n.update(this.id,e.id),n.update(this.noOp,e.noOp),n.update(this.index,e.index))}}class fi extends _e{constructor(e,t,s,i){super(fe.ARRAY_REORDER,e,t),this.fromIndex=s,this.toIndex=i,Object.freeze(this)}copy(e){return new fi(n.update(this.id,e.id),n.update(this.noOp,e.noOp),n.update(this.fromIndex,e.fromIndex),n.update(this.toIndex,e.toIndex))}}class mi extends _e{constructor(e,t,s){super(fe.ARRAY_VALUE,e,t),this.value=s,Object.freeze(this)}copy(e){return new mi(n.update(this.id,e.id),n.update(this.noOp,e.noOp),n.update(this.value,e.value))}}const gi=Object.assign(Object.assign({},ui),{INSERT:"insert",REMOVE:"remove",SET:"set",REORDER:"reorder"});Object.freeze(gi);class vi extends di{constructor(e,t,s,i,n){super(e,t,s,i,[],n),this.Ms.events().subscribe(e=>{if(e.local)if(e instanceof qs)this.Ps(new Pe(this.id(),!1,e.index,e.src.get(e.index).dataValue()));else if(e instanceof ks)this.Ps(new pi(this.id(),!1,e.index));else if(e instanceof Ls)this.Ps(new fi(this.id(),!1,e.fromIndex,e.toIndex));else if(e instanceof Vs){const t=e.index;this.Ps(new li(this.id(),!1,t,e.src.get(t).dataValue()))}else e instanceof Gs&&this.Ps(new mi(this.id(),!1,e.src.dataValue().value))})}get(e){return this.Is.wrap(this.Ms.get(e))}set(e,t){return this.xs(),this.Is.wrap(this.Ms.set(e,t))}insert(e,t){return this.xs(),this.Is.wrap(this.Ms.insert(e,t))}remove(e){return this.xs(),this.Is.wrap(this.Ms.remove(e))}reorder(e,t){this.xs(),this.Ms.reorder(e,t)}push(e){return this.xs(),this.Is.wrap(this.Ms.push(e))}pop(){return this.xs(),this.Is.wrap(this.Ms.pop())}unshift(e){return this.xs(),this.Is.wrap(this.Ms.unshift(e))}shift(){return this.xs(),this.Is.wrap(this.Ms.shift())}length(){return this.Ms.length()}some(e){return this.Ms.some((t,s)=>e(this.Is.wrap(t),s))}every(e){return this.Ms.every((t,s)=>e(this.Is.wrap(t),s))}find(e){const t=this.Ms.find((t,s)=>e(this.Is.wrap(t),s));return void 0===t?void 0:this.Is.wrap(t)}findIndex(e){return this.Ms.findIndex((t,s)=>e(this.Is.wrap(t),s))}forEach(e){this.Ms.forEach((t,s)=>{e(this.Is.wrap(t),s)})}elementAt(...e){return this.Is.wrap(this.Ms.valueAt(...e))}Ds(e){if("number"!=typeof e)throw new Error("The relative path of a child must be a number: "+typeof e);this.remove(e)}_s(e){throw new Error("Arrays to do have references yet.")}}vi.Events=gi;class yi extends _e{constructor(e,t,s){super(fe.BOOLEAN_VALUE,e,t),this.value=s,Object.freeze(this)}copy(e){return new yi(n.update(this.id,e.id),n.update(this.noOp,e.noOp),n.update(this.value,e.value))}}class wi extends di{constructor(e,t,s,i,n){super(e,t,s,i,[],n),this.Ms.events().subscribe(e=>{e.local&&e instanceof $s&&this.Ps(new yi(this.id(),!1,e.value))})}_s(e){throw new Error("Boolean values do not process references")}}wi.Events=ui;class bi extends R{constructor(e,t){super(),this.ue(e.events()),this.Ts=e,this.js=!1,this.Es=t}type(){return this.Ts.type()}key(){return this.Ts.key()}source(){return this.Ts.source()}isLocal(){return!0}user(){return this.Ts.user()}sessionId(){return this.Ts.sessionId()}isDisposed(){return this.Ts.isDisposed()}value(){return this.Ts.value()}values(){return this.Ts.values()}reference(){return this.Ts}share(){this.Ns(),this.js=!0,this.Es.onShare(this)}unshare(){this.Ns(),this.js=!1,this.Es.onUnShare(this)}isShared(){return this.js}set(e){this.Ns(),e instanceof Array?this.Ts.$t(e,!1):this.Ts.$t([e],!1),this.isShared()&&this.Es.onSet(this)}clear(){this.Ns(),this.Ts.Ft(),this.Es.onClear(this)}isSet(){return this.Ts.isSet()}dispose(){this.Ns(),this.unshare(),this.Ts.Lt(),this.Es=null}Ns(){if(this.type()!==At.Types.ELEMENT&&this.reference().source().isDetached())throw new Error("The source model is detached")}}bi.Events=At.Events;class Oi extends bi{constructor(e,t){super(e,t)}}class Ri extends bi{constructor(e,t){super(e,t)}}class Mi extends bi{constructor(e,t){super(e,t)}}class Ei{}Ei.OBJECT="object",Ei.ARRAY="array",Ei.STRING="string",Ei.NUMBER="number",Ei.BOOLEAN="boolean",Ei.NULL="null",Ei.UNDEFINED="undefined",Ei.DATE="date";class Ii extends R{constructor(e,t,s,i,n){super(),this.N=t,this.Mt=n,this.Us=e,this.Ss=i,this.qs=s,this.Ss&&this.Ss.ks(this)}session(){return this.Mt}id(){return this.N}type(){return this.Us}path(){return this.qs()}model(){return this.Ss}isDetached(){return null===this.Ss}Vs(e){this.Ss.Ls(this),this.Ss=null;const t=new Ns(this,e);this.de(t)}data(e){return 0===arguments.length?this.Gs():void this.$s(e)}Fs(e){this.de(e),this.de(new Us(this,e.local,[],e,this.Mt.sessionId(),this.Mt.user()))}Js(){if(this.isDetached())throw Error("Can not perform actions on a detached ModelNode.")}}Ii.Events={DETACHED:"detached",NODE_CHANGED:"node_changed",OPERATION:"operation"};class Si extends Ii{constructor(e,t,s){super(Ei.UNDEFINED,e,t,void 0,s)}dataValue(){}toJson(){}Hs(e){throw new Error("Undefined values do not process operations")}Gs(){}$s(e){throw new Error("Can not set the delta on a Undefined type.")}}Si.Events={DETACHED:Ii.Events.DETACHED};class Ci extends Ii{constructor(e,t,s,i){super(Ei.NULL,e,t,s,i)}dataValue(){return{id:this.id(),type:"null",value:this.data()}}toJson(){return null}Hs(e){throw new Error("Null values do not process operations")}Gs(){return null}$s(e){throw new Error("Can not set the delta on a Null type.")}}Ci.Events={DETACHED:Ii.Events.DETACHED};class xi extends Ii{constructor(e,t,s,i){super(Ei.STRING,e.id,t,s,i),this.Bs=e.value}dataValue(){return{id:this.id(),type:"string",value:this.data()}}toJson(){return this.Bs}insert(e,t){this.Ws(e,t,!0,this.Mt.sessionId(),this.Mt.user())}remove(e,t){this.zs(e,t,!0,this.Mt.sessionId(),this.Mt.user())}length(){return this.Bs.length}Hs(e){const t=e.operation.type;if(t===fe.STRING_INSERT)this.Ys(e);else if(t===fe.STRING_REMOVE)this.Qs(e);else{if(t!==fe.STRING_VALUE)throw new Error("Invalid operation!");this.Ks(e)}}$s(e){this.Zs(e,!0,this.Mt.sessionId(),this.Mt.user())}Gs(){return this.Bs}Ws(e,t,s,i,n){l.assertValidStringIndex(e,this.Bs,!0,"index"),this.Bs=this.Bs.slice(0,e)+t+this.Bs.slice(e,this.Bs.length);const r=new zs(this,s,e,t,i,n);this.Fs(r)}zs(e,t,s,i,n){l.assertValidStringIndex(e,this.Bs,!1,"index"),l.assertValidStringIndex(e+t,this.Bs,!0);const r=this.Bs.slice(e,e+t);this.Bs=this.Bs.slice(0,e)+this.Bs.slice(e+t,this.Bs.length);const o=new Ys(this,s,e,r,i,n);this.Fs(o)}Zs(e,t,s,i){l.assertString(e),this.Bs=e;const n=new Qs(this,t,e,s,i);this.Fs(n)}Ys(e){const t=e.operation;this.Ws(t.index,t.value,!1,e.sessionId,e.user)}Qs(e){const t=e.operation;this.zs(t.index,t.value.length,!1,e.sessionId,e.user)}Ks(e){const t=e.operation;this.Zs(t.value,!1,e.sessionId,e.user)}}xi.Events={INSERT:"insert",REMOVE:"remove",VALUE:"value",DETACHED:Ii.Events.DETACHED,MODEL_CHANGED:Ii.Events.MODEL_CHANGED};class Di extends Ii{constructor(e,t,s,i,n){super(e,t,s,i,n),this.Xs=e=>{const t=e.relativePath.slice(0);t.unshift(this.ei.get(e.src.id()));const s=new Us(this,e.local,t,e.childEvent,this.Mt.sessionId(),this.Mt.user());this.de(s)},this.ei=new Map}valueAt(...e){const t=1===e.length&&Array.isArray(e[0])?e[0]:e;return 0===e.length?this:this.ti(t)}Vs(e){this.si(e),super.Vs(e)}ii(){return ji.create(void 0,()=>null,void 0,this.Mt)}}Di.Events={NODE_CHANGED:Ii.Events.NODE_CHANGED};class _i extends Di{constructor(e,t,s,i,n){super(Ei.ARRAY,e.id,t,s,i),this.ni=[],this.ri=n;for(let t=0;t<e.value.length;t++){const r=e.value[t];this.ei.set(r.id,t),this.ni.push(ji.create(r,this.oi(r.id),s,i,n))}this.ni.forEach(e=>{e.on(_i.Events.NODE_CHANGED,this.Xs)})}dataValue(){const e=this.ni.map(e=>e.dataValue());return{id:this.id(),type:"array",value:e}}toJson(){const e=[];return this.forEach(t=>{e.push(t.toJson())}),e}get(e){return this.ai(e,!1),this.ni[e]}set(e,t){this.ai(e,!1);const s=this.ri.createDataValue(t);return this.ci(e,s,!0,this.Mt.sessionId(),this.Mt.user()),this.get(e)}insert(e,t){this.ai(e,!0);const s=this.ri.createDataValue(t);return this.Ws(e,s,!0,this.Mt.sessionId(),this.Mt.user()),this.get(e)}remove(e){this.ai(e,!1);const t=this.get(e);return this.zs(e,!0,this.Mt.sessionId(),this.Mt.user()),t}reorder(e,t){this.ai(e,!1,"fromIndex"),this.ai(t,!1,"toIndex"),this.ui(e,t,!0,this.Mt.sessionId(),this.Mt.user())}push(e){return this.insert(this.ni.length,e)}pop(){return this.remove(this.ni.length-1)}unshift(e){return this.insert(0,e)}shift(){return this.remove(0)}length(){return this.ni.length}some(e){return this.ni.some(e)}every(e){return this.ni.every(e)}find(e){return this.ni.find(e)}findIndex(e){return this.ni.findIndex(e)}forEach(e){this.ni.forEach(e)}Hs(e){const t=e.operation.type;if(t===fe.ARRAY_INSERT)this.Ys(e);else if(t===fe.ARRAY_REORDER)this.di(e);else if(t===fe.ARRAY_REMOVE)this.Qs(e);else if(t===fe.ARRAY_SET)this.Ks(e);else{if(t!==fe.ARRAY_VALUE)throw new Error("Invalid operation!");this.li(e)}}Gs(){const e=[];return this.forEach(t=>{e.push(t.data())}),e}$s(e){const t=e.map(e=>this.ri.createDataValue(e));this.Zs(t,!0,this.Mt.sessionId(),this.Mt.user())}si(e){this.ei.clear(),this.forEach(t=>{t.Vs(e),t.removeListener(_i.Events.NODE_CHANGED,this.Xs)})}ti(e){if(0===e.length)return this;const t=e[0],s=this.ni[t];return void 0===s?this.ii():e.length>1?s.type()===Ei.OBJECT||s.type()===Ei.ARRAY?s.valueAt(e.slice(1,e.length)):this.ii():s}ai(e,t,s){if(e<0){throw new Error(`${s||"index"} must be >= 0: ${e}`)}if(!t&&e>=this.ni.length||t&&e>this.ni.length){throw new Error(`${s||"index"} must be ${t?"<=":"<"} the length of the array: ${e}`)}}Ws(e,t,s,i,n){this.pi(e,t),this.ei.set(t.id,e);const r=ji.create(t,this.oi(t.id),this.Ss,this.Mt,this.ri);r.on(_i.Events.NODE_CHANGED,this.Xs),this.ni.splice(e,0,r),this.fi(e);const o=new qs(this,s,e,r,i,n);this.Fs(o)}ci(e,t,s,i,n){this.mi(e,t);const r=this.ti([e]);r.type()!==Ei.UNDEFINED&&(r.removeListener(_i.Events.NODE_CHANGED,this.Xs),r.Vs(s)),this.ei.set(t.id,e);const o=ji.create(t,this.oi(t.id),this.model(),this.Mt,this.ri);o.on(_i.Events.NODE_CHANGED,this.Xs),this.ni[e]=o,this.fi(e);const a=new Vs(this,s,e,o,r,i,n);this.Fs(a)}zs(e,t,s,i){this.gi(e);const n=this.ti([e]);n.type()!==Ei.UNDEFINED&&(n.removeListener(_i.Events.NODE_CHANGED,this.Xs),n.Vs(t)),this.ni.splice(e,1),this.fi(e);const r=new ks(this,t,e,n,s,i);this.Fs(r)}Zs(e,t,s,i){l.assertArray(e,"data"),this.si(t),this.ni=e.map((e,t)=>(this.ei.set(e.id,t),ji.create(e,this.oi(e.id),this.model(),this.Mt,this.ri))),this.ni.forEach(e=>{e.on(_i.Events.NODE_CHANGED,this.Xs)});const n=new Gs(this,t,this.data(),s,i);this.Fs(n)}ui(e,t,s,i,n){this.vi(e,t);const r=this.ni[e];this.ni.splice(e,1),this.ni.splice(t,0,r),this.fi(Math.min(e,t));const o=new Ls(this,s,e,t,i,n);this.Fs(o)}Ys(e){const t=e.operation;this.Ws(t.index,t.value,!1,e.sessionId,e.user)}di(e){const t=e.operation;this.ui(t.fromIndex,t.toIndex,!1,e.sessionId,e.user)}Qs(e){const t=e.operation;this.zs(t.index,!1,e.sessionId,e.user)}Ks(e){const t=e.operation;this.ci(t.index,t.value,!1,e.sessionId,e.user)}li(e){const t=e.operation;this.Zs(t.value,!1,e.sessionId,e.user)}oi(e){return()=>{const t=this.path();return t.push(this.ei.get(e)),t}}pi(e,t){if(this.ni.length<e||e<0)throw new Error("Index out of bounds!");if(void 0===t||"function"==typeof t)throw new Error("Invalid value for insert!")}vi(e,t){if(this.ni.length<=e||e<0||this.ni.length<=t||t<0)throw new Error("Index out of bounds!")}gi(e){if(this.ni.length<=e||e<0)throw new Error("Index out of bounds!")}mi(e,t){if(this.ni.length<=e||e<0)throw new Error("Index out of bounds!");if(void 0===t||"function"==typeof t)throw new Error("Illegal argument!")}fi(e){for(let t=e;t<this.ni.length;t++){const e=this.ni[t];this.ei.set(e.id(),t)}}}_i.Events={INSERT:"insert",REMOVE:"remove",SET:"set",REORDER:"reorder",VALUE:"value",DETACHED:Ii.Events.DETACHED,NODE_CHANGED:Di.Events.NODE_CHANGED};class Pi extends Ii{constructor(e,t,s,i){super(Ei.NUMBER,e.id,t,s,i),this.Bs=e.value}dataValue(){return{id:this.id(),type:"number",value:this.data()}}toJson(){return this.Bs}add(e){this.yi(e,!0,this.Mt.sessionId(),this.Mt.user())}subtract(e){this.add(-e)}increment(){this.add(1)}decrement(){this.add(-1)}Hs(e){const t=e.operation.type;if(t===fe.NUMBER_DELTA)this.wi(e);else{if(t!==fe.NUMBER_VALUE)throw new Error("Invalid operation!");this.Ks(e)}}$s(e){this.ci(e,!0,this.Mt.sessionId(),this.Mt.user())}Gs(){return this.Bs}yi(e,t,s,i){if(this.bi(e),0!==e){this.Bs+=e;const n=new Js(this,t,e,s,i);this.Fs(n)}}ci(e,t,s,i){this.bi(e),this.Bs=e;const n=new Fs(this,t,e,s,i);this.Fs(n)}wi(e){const t=e.operation;this.yi(t.delta,!1,e.sessionId,e.user)}Ks(e){const t=e.operation;this.ci(t.value,!1,e.sessionId,e.user)}bi(e){if("number"!=typeof e)throw new Error(`The value must be a number but was: ${typeof e}`);if(isNaN(e))throw new Error("The delta must not be NaN")}}Pi.Events={DELTA:"delta",VALUE:"value",DETACHED:Ii.Events.DETACHED,MODEL_CHANGED:Ii.Events.MODEL_CHANGED};class Ai extends Ii{constructor(e,t,s,i){super(Ei.BOOLEAN,e.id,t,s,i),this.Bs=e.value}dataValue(){return{id:this.id(),type:"boolean",value:this.data()}}toJson(){return this.Bs}Hs(e){if(e.operation.type!==fe.BOOLEAN_VALUE)throw new Error("Invalid operation!");this.Ks(e)}$s(e){this.Zs(e,!0,this.Mt.sessionId(),this.Mt.user())}Gs(){return this.Bs}Zs(e,t,s,i){l.assertBoolean(e),this.Bs=e;const n=new $s(this,t,e,s,i);this.Fs(n)}Ks(e){const t=e.operation;this.Zs(t.value,!1,e.sessionId,e.user)}}Ai.Events={VALUE:"value",DETACHED:Ii.Events.DETACHED,MODEL_CHANGED:Ii.Events.MODEL_CHANGED};class Ti extends Ii{constructor(e,t,s,i){super(Ei.DATE,e.id,t,s,i),this.Bs=e.value}dataValue(){return{id:this.id(),type:"date",value:this.data()}}toJson(){return{$convergenceType:"date",value:this.Bs.toISOString()}}Hs(e){if(e.operation.type!==fe.DATE_VALUE)throw new Error("Invalid operation!");this.Ks(e)}$s(e){this.Zs(e,!0,this.Mt.sessionId(),this.Mt.user())}Gs(){return this.Bs}Zs(e,t,s,i){l.assertDate(e),this.Bs=e;const n=new Ks(this,t,e,s,i);this.Fs(n)}Ks(e){const t=e.operation;this.Zs(t.value,!1,e.sessionId,e.user)}}Ti.Events={VALUE:"value",DETACHED:Ii.Events.DETACHED,MODEL_CHANGED:Ii.Events.MODEL_CHANGED};class ji{static create(e,t,s,i,n){if(void 0===e)return new Si(void 0,t,i);const r=e.type;if("null"===r)return new Ci(e.id,t,s,i);if("string"===r)return new xi(e,t,s,i);if("array"===r)return new _i(e,t,s,i,n);if("object"===r)return new Ni(e,t,s,i,n);if("number"===r)return new Pi(e,t,s,i);if("boolean"===r)return new Ai(e,t,s,i);if("date"===r)return new Ti(e,t,s,i);throw new Error("Invalid data type: "+r)}}class Ni extends Di{constructor(e,t,s,i,n){super(Ei.OBJECT,e.id,t,s,i),this.dataValueFactory=n,this.ni=new Map,Object.getOwnPropertyNames(e.value).forEach(t=>{const i=e.value[t];this.ei.set(i.id,t),this.ni.set(t,ji.create(i,this.oi(i.id),s,this.Mt,this.dataValueFactory))}),this.ni.forEach(e=>{e.on(Ni.Events.NODE_CHANGED,this.Xs)})}dataValue(){const e={};return this.ni.forEach((t,s)=>{e[s]=t.dataValue()}),{id:this.id(),type:"object",value:e}}toJson(){const e={};return this.forEach((t,s)=>{e[s]=t.toJson()}),e}get(e){return l.assertString(e,"key"),this.ti([e])}set(e,t){const s=this.dataValueFactory.createDataValue(t);return this.ci(e,s,!0,this.Mt.sessionId(),this.Mt.user()),this.get(e)}remove(e){const t=this.ti([e]);return this.zs(e,!0,this.Mt.sessionId(),this.Mt.user()),t}keys(){const e=[];return this.ni.forEach((t,s)=>{e.push(s)}),e}hasKey(e){return this.ni.has(e)}forEach(e){this.ni.forEach((t,s)=>{e(t,s)})}Hs(e){switch(e.operation.type){case fe.OBJECT_ADD:this.Oi(e);break;case fe.OBJECT_SET:this.Ri(e);break;case fe.OBJECT_REMOVE:this.Mi(e);break;case fe.OBJECT_VALUE:this.Ks(e);break;default:throw new Error("Invalid operation for RealTimeObject")}}Gs(){const e={};return this.forEach((t,s)=>{e[s]=t.data()}),e}$s(e){const t={};for(const s in e)e.hasOwnProperty(s)&&(t[s]=this.dataValueFactory.createDataValue(e[s]));this.Zs(t,!0,this.Mt.sessionId(),this.Mt.user())}ti(e){if(0===e.length)return this;const t=e[0],s=this.ni.get(t);return void 0===s?this.ii():e.length>1?s.type()===Ei.OBJECT||s.type()===Ei.ARRAY?s.valueAt(e.slice(1,e.length)):this.ii():s}si(e){this.forEach(t=>{t.Vs(e),t.removeListener(Ni.Events.NODE_CHANGED,this.Xs)})}oi(e){return()=>{const t=this.path();return t.push(this.ei.get(e)),t}}ci(e,t,s,i,n){l.assertString(e,"key");const r=this.ti([e]);r.type()!==Ei.UNDEFINED&&(r.removeListener(Ni.Events.NODE_CHANGED,this.Xs),r.Vs(s));const o=ji.create(t,this.oi(t.id),this.Ss,this.Mt,this.dataValueFactory);o.on(Ni.Events.NODE_CHANGED,this.Xs),this.ni.set(e,o),this.ei.set(o.id(),e);const a=new Hs(this,s,e,o,r,i,n);this.Fs(a)}zs(e,t,s,i){if(l.assertString(e,"key"),this.ni.has(e)){this.ei.delete(e);const n=this.ni.get(e);n.removeListener(Ni.Events.NODE_CHANGED,this.Xs),n.Vs(t),this.ni.delete(e);const r=new Bs(this,t,e,n,s,i);this.Fs(r)}}Zs(e,t,s,i){this.si(t),this.ni=new Map;for(const t in e)if(e.hasOwnProperty(t)){const s=e[t];this.ei.set(s.id,t),this.ni.set(t,ji.create(s,this.oi(s.id),this.model(),this.Mt,this.dataValueFactory))}this.ni.forEach(e=>{e.on(Ni.Events.NODE_CHANGED,this.Xs)});const n=new Ws(this,t,this.data(),s,i);this.Fs(n)}Oi(e){const t=e.operation;this.ci(t.prop,t.value,!1,e.sessionId,e.user)}Ri(e){const t=e.operation;this.ci(t.prop,t.value,!1,e.sessionId,e.user)}Mi(e){const t=e.operation;this.zs(t.prop,!1,e.sessionId,e.user)}Ks(e){const t=e.operation;this.Zs(t.value,!1,e.sessionId,e.user)}}Ni.Events={SET:"set",REMOVE:"remove",VALUE:"value",DETACHED:Ii.Events.DETACHED,NODE_CHANGED:Ii.Events.NODE_CHANGED,OPERATION:Ii.Events.OPERATION};const Ui=":";class qi extends R{constructor(e,t,s){super(),this.Mt=e,this.Ei=t,this.Ii=new Map,this.Si=0;const i=new Bt(()=>this.Ei+Ui+this.Si++);this.Bs=new Ni(s,()=>[],this,e,i)}root(){return this.Bs}valueAt(...e){return this.Bs.valueAt(...e)}setValueIdPrefix(e){this.Ei=e}Rs(e){return this.Ii.get(e)}ks(e){this.Ii.set(e.id(),e)}Ls(e){this.Ii.delete(e.id())}handleModelOperationEvent(e){const t=this.Ii.get(e.operation.id);t&&t.Hs(e)}valueIdPrefix(){return this.Ei}}var ki;qi.Events={DELETED:"deleted",MODIFIED:"modified"},Object.freeze(qi.Events),function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.UNAUTHORIZED=1]="UNAUTHORIZED",e[e.DELETED=2]="DELETED",e[e.ERROR_APPLYING_OPERATION=3]="ERROR_APPLYING_OPERATION",e[e.INVALID_REFERENCE_EVENT=4]="INVALID_REFERENCE_EVENT",e[e.PERMISSION_ERROR=5]="PERMISSION_ERROR",e[e.UNEXPECTED_COMMITTED_VERSION=6]="UNEXPECTED_COMMITTED_VERSION"}(ki||(ki={}));class Vi{constructor(){this.Ci=new Map}wrap(e){let t=this.Ci.get(e.id());return void 0===t&&(t=this.xi(e),this.Ci.set(e.id(),t),e.on(Ii.Events.DETACHED,()=>{this.Ci.delete(e.id())})),t}}class Li extends _e{constructor(e,t,s){super(fe.OBJECT_REMOVE,e,t),this.prop=s,Object.freeze(this)}copy(e){return new Li(n.update(this.id,e.id),n.update(this.noOp,e.noOp),n.update(this.prop,e.prop))}}class Gi extends _e{constructor(e,t,s){super(fe.OBJECT_VALUE,e,t),this.value=s,Object.freeze(this)}copy(e){return new Gi(n.update(this.id,e.id),n.update(this.noOp,e.noOp),n.update(this.value,e.value))}}const $i=Object.assign({SET:"set",REMOVE:"remove"},ui);Object.freeze($i);class Fi extends di{constructor(e,t,s,i,n){super(e,t,s,i,[At.Types.PROPERTY],n),this.Ms.events().subscribe(e=>this.Di(e))}get(e){return this.Is.wrap(this.Ms.get(e))}set(e,t){this.xs();const s=this.Ms.hasKey(e),i=this.Ms.set(e,t),n=s?new dt(this.id(),!1,e,i.dataValue()):new gt(this.id(),!1,e,i.dataValue());return this.Ps(n),this.Is.wrap(i)}remove(e){return this.xs(),this.Is.wrap(this.Ms.remove(e))}keys(){return this.Ms.keys()}hasKey(e){return this.Ms.hasKey(e)}forEach(e){this.Ms.forEach((t,s)=>{e(this.Is.wrap(t),s)})}elementAt(...e){return this.Is.wrap(this.Ms.valueAt(...e))}propertyReference(e){const t=this.Tt.getLocalReference(e);if(void 0!==t){if(t.reference().type()!==At.Types.PROPERTY)throw new Error("A reference with this key already exists, but is not an index reference");return t}{const t=new ii(this.Tt,e,this,this.Ms.session().user(),this.Ms.session().sessionId(),!0),s=new Ri(t,this.Es.referenceEventCallbacks);return this.Tt.addLocalReference(s),s}}Ds(e){if("string"!=typeof e)throw new Error("The relative path of a child must be a string: "+typeof e);this.remove(e)}Di(e){e instanceof Ws?(e.local&&this.Ps(new Gi(this.id(),!1,this.Ms.dataValue().value)),this.Tt.getAll().forEach(e=>{e.Lt()}),this.Tt.removeAll(),this.Tt.removeAllLocalReferences()):e instanceof Bs?(e.local&&this.Ps(new Li(this.id(),!1,e.key)),this.Tt.getAll().forEach(t=>{t instanceof ii&&t.hs(e.key)})):e instanceof Hs&&(e.local,this.Tt.getAll().forEach(t=>{t instanceof ii&&t.hs(e.key)}))}}Fi.Events=$i;class Ji extends di{constructor(e,t,s,i,n){super(e,t,s,i,[],n)}handleRemoteReferenceEvent(e){throw new Error("Null values do not process references")}}Ji.Events=ui;class Hi extends _e{constructor(e,t,s){super(fe.NUMBER_VALUE,e,t),this.value=s,Object.freeze(this)}copy(e){return new Hi(n.update(this.id,e.id),n.update(this.noOp,e.noOp),n.update(this.value,e.value))}}class Bi extends _e{constructor(e,t,s){super(fe.NUMBER_DELTA,e,t),this.delta=s,Object.freeze(this)}copy(e){return new Bi(n.update(this.id,e.id),n.update(this.noOp,e.noOp),n.update(this.delta,e.delta))}}const Wi=Object.assign({DELTA:"delta"},ui);Object.freeze(Wi);class zi extends di{constructor(e,t,s,i,n){super(e,t,s,i,[],n),this.Ms.events().subscribe(e=>{e.local&&(e instanceof Fs?this.Ps(new Hi(this.id(),!1,e.value)):e instanceof Js&&this.Ps(new Bi(this.id(),!1,e.value)))})}add(e){this.xs(),this.Ms.add(e)}subtract(e){this.xs(),this.Ms.subtract(e)}increment(){this.xs(),this.Ms.increment()}decrement(){this.xs(),this.Ms.decrement()}_s(e){throw new Error("Number values do not process references")}}zi.Events=Wi;class Yi extends _e{constructor(e,t,s,i){super(fe.STRING_INSERT,e,t),this.index=s,this.value=i,Object.freeze(this)}copy(e){return new Yi(n.update(this.id,e.id),n.update(this.noOp,e.noOp),n.update(this.index,e.index),n.update(this.value,e.value))}}class Qi extends _e{constructor(e,t,s,i){super(fe.STRING_REMOVE,e,t),this.index=s,this.value=i,Object.freeze(this)}copy(e){return new Qi(n.update(this.id,e.id),n.update(this.noOp,e.noOp),n.update(this.index,e.index),n.update(this.value,e.value))}}class Ki extends bi{constructor(e,t){super(e,t)}}class Zi extends _e{constructor(e,t,s){super(fe.STRING_VALUE,e,t),this.value=s,Object.freeze(this)}copy(e){return new Zi(n.update(this.id,e.id),n.update(this.noOp,e.noOp),n.update(this.value,e.value))}}const Xi=Object.assign({INSERT:"insert",REMOVE:"remove"},ui);Object.freeze(Xi);class en extends di{constructor(e,t,s,i,n){super(e,t,s,i,[At.Types.INDEX,At.Types.RANGE],n),this.Ms.events().subscribe(e=>this._i(e))}insert(e,t){this.xs(),this.Ms.insert(e,t)}remove(e,t){this.xs(),this.Ms.remove(e,t)}length(){return this.Ms.length()}indexReference(e){const t=this.Tt.getLocalReference(e);if(void 0!==t){if(t.reference().type()!==At.Types.INDEX)throw new Error("A reference with this key already exists, but is not an index reference");return t}{const t=new ei(this.Tt,e,this,this.Ms.session().user(),this.Ms.session().sessionId(),!0),s=new Ki(t,this.Es.referenceEventCallbacks);return this.Tt.addLocalReference(s),s}}rangeReference(e){const t=this.Tt.getLocalReference(e);if(void 0!==t){if(t.reference().type()!==At.Types.RANGE)throw new Error("A reference with this key already exists, but is not a range reference");return t}{const t=new ti(this.Tt,e,this,this.Ms.session().user(),this.Ms.session().sessionId(),!0),s=new Mi(t,this.Es.referenceEventCallbacks);return this.Tt.addLocalReference(s),s}}_i(e){e instanceof zs?(e.local&&this.Ps(new Yi(this.id(),!1,e.index,e.value)),this.Tt.getAll().forEach(t=>{t instanceof ei?t.rs(e.index,e.value.length):t instanceof ti&&t.rs(e.index,e.value.length)})):e instanceof Ys?(e.local&&this.Ps(new Qi(this.id(),!1,e.index,e.value)),this.Tt.getAll().forEach(t=>{t instanceof ei?t.R(e.index,e.value.length):t instanceof ti&&t.R(e.index,e.value.length)})):e instanceof Qs&&(e.local&&this.Ps(new Zi(this.id(),!1,e.value)),this.Tt.getAll().forEach(e=>{e.Lt()}),this.Tt.removeAll())}}en.Events=Xi,Object.freeze(en.Events);class tn extends di{constructor(e,t,s,i,n){super(e,t,s,i,[],n)}path(){return null}relativePath(){return null}parent(){return null}removeFromParent(){}handleRemoteReferenceEvent(e){throw new Error("Undefined values do not process references")}setData(e){throw new Error("Can not set the delta on a Undefined type.")}}tn.Events=ui;class sn extends _e{constructor(e,t,s){super(fe.DATE_VALUE,e,t),this.value=s,Object.freeze(this)}copy(e){return new sn(n.update(this.id,e.id),n.update(this.noOp,e.noOp),n.update(this.value,e.value))}}class nn extends di{constructor(e,t,s,i,n){super(e,t,s,i,[],n),this.Ms.events().subscribe(e=>{e.local&&e instanceof Ks&&this.Ps(new sn(this.id(),!1,e.value))})}_s(e){throw new Error("Date values do not process references")}}nn.Events=ui;class rn extends Vi{constructor(e,t,s){super(),this.Es=e,this.Ss=t,this.ms=s}xi(e){switch(e.type()){case Ei.ARRAY:return new vi(e,this.Es,this,this.Ss,this.ms);case Ei.OBJECT:return new Fi(e,this.Es,this,this.Ss,this.ms);case Ei.BOOLEAN:return new wi(e,this.Es,this,this.Ss,this.ms);case Ei.NULL:return new Ji(e,this.Es,this,this.Ss,this.ms);case Ei.NUMBER:return new zi(e,this.Es,this,this.Ss,this.ms);case Ei.STRING:return new en(e,this.Es,this,this.Ss,this.ms);case Ei.UNDEFINED:return new tn(e,this.Es,this,this.Ss,this.ms);case Ei.DATE:return new nn(e,this.Es,this,this.Ss,this.ms);default:return null}}}class on{constructor(e,t,s,i){this.clientId=e,this.version=t,this.timestamp=s,this.operation=i,Object.freeze(this)}copy(e){return e=n.getOrDefault(e,{}),new on(n.getOrDefault(e.clientId,this.clientId),n.getOrDefault(e.version,this.version),n.getOrDefault(e.timestamp,this.timestamp),n.getOrDefault(e.operation,this.operation))}}class an{constructor(e,t,s,i,n){this.sessionId=e,this.user=t,this.version=s,this.timestamp=i,this.operation=n,Object.freeze(this)}}class cn{constructor(e,t){this.user=e,this.sessionId=t,Object.freeze(this)}}const hn={CLOSED:"closed",DELETED:"deleted",VERSION_CHANGED:"version_changed"};Object.freeze(hn);class un{static objectToMap(e){const t=new Map;return Object.keys(e).forEach(s=>t.set(s,e[s])),t}static mapToObject(e){const t={};return e.forEach((e,s)=>t[s]=e),t}static coerceToObject(e){return void 0===e?{}:e instanceof Map?un.mapToObject(e):e}static coerceToMap(e){return void 0===e?new Map:e instanceof Map?e:un.objectToMap(e)}static toStringMap(e){return e?e instanceof Map?e:un.objectToMap(e):e}}class dn{constructor(e,t,s,i){this.read=e,this.write=t,this.remove=s,this.manage=i,Object.freeze(this)}static fromJSON(e){return new dn(e.read,e.write,e.remove,e.manage)}toJSON(){return{read:this.read,write:this.write,remove:this.remove,manage:this.manage}}}class ln{constructor(e,t,s,i,n,r){this.data=e,this.collectionId=t,this.modelId=s,this.created=i,this.modified=n,this.version=r,Object.freeze(this)}}function pn(e){if(e.arrayValue){const{id:t,children:s}=e.arrayValue;return{type:"array",id:t,value:Y(s).map(pn)}}if(e.objectValue)return gn(e.objectValue);if(e.booleanValue){const{id:t,value:s}=e.booleanValue;return{type:"boolean",id:t,value:W(s)}}if(e.dateValue){const{id:t,value:s}=e.dateValue;return{type:"date",id:t,value:X(s)}}if(e.doubleValue){const{id:t,value:s}=e.doubleValue;return{type:"number",id:t,value:B(s)}}if(e.stringValue){const{id:t,value:s}=e.stringValue;return{type:"string",id:t,value:z(s)}}if(e.nullValue){const{id:t}=e.nullValue;return{type:"null",id:t,value:null}}throw new O("Invalid data delta type: "+JSON.stringify(e))}function fn(e){if("array"===e.type){const{id:t,value:s}=e;return{arrayValue:{id:t,children:s.map(fn)}}}if("object"===e.type){const{id:t,value:s}=e;return{objectValue:{id:t,children:h(s,fn)}}}if("boolean"===e.type){const{id:t,value:s}=e;return{booleanValue:{id:t,value:s}}}if("date"===e.type){const{id:t,value:s}=e;return{dateValue:{id:t,value:ee(s)}}}if("number"===e.type){const{id:t,value:s}=e;return{doubleValue:{id:t,value:s}}}if("null"===e.type){const{id:t}=e;return{nullValue:{id:t}}}if("string"===e.type){const{id:t,value:s}=e;return{stringValue:{id:t,value:s}}}throw new O("Invalid data delta type: "+JSON.stringify(e))}function mn(e){return{id:e.id,children:h(e.value,fn)}}function gn(e){return{type:"object",id:e.id,value:h(Q(e.children),pn)}}function vn(e){return void 0===e?void 0:new dn(W(e.read),W(e.write),W(e.remove),W(e.manage))}function yn(e){const t=Q(e.data.fields);return new ln(h(t,te),e.collectionId,e.modelId,X(e.createdTime),X(e.modifiedTime),B(e.version))}function wn(e){if(null==e)return[];{const t=[];return u(e,(e,s)=>{t.push({user:ne(k.normal(e)),permissions:s})}),t}}class bn{constructor(e,t){this.Pi=e,this.Ke=t}get modelId(){return this.Pi}getPermissions(){const e={getModelPermissionsRequest:{modelId:this.Pi}};return this.Ke.request(e).then(e=>{const{getModelPermissionsResponse:t}=e;return vn(t.userPermissions[this.Ke.session().user().username])})}setOverridesCollection(e){const t={setModelPermissionsRequest:{modelId:this.Pi,overrideCollection:{value:e},removeAllUserPermissionsBeforeSet:!1,setUserPermissions:[],removedUserPermissions:[]}};return this.Ke.request(t).then(()=>{})}getOverridesCollection(){const e={getModelPermissionsRequest:{modelId:this.Pi}};return this.Ke.request(e).then(e=>{const{getModelPermissionsResponse:t}=e;return t.overridesCollection})}getWorldPermissions(){const e={getModelPermissionsRequest:{modelId:this.Pi}};return this.Ke.request(e).then(e=>{const{getModelPermissionsResponse:t}=e;return vn(t.worldPermissions)})}setWorldPermissions(e){const t={setModelPermissionsRequest:{modelId:this.Pi,worldPermissions:e,removeAllUserPermissionsBeforeSet:!1,setUserPermissions:[],removedUserPermissions:[]}};return this.Ke.request(t).then(()=>{})}getAllUserPermissions(){const e={getModelPermissionsRequest:{modelId:this.Pi}};return this.Ke.request(e).then(e=>{const{getModelPermissionsResponse:t}=e;return function(e){const t=new Map;return o.isArray(e)&&e.forEach(e=>{t.set(e.user.username,vn(e.permissions))}),t}(t.userPermissions)})}setAllUserPermissions(e){if(!(e instanceof Map)){const t=e,s=new Map;Object.keys(t).forEach(e=>{s.set(e,t[e])}),e=s}const t={setModelPermissionsRequest:{modelId:this.Pi,setUserPermissions:wn(un.mapToObject(e)),removeAllUserPermissionsBeforeSet:!0}};return this.Ke.request(t).then(()=>{})}getUserPermissions(e){const t={getModelPermissionsRequest:{modelId:this.Pi}};return this.Ke.request(t).then(t=>{const{getModelPermissionsResponse:s}=t;return vn(s.userPermissions[e])})}setUserPermissions(e,t){const s=k.toDomainUserId(e),i={setModelPermissionsRequest:{modelId:this.Pi,worldPermissions:null,setUserPermissions:[{user:ne(s),permissions:t}],removeAllUserPermissionsBeforeSet:!1,removedUserPermissions:[]}};return this.Ke.request(i).then(()=>{})}removeUserPermissions(e){const t=k.toDomainUserId(e),s={setModelPermissionsRequest:{modelId:this.Pi,removeAllUserPermissionsBeforeSet:!1,removedUserPermissions:[ne(t)]}};return this.Ke.request(s).then(()=>{})}}function On(e){if(e.compoundOperation)return function(e){const t=Y(e.operations).map(Rn);return new me(t)}(e.compoundOperation);if(e.discreteOperation)return Rn(e.discreteOperation);throw new O("Invalid operation data: "+JSON.stringify(e))}function Rn(e){if(e.arrayInsertOperation){const{id:t,noOp:s,index:i,value:n}=e.arrayInsertOperation;return new Pe(t,W(s),B(i),pn(n))}if(e.arrayRemoveOperation){const{id:t,noOp:s,index:i}=e.arrayRemoveOperation;return new pi(t,W(s),B(i))}if(e.arrayMoveOperation){const{id:t,noOp:s,fromIndex:i,toIndex:n}=e.arrayMoveOperation;return new fi(t,W(s),B(i),B(n))}if(e.arrayReplaceOperation){const{id:t,noOp:s,index:i,value:n}=e.arrayReplaceOperation;return new li(t,W(s),B(i),pn(n))}if(e.arraySetOperation){const{id:t,noOp:s,values:i}=e.arraySetOperation;return new mi(t,W(s),Y(i).map(pn))}if(e.objectAddPropertyOperation){const{id:t,noOp:s,key:i,value:n}=e.objectAddPropertyOperation;return new gt(t,W(s),z(i),pn(n))}if(e.objectSetPropertyOperation){const{id:t,noOp:s,key:i,value:n}=e.objectSetPropertyOperation;return new dt(t,W(s),z(i),pn(n))}if(e.objectRemovePropertyOperation){const{id:t,noOp:s,key:i}=e.objectRemovePropertyOperation;return new Li(t,W(s),z(i))}if(e.objectSetOperation){const{id:t,noOp:s,values:i}=e.objectSetOperation;return new Gi(t,W(s),h(i,pn))}if(e.stringInsertOperation){const{id:t,noOp:s,index:i,value:n}=e.stringInsertOperation;return new Yi(t,W(s),B(i),z(n))}if(e.stringRemoveOperation){const{id:t,noOp:s,index:i,value:n}=e.stringRemoveOperation;return new Qi(t,W(s),B(i),z(n))}if(e.stringSetOperation){const{id:t,noOp:s,value:i}=e.stringSetOperation;return new Zi(t,W(s),z(i))}if(e.numberDeltaOperation){const{id:t,noOp:s,delta:i}=e.numberDeltaOperation;return new Bi(t,W(s),B(i))}if(e.numberSetOperation){const{id:t,noOp:s,value:i}=e.numberSetOperation;return new Hi(t,W(s),B(i))}if(e.booleanSetOperation){const{id:t,noOp:s,value:i}=e.booleanSetOperation;return new yi(t,W(s),W(i))}if(e.dateSetOperation){const{id:t,noOp:s,value:i}=e.dateSetOperation;return new sn(t,W(s),X(i))}}function Mn(e){if(e instanceof me)return{compoundOperation:En(e)};if(e instanceof _e)return{discreteOperation:In(e)};throw new O("Invalid operation data: "+JSON.stringify(e))}function En(e){return{operations:e.ops.map(In)}}function In(e){if(e instanceof Pe){const{id:t,noOp:s,index:i,value:n}=e;return{arrayInsertOperation:{id:t,noOp:s,index:i,value:fn(n)}}}if(e instanceof pi){const{id:t,noOp:s,index:i}=e;return{arrayRemoveOperation:{id:t,noOp:s,index:i}}}if(e instanceof fi){const{id:t,noOp:s,fromIndex:i,toIndex:n}=e;return{arrayMoveOperation:{id:t,noOp:s,fromIndex:i,toIndex:n}}}if(e instanceof li){const{id:t,noOp:s,index:i,value:n}=e;return{arrayReplaceOperation:{id:t,noOp:s,index:i,value:fn(n)}}}if(e instanceof mi){const{id:t,noOp:s,value:i}=e;return{arraySetOperation:{id:t,noOp:s,values:i.map(fn)}}}if(e instanceof gt){const{id:t,noOp:s,prop:i,value:n}=e;return{objectAddPropertyOperation:{id:t,noOp:s,key:i,value:fn(n)}}}if(e instanceof dt){const{id:t,noOp:s,prop:i,value:n}=e;return{objectSetPropertyOperation:{id:t,noOp:s,key:i,value:fn(n)}}}if(e instanceof Li){const{id:t,noOp:s,prop:i}=e;return{objectRemovePropertyOperation:{id:t,noOp:s,key:i}}}if(e instanceof Gi){const{id:t,noOp:s,value:i}=e;return{objectSetOperation:{id:t,noOp:s,values:h(i,fn)}}}if(e instanceof Yi){const{id:t,noOp:s,index:i,value:n}=e;return{stringInsertOperation:{id:t,noOp:s,index:i,value:n}}}if(e instanceof Qi){const{id:t,noOp:s,index:i,value:n}=e;return{stringRemoveOperation:{id:t,noOp:s,index:i,value:n}}}if(e instanceof Zi){const{id:t,noOp:s,value:i}=e;return{stringSetOperation:{id:t,noOp:s,value:i}}}if(e instanceof Bi){const{id:t,noOp:s,delta:i}=e;return{numberDeltaOperation:{id:t,noOp:s,delta:i}}}if(e instanceof Hi){const{id:t,noOp:s,value:i}=e;return{numberSetOperation:{id:t,noOp:s,value:i}}}if(e instanceof yi){const{id:t,noOp:s,value:i}=e;return{booleanSetOperation:{id:t,noOp:s,value:i}}}if(e instanceof sn){const{id:t,noOp:s,value:i}=e;return{dateSetOperation:{id:t,noOp:s,value:ee(i)}}}}function Sn(e){if(e.indices){return{referenceType:"index",values:Y(e.indices.values).map(B)}}if(e.ranges){return{referenceType:"range",values:Y(e.ranges.values).map(({startIndex:e,endIndex:t})=>({start:B(e),end:B(t)}))}}if(e.properties){return{referenceType:"property",values:Y(e.properties.values).map(z)}}if(e.elements){return{referenceType:"element",values:Y(e.elements.values).map(z)}}}function Cn(e,t){switch(e){case At.Types.INDEX:return{indices:{values:t}};case At.Types.PROPERTY:return{properties:{values:t}};case At.Types.RANGE:return{ranges:{values:t.map(e=>({startIndex:e.start,endIndex:e.end}))}};case At.Types.ELEMENT:const e=[];for(const s of t)e.push(s.id());return{elements:{values:e}};default:throw new Error("Invalid reference type")}}function xn(e){if(e instanceof me){return{type:"compound",ops:e.ops.map(e=>xn(e))}}return e instanceof Pe?{type:"array_insert",id:e.id,noOp:e.noOp,index:e.index,value:e.value}:e instanceof li?{type:"array_replace",id:e.id,noOp:e.noOp,index:e.index,value:e.value}:e instanceof pi?{type:"array_remove",id:e.id,noOp:e.noOp,index:e.index}:e instanceof fi?{type:"array_move",id:e.id,noOp:e.noOp,fromIndex:e.fromIndex,toIndex:e.toIndex}:e instanceof mi?{type:"array_set",id:e.id,noOp:e.noOp,value:e.value}:e instanceof gt?{type:"object_add_property",id:e.id,noOp:e.noOp,key:e.prop,value:e.value}:e instanceof dt?{type:"object_set_property",id:e.id,noOp:e.noOp,key:e.prop,value:e.value}:e instanceof Li?{type:"object_remove_property",id:e.id,noOp:e.noOp,key:e.prop}:e instanceof Gi?{type:"object_set",id:e.id,noOp:e.noOp,value:e.value}:e instanceof Yi?{type:"string_insert",id:e.id,noOp:e.noOp,index:e.index,value:e.value}:e instanceof Qi?{type:"string_remove",id:e.id,noOp:e.noOp,index:e.index,value:e.value}:e instanceof Zi?{type:"string_set",id:e.id,noOp:e.noOp,value:e.value}:e instanceof Bi?{type:"number_delta",id:e.id,noOp:e.noOp,value:e.delta}:e instanceof Hi?{type:"number_set",id:e.id,noOp:e.noOp,value:e.value}:e instanceof yi?{type:"boolean_set",id:e.id,noOp:e.noOp,value:e.value}:e instanceof sn?{type:"date_set",id:e.id,noOp:e.noOp,value:e.value}:void 0}function Dn(e){switch(e.type){case"array_insert":const t=e;return new Pe(t.id,t.noOp,t.index,t.value);case"array_remove":const s=e;return new pi(s.id,s.noOp,s.index);case"array_replace":const i=e;return new li(i.id,i.noOp,i.index,i.value);case"array_move":const n=e;return new fi(n.id,n.noOp,n.fromIndex,n.toIndex);case"array_set":const r=e;return new mi(r.id,r.noOp,r.value);case"object_add_property":const o=e;return new gt(o.id,o.noOp,o.key,o.value);case"object_set_property":const a=e;return new dt(a.id,a.noOp,a.key,a.value);case"object_remove_property":const c=e;return new Li(c.id,c.noOp,c.key);case"object_set":const h=e;return new Gi(h.id,h.noOp,h.value);case"string_insert":const u=e;return new Yi(u.id,u.noOp,u.index,u.value);case"string_remove":const d=e;return new Qi(d.id,d.noOp,d.index,d.value);case"string_set":const l=e;return new Zi(l.id,l.noOp,l.value);case"number_delta":const p=e;return new Bi(p.id,p.noOp,p.value);case"number_set":const f=e;return new Hi(f.id,f.noOp,f.value);case"boolean_set":const m=e;return new yi(m.id,m.noOp,m.value);case"date_set":const g=e;return new sn(g.id,g.noOp,g.value);case"compound":const v=e.ops.map(e=>Dn(e));return new me(v)}}class _n extends S{constructor(){super(),this.Ai=[],this.Ti=void 0,this.ji=void 0}static resolved(e){const t=new _n;return t.resolve(e),t}resolve(e){super.resolve(e),this.Ti=e,this.Ai.forEach(t=>t.resolve(e))}reject(e){super.reject(e),this.ji=e,this.Ai.forEach(t=>t.reject(e))}promise(){if(this.isPending()){const e=new C;return this.Ai.push(e),e.promise()}return this.isRejected()?Promise.reject(this.ji):Promise.resolve(this.Ti)}}const Pn=Object.assign(Object.assign({},hn),{MODIFIED:Ss.NAME,COMMITTED:Is.NAME,RESYNC_STARTED:vs.NAME,RESYNC_COMPLETED:ys.NAME,RESYNC_ERROR:ws.NAME,REMOTE_RESYNC_STARTED:Os.NAME,REMOTE_RESYNC_COMPLETED:Rs.NAME,OFFLINE:ms.NAME,ONLINE:fs.NAME,RECONNECTING:gs.NAME,COLLABORATOR_OPENED:Ms.NAME,COLLABORATOR_CLOSED:Es.NAME,REFERENCE:bs.NAME,PERMISSIONS_CHANGED:ls.NAME});class An extends R{constructor(e,t,s,i,n,r,o,a,c,h,u,d,l,p,f,m,g,y){super(),this.G=v.logger("models"),this.Ni=!1,this.Ui=e,this.Vt=i,this.qi=h,this.ki=u,this.Pi=d,this.Vi=l,this.Li=p,this.Ke=f,this.Gi=g,this.$i=c,this.ms=m,this.Fi=y,this.Ji=n,this.Hi=!1,this.Bi=null,this.Wi={deferred:new _n,closing:!1},this.Ss=new qi(this.session(),t,s),this.zi=new Map,this.Yi=[...r],this.Qi=[...o],this.Ki=new w.BehaviorSubject(this.collaborators());this.Tt=new hi(this,[At.Types.ELEMENT],e=>this.Zi(e),this.ms),this.Li.on(Jt.Events.COMMIT_STATE_CHANGED,e=>{this.Xi=e.committed;const t=this.Xi?new Is(this):new Ss(this);this.de(t)});const b={onShare:this.en.bind(this),onUnShare:this.tn.bind(this),onSet:this.sn.bind(this),onClear:this.in.bind(this)};this.Es={sendOperationCallback:e=>{const t=this.Li.processOutgoingOperation(e);this.Li.isBatchOperationInProgress()||this.nn(t)},referenceEventCallbacks:b},this.Is=new rn(this.Es,this,this.ms),this.rn=!0,this.Xi=!0,this.an(a),this.cn=this.Fi.isOfflineEnabled()}permissions(){return this.$i}permissionsManager(){return new bn(this.Pi,this.Ke)}session(){return this.Ke.session()}emitLocalEvents(e){return 0===arguments.length?this.Ni:void(this.Ni=e)}collaborators(){return this.Yi.map(e=>{const t=this.ms.getUserForSession(e);return new cn(t,e)})}resynchronizingCollaborators(){return this.Qi.map(e=>{const t=this.ms.getUserForSession(e);return new cn(t,e)})}collaboratorsAsObservable(){return this.Ki.asObservable()}collectionId(){return this.Vi}modelId(){return this.Pi}time(){return this.ki}minTime(){return this.qi}maxTime(){return this.time()}createdTime(){return this.qi}version(){return this.Li.contextVersion()}minVersion(){return 0}maxVersion(){return this.version()}isCommitted(){return this.Li.isCommitted()}root(){return this.Is.wrap(this.Ss.root())}elementAt(...e){return this.Is.wrap(this.Ss.valueAt(...e))}isOpen(){return this.rn}isLocal(){return this.Vt}close(){if(this.Wi.closing)return Promise.reject(new O(`The model '${this.Pi}' is already closing`));if(!this.rn)return Promise.reject(new O(`The model '${this.Pi}' has already been closed`));if(null!==this.Bi)return this.Ji=!0,Promise.resolve();{const e=new us(this,!0);return this.hn(!0,e),this.Wi.deferred.promise()}}isClosing(){return this.Wi.closing||this.un()}whenClosed(){return this.Wi.deferred.promise()}startBatch(){this.Li.startBatchOperation()}endBatch(){this.completeBatch()}completeBatch(){const e=this.Li.completeBatchOperation();this.nn(e)}batchSize(){return this.Li.batchSize()}cancelBatch(){return this.Li.cancelBatchOperation()}isBatchStarted(){return this.Li.isBatchOperationInProgress()}elementReference(e){const t=this.Tt.getLocalReference(e);if(void 0!==t){if(t.reference().type()!==At.Types.ELEMENT)throw new Error("A reference with this key already exists, but is not an observable reference");return t}{const t=this.session(),s=new si(this.Tt,e,this,t.user(),t.sessionId(),!0),i=new Oi(s,this.Es.referenceEventCallbacks);return this.Tt.addLocalReference(i),i}}reference(e,t){return this.Tt.get(e,t)}references(e){return this.Tt.getAll(e)}subscribeOffline(){return this.Fi.subscribe([this.Pi])}unsubscribeOffline(){return this.Fi.unsubscribe([this.Pi])}isSubscribedOffline(){return this.Fi.isModelStoredOffline(this.Pi)}dn(){return this.Ui}hn(e,t){if(this.Wi.closing)throw new O(`The model '${this.Pi}' is already closing.`,"already_closing");if(this.ln("Initiating close"),this.Wi.closing=!0,this.Wi.event=t,this.Ke.isOnline()&&e){const e={closeRealTimeModelRequest:{resourceId:this.Ui}};this.Ke.request(e).then(()=>{this.pn()}).catch(e=>{this.G.error(`Unexpected error closing a model: ${this.Pi}`,e),this.Wi.deferred.reject(e)})}else this.pn()}Ei(){return this.Ss.valueIdPrefix()}pn(){!this.Wi.closing||!this.Li.isCommitted()&&this.Ke.isOnline()||this.mn()}gn(){if(this.Wi.closing)throw new O("Can't open after resynchronization if the mode is closing: "+this.Pi);this.Ji=!1}vn(){return this.Ji}yn(){return{data:this.Ss.root().dataValue(),lastSequenceNumber:this.Li.lastSequenceNumber(),uncommittedOperations:[...this.Li.getInFlightOperations()]}}wn(e,t,s){const i=t.map(e=>{const t=Dn(e.operation);return new on(e.sessionId,e.version,e.timestamp,t)}).sort((e,t)=>e.version-t.version),n=s.map(e=>{const t=Dn(e.operation);return new Ft(e.sessionId,e.sequenceNumber,e.contextVersion,e.timestamp,t)}).sort((e,t)=>e.contextVersion===t.contextVersion?e.seqNo-t.seqNo:e.contextVersion-t.contextVersion);let r=this.Li.contextVersion(),o=this.Li.lastSequenceNumber(),a=[];for(;n.length>0&&n[0].seqNo<=o;)n.shift();const c=()=>i.length>0&&(0===n.length||i[0].version<=n[0].contextVersion),h=()=>n.length>0&&n[0].contextVersion===r;for(;c()||h();){for(;c();){const e=i.shift();this.bn(e.operation,e.clientId,e.version,e.timestamp),r++}for(;h();){const e=n.shift();this.bn(e.operation,this.Ke.session().sessionId(),e.contextVersion,e.timestamp),o=e.seqNo,a.push(e)}}if(i.length>0||n.length>0)throw new Error(`Unable to apply all events while rehydrating model "${this.Pi}" from offline state.`);if(r!==e)throw new Error(`Did not arrive at the proper version (${e}) when rehydrating model: ${r}`);this.Li.setState(r,o,a)}Rs(e){return this.Is.wrap(this.Ss.Rs(e))}On(e){const{forceCloseRealTimeModel:t,remoteOperation:s,referenceShared:i,referenceSet:n,referenceCleared:r,referenceUnshared:o,operationAck:a,remoteClientOpenedModel:c,remoteClientClosedModel:h,modelPermissionsChanged:u,remoteClientResyncStarted:d,remoteClientResyncCompleted:l,modelResyncServerComplete:p}=e.message;if(t)this.Rn(t);else if(s)this.Mn(s),this.En();else if(a)this.In(a),this.En();else if(i||n||r||o){const t=function(e){if(e.referenceShared){const{sessionId:t,key:s,references:i,valueId:n,resourceId:r}=e.referenceShared,{referenceType:o,values:a}=Sn(i);return new ri(t,r,Z(n),s,o,a)}if(e.referenceSet){const{sessionId:t,key:s,references:i,valueId:n,resourceId:r}=e.referenceSet,{values:o}=Sn(i);return new ai(t,r,Z(n),s,o)}if(e.referenceCleared){const{sessionId:t,key:s,valueId:i,resourceId:n}=e.referenceCleared;return new ci(t,n,Z(i),s)}if(e.referenceUnshared){const{sessionId:t,key:s,valueId:i,resourceId:n}=e.referenceUnshared;return new oi(t,n,Z(i),s)}}(e.message);this._s(t)}else if(c)this.Sn(z(c.sessionId));else if(h)this.Cn(z(h.sessionId));else if(u)this.xn(u);else if(d)this.Dn(d);else if(l)this._n(l);else{if(!p)throw new Error("Unexpected message"+JSON.stringify(e.message));this.Pn(p)}}An(){return this.Hi}Tn(){this.ln("Offline"),this.Hi=!0,this.de(new ms(this)),this.Yi.forEach(e=>this.Cn(e)),this.Yi=[],this.Bi=null,this.Ui=null,this.Wi.closing&&this.mn()}jn(){this.Hi=!1,this.Bi={bufferedOperations:[],resyncCompleted:!1,upToDate:!1},this.Vt?this.Fi.getModelMetaData(this.Pi).then(e=>e.deleted?this.Gi.remove(this.Pi).catch(e=>{console.log(e)}).then(()=>this.Fi.modelDeleted(this.Pi)):Promise.resolve()).then(()=>this.Fi.getModelCreationData(this.Pi)).then(e=>{this.ln("Creating offline model at the server");const t={id:e.modelId,collection:e.collection,overrideCollectionWorldPermissions:e.overrideCollectionWorldPermissions,worldPermissions:e.worldPermissions,userPermissions:e.userPermissions};return this.Gi.Nn(t,e.initialData)}).then(()=>(this.Vt=!1,this.Fi.modelCreated(this.Pi))).then(()=>{this.Un()}).catch(e=>{this.qn(e.message),this.G.error("Error synchronizing offline model on reconnect.",e)}):this.Un()}kn(){this.cn=!1;const e=new us(this,!0,"The model was locally deleted");this.hn(!0,e);const t=`The model '${this.Pi}' was locally deleted while offline.`,s=new ds(this,!0,t);this.de(s)}Un(){this.ln("Requesting model resynchronization"),this.de(new gs(this));const e={modelResyncRequest:{modelId:this.Pi,contextVersion:this.Li.contextVersion()}};this.Ke.request(e).then(e=>{this.ln("Starting model resynchronization"),this.de(new vs(this));const{modelResyncResponse:t}=e;this.$i=vn(t.permissions),this.Bi.reconnectVersion=B(t.currentVersion),this.Ui=z(t.resourceId),this.Gi.Vn(this.Pi,this.Ui),this.Ln()}).catch(e=>this.qn(e.message))}qn(e){this.de(new ws(this,e)),this.Gi.qn(this.Pi,e,this)}xn(e){const t=this.$i;this.$i=vn(e.permissions);const s=[];this.$i.read!==t.read&&s.push("read"),this.$i.write!==t.write&&s.push("write"),this.$i.remove!==t.remove&&s.push("remove"),this.$i.manage!==t.manage&&s.push("manage");const i=new ls(this,this.$i,s);this.de(i)}Dn(e){const t=z(e.sessionId);this.Qi.push(t);const s=this.ms.getUserForSession(t),i=new Os(this,t,s);this.de(i)}_n(e){const t=z(e.sessionId);this.Qi.push(t);const s=this.Qi.indexOf(t);s>=0&&this.Qi.splice(s,1);const i=this.ms.getUserForSession(t),n=new Rs(this,t,i);this.de(n)}Sn(e){this.Yi.push(e),this.zi.set(e,[]);const t=this.ms.getUserForSession(e),s=new Ms(this,new cn(t,e));this.de(s),this.Ki.next(this.collaborators())}Cn(e){this.Yi=this.Yi.filter(t=>t!==e);const t=this.zi.get(e);this.zi.delete(e),t.forEach(e=>{e.Lt()});const s=this.ms.getUserForSession(e),i=new Es(this,new cn(s,e));this.de(i),this.Ki.next(this.collaborators())}_s(e){if(null===e.valueId)this.Gn(e);else{const t=this.Rs(e.valueId);if(!t)return;if(e instanceof ri){if(e.values){let t={type:e.referenceType,valueId:e.valueId,values:e.values};t=this.Li.processRemoteReferenceSet(t),e=new ri(e.sessionId,e.resourceId,e.valueId,e.key,e.referenceType,t.values)}}else if(e instanceof ai){const s=t.reference(e.sessionId,e.key);if(!s)return void this.G.warn("received an update for a non-existent reference.");let i={type:s.type(),valueId:e.valueId,values:e.values};i=this.Li.processRemoteReferenceSet(i),e=new ai(e.sessionId,e.resourceId,e.valueId,e.key,i.values)}if(e instanceof oi){const s=t.reference(e.sessionId,e.key),i=this.zi.get(e.sessionId).indexOf(s);this.zi.get(e.sessionId).splice(i,1)}if(t._s(e),e instanceof ri){const s=t.reference(e.sessionId,e.key);this.zi.get(e.sessionId).push(s)}}}Rn(e){if(this.isClosing())return;const t=new us(this,!1,e.reason);if(this.hn(!1,t),e.reasonCode===ki.DELETED){const t=new ds(this,!1,e.reason);this.de(t)}else this.G.error(`The model with id '${this.Pi}' was forcefully closed by the server: ${e.reason}`)}mn(){const{deferred:e,event:t}=this.Wi;this.Gi.mn(this),this.Fi.isOfflineEnabled()&&this.Fi.modelClosed(this),this.Ss.root().Vs(!1),this.rn=!1,this.Ke=null,this.Ui=null,this.Wi.closing=!1,e.resolve(),t&&this.de(t)}In(e){const t=B(e.version),s=B(e.sequenceNumber),i=this.Li.processAcknowledgement(t,s);if(this.ki=X(e.timestamp),this.cn){const e=xn(i.operation),n={modelId:this.Pi,sessionId:this.Ke.session().sessionId(),version:t,timestamp:this.ki,operation:e};this.Fi.processOperationAck(this.modelId(),s,n).catch(e=>{this.G.error(e)})}this.pn()}Mn(e){if(null===this.Bi||this.Bi.upToDate)this.$n(e);else if(B(e.contextVersion)>this.Bi.reconnectVersion)this.Bi.bufferedOperations.push(e);else if(this.Li.hasInflightOperation()&&this.Li.firstInFlightOperation().sessionId===e.sessionId){const t={resourceId:e.resourceId,version:e.contextVersion,timestamp:e.timestamp};this.In(t),this.Ln()}else this.$n(e),this.Ln()}$n(e){const t=new on(z(e.sessionId),B(e.contextVersion),X(e.timestamp),On(e.operation));this.Fn(t)}Fn(e){this.Li.processRemoteOperation(e);const t=this.Li.getNextIncomingOperation(),s=t.operation,i=t.clientId,n=t.version,r=t.timestamp;if(this.ki=new Date(r),this.bn(s,i,n,r),this.cn){const e=this.Li.getInFlightOperations();this.Fi.processServerOperationEvent(this.Pi,t,e).catch(e=>this.G.error(e))}}bn(e,t,s,i){const n=this.ms.getUserForSession(t);if(e.type===fe.COMPOUND){e.ops.forEach(e=>{this.Jn(e,n,t,s,i)})}else{const r=e;this.Jn(r,n,t,s,i)}}Jn(e,t,s,i,n){if(!e.noOp){const r=new an(s,t,i,n,e);this.Hn(r)}}Ln(){if(null!==this.Bi&&!this.Bi.upToDate&&this.Bi.reconnectVersion===this.Li.contextVersion()){this.Bi.upToDate=!0,this.Bi.bufferedOperations.forEach(e=>{this.$n(e)}),this.ln("All server operations applied during resynchronization"),this.Li.getInFlightOperations().forEach(e=>this.Ps(e)),this.ln("All local operations resent during resynchronization"),this.Bn()}}Bn(){this.ln("Requesting resynchronization completion"),this.Bi.resyncCompleted=!0,this.Bi.openAfterComplete=!this.Ji;const e={modelResyncClientComplete:{resourceId:this.Ui,open:this.Bi.openAfterComplete}};this.Ke.send(e)}Pn(e){this.ln("Resynchronization completed");const t=this.Bi.openAfterComplete,s=t&&!this.Ji;if(this.Bi=null,this.de(new ys(this)),this.Gi.Wn(this.Pi),s){this.ln("Opening after reconnect"),Y(e.connectedClients).forEach(e=>this.Sn(e)),this.an(Y(e.references)),this.Tt.reshare(),this.ln("Online"),this.de(new fs(this))}else this.hn(t)}un(){return null!==this.Bi&&this.Bi.resyncCompleted&&!this.Bi.openAfterComplete}ln(e){this.G.debug(`Model("${this.Pi}"): ${e}`)}Hn(e){this.Ss.handleModelOperationEvent(e)}nn(e){this.cn&&this.Fi.processLocalOperation(this.Pi,e).catch(e=>this.G.error(`Error storing local operation: ${this.Pi}`,e)),this.Ps(e)}Ps(e){if(this.zn()){const t={operationSubmission:{resourceId:this.Ui,sequenceNumber:e.seqNo,contextVersion:e.contextVersion,operation:Mn(e.operation)}};this.Ke.send(t)}}En(){const e=new ps(this,this.Li.contextVersion());this.de(e)}Gn(e){this.Tt.handleRemoteReferenceEvent(e)}Zi(e){this.zi.get(e.sessionId()).push(e),this.de(new bs(e,this))}an(e){this.zi.clear(),this.Yi.forEach(e=>{this.zi.set(e,[])}),e.forEach(e=>{let t;const s=Z(e.valueId);null!==s&&(t=this.Is.wrap(this.Ss.Rs(s)));const{referenceType:i,values:n}=Sn(e.reference),r=new ri(e.sessionId,this.Ui,s,e.key,i,n);if(void 0!==t){t._s(r);const s=t.reference(e.sessionId,e.key);this.zi.get(e.sessionId).push(s)}else this.Gn(r)})}en(e){if(this.zn()){const t=e.reference().source(),s=t instanceof di?t.id():null;let i={type:e.reference().type(),valueId:s,values:e.reference().values()};void 0!==s&&(i=this.Li.processOutgoingSetReference(i));const n={shareReference:{resourceId:this.Ui,key:e.reference().key(),valueId:K(s),references:Cn(e.reference().type(),i.values),version:this.Li.contextVersion()}};this.Ke.send(n)}}tn(e){if(this.zn()){const t=e.reference().source(),s=t instanceof di?t.id():null,i={unshareReference:{resourceId:this.Ui,valueId:K(s),key:e.reference().key()}};this.Ke.send(i)}}sn(e){if(this.zn()){const t=e.reference().source(),s=t instanceof di?t.id():null;let i={type:e.reference().type(),valueId:s,values:e.reference().values()};if(void 0!==s&&(i=this.Li.processOutgoingSetReference(i)),i){const t={setReference:{resourceId:this.Ui,key:e.reference().key(),valueId:K(i.valueId),references:Cn(e.reference().type(),i.values),version:this.Li.contextVersion()}};this.Ke.send(t)}}}in(e){if(this.zn()){const t=e.reference().source(),s=t instanceof di?t.id():null,i={clearReference:{resourceId:this.Ui,key:e.reference().key(),valueId:K(s)}};this.Ke.send(i)}}zn(){return this.Ke.isOnline()&&!this.Hi&&(null===this.Bi||this.Bi.upToDate)}}An.Events=Pn,Object.freeze(An.Events);class Tn extends R{constructor(e,t,s){super(),this.Ms=e,this.Is=t,this.Ss=s,this.Ms.events().subscribe(e=>{const t=Zs.convertEvent(e,this.Is);this.de(t)})}id(){return this.Ms.id()}type(){return this.Ms.type()}path(){return this.Ms.path()}relativePath(){const e=this.Ms.path().slice(0);return e.length>0?e.pop():null}parent(){const e=this.Ms.path().slice(0);return e.pop(),this.Ss.elementAt(e)}isAttached(){return!this.Ms.isDetached()}isDetached(){return this.Ms.isDetached()}value(){return this.Ms.data()}toJSON(){return this.Ms.toJson()}model(){return this.Ss}}Tn.Events=ui;class jn extends Tn{constructor(e,t,s){super(e,t,s)}get(e){return this.Is.wrap(this.Ms.get(e))}length(){return this.Ms.length()}forEach(e){this.Ms.forEach((t,s)=>{e(this.Is.wrap(t),s)})}elementAt(...e){return this.Is.wrap(this.Ms.valueAt(...e))}}jn.Events=gi;class Nn extends Tn{constructor(e,t,s){super(e,t,s)}}Nn.Events=ui;class Un extends Tn{constructor(e,t,s){super(e,t,s)}get(e){return this.Is.wrap(this.Ms.get(e))}keys(){return this.Ms.keys()}hasKey(e){return this.Ms.hasKey(e)}forEach(e){this.Ms.forEach((t,s)=>{e(this.Is.wrap(t),s)})}elementAt(...e){return this.Is.wrap(this.Ms.valueAt(...e))}}Un.Events=$i;class qn extends Tn{constructor(e,t,s){super(e,t,s)}}qn.Events=ui;class kn extends Tn{constructor(e,t,s){super(e,t,s)}}kn.Events=Wi;class Vn extends Tn{constructor(e,t,s){super(e,t,s)}length(){return this.Ms.length()}}Vn.Events=Xi;class Ln extends Tn{constructor(e,t,s){super(e,t,s)}}Ln.Events=ui;class Gn extends Tn{constructor(e,t,s){super(e,t,s)}}Gn.Events=ui;class $n extends Vi{constructor(e){super(),this.Ss=e}xi(e){switch(e.type()){case Ei.ARRAY:return new jn(e,this,this.Ss);case Ei.OBJECT:return new Un(e,this,this.Ss);case Ei.BOOLEAN:return new Nn(e,this,this.Ss);case Ei.NULL:return new qn(e,this,this.Ss);case Ei.NUMBER:return new kn(e,this,this.Ss);case Ei.STRING:return new Vn(e,this,this.Ss);case Ei.UNDEFINED:return new Ln(e,this,this.Ss);case Ei.DATE:return new Gn(e,this,this.Ss);default:return null}}}class Fn{constructor(e,t,s,i,n,r){this.modelId=e,this.version=t,this.timestamp=s,this.user=i,this.sessionId=n,this.operation=r,Object.freeze(this)}}class Jn{constructor(e){this.type=e}}class Hn extends Jn{constructor(e){super(fe.COMPOUND),this.ops=e,Object.freeze(this)}inverse(){return new Hn(this.ops.map(e=>e.inverse()))}}class Bn extends Jn{constructor(e,t,s){super(e),this.id=t,this.noOp=s}}class Wn extends Bn{constructor(e,t,s,i){super(fe.ARRAY_REMOVE,e,t),this.index=s,this.oldValue=i,Object.freeze(this)}inverse(){return new zn(this.id,this.noOp,this.index,this.oldValue)}}class zn extends Bn{constructor(e,t,s,i){super(fe.ARRAY_INSERT,e,t),this.index=s,this.value=i,Object.freeze(this)}inverse(){return new Wn(this.id,this.noOp,this.index,this.value)}}class Yn extends Bn{constructor(e,t,s,i){super(fe.ARRAY_REORDER,e,t),this.fromIndex=s,this.toIndex=i,Object.freeze(this)}inverse(){return new Yn(this.id,this.noOp,this.toIndex,this.fromIndex)}}class Qn extends Bn{constructor(e,t,s,i,n){super(fe.ARRAY_SET,e,t),this.index=s,this.value=i,this.oldValue=n,Object.freeze(this)}inverse(){return new Qn(this.id,this.noOp,this.index,this.oldValue,this.value)}}class Kn extends Bn{constructor(e,t,s,i){super(fe.ARRAY_VALUE,e,t),this.value=s,this.oldValue=i,Object.freeze(this)}inverse(){return new Kn(this.id,this.noOp,this.oldValue,this.value)}}class Zn extends Bn{constructor(e,t,s,i){super(fe.OBJECT_REMOVE,e,t),this.prop=s,this.oldValue=i,Object.freeze(this)}inverse(){return new Xn(this.id,this.noOp,this.prop,this.oldValue)}}class Xn extends Bn{constructor(e,t,s,i){super(fe.OBJECT_ADD,e,t),this.prop=s,this.value=i,Object.freeze(this)}inverse(){return new Zn(this.id,this.noOp,this.prop,this.value)}}class er extends Bn{constructor(e,t,s,i,n){super(fe.OBJECT_SET,e,t),this.prop=s,this.value=i,this.oldValue=n,Object.freeze(this)}inverse(){return new er(this.id,this.noOp,this.prop,this.oldValue,this.value)}}class tr extends Bn{constructor(e,t,s,i){super(fe.OBJECT_VALUE,e,t),this.value=s,this.oldValue=i,Object.freeze(this)}inverse(){return new tr(this.id,this.noOp,this.oldValue,this.value)}}class sr extends Bn{constructor(e,t,s,i){super(fe.STRING_REMOVE,e,t),this.index=s,this.value=i,Object.freeze(this)}inverse(){return new ir(this.id,this.noOp,this.index,this.value)}}class ir extends Bn{constructor(e,t,s,i){super(fe.STRING_INSERT,e,t),this.index=s,this.value=i,Object.freeze(this)}inverse(){return new sr(this.id,this.noOp,this.index,this.value)}}class nr extends Bn{constructor(e,t,s,i){super(fe.STRING_VALUE,e,t),this.value=s,this.oldValue=i,Object.freeze(this)}inverse(){return new nr(this.id,this.noOp,this.oldValue,this.value)}}class rr extends Bn{constructor(e,t,s){super(fe.NUMBER_DELTA,e,t),this.delta=s,Object.freeze(this)}inverse(){return new rr(this.id,this.noOp,-this.delta)}}class or extends Bn{constructor(e,t,s,i){super(fe.NUMBER_VALUE,e,t),this.value=s,this.oldValue=i,Object.freeze(this)}inverse(){return new or(this.id,this.noOp,this.oldValue,this.value)}}class ar extends Bn{constructor(e,t,s,i){super(fe.BOOLEAN_VALUE,e,t),this.value=s,this.oldValue=i,Object.freeze(this)}inverse(){return new ar(this.id,this.noOp,this.oldValue,this.value)}}class cr extends Bn{constructor(e,t,s,i){super(fe.DATE_VALUE,e,t),this.value=s,this.oldValue=i,Object.freeze(this)}inverse(){return new cr(this.id,this.noOp,this.oldValue,this.value)}}function hr(e,t){let s;if(e.operation.compoundOperation)s=function(e){const t=Y(e.operations).map(ur);return new Hn(t)}(e.operation.compoundOperation);else{if(!e.operation.discreteOperation)throw new O("Invalid model operation: "+JSON.stringify(e));s=ur(e.operation.discreteOperation)}return new Fn(e.modelId,B(e.version),X(e.timestamp),t.getUserForSession(e.sessionId),e.sessionId,s)}function ur(e){if(e.arrayInsertOperation){const{id:t,noOp:s,index:i,value:n}=e.arrayInsertOperation;return new zn(t,W(s),B(i),pn(n))}if(e.arrayRemoveOperation){const{id:t,noOp:s,index:i,oldValue:n}=e.arrayRemoveOperation;return new Wn(t,W(s),B(i),pn(n))}if(e.arrayMoveOperation){const{id:t,noOp:s,fromIndex:i,toIndex:n}=e.arrayMoveOperation;return new Yn(t,W(s),B(i),B(n))}if(e.arrayReplaceOperation){const{id:t,noOp:s,index:i,value:n,oldValue:r}=e.arrayReplaceOperation;return new Qn(t,W(s),B(i),pn(n),pn(r))}if(e.arraySetOperation){const{id:t,noOp:s,values:i,oldValues:n}=e.arraySetOperation;return new Kn(t,W(s),Y(i).map(pn),Y(n).map(pn))}if(e.objectAddPropertyOperation){const{id:t,noOp:s,key:i,value:n}=e.objectAddPropertyOperation;return new Xn(t,W(s),z(i),pn(n))}if(e.objectSetPropertyOperation){const{id:t,noOp:s,key:i,value:n,oldValue:r}=e.objectSetPropertyOperation;return new er(t,W(s),z(i),pn(n),pn(r))}if(e.objectRemovePropertyOperation){const{id:t,noOp:s,key:i,oldValue:n}=e.objectSetPropertyOperation;return new Zn(t,W(s),z(i),pn(n))}if(e.objectSetOperation){const{id:t,noOp:s,values:i,oldValues:n}=e.objectSetOperation;return new tr(t,W(s),h(Q(i),pn),h(Q(n),pn))}if(e.stringInsertOperation){const{id:t,noOp:s,index:i,value:n}=e.stringInsertOperation;return new ir(t,W(s),B(i),z(n))}if(e.stringRemoveOperation){const{id:t,noOp:s,index:i,oldValue:n}=e.stringRemoveOperation;return new sr(t,W(s),B(i),z(n))}if(e.stringSetOperation){const{id:t,noOp:s,value:i,oldValue:n}=e.stringSetOperation;return new nr(t,W(s),z(i),z(n))}if(e.numberDeltaOperation){const{id:t,noOp:s,delta:i}=e.numberDeltaOperation;return new rr(t,W(s),B(i))}if(e.numberSetOperation){const{id:t,noOp:s,value:i,oldValue:n}=e.numberSetOperation;return new or(t,W(s),B(i),B(n))}if(e.booleanSetOperation){const{id:t,noOp:s,value:i,oldValue:n}=e.booleanSetOperation;return new ar(t,W(s),W(i),W(n))}if(e.dateSetOperation){const{id:t,noOp:s,value:i,oldValue:n}=e.dateSetOperation;return new cr(t,W(s),X(i),X(n))}}const dr=Object.assign(Object.assign({},hn),{TARGET_VERSION_CHANGED:"target_changed",TRANSITION_START:"transition_start",TRANSITION_END:"transition_end"});Object.freeze(dr);class lr{constructor(e,t,s,i,n,r,o,a,c){this.Mt=a,this.Ke=o,this.ms=c,this.Pi=n,this.Vi=r,this.Ss=new qi(this.session(),null,e),this.Is=new $n(this),this.Yn=t,this.Qn=t,this.Kn=t,this.Zn=s,this.Xn=s,this.qi=i,this.er=[]}session(){return this.Mt}collectionId(){return this.Vi}modelId(){return this.Pi}time(){return this.Zn}minTime(){return this.createdTime()}maxTime(){return this.Xn}createdTime(){return this.qi}version(){return this.Yn}minVersion(){return 0}maxVersion(){return this.Kn}targetVersion(){return this.Qn}isTransitioning(){return this.Qn===this.Yn}root(){return this.Is.wrap(this.Ss.root())}elementAt(...e){return this.Is.wrap(this.Ss.valueAt(...e))}playTo(e){if(e<0)throw new Error(`Version must be >= 0: ${e}`);if(e>this.Kn)throw new Error(`Version must be <= maxVersion: ${e}`);let t,s,i=null;if(e===this.Qn)return Promise.resolve();e>this.Qn?(t=this.Qn+1,s=e,i=!0):(t=e+1,s=this.Qn,i=!1),this.Qn=e;const n={historicalOperationsRequest:{modelId:this.Pi,first:t,last:s}},r={forward:i,completed:!1,operations:null};return this.er.push(r),this.Ke.request(n).then(e=>{const{historicalOperationsResponse:t}=e;r.completed=!0,r.operations=Y(t.operations).map(e=>hr(e,this.ms)),this.tr()})}forward(e=1){if(e<1)throw new Error("delta must be > 0");if(this.Qn+e>this.Kn)throw new Error(`Cannot move forward by ${e}, because that would exceed the model's maxVersion.`);const t=this.Qn+e;return this.playTo(t)}backward(e=1){if(e<1)throw new Error("delta must be > 0");if(this.Qn-e<0)throw new Error(`Cannot move backawrd by ${e}, because that would move beyond version 0.`);const t=this.Qn-e;return this.playTo(t)}tr(){if(0===this.er.length)throw new Error("There are no operation requests to process");for(;this.er.length>0&&this.er[0].completed;)this.sr(this.er[0].operations,this.er[0].forward),this.er.shift()}sr(e,t){t?e.forEach(e=>{if(e.operation.type===fe.COMPOUND){e.operation.ops.forEach(t=>{this.ir(e,t,!1)})}else this.ir(e,e.operation,!1)}):e.reverse().forEach(e=>{if(e.operation.type===fe.COMPOUND){e.operation.ops.reverse().forEach(t=>{this.ir(e,t,!0)})}else this.ir(e,e.operation,!0)})}ir(e,t,s){if(!t.noOp){const i=s?t.inverse():t;this.Ss.handleModelOperationEvent(new an(e.sessionId,e.user,e.version,e.timestamp,i))}this.Yn=s?e.version-1:e.version,this.Zn=new Date(e.timestamp)}}lr.Events=dr;class pr{constructor(e){this.domain=e,this.name=pr.NAME,Object.freeze(this)}}pr.NAME="connected";class fr{constructor(e){this.domain=e,this.name=fr.NAME,Object.freeze(this)}}fr.NAME="connection_failed";class mr{constructor(e,t){this.domain=e,this.delay=t,this.name=mr.NAME,Object.freeze(this)}}mr.NAME="connection_scheduled";class gr{constructor(e){this.domain=e,this.name=gr.NAME,Object.freeze(this)}}gr.NAME="connecting";class vr{constructor(e,t){this.domain=e,this.method=t,this.name=vr.NAME,Object.freeze(this)}}vr.NAME="authenticating";class yr{constructor(e,t){this.domain=e,this.method=t,this.name=yr.NAME,Object.freeze(this)}}yr.NAME="authenticated";class wr{constructor(e,t){this.domain=e,this.method=t,this.name=wr.NAME,Object.freeze(this)}}wr.NAME="authentication_failed";class br{constructor(e){this.domain=e,this.name=br.NAME,Object.freeze(this)}}br.NAME="disconnected";class Or{constructor(e){this.domain=e,this.name=Or.NAME,Object.freeze(this)}}Or.NAME="interrupted";class Rr{constructor(e,t){this.domain=e,this.error=t,this.name=Rr.NAME,Object.freeze(this)}}Rr.NAME="error";var Mr=function(e,t,s,i){return new(s||(s=Promise))((function(n,r){function o(e){try{c(i.next(e))}catch(e){r(e)}}function a(e){try{c(i.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(o,a)}c((i=i.apply(e,t||[])).next())}))};const Er={OFFLINE_MODEL_STATUS_CHANGED:"offline_model_status_changed",OFFLINE_MODEL_UPDATED:"offline_model_updated",OFFLINE_MODEL_DOWNLOAD_PENDING:"offline_model_download_pending",OFFLINE_MODEL_DOWNLOAD_COMPLETED:"offline_model_download_completed",OFFLINE_MODEL_SYNC_STARTED:"offline_model_sync_started",OFFLINE_MODEL_SYNC_COMPLETED:"offline_model_sync_completed",OFFLINE_MODEL_SYNC_ABORTED:"offline_model_sync_aborted",OFFLINE_MODEL_DELETED:"offline_model_deleted",OFFLINE_MODEL_PERMISSIONS_REVOKED:"offline_model_permissions_revoked",OFFLINE_MODEL_SYNC_ERROR:"offline_model_sync_error"};Object.freeze(Er);class Ir extends R{constructor(e,t,s){super(),this.nr=new Map,this.rr=new Map,this.or=new Map,this.ar=new Map,this.Tn=()=>{this.rr.forEach(e=>{e.Tn(),this.ar.has(e.modelId())&&this.ar.delete(e.modelId())}),this.ar.forEach(e=>{e.resyncModel&&(e.resyncModel.Tn(),e.resyncModel.hn(!1))}),this.ar.clear(),this.cr.length=0,null!==this.hr&&(this.hr.resolve(),this.hr=null),null!==this.ur&&(this.de(new Ps("Convergence went offline during the sync","offline")),this.ur.resolve(),this.ur=null),this.or.clear(),this.dr()},this.jn=()=>{this.rr.forEach(e=>{this.lr(e)}),0!==this.ar.size&&(this.ur=new C),this.pr.isOfflineEnabled()&&(this.hr=new _n,this.pr.ready().then(()=>this.mr()).catch(e=>this.G.error("Error resynchronizing models after reconnect",e)))},this.Ke=e,this.ms=t,this.Ke.messages().subscribe(e=>this.On(e)),this.gr=0,this.vr=new Map,this.Ke.on(de.Events.INTERRUPTED,this.Tn),this.Ke.on(de.Events.DISCONNECTED,this.Tn),this.Ke.on(de.Events.AUTHENTICATED,this.jn),this.cr=[],this.ur=null,this.hr=null,this.pr=s,this.ue(s.events()),this.yr=new ue(32,ue.AlphaNumeric),this.G=v.logger("models")}session(){return this.Ke.session()}isResyncing(){return null!==this.ur}query(e){l.assertNonEmptyString(e,"query");const t={modelsQueryRequest:{query:e}};return this.Ke.request(t).then(e=>{const{modelsQueryResponse:t}=e,s=Y(t.models).map(yn),i=B(t.offset),n=B(t.totalResults);return new I(s,i,n)})}isOpen(e){return l.assertNonEmptyString(e,"id"),this.rr.has(e)}isOpening(e){return l.assertNonEmptyString(e,"id"),this.nr.has(e)}open(e){return l.assertNonEmptyString(e,"id"),this.wr(e)}openAutoCreate(e){if(l.isNotSet(e))throw new O("'options' is a required parameter");if(""===e.id)throw new O("'options.id' can not be an empty string");return l.nonEmptyString(e.collection)?this.wr(void 0,e):Promise.reject(new Error("options.collection must be a non-null, non empty string."))}create(e){if(l.isNotSet(e))throw new O("'options' is a required parameter");return l.nonEmptyString(e.collection)?this.br(e):Promise.reject(new Error("options.collection must be a non-null, non empty string."))}remove(e){return Mr(this,void 0,void 0,(function*(){if(l.assertNonEmptyString(e,"id"),this.rr.get(e)){const t=this.rr.get(e);t.kn(),yield t.whenClosed()}if(null!==this.hr&&(yield this.hr.promise()),this.ar.has(e)){const t=this.ar.get(e);if(yield t.ready,"resync"===t.action){const e=t.resyncModel;e.kn(),yield e.whenClosed()}}if(this.pr.isOfflineEnabled()&&(yield this.pr.getModelMetaData(e).then(t=>{if(t)return this.pr.markModelForDeletion(e)}).catch(e=>{this.G.error("Could not mark model for deletion",e)})),this.Ke.isOnline()||this.pr.isOfflineEnabled())return this.Or(e);throw new O("Can not delete a model while not connected and without offline support enabled.")}))}history(e){l.assertNonEmptyString(e,"id");const t={historicalDataRequest:{modelId:e}};return this.Ke.request(t).then(t=>{const{historicalDataResponse:s}=t;return new lr(gn(s.data),B(s.version),X(s.modifiedTime),X(s.createdTime),e,s.collectionId,this.Ke,this.session(),this.ms)})}permissions(e){return l.assertNonEmptyString(e,"id"),new bn(e,this.Ke)}subscribeOffline(e){const t=o.isArray(e)?e:[e];return this.pr.subscribe(t)}unsubscribeOffline(e){const t=o.isArray(e)?e:[e];return this.pr.unsubscribe(t)}setOfflineSubscription(e){return this.pr.setSubscriptions(e)}getOfflineSubscriptions(){return this.pr.ready().then(()=>this.pr.getSubscribedModelIds())}getOfflineModelMetaData(){return this.pr.ready().then(()=>this.pr.getAllModelMetaData())}Nn(e,t){return Mr(this,void 0,void 0,(function*(){const s=e.collection;if(this.Ke.isOnline()){const i=wn(e.userPermissions),n=t||this.Rr(e),r={createRealTimeModelRequest:{collectionId:s,modelId:K(e.id),data:mn(n),overrideWorldPermissions:e.overrideCollectionWorldPermissions,worldPermissions:e.worldPermissions,userPermissions:i}};return this.Ke.request(r).then(e=>{const{createRealTimeModelResponse:t}=e;return t.modelId})}if(this.pr.isOfflineEnabled()){const s=e.id||this.yr.nextString(),i=t||this.Rr(e),n={modelId:s,collection:e.collection,initialData:i,overrideCollectionWorldPermissions:e.overrideCollectionWorldPermissions,worldPermissions:e.worldPermissions,userPermissions:e.userPermissions};if(yield this.pr.createOfflineModel(n),this.Ke.isOnline()){const e=this.ar.size>0||this.cr.length>0;this.Mr(s,"resync"),e||this.dr()}return s}throw new O("Can not create a model while not connected and without offline support enabled.")}))}mn(e){const t=e.modelId();this.G.debug("Model closed: "+e.modelId()),this.rr.has(t)&&this.rr.delete(t);const s=e.dn();null!==s&&this.or.delete(s)}Vn(e,t){this.Er(e,t)}Wn(e){this.G.debug(`Resync completed for model: "${e}"`),this.ar.delete(e),this.dr()}qn(e,t,s){this.G.debug(`Resync error for model: "${e}"... ${t}`);const i=new As(e,t,s);this.de(i),this.ar.get(e).ready.reject(new Error(t)),this.Wn(e)}Lt(){this.rr.forEach(e=>e.close().catch(e=>this.G.error(e)))}Er(e,t){this.G.debug(`Registering resource id: {modelId: "${e}", resourceId: ${t}}`),this.or.set(t,e)}wr(e,t){return Mr(this,void 0,void 0,(function*(){if(void 0===e&&void 0===t)throw new Error("Internal error, id or options must be defined.");if(null!==this.hr&&(yield this.hr.promise()),o.isNotSet(e)&&(e=t.id),e&&this.rr.has(e)){const s=this.rr.get(e);return s.isClosing()?s.whenClosed().then(()=>this.rn(e,t)):(this.G.debug(`Opening model '${e}' that is already open`),Promise.resolve(s))}if(e&&this.nr.has(e))return this.G.debug(`Opening model '${e}' that is already opening`),this.nr.get(e).promise();const s=this.ar.get(e);return s&&s.resyncModel?(this.G.debug(`Opening model '${e}' that is resyncing`),s.resyncModel.isClosing()?s.resyncModel.whenClosed().then(()=>this.rn(e,t)):(s.resyncModel.gn(),Promise.resolve(s.resyncModel))):this.rn(e,t)}))}rn(e,t){const s=t?this.gr++:void 0;void 0!==t&&this.vr.set(s,t);const i=new C;let n;void 0!==e&&this.nr.set(e,i);const r=(n=this.Ke.isOnline()?this.Ir(e,s):this.pr.isOfflineEnabled()?this.Sr(e,s):Promise.reject(new O("Can not open a model while not online and without offline enabled."))).then(t=>(this.Cr(e,s),this.rr.set(t.modelId(),t),t.An()&&this.Ke.isOnline()&&this.lr(t),t)).catch(t=>(this.Cr(e,s),Promise.reject(t)));return i.resolveFromPromise(r),i.promise()}lr(e){this.Mr(e.modelId(),"resync",e),e.jn()}Mr(e,t,s){const i={modelId:e,action:t,inProgress:void 0!==s,ready:void 0!==s?_n.resolved():new _n,resyncModel:s||null};this.ar.set(e,i),i.inProgress||this.cr.push(i)}Cr(e,t){void 0!==e&&this.nr.delete(e),void 0!==t&&this.vr.delete(t)}Ir(e,t){return o.isString(e)&&this.pr.isOfflineEnabled()?(this.G.debug(`Opening model '${e}' while online`),this.xr(e,t)):this.Dr(e,t)}xr(e,t){return Mr(this,void 0,void 0,(function*(){const s=this.cr.findIndex(t=>t.modelId===e);if(s>=0){const[e]=this.cr.splice(s,1);yield this._r(e.modelId)}if(!this.ar.has(e))return this.Dr(e,t);{const s=this.ar.get(e);if(yield s.ready.promise(),"resync"===s.action)return s.resyncModel;this.Dr(e,t)}}))}Dr(e,t){const s={openRealTimeModelRequest:{modelId:K(e),autoCreateId:K(t)}};return this.Ke.request(s).then(e=>{const{openRealTimeModelResponse:t}=e,s=gn(t.data),i=this.Pr(z(t.resourceId),z(t.modelId),z(t.collection),!1,!1,B(t.version),0,X(t.createdTime),X(t.modifiedTime),z(t.valueIdPrefix),Y(t.connectedClients),Y(t.resyncingClients),Y(t.references),vn(t.permissions),s);return this.Er(i.modelId(),z(t.resourceId)),this.pr.isOfflineEnabled()?this.pr.storeOpenModelOffline(i).then(()=>(this.pr.modelOpened(i,0),i)):i})}Sr(e,t){return Mr(this,void 0,void 0,(function*(){o.isUndefined(e)&&(e=this.yr.nextString()),this.G.debug(`Opening model '${e}' while offline`);const s=yield this.pr.getOfflineModelState(e);if(o.isSet(s)){const t=yield this.pr.claimValueIdPrefix(e),i=this.Ar(s,t,!1);return Promise.resolve(i)}if(this.vr.has(t)){const s=this.vr.get(t),i=this.Tr(e,s),n=i.yn(),r={modelId:e,collection:s.collection,initialData:n.data,overrideCollectionWorldPermissions:s.overrideCollectionWorldPermissions,worldPermissions:s.worldPermissions,userPermissions:s.userPermissions};return this.pr.createOfflineModel(r).then(()=>i)}return Promise.reject(new Error("Model not available offline, and not auto create options were provided"))}))}Ar(e,t,s){this.G.debug(`Creating model '${e.modelId}' from offline state`);const i=this.Pr(null,e.modelId,e.collection,e.local,s,e.snapshot.version,e.snapshot.sequenceNumber,e.createdTime,e.modifiedTime,`${t.prefix}-${t.increment}`,[],[],[],e.permissions,e.snapshot.data);i.Tn(),i.wn(e.version,e.snapshot.serverOperations,e.snapshot.localOperations);const n=e.version-e.snapshot.version+(e.lastSequenceNumber-e.snapshot.sequenceNumber);return this.pr.modelOpened(i,n),i}Or(e){this.G.debug(`Removing model online: "${e}"`);const t={deleteRealtimeModelRequest:{modelId:e}};return this.Ke.request(t).then(()=>{this.jr(e)}).catch(t=>(t instanceof O&&t.code===T.REQUEST_TIMEOUT||this.jr(e),Promise.reject(t)))}jr(e){this.pr.isOfflineEnabled()&&this.pr.getModelMetaData(e).then(t=>{if(t)return this.pr.modelDeleted(e)}).catch(t=>{this.de(new Rr(this.Ke.session().domain(),`There was an error removing the model with id '${e}' from the offline store: ${t.message}`)),this.G.error("Error removing model from offline store.",t)})}Tr(e,t){this.G.debug(`Creating new offline model '${e}' using auto-create options.`);const s=this.Rr(t),i=new Date,n=new dn(!0,!0,!0,!0),r=this.Pr(null,e,t.collection,!0,!1,1,0,i,i,"0",[],[],[],n,s);return r.Tn(),this.pr.modelOpened(r,0),r}Pr(e,t,s,i,n,r,o,a,c,h,u,d,l,p,f){const m=new ve(new $t),g=new Ht(new $t),v=new Jt(()=>this.Ke.session().sessionId(),r,o,m,g);return new An(e,h,f,i,n,u,d,l,p,a,c,t,s,v,this.Ke,this.ms,this,this.pr)}On(e){const t=e.message,s=function(e){const t=function(e){return e.forceCloseRealTimeModel||e.remoteOperation||e.referenceShared||e.referenceSet||e.referenceCleared||e.referenceUnshared||e.operationAck||e.remoteClientOpenedModel||e.remoteClientClosedModel||e.modelPermissionsChanged||e.remoteClientResyncStarted||e.remoteClientResyncCompleted||e.modelResyncServerComplete}(e);return t?t.resourceId:null}(t);if(s){const i=this.Nr(s);i?i.On(e):this.G.warn("Received a message for a model that is not open or resynchronizing: "+JSON.stringify(t))}else t.modelAutoCreateConfigRequest&&this.Ur(t.modelAutoCreateConfigRequest,e.callback)}Nr(e){const t=this.or.get(e);if(void 0===t)return this.G.warn("Received a message for an unknown resourceId: "+e),null;const s=this.rr.get(t);if(void 0!==s)return s;const i=this.ar.get(t);return void 0!==i?i.resyncModel?i.resyncModel:(this.G.warn("Received a message for model that is resyncing but not ready: "+t),null):null}Ur(e,t){const s=e.autoCreateId||0;if(this.vr.has(s)){const e=this.vr.get(s);this.vr.delete(s);const i=this.Rr(e),n=wn(e.userPermissions),r={modelAutoCreateConfigResponse:{data:mn(i),ephemeral:e.ephemeral,collection:e.collection,overridePermissions:e.overrideCollectionWorldPermissions,worldPermissions:e.worldPermissions,userPermissions:n}};t.reply(r)}else{const e=`Received a request for an auto create id that was not expected: ${s}`;this.G.error(e),t.expectedError("unknown_model",e)}}Rr(e){let t=e.data;o.isFunction(t)?t=t():o.isNotSet(t)&&(t={}),t=Object.assign({},t);const s=new Sr;return new Bt(()=>s.id()).createDataValue(t)}mr(){return Mr(this,void 0,void 0,(function*(){this.Ke.isOnline()&&(this.de(new Ds),yield this.qr()),this.Ke.isOnline()&&(yield this.pr.resubscribe())}))}qr(){return Mr(this,void 0,void 0,(function*(){null===this.ur&&(this.ur=new C),(yield this.pr.getModelsRequiringSync()).forEach(e=>{this.rr.has(e.modelId)||this.nr.has(e.modelId)||this.ar.has(e.modelId)||this.Mr(e.modelId,e.available?"resync":"delete")});const e=this.ur.promise();return null!==this.hr&&(this.hr.resolve(),this.hr=null),this.dr(),e}))}dr(){if(!this.Ke.isOnline())return;const e=Array.from(this.ar.values()).filter(e=>e.inProgress);if(this.G.debug("Checking resync status"),this.G.debug(()=>{const t=e.map(e=>e.modelId);return`In Progress Resync Models (${e.length}): ${JSON.stringify(t)}`}),this.G.debug(()=>{const e=this.cr.map(e=>e.modelId);return`Queued Resync Models (${this.cr.length}): ${JSON.stringify(e)}`}),0===e.length)if(0===this.cr.length)null!==this.hr?(this.G.debug("Resync queue is empty, but waiting for offline sync to start."),this.hr.promise().then(()=>this.dr())):null!==this.ur&&(this.G.debug("Resync queue is empty, completing resync process"),this.de(new _s),this.ur.resolve(),this.ur=null);else{const e=this.cr.pop();this._r(e.modelId).catch(e=>{this.G.error("Error resyncing models",e)})}}_r(e){return Mr(this,void 0,void 0,(function*(){this.G.debug(`Initiating sync for model: "${e}"`);const t=this.ar.get(e);if("resync"!==t.action)return this.kr(t.modelId).then(()=>t.ready.resolve()).catch(t=>(this.qn(e,t.message),Promise.reject(new Error(t.message))));{const s=yield this.pr.getOfflineModelState(t.modelId);if(!o.isSet(s)){const t=`The state for model "${e}" could not be found to resynchronize the model`;return this.qn(e,t),Promise.reject(new Error(t))}{const e=yield this.pr.claimValueIdPrefix(t.modelId),i=this.Vr(s,e);t.resyncModel=i,t.ready.resolve()}}}))}kr(e){return this.G.debug(`Deleting resync model from the server: "${e}"`),this.Or(e).then(()=>this.Wn(e)).catch(t=>t instanceof M&&"model_not_found"===t.code?(this.Wn(e),Promise.resolve()):Promise.reject(t))}Vr(e,t){this.G.debug(`Creating and resynchronizing model: ${e.modelId}`);const s=this.Ar(e,t,!0);return s.jn(),s}br(e){return Mr(this,void 0,void 0,(function*(){if(this.rr.has(e.id)){const t=`A model with id '${e.id}' is open locally.`;return Promise.reject(new O(t))}if(null!==this.hr&&(yield this.hr.promise()),this.ar.has(e.id)){const t=this.ar.get(e.id);if("resync"===t.action){const t=`A model with id '${e.id}' is resynchronizing.`;return Promise.reject(new O(t))}yield t.ready}return this.Nn(e)}))}}Ir.Events=Er;class Sr{constructor(){this.Lr="@",this.N=0}id(){return this.Lr+":"+this.N++}}class Cr{constructor(e,t,s,i,n){this.activity=e,this.user=t,this.sessionId=s,this.local=i,this.Gr=d(n),Object.freeze(this)}get state(){return d(this.Gr)}clone(e={}){return new Cr(void 0!==e.activity?e.activity:this.activity,void 0!==e.user?e.user:this.user,void 0!==e.sessionId?e.sessionId:this.sessionId,void 0!==e.local?e.local:this.local,void 0!==e.state?e.state:this.state)}}class xr{constructor(e,t,s,i,n){this.activity=e,this.user=t,this.sessionId=s,this.local=i,this.participant=n,this.name=xr.EVENT_NAME,Object.freeze(this)}}xr.EVENT_NAME="session_joined";class Dr{constructor(e,t,s,i){this.activity=e,this.user=t,this.sessionId=s,this.local=i,this.name=Dr.EVENT_NAME,Object.freeze(this)}}Dr.EVENT_NAME="session_left";class _r{constructor(e,t,s,i,n,r,o){this.activity=e,this.user=t,this.sessionId=s,this.local=i,this.key=n,this.value=r,this.oldValue=o,this.name=_r.EVENT_NAME,Object.freeze(this)}}_r.EVENT_NAME="state_set";class Pr{constructor(e,t,s,i,n,r){this.activity=e,this.user=t,this.sessionId=s,this.local=i,this.key=n,this.oldValue=r,this.name=Pr.EVENT_NAME,Object.freeze(this)}}Pr.EVENT_NAME="state_removed";class Ar{constructor(e,t,s,i,n){this.activity=e,this.user=t,this.sessionId=s,this.local=i,this.oldValues=n,this.name=Ar.EVENT_NAME,Object.freeze(this)}}Ar.EVENT_NAME="state_cleared";class Tr{constructor(e,t,s,i,n,r,o,a){this.activity=e,this.user=t,this.sessionId=s,this.local=i,this.values=n,this.complete=r,this.removed=o,this.oldValues=a,this.name=Tr.EVENT_NAME,Object.freeze(this)}}Tr.EVENT_NAME="state_delta";class jr{constructor(e,t,s,i){this.activity=e,this.user=t,this.sessionId=s,this.local=i,this.name=jr.EVENT_NAME,Object.freeze(this)}}jr.EVENT_NAME="left";class Nr extends R{constructor(e,t,s){super(),this.jn=()=>{this.se.debug(()=>`Activity '${this.N}' is online`);const e=this.$r.state,t=new C;this.Fr(t,e)},this.Tn=()=>{this.se.debug(()=>`Activity '${this.N}' is offline`),this.Jr(e=>{for(const[t,s]of e)if(t!==this.$r.sessionId){e.delete(t);const i=new Dr(this,s.user,s.sessionId,!1);this.de(i)}})},this.ms=t,this.N=e,this.Hr=new w.BehaviorSubject(new Map),this.Br=!0,this.Ke=s,this.se=v.logger("activities.activity"),this.Wr=null,this.Ke.on(de.Events.INTERRUPTED,this.Tn),this.Ke.on(de.Events.DISCONNECTED,this.Tn),this.Ke.on(de.Events.AUTHENTICATED,this.jn),this.zr=this.Ke.messages().subscribe(e=>{const t=e.message;t.activitySessionJoined&&t.activitySessionJoined.activityId===this.N?this.Yr(t.activitySessionJoined):t.activitySessionLeft&&t.activitySessionLeft.activityId===this.N?this.Qr(t.activitySessionLeft):t.activityStateUpdated&&t.activityStateUpdated.activityId===this.N&&this.Kr(t.activityStateUpdated)})}session(){return this.Ke.session()}id(){return this.N}leave(){if(this.isJoined()){this.Br=!1,this.Ke.send({activityLeaveRequest:{activityId:this.N}});const e=this.Ke.session().user(),t=this.Ke.session().sessionId(),s=new jr(this,e,t,!0);this.de(s),this.zr.unsubscribe(),this.le()}}isJoined(){return this.Br}state(){return this.$r.state}setState(){if(this.isJoined()){let e;if(1===arguments.length?e=un.coerceToMap(arguments[0]):2===arguments.length&&(e=new Map).set(arguments[0],arguments[1]),e.size>0){this.Zr(e,!1,[]);const t=new Map,s=this.state();e.forEach((e,i)=>{t.set(i,s.get(i)),s.set(i,e)}),this.Xr(e=>e.clone({state:s}));const i=this.Ke.session(),n=new Tr(this,i.user(),i.sessionId(),!0,e,!1,[],t);this.de(n),e.forEach((e,s)=>{const n=t.get(s),r=new _r(this,i.user(),i.sessionId(),!0,s,e,n);this.de(r)})}}}removeState(e){if(this.isJoined()&&(o.isString(e)&&(e=[e]),e.length>0)){this.Zr(null,!1,e);const t=this.state(),s=new Map;e.forEach(e=>{s.set(e,t.get(e)),t.delete(e)}),this.Xr(e=>e.clone({state:t}));const i=this.Ke.session(),n=new Tr(this,i.user(),i.sessionId(),!0,new Map,!1,e,s);this.de(n),e.forEach(e=>{const t=s.get(e),n=new Pr(this,i.user(),i.sessionId(),!0,e,t);this.de(n)})}}clearState(){if(this.isJoined()&&this.$r.state.size>0){this.Zr(new Map,!0,null);const e=this.state();this.Xr(e=>e.clone({state:new Map}));const t=this.Ke.session(),s=new Tr(this,t.user(),t.sessionId(),!0,new Map,!0,[],e);this.de(s);const i=new Ar(this,t.user(),t.sessionId(),!0,e);this.de(i)}}participant(e){return this.Hr.getValue().get(e)}participants(){return Array.from(this.Hr.getValue().values())}participantsAsObservable(){return this.Hr.asObservable().pipe(Object(b.map)(e=>Array.from(e.values())))}eo(e){if(null===this.Wr){e=e||{};const t=new C,s=e.state?un.coerceToMap(e.state):new Map;this.Ke.isOnline()?this.Fr(t,s):this.to(t,s),this.Wr=t.promise()}}so(){return this.Wr}Yr(e){const t=this.ms.getUserForSession(e.sessionId),s=h(Q(e.state),te),i=new Cr(this,t,e.sessionId,!1,un.objectToMap(s));this.Jr(e=>e.set(i.sessionId,i)),this.io(i)}io(e){const t=new xr(this,e.user,e.sessionId,!1,e);this.de(t)}Qr(e){const t=this.Hr.getValue().get(e.sessionId);this.no(t),this.Jr(e=>e.delete(t.sessionId))}no(e){const t=new Dr(this,e.user,e.sessionId,e.local);this.de(t)}Kr(e){const t=z(e.sessionId),s=un.objectToMap(Q(e.set)),i=W(e.complete),n=Y(e.removed);i?0===s.size?this.ro(t):this.oo(t,s):(n.length>0&&this.ao(t,n),s.size>0&&this.co(t,s))}co(e,t){const s=this.ms.getUserForSession(e),i=new Map;t.forEach((e,t)=>{const s=te(e);i.set(t,s)});const n=new Map;this.Jr(t=>{const s=t.get(e),r=new Map(s.state);i.forEach((e,t)=>{n.set(t,r.get(t)),r.set(t,e)}),t.set(e,s.clone({state:r}))});const r=new Tr(this,s,e,!0,i,!1,[],n);this.de(r),i.forEach((t,i)=>{const r=n.get(i),o=new _r(this,s,e,!1,i,t,r);this.de(o)})}oo(e,t){const s=this.ms.getUserForSession(e),i=new Map;Object.keys(t).forEach(e=>{const s=te(t[e]);i.set(e,s)});const n=this.Hr.getValue().get(e).state;this.Jr(t=>{const s=t.get(e);t.set(e,s.clone({state:i}))});const r=[];n.forEach((e,t)=>{i.has(t)||r.push(t)});const o=new Tr(this,s,e,!0,i,!1,r,n);this.de(o),r.forEach(t=>{const i=n.get(t),r=new Pr(this,s,e,!1,t,i);this.de(r)}),i.forEach((t,i)=>{const r=n.get(i),o=new _r(this,s,e,!1,i,t,r);this.de(o)})}ro(e){const t=this.ms.getUserForSession(e),s=this.Hr.getValue().get(e).state;this.Jr(t=>{const s=t.get(e),i=new Map;t.set(e,s.clone({state:i}))});const i=new Tr(this,t,e,!0,new Map,!0,[],s);this.de(i);const n=new Ar(this,t,e,!1,s);this.de(n)}ao(e,t){const s=this.ms.getUserForSession(e),i=new Map;this.Jr(s=>{const n=s.get(e),r=new Map(n.state);t.forEach(e=>{i.set(e,r.get(e)),r.delete(e)}),s.set(e,n.clone({state:r}))});const n=new Tr(this,s,e,!0,new Map,!1,t,i);this.de(n),t.forEach(t=>{const n=i.get(t),r=new Pr(this,s,e,!1,t,n);this.de(r)})}Jr(e){const t=new Map(this.Hr.getValue());e(t),this.Hr.next(t)}Xr(e){this.Jr(t=>{this.$r=e(this.$r),t.set(this.$r.sessionId,this.$r)})}Fr(e,t){const s=h(un.mapToObject(t),se),i={activityJoinRequest:{activityId:this.N,state:s}};this.Ke.request(i).then(t=>{const s=t.activityJoinResponse,i=this.Ke.session().sessionId(),n=new Map,r=Q(s.state);if(u(r,e=>{const t=r[e]||{},s=this.ms.getUserForSession(e),o=e===i,a=h(Q(t.state),te),c=un.objectToMap(a),u=new Cr(this,s,e,o,c);n.set(e,u)}),void 0!==this.$r){this.no(this.$r);const e=n.get(i),t=e.clone({state:this.$r.state});this.ho(e.state,this.$r.state),n.set(i,t)}this.$r=n.get(i),n.forEach(e=>this.io(e)),this.Hr.next(n),e.resolve()}).catch(t=>{e.reject(t)})}ho(e,t){const s=[];e.forEach((e,i)=>{t.has(i)||s.push(i)});const i=new Map;t.forEach((t,s)=>{qe.deepEquals(!e.get(s),t)||i.set(s,t)}),(s.length>0||i.size>0)&&this.Zr(i,!1,s)}to(e,t){const s=this.Ke.session();this.$r=new Cr(void 0,s.user(),s.sessionId(),!0,t);const i=new Map;i.set(this.$r.sessionId,this.$r),this.Hr.next(i),e.resolve()}Zr(e,t,s){const i=null!==e?h(un.mapToObject(e),se):{},n=null!==s?s:[];if(this.Ke.isOnline()){const e={activityUpdateState:{activityId:this.N,set:i,complete:t,removed:n}};this.Ke.send(e)}}}Nr.Events={SESSION_JOINED:xr.EVENT_NAME,SESSION_LEFT:Dr.EVENT_NAME,STATE_SET:_r.EVENT_NAME,STATE_CLEARED:Ar.EVENT_NAME,STATE_REMOVED:Pr.EVENT_NAME,STATE_DELTA:Pr.EVENT_NAME,LEFT:jr.EVENT_NAME},Object.freeze(Nr.Events);class Ur extends R{constructor(e,t){super(),this.se=v.logger("activities.service"),this.Ke=e,this.ms=t,this.uo=new Map}session(){return this.Ke.session()}join(e,t){let s=this.uo.get(e);if(void 0===s){s=new Nr(e,this.ms,this.Ke),this.uo.set(e,s);const i=s.events().pipe(Object(b.filter)(e=>e.name===jr.EVENT_NAME),Object(b.tap)(()=>this.do(e)));s.eo(t),s.so().then(()=>(this.ue(i),Promise.resolve(s))).catch(t=>(this.uo.delete(e),Promise.reject(t)))}return s.so().then(()=>s)}joined(){return new Map(this.uo)}isJoined(e){return this.uo.has(e)}do(e){this.uo.delete(e)}}class qr{constructor(e,t,s){this.user=e,this.available=t,this.Gr=d(s),Object.freeze(this)}get state(){return d(this.Gr)}}class kr{constructor(e,t){this.user=e,this.available=t,this.name=kr.NAME,Object.freeze(this)}}kr.NAME="availability_changed";class Vr{constructor(e){this.user=e,this.name=Vr.NAME,Object.freeze(this)}}Vr.NAME="state_cleared";class Lr{constructor(e,t){this.user=e,this.keys=t,this.name=Lr.NAME,Object.freeze(this)}}Lr.NAME="state_removed";class Gr{constructor(e,t){this.user=e,this.state=t,this.name=Gr.NAME,Object.freeze(this)}}Gr.NAME="state_set";class $r extends R{constructor(e){super(),this.po=e,this.ue(e.events())}get user(){return this.po.user()}get available(){return this.po.isAvailable()}get state(){return this.po.state()}asObservable(){return this.po.asObservable()}unsubscribe(){null!==this.po&&this.po.unsubscribe(this),this.po=null}}$r.Events={STATE_SET:Gr.NAME,STATE_REMOVED:Lr.NAME,STATE_CLEARED:Vr.NAME,AVAILABILITY_CHANGED:kr.NAME};class Fr extends R{constructor(e,t,s){super(),this.fo=new qr(e.user,e.available,e.state),this.mo=[],this.vo=s,this.yo(t),this.wo=new w.BehaviorSubject(this.fo)}user(){return this.fo.user}isAvailable(){return this.fo.available}state(){return this.fo.state}asObservable(){return this.wo.asObservable()}subscribe(){const e=new $r(this);return this.mo.push(e),e}unsubscribe(e){this.mo=this.mo.filter(t=>t!==e),0===this.mo.length&&(this.bo.unsubscribe(),this.wo.complete(),this.vo(this.user().userId))}availability(e,t=!0){this.fo=new qr(this.fo.user,e,this.fo.state);const s=new kr(this.fo.user,e);this.de(s),t&&this.wo.next(this.fo)}set(e,t=!0){const s=this.fo.state;e.forEach((e,t)=>s.set(t,d(e))),this.fo=new qr(this.fo.user,this.fo.available,s);const i=new Gr(this.fo.user,s);this.de(i),t&&this.wo.next(this.fo)}remove(e,t=!0){const s=this.fo.state;e.forEach(e=>s.delete(e)),this.fo=new qr(this.fo.user,this.fo.available,s);const i=new Lr(this.fo.user,e);this.de(i),t&&this.wo.next(this.fo)}clear(e=!0){this.fo=new qr(this.fo.user,this.fo.available,new Map);const t=new Vr(this.fo.user);this.de(t),e&&this.wo.next(this.fo)}hasKey(e){return this.fo.state.has(e)}jn(e){this.availability(e.available,!1),this.clear(!1),this.set(e.state),this.wo.next(e)}yo(e){this.bo&&this.bo.unsubscribe(),this.bo=e.subscribe(e=>this.On(e))}Tn(){this.availability(!1,!1)}On(e){const t=e.message;if(t.presenceAvailabilityChanged){const{available:e}=t.presenceAvailabilityChanged;this.availability(W(e))}else if(t.presenceStateSet){const{state:e}=t.presenceStateSet,s=un.objectToMap(h(Q(e),te));this.set(s)}else if(t.presenceStateCleared)this.clear();else if(t.presenceStateRemoved){const{keys:e}=t.presenceStateRemoved;this.remove(Y(e))}}}class Jr extends R{constructor(e,t,s){super(),this.se=v.logger("connection"),this.jn=()=>{const e=this.session().user(),t=this.Oo(e.userId);this.Ro.yo(t);const s=[];this.Mo.forEach(e=>{s.push(e.user().userId)}),this.Eo(s).then(e=>{e.forEach(e=>{const t=this.Io(e.user.userId);t&&t.jn(e)})}).catch(e=>{this.se.error("Error resubscribing to presence",e)})},this.Tn=()=>{this.Ro.Tn(),this.Mo.forEach(e=>{e.Tn()})},this.Ke=e,this.ms=t,this.Mo=new Map,this.So=this.Ke.messages().pipe(Object(b.share)());const i=void 0!==s?s:new V(q.ANONYMOUS,""),n=this.Oo(i.userId),r=new qr(i,!1,new Map);this.Ro=new Fr(r,n,()=>{}),this.Co=this.Ro.subscribe(),this.ue(this.Co.events()),this.Ke.on(de.Events.INTERRUPTED,this.Tn),this.Ke.on(de.Events.DISCONNECTED,this.Tn),this.Ke.on(de.Events.AUTHENTICATED,this.jn)}session(){return this.Ke.session()}isAvailable(){return this.Co.available}setState(){let e;if(1===arguments.length)e=un.objectToMap(arguments[0]);else if(2===arguments.length)(e=new Map).set(arguments[0],arguments[1]);else if(0===arguments.length)return;if(this.Ro.set(e),this.Ke.isOnline()){const t={presenceSetState:{state:h(un.mapToObject(e),se)}};this.Ke.send(t)}}removeState(e){const t=("string"==typeof e?[e]:e).filter(e=>this.Ro.hasKey(e));if(t.length>0&&(this.Ro.remove(t),this.Ke.isOnline())){const e={presenceRemoveState:{keys:t}};this.Ke.send(e)}}clearState(){if(this.Ro.clear(),this.Ke.isOnline()){const e={presenceClearState:{}};this.Ke.send(e)}}state(){return this.Co.state}presence(e){return this.Ke.session().assertOnline(),Array.isArray(e)?this.xo(e.map(k.toDomainUserId)):this.xo([k.toDomainUserId(e)]).then(e=>e[0])}subscribe(e){const t=Array.isArray(e)?e.map(k.toDomainUserId):[k.toDomainUserId(e)];return this.Do(t).then(()=>{const s=t.map(e=>this.Mo.get(e.toGuid()).subscribe());return Array.isArray(e)?s:s[0]})}_o(e){this.Ro.clear(!1),this.Ro.set(e)}xo(e){const t={presenceRequest:{users:e.map(ne)}};return this.Ke.request(t).then(e=>{const{userPresences:t}=e.presenceResponse;return Y(t).map(e=>this.Po(e))})}Oo(e){return this.So.pipe(Object(b.filter)(t=>{const s=t.message,i=s.presenceAvailabilityChanged&&s.presenceAvailabilityChanged.user||s.presenceStateSet&&s.presenceStateSet.user||s.presenceStateRemoved&&s.presenceStateRemoved.user||s.presenceStateCleared&&s.presenceStateCleared.user;return i&&ie(i).equals(e)}))}Do(e){const t=e.filter(e=>void 0===this.Mo.get(e.toGuid()));return t.length>0?this.Eo(t).then(e=>{e.forEach(e=>{const t=e.user.userId.toGuid(),s=this.Oo(e.user.userId),i=new Fr(e,s,e=>this.Ao(e));this.Mo.set(t,i)})}):Promise.resolve()}Eo(e){const t={presenceSubscribeRequest:{users:e.map(ne)}};return this.Ke.request(t).then(e=>{const{userPresences:t}=e.presenceSubscribeResponse;return Y(t).map(e=>this.Po(e))})}Ao(e){if(this.Ke.isOnline()){const t={presenceUnsubscribe:{users:[ne(e)]}};this.Ke.send(t)}const t=e.toGuid();this.Mo.delete(t)}Po(e){const t=this.ms.getUser(ie(e.user)),s=W(e.available),i=un.objectToMap(h(Q(e.state),te));return new qr(t,s,i)}Io(e){return e.equals(this.Ro.user().userId)?this.Ro:this.Mo.get(e.toGuid())}}Jr.Events={STATE_SET:Gr.NAME,STATE_REMOVED:Lr.NAME,STATE_CLEARED:Vr.NAME,AVAILABILITY_CHANGED:kr.NAME},Object.freeze(Jr.Events);class Hr{constructor(e,t,s,i){this.chatId=e,this.eventNumber=t,this.timestamp=s,this.user=i}}class Br{constructor(e){this.chatId=e,this.name=Br.NAME,Object.freeze(this)}}Br.NAME="joined";class Wr{constructor(e){this.chatId=e,this.name=Wr.NAME,Object.freeze(this)}}Wr.NAME="left";class zr extends Hr{constructor(e,t,s,i,n,r){super(e,t,s,i),this.sessionId=n,this.message=r,this.name=zr.NAME,Object.freeze(this)}}zr.NAME="message";class Yr extends Hr{constructor(e,t,s,i,n){super(e,t,s,i),this.chatName=n,this.name=Yr.NAME,Object.freeze(this)}}Yr.NAME="name_changed";class Qr{constructor(e){this.chatId=e,this.name=Qr.NAME,Object.freeze(this)}}Qr.NAME="removed";class Kr extends Hr{constructor(e,t,s,i,n){super(e,t,s,i),this.topic=n,this.name=Kr.NAME,Object.freeze(this)}}Kr.NAME="topic_changed";class Zr extends Hr{constructor(e,t,s,i,n){super(e,t,s,i),this.addedUser=n,this.name=Zr.NAME,Object.freeze(this)}}Zr.NAME="user_added";class Xr extends Hr{constructor(e,t,s,i){super(e,t,s,i),this.name=Xr.NAME,Object.freeze(this)}}Xr.NAME="user_joined";class eo extends Hr{constructor(e,t,s,i){super(e,t,s,i),this.name=eo.NAME,Object.freeze(this)}}eo.NAME="user_left";class to extends Hr{constructor(e,t,s,i,n){super(e,t,s,i),this.removedUser=n,this.name=to.NAME,Object.freeze(this)}}to.NAME="user_removed";class so{constructor(e,t,s,i,n){this.type=e,this.chatId=t,this.eventNumber=s,this.timestamp=i,this.user=n}}so.TYPES={CREATED:"created",MESSAGE:"message",USER_JOINED:"user_joined",USER_LEFT:"user_left",USER_ADDED:"user_added",USER_REMOVED:"user_removed",NAME_CHANGED:"name_changed",TOPIC_CHANGED:"topic_changed"},n.make(so.TYPES);class io extends so{constructor(e,t,s,i,r,o,a){super(io.TYPE,e,t,s,i),this.name=r,this.topic=o,this.members=a,n.make(this)}}io.TYPE=so.TYPES.CREATED;class no extends so{constructor(e,t,s,i,r){super(no.TYPE,e,t,s,i),this.message=r,n.make(this)}}no.TYPE=so.TYPES.MESSAGE;class ro extends so{constructor(e,t,s,i,r){super(ro.TYPE,e,t,s,i),this.addedUser=r,n.make(this)}}ro.TYPE=so.TYPES.USER_ADDED;class oo extends so{constructor(e,t,s,i,r){super(oo.TYPE,e,t,s,i),this.removedUser=r,n.make(this)}}oo.TYPE=so.TYPES.USER_REMOVED;class ao extends so{constructor(e,t,s,i){super(ao.TYPE,e,t,s,i),n.make(this)}}ao.TYPE=so.TYPES.USER_JOINED;class co extends so{constructor(e,t,s,i){super(co.TYPE,e,t,s,i),n.make(this)}}co.TYPE=so.TYPES.USER_LEFT;class ho extends so{constructor(e,t,s,i,r){super(ho.TYPE,e,t,s,i),this.name=r,n.make(this)}}ho.TYPE=so.TYPES.NAME_CHANGED;class uo extends so{constructor(e,t,s,i,r){super(uo.TYPE,e,t,s,i),this.topic=r,n.make(this)}}uo.TYPE=so.TYPES.TOPIC_CHANGED;class lo{static toChatHistoryEntry(e,t){if(e.created){const{chatId:s,eventNumber:i,timestamp:n,user:r,name:o,topic:a,members:c}=e.created,h=Y(c).map(e=>t.getUser(ie(e)));return new io(s,B(i),X(n),t.getUser(ie(r)),o,a,h)}if(e.message){const{chatId:s,eventNumber:i,timestamp:n,user:r,message:o}=e.message;return new no(s,B(i),X(n),t.getUser(ie(r)),o)}if(e.userAdded){const{chatId:s,eventNumber:i,timestamp:n,user:r,addedUser:o}=e.userAdded;return new ro(s,B(i),X(n),t.getUser(ie(r)),t.getUser(ie(o)))}if(e.userRemoved){const{chatId:s,eventNumber:i,timestamp:n,user:r,removedUser:o}=e.userRemoved;return new oo(s,B(i),X(n),t.getUser(ie(r)),t.getUser(ie(o)))}if(e.userJoined){const{chatId:s,eventNumber:i,timestamp:n,user:r}=e.userJoined;return new ao(s,B(i),X(n),t.getUser(ie(r)))}if(e.userLeft){const{chatId:s,eventNumber:i,timestamp:n,user:r}=e.userLeft;return new co(s,B(i),X(n),t.getUser(ie(r)))}if(e.topicChanged){const{chatId:s,eventNumber:i,timestamp:n,user:r,topic:o}=e.topicChanged;return new uo(s,B(i),X(n),t.getUser(ie(r)),z(o))}if(e.nameChanged){const{chatId:s,eventNumber:i,timestamp:n,user:r,name:o}=e.nameChanged;return new ho(s,B(i),X(n),t.getUser(ie(r)),z(o))}throw new O("Invalid chat event: "+JSON.stringify(e))}}var po;function fo(e,t,s){let i=-1;const n=e.user().userId,r=s.members.map(e=>{const s=ie(e.user);return s.equals(n)&&(i=B(e.maxSeenEventNumber)),{user:t.getUser(s),maxSeenEventNumber:B(e.maxSeenEventNumber)}});return{chatId:s.id,chatType:s.chatType,membership:s.membership,name:s.name,topic:s.topic,createdTime:X(s.createdTime),lastEventTime:X(s.lastEventTime),lastEventNumber:B(s.lastEventNumber),maxSeenEventNumber:i,members:r}}!function(e){e.DIRECT="direct",e.CHANNEL="channel",e.ROOM="room"}(po||(po={}));const mo={MESSAGE:zr.NAME,USER_JOINED:Xr.NAME,USER_LEFT:eo.NAME,USER_ADDED:Zr.NAME,USER_REMOVED:to.NAME};Object.freeze(mo);class go extends R{constructor(e,t,s,i){super(),this.Ke=e,this.ms=t,this.To=i,this.jo(),s.subscribe(e=>{this.No(e),this.de(e)})}session(){return this.Ke.session()}info(){return Object.assign({},this.To)}isJoined(){return this.Br}send(e){return this.Ke.session().assertOnline(),this.Uo(),this.Ke.request({publishChatMessageRequest:{chatId:this.To.chatId,message:e}}).then(()=>void 0)}setName(e){return this.Ke.session().assertOnline(),this.Uo(),this.Ke.request({setChatNameRequest:{chatId:this.To.chatId,name:e}}).then(()=>void 0)}setTopic(e){return this.Ke.session().assertOnline(),this.Uo(),this.Ke.request({setChatTopicRequest:{chatId:this.To.chatId,topic:e}}).then(()=>void 0)}markSeen(e){return this.Ke.session().assertOnline(),this.Uo(),this.Ke.request({markChatEventsSeenRequest:{chatId:this.To.chatId,eventNumber:e}}).then(()=>void 0)}getHistory(e){return this.Ke.session().assertOnline(),this.Uo(),this.Ke.request({getChatHistoryRequest:{chatId:this.To.chatId,startEvent:K(e.startEvent),limit:K(e.limit),forward:K(e.forward),eventFilter:e.eventFilter}}).then(e=>{return Y(e.getChatHistoryResponse.eventData).map(e=>lo.toChatHistoryEntry(e,this.ms))})}qo(e){this.To=fo(this.Ke.session(),this.ms,e),this.jo()}eo(){return this.Ke.request({joinChatRequest:{chatId:this.To.chatId}}).then(e=>{const{joinChatResponse:t}=e;this.qo(t.chatInfo)})}Uo(){if(!this.isJoined()){const e=`Chat channel not joined: ${this.To.chatId}`;throw new O(e,T.CHAT_NOT_JOINED)}}No(e){if(e instanceof Hr&&(this.To=Object.assign(Object.assign({},this.To),{lastEventNumber:e.eventNumber,lastEventTime:e.timestamp})),e instanceof Xr||e instanceof Zr){const t=e instanceof Xr?e.user:e.addedUser,s=this.To.members.slice(0),i={user:t,maxSeenEventNumber:-1};s.push(i),e.user.username===this.session().user().username&&(this.Br=!0),this.To=Object.assign(Object.assign({},this.To),{members:s})}else if(e instanceof eo||e instanceof to){const t=e instanceof eo?e.user:e.removedUser;this.session().user().userId.equals(t.userId)&&(this.Br=!1);const s=this.To.members.filter(e=>!e.user.userId.equals(t.userId));this.To=Object.assign(Object.assign({},this.To),{members:s})}else e instanceof Yr?this.To=Object.assign(Object.assign({},this.To),{name:e.chatName}):e instanceof Kr&&(this.To=Object.assign(Object.assign({},this.To),{topic:e.topic}));n.make(this.To)}jo(){this.Br=this.To.members.map(e=>e.user.userId).findIndex(e=>this.session().user().userId.equals(e))>=0}}go.Events=mo;class vo extends go{constructor(e,t,s,i){super(e,t,s,i)}info(){const e=super.info(),t=this.session().user().userId,s=e.members.filter(e=>!e.user.userId.equals(t));return Object.assign(Object.assign({},e),{otherUsers:s})}}class yo extends go{constructor(e,t,s,i){super(e,t,s,i)}info(){return super.info()}leave(){return this.Ke.session().assertOnline(),this.Uo(),this.Ke.request({leaveChatRequest:{chatId:this.To.chatId}}).then(()=>void 0)}remove(e){return this.Ke.session().assertOnline(),this.Uo(),this.Ke.request({removeUserFromChatChannelRequest:{chatId:this.To.chatId,userToRemove:ne(k.toDomainUserId(e))}}).then(()=>void 0)}}class wo extends yo{constructor(e,t,s,i){super(e,t,s,i)}add(e){return this.Ke.session().assertOnline(),this.Uo(),this.Ke.request({addUserToChatChannelRequest:{chatId:this.To.chatId,userToAdd:ne(k.toDomainUserId(e))}}).then(()=>void 0)}}class bo extends yo{constructor(e,t,s,i){super(e,t,s,i),this.jn=()=>{this.eo()},this.Tn=()=>{this.Br=!1},e.on(de.Events.INTERRUPTED,this.Tn),e.on(de.Events.DISCONNECTED,this.Tn),e.on(de.Events.AUTHENTICATED,this.jn)}}const Oo=1;class Ro{constructor(e,t){this.ko=e,this.Ke=t}get chatId(){return this.ko}getPermissions(){this.Ke.session().assertOnline();const e={getClientPermissionsRequest:{idType:Oo,id:this.ko}};return this.Ke.request(e).then(e=>{const{getClientPermissionsResponse:t}=e;return Y(t.permissions)})}addWorldPermissions(e){this.Ke.session().assertOnline();const t={addPermissionsRequest:{idType:Oo,id:this.ko,world:e}};return this.Ke.request(t).then(()=>{})}removeWorldPermissions(e){this.Ke.session().assertOnline();const t={removePermissionsRequest:{idType:Oo,id:this.ko,world:e}};return this.Ke.request(t).then(()=>{})}setWorldPermissions(e){this.Ke.session().assertOnline();const t={setPermissionsRequest:{idType:Oo,id:this.ko,world:e}};return this.Ke.request(t).then(()=>{})}getWorldPermissions(){this.Ke.session().assertOnline();const e={getWorldPermissionsRequest:{idType:Oo,id:this.ko}};return this.Ke.request(e).then(e=>{const{getWorldPermissionsResponse:t}=e;return Y(t.permissions)})}addUserPermissions(e){this.Ke.session().assertOnline();let t=un.coerceToMap(e);const s={addPermissionsRequest:{idType:Oo,id:this.ko,user:this.Vo(t)}};return this.Ke.request(s).then(()=>{})}removeUserPermissions(e){this.Ke.session().assertOnline();let t=un.coerceToMap(e);const s={removePermissionsRequest:{idType:Oo,id:this.ko,user:this.Vo(t)}};return this.Ke.request(s).then(()=>{})}setUserPermissions(e){this.Ke.session().assertOnline();let t=un.coerceToMap(e);const s={setPermissionsRequest:{idType:Oo,id:this.ko,user:this.Vo(t)}};return this.Ke.request(s).then(()=>{})}getAllUserPermissions(){this.Ke.session().assertOnline();const e={getAllUserPermissionsRequest:{idType:Oo,id:this.ko}};return this.Ke.request(e).then(e=>{const{getAllUserPermissionsResponse:t}=e;return this.Lo(t.users)})}getUserPermissions(e){this.Ke.session().assertOnline();const t={getUserPermissionsRequest:{idType:Oo,id:this.ko,user:ne(k.normal(e))}};return this.Ke.request(t).then(e=>{const{getUserPermissionsResponse:t}=e;return Y(t.permissions)})}addGroupPermissions(e){this.Ke.session().assertOnline();let t=this.Go(e);const s={addPermissionsRequest:{idType:Oo,id:this.ko,group:t}};return this.Ke.request(s).then(()=>{})}removeGroupPermissions(e){this.Ke.session().assertOnline();let t=this.Go(e);const s={removePermissionsRequest:{idType:Oo,id:this.ko,group:t}};return this.Ke.request(s).then(()=>{})}setGroupPermissions(e){this.Ke.session().assertOnline();let t=this.Go(e);const s={setPermissionsRequest:{idType:Oo,id:this.ko,group:t}};return this.Ke.request(s).then(()=>{})}getAllGroupPermissions(){this.Ke.session().assertOnline();const e={getAllGroupPermissionsRequest:{idType:Oo,id:this.ko}};return this.Ke.request(e).then(e=>{const{getAllGroupPermissionsResponse:t}=e;let s=h(t.groups,e=>Y(e.values));return un.objectToMap(s)})}getGroupPermissions(e){this.Ke.session().assertOnline();const t={getGroupPermissionsRequest:{idType:Oo,id:this.ko,groupId:e}};return this.Ke.request(t).then(e=>{const{getGroupPermissionsResponse:t}=e;return Y(t.permissions)})}Vo(e){const t=[];return e.forEach((e,s)=>{t.push({user:{userType:oe(q.NORMAL),username:s},permissions:e})}),t}Lo(e){const t=new Map;return e.forEach(e=>{const s=e.user.username;let i=Y(e.permissions);t.set(s,i)}),t}Go(e){return h(un.coerceToObject(e),e=>({values:e}))}}const Mo={MESSAGE:zr.NAME,USER_JOINED:Xr.NAME,USER_LEFT:eo.NAME,USER_ADDED:Zr.NAME,USER_REMOVED:to.NAME,CHANNEL_JOINED:Br.NAME,CHANNEL_LEFT:Wr.NAME};Object.freeze(Mo);class Eo extends R{constructor(e,t){super(),this.Ke=e,this.ms=t,this.So=this.Ke.messages().pipe(Object(b.filter)(e=>(function(e){return!!(e.remoteChatMessage||e.userJoinedChat||e.userLeftChat||e.userAddedToChatChannel||e.userRemovedFromChatChannel||e.chatRemoved||e.chatNameChanged||e.chatTopicChanged)})(e.message)),Object(b.map)(e=>(function(e,t){if(e.userJoinedChat){const s=e.userJoinedChat;return new Xr(s.chatId,B(s.eventNumber),X(s.timestamp),t.getUser(ie(s.user)))}if(e.userLeftChat){const s=e.userLeftChat;return new eo(s.chatId,B(s.eventNumber),X(s.timestamp),t.getUser(ie(s.user)))}if(e.userAddedToChatChannel){const s=e.userAddedToChatChannel;return new Zr(s.chatId,B(s.eventNumber),X(s.timestamp),t.getUser(ie(s.user)),t.getUser(ie(s.addedUser)))}if(e.userRemovedFromChatChannel){const s=e.userRemovedFromChatChannel;return new to(s.chatId,B(s.eventNumber),X(s.timestamp),t.getUser(ie(s.user)),t.getUser(ie(s.removedUser)))}if(e.chatRemoved){const t=e.chatRemoved;return new Qr(t.chatId)}if(e.chatNameChanged){const s=e.chatNameChanged;return new Yr(s.chatId,B(s.eventNumber),X(s.timestamp),t.getUser(ie(s.user)),z(s.name))}if(e.chatTopicChanged){const s=e.chatTopicChanged;return new Kr(s.chatId,B(s.eventNumber),X(s.timestamp),t.getUser(ie(s.user)),z(s.topic))}if(e.remoteChatMessage){const s=e.remoteChatMessage;return new zr(s.chatId,B(s.eventNumber),X(s.timestamp),t.getUserForSession(s.sessionId),s.sessionId,z(s.message))}throw new O("Invalid chat event")})(e.message,this.ms)),Object(b.tap)(e=>{if(e instanceof Xr&&e.user.username===this.session().user().username){const t=new Br(e.chatId);this.de(t)}else if(e instanceof eo&&e.user.username===this.session().user().username){const t=new Wr(e.chatId);this.de(t)}}),Object(b.share)()),this.ue(this.So)}session(){return this.Ke.session()}exists(e){return l.assertNonEmptyString(e,"chatId"),this.session().assertOnline(),this.Ke.request({chatsExistRequest:{chatIds:[e]}}).then(e=>{const{chatsExistResponse:t}=e;return t.exists[0]})}get(e){return l.assertNonEmptyString(e,"chatId"),this.session().assertOnline(),this.Ke.request({getChatsRequest:{chatIds:[e]}}).then(e=>{const{getChatsResponse:t}=e,s=t.chatInfo[0],i=fo(this.Ke.session(),this.ms,s);return this.$o(i)})}joined(){return this.session().isAuthenticated()?this.Ke.request({getJoinedChatsRequest:{}}).then(e=>{const{getJoinedChatsResponse:t}=e;return t.chatInfo.map(e=>fo(this.Ke.session(),this.ms,e))}):Promise.resolve([])}create(e){if(!e)throw new Error("create options must be supplied");if("channel"!==e.type&&"room"!==e.type)throw new Error(`type must be 'channel' or 'room': ${e.type}`);if("public"!==e.membership&&"private"!==e.membership)throw new Error(`membership must be 'public' or 'private': ${e.membership}`);if("room"===e.type&&"private"===e.membership)throw new Error(`membership must be 'public' for a 'room': ${e.membership}`);void 0!==e.id&&l.assertNonEmptyString(e.id,"id"),this.session().assertOnline();const{id:t,type:s,name:i,topic:n,membership:r,members:o}=e,a=(o||[]).map(e=>ne(e instanceof k?e:k.normal(e)));return this.Ke.request({createChatRequest:{chatId:K(t),chatType:s,membership:r,name:i,topic:n,members:a}}).then(e=>{const{createChatResponse:t}=e;return t.chatId}).catch(s=>s instanceof M&&"chat_already_exists"===s.code&&e.ignoreExistsError?Promise.resolve(t):Promise.reject(s))}remove(e){return l.assertNonEmptyString(e,"chatId"),this.session().assertOnline(),this.Ke.request({removeChatRequest:{chatId:e}}).then(()=>void 0)}join(e){return l.assertNonEmptyString(e,"chatId"),this.session().assertOnline(),this.Ke.request({joinChatRequest:{chatId:e}}).then(e=>{const{joinChatResponse:t}=e,s=fo(this.Ke.session(),this.ms,t.chatInfo);return this.$o(s)})}leave(e){return l.assertNonEmptyString(e,"chatId"),this.session().assertOnline(),this.Ke.request({leaveChatRequest:{chatId:e}}).then(()=>void 0)}direct(e){this.session().assertOnline(),("string"==typeof e||e instanceof k)&&(e=[e]);const t=e.map(e=>ne(e instanceof k?e:k.normal(e)));return this.Ke.request({getDirectChatsRequest:{userLists:[{values:t}]}}).then(e=>{const{getDirectChatsResponse:t}=e,s=t.chatInfo[0],i=fo(this.Ke.session(),this.ms,s);return this.$o(i)})}permissions(e){return new Ro(e,this.Ke)}$o(e){const t=this.So.pipe(Object(b.filter)(t=>t.chatId===e.chatId));switch(e.chatType){case po.DIRECT:return new vo(this.Ke,this.ms,t,e);case po.CHANNEL:return new wo(this.Ke,this.ms,t,e);case po.ROOM:return new bo(this.Ke,this.ms,t,e);default:throw new Error(`Invalid chat chat type: ${e.chatType}`)}}}Eo.Events=Mo;var Io=function(e,t,s,i){return new(s||(s=Promise))((function(n,r){function o(e){try{c(i.next(e))}catch(e){r(e)}}function a(e){try{c(i.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(o,a)}c((i=i.apply(e,t||[])).next())}))};class So{constructor(e,t){this.Fo=new Map,this.Yi=new Map,e.messages().subscribe(e=>{e.message.identityCacheUpdate&&this.Jo(e.message.identityCacheUpdate)}),this.Ho=t,this.G=v.logger("identity")}init(){return Io(this,void 0,void 0,(function*(){if(this.Ho.isEnabled()){(yield this.Ho.identityStore().getUsers()).forEach(e=>{this.Fo.set(e.userId.toGuid(),e)}),(yield this.Ho.identityStore().getSessions()).forEach((e,t)=>{const s=this.Fo.get(e.toGuid());this.Yi.set(t,s)})}}))}getUserForSession(e){return this.Yi.get(e)}getUser(e){return this.Fo.get(e.toGuid())}Jo(e){Y(e.users).forEach(e=>{const t=$(e);this.Fo.set(t.userId.toGuid(),t),this.Ho.isEnabled()&&this.Ho.identityStore().putUser(t).catch(e=>this.G.error("Error storing user",e))}),u(Q(e.sessions),(e,t)=>{const s=re(t.userType),i=z(t.username),n=this.Fo.get(k.guid(s,i));this.Yi.set(e,n),this.Ho.isEnabled()&&this.Ho.identityStore().putSession(e,n.userId).catch(e=>this.G.error("Error storing session",e))})}}class Co{constructor(e){Co.validate(e);const t={timeout:Co.DEFAULT_CONNECTION_TIMEOUT,handshakeTimeout:Co.DEFAULT_HANDSHAKE_TIMEOUT},{timeout:s,handshakeTimeout:i}=Object.assign(Object.assign({},t),e.connection);this.connectionTimeout=s,this.handshakeTimeout=i;const n={autoReconnect:Co.DEFAULT_AUTO_RECONNECT,reconnectIntervals:Co.DEFAULT_RECONNECT_INTERVALS,fallbackAuth:{jwt:null,password:null,anonymous:null}},{autoReconnect:r,reconnectIntervals:a,fallbackAuth:c}=Object.assign(Object.assign({},n),e.reconnect);this.autoReconnect=r,this.reconnectIntervals=a,this.fallbackAuth=null,o.isFunction(c)&&(this.fallbackAuth=c);const h={defaultRequestTimeout:Co.DEFAULT_REQUEST_TIMEOUT,heartbeat:{enabled:Co.DEFAULT_HEARTBEAT_ENABLED,pingInterval:Co.DEFAULT_PING_INTERVAL,pongTimeout:Co.DEFAULT_PONG_TIMEOUT}},{defaultRequestTimeout:u,heartbeat:d}=Object.assign(Object.assign({},h),e.protocol);this.defaultRequestTimeout=u,this.heartbeatEnabled=void 0!==d.enabled?d.enabled:Co.DEFAULT_HEARTBEAT_ENABLED,this.pingInterval=void 0!==d.pingInterval?d.pingInterval:Co.DEFAULT_PING_INTERVAL,this.pongTimeout=void 0!==d.pongTimeout?d.pongTimeout:Co.DEFAULT_PONG_TIMEOUT;const l={factory:Co.DEFAULT_WEBSOCKET_FACTORY,constructor:Co.DEFAULT_WEBSOCKET_CONSTRUCTOR},p=Object.assign(Object.assign({},l),e.webSocket);this.webSocketFactory=p.factory||null,this.webSocketClass=p.class||null;const f=Object.assign({},e.offline);this.storageAdapter=f.storage||null,this.offlineStorageEnabled=null!==this.storageAdapter,this.offlineModelOperationSnapshotInterval=f.modelSnapshotInterval||100}static validate(e){let t=!1;try{t=2===WebSocket.CLOSING}catch(e){}if(!(t||e.webSocket&&e.webSocket.class)){throw new O("Convergence depends on the WebSockets API. If Convergence is not being run in a browser, you must set the 'webSocket.class' property in the connection options.","websockets_not_supported")}}getOptions(){return{connection:{timeout:this.connectionTimeout,handshakeTimeout:this.handshakeTimeout},protocol:{defaultRequestTimeout:this.defaultRequestTimeout,heartbeat:{enabled:this.heartbeatEnabled,pingInterval:this.pingInterval,pongTimeout:this.pongTimeout}},reconnect:{autoReconnect:this.autoReconnect,reconnectIntervals:this.reconnectIntervals,fallbackAuth:this.fallbackAuth},offline:{storage:this.storageAdapter},webSocket:{factory:this.webSocketFactory,class:this.webSocketClass}}}}Co.DEFAULT_CONNECTION_TIMEOUT=5,Co.DEFAULT_HANDSHAKE_TIMEOUT=5,Co.DEFAULT_AUTO_RECONNECT=!0,Co.DEFAULT_RECONNECT_INTERVALS=[0,5,10,20,30],Co.DEFAULT_REQUEST_TIMEOUT=10,Co.DEFAULT_HEARTBEAT_ENABLED=!0,Co.DEFAULT_PING_INTERVAL=5,Co.DEFAULT_PONG_TIMEOUT=10,Co.DEFAULT_WEBSOCKET_FACTORY=null,Co.DEFAULT_WEBSOCKET_CONSTRUCTOR=null;class xo{constructor(){this.G=v.logger("storage"),this.Ho=null}configure(e){if(this.G.debug("Initializing storage engine: "+e.adapterId()),!e)throw new Error("storage must be specified");this.Ho=e}openStore(e,t,s){return this.Ho.initialize(e,t,s)}isEnabled(){return null!==this.Ho}isInitialized(){return null!==this.Ho&&this.Ho.isInitialized()}dispose(){if(!this.isInitialized())throw new Error("Can not disposed a storage adapter that is not initialized");if(this.isDisposed())throw new Error("Already disposed");this.Ho.dispose()}isDisposed(){return null!==this.Ho&&this.Ho.isDisposed()}modelStore(){return this.Ho.modelStore()}identityStore(){return this.Ho.identityStore()}}class Do{constructor(e,t,s){this.id=e,this.version=t,this.permissions=s,this.name=Do.NAME,Object.freeze(this)}}Do.NAME="offline_model_updated";class _o{constructor(e,t,s,i,n){this.id=e,this.subscribed=t,this.available=s,this.uncommitted=i,this.local=n,this.name=_o.NAME,Object.freeze(this)}}_o.NAME="offline_model_status_changed";var Po=function(e,t,s,i){return new(s||(s=Promise))((function(n,r){function o(e){try{c(i.next(e))}catch(e){r(e)}}function a(e){try{c(i.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(o,a)}c((i=i.apply(e,t||[])).next())}))};class Ao extends R{constructor(e,t,s){super(),this.G=v.logger("models.offline"),this.Bo=e=>{this.Wo(e.src)},this.zo=e=>{this.Wo(e.src)},this.Ke=e,this.Ho=s,this.Yo=new Map,this.rr=new Map,this.Qo=new _n,this.Ko=t,this.Zo=!0,this.Ke.messages().subscribe(e=>{const t=e.message;t.modelOfflineUpdated&&this.Xo(t.modelOfflineUpdated)})}static ea(e,t){const s=xn(t.operation);return{sessionId:t.sessionId,modelId:e,sequenceNumber:t.seqNo,contextVersion:t.contextVersion,timestamp:t.timestamp,operation:s}}init(){return Po(this,void 0,void 0,(function*(){this.G.debug("Initializing offline model manager");try{const e=yield this.Ho.modelStore().getAllModelMetaData();for(const t of e)t.subscribed?this.Yo.set(t.modelId,{version:t.details?t.details.version:0,permissions:t.details?dn.fromJSON(t.details.permissions):void 0,available:t.available}):yield this.Ho.modelStore().deleteIfNotNeeded(t.modelId);this.Qo.resolve()}catch(e){this.G.error("Error initializing offline model manager",e),this.Qo.reject(e)}}))}isOfflineEnabled(){return this.Ho.isEnabled()}ready(){return this.Qo.promise()}modelOpened(e,t){const s={model:e,opsSinceSnapshot:t};this.rr.set(e.modelId(),s),e.on(An.Events.MODIFIED,this.zo),e.on(An.Events.COMMITTED,this.Bo)}modelClosed(e){this.rr.delete(e.modelId()),this.ta(e.modelId()).catch(e=>this.G.error("Error cleaning up model after close",e)),e.off(An.Events.MODIFIED,this.zo),e.off(An.Events.COMMITTED,this.Bo)}isModelStoredOffline(e){return this.Yo.has(e)}getSubscribedModelIds(){return Array.from(this.Yo.keys())}getModelsRequiringSync(){return this.Ho.modelStore().getModelsRequiringSync()}subscribe(e){const t=e.filter(e=>!this.Yo.has(e));return t.filter(e=>!this.rr.has(e)).forEach(e=>this.sa(e)),t.filter(e=>this.rr.has(e)).forEach(e=>{const t=this.rr.get(e);this.Yo.set(e,{version:t.model.version(),permissions:t.model.permissions(),available:!0})}),this.ia(),this.Ho.modelStore().addSubscriptions(t).then(()=>{const e=t.map(e=>{if(this.rr.has(e)){const t=this.rr.get(e);return{modelId:e,version:t.model.version(),permissions:t.model.permissions().toJSON()}}return{modelId:e,version:0}});return this.na(e,[],!1)})}unsubscribe(e){const t=e.filter(e=>this.Yo.has(e));return t.forEach(e=>this.ra(e)),this.ia(),this.Ho.modelStore().removeSubscriptions(e).then(()=>this.na([],t,!1))}setSubscriptions(e){e.filter(e=>!this.Yo.has(e)).forEach(e=>this.sa(e)),Array.from(this.Yo.keys()).filter(t=>!e.includes(t)).forEach(e=>this.ra(e));const t=Array.from(this.Yo.keys()),s=t.map(e=>{const t=this.Yo.get(e);return{modelId:e,currentVersion:t.version,currentPermissions:t.permissions}});return this.ia(),this.Ho.modelStore().setModelSubscriptions(t).then(()=>this.na(s,[],!0))}resubscribe(){this.ia();const e=[];return this.Yo.forEach((t,s)=>{e.push({modelId:s,currentPermissions:t.permissions?t.permissions.toJSON():void 0,currentVersion:t.version?t.version:0})}),this.na(e,[],!0)}getModelCreationData(e){return this.Ho.modelStore().getModelCreationData(e)}modelCreated(e){return this.Ho.modelStore().modelCreated(e).then(()=>this.ta(e))}createOfflineModel(e){return this.Ho.modelStore().createModelOffline(e)}getOfflineModelState(e){return this.Ho.modelStore().getModelState(e)}claimValueIdPrefix(e){return this.Ho.modelStore().claimValueIdPrefix(e)}getModelMetaData(e){return this.Ho.modelStore().getModelMetaData(e)}getAllModelMetaData(){return this.Ho.modelStore().getAllModelMetaData()}processLocalOperation(e,t){const s=Ao.ea(e,t);return this.Ho.modelStore().processLocalOperation(s).then(()=>this.oa(e))}processOperationAck(e,t,s){return this.Ho.modelStore().processOperationAck(e,t,s)}processServerOperationEvent(e,t,s){const i=xn(t.operation),n={modelId:e,sessionId:t.clientId,version:t.version,timestamp:t.timestamp,operation:i},r=s.map(t=>Ao.ea(e,t));return this.Ho.modelStore().processServerOperation(n,r).then(()=>this.oa(e))}markModelForDeletion(e){return this.Yo.delete(e),this.Ho.modelStore().deleteModel(e).then(()=>this.ta(e))}modelDeleted(e){return this.Ho.modelStore().modelDeleted(e).then(()=>this.ta(e))}storeOpenModelOffline(e){const t=this.aa(e),s=e.version(),i={modelId:e.modelId(),collection:e.collectionId(),valueIdPrefix:{prefix:e.Ei(),increment:0},version:s,lastSequenceNumber:t.sequenceNumber,createdTime:e.createdTime(),modifiedTime:e.time(),local:e.isLocal(),permissions:e.permissions(),snapshot:t};return this.Ho.modelStore().putModelState(i)}sa(e){if(this.Yo.has(e))throw new Error(`Model is already subscribed: ${e}`);this.Yo.set(e,{version:0,available:this.rr.has(e)})}ra(e){this.Yo.delete(e)}na(e,t,s){const i=s||e.length>0||t.length>0;if(this.Ke.isOnline()&&i){const i={modelOfflineSubscriptionChange:{subscribe:e,unsubscribe:t,all:s}};return this.Ke.request(i).then(()=>void 0)}return Promise.resolve()}Xo(e){const t=z(e.modelId);if(!this.rr.has(t))if(W(e.deleted))this.Ho.modelStore().removeSubscriptions([t]).then(()=>{this.Yo.delete(t);const e=new Ts(t);this.de(e);const s=new _o(t,!1,!1,!1,!1);this.de(s)}).catch(e=>{this.G.error("Could not delete offline model.",e)});else if(W(e.permissionRevoked))this.Ho.modelStore().removeSubscriptions([t]).then(()=>{this.Yo.delete(t);const e=new js(t);this.de(e);const s=new _o(t,!1,!1,!1,!1);this.de(s)}).catch(e=>{this.G.error("Could not delete offline model after permissions revoked.",e)});else if(e.initial){if(this.Yo.has(t)){const{collection:s,model:i,permissions:n,valueIdPrefix:r}=e.initial,o=vn(n),a=B(i.version),c={modelId:t,collection:s,valueIdPrefix:{prefix:r,increment:0},version:a,lastSequenceNumber:0,createdTime:X(i.createdTime),modifiedTime:X(i.modifiedTime),local:!1,permissions:o,snapshot:{version:B(i.version),sequenceNumber:0,data:gn(i.data),serverOperations:[],localOperations:[]}};this.Ho.modelStore().putModelState(c).catch(e=>{this.G.error("Error synchronizing subscribed model from server",e)}).then(()=>{this.Yo.set(t,{version:a,permissions:o,available:!0});const e=new _o(t,!0,!0,!1,!1);this.de(e);const s=new Do(t,a,o);this.de(s),this.ia()})}}else if(e.updated){const{model:s,permissions:i}=e.updated,n=s?{version:B(s.version),createdTime:X(s.createdTime),modifiedTime:X(s.modifiedTime),data:gn(s.data)}:void 0,r=vn(i),o={modelId:t,dataUpdate:n,permissionsUpdate:r};this.Ho.modelStore().updateOfflineModel(o).catch(e=>{this.G.error("Error synchronizing subscribed model from server",e)}).then(()=>{n&&this.Yo.set(t,{version:B(s.version),permissions:r,available:!0});const e=r?dn.fromJSON(r):null,i=n?n.version:null,o=new Do(t,i,e);this.de(o)})}}oa(e){return Po(this,void 0,void 0,(function*(){if(this.rr.has(e)){let{model:t,opsSinceSnapshot:s}=this.rr.get(e);if(++s>=this.Ko){const i=this.aa(t);yield this.Ho.modelStore().snapshotModel(e,i.version,i.sequenceNumber,i.data).then(()=>{s=0}).catch(e=>this.G.error("Error snapshotting model",e))}this.rr.set(e,{model:t,opsSinceSnapshot:s})}}))}aa(e){const t=e.yn(),s=t.uncommittedOperations.map(t=>Ao.ea(e.modelId(),t));return{version:e.version(),sequenceNumber:t.lastSequenceNumber,data:t.data,localOperations:s,serverOperations:[]}}ia(){let e=!0;if(this.Yo.forEach(t=>{t.available||(e=!1)}),this.Zo&&!e){const e=new Cs;this.de(e)}else if(!this.Zo&&e){const e=new xs;this.de(e)}this.Zo=e}ta(e){return this.Ho.modelStore().deleteIfNotNeeded(e).then(t=>{if(t){this.Yo.delete(e);const t=new _o(e,!1,!1,!1,!1);this.de(t)}})}Wo(e){const t=new _o(e.modelId(),this.Yo.has(e.modelId()),!0,!e.isCommitted(),e.isLocal());this.de(t)}}var To=function(e,t,s,i){return new(s||(s=Promise))((function(n,r){function o(e){try{c(i.next(e))}catch(e){r(e)}}function a(e){try{c(i.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(o,a)}c((i=i.apply(e,t||[])).next())}))};class jo extends R{constructor(e,t){super(),this.G=v.logger("domain"),l.assertString(e,"url");const s=/^(https?|wss?):\/{2}(.+)\/(.+)\/(.+)/.exec(e.trim());if(!s||5!==s.length)throw new Error(`Invalid url: ${e}`);this.ca=s[3],this.ha=s[4],this.bt=new Co(t||{}),this.jt=!1,this.ua=!1,this.Ke=new de(e,this,this.bt),this.Ho=new xo,this.ms=new So(this.Ke,this.Ho),this.pr=new Ao(this.Ke,this.bt.offlineModelOperationSnapshotInterval,this.Ho),this.Gi=new Ir(this.Ke,this.ms,this.pr),this.da=new J(this.Ke),this.la=new Ur(this.Ke,this.ms),this.pa=new Jr(this.Ke,this.ms,void 0),this.fa=new Eo(this.Ke,this.ms),this.ma(),this.bt.storageAdapter&&(this.G.debug("options.offline.storage is set, configuring offline storage"),this.Ho.configure(this.bt.storageAdapter))}static ga(e){return void 0===e?()=>Promise.resolve(void 0):"function"==typeof e?e:()=>Promise.resolve(e)}url(){return this.Ke.url()}options(){return this.bt.getOptions()}namespace(){return this.ca}id(){return this.ha}session(){return this.Ke.session()}models(){return this.Gi}identity(){return this.da}activities(){return this.la}presence(){return this.pa}chat(){return this.fa}dispose(){this.jt=!0,void 0!==this.Gi&&this.Gi.Lt(),this.Ke.disconnect()}isDisposed(){return this.jt}connectWithPassword(e){const t=jo.ga(e);return this.Ke.connect().then(()=>t()).then(e=>(l.assertNonEmptyString(e.username,"username"),l.assertNonEmptyString(e.password,"password"),this.va(e))).then(()=>this.ya(this.Ke.session().user().username))}connectAnonymously(e){const t=jo.ga(e);return this.Ke.connect().then(()=>t()).then(e=>this.wa(e)).then(()=>this.ya(this.Ke.session().user().username))}connectWithJwt(e){const t=jo.ga(e);return this.Ke.connect().then(()=>t()).then(e=>(l.assertNonEmptyString(e,"jwt"),this.ba(e))).then(()=>this.ya(this.Ke.session().user().username))}reconnect(e){if(e=e||this.Ke.session().reconnectToken(),o.isSet(e)){const t=jo.ga(e);return this.Ke.connect().then(()=>t()).then(e=>(l.assertNonEmptyString(e,"token"),this.Oa(e))).then(()=>this.ya(this.Ke.session().user().username))}return Promise.reject(new Error("No reconnect token was provided, and there is not one in memory"))}initializeOffline(e){const t=jo.ga(e);if(o.isNotSet(e))throw new Error("An username must be provided to initialize the domain offline.");if(o.isNotSet(this.bt.storageAdapter))throw new Error("'options.offline.storage' must be set to initialize the domain offline.");return t().then(e=>this.ya(e))}disconnect(){this.Ke.isDisconnected()||this.Ke.disconnect()}isDisconnected(){return this.Ke.isDisconnected()}isConnected(){return this.Ke.isConnected()}va(e){return this.Ke.authenticateWithPassword(e).then(()=>void 0)}ba(e){return this.Ke.authenticateWithJwt(e).then(()=>void 0)}Oa(e){return this.Ke.authenticateWithReconnectToken(e).then(()=>void 0)}wa(e){return this.Ke.authenticateAnonymously(e).then(()=>void 0)}ma(){this.Ke.on(de.Events.CONNECTING,()=>this.de(new gr(this))),this.Ke.on(de.Events.CONNECTED,()=>this.de(new pr(this))),this.Ke.on(de.Events.CONNECTION_SCHEDULED,e=>this.de(new mr(this,e.delay))),this.Ke.on(de.Events.CONNECTION_FAILED,()=>this.de(new fr(this))),this.Ke.on(de.Events.AUTHENTICATING,e=>this.de(new vr(this,e.method))),this.Ke.on(de.Events.AUTHENTICATED,e=>{this.de(new yr(this,e.method)),this.Ra(e)}),this.Ke.on(de.Events.AUTHENTICATION_FAILED,e=>this.de(new wr(this,e.method))),this.Ke.on(de.Events.INTERRUPTED,()=>{this.de(new Or(this))}),this.Ke.on(de.Events.DISCONNECTED,()=>{this.de(new br(this))}),this.Ke.on(de.Events.ERROR,e=>this.de(new Rr(this,e.error.message)))}ya(e){return this.ua?Promise.resolve():(this.G.debug("Initializing domain"),this.bt.storageAdapter?(this.G.debug("options.offline.storage is set, opening offline storage"),this.Ho.openStore(this.ca,this.ha,e).then(()=>To(this,void 0,void 0,(function*(){this.ua=!0,yield this.pr.init(),yield this.ms.init()})))):(this.ua=!0,Promise.resolve()))}Ra(e){const t=h(Q(e.state),te);this.pa._o(un.objectToMap(t))}}jo.Events={CONNECTION_SCHEDULED:mr.NAME,CONNECTING:gr.NAME,CONNECTED:pr.NAME,CONNECTION_FAILED:fr.NAME,AUTHENTICATING:vr.NAME,AUTHENTICATED:yr.NAME,AUTHENTICATION_FAILED:wr.NAME,INTERRUPTED:Or.NAME,DISCONNECTED:br.NAME,ERROR:Rr.NAME},Object.freeze(jo.Events);class No{static connect(e,t,s,i,n){return No.connectWithPassword(e,{username:t,password:s},i,n)}static connectWithPassword(e,t,s,i){const n=No.Ma(e,s,i);return n.connectWithPassword(t).then(()=>n)}static connectAnonymously(e,t,s,i){const n=No.Ma(e,s,i);return n.connectAnonymously(t).then(()=>n)}static connectWithJwt(e,t,s,i){const n=No.Ma(e,s,i);return n.connectWithJwt(t).then(()=>n)}static reconnect(e,t,s,i){const n=No.Ma(e,s,i);return n.reconnect(t).then(()=>n)}static configureLogging(e){v.configure(e)}static Ma(e,t,s){const i=new jo(e,t);return"object"==typeof s&&s.me(()=>i.dispose()),i}}const Uo=No.connect,qo=No.connectWithPassword,ko=No.connectAnonymously,Vo=No.connectWithJwt,Lo=No.reconnect,Go=No.configureLogging;function $o(e){return new Promise((t,s)=>{e.onsuccess=()=>{t(e.result)},e.onerror=()=>{s(e.error)}})}function Fo(e){return $o(e).then(()=>void 0)}function Jo(e){return new Promise((t,s)=>{e.oncomplete=()=>{t()},e.onerror=()=>{s(e.error)},e.onabort=()=>{s(e.error)}})}const Ho="readonly",Bo="readwrite";class Wo{constructor(e){this.Ea=e}static deleteFromIndex(e,t,s){return this.Ia(e,t,e=>{e.delete()},s)}static Ia(e,t,s,i,n){return new Promise((r,o)=>{let a=null;if(null===t)a=e.openCursor();else{const s=e.index(t);a=s.openCursor(i,n)}a.onsuccess=e=>{const t=e.target.result;t?(s(t),t.continue()):r()},a.onerror=()=>{o(a.error)}})}Sa(e,t){return this.Ca([e],Bo,e=>t(e[0]))}xa(e,t){return this.Ca([e],Ho,e=>t(e[0]))}Da(e,t){return this.Ca(e,Bo,t)}_a(e,t){return this.Ca(e,Ho,t)}Ca(e,t,s){const i=this.Ea.transaction(e,t),n=s(e.map(e=>i.objectStore(e))).catch(e=>(i.abort(),Promise.reject(e)));return Promise.all([n,Jo(i)]).then(([e,t])=>e)}put(e,t){return this.Sa(e,e=>Fo(e.put(t)))}add(e,t){return this.Sa(e,e=>Fo(e.add(t)))}Pa(e,t){const s=[];return this.Aa(e,null,e=>{s.push(e)},t).then(()=>s)}Aa(e,t,s,i,n){const r=e=>{s(e.value)};return this.xa(e,e=>Wo.Ia(e,t,r,i,n))}Ta(e,t,s,i){return this.ja(e,t,e=>{e.delete()},s,i)}ja(e,t,s,i,n){return this.Sa(e,e=>Wo.Ia(e,t,s,i,n))}}const zo={ModelCreation:{Store:"ModelCreation",Fields:{ModelId:"modelId"},Indices:{ModelId:"ModelCreation.modelId"}},ModelMetaData:{Store:"ModelMetaData",Fields:{ModelId:"modelId",Subscribed:"subscribed",Created:"created",Deleted:"deleted",SyncRequired:"syncRequired",Uncommitted:"uncommitted"},Indices:{ModelId:"ModelMetaData.modelId",Created:"ModelMetaData.created",Deleted:"ModelMetaData.deleted",Uncommitted:"ModelMetaData.uncommitted",SyncRequired:"ModelMetaData.syncRequired",Subscribed:"ModelMetaData.subscribed"}},ModelData:{Store:"ModelData",Fields:{ModelId:"modelId"},Indices:{ModelId:"ModelData.modelId"}},ModelServerOperation:{Store:"ModelServerOperation",Fields:{ModelId:"modelId",Version:"version"},Indices:{ModelId:"ModelServerOperation.modelId",ModelId_Version:"ModelServerOperation.modelId_version"}},ModelLocalOperation:{Store:"ModelLocalOperation",Fields:{ModelId:"modelId",SequenceNumber:"sequenceNumber"},Indices:{ModelId:"ModelLocalOperation.modelId",ModelId_SequenceNumber:"ModelLocalOperation.modelId_sequenceNumber"}},DomainUser:{Store:"DomainUser",Fields:{Username:"username",UserType:"userType"},Indices:{UserType_Username:"DomainUser.userType_username"}},Session:{Store:"Session",Fields:{SessionId:"sessionId",Username:"username",UserType:"userType"},Indices:{UserType_Username:"DomainUser.userType_username",SessionId:"Session.sessionId"}}};var Yo=function(e,t,s,i){return new(s||(s=Promise))((function(n,r){function o(e){try{c(i.next(e))}catch(e){r(e)}}function a(e){try{c(i.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(o,a)}c((i=i.apply(e,t||[])).next())}))};class Qo extends Wo{static Na(e,t){return Wo.deleteFromIndex(e,zo.ModelServerOperation.Indices.ModelId,IDBKeyRange.only(t))}static Ua(e,t){return Wo.deleteFromIndex(e,zo.ModelLocalOperation.Indices.ModelId,IDBKeyRange.only(t))}static qa(e,t){return Yo(this,void 0,void 0,(function*(){for(const s of t)yield Fo(e.add(s))}))}static ka(e,t){return Yo(this,void 0,void 0,(function*(){for(const s of t)yield Fo(e.add(s))}))}static Va(e){const t={modelId:e.modelId,subscribed:1===e.subscribed,available:1===e.available,deleted:1===e.deleted,created:1===e.created,uncommitted:1===e.uncommitted,syncRequired:1===e.syncRequired};return e.details&&(t.details={collection:e.details.collection,valueIdPrefix:e.details.valueIdPrefix,version:e.details.version,lastSequenceNumber:e.details.lastSequenceNumber,createdTime:e.details.createdTime,modifiedTime:e.details.modifiedTime,permissions:new dn(e.details.permissions.read,e.details.permissions.write,e.details.permissions.remove,e.details.permissions.manage),snapshotVersion:e.details.snapshotVersion,snapshotSequenceNumber:e.details.snapshotSequenceNumber}),t}static La(e,t,s,i,n){return Yo(this,void 0,void 0,(function*(){const r=yield $o(t.get(e.modelId)),o={prefix:e.valueIdPrefix.prefix,increment:e.valueIdPrefix.increment||0},a={modelId:e.modelId,available:1,details:{collection:e.collection,valueIdPrefix:o,createdTime:e.createdTime,modifiedTime:e.modifiedTime,permissions:{read:e.permissions.read,write:e.permissions.write,remove:e.permissions.remove,manage:e.permissions.manage},lastSequenceNumber:e.lastSequenceNumber,version:e.version,snapshotVersion:e.snapshot.version,snapshotSequenceNumber:e.snapshot.sequenceNumber}};e.local&&(a.created=1),a.available=1,r&&(a.subscribed=r.subscribed,a.deleted=r.deleted),Qo.Ga(a),yield Fo(t.put(a));const c={modelId:e.modelId,data:e.snapshot.data};yield Fo(s.put(c)),yield Qo.Na(n,a.modelId),yield Qo.Ua(i,a.modelId),yield Qo.qa(i,e.snapshot.localOperations),yield Qo.ka(n,e.snapshot.serverOperations)}))}static $a(e,t,s,i,n,r){return Yo(this,void 0,void 0,(function*(){for(const o of e){const e=yield $o(s.get(o));e&&(delete e.subscribed,Qo.Ga(e),Qo.Fa(e)?yield s.put(e):yield this.Ja(o,t,s,i,n,r))}}))}static Ja(e,t,s,i,n,r){return Yo(this,void 0,void 0,(function*(){yield t.delete(e),yield s.delete(e),yield i.delete(e),yield Qo.Na(r,e),yield Qo.Ua(n,e)}))}static Ha(e,t){return Yo(this,void 0,void 0,(function*(){for(const s of e){const e=yield $o(t.get(s));let i;void 0!==e?(i=e).subscribed=1:i={modelId:s,subscribed:1},yield Fo(t.put(i))}}))}static Ga(e){1===e.deleted||1===e.created||1===e.uncommitted?e.syncRequired=1:delete e.syncRequired}static Fa(e){return 1===e.subscribed||1===e.syncRequired}createModelOffline(e){const t=[zo.ModelCreation.Store,zo.ModelMetaData.Store,zo.ModelData.Store,zo.ModelLocalOperation.Store,zo.ModelServerOperation.Store];return this.Da(t,([t,s,i,n,r])=>Yo(this,void 0,void 0,(function*(){const a=e.modelId,c=yield $o(s.get(a));if(o.isSet(c)&&c.available)return Promise.reject(new Error(`An offline model with the specified id already exists: ${a}`));yield Fo(t.put(e));const h=new Date,u=new dn(!0,!0,!0,!0),d={modelId:a,collection:e.collection,valueIdPrefix:{prefix:"0",increment:0},version:1,lastSequenceNumber:0,createdTime:h,modifiedTime:h,permissions:u,local:!0,snapshot:{version:1,sequenceNumber:0,data:e.initialData,localOperations:[],serverOperations:[]}};yield Qo.La(d,s,i,n,r)})))}deleteModel(e){const t=[zo.ModelCreation.Store,zo.ModelMetaData.Store,zo.ModelData.Store,zo.ModelLocalOperation.Store,zo.ModelServerOperation.Store];return this.Da(t,([t,s,i,n,r])=>Yo(this,void 0,void 0,(function*(){const o=yield $o(s.get(e));if(!o)throw new Error(`Can't delete model '${e}' because it doesn't exist.`);delete o.details,delete o.subscribed,delete o.available,delete o.uncommitted,1===o.created?delete o.created:o.deleted=1,Qo.Ga(o),yield Fo(s.put(o)),yield Fo(t.delete(e)),yield Qo.Ua(n,e),yield Qo.Na(r,e),yield Fo(i.delete(e))})))}modelDeleted(e){const t=[zo.ModelMetaData.Store];return this.Da(t,([t])=>Yo(this,void 0,void 0,(function*(){const s=yield $o(t.get(e));s&&(delete s.deleted,Qo.Ga(s),yield Fo(t.put(s)))})))}modelCreated(e){const t=[zo.ModelCreation.Store,zo.ModelMetaData.Store];return this.Da(t,([t,s])=>Yo(this,void 0,void 0,(function*(){t.delete(e);const i=yield $o(s.get(e));i.available=1,delete i.created,Qo.Ga(i),yield Fo(s.put(i))})))}deleteIfNotNeeded(e){const t=[zo.ModelCreation.Store,zo.ModelMetaData.Store,zo.ModelData.Store,zo.ModelLocalOperation.Store,zo.ModelServerOperation.Store];return this.Da(t,([t,s,i,n,r])=>Yo(this,void 0,void 0,(function*(){const o=yield $o(s.get(e));return!(!o||Qo.Fa(o))&&(yield Qo.Ja(e,t,s,i,n,r),!0)})))}getModelCreationData(e){return this.xa(zo.ModelCreation.Store,t=>Yo(this,void 0,void 0,(function*(){return $o(t.get(e))})))}putModelState(e){const t=[zo.ModelMetaData.Store,zo.ModelData.Store,zo.ModelLocalOperation.Store,zo.ModelServerOperation.Store];return this.Da(t,([t,s,i,n])=>Yo(this,void 0,void 0,(function*(){yield Qo.La(e,t,s,i,n)})))}updateOfflineModel(e){const t=[zo.ModelMetaData.Store,zo.ModelData.Store,zo.ModelServerOperation.Store];return this.Da(t,([t,s,i])=>Yo(this,void 0,void 0,(function*(){const{modelId:n,dataUpdate:r,permissionsUpdate:o}=e,a=yield $o(t.get(n));if(void 0!==a){if(a.uncommitted)throw new Error(`A model update was received for an model ('${n}')with uncommitted operations.`);if(yield Qo.Na(i,n),r){a.details.version=r.version,a.details.createdTime=r.createdTime,a.details.modifiedTime=r.modifiedTime,a.details.snapshotSequenceNumber=a.details.lastSequenceNumber,a.details.snapshotVersion=r.version;const e={modelId:n,data:r.data};yield Fo(s.put(e))}return o&&(a.details.permissions=o),Fo(t.put(a))}})))}modelExists(e){if(null==e)throw new Error("modelId must be defined");return this.xa(zo.ModelMetaData.Store,t=>{return $o(t.index(zo.ModelMetaData.Indices.ModelId).count(e)).then(e=>e>0)})}getModelsRequiringSync(){return this.xa(zo.ModelMetaData.Store,e=>{return $o(e.index(zo.ModelMetaData.Indices.SyncRequired).getAll()).then(e=>e.map(Qo.Va))})}processServerOperation(e){if(!e)throw new Error("serverOp was undefined.");const t=[zo.ModelMetaData.Store,zo.ModelServerOperation.Store];return this.Da(t,([t,s])=>Yo(this,void 0,void 0,(function*(){const i=yield $o(t.get(e.modelId));if(!i)throw new Error(`Model meta data for model '${e.modelId}' not found when processing a server operation.`);if(!i.details)throw new Error(`Can't store server operation for Model '${e.modelId}' because the model details are missing from storage.`);i.details.version=e.version+1,i.details.modifiedTime=e.timestamp,yield Fo(s.add(e)),yield Fo(t.put(i))})))}processLocalOperation(e){if(!e)throw new Error("localOp was undefined.");const t=[zo.ModelMetaData.Store,zo.ModelLocalOperation.Store];return this.Da(t,([t,s])=>Yo(this,void 0,void 0,(function*(){const i=yield $o(t.get(e.modelId));if(!i)throw new Error(`Model meta data for model '${e.modelId}' not found when processing a local operation.`);if(!i.details)throw new Error(`Can't store local operation for Model '${e.modelId}' because the model details are missing from storage.`);i.uncommitted=1,i.details.lastSequenceNumber=e.sequenceNumber,Qo.Ga(i),yield Fo(s.add(e)),yield Fo(t.put(i))})))}processOperationAck(e,t,s){const i=[zo.ModelLocalOperation.Store,zo.ModelServerOperation.Store,zo.ModelMetaData.Store];return this.Da(i,([i,n,r])=>Yo(this,void 0,void 0,(function*(){const o=yield $o(r.get(e));if(!o)throw new Error(`Model meta data for model '${e}' not found when processing a local operation acknowledgement.`);if(!o.details)throw new Error(`Can't store operation ack for Model '${e}' because the model details are missing from storage.`);o.details.version=s.version+1,o.details.modifiedTime=s.timestamp,yield Fo(i.delete([e,t])),yield Fo(n.add(s));const a=i.index(zo.ModelLocalOperation.Indices.ModelId);(yield $o(a.count(e)).then(e=>e>0))?o.uncommitted=1:delete o.uncommitted,Qo.Ga(o),yield Fo(r.put(o))})))}getModelState(e){if(null==e)throw new Error("modelId must be defined");const t=[zo.ModelMetaData.Store,zo.ModelData.Store,zo.ModelLocalOperation.Store,zo.ModelServerOperation.Store];return this._a(t,([t,s,i,n])=>Yo(this,void 0,void 0,(function*(){const r=yield $o(t.get(e)),o=yield $o(s.get(e));if(r&&o){const t=i.index(zo.ModelLocalOperation.Indices.ModelId),s=yield $o(t.getAll(e)),a=n.index(zo.ModelServerOperation.Indices.ModelId),c=yield $o(a.getAll(e)),h={version:r.details.snapshotVersion,sequenceNumber:r.details.snapshotSequenceNumber,data:o.data,localOperations:s,serverOperations:c},u=r.details.version,d=r.details.lastSequenceNumber;return{modelId:r.modelId,collection:r.details.collection,createdTime:r.details.createdTime,modifiedTime:r.details.modifiedTime,version:u,lastSequenceNumber:d,valueIdPrefix:Object.assign({},r.details.valueIdPrefix),permissions:new dn(r.details.permissions.read,r.details.permissions.write,r.details.permissions.remove,r.details.permissions.manage),local:1===r.created,snapshot:h}}})))}getAllModelMetaData(){return this.Pa(zo.ModelMetaData.Store).then(e=>e.map(Qo.Va))}getModelMetaData(e){return this.xa(zo.ModelMetaData.Store,t=>$o(t.get(e)).then(e=>{if(e)return Qo.Va(e)}))}setModelSubscriptions(e){const t=[zo.ModelCreation.Store,zo.ModelMetaData.Store,zo.ModelData.Store,zo.ModelLocalOperation.Store,zo.ModelServerOperation.Store];return this.Da(t,([t,s,i,n,r])=>Yo(this,void 0,void 0,(function*(){const o=s.index(zo.ModelMetaData.Indices.Subscribed),a=(yield $o(o.getAll())).map(e=>e.modelId),c=e.filter(e=>!a.includes(e)),h=a.filter(t=>!e.includes(t));yield Qo.$a(h,t,s,i,n,r),yield Qo.Ha(c,s)})))}getSubscribedModels(){const e=zo.ModelMetaData.Store;return this.xa(e,e=>Yo(this,void 0,void 0,(function*(){const t=e.index(zo.ModelMetaData.Indices.Subscribed);return(yield $o(t.getAll())).map(Qo.Va)})))}addSubscriptions(e){const t=zo.ModelMetaData.Store;return this.Sa(t,t=>Qo.Ha(e,t))}removeSubscriptions(e){const t=[zo.ModelCreation.Store,zo.ModelMetaData.Store,zo.ModelData.Store,zo.ModelLocalOperation.Store,zo.ModelServerOperation.Store];return this.Da(t,([t,s,i,n,r])=>Yo(this,void 0,void 0,(function*(){return Qo.$a(e,t,s,i,n,r)})))}snapshotModel(e,t,s,i){const n=[zo.ModelMetaData.Store,zo.ModelData.Store,zo.ModelServerOperation.Store];return this.Da(n,([n,r,o])=>Yo(this,void 0,void 0,(function*(){const a=yield $o(n.get(e));a.details.snapshotVersion=t,a.details.snapshotSequenceNumber=s,yield Fo(n.put(a));const c={modelId:e,data:i};yield Fo(r.put(c)),yield Qo.Na(o,e)})))}claimValueIdPrefix(e){return this.Sa(zo.ModelMetaData.Store,t=>Yo(this,void 0,void 0,(function*(){const s=yield $o(t.get(e));if(!s||!s.details)throw new O("No such offline model available: "+e);const i=Object.assign({},s.details.valueIdPrefix);return s.details.valueIdPrefix.increment=s.details.valueIdPrefix.increment+1,yield Fo(t.put(s)),i})))}}class Ko{static upgrade(e){e.createObjectStore(zo.ModelCreation.Store,{keyPath:zo.ModelCreation.Fields.ModelId}).createIndex(zo.ModelCreation.Indices.ModelId,zo.ModelCreation.Fields.ModelId,{unique:!0});const t=e.createObjectStore(zo.ModelMetaData.Store,{keyPath:zo.ModelMetaData.Fields.ModelId});t.createIndex(zo.ModelMetaData.Indices.ModelId,zo.ModelMetaData.Fields.ModelId,{unique:!0}),t.createIndex(zo.ModelMetaData.Indices.Created,zo.ModelMetaData.Fields.Created,{unique:!1}),t.createIndex(zo.ModelMetaData.Indices.Deleted,zo.ModelMetaData.Fields.Deleted,{unique:!1}),t.createIndex(zo.ModelMetaData.Indices.Uncommitted,zo.ModelMetaData.Fields.Uncommitted,{unique:!1}),t.createIndex(zo.ModelMetaData.Indices.SyncRequired,zo.ModelMetaData.Fields.SyncRequired,{unique:!1}),t.createIndex(zo.ModelMetaData.Indices.Subscribed,zo.ModelMetaData.Fields.Subscribed,{unique:!1}),e.createObjectStore(zo.ModelData.Store,{keyPath:zo.ModelData.Fields.ModelId}).createIndex(zo.ModelData.Indices.ModelId,zo.ModelData.Fields.ModelId,{unique:!0});const s=e.createObjectStore(zo.ModelServerOperation.Store,{keyPath:[zo.ModelServerOperation.Fields.ModelId,zo.ModelServerOperation.Fields.Version]});s.createIndex(zo.ModelServerOperation.Indices.ModelId,zo.ModelServerOperation.Fields.ModelId,{unique:!1}),s.createIndex(zo.ModelServerOperation.Indices.ModelId_Version,[zo.ModelServerOperation.Fields.ModelId,zo.ModelServerOperation.Fields.Version],{unique:!0});const i=e.createObjectStore(zo.ModelLocalOperation.Store,{keyPath:[zo.ModelLocalOperation.Fields.ModelId,zo.ModelLocalOperation.Fields.SequenceNumber]});i.createIndex(zo.ModelLocalOperation.Indices.ModelId,zo.ModelLocalOperation.Fields.ModelId,{unique:!1}),i.createIndex(zo.ModelLocalOperation.Indices.ModelId_SequenceNumber,[zo.ModelLocalOperation.Fields.ModelId,zo.ModelLocalOperation.Fields.SequenceNumber],{unique:!0}),e.createObjectStore(zo.DomainUser.Store,{keyPath:[zo.DomainUser.Fields.UserType,zo.DomainUser.Fields.Username]}).createIndex(zo.DomainUser.Indices.UserType_Username,[zo.DomainUser.Fields.UserType,zo.DomainUser.Fields.Username],{unique:!0});const n=e.createObjectStore(zo.Session.Store,{keyPath:[zo.Session.Fields.SessionId]});n.createIndex(zo.Session.Indices.UserType_Username,[zo.Session.Fields.UserType,zo.Session.Fields.Username],{unique:!1}),n.createIndex(zo.Session.Indices.SessionId,[zo.Session.Fields.SessionId],{unique:!0})}}class Zo{static upgrade(e,t){switch(t){case 1:Ko.upgrade(e)}}}var Xo=function(e,t,s,i){return new(s||(s=Promise))((function(n,r){function o(e){try{c(i.next(e))}catch(e){r(e)}}function a(e){try{c(i.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(o,a)}c((i=i.apply(e,t||[])).next())}))};class ea extends Wo{putUser(e){const t=zo.DomainUser.Store;return this.Sa(t,t=>Xo(this,void 0,void 0,(function*(){const s={userType:e.userId.userType,username:e.userId.username,displayName:e.displayName,firstName:e.firstName,lastName:e.lastName,email:e.email};yield Fo(t.put(s))})))}getUsers(){return Xo(this,void 0,void 0,(function*(){const e=zo.DomainUser.Store;return(yield this.Pa(e)).map(e=>new V(e.userType,e.username,e.firstName,e.lastName,e.displayName,e.email))}))}putSession(e,t){const s=zo.Session.Store;return this.Sa(s,s=>Xo(this,void 0,void 0,(function*(){const i={sessionId:e,userType:t.userType,username:t.username};yield Fo(s.put(i))})))}getSessions(){return Xo(this,void 0,void 0,(function*(){const e=zo.Session.Store,t=yield this.Pa(e),s=new Map;return t.forEach(e=>{s.set(e.sessionId,new k(e.userType,e.username))}),s}))}}class ta{constructor(){this.Ea=null,this.jt=!1}adapterId(){return"Indexed DB Storage"}initialize(e,t,s){if(!e)throw new Error("namespace must be a non-empty string");if(!t)throw new Error("domain must be a non-empty string");if(!s)throw new Error("username must be a non-empty string");const i=`${ta.Ba}:${e}/${t}/${s}`,n=indexedDB.open(i,ta.Wa);let r=!0;return n.onupgradeneeded=()=>{const e=n.result,t=n.result.version;r=1===t,Zo.upgrade(e,t)},$o(n).then(e=>{this.Ea=e,this.za=new Qo(this.Ea),this.Ya=new ea(this.Ea)})}isInitialized(){return null!==this.Ea}modelStore(){return this.za}identityStore(){return this.Ya}destroy(){const e=this.Ea.name;this.dispose(),indexedDB.deleteDatabase(e)}dispose(){if(!this.isInitialized())throw new Error("Can not disposed a storage adapter that is not initialized");if(this.isDisposed())throw new Error("Already disposed");this.Ea.close(),this.Ea=null,this.jt=!0}isDisposed(){return this.jt}}ta.Ba="convergence.offline.storage",ta.Wa=1,s.d(t,"Convergence",(function(){return No})),s.d(t,"connect",(function(){return Uo})),s.d(t,"connectWithPassword",(function(){return qo})),s.d(t,"connectAnonymously",(function(){return ko})),s.d(t,"connectWithJwt",(function(){return Vo})),s.d(t,"reconnect",(function(){return Lo})),s.d(t,"configureLogging",(function(){return Go})),s.d(t,"ConvergenceSession",(function(){return U})),s.d(t,"ConvergenceDomain",(function(){return jo})),s.d(t,"ActivityParticipant",(function(){return Cr})),s.d(t,"Activity",(function(){return Nr})),s.d(t,"ActivityService",(function(){return Ur})),s.d(t,"ActivitySessionJoinedEvent",(function(){return xr})),s.d(t,"ActivitySessionLeftEvent",(function(){return Dr})),s.d(t,"ActivityStateSetEvent",(function(){return _r})),s.d(t,"ActivityStateRemovedEvent",(function(){return Pr})),s.d(t,"ActivityStateClearedEvent",(function(){return Ar})),s.d(t,"ActivityStateDeltaEvent",(function(){return Tr})),s.d(t,"ChatTypes",(function(){return po})),s.d(t,"ChatService",(function(){return Eo})),s.d(t,"Chat",(function(){return go})),s.d(t,"ChatChannel",(function(){return wo})),s.d(t,"ChatPermissionManager",(function(){return Ro})),s.d(t,"ChatRoom",(function(){return bo})),s.d(t,"DirectChat",(function(){return vo})),s.d(t,"MembershipChat",(function(){return yo})),s.d(t,"ChatHistoryEntry",(function(){return so})),s.d(t,"ChannelCreatedHistoryEntry",(function(){return io})),s.d(t,"MessageChatHistoryEntry",(function(){return no})),s.d(t,"NameChangedChatHistoryEntry",(function(){return ho})),s.d(t,"TopicChangedChatHistoryEntry",(function(){return uo})),s.d(t,"UserAddedChatHistoryEntry",(function(){return ro})),s.d(t,"UserJoinedChatHistoryEntry",(function(){return ao})),s.d(t,"UserLeftChatHistoryEntry",(function(){return co})),s.d(t,"UserRemovedChatHistoryEntry",(function(){return oo})),s.d(t,"ChatEvent",(function(){return Hr})),s.d(t,"ChatJoinedEvent",(function(){return Br})),s.d(t,"ChatLeftEvent",(function(){return Wr})),s.d(t,"ChatMessageEvent",(function(){return zr})),s.d(t,"ChatNameChangedEvent",(function(){return Yr})),s.d(t,"ChatRemovedEvent",(function(){return Qr})),s.d(t,"ChatTopicChangedEvent",(function(){return Kr})),s.d(t,"UserAddedEvent",(function(){return Zr})),s.d(t,"UserJoinedEvent",(function(){return Xr})),s.d(t,"UserLeftEvent",(function(){return eo})),s.d(t,"UserRemovedEvent",(function(){return to})),s.d(t,"DomainUser",(function(){return V})),s.d(t,"IdentityService",(function(){return J})),s.d(t,"DomainUserType",(function(){return q})),s.d(t,"DomainUserId",(function(){return k})),s.d(t,"ModelServiceEventConstants",(function(){return Er})),s.d(t,"ModelService",(function(){return Ir})),s.d(t,"ModelPermissionManager",(function(){return bn})),s.d(t,"ModelPermissions",(function(){return dn})),s.d(t,"ArrayInsertEvent",(function(){return Wt})),s.d(t,"ArrayRemoveEvent",(function(){return zt})),s.d(t,"ArrayReorderEvent",(function(){return Yt})),s.d(t,"ArraySetEvent",(function(){return Qt})),s.d(t,"ArraySetValueEvent",(function(){return Kt})),s.d(t,"ObjectRemoveEvent",(function(){return Zt})),s.d(t,"ObjectSetEvent",(function(){return Xt})),s.d(t,"ObjectSetValueEvent",(function(){return es})),s.d(t,"BooleanSetValueEvent",(function(){return ts})),s.d(t,"DateSetValueEvent",(function(){return ss})),s.d(t,"NumberSetValueEvent",(function(){return is})),s.d(t,"NumberDeltaEvent",(function(){return ns})),s.d(t,"StringInsertEvent",(function(){return rs})),s.d(t,"StringRemoveEvent",(function(){return os})),s.d(t,"StringSetValueEvent",(function(){return as})),s.d(t,"ElementDetachedEvent",(function(){return cs})),s.d(t,"ModelChangedEvent",(function(){return hs})),s.d(t,"ModelClosedEvent",(function(){return us})),s.d(t,"ModelDeletedEvent",(function(){return ds})),s.d(t,"ModelPermissionsChangedEvent",(function(){return ls})),s.d(t,"VersionChangedEvent",(function(){return ps})),s.d(t,"ModelOnlineEvent",(function(){return fs})),s.d(t,"ModelOfflineEvent",(function(){return ms})),s.d(t,"ModelReconnectingEvent",(function(){return gs})),s.d(t,"ResyncStartedEvent",(function(){return vs})),s.d(t,"ResyncCompletedEvent",(function(){return ys})),s.d(t,"ResyncErrorEvent",(function(){return ws})),s.d(t,"RemoteReferenceCreatedEvent",(function(){return bs})),s.d(t,"RemoteResyncStartedEvent",(function(){return Os})),s.d(t,"RemoteResyncCompletedEvent",(function(){return Rs})),s.d(t,"CollaboratorOpenedEvent",(function(){return Ms})),s.d(t,"CollaboratorClosedEvent",(function(){return Es})),s.d(t,"ModelCommittedEvent",(function(){return Is})),s.d(t,"ModelModifiedEvent",(function(){return Ss})),s.d(t,"OfflineModelDownloadPendingEvent",(function(){return Cs})),s.d(t,"OfflineModelDownloadCompletedEvent",(function(){return xs})),s.d(t,"OfflineModelSyncStartedEvent",(function(){return Ds})),s.d(t,"OfflineModelSyncCompletedEvent",(function(){return _s})),s.d(t,"OfflineModelSyncAbortedEvent",(function(){return Ps})),s.d(t,"OfflineModelSyncErrorEvent",(function(){return As})),s.d(t,"OfflineModelDeletedEvent",(function(){return Ts})),s.d(t,"OfflineModelPermissionsRevokedEvent",(function(){return js})),s.d(t,"HistoricalArray",(function(){return jn})),s.d(t,"HistoricalBoolean",(function(){return Nn})),s.d(t,"HistoricalElement",(function(){return Tn})),s.d(t,"HistoricalModel",(function(){return lr})),s.d(t,"HistoricalNull",(function(){return qn})),s.d(t,"HistoricalNumber",(function(){return kn})),s.d(t,"HistoricalObject",(function(){return Un})),s.d(t,"HistoricalString",(function(){return Vn})),s.d(t,"HistoricalUndefined",(function(){return Ln})),s.d(t,"HistoricalDate",(function(){return Gn})),s.d(t,"ModelResult",(function(){return ln})),s.d(t,"ElementReference",(function(){return si})),s.d(t,"IndexReference",(function(){return ei})),s.d(t,"LocalElementReference",(function(){return Oi})),s.d(t,"LocalModelReference",(function(){return bi})),s.d(t,"LocalPropertyReference",(function(){return Ri})),s.d(t,"LocalRangeReference",(function(){return Mi})),s.d(t,"ModelReference",(function(){return At})),s.d(t,"PropertyReference",(function(){return ii})),s.d(t,"RangeReference",(function(){return ti})),s.d(t,"RealTimeArray",(function(){return vi})),s.d(t,"RealTimeBoolean",(function(){return wi})),s.d(t,"RealTimeElement",(function(){return di})),s.d(t,"RealTimeModel",(function(){return An})),s.d(t,"RealTimeNull",(function(){return Ji})),s.d(t,"RealTimeNumber",(function(){return zi})),s.d(t,"RealTimeObject",(function(){return Fi})),s.d(t,"RealTimeString",(function(){return en})),s.d(t,"RealTimeDate",(function(){return nn})),s.d(t,"RealTimeUndefined",(function(){return tn})),s.d(t,"ModelCollaborator",(function(){return cn})),s.d(t,"ReferenceChangedEvent",(function(){return Dt})),s.d(t,"ReferenceClearedEvent",(function(){return _t})),s.d(t,"ReferenceDisposedEvent",(function(){return Pt})),s.d(t,"PresenceService",(function(){return Jr})),s.d(t,"UserPresence",(function(){return qr})),s.d(t,"UserPresenceSubscription",(function(){return $r})),s.d(t,"PresenceAvailabilityChangedEvent",(function(){return kr})),s.d(t,"PresenceStateClearedEvent",(function(){return Vr})),s.d(t,"PresenceStateRemovedEvent",(function(){return Lr})),s.d(t,"PresenceStateSetEvent",(function(){return Gr})),s.d(t,"ConvergenceEventEmitter",(function(){return R})),s.d(t,"ConvergenceServerError",(function(){return M})),s.d(t,"ConvergenceError",(function(){return O})),s.d(t,"CancellationToken",(function(){return E})),s.d(t,"PagedData",(function(){return I})),s.d(t,"LogLevel",(function(){return i})),s.d(t,"ConnectedEvent",(function(){return pr})),s.d(t,"ConnectionFailedEvent",(function(){return fr})),s.d(t,"ConnectionScheduledEvent",(function(){return mr})),s.d(t,"ConnectingEvent",(function(){return gr})),s.d(t,"AuthenticatingEvent",(function(){return vr})),s.d(t,"AuthenticatedEvent",(function(){return yr})),s.d(t,"AuthenticationFailedEvent",(function(){return wr})),s.d(t,"DisconnectedEvent",(function(){return br})),s.d(t,"InterruptedEvent",(function(){return Or})),s.d(t,"ErrorEvent",(function(){return Rr})),s.d(t,"IdbStorageAdapter",(function(){return ta}));t.default=No}]);
//# sourceMappingURL=convergence.global.min.js.map
