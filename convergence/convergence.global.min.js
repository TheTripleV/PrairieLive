/**!
Copyright Â© 2016-2020 - Convergence Labs, Inc.
@version 1.0.0-rc.12
@license Licensed under the terms of the GNU Lesser General Public License version 3 (GPLv3). See https://www.gnu.org/licenses/lgpl-3.0.html
*/
var Convergence=function(e){var t={};function s(i){if(t[i])return t[i].exports;var n=t[i]={i:i,l:!1,exports:{}};return e[i].call(n.exports,n,n.exports,s),n.l=!0,n.exports}return s.m=e,s.c=t,s.d=function(e,t,i){s.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},s.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"h",{value:!0})},s.t=function(e,t){if(1&t&&(e=s(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.h)return e;var i=Object.create(null);if(s.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)s.d(i,n,function(t){return e[t]}.bind(null,n));return i},s.n=function(e){var t=e&&e.h?function(){return e.default}:function(){return e};return s.d(t,"a",t),t},s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},s.p="",s(s.s=44)}([function(e,t){e.exports=rxjs.operators},function(e,t,s){"use strict";var i,n,r=e.exports=s(2),o=s(16);r.codegen=s(41),r.fetch=s(42),r.path=s(43),r.fs=r.inquire("fs"),r.toArray=function(e){if(e){for(var t=Object.keys(e),s=new Array(t.length),i=0;i<t.length;)s[i]=e[t[i++]];return s}return[]},r.toObject=function(e){for(var t={},s=0;s<e.length;){var i=e[s++],n=e[s++];void 0!==n&&(t[i]=n)}return t};var a=/\\/g,c=/"/g;r.isReserved=function(e){return/^(?:do|if|in|for|let|new|try|var|case|else|enum|eval|false|null|this|true|void|with|break|catch|class|const|super|throw|while|yield|delete|export|import|public|return|static|switch|typeof|default|extends|finally|package|private|continue|debugger|function|arguments|interface|protected|implements|instanceof)$/.test(e)},r.safeProp=function(e){return!/^[$\w_]+$/.test(e)||r.isReserved(e)?'["'+e.replace(a,"\\\\").replace(c,'\\"')+'"]':"."+e},r.ucFirst=function(e){return e.charAt(0).toUpperCase()+e.substring(1)};var h=/_([a-z])/g;r.camelCase=function(e){return e.substring(0,1)+e.substring(1).replace(h,(function(e,t){return t.toUpperCase()}))},r.compareFieldsById=function(e,t){return e.id-t.id},r.decorateType=function(e,t){if(e.$type)return t&&e.$type.name!==t&&(r.decorateRoot.remove(e.$type),e.$type.name=t,r.decorateRoot.add(e.$type)),e.$type;i||(i=s(18));var n=new i(t||e.name);return r.decorateRoot.add(n),n.ctor=e,Object.defineProperty(e,"$type",{value:n,enumerable:!1}),Object.defineProperty(e.prototype,"$type",{value:n,enumerable:!1}),n};var u=0;r.decorateEnum=function(e){if(e.$type)return e.$type;n||(n=s(3));var t=new n("Enum"+u++,e);return r.decorateRoot.add(t),Object.defineProperty(e,"$type",{value:t,enumerable:!1}),t},r.setProperty=function(e,t,s){if("object"!=typeof e)throw TypeError("dst must be an object");if(!t)throw TypeError("path must be specified");return function e(t,s,i){var n=s.shift();if(s.length>0)t[n]=e(t[n]||{},s,i);else{var r=t[n];r&&(i=[].concat(r).concat(i)),t[n]=i}return t}(e,t=t.split("."),s)},Object.defineProperty(r,"decorateRoot",{get:function(){return o.decorated||(o.decorated=new(s(26)))}})},function(e,t,s){"use strict";(function(e){var i=t;function n(e,t,s){for(var i=Object.keys(t),n=0;n<i.length;++n)void 0!==e[i[n]]&&s||(e[i[n]]=t[i[n]]);return e}function r(e){function t(e,s){if(!(this instanceof t))return new t(e,s);Object.defineProperty(this,"message",{get:function(){return e}}),Error.captureStackTrace?Error.captureStackTrace(this,t):Object.defineProperty(this,"stack",{value:(new Error).stack||""}),s&&n(this,s)}return(t.prototype=Object.create(Error.prototype)).constructor=t,Object.defineProperty(t.prototype,"name",{get:function(){return e}}),t.prototype.toString=function(){return this.name+": "+this.message},t}i.asPromise=s(13),i.base64=s(32),i.EventEmitter=s(33),i.float=s(34),i.inquire=s(14),i.utf8=s(35),i.pool=s(36),i.LongBits=s(37),i.isNode=Boolean(void 0!==e&&e&&e.process&&e.process.versions&&e.process.versions.node),i.global=i.isNode&&e||"undefined"!=typeof window&&window||"undefined"!=typeof self&&self||this,i.emptyArray=Object.freeze?Object.freeze([]):[],i.emptyObject=Object.freeze?Object.freeze({}):{},i.isInteger=Number.isInteger||function(e){return"number"==typeof e&&isFinite(e)&&Math.floor(e)===e},i.isString=function(e){return"string"==typeof e||e instanceof String},i.isObject=function(e){return e&&"object"==typeof e},i.isset=i.isSet=function(e,t){var s=e[t];return!(null==s||!e.hasOwnProperty(t))&&("object"!=typeof s||(Array.isArray(s)?s.length:Object.keys(s).length)>0)},i.Buffer=function(){try{var e=i.inquire("buffer").Buffer;return e.prototype.utf8Write?e:null}catch(e){return null}}(),i.u=null,i.g=null,i.newBuffer=function(e){return"number"==typeof e?i.Buffer?i.g(e):new i.Array(e):i.Buffer?i.u(e):"undefined"==typeof Uint8Array?e:new Uint8Array(e)},i.Array="undefined"!=typeof Uint8Array?Uint8Array:Array,i.Long=i.global.dcodeIO&&i.global.dcodeIO.Long||i.global.Long||i.inquire("long"),i.key2Re=/^true|false|0|1$/,i.key32Re=/^-?(?:0|[1-9][0-9]*)$/,i.key64Re=/^(?:[\\x00-\\xff]{8}|-?(?:0|[1-9][0-9]*))$/,i.longToHash=function(e){return e?i.LongBits.from(e).toHash():i.LongBits.zeroHash},i.longFromHash=function(e,t){var s=i.LongBits.fromHash(e);return i.Long?i.Long.fromBits(s.lo,s.hi,t):s.toNumber(Boolean(t))},i.merge=n,i.lcFirst=function(e){return e.charAt(0).toLowerCase()+e.substring(1)},i.newError=r,i.ProtocolError=r("ProtocolError"),i.oneOfGetter=function(e){for(var t={},s=0;s<e.length;++s)t[e[s]]=1;return function(){for(var e=Object.keys(this),s=e.length-1;s>-1;--s)if(1===t[e[s]]&&void 0!==this[e[s]]&&null!==this[e[s]])return e[s]}},i.oneOfSetter=function(e){return function(t){for(var s=0;s<e.length;++s)e[s]!==t&&delete this[e[s]]}},i.toJSONOptions={longs:String,enums:String,bytes:String,json:!0},i.v=function(){var e=i.Buffer;e?(i.u=e.from!==Uint8Array.from&&e.from||function(t,s){return new e(t,s)},i.g=e.allocUnsafe||function(t){return new e(t)}):i.u=i.g=null}}).call(this,s(31))},function(e,t,s){"use strict";e.exports=o;var i=s(5);((o.prototype=Object.create(i.prototype)).constructor=o).className="Enum";var n=s(7),r=s(1);function o(e,t,s,n,r){if(i.call(this,e,s),t&&"object"!=typeof t)throw TypeError("values must be an object");if(this.valuesById={},this.values=Object.create(this.valuesById),this.comment=n,this.comments=r||{},this.reserved=void 0,t)for(var o=Object.keys(t),a=0;a<o.length;++a)"number"==typeof t[o[a]]&&(this.valuesById[this.values[o[a]]=t[o[a]]]=o[a])}o.fromJSON=function(e,t){var s=new o(e,t.values,t.options,t.comment,t.comments);return s.reserved=t.reserved,s},o.prototype.toJSON=function(e){var t=!!e&&Boolean(e.keepComments);return r.toObject(["options",this.options,"values",this.values,"reserved",this.reserved&&this.reserved.length?this.reserved:void 0,"comment",t?this.comment:void 0,"comments",t?this.comments:void 0])},o.prototype.add=function(e,t,s){if(!r.isString(e))throw TypeError("name must be a string");if(!r.isInteger(t))throw TypeError("id must be an integer");if(void 0!==this.values[e])throw Error("duplicate name '"+e+"' in "+this);if(this.isReservedId(t))throw Error("id "+t+" is reserved in "+this);if(this.isReservedName(e))throw Error("name '"+e+"' is reserved in "+this);if(void 0!==this.valuesById[t]){if(!this.options||!this.options.allow_alias)throw Error("duplicate id "+t+" in "+this);this.values[e]=t}else this.valuesById[this.values[e]=t]=e;return this.comments[e]=s||null,this},o.prototype.remove=function(e){if(!r.isString(e))throw TypeError("name must be a string");var t=this.values[e];if(null==t)throw Error("name '"+e+"' does not exist in "+this);return delete this.valuesById[t],delete this.values[e],delete this.comments[e],this},o.prototype.isReservedId=function(e){return n.isReservedId(this.reserved,e)},o.prototype.isReservedName=function(e){return n.isReservedName(this.reserved,e)}},function(e,t){e.exports=rxjs},function(e,t,s){"use strict";e.exports=r,r.className="ReflectionObject";var i,n=s(1);function r(e,t){if(!n.isString(e))throw TypeError("name must be a string");if(t&&!n.isObject(t))throw TypeError("options must be an object");this.options=t,this.parsedOptions=null,this.name=e,this.parent=null,this.resolved=!1,this.comment=null,this.filename=null}Object.defineProperties(r.prototype,{root:{get:function(){for(var e=this;null!==e.parent;)e=e.parent;return e}},fullName:{get:function(){for(var e=[this.name],t=this.parent;t;)e.unshift(t.name),t=t.parent;return e.join(".")}}}),r.prototype.toJSON=function(){throw Error()},r.prototype.onAdd=function(e){this.parent&&this.parent!==e&&this.parent.remove(this),this.parent=e,this.resolved=!1;var t=e.root;t instanceof i&&t.O(this)},r.prototype.onRemove=function(e){var t=e.root;t instanceof i&&t.R(this),this.parent=null,this.resolved=!1},r.prototype.resolve=function(){return this.resolved||this.root instanceof i&&(this.resolved=!0),this},r.prototype.getOption=function(e){if(this.options)return this.options[e]},r.prototype.setOption=function(e,t,s){return s&&this.options&&void 0!==this.options[e]||((this.options||(this.options={}))[e]=t),this},r.prototype.setParsedOption=function(e,t,s){this.parsedOptions||(this.parsedOptions=[]);var i=this.parsedOptions;if(s){var r=i.find((function(t){return Object.prototype.hasOwnProperty.call(t,e)}));if(r){var o=r[e];n.setProperty(o,s,t)}else(r={})[e]=n.setProperty({},s,t),i.push(r)}else{var a={};a[e]=t,i.push(a)}return this},r.prototype.setOptions=function(e,t){if(e)for(var s=Object.keys(e),i=0;i<s.length;++i)this.setOption(s[i],e[s[i]],t);return this},r.prototype.toString=function(){var e=this.constructor.className,t=this.fullName;return t.length?e+" "+t:e},r.v=function(e){i=e}},function(e,t,s){"use strict";e.exports=h;var i=s(5);((h.prototype=Object.create(i.prototype)).constructor=h).className="Field";var n,r=s(3),o=s(8),a=s(1),c=/^required|optional|repeated$/;function h(e,t,s,n,r,h,u){if(a.isObject(n)?(u=r,h=n,n=r=void 0):a.isObject(r)&&(u=h,h=r,r=void 0),i.call(this,e,h),!a.isInteger(t)||t<0)throw TypeError("id must be a non-negative integer");if(!a.isString(s))throw TypeError("type must be a string");if(void 0!==n&&!c.test(n=n.toString().toLowerCase()))throw TypeError("rule must be a string rule");if(void 0!==r&&!a.isString(r))throw TypeError("extend must be a string");"proto3_optional"===n&&(n="optional"),this.rule=n&&"optional"!==n?n:void 0,this.type=s,this.id=t,this.extend=r||void 0,this.required="required"===n,this.optional=!this.required,this.repeated="repeated"===n,this.map=!1,this.message=null,this.partOf=null,this.typeDefault=null,this.defaultValue=null,this.long=!!a.Long&&void 0!==o.long[s],this.bytes="bytes"===s,this.resolvedType=null,this.extensionField=null,this.declaringField=null,this.M=null,this.comment=u}h.fromJSON=function(e,t){return new h(e,t.id,t.type,t.rule,t.extend,t.options,t.comment)},Object.defineProperty(h.prototype,"packed",{get:function(){return null===this.M&&(this.M=!1!==this.getOption("packed")),this.M}}),h.prototype.setOption=function(e,t,s){return"packed"===e&&(this.M=null),i.prototype.setOption.call(this,e,t,s)},h.prototype.toJSON=function(e){var t=!!e&&Boolean(e.keepComments);return a.toObject(["rule","optional"!==this.rule&&this.rule||void 0,"type",this.type,"id",this.id,"extend",this.extend,"options",this.options,"comment",t?this.comment:void 0])},h.prototype.resolve=function(){if(this.resolved)return this;if(void 0===(this.typeDefault=o.defaults[this.type])&&(this.resolvedType=(this.declaringField?this.declaringField.parent:this.parent).lookupTypeOrEnum(this.type),this.resolvedType instanceof n?this.typeDefault=null:this.typeDefault=this.resolvedType.values[Object.keys(this.resolvedType.values)[0]]),this.options&&null!=this.options.default&&(this.typeDefault=this.options.default,this.resolvedType instanceof r&&"string"==typeof this.typeDefault&&(this.typeDefault=this.resolvedType.values[this.typeDefault])),this.options&&(!0!==this.options.packed&&(void 0===this.options.packed||!this.resolvedType||this.resolvedType instanceof r)||delete this.options.packed,Object.keys(this.options).length||(this.options=void 0)),this.long)this.typeDefault=a.Long.fromNumber(this.typeDefault,"u"===this.type.charAt(0)),Object.freeze&&Object.freeze(this.typeDefault);else if(this.bytes&&"string"==typeof this.typeDefault){var e;a.base64.test(this.typeDefault)?a.base64.decode(this.typeDefault,e=a.newBuffer(a.base64.length(this.typeDefault)),0):a.utf8.write(this.typeDefault,e=a.newBuffer(a.utf8.length(this.typeDefault)),0),this.typeDefault=e}return this.map?this.defaultValue=a.emptyObject:this.repeated?this.defaultValue=a.emptyArray:this.defaultValue=this.typeDefault,this.parent instanceof n&&(this.parent.ctor.prototype[this.name]=this.defaultValue),i.prototype.resolve.call(this)},h.d=function(e,t,s,i){return"function"==typeof t?t=a.decorateType(t).name:t&&"object"==typeof t&&(t=a.decorateEnum(t).name),function(n,r){a.decorateType(n.constructor).add(new h(r,e,t,s,{default:i}))}},h.v=function(e){n=e}},function(e,t,s){"use strict";e.exports=d;var i=s(5);((d.prototype=Object.create(i.prototype)).constructor=d).className="Namespace";var n,r,o,a=s(6),c=s(9),h=s(1);function u(e,t){if(e&&e.length){for(var s={},i=0;i<e.length;++i)s[e[i].name]=e[i].toJSON(t);return s}}function d(e,t){i.call(this,e,t),this.nested=void 0,this.S=null}function l(e){return e.S=null,e}d.fromJSON=function(e,t){return new d(e,t.options).addJSON(t.nested)},d.arrayToJSON=u,d.isReservedId=function(e,t){if(e)for(var s=0;s<e.length;++s)if("string"!=typeof e[s]&&e[s][0]<=t&&e[s][1]>t)return!0;return!1},d.isReservedName=function(e,t){if(e)for(var s=0;s<e.length;++s)if(e[s]===t)return!0;return!1},Object.defineProperty(d.prototype,"nestedArray",{get:function(){return this.S||(this.S=h.toArray(this.nested))}}),d.prototype.toJSON=function(e){return h.toObject(["options",this.options,"nested",u(this.nestedArray,e)])},d.prototype.addJSON=function(e){if(e)for(var t,s=Object.keys(e),i=0;i<s.length;++i)t=e[s[i]],this.add((void 0!==t.fields?n.fromJSON:void 0!==t.values?o.fromJSON:void 0!==t.methods?r.fromJSON:void 0!==t.id?a.fromJSON:d.fromJSON)(s[i],t));return this},d.prototype.get=function(e){return this.nested&&this.nested[e]||null},d.prototype.getEnum=function(e){if(this.nested&&this.nested[e]instanceof o)return this.nested[e].values;throw Error("no such enum: "+e)},d.prototype.add=function(e){if(!(e instanceof a&&void 0!==e.extend||e instanceof n||e instanceof o||e instanceof r||e instanceof d||e instanceof c))throw TypeError("object must be a valid nested object");if(this.nested){var t=this.get(e.name);if(t){if(!(t instanceof d&&e instanceof d)||t instanceof n||t instanceof r)throw Error("duplicate name '"+e.name+"' in "+this);for(var s=t.nestedArray,i=0;i<s.length;++i)e.add(s[i]);this.remove(t),this.nested||(this.nested={}),e.setOptions(t.options,!0)}}else this.nested={};return this.nested[e.name]=e,e.onAdd(this),l(this)},d.prototype.remove=function(e){if(!(e instanceof i))throw TypeError("object must be a ReflectionObject");if(e.parent!==this)throw Error(e+" is not a member of "+this);return delete this.nested[e.name],Object.keys(this.nested).length||(this.nested=void 0),e.onRemove(this),l(this)},d.prototype.define=function(e,t){if(h.isString(e))e=e.split(".");else if(!Array.isArray(e))throw TypeError("illegal path");if(e&&e.length&&""===e[0])throw Error("path must be relative");for(var s=this;e.length>0;){var i=e.shift();if(s.nested&&s.nested[i]){if(!((s=s.nested[i])instanceof d))throw Error("path conflicts with non-namespace objects")}else s.add(s=new d(i))}return t&&s.addJSON(t),s},d.prototype.resolveAll=function(){for(var e=this.nestedArray,t=0;t<e.length;)e[t]instanceof d?e[t++].resolveAll():e[t++].resolve();return this.resolve()},d.prototype.lookup=function(e,t,s){if("boolean"==typeof t?(s=t,t=void 0):t&&!Array.isArray(t)&&(t=[t]),h.isString(e)&&e.length){if("."===e)return this.root;e=e.split(".")}else if(!e.length)return this;if(""===e[0])return this.root.lookup(e.slice(1),t);var i=this.get(e[0]);if(i){if(1===e.length){if(!t||t.indexOf(i.constructor)>-1)return i}else if(i instanceof d&&(i=i.lookup(e.slice(1),t,!0)))return i}else for(var n=0;n<this.nestedArray.length;++n)if(this.S[n]instanceof d&&(i=this.S[n].lookup(e,t,!0)))return i;return null===this.parent||s?null:this.parent.lookup(e,t)},d.prototype.lookupType=function(e){var t=this.lookup(e,[n]);if(!t)throw Error("no such type: "+e);return t},d.prototype.lookupEnum=function(e){var t=this.lookup(e,[o]);if(!t)throw Error("no such Enum '"+e+"' in "+this);return t},d.prototype.lookupTypeOrEnum=function(e){var t=this.lookup(e,[n,o]);if(!t)throw Error("no such Type or Enum '"+e+"' in "+this);return t},d.prototype.lookupService=function(e){var t=this.lookup(e,[r]);if(!t)throw Error("no such Service '"+e+"' in "+this);return t},d.v=function(e,t,s){n=e,r=t,o=s}},function(e,t,s){"use strict";var i=t,n=s(1),r=["double","float","int32","uint32","sint32","fixed32","sfixed32","int64","uint64","sint64","fixed64","sfixed64","bool","string","bytes"];function o(e,t){var s=0,i={};for(t|=0;s<e.length;)i[r[s+t]]=e[s++];return i}i.basic=o([1,5,0,0,0,5,5,0,0,0,1,1,0,2,2]),i.defaults=o([0,0,0,0,0,0,0,0,0,0,0,0,!1,"",n.emptyArray,null]),i.long=o([0,0,0,1,1],7),i.mapKey=o([0,0,0,5,5,0,0,0,1,1,0,2],2),i.packed=o([1,5,0,0,0,5,5,0,0,0,1,1,0])},function(e,t,s){"use strict";e.exports=o;var i=s(5);((o.prototype=Object.create(i.prototype)).constructor=o).className="OneOf";var n=s(6),r=s(1);function o(e,t,s,n){if(Array.isArray(t)||(s=t,t=void 0),i.call(this,e,s),void 0!==t&&!Array.isArray(t))throw TypeError("fieldNames must be an Array");this.oneof=t||[],this.fieldsArray=[],this.comment=n}function a(e){if(e.parent)for(var t=0;t<e.fieldsArray.length;++t)e.fieldsArray[t].parent||e.parent.add(e.fieldsArray[t])}o.fromJSON=function(e,t){return new o(e,t.oneof,t.options,t.comment)},o.prototype.toJSON=function(e){var t=!!e&&Boolean(e.keepComments);return r.toObject(["options",this.options,"oneof",this.oneof,"comment",t?this.comment:void 0])},o.prototype.add=function(e){if(!(e instanceof n))throw TypeError("field must be a Field");return e.parent&&e.parent!==this.parent&&e.parent.remove(e),this.oneof.push(e.name),this.fieldsArray.push(e),e.partOf=this,a(this),this},o.prototype.remove=function(e){if(!(e instanceof n))throw TypeError("field must be a Field");var t=this.fieldsArray.indexOf(e);if(t<0)throw Error(e+" is not a member of "+this);return this.fieldsArray.splice(t,1),(t=this.oneof.indexOf(e.name))>-1&&this.oneof.splice(t,1),e.partOf=null,this},o.prototype.onAdd=function(e){i.prototype.onAdd.call(this,e);for(var t=0;t<this.oneof.length;++t){var s=e.get(this.oneof[t]);s&&!s.partOf&&(s.partOf=this,this.fieldsArray.push(s))}a(this)},o.prototype.onRemove=function(e){for(var t,s=0;s<this.fieldsArray.length;++s)(t=this.fieldsArray[s]).parent&&t.parent.remove(t);i.prototype.onRemove.call(this,e)},o.d=function(){for(var e=new Array(arguments.length),t=0;t<arguments.length;)e[t]=arguments[t++];return function(t,s){r.decorateType(t.constructor).add(new o(s,e)),Object.defineProperty(t,s,{get:r.oneOfGetter(e),set:r.oneOfSetter(e)})}}},function(e,t,s){"use strict";e.exports=d;var i,n=s(2),r=n.LongBits,o=n.base64,a=n.utf8;function c(e,t,s){this.fn=e,this.len=t,this.next=void 0,this.val=s}function h(){}function u(e){this.head=e.head,this.tail=e.tail,this.len=e.len,this.next=e.states}function d(){this.len=0,this.head=new c(h,0,0),this.tail=this.head,this.states=null}var l=function(){return n.Buffer?function(){return(d.create=function(){return new i})()}:function(){return new d}};function p(e,t,s){t[s]=255&e}function f(e,t){this.len=e,this.next=void 0,this.val=t}function m(e,t,s){for(;e.hi;)t[s++]=127&e.lo|128,e.lo=(e.lo>>>7|e.hi<<25)>>>0,e.hi>>>=7;for(;e.lo>127;)t[s++]=127&e.lo|128,e.lo=e.lo>>>7;t[s++]=e.lo}function g(e,t,s){t[s]=255&e,t[s+1]=e>>>8&255,t[s+2]=e>>>16&255,t[s+3]=e>>>24}d.create=l(),d.alloc=function(e){return new n.Array(e)},n.Array!==Array&&(d.alloc=n.pool(d.alloc,n.Array.prototype.subarray)),d.prototype.C=function(e,t,s){return this.tail=this.tail.next=new c(e,t,s),this.len+=t,this},f.prototype=Object.create(c.prototype),f.prototype.fn=function(e,t,s){for(;e>127;)t[s++]=127&e|128,e>>>=7;t[s]=e},d.prototype.uint32=function(e){return this.len+=(this.tail=this.tail.next=new f((e>>>=0)<128?1:e<16384?2:e<2097152?3:e<268435456?4:5,e)).len,this},d.prototype.int32=function(e){return e<0?this.C(m,10,r.fromNumber(e)):this.uint32(e)},d.prototype.sint32=function(e){return this.uint32((e<<1^e>>31)>>>0)},d.prototype.uint64=function(e){var t=r.from(e);return this.C(m,t.length(),t)},d.prototype.int64=d.prototype.uint64,d.prototype.sint64=function(e){var t=r.from(e).zzEncode();return this.C(m,t.length(),t)},d.prototype.bool=function(e){return this.C(p,1,e?1:0)},d.prototype.fixed32=function(e){return this.C(g,4,e>>>0)},d.prototype.sfixed32=d.prototype.fixed32,d.prototype.fixed64=function(e){var t=r.from(e);return this.C(g,4,t.lo).C(g,4,t.hi)},d.prototype.sfixed64=d.prototype.fixed64,d.prototype.float=function(e){return this.C(n.float.writeFloatLE,4,e)},d.prototype.double=function(e){return this.C(n.float.writeDoubleLE,8,e)};var v=n.Array.prototype.set?function(e,t,s){t.set(e,s)}:function(e,t,s){for(var i=0;i<e.length;++i)t[s+i]=e[i]};d.prototype.bytes=function(e){var t=e.length>>>0;if(!t)return this.C(p,1,0);if(n.isString(e)){var s=d.alloc(t=o.length(e));o.decode(e,s,0),e=s}return this.uint32(t).C(v,t,e)},d.prototype.string=function(e){var t=a.length(e);return t?this.uint32(t).C(a.write,t,e):this.C(p,1,0)},d.prototype.fork=function(){return this.states=new u(this),this.head=this.tail=new c(h,0,0),this.len=0,this},d.prototype.reset=function(){return this.states?(this.head=this.states.head,this.tail=this.states.tail,this.len=this.states.len,this.states=this.states.next):(this.head=this.tail=new c(h,0,0),this.len=0),this},d.prototype.ldelim=function(){var e=this.head,t=this.tail,s=this.len;return this.reset().uint32(s),s&&(this.tail.next=e.next,this.tail=t,this.len+=s),this},d.prototype.finish=function(){for(var e=this.head.next,t=this.constructor.alloc(this.len),s=0;e;)e.fn(e.val,t,s),s+=e.len,e=e.next;return t},d.v=function(e){i=e,d.create=l(),i.v()}},function(e,t,s){"use strict";e.exports=c;var i,n=s(2),r=n.LongBits,o=n.utf8;function a(e,t){return RangeError("index out of range: "+e.pos+" + "+(t||1)+" > "+e.len)}function c(e){this.buf=e,this.pos=0,this.len=e.length}var h,u="undefined"!=typeof Uint8Array?function(e){if(e instanceof Uint8Array||Array.isArray(e))return new c(e);throw Error("illegal buffer")}:function(e){if(Array.isArray(e))return new c(e);throw Error("illegal buffer")},d=function(){return n.Buffer?function(e){return(c.create=function(e){return n.Buffer.isBuffer(e)?new i(e):u(e)})(e)}:u};function l(){var e=new r(0,0),t=0;if(!(this.len-this.pos>4)){for(;t<3;++t){if(this.pos>=this.len)throw a(this);if(e.lo=(e.lo|(127&this.buf[this.pos])<<7*t)>>>0,this.buf[this.pos++]<128)return e}return e.lo=(e.lo|(127&this.buf[this.pos++])<<7*t)>>>0,e}for(;t<4;++t)if(e.lo=(e.lo|(127&this.buf[this.pos])<<7*t)>>>0,this.buf[this.pos++]<128)return e;if(e.lo=(e.lo|(127&this.buf[this.pos])<<28)>>>0,e.hi=(e.hi|(127&this.buf[this.pos])>>4)>>>0,this.buf[this.pos++]<128)return e;if(t=0,this.len-this.pos>4){for(;t<5;++t)if(e.hi=(e.hi|(127&this.buf[this.pos])<<7*t+3)>>>0,this.buf[this.pos++]<128)return e}else for(;t<5;++t){if(this.pos>=this.len)throw a(this);if(e.hi=(e.hi|(127&this.buf[this.pos])<<7*t+3)>>>0,this.buf[this.pos++]<128)return e}throw Error("invalid varint encoding")}function p(e,t){return(e[t-4]|e[t-3]<<8|e[t-2]<<16|e[t-1]<<24)>>>0}function f(){if(this.pos+8>this.len)throw a(this,8);return new r(p(this.buf,this.pos+=4),p(this.buf,this.pos+=4))}c.create=d(),c.prototype.I=n.Array.prototype.subarray||n.Array.prototype.slice,c.prototype.uint32=(h=4294967295,function(){if(h=(127&this.buf[this.pos])>>>0,this.buf[this.pos++]<128)return h;if(h=(h|(127&this.buf[this.pos])<<7)>>>0,this.buf[this.pos++]<128)return h;if(h=(h|(127&this.buf[this.pos])<<14)>>>0,this.buf[this.pos++]<128)return h;if(h=(h|(127&this.buf[this.pos])<<21)>>>0,this.buf[this.pos++]<128)return h;if(h=(h|(15&this.buf[this.pos])<<28)>>>0,this.buf[this.pos++]<128)return h;if((this.pos+=5)>this.len)throw this.pos=this.len,a(this,10);return h}),c.prototype.int32=function(){return 0|this.uint32()},c.prototype.sint32=function(){var e=this.uint32();return e>>>1^-(1&e)|0},c.prototype.bool=function(){return 0!==this.uint32()},c.prototype.fixed32=function(){if(this.pos+4>this.len)throw a(this,4);return p(this.buf,this.pos+=4)},c.prototype.sfixed32=function(){if(this.pos+4>this.len)throw a(this,4);return 0|p(this.buf,this.pos+=4)},c.prototype.float=function(){if(this.pos+4>this.len)throw a(this,4);var e=n.float.readFloatLE(this.buf,this.pos);return this.pos+=4,e},c.prototype.double=function(){if(this.pos+8>this.len)throw a(this,4);var e=n.float.readDoubleLE(this.buf,this.pos);return this.pos+=8,e},c.prototype.bytes=function(){var e=this.uint32(),t=this.pos,s=this.pos+e;if(s>this.len)throw a(this,e);return this.pos+=e,Array.isArray(this.buf)?this.buf.slice(t,s):t===s?new this.buf.constructor(0):this.I.call(this.buf,t,s)},c.prototype.string=function(){var e=this.bytes();return o.read(e,0,e.length)},c.prototype.skip=function(e){if("number"==typeof e){if(this.pos+e>this.len)throw a(this,e);this.pos+=e}else do{if(this.pos>=this.len)throw a(this)}while(128&this.buf[this.pos++]);return this},c.prototype.skipType=function(e){switch(e){case 0:this.skip();break;case 1:this.skip(8);break;case 2:this.skip(this.uint32());break;case 3:for(;4!=(e=7&this.uint32());)this.skipType(e);break;case 5:this.skip(4);break;default:throw Error("invalid wire type "+e+" at offset "+this.pos)}return this},c.v=function(e){i=e,c.create=d(),i.v();var t=n.Long?"toLong":"toNumber";n.merge(c.prototype,{int64:function(){return l.call(this)[t](!1)},uint64:function(){return l.call(this)[t](!0)},sint64:function(){return l.call(this).zzDecode()[t](!1)},fixed64:function(){return f.call(this)[t](!0)},sfixed64:function(){return f.call(this)[t](!1)}})}},function(e,t,s){"use strict";e.exports=n;var i=s(2);function n(e){if(e)for(var t=Object.keys(e),s=0;s<t.length;++s)this[t[s]]=e[t[s]]}n.create=function(e){return this.$type.create(e)},n.encode=function(e,t){return this.$type.encode(e,t)},n.encodeDelimited=function(e,t){return this.$type.encodeDelimited(e,t)},n.decode=function(e){return this.$type.decode(e)},n.decodeDelimited=function(e){return this.$type.decodeDelimited(e)},n.verify=function(e){return this.$type.verify(e)},n.fromObject=function(e){return this.$type.fromObject(e)},n.toObject=function(e,t){return this.$type.toObject(e,t)},n.prototype.toJSON=function(){return this.$type.toObject(this,i.toJSONOptions)}},function(e,t,s){"use strict";e.exports=function(e,t){var s=new Array(arguments.length-1),i=0,n=2,r=!0;for(;n<arguments.length;)s[i++]=arguments[n++];return new Promise((function(n,o){s[i]=function(e){if(r)if(r=!1,e)o(e);else{for(var t=new Array(arguments.length-1),s=0;s<t.length;)t[s++]=arguments[s];n.apply(null,t)}};try{e.apply(t||null,s)}catch(e){r&&(r=!1,o(e))}}))}},function(module,exports,__webpack_require__){"use strict";function inquire(moduleName){try{var mod=eval("quire".replace(/^/,"re"))(moduleName);if(mod&&(mod.length||Object.keys(mod).length))return mod}catch(e){}return null}module.exports=inquire},function(e,t,s){"use strict";t.Service=s(40)},function(e,t,s){"use strict";e.exports={}},function(e,t,s){"use strict";e.exports=function(e){for(var t,s=r.codegen(["m","w"],e.name+"$encode")("if(!w)")("w=Writer.create()"),a=e.fieldsArray.slice().sort(r.compareFieldsById),c=0;c<a.length;++c){var h=a[c].resolve(),u=e._.indexOf(h),d=h.resolvedType instanceof i?"int32":h.type,l=n.basic[d];t="m"+r.safeProp(h.name),h.map?(s("if(%s!=null&&Object.hasOwnProperty.call(m,%j)){",t,h.name)("for(var ks=Object.keys(%s),i=0;i<ks.length;++i){",t)("w.uint32(%i).fork().uint32(%i).%s(ks[i])",(h.id<<3|2)>>>0,8|n.mapKey[h.keyType],h.keyType),void 0===l?s("types[%i].encode(%s[ks[i]],w.uint32(18).fork()).ldelim().ldelim()",u,t):s(".uint32(%i).%s(%s[ks[i]]).ldelim()",16|l,d,t),s("}")("}")):h.repeated?(s("if(%s!=null&&%s.length){",t,t),h.packed&&void 0!==n.packed[d]?s("w.uint32(%i).fork()",(h.id<<3|2)>>>0)("for(var i=0;i<%s.length;++i)",t)("w.%s(%s[i])",d,t)("w.ldelim()"):(s("for(var i=0;i<%s.length;++i)",t),void 0===l?o(s,h,u,t+"[i]"):s("w.uint32(%i).%s(%s[i])",(h.id<<3|l)>>>0,d,t)),s("}")):(h.optional&&s("if(%s!=null&&Object.hasOwnProperty.call(m,%j))",t,h.name),void 0===l?o(s,h,u,t):s("w.uint32(%i).%s(%s)",(h.id<<3|l)>>>0,d,t))}return s("return w")};var i=s(3),n=s(8),r=s(1);function o(e,t,s,i){return t.resolvedType.group?e("types[%i].encode(%s,w.uint32(%i)).uint32(%i)",s,i,(t.id<<3|3)>>>0,(t.id<<3|4)>>>0):e("types[%i].encode(%s,w.uint32(%i).fork()).ldelim()",s,i,(t.id<<3|2)>>>0)}},function(e,t,s){"use strict";e.exports=y;var i=s(7);((y.prototype=Object.create(i.prototype)).constructor=y).className="Type";var n=s(3),r=s(9),o=s(6),a=s(19),c=s(20),h=s(12),u=s(11),d=s(10),l=s(1),p=s(17),f=s(22),m=s(23),g=s(24),v=s(25);function y(e,t){i.call(this,e,t),this.fields={},this.oneofs=void 0,this.extensions=void 0,this.reserved=void 0,this.group=void 0,this.D=null,this._=null,this.T=null,this.j=null}function w(e){return e.D=e._=e.T=null,delete e.encode,delete e.decode,delete e.verify,e}Object.defineProperties(y.prototype,{fieldsById:{get:function(){if(this.D)return this.D;this.D={};for(var e=Object.keys(this.fields),t=0;t<e.length;++t){var s=this.fields[e[t]],i=s.id;if(this.D[i])throw Error("duplicate id "+i+" in "+this);this.D[i]=s}return this.D}},fieldsArray:{get:function(){return this._||(this._=l.toArray(this.fields))}},oneofsArray:{get:function(){return this.T||(this.T=l.toArray(this.oneofs))}},ctor:{get:function(){return this.j||(this.ctor=y.generateConstructor(this)())},set:function(e){var t=e.prototype;t instanceof h||((e.prototype=new h).constructor=e,l.merge(e.prototype,t)),e.$type=e.prototype.$type=this,l.merge(e,h,!0),this.j=e;for(var s=0;s<this.fieldsArray.length;++s)this._[s].resolve();var i={};for(s=0;s<this.oneofsArray.length;++s)i[this.T[s].resolve().name]={get:l.oneOfGetter(this.T[s].oneof),set:l.oneOfSetter(this.T[s].oneof)};s&&Object.defineProperties(e.prototype,i)}}}),y.generateConstructor=function(e){for(var t,s=l.codegen(["p"],e.name),i=0;i<e.fieldsArray.length;++i)(t=e._[i]).map?s("this%s={}",l.safeProp(t.name)):t.repeated&&s("this%s=[]",l.safeProp(t.name));return s("if(p)for(var ks=Object.keys(p),i=0;i<ks.length;++i)if(p[ks[i]]!=null)")("this[ks[i]]=p[ks[i]]")},y.fromJSON=function(e,t){var s=new y(e,t.options);s.extensions=t.extensions,s.reserved=t.reserved;for(var h=Object.keys(t.fields),u=0;u<h.length;++u)s.add((void 0!==t.fields[h[u]].keyType?a.fromJSON:o.fromJSON)(h[u],t.fields[h[u]]));if(t.oneofs)for(h=Object.keys(t.oneofs),u=0;u<h.length;++u)s.add(r.fromJSON(h[u],t.oneofs[h[u]]));if(t.nested)for(h=Object.keys(t.nested),u=0;u<h.length;++u){var d=t.nested[h[u]];s.add((void 0!==d.id?o.fromJSON:void 0!==d.fields?y.fromJSON:void 0!==d.values?n.fromJSON:void 0!==d.methods?c.fromJSON:i.fromJSON)(h[u],d))}return t.extensions&&t.extensions.length&&(s.extensions=t.extensions),t.reserved&&t.reserved.length&&(s.reserved=t.reserved),t.group&&(s.group=!0),t.comment&&(s.comment=t.comment),s},y.prototype.toJSON=function(e){var t=i.prototype.toJSON.call(this,e),s=!!e&&Boolean(e.keepComments);return l.toObject(["options",t&&t.options||void 0,"oneofs",i.arrayToJSON(this.oneofsArray,e),"fields",i.arrayToJSON(this.fieldsArray.filter((function(e){return!e.declaringField})),e)||{},"extensions",this.extensions&&this.extensions.length?this.extensions:void 0,"reserved",this.reserved&&this.reserved.length?this.reserved:void 0,"group",this.group||void 0,"nested",t&&t.nested||void 0,"comment",s?this.comment:void 0])},y.prototype.resolveAll=function(){for(var e=this.fieldsArray,t=0;t<e.length;)e[t++].resolve();var s=this.oneofsArray;for(t=0;t<s.length;)s[t++].resolve();return i.prototype.resolveAll.call(this)},y.prototype.get=function(e){return this.fields[e]||this.oneofs&&this.oneofs[e]||this.nested&&this.nested[e]||null},y.prototype.add=function(e){if(this.get(e.name))throw Error("duplicate name '"+e.name+"' in "+this);if(e instanceof o&&void 0===e.extend){if(this.D?this.D[e.id]:this.fieldsById[e.id])throw Error("duplicate id "+e.id+" in "+this);if(this.isReservedId(e.id))throw Error("id "+e.id+" is reserved in "+this);if(this.isReservedName(e.name))throw Error("name '"+e.name+"' is reserved in "+this);return e.parent&&e.parent.remove(e),this.fields[e.name]=e,e.message=this,e.onAdd(this),w(this)}return e instanceof r?(this.oneofs||(this.oneofs={}),this.oneofs[e.name]=e,e.onAdd(this),w(this)):i.prototype.add.call(this,e)},y.prototype.remove=function(e){if(e instanceof o&&void 0===e.extend){if(!this.fields||this.fields[e.name]!==e)throw Error(e+" is not a member of "+this);return delete this.fields[e.name],e.parent=null,e.onRemove(this),w(this)}if(e instanceof r){if(!this.oneofs||this.oneofs[e.name]!==e)throw Error(e+" is not a member of "+this);return delete this.oneofs[e.name],e.parent=null,e.onRemove(this),w(this)}return i.prototype.remove.call(this,e)},y.prototype.isReservedId=function(e){return i.isReservedId(this.reserved,e)},y.prototype.isReservedName=function(e){return i.isReservedName(this.reserved,e)},y.prototype.create=function(e){return new this.ctor(e)},y.prototype.setup=function(){for(var e=this.fullName,t=[],s=0;s<this.fieldsArray.length;++s)t.push(this._[s].resolve().resolvedType);this.encode=p(this)({Writer:d,types:t,util:l}),this.decode=f(this)({Reader:u,types:t,util:l}),this.verify=m(this)({types:t,util:l}),this.fromObject=g.fromObject(this)({types:t,util:l}),this.toObject=g.toObject(this)({types:t,util:l});var i=v[e];if(i){var n=Object.create(this);n.fromObject=this.fromObject,this.fromObject=i.fromObject.bind(n),n.toObject=this.toObject,this.toObject=i.toObject.bind(n)}return this},y.prototype.encode=function(e,t){return this.setup().encode(e,t)},y.prototype.encodeDelimited=function(e,t){return this.encode(e,t&&t.len?t.fork():t).ldelim()},y.prototype.decode=function(e,t){return this.setup().decode(e,t)},y.prototype.decodeDelimited=function(e){return e instanceof u||(e=u.create(e)),this.decode(e,e.uint32())},y.prototype.verify=function(e){return this.setup().verify(e)},y.prototype.fromObject=function(e){return this.setup().fromObject(e)},y.prototype.toObject=function(e,t){return this.setup().toObject(e,t)},y.d=function(e){return function(t){l.decorateType(t,e)}}},function(e,t,s){"use strict";e.exports=o;var i=s(6);((o.prototype=Object.create(i.prototype)).constructor=o).className="MapField";var n=s(8),r=s(1);function o(e,t,s,n,o,a){if(i.call(this,e,t,n,void 0,void 0,o,a),!r.isString(s))throw TypeError("keyType must be a string");this.keyType=s,this.resolvedKeyType=null,this.map=!0}o.fromJSON=function(e,t){return new o(e,t.id,t.keyType,t.type,t.options,t.comment)},o.prototype.toJSON=function(e){var t=!!e&&Boolean(e.keepComments);return r.toObject(["keyType",this.keyType,"type",this.type,"id",this.id,"extend",this.extend,"options",this.options,"comment",t?this.comment:void 0])},o.prototype.resolve=function(){if(this.resolved)return this;if(void 0===n.mapKey[this.keyType])throw Error("invalid key type: "+this.keyType);return i.prototype.resolve.call(this)},o.d=function(e,t,s){return"function"==typeof s?s=r.decorateType(s).name:s&&"object"==typeof s&&(s=r.decorateEnum(s).name),function(i,n){r.decorateType(i.constructor).add(new o(n,e,t,s))}}},function(e,t,s){"use strict";e.exports=a;var i=s(7);((a.prototype=Object.create(i.prototype)).constructor=a).className="Service";var n=s(21),r=s(1),o=s(15);function a(e,t){i.call(this,e,t),this.methods={},this.A=null}function c(e){return e.A=null,e}a.fromJSON=function(e,t){var s=new a(e,t.options);if(t.methods)for(var i=Object.keys(t.methods),r=0;r<i.length;++r)s.add(n.fromJSON(i[r],t.methods[i[r]]));return t.nested&&s.addJSON(t.nested),s.comment=t.comment,s},a.prototype.toJSON=function(e){var t=i.prototype.toJSON.call(this,e),s=!!e&&Boolean(e.keepComments);return r.toObject(["options",t&&t.options||void 0,"methods",i.arrayToJSON(this.methodsArray,e)||{},"nested",t&&t.nested||void 0,"comment",s?this.comment:void 0])},Object.defineProperty(a.prototype,"methodsArray",{get:function(){return this.A||(this.A=r.toArray(this.methods))}}),a.prototype.get=function(e){return this.methods[e]||i.prototype.get.call(this,e)},a.prototype.resolveAll=function(){for(var e=this.methodsArray,t=0;t<e.length;++t)e[t].resolve();return i.prototype.resolve.call(this)},a.prototype.add=function(e){if(this.get(e.name))throw Error("duplicate name '"+e.name+"' in "+this);return e instanceof n?(this.methods[e.name]=e,e.parent=this,c(this)):i.prototype.add.call(this,e)},a.prototype.remove=function(e){if(e instanceof n){if(this.methods[e.name]!==e)throw Error(e+" is not a member of "+this);return delete this.methods[e.name],e.parent=null,c(this)}return i.prototype.remove.call(this,e)},a.prototype.create=function(e,t,s){for(var i,n=new o.Service(e,t,s),a=0;a<this.methodsArray.length;++a){var c=r.lcFirst((i=this.A[a]).resolve().name).replace(/[^$\w_]/g,"");n[c]=r.codegen(["r","c"],r.isReserved(c)?c+"_":c)("return this.rpcCall(m,q,s,r,c)")({m:i,q:i.resolvedRequestType.ctor,s:i.resolvedResponseType.ctor})}return n}},function(e,t,s){"use strict";e.exports=r;var i=s(5);((r.prototype=Object.create(i.prototype)).constructor=r).className="Method";var n=s(1);function r(e,t,s,r,o,a,c,h,u){if(n.isObject(o)?(c=o,o=a=void 0):n.isObject(a)&&(c=a,a=void 0),void 0!==t&&!n.isString(t))throw TypeError("type must be a string");if(!n.isString(s))throw TypeError("requestType must be a string");if(!n.isString(r))throw TypeError("responseType must be a string");i.call(this,e,c),this.type=t||"rpc",this.requestType=s,this.requestStream=!!o||void 0,this.responseType=r,this.responseStream=!!a||void 0,this.resolvedRequestType=null,this.resolvedResponseType=null,this.comment=h,this.parsedOptions=u}r.fromJSON=function(e,t){return new r(e,t.type,t.requestType,t.responseType,t.requestStream,t.responseStream,t.options,t.comment,t.parsedOptions)},r.prototype.toJSON=function(e){var t=!!e&&Boolean(e.keepComments);return n.toObject(["type","rpc"!==this.type&&this.type||void 0,"requestType",this.requestType,"requestStream",this.requestStream,"responseType",this.responseType,"responseStream",this.responseStream,"options",this.options,"comment",t?this.comment:void 0,"parsedOptions",this.parsedOptions])},r.prototype.resolve=function(){return this.resolved?this:(this.resolvedRequestType=this.parent.lookupType(this.requestType),this.resolvedResponseType=this.parent.lookupType(this.responseType),i.prototype.resolve.call(this))}},function(e,t,s){"use strict";e.exports=function(e){var t=r.codegen(["r","l"],e.name+"$decode")("if(!(r instanceof Reader))")("r=Reader.create(r)")("var c=l===undefined?r.len:r.pos+l,m=new this.ctor"+(e.fieldsArray.filter((function(e){return e.map})).length?",k,value":""))("while(r.pos<c){")("var t=r.uint32()");e.group&&t("if((t&7)===4)")("break");t("switch(t>>>3){");for(var s=0;s<e.fieldsArray.length;++s){var a=e._[s].resolve(),c=a.resolvedType instanceof i?"int32":a.type,h="m"+r.safeProp(a.name);t("case %i:",a.id),a.map?(t("if(%s===util.emptyObject)",h)("%s={}",h)("var c2 = r.uint32()+r.pos"),void 0!==n.defaults[a.keyType]?t("k=%j",n.defaults[a.keyType]):t("k=null"),void 0!==n.defaults[c]?t("value=%j",n.defaults[c]):t("value=null"),t("while(r.pos<c2){")("var tag2=r.uint32()")("switch(tag2>>>3){")("case 1: k=r.%s(); break",a.keyType)("case 2:"),void 0===n.basic[c]?t("value=types[%i].decode(r,r.uint32())",s):t("value=r.%s()",c),t("break")("default:")("r.skipType(tag2&7)")("break")("}")("}"),void 0!==n.long[a.keyType]?t('%s[typeof k==="object"?util.longToHash(k):k]=value',h):t("%s[k]=value",h)):a.repeated?(t("if(!(%s&&%s.length))",h,h)("%s=[]",h),void 0!==n.packed[c]&&t("if((t&7)===2){")("var c2=r.uint32()+r.pos")("while(r.pos<c2)")("%s.push(r.%s())",h,c)("}else"),void 0===n.basic[c]?t(a.resolvedType.group?"%s.push(types[%i].decode(r))":"%s.push(types[%i].decode(r,r.uint32()))",h,s):t("%s.push(r.%s())",h,c)):void 0===n.basic[c]?t(a.resolvedType.group?"%s=types[%i].decode(r)":"%s=types[%i].decode(r,r.uint32())",h,s):t("%s=r.%s()",h,c),t("break")}for(t("default:")("r.skipType(t&7)")("break")("}")("}"),s=0;s<e._.length;++s){var u=e._[s];u.required&&t("if(!m.hasOwnProperty(%j))",u.name)("throw util.ProtocolError(%j,{instance:m})",o(u))}return t("return m")};var i=s(3),n=s(8),r=s(1);function o(e){return"missing required '"+e.name+"'"}},function(e,t,s){"use strict";e.exports=function(e){var t=n.codegen(["m"],e.name+"$verify")('if(typeof m!=="object"||m===null)')("return%j","object expected"),s=e.oneofsArray,i={};s.length&&t("var p={}");for(var c=0;c<e.fieldsArray.length;++c){var h=e._[c].resolve(),u="m"+n.safeProp(h.name);if(h.optional&&t("if(%s!=null&&m.hasOwnProperty(%j)){",u,h.name),h.map)t("if(!util.isObject(%s))",u)("return%j",r(h,"object"))("var k=Object.keys(%s)",u)("for(var i=0;i<k.length;++i){"),a(t,h,"k[i]"),o(t,h,c,u+"[k[i]]")("}");else if(h.repeated)t("if(!Array.isArray(%s))",u)("return%j",r(h,"array"))("for(var i=0;i<%s.length;++i){",u),o(t,h,c,u+"[i]")("}");else{if(h.partOf){var d=n.safeProp(h.partOf.name);1===i[h.partOf.name]&&t("if(p%s===1)",d)("return%j",h.partOf.name+": multiple values"),i[h.partOf.name]=1,t("p%s=1",d)}o(t,h,c,u)}h.optional&&t("}")}return t("return null")};var i=s(3),n=s(1);function r(e,t){return e.name+": "+t+(e.repeated&&"array"!==t?"[]":e.map&&"object"!==t?"{k:"+e.keyType+"}":"")+" expected"}function o(e,t,s,n){if(t.resolvedType)if(t.resolvedType instanceof i){e("switch(%s){",n)("default:")("return%j",r(t,"enum value"));for(var o=Object.keys(t.resolvedType.values),a=0;a<o.length;++a)e("case %i:",t.resolvedType.values[o[a]]);e("break")("}")}else e("{")("var e=types[%i].verify(%s);",s,n)("if(e)")("return%j+e",t.name+".")("}");else switch(t.type){case"int32":case"uint32":case"sint32":case"fixed32":case"sfixed32":e("if(!util.isInteger(%s))",n)("return%j",r(t,"integer"));break;case"int64":case"uint64":case"sint64":case"fixed64":case"sfixed64":e("if(!util.isInteger(%s)&&!(%s&&util.isInteger(%s.low)&&util.isInteger(%s.high)))",n,n,n,n)("return%j",r(t,"integer|Long"));break;case"float":case"double":e('if(typeof %s!=="number")',n)("return%j",r(t,"number"));break;case"bool":e('if(typeof %s!=="boolean")',n)("return%j",r(t,"boolean"));break;case"string":e("if(!util.isString(%s))",n)("return%j",r(t,"string"));break;case"bytes":e('if(!(%s&&typeof %s.length==="number"||util.isString(%s)))',n,n,n)("return%j",r(t,"buffer"))}return e}function a(e,t,s){switch(t.keyType){case"int32":case"uint32":case"sint32":case"fixed32":case"sfixed32":e("if(!util.key32Re.test(%s))",s)("return%j",r(t,"integer key"));break;case"int64":case"uint64":case"sint64":case"fixed64":case"sfixed64":e("if(!util.key64Re.test(%s))",s)("return%j",r(t,"integer|Long key"));break;case"bool":e("if(!util.key2Re.test(%s))",s)("return%j",r(t,"boolean key"))}return e}},function(e,t,s){"use strict";var i=t,n=s(3),r=s(1);function o(e,t,s,i){if(t.resolvedType)if(t.resolvedType instanceof n){e("switch(d%s){",i);for(var r=t.resolvedType.values,o=Object.keys(r),a=0;a<o.length;++a)t.repeated&&r[o[a]]===t.typeDefault&&e("default:"),e("case%j:",o[a])("case %i:",r[o[a]])("m%s=%j",i,r[o[a]])("break");e("}")}else e('if(typeof d%s!=="object")',i)("throw TypeError(%j)",t.fullName+": object expected")("m%s=types[%i].fromObject(d%s)",i,s,i);else{var c=!1;switch(t.type){case"double":case"float":e("m%s=Number(d%s)",i,i);break;case"uint32":case"fixed32":e("m%s=d%s>>>0",i,i);break;case"int32":case"sint32":case"sfixed32":e("m%s=d%s|0",i,i);break;case"uint64":c=!0;case"int64":case"sint64":case"fixed64":case"sfixed64":e("if(util.Long)")("(m%s=util.Long.fromValue(d%s)).unsigned=%j",i,i,c)('else if(typeof d%s==="string")',i)("m%s=parseInt(d%s,10)",i,i)('else if(typeof d%s==="number")',i)("m%s=d%s",i,i)('else if(typeof d%s==="object")',i)("m%s=new util.LongBits(d%s.low>>>0,d%s.high>>>0).toNumber(%s)",i,i,i,c?"true":"");break;case"bytes":e('if(typeof d%s==="string")',i)("util.base64.decode(d%s,m%s=util.newBuffer(util.base64.length(d%s)),0)",i,i,i)("else if(d%s.length)",i)("m%s=d%s",i,i);break;case"string":e("m%s=String(d%s)",i,i);break;case"bool":e("m%s=Boolean(d%s)",i,i)}}return e}function a(e,t,s,i){if(t.resolvedType)t.resolvedType instanceof n?e("d%s=o.enums===String?types[%i].values[m%s]:m%s",i,s,i,i):e("d%s=types[%i].toObject(m%s,o)",i,s,i);else{var r=!1;switch(t.type){case"double":case"float":e("d%s=o.json&&!isFinite(m%s)?String(m%s):m%s",i,i,i,i);break;case"uint64":r=!0;case"int64":case"sint64":case"fixed64":case"sfixed64":e('if(typeof m%s==="number")',i)("d%s=o.longs===String?String(m%s):m%s",i,i,i)("else")("d%s=o.longs===String?util.Long.prototype.toString.call(m%s):o.longs===Number?new util.LongBits(m%s.low>>>0,m%s.high>>>0).toNumber(%s):m%s",i,i,i,i,r?"true":"",i);break;case"bytes":e("d%s=o.bytes===String?util.base64.encode(m%s,0,m%s.length):o.bytes===Array?Array.prototype.slice.call(m%s):m%s",i,i,i,i,i);break;default:e("d%s=m%s",i,i)}}return e}i.fromObject=function(e){var t=e.fieldsArray,s=r.codegen(["d"],e.name+"$fromObject")("if(d instanceof this.ctor)")("return d");if(!t.length)return s("return new this.ctor");s("var m=new this.ctor");for(var i=0;i<t.length;++i){var a=t[i].resolve(),c=r.safeProp(a.name);a.map?(s("if(d%s){",c)('if(typeof d%s!=="object")',c)("throw TypeError(%j)",a.fullName+": object expected")("m%s={}",c)("for(var ks=Object.keys(d%s),i=0;i<ks.length;++i){",c),o(s,a,i,c+"[ks[i]]")("}")("}")):a.repeated?(s("if(d%s){",c)("if(!Array.isArray(d%s))",c)("throw TypeError(%j)",a.fullName+": array expected")("m%s=[]",c)("for(var i=0;i<d%s.length;++i){",c),o(s,a,i,c+"[i]")("}")("}")):(a.resolvedType instanceof n||s("if(d%s!=null){",c),o(s,a,i,c),a.resolvedType instanceof n||s("}"))}return s("return m")},i.toObject=function(e){var t=e.fieldsArray.slice().sort(r.compareFieldsById);if(!t.length)return r.codegen()("return {}");for(var s=r.codegen(["m","o"],e.name+"$toObject")("if(!o)")("o={}")("var d={}"),i=[],o=[],c=[],h=0;h<t.length;++h)t[h].partOf||(t[h].resolve().repeated?i:t[h].map?o:c).push(t[h]);if(i.length){for(s("if(o.arrays||o.defaults){"),h=0;h<i.length;++h)s("d%s=[]",r.safeProp(i[h].name));s("}")}if(o.length){for(s("if(o.objects||o.defaults){"),h=0;h<o.length;++h)s("d%s={}",r.safeProp(o[h].name));s("}")}if(c.length){for(s("if(o.defaults){"),h=0;h<c.length;++h){var u=c[h],d=r.safeProp(u.name);if(u.resolvedType instanceof n)s("d%s=o.enums===String?%j:%j",d,u.resolvedType.valuesById[u.typeDefault],u.typeDefault);else if(u.long)s("if(util.Long){")("var n=new util.Long(%i,%i,%j)",u.typeDefault.low,u.typeDefault.high,u.typeDefault.unsigned)("d%s=o.longs===String?n.toString():o.longs===Number?n.toNumber():n",d)("}else")("d%s=o.longs===String?%j:%i",d,u.typeDefault.toString(),u.typeDefault.toNumber());else if(u.bytes){var l="["+Array.prototype.slice.call(u.typeDefault).join(",")+"]";s("if(o.bytes===String)d%s=%j",d,String.fromCharCode.apply(String,u.typeDefault))("else{")("d%s=%s",d,l)("if(o.bytes!==Array)d%s=util.newBuffer(d%s)",d,d)("}")}else s("d%s=%j",d,u.typeDefault)}s("}")}var p=!1;for(h=0;h<t.length;++h){u=t[h];var f=e._.indexOf(u);d=r.safeProp(u.name);u.map?(p||(p=!0,s("var ks2")),s("if(m%s&&(ks2=Object.keys(m%s)).length){",d,d)("d%s={}",d)("for(var j=0;j<ks2.length;++j){"),a(s,u,f,d+"[ks2[j]]")("}")):u.repeated?(s("if(m%s&&m%s.length){",d,d)("d%s=[]",d)("for(var j=0;j<m%s.length;++j){",d),a(s,u,f,d+"[j]")("}")):(s("if(m%s!=null&&m.hasOwnProperty(%j)){",d,u.name),a(s,u,f,d),u.partOf&&s("if(o.oneofs)")("d%s=%j",r.safeProp(u.partOf.name),u.name)),s("}")}return s("return d")}},function(e,t,s){"use strict";var i=t,n=s(12);i[".google.protobuf.Any"]={fromObject:function(e){if(e&&e["@type"]){var t=e["@type"].substring(e["@type"].lastIndexOf("/")+1),s=this.lookup(t);if(s){var i="."===e["@type"].charAt(0)?e["@type"].substr(1):e["@type"];return-1===i.indexOf("/")&&(i="/"+i),this.create({type_url:i,value:s.encode(s.fromObject(e)).finish()})}}return this.fromObject(e)},toObject:function(e,t){var s="",i="";if(t&&t.json&&e.type_url&&e.value){i=e.type_url.substring(e.type_url.lastIndexOf("/")+1),s=e.type_url.substring(0,e.type_url.lastIndexOf("/")+1);var r=this.lookup(i);r&&(e=r.decode(e.value))}if(!(e instanceof this.ctor)&&e instanceof n){var o=e.$type.toObject(e,t);return""===s&&(s="type.googleapis.com/"),i=s+("."===e.$type.fullName[0]?e.$type.fullName.substr(1):e.$type.fullName),o["@type"]=i,o}return this.toObject(e,t)}}},function(e,t,s){"use strict";e.exports=d;var i=s(7);((d.prototype=Object.create(i.prototype)).constructor=d).className="Root";var n,r,o,a=s(6),c=s(3),h=s(9),u=s(1);function d(e){i.call(this,"",e),this.deferred=[],this.files=[]}function l(){}d.fromJSON=function(e,t){return t||(t=new d),e.options&&t.setOptions(e.options),t.addJSON(e.nested)},d.prototype.resolvePath=u.path.resolve,d.prototype.fetch=u.fetch,d.prototype.load=function e(t,s,i){"function"==typeof s&&(i=s,s=void 0);var n=this;if(!i)return u.asPromise(e,n,t,s);var a=i===l;function c(e,t){if(i){var s=i;if(i=null,a)throw e;s(e,t)}}function h(e){var t=e.lastIndexOf("google/protobuf/");if(t>-1){var s=e.substring(t);if(s in o)return s}return null}function d(e,t){try{if(u.isString(t)&&"{"===t.charAt(0)&&(t=JSON.parse(t)),u.isString(t)){r.filename=e;var i,o=r(t,n,s),d=0;if(o.imports)for(;d<o.imports.length;++d)(i=h(o.imports[d])||n.resolvePath(e,o.imports[d]))&&p(i);if(o.weakImports)for(d=0;d<o.weakImports.length;++d)(i=h(o.weakImports[d])||n.resolvePath(e,o.weakImports[d]))&&p(i,!0)}else n.setOptions(t.options).addJSON(t.nested)}catch(e){c(e)}a||f||c(null,n)}function p(e,t){if(!(n.files.indexOf(e)>-1))if(n.files.push(e),e in o)a?d(e,o[e]):(++f,setTimeout((function(){--f,d(e,o[e])})));else if(a){var s;try{s=u.fs.readFileSync(e).toString("utf8")}catch(e){return void(t||c(e))}d(e,s)}else++f,n.fetch(e,(function(s,r){--f,i&&(s?t?f||c(null,n):c(s):d(e,r))}))}var f=0;u.isString(t)&&(t=[t]);for(var m,g=0;g<t.length;++g)(m=n.resolvePath("",t[g]))&&p(m);if(a)return n;f||c(null,n)},d.prototype.loadSync=function(e,t){if(!u.isNode)throw Error("not supported");return this.load(e,t,l)},d.prototype.resolveAll=function(){if(this.deferred.length)throw Error("unresolvable extensions: "+this.deferred.map((function(e){return"'extend "+e.extend+"' in "+e.parent.fullName})).join(", "));return i.prototype.resolveAll.call(this)};var p=/^[A-Z]/;function f(e,t){var s=t.parent.lookup(t.extend);if(s){var i=new a(t.fullName,t.id,t.type,t.rule,void 0,t.options);return i.declaringField=t,t.extensionField=i,s.add(i),!0}return!1}d.prototype.O=function(e){if(e instanceof a)void 0===e.extend||e.extensionField||f(0,e)||this.deferred.push(e);else if(e instanceof c)p.test(e.name)&&(e.parent[e.name]=e.values);else if(!(e instanceof h)){if(e instanceof n)for(var t=0;t<this.deferred.length;)f(0,this.deferred[t])?this.deferred.splice(t,1):++t;for(var s=0;s<e.nestedArray.length;++s)this.O(e.S[s]);p.test(e.name)&&(e.parent[e.name]=e)}},d.prototype.R=function(e){if(e instanceof a){if(void 0!==e.extend)if(e.extensionField)e.extensionField.parent.remove(e.extensionField),e.extensionField=null;else{var t=this.deferred.indexOf(e);t>-1&&this.deferred.splice(t,1)}}else if(e instanceof c)p.test(e.name)&&delete e.parent[e.name];else if(e instanceof i){for(var s=0;s<e.nestedArray.length;++s)this.R(e.S[s]);p.test(e.name)&&delete e.parent[e.name]}},d.v=function(e,t,s){n=e,r=t,o=s}},function(e){e.exports=JSON.parse('{"nested":{"com":{"nested":{"convergencelabs":{"nested":{"convergence":{"nested":{"proto":{"nested":{"ConvergenceMessage":{"oneofs":{"body":{"oneof":["ok","error","ping","pong","connectionRequest","connectionResponse","serverTimeRequest","serverTimeResponse","openRealTimeModelRequest","openRealTimeModelResponse","closeRealTimeModelRequest","closeRealTimeModelResponse","createRealTimeModelRequest","createRealTimeModelResponse","deleteRealtimeModelRequest","deleteRealtimeModelResponse","forceCloseRealTimeModel","remoteClientOpenedModel","remoteClientClosedModel","modelAutoCreateConfigRequest","modelAutoCreateConfigResponse","remoteOperation","operationSubmission","operationAck","shareReference","setReference","clearReference","unshareReference","referenceShared","referenceSet","referenceCleared","referenceUnshared","modelsQueryRequest","modelsQueryResponse","getModelPermissionsRequest","getModelPermissionsResponse","setModelPermissionsRequest","setModelPermissionsResponse","modelPermissionsChanged","modelResyncRequest","modelResyncResponse","modelResyncClientComplete","modelResyncServerComplete","remoteClientResyncStarted","remoteClientResyncCompleted","modelOfflineSubscriptionChange","modelOfflineUpdated","historicalDataRequest","historicalDataResponse","historicalOperationsRequest","historicalOperationsResponse","modelGetVersionAtTimeRequest","modelGetVersionAtTimeResponse","identityCacheUpdate","usersGetRequest","userSearchRequest","userListResponse","userGroupsRequest","userGroupsResponse","userGroupsForUsersRequest","userGroupsForUsersResponse","activityParticipantsRequest","activityParticipantsResponse","activityCreateRequest","activityDeleteRequest","activityJoinRequest","activityJoinResponse","activityLeaveRequest","activitySessionJoined","activitySessionLeft","activityUpdateState","activityStateUpdated","activityDeleted","activityForceLeave","presenceSetState","presenceRemoveState","presenceClearState","presenceStateSet","presenceStateRemoved","presenceStateCleared","presenceAvailabilityChanged","presenceRequest","presenceResponse","presenceSubscribeRequest","presenceSubscribeResponse","presenceUnsubscribe","createChatRequest","createChatResponse","removeChatRequest","removeChatResponse","chatRemoved","getChatsRequest","getChatsResponse","chatsExistRequest","chatsExistResponse","getDirectChatsRequest","getDirectChatsResponse","getJoinedChatsRequest","getJoinedChatsResponse","chatsSearchRequest","chatsSearchResponse","joinChatRequest","joinChatResponse","userJoinedChat","leaveChatRequest","leaveChatResponse","userLeftChat","addUserToChatRequest","addUserToChatResponse","userAddedToChat","removeUserFromChatRequest","removeUserFromChatResponse","userRemovedFromChat","setChatNameRequest","setChatNameResponse","chatNameChanged","setChatTopicRequest","setChatTopicResponse","chatTopicChanged","markChatEventsSeenRequest","markChatEventsSeenResponse","chatEventsMarkedSeen","publishChatMessageRequest","publishChatMessageResponse","remoteChatMessage","getChatHistoryRequest","getChatHistoryResponse","resolvePermissionsForConnectedSessionRequest","resolvePermissionsForConnectedSessionResponse","addPermissionsRequest","removePermissionsRequest","setPermissionsRequest","getPermissionsRequest","getPermissionsResponse"]}},"fields":{"requestId":{"type":"google.protobuf.Int32Value","id":1},"responseId":{"type":"google.protobuf.Int32Value","id":2},"ok":{"type":"core.OkResponse","id":3},"error":{"type":"core.ErrorMessage","id":4},"ping":{"type":"core.PingMessage","id":5},"pong":{"type":"core.PongMessage","id":6},"connectionRequest":{"type":"core.ConnectionRequestMessage","id":7},"connectionResponse":{"type":"core.ConnectionResponseMessage","id":8},"serverTimeRequest":{"type":"core.GetServerTimeRequestMessage","id":20},"serverTimeResponse":{"type":"core.GetServerTimeResponseMessage","id":21},"openRealTimeModelRequest":{"type":"model.OpenRealtimeModelRequestMessage","id":100},"openRealTimeModelResponse":{"type":"model.OpenRealtimeModelResponseMessage","id":101},"closeRealTimeModelRequest":{"type":"model.CloseRealtimeModelRequestMessage","id":102},"closeRealTimeModelResponse":{"type":"model.CloseRealTimeModelResponseMessage","id":103},"createRealTimeModelRequest":{"type":"model.CreateRealtimeModelRequestMessage","id":104},"createRealTimeModelResponse":{"type":"model.CreateRealtimeModelResponseMessage","id":105},"deleteRealtimeModelRequest":{"type":"model.DeleteRealtimeModelRequestMessage","id":106},"deleteRealtimeModelResponse":{"type":"model.DeleteRealtimeModelResponseMessage","id":107},"forceCloseRealTimeModel":{"type":"model.ModelForceCloseMessage","id":108},"remoteClientOpenedModel":{"type":"model.RemoteClientOpenedMessage","id":109},"remoteClientClosedModel":{"type":"model.RemoteClientClosedMessage","id":110},"modelAutoCreateConfigRequest":{"type":"model.AutoCreateModelConfigRequestMessage","id":111},"modelAutoCreateConfigResponse":{"type":"model.AutoCreateModelConfigResponseMessage","id":112},"remoteOperation":{"type":"model.RemoteOperationMessage","id":113},"operationSubmission":{"type":"model.OperationSubmissionMessage","id":114},"operationAck":{"type":"model.OperationAcknowledgementMessage","id":115},"shareReference":{"type":"model.ShareReferenceMessage","id":116},"setReference":{"type":"model.SetReferenceMessage","id":117},"clearReference":{"type":"model.ClearReferenceMessage","id":118},"unshareReference":{"type":"model.UnshareReferenceMessage","id":119},"referenceShared":{"type":"model.RemoteReferenceSharedMessage","id":120},"referenceSet":{"type":"model.RemoteReferenceSetMessage","id":121},"referenceCleared":{"type":"model.RemoteReferenceClearedMessage","id":122},"referenceUnshared":{"type":"model.RemoteReferenceUnsharedMessage","id":123},"modelsQueryRequest":{"type":"model.ModelsQueryRequestMessage","id":124},"modelsQueryResponse":{"type":"model.ModelsQueryResponseMessage","id":125},"getModelPermissionsRequest":{"type":"model.GetModelPermissionsRequestMessage","id":126},"getModelPermissionsResponse":{"type":"model.GetModelPermissionsResponseMessage","id":127},"setModelPermissionsRequest":{"type":"model.SetModelPermissionsRequestMessage","id":128},"setModelPermissionsResponse":{"type":"model.SetModelPermissionsResponseMessage","id":129},"modelPermissionsChanged":{"type":"model.ModelPermissionsChangedMessage","id":130},"modelResyncRequest":{"type":"model.ModelResyncRequestMessage","id":131},"modelResyncResponse":{"type":"model.ModelResyncResponseMessage","id":132},"modelResyncClientComplete":{"type":"model.ModelResyncClientCompleteMessage","id":133},"modelResyncServerComplete":{"type":"model.ModelResyncServerCompleteMessage","id":134},"remoteClientResyncStarted":{"type":"model.RemoteClientResyncStartedMessage","id":135},"remoteClientResyncCompleted":{"type":"model.RemoteClientResyncCompletedMessage","id":136},"modelOfflineSubscriptionChange":{"type":"model.ModelOfflineSubscriptionChangeRequestMessage","id":137},"modelOfflineUpdated":{"type":"model.OfflineModelUpdatedMessage","id":138},"historicalDataRequest":{"type":"model.HistoricalDataRequestMessage","id":139},"historicalDataResponse":{"type":"model.HistoricalDataResponseMessage","id":140},"historicalOperationsRequest":{"type":"model.HistoricalOperationRequestMessage","id":141},"historicalOperationsResponse":{"type":"model.HistoricalOperationsResponseMessage","id":142},"modelGetVersionAtTimeRequest":{"type":"model.ModelGetVersionAtTimeRequestMessage","id":143},"modelGetVersionAtTimeResponse":{"type":"model.ModelGetVersionAtTimeResponseMessage","id":144},"identityCacheUpdate":{"type":"identity.IdentityCacheUpdateMessage","id":200},"usersGetRequest":{"type":"identity.GetUsersRequestMessage","id":201},"userSearchRequest":{"type":"identity.SearchUsersRequestMessage","id":202},"userListResponse":{"type":"identity.UserListMessage","id":203},"userGroupsRequest":{"type":"identity.UserGroupsRequestMessage","id":204},"userGroupsResponse":{"type":"identity.UserGroupsResponseMessage","id":205},"userGroupsForUsersRequest":{"type":"identity.UserGroupsForUsersRequestMessage","id":206},"userGroupsForUsersResponse":{"type":"identity.UserGroupsForUsersResponseMessage","id":207},"activityParticipantsRequest":{"type":"activity.ActivityParticipantsRequestMessage","id":300},"activityParticipantsResponse":{"type":"activity.ActivityParticipantsResponseMessage","id":301},"activityCreateRequest":{"type":"activity.ActivityCreateRequestMessage","id":302},"activityDeleteRequest":{"type":"activity.ActivityDeleteRequestMessage","id":304},"activityJoinRequest":{"type":"activity.ActivityJoinRequestMessage","id":306},"activityJoinResponse":{"type":"activity.ActivityJoinResponseMessage","id":307},"activityLeaveRequest":{"type":"activity.ActivityLeaveRequestMessage","id":308},"activitySessionJoined":{"type":"activity.ActivitySessionJoinedMessage","id":310},"activitySessionLeft":{"type":"activity.ActivitySessionLeftMessage","id":311},"activityUpdateState":{"type":"activity.ActivityUpdateStateMessage","id":312},"activityStateUpdated":{"type":"activity.ActivityStateUpdatedMessage","id":313},"activityDeleted":{"type":"activity.ActivityDeletedMessage","id":314},"activityForceLeave":{"type":"activity.ActivityForceLeaveMessage","id":315},"presenceSetState":{"type":"presence.PresenceSetStateMessage","id":400},"presenceRemoveState":{"type":"presence.PresenceRemoveStateMessage","id":401},"presenceClearState":{"type":"presence.PresenceClearStateMessage","id":402},"presenceStateSet":{"type":"presence.PresenceStateSetMessage","id":403},"presenceStateRemoved":{"type":"presence.PresenceStateRemovedMessage","id":404},"presenceStateCleared":{"type":"presence.PresenceStateClearedMessage","id":405},"presenceAvailabilityChanged":{"type":"presence.PresenceAvailabilityChangedMessage","id":406},"presenceRequest":{"type":"presence.PresenceRequestMessage","id":407},"presenceResponse":{"type":"presence.PresenceResponseMessage","id":408},"presenceSubscribeRequest":{"type":"presence.SubscribePresenceRequestMessage","id":409},"presenceSubscribeResponse":{"type":"presence.SubscribePresenceResponseMessage","id":410},"presenceUnsubscribe":{"type":"presence.UnsubscribePresenceMessage","id":411},"createChatRequest":{"type":"chat.CreateChatRequestMessage","id":500},"createChatResponse":{"type":"chat.CreateChatResponseMessage","id":501},"removeChatRequest":{"type":"chat.RemoveChatRequestMessage","id":502},"removeChatResponse":{"type":"chat.RemoveChatResponseMessage","id":503},"chatRemoved":{"type":"chat.ChatRemovedMessage","id":504},"getChatsRequest":{"type":"chat.GetChatsRequestMessage","id":505},"getChatsResponse":{"type":"chat.GetChatsResponseMessage","id":506},"chatsExistRequest":{"type":"chat.ChatsExistRequestMessage","id":507},"chatsExistResponse":{"type":"chat.ChatsExistResponseMessage","id":508},"getDirectChatsRequest":{"type":"chat.GetDirectChatsRequestMessage","id":509},"getDirectChatsResponse":{"type":"chat.GetDirectChatsResponseMessage","id":510},"getJoinedChatsRequest":{"type":"chat.GetJoinedChatsRequestMessage","id":511},"getJoinedChatsResponse":{"type":"chat.GetJoinedChatsResponseMessage","id":512},"chatsSearchRequest":{"type":"chat.ChatsSearchRequestMessage","id":513},"chatsSearchResponse":{"type":"chat.ChatsSearchResponseMessage","id":514},"joinChatRequest":{"type":"chat.JoinChatRequestMessage","id":515},"joinChatResponse":{"type":"chat.JoinChatResponseMessage","id":516},"userJoinedChat":{"type":"chat.UserJoinedChatMessage","id":517},"leaveChatRequest":{"type":"chat.LeaveChatRequestMessage","id":518},"leaveChatResponse":{"type":"chat.LeaveChatResponseMessage","id":519},"userLeftChat":{"type":"chat.UserLeftChatMessage","id":520},"addUserToChatRequest":{"type":"chat.AddUserToChatRequestMessage","id":521},"addUserToChatResponse":{"type":"chat.AddUserToChatResponseMessage","id":522},"userAddedToChat":{"type":"chat.UserAddedToChatMessage","id":523},"removeUserFromChatRequest":{"type":"chat.RemoveUserFromChatRequestMessage","id":524},"removeUserFromChatResponse":{"type":"chat.RemoveUserFromChatResponseMessage","id":525},"userRemovedFromChat":{"type":"chat.UserRemovedFromChatMessage","id":526},"setChatNameRequest":{"type":"chat.SetChatNameRequestMessage","id":527},"setChatNameResponse":{"type":"chat.SetChatNameResponseMessage","id":528},"chatNameChanged":{"type":"chat.ChatNameSetMessage","id":529},"setChatTopicRequest":{"type":"chat.SetChatTopicRequestMessage","id":530},"setChatTopicResponse":{"type":"chat.SetChatTopicResponseMessage","id":531},"chatTopicChanged":{"type":"chat.ChatTopicSetMessage","id":532},"markChatEventsSeenRequest":{"type":"chat.MarkChatEventsSeenRequestMessage","id":533},"markChatEventsSeenResponse":{"type":"chat.MarkChatEventsSeenResponseMessage","id":534},"chatEventsMarkedSeen":{"type":"chat.ChatEventsMarkedSeenMessage","id":535},"publishChatMessageRequest":{"type":"chat.PublishChatRequestMessage","id":536},"publishChatMessageResponse":{"type":"chat.PublishChatResponseMessage","id":537},"remoteChatMessage":{"type":"chat.RemoteChatMessageMessage","id":538},"getChatHistoryRequest":{"type":"chat.ChatHistoryRequestMessage","id":539},"getChatHistoryResponse":{"type":"chat.ChatHistoryResponseMessage","id":540},"resolvePermissionsForConnectedSessionRequest":{"type":"core.ResolvePermissionsForConnectedSessionRequestMessage","id":601},"resolvePermissionsForConnectedSessionResponse":{"type":"core.ResolvePermissionsForConnectedSessionResponseMessage","id":602},"addPermissionsRequest":{"type":"core.AddPermissionsRequestMessage","id":603},"removePermissionsRequest":{"type":"core.RemovePermissionsRequestMessage","id":605},"setPermissionsRequest":{"type":"core.SetPermissionsRequestMessage","id":607},"getPermissionsRequest":{"type":"core.GetPermissionsRequestMessage","id":609},"getPermissionsResponse":{"type":"core.GetPermissionsResponseMessage","id":610}}},"core":{"nested":{"PingMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{}},"PongMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{}},"ConnectionRequestMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ClientMessage"},"oneofs":{"auth":{"oneof":["password","jwt","anonymous","reconnect"]}},"fields":{"client":{"type":"string","id":1},"clientVersion":{"type":"string","id":2},"password":{"type":"PasswordAuthRequestData","id":3},"jwt":{"type":"JwtAuthRequestData","id":4},"anonymous":{"type":"AnonymousAuthRequestData","id":5},"reconnect":{"type":"ReconnectTokenAuthRequestData","id":6}},"nested":{"PasswordAuthRequestData":{"fields":{"username":{"type":"string","id":1},"password":{"type":"string","id":2}}},"JwtAuthRequestData":{"fields":{"jwt":{"type":"string","id":1}}},"ReconnectTokenAuthRequestData":{"fields":{"token":{"type":"string","id":1}}},"AnonymousAuthRequestData":{"fields":{"displayName":{"type":"google.protobuf.StringValue","id":1}}}}},"ConnectionResponseMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"oneofs":{"response":{"oneof":["success","failure"]}},"fields":{"server":{"type":"ServerData","id":1},"success":{"type":"ConnectionSuccessData","id":3},"failure":{"type":"ConnectionFailureData","id":4}},"nested":{"ServerData":{"fields":{"version":{"type":"string","id":1}}},"ConnectionSuccessData":{"fields":{"namespace":{"type":"string","id":1},"domainId":{"type":"string","id":2},"user":{"type":"DomainUserData","id":3},"sessionId":{"type":"string","id":4},"reconnectToken":{"type":"string","id":5},"presenceState":{"keyType":"string","type":"google.protobuf.Value","id":6}}},"ConnectionFailureData":{"fields":{"code":{"type":"string","id":1},"details":{"type":"string","id":2},"retryOk":{"type":"bool","id":3}}}}},"DomainUserTypeData":{"values":{"Normal":0,"Convergence":1,"Anonymous":2}},"DomainUserIdData":{"fields":{"userType":{"type":"DomainUserTypeData","id":1},"username":{"type":"string","id":2}}},"DomainUserIdList":{"fields":{"values":{"rule":"repeated","type":"DomainUserIdData","id":1}}},"DomainUserData":{"fields":{"userId":{"type":"DomainUserIdData","id":1},"firstName":{"type":"google.protobuf.StringValue","id":2},"lastName":{"type":"google.protobuf.StringValue","id":3},"displayName":{"type":"google.protobuf.StringValue","id":4},"email":{"type":"google.protobuf.StringValue","id":5},"disabled":{"type":"bool","id":6},"deleted":{"type":"bool","id":7},"deletedUsername":{"type":"google.protobuf.StringValue","id":8}}},"UserPermissionsEntry":{"fields":{"user":{"type":"DomainUserIdData","id":1},"permissions":{"rule":"repeated","type":"string","id":2}}},"PermissionsList":{"fields":{"values":{"rule":"repeated","type":"string","id":1}}},"PermissionTarget":{"oneofs":{"targetType":{"oneof":["chat","activity"]}},"fields":{"chat":{"type":"Chat","id":1},"activity":{"type":"Activity","id":2}},"nested":{"Chat":{"fields":{"id":{"type":"string","id":1}}},"Activity":{"fields":{"type":{"type":"string","id":1},"id":{"type":"string","id":2}}}}},"AddPermissionsRequestMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ClientMessage"},"fields":{"target":{"type":"PermissionTarget","id":1},"world":{"rule":"repeated","type":"string","id":2},"user":{"rule":"repeated","type":"UserPermissionsEntry","id":3},"group":{"keyType":"string","type":"PermissionsList","id":4}}},"RemovePermissionsRequestMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ClientMessage"},"fields":{"target":{"type":"PermissionTarget","id":1},"world":{"rule":"repeated","type":"string","id":2},"user":{"rule":"repeated","type":"UserPermissionsEntry","id":3},"group":{"keyType":"string","type":"PermissionsList","id":4}}},"SetPermissionsRequestMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ClientMessage"},"fields":{"target":{"type":"PermissionTarget","id":1},"world":{"type":"SetWorld","id":2},"user":{"type":"SetUser","id":3},"group":{"type":"SetGroup","id":4}},"nested":{"SetWorld":{"fields":{"permissions":{"rule":"repeated","type":"string","id":1}}},"SetUser":{"fields":{"permissions":{"rule":"repeated","type":"UserPermissionsEntry","id":1},"replaceAll":{"type":"bool","id":2}}},"SetGroup":{"fields":{"permissions":{"keyType":"string","type":"PermissionsList","id":1},"replaceAll":{"type":"bool","id":2}}}}},"GetPermissionsRequestMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ClientMessage"},"fields":{"target":{"type":"PermissionTarget","id":1}}},"GetPermissionsResponseMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{"user":{"rule":"repeated","type":"UserPermissionsEntry","id":1},"group":{"keyType":"string","type":"PermissionsList","id":2},"world":{"rule":"repeated","type":"string","id":3}}},"ResolvePermissionsForConnectedSessionRequestMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ClientMessage"},"fields":{"target":{"type":"PermissionTarget","id":1}}},"ResolvePermissionsForConnectedSessionResponseMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{"permissions":{"rule":"repeated","type":"string","id":1}}},"ErrorMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{"code":{"type":"string","id":1},"message":{"type":"string","id":2},"details":{"keyType":"string","type":"google.protobuf.Value","id":3}}},"OkResponse":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{}},"GetServerTimeRequestMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ClientMessage"},"fields":{}},"GetServerTimeResponseMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{"serverTime":{"type":"google.protobuf.Timestamp","id":1}}},"StringList":{"fields":{"values":{"rule":"repeated","type":"string","id":1}}},"Int32List":{"fields":{"values":{"rule":"repeated","type":"int32","id":1}}}}},"activity":{"nested":{"ActivityCreateRequestMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ClientMessage"},"fields":{"activityType":{"type":"string","id":1},"activityId":{"type":"string","id":2},"worldPermissions":{"rule":"repeated","type":"string","id":3},"userPermissions":{"rule":"repeated","type":"core.UserPermissionsEntry","id":4},"groupPermissions":{"keyType":"string","type":"core.PermissionsList","id":5}}},"ActivityDeleteRequestMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ClientMessage"},"fields":{"activityType":{"type":"string","id":1},"activityId":{"type":"string","id":2}}},"ActivityParticipantsRequestMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ClientMessage"},"fields":{"activityType":{"type":"string","id":1},"activityId":{"type":"string","id":2}}},"ActivityParticipantsResponseMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{"state":{"keyType":"string","type":"ActivityStateData","id":1}}},"ActivityJoinRequestMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ClientMessage"},"fields":{"activityType":{"type":"string","id":1},"activityId":{"type":"string","id":2},"lurk":{"type":"bool","id":3},"state":{"keyType":"string","type":"google.protobuf.Value","id":4},"autoCreateData":{"type":"AutoCreateData","id":5}},"nested":{"AutoCreateData":{"fields":{"ephemeral":{"type":"bool","id":1},"worldPermissions":{"rule":"repeated","type":"string","id":3},"userPermissions":{"rule":"repeated","type":"core.UserPermissionsEntry","id":4},"groupPermissions":{"keyType":"string","type":"core.PermissionsList","id":5}}}}},"ActivityJoinResponseMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{"resourceId":{"type":"int32","id":1},"state":{"keyType":"string","type":"ActivityStateData","id":2},"ephemeral":{"type":"bool","id":3},"created":{"type":"google.protobuf.Timestamp","id":5}}},"ActivityLeaveRequestMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.RequestMessage"},"fields":{"resourceId":{"type":"int32","id":1}}},"ActivityUpdateStateMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ClientMessage"},"fields":{"resourceId":{"type":"int32","id":1},"set":{"keyType":"string","type":"google.protobuf.Value","id":2},"complete":{"type":"bool","id":3},"removed":{"rule":"repeated","type":"string","id":4}}},"ActivitySessionJoinedMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{"resourceId":{"type":"int32","id":1},"sessionId":{"type":"string","id":2},"state":{"keyType":"string","type":"google.protobuf.Value","id":3}}},"ActivitySessionLeftMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{"resourceId":{"type":"int32","id":1},"sessionId":{"type":"string","id":2}}},"ActivityStateUpdatedMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{"resourceId":{"type":"int32","id":1},"sessionId":{"type":"string","id":2},"set":{"keyType":"string","type":"google.protobuf.Value","id":3},"complete":{"type":"bool","id":4},"removed":{"rule":"repeated","type":"string","id":5}}},"ActivityDeletedMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{"resourceId":{"type":"int32","id":1}}},"ActivityForceLeaveMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{"resourceId":{"type":"int32","id":1},"reason":{"type":"string","id":2}}},"ActivityStateData":{"fields":{"state":{"keyType":"string","type":"google.protobuf.Value","id":1}}}}},"chat":{"nested":{"PublishChatRequestMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ClientMessage"},"fields":{"chatId":{"type":"string","id":1},"message":{"type":"string","id":2}}},"PublishChatResponseMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{"eventNumber":{"type":"int64","id":1},"timestamp":{"type":"google.protobuf.Timestamp","id":2}}},"RemoteChatMessageMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{"chatId":{"type":"string","id":1},"eventNumber":{"type":"int64","id":2},"timestamp":{"type":"google.protobuf.Timestamp","id":3},"user":{"type":"com.convergencelabs.convergence.proto.core.DomainUserIdData","id":4},"message":{"type":"string","id":5}}},"CreateChatRequestMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ClientMessage"},"fields":{"chatId":{"type":"google.protobuf.StringValue","id":1},"chatType":{"type":"string","id":2},"membership":{"type":"string","id":3},"name":{"type":"string","id":4},"topic":{"type":"string","id":5},"members":{"rule":"repeated","type":"com.convergencelabs.convergence.proto.core.DomainUserIdData","id":6}}},"CreateChatResponseMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{"chatId":{"type":"string","id":1}}},"RemoveChatRequestMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ClientMessage"},"fields":{"chatId":{"type":"string","id":1}}},"RemoveChatResponseMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{}},"ChatRemovedMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{"chatId":{"type":"string","id":1}}},"JoinChatRequestMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ClientMessage"},"fields":{"chatId":{"type":"string","id":1}}},"JoinChatResponseMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{"chatInfo":{"type":"ChatInfoData","id":1}}},"UserJoinedChatMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{"chatId":{"type":"string","id":1},"eventNumber":{"type":"int64","id":2},"timestamp":{"type":"google.protobuf.Timestamp","id":3},"user":{"type":"com.convergencelabs.convergence.proto.core.DomainUserIdData","id":4}}},"AddUserToChatRequestMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ClientMessage"},"fields":{"chatId":{"type":"string","id":1},"userToAdd":{"type":"com.convergencelabs.convergence.proto.core.DomainUserIdData","id":2}}},"AddUserToChatResponseMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{}},"UserAddedToChatMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{"chatId":{"type":"string","id":1},"eventNumber":{"type":"int64","id":2},"timestamp":{"type":"google.protobuf.Timestamp","id":3},"user":{"type":"com.convergencelabs.convergence.proto.core.DomainUserIdData","id":4},"addedUser":{"type":"com.convergencelabs.convergence.proto.core.DomainUserIdData","id":5}}},"ChatJoinedMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{"chatId":{"type":"string","id":1}}},"LeaveChatRequestMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ClientMessage"},"fields":{"chatId":{"type":"string","id":1}}},"LeaveChatResponseMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{}},"UserLeftChatMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{"chatId":{"type":"string","id":1},"eventNumber":{"type":"int64","id":2},"timestamp":{"type":"google.protobuf.Timestamp","id":3},"user":{"type":"com.convergencelabs.convergence.proto.core.DomainUserIdData","id":4}}},"RemoveUserFromChatRequestMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ClientMessage"},"fields":{"chatId":{"type":"string","id":1},"userToRemove":{"type":"com.convergencelabs.convergence.proto.core.DomainUserIdData","id":2}}},"RemoveUserFromChatResponseMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{}},"UserRemovedFromChatMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{"chatId":{"type":"string","id":1},"eventNumber":{"type":"int64","id":2},"timestamp":{"type":"google.protobuf.Timestamp","id":3},"user":{"type":"com.convergencelabs.convergence.proto.core.DomainUserIdData","id":4},"removedUser":{"type":"com.convergencelabs.convergence.proto.core.DomainUserIdData","id":5}}},"ChatLeftMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{"chatId":{"type":"string","id":1}}},"SetChatNameRequestMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ClientMessage"},"fields":{"chatId":{"type":"string","id":1},"name":{"type":"string","id":2}}},"SetChatNameResponseMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{}},"ChatNameSetMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{"chatId":{"type":"string","id":1},"eventNumber":{"type":"int64","id":2},"timestamp":{"type":"google.protobuf.Timestamp","id":3},"user":{"type":"com.convergencelabs.convergence.proto.core.DomainUserIdData","id":4},"name":{"type":"string","id":5}}},"SetChatTopicRequestMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ClientMessage"},"fields":{"chatId":{"type":"string","id":1},"topic":{"type":"string","id":2}}},"SetChatTopicResponseMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{}},"ChatTopicSetMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{"chatId":{"type":"string","id":1},"eventNumber":{"type":"int64","id":2},"timestamp":{"type":"google.protobuf.Timestamp","id":3},"user":{"type":"com.convergencelabs.convergence.proto.core.DomainUserIdData","id":4},"topic":{"type":"string","id":5}}},"MarkChatEventsSeenRequestMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ClientMessage"},"fields":{"chatId":{"type":"string","id":1},"eventNumber":{"type":"int64","id":2}}},"MarkChatEventsSeenResponseMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{}},"ChatEventsMarkedSeenMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{"chatId":{"type":"string","id":1},"user":{"type":"com.convergencelabs.convergence.proto.core.DomainUserIdData","id":2},"eventNumber":{"type":"int64","id":3}}},"GetJoinedChatsRequestMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ClientMessage"},"fields":{}},"GetJoinedChatsResponseMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{"chatInfo":{"rule":"repeated","type":"ChatInfoData","id":1}}},"GetChatsRequestMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ClientMessage"},"fields":{"chatIds":{"rule":"repeated","type":"string","id":1}}},"GetChatsResponseMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{"chatInfo":{"rule":"repeated","type":"ChatInfoData","id":1}}},"GetDirectChatsRequestMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ClientMessage"},"fields":{"userLists":{"rule":"repeated","type":"com.convergencelabs.convergence.proto.core.DomainUserIdList","id":1}}},"GetDirectChatsResponseMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{"chatInfo":{"rule":"repeated","type":"ChatInfoData","id":1}}},"ChatHistoryRequestMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ClientMessage"},"fields":{"chatId":{"type":"string","id":1},"offset":{"type":"google.protobuf.Int64Value","id":2},"limit":{"type":"google.protobuf.Int64Value","id":3},"startEvent":{"type":"google.protobuf.Int64Value","id":4},"forward":{"type":"google.protobuf.BoolValue","id":5},"eventFilter":{"rule":"repeated","type":"string","id":6}}},"ChatHistoryResponseMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{"data":{"rule":"repeated","type":"ChatEventData","id":1},"startIndex":{"type":"int64","id":2},"totalResults":{"type":"int64","id":3}}},"ChatsExistRequestMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ClientMessage"},"fields":{"chatIds":{"rule":"repeated","type":"string","id":1}}},"ChatsExistResponseMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{"exists":{"rule":"repeated","type":"bool","id":1}}},"ChatsSearchRequestMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ClientMessage"},"fields":{"searchTerm":{"type":"string","id":1},"searchFields":{"rule":"repeated","type":"string","id":2},"types":{"rule":"repeated","type":"string","id":3},"membership":{"type":"string","id":4},"offset":{"type":"google.protobuf.Int64Value","id":5},"limit":{"type":"google.protobuf.Int64Value","id":6}}},"ChatsSearchResponseMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{"data":{"rule":"repeated","type":"ChatInfoData","id":1},"startIndex":{"type":"int64","id":2},"totalResults":{"type":"int64","id":3}}},"ChatMemberData":{"fields":{"user":{"type":"com.convergencelabs.convergence.proto.core.DomainUserIdData","id":1},"maxSeenEventNumber":{"type":"int64","id":2}}},"ChatInfoData":{"fields":{"id":{"type":"string","id":1},"chatType":{"type":"string","id":2},"membership":{"type":"string","id":3},"name":{"type":"string","id":4},"topic":{"type":"string","id":5},"createdTime":{"type":"google.protobuf.Timestamp","id":6},"lastEventTime":{"type":"google.protobuf.Timestamp","id":7},"lastEventNumber":{"type":"int64","id":8},"members":{"rule":"repeated","type":"ChatMemberData","id":9}}},"ChatCreatedEventData":{"fields":{"chatId":{"type":"string","id":1},"eventNumber":{"type":"int64","id":2},"timestamp":{"type":"google.protobuf.Timestamp","id":3},"user":{"type":"com.convergencelabs.convergence.proto.core.DomainUserIdData","id":4},"name":{"type":"string","id":5},"topic":{"type":"string","id":6},"members":{"rule":"repeated","type":"com.convergencelabs.convergence.proto.core.DomainUserIdData","id":7}}},"ChatMessageEventData":{"fields":{"chatId":{"type":"string","id":1},"eventNumber":{"type":"int64","id":2},"timestamp":{"type":"google.protobuf.Timestamp","id":3},"user":{"type":"com.convergencelabs.convergence.proto.core.DomainUserIdData","id":4},"message":{"type":"string","id":5}}},"ChatUserJoinedEventData":{"fields":{"chatId":{"type":"string","id":1},"eventNumber":{"type":"int64","id":2},"timestamp":{"type":"google.protobuf.Timestamp","id":3},"user":{"type":"com.convergencelabs.convergence.proto.core.DomainUserIdData","id":4}}},"ChatUserLeftEventData":{"fields":{"chatId":{"type":"string","id":1},"eventNumber":{"type":"int64","id":2},"timestamp":{"type":"google.protobuf.Timestamp","id":3},"user":{"type":"com.convergencelabs.convergence.proto.core.DomainUserIdData","id":4}}},"ChatUserAddedEventData":{"fields":{"chatId":{"type":"string","id":1},"eventNumber":{"type":"int64","id":2},"timestamp":{"type":"google.protobuf.Timestamp","id":3},"user":{"type":"com.convergencelabs.convergence.proto.core.DomainUserIdData","id":4},"addedUser":{"type":"com.convergencelabs.convergence.proto.core.DomainUserIdData","id":5}}},"ChatUserRemovedEventData":{"fields":{"chatId":{"type":"string","id":1},"eventNumber":{"type":"int64","id":2},"timestamp":{"type":"google.protobuf.Timestamp","id":3},"user":{"type":"com.convergencelabs.convergence.proto.core.DomainUserIdData","id":4},"removedUser":{"type":"com.convergencelabs.convergence.proto.core.DomainUserIdData","id":5}}},"ChatNameChangedEventData":{"fields":{"chatId":{"type":"string","id":1},"eventNumber":{"type":"int64","id":2},"timestamp":{"type":"google.protobuf.Timestamp","id":3},"user":{"type":"com.convergencelabs.convergence.proto.core.DomainUserIdData","id":4},"name":{"type":"string","id":5}}},"ChatTopicChangedEventData":{"fields":{"chatId":{"type":"string","id":1},"eventNumber":{"type":"int64","id":2},"timestamp":{"type":"google.protobuf.Timestamp","id":3},"user":{"type":"com.convergencelabs.convergence.proto.core.DomainUserIdData","id":4},"topic":{"type":"string","id":5}}},"ChatEventData":{"oneofs":{"event":{"oneof":["created","message","userJoined","userLeft","userAdded","userRemoved","nameChanged","topicChanged"]}},"fields":{"created":{"type":"ChatCreatedEventData","id":1},"message":{"type":"ChatMessageEventData","id":2},"userJoined":{"type":"ChatUserJoinedEventData","id":3},"userLeft":{"type":"ChatUserLeftEventData","id":4},"userAdded":{"type":"ChatUserAddedEventData","id":5},"userRemoved":{"type":"ChatUserRemovedEventData","id":6},"nameChanged":{"type":"ChatNameChangedEventData","id":7},"topicChanged":{"type":"ChatTopicChangedEventData","id":8}}}}},"identity":{"nested":{"GetUsersRequestMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.IdentityMessage"},"fields":{"userIds":{"rule":"repeated","type":"com.convergencelabs.convergence.proto.core.DomainUserIdData","id":1}}},"SearchUsersRequestMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.IdentityMessage"},"fields":{"fields":{"rule":"repeated","type":"UserField","id":1},"value":{"type":"string","id":2},"offset":{"type":"google.protobuf.Int32Value","id":3},"limit":{"type":"google.protobuf.Int32Value","id":4},"orderField":{"type":"UserField","id":5},"ascending":{"type":"bool","id":6}}},"UserListMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.IdentityMessage"},"fields":{"userData":{"rule":"repeated","type":"com.convergencelabs.convergence.proto.core.DomainUserData","id":1}}},"UserGroupsRequestMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.IdentityMessage"},"fields":{"ids":{"rule":"repeated","type":"string","id":1}}},"UserGroupsResponseMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.IdentityMessage"},"fields":{"groupData":{"rule":"repeated","type":"UserGroupData","id":1}}},"UserGroupsForUsersRequestMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.IdentityMessage"},"fields":{"users":{"rule":"repeated","type":"com.convergencelabs.convergence.proto.core.DomainUserIdData","id":1}}},"UserGroupsForUsersResponseMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.IdentityMessage"},"fields":{"userGroups":{"rule":"repeated","type":"UserGroupsEntry","id":1}}},"IdentityCacheUpdateMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.IdentityMessage"},"fields":{"sessions":{"keyType":"string","type":"com.convergencelabs.convergence.proto.core.DomainUserIdData","id":1},"users":{"rule":"repeated","type":"com.convergencelabs.convergence.proto.core.DomainUserData","id":2}}},"UserField":{"values":{"FIELD_NOT_SET":0,"USERNAME":1,"EMAIL":2,"FIRST_NAME":3,"LAST_NAME":4,"DISPLAY_NAME":5}},"UserGroupData":{"fields":{"id":{"type":"string","id":1},"description":{"type":"string","id":2},"members":{"rule":"repeated","type":"com.convergencelabs.convergence.proto.core.DomainUserIdData","id":3}}},"UserGroupsEntry":{"fields":{"user":{"type":"com.convergencelabs.convergence.proto.core.DomainUserIdData","id":1},"groups":{"rule":"repeated","type":"string","id":2}}}}},"model":{"nested":{"OpenRealtimeModelRequestMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ClientMessage"},"fields":{"modelId":{"type":"google.protobuf.StringValue","id":1},"autoCreateId":{"type":"google.protobuf.Int32Value","id":2}}},"OpenRealtimeModelResponseMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{"resourceId":{"type":"int32","id":1},"modelId":{"type":"string","id":2},"collection":{"type":"string","id":3},"valueIdPrefix":{"type":"string","id":4},"version":{"type":"int64","id":5},"createdTime":{"type":"google.protobuf.Timestamp","id":6},"modifiedTime":{"type":"google.protobuf.Timestamp","id":7},"data":{"type":"ObjectValue","id":8},"connectedClients":{"rule":"repeated","type":"string","id":9},"resyncingClients":{"rule":"repeated","type":"string","id":10},"references":{"rule":"repeated","type":"ReferenceData","id":11},"permissions":{"type":"ModelPermissionsData","id":12}}},"CloseRealtimeModelRequestMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ClientMessage"},"fields":{"resourceId":{"type":"int32","id":1}}},"CloseRealTimeModelResponseMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{}},"AutoCreateModelConfigRequestMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{"autoCreateId":{"type":"int32","id":1}}},"AutoCreateModelConfigResponseMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ClientMessage"},"fields":{"collection":{"type":"string","id":1},"data":{"type":"ObjectValue","id":2},"overridePermissions":{"type":"bool","id":3},"worldPermissions":{"type":"ModelPermissionsData","id":4},"userPermissions":{"rule":"repeated","type":"UserModelPermissionsData","id":5},"ephemeral":{"type":"bool","id":6}}},"RemoteClientClosedMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{"resourceId":{"type":"int32","id":1},"sessionId":{"type":"string","id":2}}},"RemoteClientOpenedMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{"resourceId":{"type":"int32","id":1},"sessionId":{"type":"string","id":2}}},"ModelForceCloseMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{"resourceId":{"type":"int32","id":1},"reason":{"type":"string","id":2},"reasonCode":{"type":"int32","id":3}}},"CreateRealtimeModelRequestMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ClientMessage"},"fields":{"collectionId":{"type":"string","id":1},"modelId":{"type":"google.protobuf.StringValue","id":2},"data":{"type":"ObjectValue","id":3},"createdTime":{"type":"google.protobuf.Timestamp","id":4},"overrideWorldPermissions":{"type":"bool","id":5},"worldPermissions":{"type":"ModelPermissionsData","id":6},"userPermissions":{"rule":"repeated","type":"UserModelPermissionsData","id":7}}},"CreateRealtimeModelResponseMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{"modelId":{"type":"string","id":1}}},"DeleteRealtimeModelRequestMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ClientMessage"},"fields":{"modelId":{"type":"string","id":1}}},"DeleteRealtimeModelResponseMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{}},"ModelResyncRequestMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ClientMessage"},"fields":{"modelId":{"type":"string","id":1},"contextVersion":{"type":"int64","id":2}}},"ModelResyncResponseMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{"resourceId":{"type":"int32","id":1},"currentVersion":{"type":"int64","id":2},"permissions":{"type":"ModelPermissionsData","id":3}}},"ModelResyncClientCompleteMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ClientMessage"},"fields":{"resourceId":{"type":"int32","id":1},"open":{"type":"bool","id":2}}},"ModelResyncServerCompleteMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{"resourceId":{"type":"int32","id":1},"connectedClients":{"rule":"repeated","type":"string","id":2},"resyncingClients":{"rule":"repeated","type":"string","id":3},"references":{"rule":"repeated","type":"ReferenceData","id":4}}},"RemoteClientResyncStartedMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{"resourceId":{"type":"int32","id":1},"sessionId":{"type":"string","id":2}}},"RemoteClientResyncCompletedMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{"resourceId":{"type":"int32","id":1},"sessionId":{"type":"string","id":2}}},"GetModelPermissionsRequestMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ClientMessage"},"fields":{"modelId":{"type":"string","id":1}}},"GetModelPermissionsResponseMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{"overridesCollection":{"type":"bool","id":1},"worldPermissions":{"type":"ModelPermissionsData","id":2},"userPermissions":{"rule":"repeated","type":"UserModelPermissionsData","id":3}}},"SetModelPermissionsRequestMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ClientMessage"},"fields":{"modelId":{"type":"string","id":1},"overrideCollection":{"type":"google.protobuf.BoolValue","id":2},"worldPermissions":{"type":"ModelPermissionsData","id":3},"removeAllUserPermissionsBeforeSet":{"type":"bool","id":4},"setUserPermissions":{"rule":"repeated","type":"UserModelPermissionsData","id":5},"removedUserPermissions":{"rule":"repeated","type":"com.convergencelabs.convergence.proto.core.DomainUserIdData","id":6}}},"SetModelPermissionsResponseMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{}},"ModelPermissionsChangedMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{"resourceId":{"type":"int32","id":1},"permissions":{"type":"ModelPermissionsData","id":2}}},"ModelsQueryRequestMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ClientMessage"},"fields":{"query":{"type":"string","id":1}}},"ModelsQueryResponseMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{"models":{"rule":"repeated","type":"ModelResult","id":1},"offset":{"type":"int64","id":2},"totalResults":{"type":"int64","id":3}},"nested":{"ModelResult":{"fields":{"collectionId":{"type":"string","id":1},"modelId":{"type":"string","id":2},"createdTime":{"type":"google.protobuf.Timestamp","id":3},"modifiedTime":{"type":"google.protobuf.Timestamp","id":4},"version":{"type":"int64","id":5},"data":{"type":"google.protobuf.Struct","id":6}}}}},"OperationSubmissionMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ClientMessage"},"fields":{"resourceId":{"type":"int32","id":1},"sequenceNumber":{"type":"int32","id":2},"contextVersion":{"type":"int64","id":3},"operation":{"type":"OperationData","id":4}}},"OperationAcknowledgementMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{"resourceId":{"type":"int32","id":1},"sequenceNumber":{"type":"int32","id":2},"version":{"type":"int64","id":3},"timestamp":{"type":"google.protobuf.Timestamp","id":4}}},"RemoteOperationMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{"resourceId":{"type":"int32","id":1},"sessionId":{"type":"string","id":2},"contextVersion":{"type":"int64","id":3},"timestamp":{"type":"google.protobuf.Timestamp","id":4},"operation":{"type":"OperationData","id":5}}},"ShareReferenceMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ClientMessage"},"fields":{"resourceId":{"type":"int32","id":1},"valueId":{"type":"google.protobuf.StringValue","id":2},"key":{"type":"string","id":3},"references":{"type":"ReferenceValues","id":4},"version":{"type":"int64","id":5}}},"RemoteReferenceSharedMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{"resourceId":{"type":"int32","id":1},"valueId":{"type":"google.protobuf.StringValue","id":2},"key":{"type":"string","id":3},"references":{"type":"ReferenceValues","id":4},"sessionId":{"type":"string","id":5}}},"UnshareReferenceMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ClientMessage"},"fields":{"resourceId":{"type":"int32","id":1},"valueId":{"type":"google.protobuf.StringValue","id":2},"key":{"type":"string","id":3}}},"RemoteReferenceUnsharedMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{"resourceId":{"type":"int32","id":1},"valueId":{"type":"google.protobuf.StringValue","id":2},"key":{"type":"string","id":3},"sessionId":{"type":"string","id":4}}},"SetReferenceMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ClientMessage"},"fields":{"resourceId":{"type":"int32","id":1},"valueId":{"type":"google.protobuf.StringValue","id":2},"key":{"type":"string","id":3},"references":{"type":"ReferenceValues","id":4},"version":{"type":"int64","id":5}}},"RemoteReferenceSetMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{"resourceId":{"type":"int32","id":1},"valueId":{"type":"google.protobuf.StringValue","id":2},"key":{"type":"string","id":3},"references":{"type":"ReferenceValues","id":4},"sessionId":{"type":"string","id":5}}},"ClearReferenceMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ClientMessage"},"fields":{"resourceId":{"type":"int32","id":1},"valueId":{"type":"google.protobuf.StringValue","id":2},"key":{"type":"string","id":3}}},"RemoteReferenceClearedMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{"resourceId":{"type":"int32","id":1},"valueId":{"type":"google.protobuf.StringValue","id":2},"key":{"type":"string","id":3},"sessionId":{"type":"string","id":4}}},"ModelOfflineSubscriptionChangeRequestMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ClientMessage"},"fields":{"subscribe":{"rule":"repeated","type":"ModelOfflineSubscriptionData","id":1},"unsubscribe":{"rule":"repeated","type":"string","id":2},"all":{"type":"bool","id":3}},"nested":{"ModelOfflineSubscriptionData":{"fields":{"modelId":{"type":"string","id":1},"currentVersion":{"type":"int64","id":2},"currentPermissions":{"type":"ModelPermissionsData","id":3}}}}},"OfflineModelUpdatedMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"oneofs":{"action":{"oneof":["deleted","permissionRevoked","updated","initial"]}},"fields":{"modelId":{"type":"string","id":1},"deleted":{"type":"bool","id":2},"permissionRevoked":{"type":"bool","id":3},"updated":{"type":"OfflineModelUpdateData","id":4},"initial":{"type":"OfflineModelInitialData","id":5}},"nested":{"OfflineModelInitialData":{"fields":{"collection":{"type":"string","id":1},"valueIdPrefix":{"type":"string","id":2},"model":{"type":"ModelUpdateData","id":3},"permissions":{"type":"ModelPermissionsData","id":4}}},"OfflineModelUpdateData":{"fields":{"model":{"type":"ModelUpdateData","id":1},"permissions":{"type":"ModelPermissionsData","id":2}}},"ModelUpdateData":{"fields":{"version":{"type":"int64","id":1},"createdTime":{"type":"google.protobuf.Timestamp","id":2},"modifiedTime":{"type":"google.protobuf.Timestamp","id":3},"data":{"type":"ObjectValue","id":4}}}}},"HistoricalDataRequestMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ClientMessage"},"fields":{"modelId":{"type":"string","id":1}}},"HistoricalDataResponseMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{"collectionId":{"type":"string","id":1},"data":{"type":"ObjectValue","id":2},"version":{"type":"int64","id":3},"createdTime":{"type":"google.protobuf.Timestamp","id":4},"modifiedTime":{"type":"google.protobuf.Timestamp","id":5}}},"HistoricalOperationRequestMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ClientMessage"},"fields":{"modelId":{"type":"string","id":1},"first":{"type":"int64","id":2},"last":{"type":"int64","id":3}}},"HistoricalOperationsResponseMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{"operations":{"rule":"repeated","type":"ModelOperationData","id":1}},"nested":{"ModelOperationData":{"fields":{"modelId":{"type":"string","id":1},"version":{"type":"int64","id":2},"timestamp":{"type":"google.protobuf.Timestamp","id":3},"sessionId":{"type":"string","id":4},"operation":{"type":"AppliedOperationData","id":5}}}}},"ModelGetVersionAtTimeRequestMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ClientMessage"},"fields":{"modelId":{"type":"string","id":1},"targetTime":{"type":"google.protobuf.Timestamp","id":2}}},"ModelGetVersionAtTimeResponseMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.ServerMessage"},"fields":{"versionAtTime":{"type":"int64","id":1}}},"ObjectValue":{"fields":{"id":{"type":"string","id":1},"children":{"keyType":"string","type":"DataValue","id":2}}},"ArrayValue":{"fields":{"id":{"type":"string","id":1},"children":{"rule":"repeated","type":"DataValue","id":2}}},"BooleanValue":{"fields":{"id":{"type":"string","id":1},"value":{"type":"bool","id":2}}},"DoubleValue":{"fields":{"id":{"type":"string","id":1},"value":{"type":"double","id":2}}},"NullValue":{"fields":{"id":{"type":"string","id":1}}},"StringValue":{"fields":{"id":{"type":"string","id":1},"value":{"type":"string","id":2}}},"DateValue":{"fields":{"id":{"type":"string","id":1},"value":{"type":"google.protobuf.Timestamp","id":2}}},"DataValue":{"oneofs":{"value":{"oneof":["objectValue","arrayValue","booleanValue","doubleValue","nullValue","stringValue","dateValue"]}},"fields":{"objectValue":{"type":"ObjectValue","id":1},"arrayValue":{"type":"ArrayValue","id":2},"booleanValue":{"type":"BooleanValue","id":3},"doubleValue":{"type":"DoubleValue","id":4},"nullValue":{"type":"NullValue","id":5},"stringValue":{"type":"StringValue","id":6},"dateValue":{"type":"DateValue","id":7}}},"StringSpliceOperationData":{"fields":{"id":{"type":"string","id":1},"noOp":{"type":"bool","id":2},"index":{"type":"int32","id":3},"deleteCount":{"type":"int32","id":4},"insertedValue":{"type":"string","id":5}}},"StringSetOperationData":{"fields":{"id":{"type":"string","id":1},"noOp":{"type":"bool","id":2},"value":{"type":"string","id":3}}},"ArrayInsertOperationData":{"fields":{"id":{"type":"string","id":1},"noOp":{"type":"bool","id":2},"index":{"type":"int32","id":3},"value":{"type":"DataValue","id":4}}},"ArrayRemoveOperationData":{"fields":{"id":{"type":"string","id":1},"noOp":{"type":"bool","id":2},"index":{"type":"int32","id":3}}},"ArrayReplaceOperationData":{"fields":{"id":{"type":"string","id":1},"noOp":{"type":"bool","id":2},"index":{"type":"int32","id":3},"value":{"type":"DataValue","id":4}}},"ArrayMoveOperationData":{"fields":{"id":{"type":"string","id":1},"noOp":{"type":"bool","id":2},"fromIndex":{"type":"int32","id":3},"toIndex":{"type":"int32","id":4}}},"ArraySetOperationData":{"fields":{"id":{"type":"string","id":1},"noOp":{"type":"bool","id":2},"values":{"rule":"repeated","type":"DataValue","id":3}}},"ObjectAddPropertyOperationData":{"fields":{"id":{"type":"string","id":1},"noOp":{"type":"bool","id":2},"key":{"type":"string","id":3},"value":{"type":"DataValue","id":4}}},"ObjectSetPropertyOperationData":{"fields":{"id":{"type":"string","id":1},"noOp":{"type":"bool","id":2},"key":{"type":"string","id":3},"value":{"type":"DataValue","id":4}}},"ObjectRemovePropertyOperationData":{"fields":{"id":{"type":"string","id":1},"noOp":{"type":"bool","id":2},"key":{"type":"string","id":3}}},"ObjectSetOperationData":{"fields":{"id":{"type":"string","id":1},"noOp":{"type":"bool","id":2},"values":{"keyType":"string","type":"DataValue","id":3}}},"NumberDeltaOperationData":{"fields":{"id":{"type":"string","id":1},"noOp":{"type":"bool","id":2},"delta":{"type":"double","id":3}}},"NumberSetOperationData":{"fields":{"id":{"type":"string","id":1},"noOp":{"type":"bool","id":2},"value":{"type":"double","id":3}}},"BooleanSetOperationData":{"fields":{"id":{"type":"string","id":1},"noOp":{"type":"bool","id":2},"value":{"type":"bool","id":3}}},"DateSetOperationData":{"fields":{"id":{"type":"string","id":1},"noOp":{"type":"bool","id":2},"value":{"type":"google.protobuf.Timestamp","id":3}}},"DiscreteOperationData":{"oneofs":{"operation":{"oneof":["stringSpliceOperation","stringSetOperation","arrayInsertOperation","arrayRemoveOperation","arrayReplaceOperation","arrayMoveOperation","arraySetOperation","objectAddPropertyOperation","objectSetPropertyOperation","objectRemovePropertyOperation","objectSetOperation","numberDeltaOperation","numberSetOperation","booleanSetOperation","dateSetOperation"]}},"fields":{"stringSpliceOperation":{"type":"StringSpliceOperationData","id":1},"stringSetOperation":{"type":"StringSetOperationData","id":2},"arrayInsertOperation":{"type":"ArrayInsertOperationData","id":3},"arrayRemoveOperation":{"type":"ArrayRemoveOperationData","id":4},"arrayReplaceOperation":{"type":"ArrayReplaceOperationData","id":5},"arrayMoveOperation":{"type":"ArrayMoveOperationData","id":6},"arraySetOperation":{"type":"ArraySetOperationData","id":7},"objectAddPropertyOperation":{"type":"ObjectAddPropertyOperationData","id":8},"objectSetPropertyOperation":{"type":"ObjectSetPropertyOperationData","id":9},"objectRemovePropertyOperation":{"type":"ObjectRemovePropertyOperationData","id":10},"objectSetOperation":{"type":"ObjectSetOperationData","id":11},"numberDeltaOperation":{"type":"NumberDeltaOperationData","id":12},"numberSetOperation":{"type":"NumberSetOperationData","id":13},"booleanSetOperation":{"type":"BooleanSetOperationData","id":14},"dateSetOperation":{"type":"DateSetOperationData","id":15}}},"CompoundOperationData":{"fields":{"operations":{"rule":"repeated","type":"DiscreteOperationData","id":1}}},"OperationData":{"oneofs":{"operation":{"oneof":["discreteOperation","compoundOperation"]}},"fields":{"discreteOperation":{"type":"DiscreteOperationData","id":1},"compoundOperation":{"type":"CompoundOperationData","id":2}}},"ModelPermissionsData":{"fields":{"read":{"type":"bool","id":1},"write":{"type":"bool","id":2},"remove":{"type":"bool","id":3},"manage":{"type":"bool","id":4}}},"UserModelPermissionsData":{"fields":{"user":{"type":"com.convergencelabs.convergence.proto.core.DomainUserIdData","id":1},"permissions":{"type":"ModelPermissionsData","id":2}}},"AppliedStringSpliceOperationData":{"fields":{"id":{"type":"string","id":1},"noOp":{"type":"bool","id":2},"index":{"type":"int32","id":3},"deletedValue":{"type":"string","id":4},"insertedValue":{"type":"string","id":5}}},"AppliedStringSetOperationData":{"fields":{"id":{"type":"string","id":1},"noOp":{"type":"bool","id":2},"value":{"type":"string","id":3},"oldValue":{"type":"string","id":4}}},"AppliedArrayInsertOperationData":{"fields":{"id":{"type":"string","id":1},"noOp":{"type":"bool","id":2},"index":{"type":"int32","id":3},"value":{"type":"DataValue","id":4}}},"AppliedArrayRemoveOperationData":{"fields":{"id":{"type":"string","id":1},"noOp":{"type":"bool","id":2},"index":{"type":"int32","id":3},"oldValue":{"type":"DataValue","id":4}}},"AppliedArrayReplaceOperationData":{"fields":{"id":{"type":"string","id":1},"noOp":{"type":"bool","id":2},"index":{"type":"int32","id":3},"value":{"type":"DataValue","id":4},"oldValue":{"type":"DataValue","id":5}}},"AppliedArrayMoveOperationData":{"fields":{"id":{"type":"string","id":1},"noOp":{"type":"bool","id":2},"fromIndex":{"type":"int32","id":3},"toIndex":{"type":"int32","id":4}}},"AppliedArraySetOperationData":{"fields":{"id":{"type":"string","id":1},"noOp":{"type":"bool","id":2},"values":{"rule":"repeated","type":"DataValue","id":3},"oldValues":{"rule":"repeated","type":"DataValue","id":4}}},"AppliedObjectAddPropertyOperationData":{"fields":{"id":{"type":"string","id":1},"noOp":{"type":"bool","id":2},"key":{"type":"string","id":3},"value":{"type":"DataValue","id":4}}},"AppliedObjectSetPropertyOperationData":{"fields":{"id":{"type":"string","id":1},"noOp":{"type":"bool","id":2},"key":{"type":"string","id":3},"value":{"type":"DataValue","id":4},"oldValue":{"type":"DataValue","id":5}}},"AppliedObjectRemovePropertyOperationData":{"fields":{"id":{"type":"string","id":1},"noOp":{"type":"bool","id":2},"key":{"type":"string","id":3},"oldValue":{"type":"DataValue","id":4}}},"AppliedObjectSetOperationData":{"fields":{"id":{"type":"string","id":1},"noOp":{"type":"bool","id":2},"values":{"keyType":"string","type":"DataValue","id":3},"oldValues":{"keyType":"string","type":"DataValue","id":4}}},"AppliedNumberDeltaOperationData":{"fields":{"id":{"type":"string","id":1},"noOp":{"type":"bool","id":2},"delta":{"type":"double","id":3}}},"AppliedNumberSetOperationData":{"fields":{"id":{"type":"string","id":1},"noOp":{"type":"bool","id":2},"value":{"type":"double","id":3},"oldValue":{"type":"double","id":4}}},"AppliedBooleanSetOperationData":{"fields":{"id":{"type":"string","id":1},"noOp":{"type":"bool","id":2},"value":{"type":"bool","id":3},"oldValue":{"type":"bool","id":4}}},"AppliedDateSetOperationData":{"fields":{"id":{"type":"string","id":1},"noOp":{"type":"bool","id":2},"value":{"type":"google.protobuf.Timestamp","id":3},"oldValue":{"type":"google.protobuf.Timestamp","id":4}}},"AppliedDiscreteOperationData":{"oneofs":{"operation":{"oneof":["stringSpliceOperation","stringSetOperation","arrayInsertOperation","arrayRemoveOperation","arrayReplaceOperation","arrayMoveOperation","arraySetOperation","objectAddPropertyOperation","objectSetPropertyOperation","objectRemovePropertyOperation","objectSetOperation","numberDeltaOperation","numberSetOperation","booleanSetOperation","dateSetOperation"]}},"fields":{"stringSpliceOperation":{"type":"AppliedStringSpliceOperationData","id":1},"stringSetOperation":{"type":"AppliedStringSetOperationData","id":2},"arrayInsertOperation":{"type":"AppliedArrayInsertOperationData","id":3},"arrayRemoveOperation":{"type":"AppliedArrayRemoveOperationData","id":4},"arrayReplaceOperation":{"type":"AppliedArrayReplaceOperationData","id":5},"arrayMoveOperation":{"type":"AppliedArrayMoveOperationData","id":6},"arraySetOperation":{"type":"AppliedArraySetOperationData","id":7},"objectAddPropertyOperation":{"type":"AppliedObjectAddPropertyOperationData","id":8},"objectSetPropertyOperation":{"type":"AppliedObjectSetPropertyOperationData","id":9},"objectRemovePropertyOperation":{"type":"AppliedObjectRemovePropertyOperationData","id":10},"objectSetOperation":{"type":"AppliedObjectSetOperationData","id":11},"numberDeltaOperation":{"type":"AppliedNumberDeltaOperationData","id":12},"numberSetOperation":{"type":"AppliedNumberSetOperationData","id":13},"booleanSetOperation":{"type":"AppliedBooleanSetOperationData","id":14},"dateSetOperation":{"type":"AppliedDateSetOperationData","id":15}}},"AppliedCompoundOperationData":{"fields":{"operations":{"rule":"repeated","type":"AppliedDiscreteOperationData","id":1}}},"AppliedOperationData":{"oneofs":{"operation":{"oneof":["discreteOperation","compoundOperation"]}},"fields":{"discreteOperation":{"type":"AppliedDiscreteOperationData","id":1},"compoundOperation":{"type":"AppliedCompoundOperationData","id":2}}},"IndexRange":{"fields":{"startIndex":{"type":"int32","id":1},"endIndex":{"type":"int32","id":2}}},"IndexRangeList":{"fields":{"values":{"rule":"repeated","type":"IndexRange","id":1}}},"ReferenceValues":{"oneofs":{"values":{"oneof":["indices","ranges","properties","elements"]}},"fields":{"indices":{"type":"com.convergencelabs.convergence.proto.core.Int32List","id":1},"ranges":{"type":"IndexRangeList","id":2},"properties":{"type":"com.convergencelabs.convergence.proto.core.StringList","id":3},"elements":{"type":"com.convergencelabs.convergence.proto.core.StringList","id":4}}},"ReferenceData":{"fields":{"sessionId":{"type":"string","id":1},"valueId":{"type":"google.protobuf.StringValue","id":2},"key":{"type":"string","id":3},"reference":{"type":"ReferenceValues","id":4}}}}},"presence":{"nested":{"PresenceRequestMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.PresenceMessage"},"fields":{"users":{"rule":"repeated","type":"com.convergencelabs.convergence.proto.core.DomainUserIdData","id":1}}},"PresenceResponseMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.PresenceMessage"},"fields":{"userPresences":{"rule":"repeated","type":"UserPresenceData","id":1}}},"SubscribePresenceRequestMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.PresenceMessage"},"fields":{"users":{"rule":"repeated","type":"com.convergencelabs.convergence.proto.core.DomainUserIdData","id":1}}},"SubscribePresenceResponseMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.PresenceMessage"},"fields":{"userPresences":{"rule":"repeated","type":"UserPresenceData","id":1}}},"UnsubscribePresenceMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.PresenceMessage"},"fields":{"users":{"rule":"repeated","type":"com.convergencelabs.convergence.proto.core.DomainUserIdData","id":1}}},"PresenceSetStateMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.PresenceMessage"},"fields":{"state":{"keyType":"string","type":"google.protobuf.Value","id":1}}},"PresenceRemoveStateMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.PresenceMessage"},"fields":{"keys":{"rule":"repeated","type":"string","id":1}}},"PresenceClearStateMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.PresenceMessage"},"fields":{}},"PresenceStateSetMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.PresenceMessage"},"fields":{"user":{"type":"com.convergencelabs.convergence.proto.core.DomainUserIdData","id":1},"state":{"keyType":"string","type":"google.protobuf.Value","id":2}}},"PresenceStateRemovedMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.PresenceMessage"},"fields":{"user":{"type":"com.convergencelabs.convergence.proto.core.DomainUserIdData","id":1},"keys":{"rule":"repeated","type":"string","id":2}}},"PresenceStateClearedMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.PresenceMessage"},"fields":{"user":{"type":"com.convergencelabs.convergence.proto.core.DomainUserIdData","id":1}}},"PresenceAvailabilityChangedMessage":{"options":{"(scalapb.message).extends":"com.convergencelabs.convergence.proto.PresenceMessage"},"fields":{"user":{"type":"com.convergencelabs.convergence.proto.core.DomainUserIdData","id":1},"available":{"type":"bool","id":2}}},"UserPresenceData":{"fields":{"user":{"type":"com.convergencelabs.convergence.proto.core.DomainUserIdData","id":1},"available":{"type":"bool","id":2},"state":{"keyType":"string","type":"google.protobuf.Value","id":3}}}}}}}}}}}}},"google":{"nested":{"protobuf":{"nested":{"DoubleValue":{"fields":{"value":{"type":"double","id":1}}},"FloatValue":{"fields":{"value":{"type":"float","id":1}}},"Int64Value":{"fields":{"value":{"type":"int64","id":1}}},"UInt64Value":{"fields":{"value":{"type":"uint64","id":1}}},"Int32Value":{"fields":{"value":{"type":"int32","id":1}}},"UInt32Value":{"fields":{"value":{"type":"uint32","id":1}}},"BoolValue":{"fields":{"value":{"type":"bool","id":1}}},"StringValue":{"fields":{"value":{"type":"string","id":1}}},"BytesValue":{"fields":{"value":{"type":"bytes","id":1}}},"Struct":{"fields":{"fields":{"keyType":"string","type":"Value","id":1}}},"Value":{"oneofs":{"kind":{"oneof":["nullValue","numberValue","stringValue","boolValue","structValue","listValue"]}},"fields":{"nullValue":{"type":"NullValue","id":1},"numberValue":{"type":"double","id":2},"stringValue":{"type":"string","id":3},"boolValue":{"type":"bool","id":4},"structValue":{"type":"Struct","id":5},"listValue":{"type":"ListValue","id":6}}},"NullValue":{"values":{"NULL_VALUE":0}},"ListValue":{"fields":{"values":{"rule":"repeated","type":"Value","id":1}}},"Timestamp":{"fields":{"seconds":{"type":"int64","id":1},"nanos":{"type":"int32","id":2}}}}}}}}}')},function(e,t,s){"use strict";e.exports=s(29)},function(e,t,s){"use strict";var i=e.exports=s(30);i.build="light",i.load=function(e,t,s){return"function"==typeof t?(s=t,t=new i.Root):t||(t=new i.Root),t.load(e,s)},i.loadSync=function(e,t){return t||(t=new i.Root),t.loadSync(e)},i.encoder=s(17),i.decoder=s(22),i.verifier=s(23),i.converter=s(24),i.ReflectionObject=s(5),i.Namespace=s(7),i.Root=s(26),i.Enum=s(3),i.Type=s(18),i.Field=s(6),i.OneOf=s(9),i.MapField=s(19),i.Service=s(20),i.Method=s(21),i.Message=s(12),i.wrappers=s(25),i.types=s(8),i.util=s(1),i.ReflectionObject.v(i.Root),i.Namespace.v(i.Type,i.Service,i.Enum),i.Root.v(i.Type),i.Field.v(i.Type)},function(e,t,s){"use strict";var i=t;function n(){i.util.v(),i.Writer.v(i.BufferWriter),i.Reader.v(i.BufferReader)}i.build="minimal",i.Writer=s(10),i.BufferWriter=s(38),i.Reader=s(11),i.BufferReader=s(39),i.util=s(2),i.rpc=s(15),i.roots=s(16),i.configure=n,n()},function(e,t){var s;s=function(){return this}();try{s=s||new Function("return this")()}catch(e){"object"==typeof window&&(s=window)}e.exports=s},function(e,t,s){"use strict";var i=t;i.length=function(e){var t=e.length;if(!t)return 0;for(var s=0;--t%4>1&&"="===e.charAt(t);)++s;return Math.ceil(3*e.length)/4-s};for(var n=new Array(64),r=new Array(123),o=0;o<64;)r[n[o]=o<26?o+65:o<52?o+71:o<62?o-4:o-59|43]=o++;i.encode=function(e,t,s){for(var i,r=null,o=[],a=0,c=0;t<s;){var h=e[t++];switch(c){case 0:o[a++]=n[h>>2],i=(3&h)<<4,c=1;break;case 1:o[a++]=n[i|h>>4],i=(15&h)<<2,c=2;break;case 2:o[a++]=n[i|h>>6],o[a++]=n[63&h],c=0}a>8191&&((r||(r=[])).push(String.fromCharCode.apply(String,o)),a=0)}return c&&(o[a++]=n[i],o[a++]=61,1===c&&(o[a++]=61)),r?(a&&r.push(String.fromCharCode.apply(String,o.slice(0,a))),r.join("")):String.fromCharCode.apply(String,o.slice(0,a))};i.decode=function(e,t,s){for(var i,n=s,o=0,a=0;a<e.length;){var c=e.charCodeAt(a++);if(61===c&&o>1)break;if(void 0===(c=r[c]))throw Error("invalid encoding");switch(o){case 0:i=c,o=1;break;case 1:t[s++]=i<<2|(48&c)>>4,i=c,o=2;break;case 2:t[s++]=(15&i)<<4|(60&c)>>2,i=c,o=3;break;case 3:t[s++]=(3&i)<<6|c,o=0}}if(1===o)throw Error("invalid encoding");return s-n},i.test=function(e){return/^(?:[A-Za-z0-9+/]{4})*(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=)?$/.test(e)}},function(e,t,s){"use strict";function i(){this.P={}}e.exports=i,i.prototype.on=function(e,t,s){return(this.P[e]||(this.P[e]=[])).push({fn:t,ctx:s||this}),this},i.prototype.off=function(e,t){if(void 0===e)this.P={};else if(void 0===t)this.P[e]=[];else for(var s=this.P[e],i=0;i<s.length;)s[i].fn===t?s.splice(i,1):++i;return this},i.prototype.emit=function(e){var t=this.P[e];if(t){for(var s=[],i=1;i<arguments.length;)s.push(arguments[i++]);for(i=0;i<t.length;)t[i].fn.apply(t[i++].ctx,s)}return this}},function(e,t,s){"use strict";function i(e){return"undefined"!=typeof Float32Array?function(){var t=new Float32Array([-0]),s=new Uint8Array(t.buffer),i=128===s[3];function n(e,i,n){t[0]=e,i[n]=s[0],i[n+1]=s[1],i[n+2]=s[2],i[n+3]=s[3]}function r(e,i,n){t[0]=e,i[n]=s[3],i[n+1]=s[2],i[n+2]=s[1],i[n+3]=s[0]}function o(e,i){return s[0]=e[i],s[1]=e[i+1],s[2]=e[i+2],s[3]=e[i+3],t[0]}function a(e,i){return s[3]=e[i],s[2]=e[i+1],s[1]=e[i+2],s[0]=e[i+3],t[0]}e.writeFloatLE=i?n:r,e.writeFloatBE=i?r:n,e.readFloatLE=i?o:a,e.readFloatBE=i?a:o}():function(){function t(e,t,s,i){var n=t<0?1:0;if(n&&(t=-t),0===t)e(1/t>0?0:2147483648,s,i);else if(isNaN(t))e(2143289344,s,i);else if(t>34028234663852886e22)e((n<<31|2139095040)>>>0,s,i);else if(t<11754943508222875e-54)e((n<<31|Math.round(t/1401298464324817e-60))>>>0,s,i);else{var r=Math.floor(Math.log(t)/Math.LN2);e((n<<31|r+127<<23|8388607&Math.round(t*Math.pow(2,-r)*8388608))>>>0,s,i)}}function s(e,t,s){var i=e(t,s),n=2*(i>>31)+1,r=i>>>23&255,o=8388607&i;return 255===r?o?NaN:n*(1/0):0===r?1401298464324817e-60*n*o:n*Math.pow(2,r-150)*(o+8388608)}e.writeFloatLE=t.bind(null,n),e.writeFloatBE=t.bind(null,r),e.readFloatLE=s.bind(null,o),e.readFloatBE=s.bind(null,a)}(),"undefined"!=typeof Float64Array?function(){var t=new Float64Array([-0]),s=new Uint8Array(t.buffer),i=128===s[7];function n(e,i,n){t[0]=e,i[n]=s[0],i[n+1]=s[1],i[n+2]=s[2],i[n+3]=s[3],i[n+4]=s[4],i[n+5]=s[5],i[n+6]=s[6],i[n+7]=s[7]}function r(e,i,n){t[0]=e,i[n]=s[7],i[n+1]=s[6],i[n+2]=s[5],i[n+3]=s[4],i[n+4]=s[3],i[n+5]=s[2],i[n+6]=s[1],i[n+7]=s[0]}function o(e,i){return s[0]=e[i],s[1]=e[i+1],s[2]=e[i+2],s[3]=e[i+3],s[4]=e[i+4],s[5]=e[i+5],s[6]=e[i+6],s[7]=e[i+7],t[0]}function a(e,i){return s[7]=e[i],s[6]=e[i+1],s[5]=e[i+2],s[4]=e[i+3],s[3]=e[i+4],s[2]=e[i+5],s[1]=e[i+6],s[0]=e[i+7],t[0]}e.writeDoubleLE=i?n:r,e.writeDoubleBE=i?r:n,e.readDoubleLE=i?o:a,e.readDoubleBE=i?a:o}():function(){function t(e,t,s,i,n,r){var o=i<0?1:0;if(o&&(i=-i),0===i)e(0,n,r+t),e(1/i>0?0:2147483648,n,r+s);else if(isNaN(i))e(0,n,r+t),e(2146959360,n,r+s);else if(i>17976931348623157e292)e(0,n,r+t),e((o<<31|2146435072)>>>0,n,r+s);else{var a;if(i<22250738585072014e-324)e((a=i/5e-324)>>>0,n,r+t),e((o<<31|a/4294967296)>>>0,n,r+s);else{var c=Math.floor(Math.log(i)/Math.LN2);1024===c&&(c=1023),e(4503599627370496*(a=i*Math.pow(2,-c))>>>0,n,r+t),e((o<<31|c+1023<<20|1048576*a&1048575)>>>0,n,r+s)}}}function s(e,t,s,i,n){var r=e(i,n+t),o=e(i,n+s),a=2*(o>>31)+1,c=o>>>20&2047,h=4294967296*(1048575&o)+r;return 2047===c?h?NaN:a*(1/0):0===c?5e-324*a*h:a*Math.pow(2,c-1075)*(h+4503599627370496)}e.writeDoubleLE=t.bind(null,n,0,4),e.writeDoubleBE=t.bind(null,r,4,0),e.readDoubleLE=s.bind(null,o,0,4),e.readDoubleBE=s.bind(null,a,4,0)}(),e}function n(e,t,s){t[s]=255&e,t[s+1]=e>>>8&255,t[s+2]=e>>>16&255,t[s+3]=e>>>24}function r(e,t,s){t[s]=e>>>24,t[s+1]=e>>>16&255,t[s+2]=e>>>8&255,t[s+3]=255&e}function o(e,t){return(e[t]|e[t+1]<<8|e[t+2]<<16|e[t+3]<<24)>>>0}function a(e,t){return(e[t]<<24|e[t+1]<<16|e[t+2]<<8|e[t+3])>>>0}e.exports=i(i)},function(e,t,s){"use strict";var i=t;i.length=function(e){for(var t=0,s=0,i=0;i<e.length;++i)(s=e.charCodeAt(i))<128?t+=1:s<2048?t+=2:55296==(64512&s)&&56320==(64512&e.charCodeAt(i+1))?(++i,t+=4):t+=3;return t},i.read=function(e,t,s){if(s-t<1)return"";for(var i,n=null,r=[],o=0;t<s;)(i=e[t++])<128?r[o++]=i:i>191&&i<224?r[o++]=(31&i)<<6|63&e[t++]:i>239&&i<365?(i=((7&i)<<18|(63&e[t++])<<12|(63&e[t++])<<6|63&e[t++])-65536,r[o++]=55296+(i>>10),r[o++]=56320+(1023&i)):r[o++]=(15&i)<<12|(63&e[t++])<<6|63&e[t++],o>8191&&((n||(n=[])).push(String.fromCharCode.apply(String,r)),o=0);return n?(o&&n.push(String.fromCharCode.apply(String,r.slice(0,o))),n.join("")):String.fromCharCode.apply(String,r.slice(0,o))},i.write=function(e,t,s){for(var i,n,r=s,o=0;o<e.length;++o)(i=e.charCodeAt(o))<128?t[s++]=i:i<2048?(t[s++]=i>>6|192,t[s++]=63&i|128):55296==(64512&i)&&56320==(64512&(n=e.charCodeAt(o+1)))?(i=65536+((1023&i)<<10)+(1023&n),++o,t[s++]=i>>18|240,t[s++]=i>>12&63|128,t[s++]=i>>6&63|128,t[s++]=63&i|128):(t[s++]=i>>12|224,t[s++]=i>>6&63|128,t[s++]=63&i|128);return s-r}},function(e,t,s){"use strict";e.exports=function(e,t,s){var i=s||8192,n=i>>>1,r=null,o=i;return function(s){if(s<1||s>n)return e(s);o+s>i&&(r=e(i),o=0);var a=t.call(r,o,o+=s);return 7&o&&(o=1+(7|o)),a}}},function(e,t,s){"use strict";e.exports=n;var i=s(2);function n(e,t){this.lo=e>>>0,this.hi=t>>>0}var r=n.zero=new n(0,0);r.toNumber=function(){return 0},r.zzEncode=r.zzDecode=function(){return this},r.length=function(){return 1};var o=n.zeroHash="\0\0\0\0\0\0\0\0";n.fromNumber=function(e){if(0===e)return r;var t=e<0;t&&(e=-e);var s=e>>>0,i=(e-s)/4294967296>>>0;return t&&(i=~i>>>0,s=~s>>>0,++s>4294967295&&(s=0,++i>4294967295&&(i=0))),new n(s,i)},n.from=function(e){if("number"==typeof e)return n.fromNumber(e);if(i.isString(e)){if(!i.Long)return n.fromNumber(parseInt(e,10));e=i.Long.fromString(e)}return e.low||e.high?new n(e.low>>>0,e.high>>>0):r},n.prototype.toNumber=function(e){if(!e&&this.hi>>>31){var t=1+~this.lo>>>0,s=~this.hi>>>0;return t||(s=s+1>>>0),-(t+4294967296*s)}return this.lo+4294967296*this.hi},n.prototype.toLong=function(e){return i.Long?new i.Long(0|this.lo,0|this.hi,Boolean(e)):{low:0|this.lo,high:0|this.hi,unsigned:Boolean(e)}};var a=String.prototype.charCodeAt;n.fromHash=function(e){return e===o?r:new n((a.call(e,0)|a.call(e,1)<<8|a.call(e,2)<<16|a.call(e,3)<<24)>>>0,(a.call(e,4)|a.call(e,5)<<8|a.call(e,6)<<16|a.call(e,7)<<24)>>>0)},n.prototype.toHash=function(){return String.fromCharCode(255&this.lo,this.lo>>>8&255,this.lo>>>16&255,this.lo>>>24,255&this.hi,this.hi>>>8&255,this.hi>>>16&255,this.hi>>>24)},n.prototype.zzEncode=function(){var e=this.hi>>31;return this.hi=((this.hi<<1|this.lo>>>31)^e)>>>0,this.lo=(this.lo<<1^e)>>>0,this},n.prototype.zzDecode=function(){var e=-(1&this.lo);return this.lo=((this.lo>>>1|this.hi<<31)^e)>>>0,this.hi=(this.hi>>>1^e)>>>0,this},n.prototype.length=function(){var e=this.lo,t=(this.lo>>>28|this.hi<<4)>>>0,s=this.hi>>>24;return 0===s?0===t?e<16384?e<128?1:2:e<2097152?3:4:t<16384?t<128?5:6:t<2097152?7:8:s<128?9:10}},function(e,t,s){"use strict";e.exports=r;var i=s(10);(r.prototype=Object.create(i.prototype)).constructor=r;var n=s(2);function r(){i.call(this)}function o(e,t,s){e.length<40?n.utf8.write(e,t,s):t.utf8Write?t.utf8Write(e,s):t.write(e,s)}r.v=function(){r.alloc=n.g,r.writeBytesBuffer=n.Buffer&&n.Buffer.prototype instanceof Uint8Array&&"set"===n.Buffer.prototype.set.name?function(e,t,s){t.set(e,s)}:function(e,t,s){if(e.copy)e.copy(t,s,0,e.length);else for(var i=0;i<e.length;)t[s++]=e[i++]}},r.prototype.bytes=function(e){n.isString(e)&&(e=n.u(e,"base64"));var t=e.length>>>0;return this.uint32(t),t&&this.C(r.writeBytesBuffer,t,e),this},r.prototype.string=function(e){var t=n.Buffer.byteLength(e);return this.uint32(t),t&&this.C(o,t,e),this},r.v()},function(e,t,s){"use strict";e.exports=r;var i=s(11);(r.prototype=Object.create(i.prototype)).constructor=r;var n=s(2);function r(e){i.call(this,e)}r.v=function(){n.Buffer&&(r.prototype.I=n.Buffer.prototype.slice)},r.prototype.string=function(){var e=this.uint32();return this.buf.utf8Slice?this.buf.utf8Slice(this.pos,this.pos=Math.min(this.pos+e,this.len)):this.buf.toString("utf-8",this.pos,this.pos=Math.min(this.pos+e,this.len))},r.v()},function(e,t,s){"use strict";e.exports=n;var i=s(2);function n(e,t,s){if("function"!=typeof e)throw TypeError("rpcImpl must be a function");i.EventEmitter.call(this),this.rpcImpl=e,this.requestDelimited=Boolean(t),this.responseDelimited=Boolean(s)}(n.prototype=Object.create(i.EventEmitter.prototype)).constructor=n,n.prototype.rpcCall=function e(t,s,n,r,o){if(!r)throw TypeError("request must be specified");var a=this;if(!o)return i.asPromise(e,a,t,s,n,r);if(a.rpcImpl)try{return a.rpcImpl(t,s[a.requestDelimited?"encodeDelimited":"encode"](r).finish(),(function(e,s){if(e)return a.emit("error",e,t),o(e);if(null!==s){if(!(s instanceof n))try{s=n[a.responseDelimited?"decodeDelimited":"decode"](s)}catch(e){return a.emit("error",e,t),o(e)}return a.emit("data",s,t),o(null,s)}a.end(!0)}))}catch(e){return a.emit("error",e,t),void setTimeout((function(){o(e)}),0)}else setTimeout((function(){o(Error("already ended"))}),0)},n.prototype.end=function(e){return this.rpcImpl&&(e||this.rpcImpl(null,null,null),this.rpcImpl=null,this.emit("end").off()),this}},function(e,t,s){"use strict";function i(e,t){"string"==typeof e&&(t=e,e=void 0);var s=[];function n(e){if("string"!=typeof e){var t=r();if(i.verbose&&console.log("codegen: "+t),t="return "+t,e){for(var o=Object.keys(e),a=new Array(o.length+1),c=new Array(o.length),h=0;h<o.length;)a[h]=o[h],c[h]=e[o[h++]];return a[h]=t,Function.apply(null,a).apply(null,c)}return Function(t)()}for(var u=new Array(arguments.length-1),d=0;d<u.length;)u[d]=arguments[++d];if(d=0,e=e.replace(/%([%dfijs])/g,(function(e,t){var s=u[d++];switch(t){case"d":case"f":return String(Number(s));case"i":return String(Math.floor(s));case"j":return JSON.stringify(s);case"s":return String(s)}return"%"})),d!==u.length)throw Error("parameter count mismatch");return s.push(e),n}function r(i){return"function "+(i||t||"")+"("+(e&&e.join(",")||"")+"){\n  "+s.join("\n  ")+"\n}"}return n.toString=r,n}e.exports=i,i.verbose=!1},function(e,t,s){"use strict";e.exports=r;var i=s(13),n=s(14)("fs");function r(e,t,s){return"function"==typeof t?(s=t,t={}):t||(t={}),s?!t.xhr&&n&&n.readFile?n.readFile(e,(function(i,n){return i&&"undefined"!=typeof XMLHttpRequest?r.xhr(e,t,s):i?s(i):s(null,t.binary?n:n.toString("utf8"))})):r.xhr(e,t,s):i(r,this,e,t)}r.xhr=function(e,t,s){var i=new XMLHttpRequest;i.onreadystatechange=function(){if(4===i.readyState){if(0!==i.status&&200!==i.status)return s(Error("status "+i.status));if(t.binary){var e=i.response;if(!e){e=[];for(var n=0;n<i.responseText.length;++n)e.push(255&i.responseText.charCodeAt(n))}return s(null,"undefined"!=typeof Uint8Array?new Uint8Array(e):e)}return s(null,i.responseText)}},t.binary&&("overrideMimeType"in i&&i.overrideMimeType("text/plain; charset=x-user-defined"),i.responseType="arraybuffer"),i.open("GET",e),i.send()}},function(e,t,s){"use strict";var i=t,n=i.isAbsolute=function(e){return/^(?:\/|\w+:)/.test(e)},r=i.normalize=function(e){var t=(e=e.replace(/\\/g,"/").replace(/\/{2,}/g,"/")).split("/"),s=n(e),i="";s&&(i=t.shift()+"/");for(var r=0;r<t.length;)".."===t[r]?r>0&&".."!==t[r-1]?t.splice(--r,2):s?t.splice(r,1):++r:"."===t[r]?t.splice(r,1):++r;return i+t.join("/")};i.resolve=function(e,t,s){return s||(t=r(t)),n(t)?t:(s||(e=r(e)),(e=e.replace(/(?:\/|^)[^/]+$/,"")).length?r(e+"/"+t):t)}},function(e,t,s){"use strict";var i;s.r(t),s.d(t,"Convergence",(function(){return Vo})),s.d(t,"connect",(function(){return Lo})),s.d(t,"connectWithPassword",(function(){return Fo})),s.d(t,"connectAnonymously",(function(){return $o})),s.d(t,"connectWithJwt",(function(){return Go})),s.d(t,"reconnect",(function(){return Jo})),s.d(t,"configureLogging",(function(){return Bo})),s.d(t,"ConvergenceSession",(function(){return ce})),s.d(t,"ConvergenceDomain",(function(){return ko})),s.d(t,"ActivityParticipant",(function(){return xr})),s.d(t,"Activity",(function(){return $r})),s.d(t,"ActivityService",(function(){return Gr})),s.d(t,"ActivityPermissionManager",(function(){return Vr})),s.d(t,"ActivitySessionJoinedEvent",(function(){return Dr})),s.d(t,"ActivitySessionLeftEvent",(function(){return Tr})),s.d(t,"ActivityStateSetEvent",(function(){return jr})),s.d(t,"ActivityStateRemovedEvent",(function(){return Ar})),s.d(t,"ActivityStateClearedEvent",(function(){return Pr})),s.d(t,"ActivityStateDeltaEvent",(function(){return Nr})),s.d(t,"ChatService",(function(){return Do})),s.d(t,"Chat",(function(){return Eo})),s.d(t,"ChatChannel",(function(){return Io})),s.d(t,"ChatTypes",(function(){return bo})),s.d(t,"ChatPermissionManager",(function(){return Ro})),s.d(t,"ChatRoom",(function(){return _o})),s.d(t,"DirectChat",(function(){return So})),s.d(t,"MembershipChat",(function(){return Co})),s.d(t,"ChatHistoryEntry",(function(){return uo})),s.d(t,"CreatedChatHistoryEntry",(function(){return lo})),s.d(t,"MessageChatHistoryEntry",(function(){return po})),s.d(t,"NameChangedChatHistoryEntry",(function(){return yo})),s.d(t,"TopicChangedChatHistoryEntry",(function(){return wo})),s.d(t,"UserAddedChatHistoryEntry",(function(){return fo})),s.d(t,"UserJoinedChatHistoryEntry",(function(){return go})),s.d(t,"UserLeftChatHistoryEntry",(function(){return vo})),s.d(t,"UserRemovedChatHistoryEntry",(function(){return mo})),s.d(t,"ChatEvent",(function(){return Xr})),s.d(t,"ChatJoinedEvent",(function(){return Zr})),s.d(t,"ChatLeftEvent",(function(){return eo})),s.d(t,"ChatMessageEvent",(function(){return to})),s.d(t,"ChatNameChangedEvent",(function(){return so})),s.d(t,"ChatRemovedEvent",(function(){return io})),s.d(t,"ChatTopicChangedEvent",(function(){return no})),s.d(t,"UserAddedEvent",(function(){return ro})),s.d(t,"UserJoinedEvent",(function(){return oo})),s.d(t,"UserLeftEvent",(function(){return ao})),s.d(t,"UserRemovedEvent",(function(){return co})),s.d(t,"ChatEventsMarkedSeenEvent",(function(){return ho})),s.d(t,"DomainUser",(function(){return q})),s.d(t,"IdentityService",(function(){return F})),s.d(t,"DomainUserType",(function(){return P})),s.d(t,"DomainUserId",(function(){return N})),s.d(t,"DomainUserIdMap",(function(){return J})),s.d(t,"ModelServiceEventConstants",(function(){return Cr})),s.d(t,"ModelService",(function(){return Ir})),s.d(t,"ArrayInsertEvent",(function(){return Ct})),s.d(t,"ArrayRemoveEvent",(function(){return It})),s.d(t,"ArrayReorderEvent",(function(){return _t})),s.d(t,"ArraySetEvent",(function(){return xt})),s.d(t,"ArraySetValueEvent",(function(){return Dt})),s.d(t,"ObjectRemoveEvent",(function(){return Tt})),s.d(t,"ObjectSetEvent",(function(){return jt})),s.d(t,"ObjectSetValueEvent",(function(){return At})),s.d(t,"BooleanSetValueEvent",(function(){return Pt})),s.d(t,"DateSetValueEvent",(function(){return Nt})),s.d(t,"NumberSetValueEvent",(function(){return qt})),s.d(t,"NumberDeltaEvent",(function(){return Ut})),s.d(t,"StringInsertEvent",(function(){return kt})),s.d(t,"StringRemoveEvent",(function(){return Vt})),s.d(t,"StringSpliceEvent",(function(){return Lt})),s.d(t,"StringSetValueEvent",(function(){return Ft})),s.d(t,"ElementDetachedEvent",(function(){return $t})),s.d(t,"ModelChangedEvent",(function(){return Gt})),s.d(t,"ModelClosedEvent",(function(){return Jt})),s.d(t,"ModelDeletedEvent",(function(){return Bt})),s.d(t,"ModelPermissionsChangedEvent",(function(){return Ht})),s.d(t,"VersionChangedEvent",(function(){return Wt})),s.d(t,"ModelOnlineEvent",(function(){return zt})),s.d(t,"ModelOfflineEvent",(function(){return Yt})),s.d(t,"ModelReconnectingEvent",(function(){return Qt})),s.d(t,"ResyncStartedEvent",(function(){return Kt})),s.d(t,"ResyncCompletedEvent",(function(){return Xt})),s.d(t,"ResyncErrorEvent",(function(){return Zt})),s.d(t,"RemoteReferenceCreatedEvent",(function(){return es})),s.d(t,"RemoteResyncStartedEvent",(function(){return ts})),s.d(t,"RemoteResyncCompletedEvent",(function(){return ss})),s.d(t,"CollaboratorOpenedEvent",(function(){return is})),s.d(t,"CollaboratorClosedEvent",(function(){return ns})),s.d(t,"ModelCommittedEvent",(function(){return rs})),s.d(t,"ModelModifiedEvent",(function(){return os})),s.d(t,"OfflineModelsDownloadStartedEvent",(function(){return as})),s.d(t,"OfflineModelsDownloadStatusChangedEvent",(function(){return cs})),s.d(t,"OfflineModelsDownloadStoppedEvent",(function(){return hs})),s.d(t,"OfflineModelsSyncStartedEvent",(function(){return us})),s.d(t,"OfflineModelsSyncProgressEvent",(function(){return ds})),s.d(t,"OfflineModelsSyncCompletedEvent",(function(){return ls})),s.d(t,"OfflineModelsSyncAbortedEvent",(function(){return ps})),s.d(t,"OfflineModelSyncStartedEvent",(function(){return fs})),s.d(t,"OfflineModelSyncCompletedEvent",(function(){return ms})),s.d(t,"OfflineModelSyncErrorEvent",(function(){return gs})),s.d(t,"OfflineModelDownloadedEvent",(function(){return vs})),s.d(t,"OfflineModelUpdatedEvent",(function(){return ys})),s.d(t,"OfflineModelStatusChangedEvent",(function(){return ws})),s.d(t,"OfflineModelDeletedEvent",(function(){return bs})),s.d(t,"OfflineModelPermissionsRevokedEvent",(function(){return Os})),s.d(t,"HistoricalArray",(function(){return Wn})),s.d(t,"HistoricalBoolean",(function(){return zn})),s.d(t,"HistoricalElement",(function(){return Hn})),s.d(t,"HistoricalModel",(function(){return Er})),s.d(t,"HistoricalNull",(function(){return Qn})),s.d(t,"HistoricalNumber",(function(){return Kn})),s.d(t,"HistoricalObject",(function(){return Yn})),s.d(t,"HistoricalString",(function(){return Xn})),s.d(t,"HistoricalUndefined",(function(){return Zn})),s.d(t,"HistoricalDate",(function(){return er})),s.d(t,"ModelResult",(function(){return en})),s.d(t,"ElementReference",(function(){return ri})),s.d(t,"IndexReference",(function(){return Ws})),s.d(t,"LocalElementReference",(function(){return jn})),s.d(t,"LocalIndexReference",(function(){return An})),s.d(t,"LocalModelReference",(function(){return Tn})),s.d(t,"LocalPropertyReference",(function(){return Pn})),s.d(t,"LocalRangeReference",(function(){return Nn})),s.d(t,"ModelReference",(function(){return Bs})),s.d(t,"PropertyReference",(function(){return Qs})),s.d(t,"RangeReference",(function(){return Ys})),s.d(t,"ReferenceSetEvent",(function(){return $s})),s.d(t,"ReferenceClearedEvent",(function(){return Gs})),s.d(t,"ReferenceDisposedEvent",(function(){return Js})),s.d(t,"RealTimeArray",(function(){return di})),s.d(t,"RealTimeBoolean",(function(){return pi})),s.d(t,"RealTimeElement",(function(){return ni})),s.d(t,"RealTimeModel",(function(){return Dn})),s.d(t,"RealTimeNull",(function(){return qi})),s.d(t,"RealTimeNumber",(function(){return Li})),s.d(t,"RealTimeObject",(function(){return Ni})),s.d(t,"RealTimeString",(function(){return Ji})),s.d(t,"RealTimeDate",(function(){return Wi})),s.d(t,"RealTimeUndefined",(function(){return Bi})),s.d(t,"ModelCollaborator",(function(){return Ki})),s.d(t,"ModelPermissionManager",(function(){return hn})),s.d(t,"ModelPermissions",(function(){return Zi})),s.d(t,"PresenceService",(function(){return Kr})),s.d(t,"UserPresence",(function(){return Jr})),s.d(t,"UserPresenceSubscription",(function(){return Yr})),s.d(t,"PresenceAvailabilityChangedEvent",(function(){return Br})),s.d(t,"PresenceStateClearedEvent",(function(){return Hr})),s.d(t,"PresenceStateRemovedEvent",(function(){return Wr})),s.d(t,"PresenceStateSetEvent",(function(){return zr})),s.d(t,"ConvergenceEventEmitter",(function(){return R})),s.d(t,"ConvergenceServerError",(function(){return M})),s.d(t,"ConvergenceError",(function(){return O})),s.d(t,"CancellationToken",(function(){return E})),s.d(t,"PagedData",(function(){return S})),s.d(t,"LogLevel",(function(){return i})),s.d(t,"ConnectedEvent",(function(){return bn})),s.d(t,"ConnectionFailedEvent",(function(){return On})),s.d(t,"ConnectionScheduledEvent",(function(){return Rn})),s.d(t,"ConnectingEvent",(function(){return Mn})),s.d(t,"AuthenticatingEvent",(function(){return En})),s.d(t,"DisconnectedEvent",(function(){return Sn})),s.d(t,"InterruptedEvent",(function(){return Cn})),s.d(t,"ErrorEvent",(function(){return In})),s.d(t,"IdbStorageAdapter",(function(){return aa})),function(e){e.TRACE="trace",e.DEBUG="debug",e.INFO="info",e.WARN="warn",e.ERROR="error",e.SILENT="silent"}(i||(i={}));class n{static make(e){"object"==typeof e&&(Object.freeze(e),Object.keys(e).forEach((e,t,s)=>{n.make(e)}))}static copy(e,t){const s={};return Object.keys(e).forEach((i,n,r)=>{s[i]=void 0!==t[i]?t[i]:e[i]}),Object.freeze(s),s}static getOrDefault(e,t){return void 0===e?t:e}static update(e,t){return void 0!==t?t:e}}class r{constructor(e,t,s,i,r){this.timestamp=e,this.logger=t,this.level=s,this.message=i,this.error=r,n.make(this)}}class o{static isArray(e){return Array.isArray(e)}static isMap(e){return e instanceof Map}static isBoolean(e){return"boolean"==typeof e}static isDate(e){return e instanceof Date||"Date"===e.constructor.name}static isError(e){return e instanceof Error&&void 0!==e.message}static isFunction(e){return"function"==typeof e}static isNull(e){return null===e}static isNumber(e){return"number"==typeof e&&isFinite(e)}static isObject(e){return e&&"object"==typeof e&&e.constructor===Object}static isString(e){return"string"==typeof e||e instanceof String}static isSymbol(e){return"symbol"==typeof e}static isRegExp(e){return e&&"object"==typeof e&&e.constructor===RegExp}static isUndefined(e){return void 0===e}static isSet(e){return!o.isNull(e)&&!o.isUndefined(e)}static isNotSet(e){return!o.isSet(e)}static switch(e,t){if(o.isUndefined(t)||o.isNull(t))throw new Error("matcher must be defined.");if(o.isArray(e)&&!o.isUndefined(t.array))t.array(e);else if(o.isBoolean(e)&&!o.isUndefined(t.boolean))t.boolean(e);else if(o.isError(e)&&!o.isUndefined(t.error))t.error(e);else if(o.isDate(e)&&!o.isUndefined(t.date))t.date(e);else if(o.isFunction(e)&&!o.isUndefined(t.function))t.function(e);else if(o.isNull(e)&&!o.isUndefined(t.null))t.null();else if(o.isNumber(e)&&!o.isUndefined(t.number))t.number(e);else if(o.isObject(e)&&!o.isUndefined(t.object))t.object(e);else if(o.isRegExp(e)&&!o.isUndefined(t.regexp))t.regexp(e);else if(o.isString(e)&&!o.isUndefined(t.string))t.string(e);else if(o.isSymbol(e)&&!o.isUndefined(t.symbol))t.symbol(e);else if(o.isUndefined(e)&&!o.isUndefined(t.undefined))t.undefined();else{const s=o.isArray(t.custom)?t.custom.find(t=>o.isFunction(t.test)&&o.isFunction(t.callback)&&t.test(e)):void 0;o.isUndefined(s)?o.isUndefined(t.default)||t.default(e):s.callback(e)}}}const a={SILENT:-1,TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4};class c{constructor(e,t,s){this.N=e,this.U=s,this.setLevel(t)}getId(){return this.N}getLevel(){return this.k}setLevel(e){this.k=e,this.V=a[this.k.toUpperCase()]}trace(e){if(a.TRACE>=this.V){const t=new r(new Date,this.N,i.TRACE,this.L(e));this.F(t)}}debug(e){if(a.DEBUG>=this.V){const t=new r(new Date,this.N,i.DEBUG,this.L(e));this.F(t)}}info(e){if(a.INFO>=this.V){const t=new r(new Date,this.N,i.INFO,this.L(e));this.F(t)}}warn(e){if(a.WARN>=this.V){const t=new r(new Date,this.N,i.WARN,this.L(e));this.F(t)}}error(e,t){if(a.ERROR>=this.V){const s=new r(new Date,this.N,i.ERROR,this.L(e),t);this.F(s)}}F(e){this.V!==a.SILENT&&this.U.forEach(t=>t.writeLog(e))}L(e){return o.isFunction(e)?e():e}}function h(e,t){return Object.keys(e).reduce((s,i)=>(s[i]=t(e[i]),s),{})}function u(e,t){return Object.keys(e).forEach(s=>{t(s,e[s])})}function d(e){const t=typeof e;if(null==e||"string"===t||"number"===t||"boolean"===t)return e;if(e instanceof Date)return new Date(e.getTime());if(Array.isArray(e))return e.map(e=>d(e));if(e instanceof Map){const t=new Map;return e.forEach((e,s)=>{t.set(s,d(e))}),t}if(e instanceof Set){const t=new Set;return e.forEach(e=>t.add(d(e))),t}if(e.constructor===Object){const t={};return Object.keys(e).forEach(s=>{t[s]=d(e[s])}),t}const s=e.constructor.name||e.constructor.toString();throw new Error("Can not clone unknown type: "+s)}class l{static isSet(e){return!l.isNotSet(e)}static isNotSet(e){return null==e}static nonEmptyString(e){return"string"==typeof e&&e.length>0}static assertNonEmptyString(e,t){if(void 0===t&&(t="value"),!l.nonEmptyString(e))throw new Error(t+" must be a non-empty string: "+typeof e)}static assertString(e,t){if("string"!=typeof e)throw new Error(`${l.getValueName(t)} must be a string: ${typeof e}`)}static assertValidStringIndex(e,t,s,i){l.assertValidIndex(e,0,s?t.length+1:t.length,i)}static assertNumber(e,t){if("number"!=typeof e)throw new Error(`${l.getValueName(t)} must be a number: ${typeof e}`)}static assertArray(e,t){if(!Array.isArray(e))throw new Error(`${l.getValueName(t)} must be an array: ${typeof e}`)}static assertNonEmptyArray(e,t){if(l.assertArray(e,t),0===e.length)throw new Error(`${l.getValueName(t)} must be a non-empty array: ${typeof e}`)}static assertValidArrayIndex(e,t,s){l.assertValidIndex(e,0,t.length,s)}static assertValidIndex(e,t,s,i){if(l.assertNumber(e,i),e<t||e>=s)throw i=l.getValueName(i),new Error(`Index out of bounds. ${i} must be > 0 and <= ${s}: ${e}`)}static assertBoolean(e,t){if("boolean"!=typeof e)throw new Error(`${l.getValueName(t)} must be a boolean but was: ${typeof e}`)}static assertDate(e,t){if(!o.isDate(e))throw new Error(`${l.getValueName(t)} must be a Date but was: ${e.constructor.name}`)}static getValueName(e,t){return e||t||"value"}}class p{constructor(e){this.$=new Map,o.isSet(e.loggers)&&u(e.loggers,(e,t)=>{if(!l.nonEmptyString(e))throw new Error("A logger's id must be a non-empty string");this.$.set(e,this.G(t))}),this.$.set(p.ROOT_LOGGER_ID,this.G(e.root))}resolveLoggerConfig(e){let t=e,s=this.$.get(t);for(;void 0===s&&""!==t;){const e=t.lastIndexOf(".");t=t.substring(0,e),s=this.$.get(t)}return void 0!==s?s:this.$.get(p.ROOT_LOGGER_ID)}G(e){return o.isString(e)?{level:e}:e}}p.ROOT_LOGGER_ID="";class f{constructor(e){this.J=e||f.DEFAULT_PATTERN}B(e){return`${this.H(e.level.toUpperCase(),5," ",!1)} ${this.W(e)} ${e.message}`}W(e){const t=e.timestamp;return this.H(t.getHours(),2,"0")+":"+this.H(t.getMinutes(),2,"0")+":"+this.H(t.getSeconds(),2,"0")+"."+this.H(t.getMilliseconds(),3,"0")}H(e,t,s,i=!0){let n=String(e);for(;n.length<t;)n=i?s+n:n+s;return n}}f.FIELDS={LOG_NAME:"%l",MESSAGE:"%m",DATE_TIME:"%t",LOG_LEVEL:"%p"},f.DEFAULT_PATTERN="%t %p %m";class m extends f{constructor(e){super(e)}writeLog(e){switch(e.level){case i.TRACE:case i.DEBUG:console.debug(this.B(e));break;case i.INFO:console.info(this.B(e));break;case i.WARN:console.warn(this.B(e));break;case i.ERROR:e.error?console.error(this.B(e)+"\n",e.error):console.error(this.B(e))}}}const g={root:{level:i.WARN}};const v=new class{constructor(e){this.configure(e||{}),this.Y=new m("")}configure(e){const t=Object.assign(Object.assign({},g),e);this.K=new p(t),this.$=new Map}root(){return this.logger()}logger(e){if(null==e&&(e=p.ROOT_LOGGER_ID),!this.$.has(e)){const t=this.K.resolveLoggerConfig(e);this.$.set(e,new c(e,t.level,[this.Y]))}return this.$.get(e)}};class y{constructor(e,t,s){this.X=()=>{this.Z.sendPing(),this.ee()},this.te=()=>{this.se.trace(()=>"A pong timeout occurred"),this.Z.onTimeout()},this.Z=e,this.ie=t,this.ne=s,this.re=!1,this.se=v.logger("heartbeat")}messageReceived(){this.re&&(this.oe(),this.ae())}start(){if(null==this.Z)throw new Error("Can't start the HeartbeatManager unless the callback is set.");this.se.trace(()=>"HeartbeatHelper started with Ping Interval "+this.ie+" and Pong Timeout "+this.ne),this.re=!0,this.messageReceived()}stop(){this.re=!1,this.ce(),this.oe(),this.se.trace(()=>"HeartbeatHelper stopped.")}get started(){return this.re}dispose(){this.stop()}ee(){this.oe();const e=1e3*this.ne;this.he=setTimeout(this.te,e)}oe(){null!==this.he&&(clearTimeout(this.he),this.he=null)}ce(){null!==this.ue&&(clearTimeout(this.ue),this.ue=null)}ae(){this.ce();const e=1e3*this.ie;this.ue=setTimeout(this.X,e)}}var w=s(4),b=s(0);class O extends Error{constructor(e,t,s){super(e),this.de=t,this.le=s||{},this.name="ConvergenceError",Object.setPrototypeOf(this,O.prototype)}get code(){return this.de}get details(){return this.le}}class R{constructor(){this.pe=new w.Subject,this.fe=this.pe.asObservable().pipe(Object(b.share)()),this.P=new Map}static me(e){if("string"==typeof e)return e.toLowerCase();throw new Error("Event names must be strings: "+typeof e)}addListener(e,t){if("function"!=typeof t)throw new TypeError("Listeners must be functions");e=R.me(e);let s=this.P.get(e);if(void 0===s)s=[],this.P.set(e,s);else if(void 0!==s.find(e=>e.listener===t))return this;const i=this.fe.pipe(Object(b.filter)(t=>t.name.toLowerCase()===e)).subscribe(e=>{t(e)});return s.push({listener:t,subscription:i}),this}on(e,t){return this.addListener(e,t)}once(e,t){const s=i=>{this.removeListener(e,s),t(i)};return this.addListener(e,s)}removeAllListeners(){return Array.from(this.P.keys()).forEach(e=>this.removeListeners(e)),this}removeListeners(e){if(e=R.me(e),this.P.has(e)){this.P.get(e).forEach(e=>e.subscription.unsubscribe()),this.P.delete(e)}return this}removeListener(e,t){if(e=R.me(e),this.P.has(e)){const s=this.P.get(e),i=s.findIndex(e=>e.listener===t);if(-1!==i){const e=s[i];s.splice(i,1),e.subscription.unsubscribe()}0===s.length&&this.P.delete(e)}return this}off(e,t){return this.removeListener(e,t)}events(){return this.fe}ge(e){return e.subscribe(e=>{this.pe.next(e)},e=>{this.pe.error(e)})}ve(e){if(l.isNotSet(e.name))throw new O("An event must have a name.");this.pe.next(e)}ye(){this.pe.complete()}}class M extends Error{constructor(e,t,s){super(e),this.de=t,this.le=s,Object.setPrototypeOf(this,M.prototype)}get code(){return this.de}get details(){return this.le}}class E{constructor(){this.we=null,this.be=!1}static create(){return new E}cancel(){if(null===this.we)throw new Error("The cancellation token must be bound before calling cancel.");if(this.be)throw new Error("The cancellation token has already been cancelled.");this.we(),this.be=!0}isBound(){return null!==this.we}Oe(e){if("function"!=typeof e)throw new Error("callback must be a function");if(null!==this.we)throw new Error("The cancellation token was already bound");this.we=e}}class S{constructor(e,t,s){this.data=e,this.offset=t,this.totalResults=s,Object.freeze(this),Object.freeze(e)}}class C{constructor(){this.Re=!1,this.Me=!1}isPending(){return!this.Me&&!this.Re}isRejected(){return this.Re}isResolved(){return this.Me}resolve(e){this.Re=!1,this.Me=!0}reject(e){this.Re=!0,this.Me=!1}resolveFromPromise(e){e.then(e=>this.resolve(e)).catch(e=>this.reject(e))}}class I extends C{constructor(){super(),this.Ee=new Promise((e,t)=>{this.Se=e,this.Ce=t})}resolve(e){super.resolve(e),this.Se(e)}reject(e){super.reject(e),this.Ce(e)}promise(){return this.Ee}}class _ extends R{constructor(e,t,s){super(),this.Ie=null,this.se=v.logger("socket");let i=e;i=i.replace(/https:/i,"wss:"),i=i.replace(/http:/i,"ws:"),this._e=i,this.xe=null,this.De=null!==t?t:WebSocket,this.Te=null!==s?s:e=>new this.De(e)}static je(e){e.onmessage=void 0,e.onopen=void 0,e.onerror=void 0,e.onclose=void 0}get url(){return this._e}open(){if(this.Ae=new I,this.xe&&this.xe.readyState===this.De.CONNECTING)throw new Error("Socket already in the process of opening.");if(this.xe&&this.xe.readyState===this.De.OPEN)throw new Error("Can not call connect on a socket that is already connected.");if(this.xe&&this.xe.readyState===this.De.CLOSING)throw new Error("Can not call connect on a socket that is in the process of closing.");return this.xe=this.Te(this._e),this.xe.binaryType="arraybuffer",this.Pe(this.xe),this.Ae.promise()}close(){return this.Ne(!0)}terminate(e){return this.Ne(!1,e)}isOpen(){return null!==this.xe&&this.xe.readyState===this.De.OPEN}isConnecting(){return null!==this.xe&&this.xe.readyState===this.De.CONNECTING}isClosed(){return null===this.xe||this.xe.readyState===this.De.CLOSED}send(e){if(!this.isOpen())throw new Error("Can't send messages because the WebSocket is not open.");this.xe.send(e)}Ne(e,t){if(this.xe&&this.xe.readyState!==this.De.CLOSED){if(this.xe.readyState===this.De.CLOSING)return this.se.trace("Attempted to close a WebSocket that is in the CLOSING state."),Promise.reject(new Error("Can not call close on a WebSocket in the CLOSING state."));if(this.xe.readyState===this.De.CONNECTING?this.se.trace("Closing a connecting WebSocket."):this.se.trace("Closing an open WebSocket."),this.qe=new I,e?(this.se.debug("Closing WebSocket normally."),this.xe.close(1e3,t||"The client closed the connection")):(this.se.debug("Closing WebSocket abnormally: "+t),this.xe.close(4006,t)),null!==this.Ae){const e=this.Ae;this.Ae=null,e.reject(new Error("Web Socket connection closed while opening."))}return this.qe.promise()}return this.se.trace("Attempted to close a WebSocket that is in the CLOSED state."),Promise.reject(new Error("Can not call close on a WebSocket in the CLOSED state."))}Pe(e){e.onmessage=e=>{try{if(!(e.data instanceof ArrayBuffer))throw new O("Convergence protocol does not accept text frames: "+e.data);{const t=new Uint8Array(e.data);this.ve({name:_.Events.MESSAGE,message:t})}}catch(e){this.ve({name:_.Events.ERROR,error:e}),this.se.error("Error handling  web socket frame",e)}},e.onopen=e=>{if(this.Ae){this.se.debug("WebSocket connection opened");try{this.Ae.resolve()}catch(e){this.se.error("Error resolving WebSocket Open Promise.",e)}this.Ae=null}else{const e={name:_.Events.ERROR,error:new O("Received onOpen event while in state: "+this.xe.readyState)};this.ve(e)}},e.onerror=e=>{if(this.se.debug("WebSocket Error: "+e.message),void 0===this.xe||this.xe.readyState===this.De.CONNECTING)try{const t={name:_.Events.ERROR,error:new O("WebSocket error: "+e.message)};this.ve(t)}catch(e){this.se.error("Error handling WebSocket error.",e)}else this.Ie=e.error},e.onclose=t=>{this.se.trace(()=>`WebSocket close event: {code: ${t.code}, reason: "${t.reason}"}`),_.je(e),this.xe=null;try{if(this.Ae&&(this.se.debug(()=>`Web Socket connection failed: {code: ${t.code}, reason: "${t.reason}"}`),this.Ae.reject(new Error(this.Ie)),this.Ae=null),this.qe){const e={name:_.Events.CLOSE,reason:"close requested by client"};this.ve(e),this.qe.resolve()}else{this.se.debug(()=>`Web Socket connection unexpectedly closed: {code: ${t.code}, reason: "${t.reason}"}`);const e={name:_.Events.CLOSE,reason:"unexpected Web Socket closure."};this.ve(e)}}catch(e){this.se.error("Error handling web socket close event.",e)}}}}_.Events={MESSAGE:"message",ERROR:"error",CLOSE:"close"};var x=s(27),D=s.t(x,2);const T=s(28).Root.fromJSON(D);class j{static decode(e){const t=j.Ue.decode(e);return j.Ue.toObject(t)}static encode(e){const t=j.Ue.fromObject(e);return j.Ue.encode(t).finish()}}j.Ue=T.lookupType("com.convergencelabs.convergence.proto.ConvergenceMessage");const A={MODEL_ALREADY_EXISTS:"model_already_exists",REQUEST_TIMEOUT:"request_timeout",CONNECTION_FAILED:"connection_failed",AUTHENTICATION_FAILED:"authentication_failed",OFFLINE:"offline",CHAT_NOT_JOINED:"chat_not_joined"};var P;n.make(A),function(e){e.NORMAL="normal",e.CONVERGENCE="convergence",e.ANONYMOUS="anonymous"}(P||(P={}));class N{constructor(e,t){this.userType=e,this.username=t,l.assertString(t,"username"),this.ke=N.guid(this.userType,this.username),Object.freeze(this)}static normal(e){return new N(P.NORMAL,e)}static anonymous(e){return new N(P.ANONYMOUS,e)}static convergence(e){return new N(P.CONVERGENCE,e)}static guid(e,t){return`${e}:${t}`}static fromGuid(e){l.assertNonEmptyString(e,"guid");const t=e.indexOf(":");if(t<0)throw new Error("Invalid guid value. Not separator found: "+e);const s=N.toDomainUserType(e.substring(0,t)),i=e.substring(t+1,e.length);return new N(s,i)}static toDomainUserType(e){switch(e){case P.NORMAL:return P.NORMAL;case P.CONVERGENCE:return P.CONVERGENCE;case P.ANONYMOUS:return P.ANONYMOUS;default:throw new O("Invalid guid value. Unrecognized user type: "+e)}}static toDomainUserId(e){return N.of(e)}static of(e){return e instanceof N?e:N.normal(e)}toGuid(){return this.ke}equals(e){return this.username===e.username&&this.userType===e.userType}}class q{constructor(e,t,s,i,n,r){this.userType=e,this.username=t,this.firstName=s,this.lastName=i,this.displayName=n,this.email=r,this.anonymous=e===P.ANONYMOUS,this.convergence=e===P.CONVERGENCE,this.normal=e===P.NORMAL,this.userId=new N(this.userType,this.username),Object.freeze(this)}}class U{constructor(e,t,s){this.id=e,this.description=t,this.members=s,Object.freeze(this)}}function k(e){switch(e){case"username":return 1;case"email":return 2;case"firstName":return 3;case"lastName":return 4;case"displayName":return 5;default:throw new O("Invalid user field: "+e)}}function V(e){return new q(ne(e.userId.userType),e.userId.username,K(e.firstName),K(e.lastName),K(e.displayName),K(e.email))}const L=["username","email","firstName","lastName","displayName"];class F{constructor(e){this.Ve=e}session(){return this.Ve.session()}profile(){return this.user(this.Ve.session().user().userId)}userExists(e){return this.user(e).then(e=>void 0!==e)}user(e){return l.isNotSet(e)?Promise.reject("Must specify a user id."):this.users([e]).then(e=>0===e.length?Promise.resolve(void 0):1===e.length?Promise.resolve(e[0]):Promise.reject(new Error("Error getting user.")))}users(e){if(l.assertArray(e,"users"),0===e.length)return Promise.resolve([]);const t=e.map(e=>e instanceof N?e:N.normal(e)),s={usersGetRequest:{userIds:Array.from(new Set(t)).map(ie)}};return this.Ve.request(s).then($)}search(e){if(void 0===e.fields||null===e.fields||Array.isArray(e.fields)&&0===e.fields.length)return Promise.reject(new Error("Must specify at least one field to search"));if(void 0===e.term||null===e.term)return Promise.reject(new Error("Must specify a search term"));{const t=Array.isArray(e.fields)?e.fields:[e.fields],s=e.orderBy||{field:"username",ascending:!0},i={userSearchRequest:{fields:this.Le(t),value:e.term,offset:Q(e.offset),limit:Q(e.limit),orderField:k(s.field||"username"),ascending:s.ascending}};return this.Ve.request(i).then($)}}groups(e){l.assertNonEmptyArray(e,"ids");const t={userGroupsRequest:{ids:e}};return this.Ve.request(t).then(e=>{const{userGroupsResponse:t}=e;return t.groupData.map(e=>{return new U((t=e).id,t.description,t.members?t.members.map(e=>se(e).username):[]);var t})})}group(e){return this.groups([e]).then(e=>e[0])}groupsForUser(e){return this.groupsForUsers([e]).then(t=>t[e])}groupsForUsers(e){const t={userGroupsForUsersRequest:{users:e.map(e=>ie(N.normal(e)))}};return this.Ve.request(t).then(e=>{const{userGroupsForUsersResponse:t}=e,s={};return t.userGroups.forEach(e=>{if(e.hasOwnProperty("user")){let t=se(e.user);s[t.username]=e.groups}}),s})}Le(e){const t=[];return e.forEach(e=>{if(L.indexOf(e)<0)throw new Error("Invalid user search field: "+e);const s=k(e);t.indexOf(s)<0&&t.push(s)}),t}}function $(e){const{userListResponse:t}=e;return z(t.userData).map(V)}class G{static objectToMap(e){const t=new Map;return Object.keys(e).forEach(s=>t.set(s,e[s])),t}static mapToObject(e){const t={};return e.forEach((e,s)=>t[s]=e),t}static coerceToObject(e){return void 0===e?{}:e instanceof Map?G.mapToObject(e):e}static coerceToMap(e){return void 0===e?new Map:e instanceof Map?e:G.objectToMap(e)}static toStringMap(e){return e?e instanceof Map?e:G.objectToMap(e):e}}class J{constructor(){this.Fe=new Map}static of(e){if(o.isObject(e)&&(e=G.coerceToMap(e)),e instanceof J||o.isMap(e)){const t=new J;return e.forEach((e,s)=>{t.set(s,e)}),t}throw new O("Can not convert the supplied value to a DomainUserIdMap")}static fromGuidObjectMap(e){const t=new J;return u(e,(e,s)=>{t.set(N.fromGuid(e),s)}),t}get(e){return this.Fe.get(N.of(e).toGuid())}set(e,t){this.Fe.set(N.of(e).toGuid(),t)}has(e){return this.Fe.has(N.of(e).toGuid())}delete(e){this.Fe.delete(N.of(e).toGuid())}keys(){return Array.from(this.Fe.keys()).map(N.fromGuid)}entries(){return Array.from(this.Fe.entries()).map(e=>[N.fromGuid(e[0]),e[1]])}size(){return this.Fe.size}forEach(e){this.Fe.forEach((t,s)=>{e(t,N.fromGuid(s))})}toGuidObjectMap(){const e={};return this.Fe.forEach((t,s)=>{e[s]=t}),e}}function B(e){return null==e?0:"number"==typeof e?e:e.toNumber()}function H(e){return e||!1}function W(e){return e||""}function z(e){return e||[]}function Y(e){return e||{}}function Q(e){return void 0===e?null:{value:e}}function K(e){return e?e.value:null}function X(e){const t=B(e.seconds),s=B(e.nanos),i=Math.round(s/1e6);return new Date(1e3*t+i)}function Z(e){const t=e.getTime(),s=Math.floor(t/1e3);return{seconds:s,nanos:1e6*(t-1e3*s)}}function ee(e){if(void 0!==e.nullValue)return null;if(void 0!==e.boolValue)return H(e.boolValue);if(void 0!==e.stringValue)return W(e.stringValue);if(void 0!==e.numberValue)return B(e.numberValue);if(void 0!==e.structValue)return h(Y(e.structValue.fields),ee);if(void 0!==e.listValue)return z(e.listValue.values).map(ee);throw new O("Could not deserialize json value: "+JSON.stringify(e))}function te(e){if(null===e)return{nullValue:0};if("boolean"==typeof e)return{boolValue:e};if("string"==typeof e)return{stringValue:e};if("number"==typeof e)return{numberValue:e};if(Array.isArray(e))return{listValue:{values:e.map(te)}};if(void 0!==e&&e.constructor===Object)return{structValue:{fields:h(e,te)}};if(void 0!==e)throw new O("Can not serialize unknown data type: "+e)}function se(e){return new N(ne(e.userType),W(e.username))}function ie(e){return{userType:re(e.userType),username:e.username}}function ne(e){switch(e){case 0:case void 0:return P.NORMAL;case 1:return P.CONVERGENCE;case 2:return P.ANONYMOUS}}function re(e){switch(e){case P.NORMAL:return 0;case P.CONVERGENCE:return 1;case P.ANONYMOUS:return 2}}class oe extends R{constructor(e,t){super(),this.$e=0,this.Ge=!1,this.Je=!1,this.se=v.logger("protocol"),this.Be=t,this.xe=e,this.xe.on(_.Events.MESSAGE,e=>{this.He(e.message)}),this.xe.on(_.Events.ERROR,e=>{this.We(e.error)}),this.xe.on(_.Events.CLOSE,e=>{this.Je&&(this.Ge?this.ze(e.reason):this.Ye())}),this.Qe=new Map}connect(){return this.xe.open().then(()=>{this.Je=!0;const e={sendPing:()=>{this.sendMessage({ping:{}})},onTimeout:()=>{this.abort("heartbeat pong timeout").then(()=>{this.se.debug("Connection aborted after pong timeout")}).catch(e=>{this.se.error("Error aborting connection after a pong timeout",e)})}};this.Ke=new y(e,this.Be.heartbeatConfig.pingInterval,this.Be.heartbeatConfig.pongTimeout),this.Be.heartbeatConfig.enabled&&this.Ke.start()})}send(e){this.sendMessage(e)}request(e,t){const s=this.$e;this.$e++;const i=new I,n=1e3*(void 0!==t?t:this.Be.defaultRequestTimeout),r=setTimeout(()=>{const t=this.Qe.get(s);t&&t.replyDeferred.reject(new O("A request timeout occurred.",A.REQUEST_TIMEOUT,{message:e}))},n);return this.Qe.set(s,{reqId:s,replyDeferred:i,timeoutTask:r}),this.sendMessage(Object.assign(Object.assign({},e),{requestId:{value:s}})),i.promise()}abort(e){this.Ke&&this.Ke.started&&this.Ke.stop();const t=this.xe.isOpen()||this.xe.isConnecting()?this.xe.terminate(e):Promise.resolve();return this.Ye(),t}close(){return this.Ge=!0,this.removeAllListeners(),void 0!==this.Ke&&this.Ke.started&&this.Ke.stop(),this.Qe.forEach(e=>{clearTimeout(e.timeoutTask),e.replyDeferred.reject(new Error("The connection was closed while waiting for a reply to a request message."))}),this.xe.close()}sendMessage(e){e.ping||e.pong?this.se.trace(()=>"SND: "+JSON.stringify(e)):this.se.debug(()=>"SND: "+JSON.stringify(e));try{const t=j.encode(e);this.xe.send(t)}catch(e){throw this.We(e),e}}He(e){const t=j.decode(e);this.Be.heartbeatConfig.enabled&&this.Ke&&this.Ke.messageReceived(),t.ping||t.pong?this.se.trace(()=>"RCV: "+JSON.stringify(t)):this.se.debug(()=>"RCV: "+JSON.stringify(t)),t.ping?this.Xe():t.pong||(void 0!==t.requestId?this.Ze(t):void 0!==t.responseId?this.et(t):this.tt(t))}ze(e){this.Je=!1,this.Ke&&this.Ke.started&&this.Ke.stop();const t={name:oe.Events.CLOSED,reason:e};this.ve(t)}Ye(){this.Je=!1,this.Ke&&this.Ke.started&&this.Ke.stop(),this.ve({name:oe.Events.DROPPED})}We(e){const t={name:oe.Events.ERROR,error:e};this.ve(t)}tt(e){Promise.resolve().then(()=>{const t={name:"message",request:!1,message:e};this.ve(t)})}Ze(e){const t=e.requestId.value||0,s={name:"message",request:!0,callback:new ae(t,this),message:e};this.ve(s)}et(e){const t=e.responseId.value||0,s=this.Qe.get(t);if(this.Qe.delete(t),s)if(clearTimeout(s.timeoutTask),e.error){const t=e.error,i=h(Y(t.details),ee);s.replyDeferred.reject(new M(t.message,t.code,i))}else s.replyDeferred.resolve(e)}Xe(){this.sendMessage({pong:{}})}}oe.Events={MESSAGE:"message",ERROR:"error",CLOSED:"close",DROPPED:"dropped"};class ae{constructor(e,t){this.st=e,this.it=t}reply(e){this.it.sendMessage(Object.assign(Object.assign({},e),{responseId:{value:this.st}}))}unknownError(){this.unexpectedError("An unknown error has occurred")}unexpectedError(e){this.expectedError("unknown",e)}expectedError(e,t,s){const i={code:e,message:t,details:s=s||{}};this.it.sendMessage({error:i,responseId:{value:this.st}})}}class ce{constructor(e,t,s,i,n){this.nt=e,this.rt=i,this.ot=s,this.at=n,this.Ve=t}domain(){return this.nt}sessionId(){return this.rt}user(){return this.ot}reconnectToken(){return this.at}isConnected(){return this.Ve.isConnected()}assertOnline(){if(!this.isConnected()){throw new O("Cannot perform this action while offline",A.OFFLINE)}}ct(e){this.rt=e}ht(e){this.ot=e}ut(e){this.at=e}}class he{constructor(){this.dt=new I,this.be=!1,this.lt=null,this.pt=null,this.ft=null}challenge(){return{password:e=>{this.gt(e)},jwt:e=>{this.vt(e)},anonymous:e=>{this.yt(e)},cancel:()=>{this.wt()}}}fulfilled(){return this.dt.promise()}isCompleted(){return this.bt}isPassword(){return null!==this.lt}isJwt(){return null!==this.pt}isAnonymous(){return null!==this.ft}isCanceled(){return this.be}getPassword(){return this.lt}getJwt(){return this.pt}getDisplayName(){return this.ft}gt(e){this.bt=!0,this.Ot(e).then(e=>{this.lt=e,this.dt.resolve()})}vt(e){this.bt=!0,this.Ot(e).then(e=>{this.pt=e,this.dt.resolve()})}yt(e){this.bt=!0,this.Ot(e).then(e=>{this.ft=e,this.dt.resolve()})}wt(){this.bt=!0,this.be=!0,this.dt.resolve()}Ot(e){try{return o.isFunction(e)?Promise.resolve(e()):o.isFunction(e.then)?e:Promise.resolve(e)}catch(e){return Promise.reject(e)}}}var ue;!function(e){e.ANONYMOUS="anonymous",e.PASSWORD="password",e.JWT="jwt",e.RECONNECT="reconnect"}(ue||(ue={}));class de{constructor(e,t){if(e<1)throw new Error;if(t.length<2)throw new Error;this.Rt=t,this.Mt=e}nextString(){let e="";for(let t=0;t<this.Mt;t++)e+=this.Rt.charAt(Math.floor(Math.random()*this.Mt));return e}}de.UpperCaseLetters="ABCDEFGHIJKLMNOPQRSTUVWXYZ",de.LowerCaseLetters=de.UpperCaseLetters.toLowerCase(),de.Digits="0123456789",de.AlphaNumeric=de.UpperCaseLetters+de.LowerCaseLetters+de.Digits,de.Base64=de.AlphaNumeric+"/+";var le,pe=function(e,t,s,i){return new(s||(s=Promise))((function(n,r){function o(e){try{c(i.next(e))}catch(e){r(e)}}function a(e){try{c(i.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(o,a)}c((i=i.apply(e,t||[])).next())}))};class fe extends R{constructor(e,t,s){super(),this.se=v.logger("connection"),this.Et=e=>{this.se.debug(()=>"Browser connectivity changed, restarting connection schedule."),this.St===le.CONNECTING&&(this.Ct=0,this.It())},this._t=()=>{this.xt();const e=1e3*this.Dt.connectionTimeout;this.Tt=setTimeout(this.jt,e)},this.xt=()=>{null!==this.Tt&&(clearTimeout(this.Tt),this.Tt=null)},this.jt=()=>{this.it.abort("connection timeout exceeded").catch(e=>this.se.error("error aborting connection after a connection timeout",e))},this._e=e.trim().toLowerCase();if(!/^(https?|wss?):\/{2}.+\/.+\/.+/g.test(this._e))throw new Error("Invalid domain connection url: "+this._e);this.Dt=s,this._e=e,this.Ct=0,this.St=le.DISCONNECTED,this.Tt=null,this.At=null,this.Pt=!0,this.it=null,this.Nt=null,this.qt=null,this.Ut=null;const i="offline:"+fe.kt.nextString();this.Vt=new ce(t,this,null,i,null),"undefined"!=typeof window&&window.addEventListener("online",this.Et)}url(){return this._e}session(){return this.Vt}disconnect(){return this.qt=null,this.Ut=null,null!==this.Tt&&(clearTimeout(this.Tt),this.Tt=null),null!==this.At&&(clearTimeout(this.At),this.At=null),null!==this.Lt&&(this.Lt.reject(new Error("Connection canceled by user")),this.Lt=null),this.St===le.DISCONNECTED?Promise.reject(new Error("Connection is already disconnected.")):(this.St=le.DISCONNECTING,this.Pt=!0,"undefined"!=typeof window&&window.removeEventListener("online",this.Et),this.it.close().then(()=>{this.Nt.unsubscribe(),this.it=null,this.Nt=null,this.Ft()}))}reconnect(){if(this.St!==le.INTERRUPTED&&this.St!==le.DISCONNECTED)throw new Error("Can only call reconnect on an disconnected or interrupted connection.");return this.connectWithReconnectToken(()=>Promise.resolve(this.Vt.reconnectToken())).then(()=>{})}isConnected(){return this.St===le.CONNECTED}isDisconnected(){return this.St===le.DISCONNECTED}send(e){this.it.send(e)}request(e,t){return this.it.request(e,t)}connectWithPassword(e){this.Ut=ue.PASSWORD;return this.$t(()=>e().then(e=>{l.assertNonEmptyString(e.username,"username"),l.assertNonEmptyString(e.password,"password");return{password:{username:e.username,password:e.password}}}))}connectWithJwt(e){this.Ut=ue.JWT;return this.$t(()=>e().then(e=>{l.assertNonEmptyString(e,"jwt");return{jwt:{jwt:e}}}))}connectWithReconnectToken(e){this.Ut=ue.RECONNECT;return this.$t(()=>e().then(e=>{l.assertNonEmptyString(e,"token");return{reconnect:{token:e}}})).catch(e=>this.Gt(e))}Gt(e){if(!(e instanceof O&&e.code===A.AUTHENTICATION_FAILED))return Promise.resolve(e);if(!o.isFunction(this.Dt.fallbackAuth))return Promise.resolve(e);{const t=new he;if(this.Dt.fallbackAuth(t.challenge()),!t.isCompleted())return Promise.reject(new Error("You must call one of the auth challenge methods."));t.fulfilled().then(()=>{if(t.isPassword()){const e=this.session().user().username,s=t.getPassword();return this.connectWithPassword(()=>Promise.resolve({username:e,password:s}))}return t.isJwt()?this.connectWithJwt(()=>Promise.resolve(t.getJwt())):t.isAnonymous()?this.connectAnonymously(()=>Promise.resolve(t.getDisplayName())):(t.isCanceled(),Promise.reject(e))})}}connectAnonymously(e){this.Ut=ue.ANONYMOUS;return this.$t(()=>e().then(e=>({anonymous:{displayName:Q(e)}})))}messages(){return this.events().pipe(Object(b.filter)(e=>"message"===e.name))}$t(e){return this.qt=e,this.St===le.CONNECTED?Promise.reject(new O("already connected")):this.St===le.CONNECTING?Promise.reject(new O("already connecting")):this.Jt()}Jt(){if(this.St!==le.DISCONNECTED&&this.St!==le.INTERRUPTED)throw new Error("Can only call connect on a disconnected or interrupted connection.");return this.Ct=0,this.Lt=new I,this.St=le.CONNECTING,this.It(),this.Lt.promise()}It(){null!==this.At&&(clearTimeout(this.At),this.At=null),this.Ct++,this.se.debug(()=>"Attempting to open web socket connection to: "+this._e),this._t(),this.ve({name:fe.Events.CONNECTING}),this.it=this.Bt(),this.Ht()}Ht(){this.it.connect().then(()=>(this.xt(),this.se.debug("Server connection established."),this.Pt=!1,this.Wt())).catch(e=>{this.se.debug(e.message),this.xt();const t={name:fe.Events.CONNECTION_FAILED,authMethod:this.Ut,code:"server_connection_failed",details:e.message};if(this.ve(t),!this.Pt||this.Dt.autoReconnectOnInitial)this.zt();else{const e=`The initial connection to '${this._e}' failed, and 'reconnect.autoReconnectOnInitial' was set to false`;this.Lt.reject(new O(e,"initial_connection_failed")),this.Ft()}})}Bt(){const e=new _(this._e,this.Dt.webSocketClass,this.Dt.webSocketFactory),t=new oe(e,{defaultRequestTimeout:this.Dt.defaultRequestTimeout,heartbeatConfig:{enabled:this.Dt.heartbeatEnabled,pingInterval:this.Dt.pingInterval,pongTimeout:this.Dt.pongTimeout}});return this.Nt=t.events().subscribe(e=>{switch(e.name){case oe.Events.ERROR:{const t=e,s={name:fe.Events.ERROR,error:t.error};this.ve(s);break}case oe.Events.DROPPED:this.Yt();break;case oe.Events.CLOSED:this.Ft();break;case oe.Events.MESSAGE:{const t=e,s={name:fe.Events.MESSAGE,request:t.request,callback:t.callback,message:t.message};this.ve(s);break}}}),t}Wt(){return pe(this,void 0,void 0,(function*(){const e=yield this.qt(),t=fe.Qt(e),s={name:fe.Events.AUTHENTICATING,method:this.Ut};this.ve(s);const i=this.Dt.connectionRequestTimeout,n=(yield this.request({connectionRequest:t},i)).connectionResponse;return n.success?this.Kt(n.success):this.Xt(n.failure,this.Ut)}))}Kt(e){this.Zt=e.domainId,this.es=e.namespace,this.Vt.ht(V(e.user)),this.Vt.ct(e.sessionId),this.Vt.ut(e.reconnectToken),this.St=le.CONNECTED;const t={name:fe.Events.CONNECTED,state:Y(e.presenceState)};this.ve(t),this.Lt.resolve(),this.Lt=null,this.Ct=0}Xt(e,t){this.xt();const{code:s,details:i,retryOk:n}=e,r={name:fe.Events.CONNECTION_FAILED,authMethod:t,code:W(s),details:W(i)};if(this.ve(r),this.Nt.unsubscribe(),this.it.close().catch(e=>this.se.error("Error closing protocol connection after connection failure",e)),this.it=null,this.Nt=null,H(n))if(!this.Pt||this.Dt.autoReconnectOnInitial)this.zt();else{this.qt=null,this.Ut=null;const e=`The initial connection to '${this._e}' failed, and 'reconnect.autoReconnectOnInitial' was set to false.`;this.Lt.reject(new O(e,W(s))),this.Ft()}else this.Lt.reject(new O(W(i),W(s))),this.Ft()}static Qt(e){return Object.assign(Object.assign({},e),{client:"JavaScript",clientVersion:"1.0.0-rc.12"})}zt(){if(this.St===le.CONNECTING){const e=Math.min(this.Ct,this.Dt.reconnectIntervals.length-1),t=this.Dt.reconnectIntervals[e];this.se.debug(()=>`Scheduling web socket connection in ${t} seconds.`);const s={name:fe.Events.CONNECTION_SCHEDULED,delay:t};this.ve(s),this.At=setTimeout(()=>this.It(),1e3*t)}}Ft(){this.St!==le.DISCONNECTED&&(this.St=le.DISCONNECTED,this.ve({name:fe.Events.DISCONNECTED}))}Yt(){this.St=le.INTERRUPTED,this.ve({name:fe.Events.INTERRUPTED}),this.Dt.autoReconnect&&this.Vt.reconnectToken()?this.reconnect().catch(e=>this.se.error("Unexpected error reconnecting",e)):this.Ft()}}fe.Events={MESSAGE:"message",CONNECTION_SCHEDULED:"connection_scheduled",CONNECTING:"connecting",AUTHENTICATING:"authenticating",CONNECTED:"connected",CONNECTION_FAILED:"connection_failed",INTERRUPTED:"interrupted",DISCONNECTED:"disconnected",ERROR:"error"},fe.kt=new de(32,de.AlphaNumeric),function(e){e[e.DISCONNECTED=0]="DISCONNECTED",e[e.CONNECTING=1]="CONNECTING",e[e.CONNECTED=2]="CONNECTED",e[e.INTERRUPTED=3]="INTERRUPTED",e[e.DISCONNECTING=4]="DISCONNECTING"}(le||(le={}));class me{constructor(e){this.type=e}}const ge={COMPOUND:"Compound",ARRAY_INSERT:"ArrayInsert",ARRAY_REORDER:"ArrayReorder",ARRAY_REMOVE:"ArrayRemove",ARRAY_SET:"ArraySet",ARRAY_VALUE:"ArrayValue",BOOLEAN_VALUE:"BooleanValue",NUMBER_DELTA:"NumberDelta",NUMBER_VALUE:"NumberValue",OBJECT_ADD:"ObjectAdd",OBJECT_REMOVE:"ObjectRemove",OBJECT_SET:"ObjectSet",OBJECT_VALUE:"ObjectValue",STRING_SPLICE:"StringSplice",STRING_VALUE:"StringValue",DATE_VALUE:"DateValue"};Object.freeze(ge);const ve=ge;class ye extends me{constructor(e){super(ve.COMPOUND),this.ops=e,Object.freeze(this)}copy(e){return new ye(n.update(this.ops,e.ops))}}class we{constructor(e,t){this.serverOp=e,this.clientOp=t,Object.freeze(this)}}class be{constructor(e){this.ts=e}transform(e,t){return e instanceof ye?this.transformServerCompoundOperation(e,t):t instanceof ye?this.transformClientCompoundOperation(e,t):this.transformTwoDiscreteOps(e,t)}transformClientCompoundOperation(e,t){let s=e;const i=t.ops.map(e=>{const t=this.transform(s,e);return s=t.serverOp,t.clientOp});return new we(s,new ye(i))}transformServerCompoundOperation(e,t){let s=t;const i=e.ops.map(e=>{const t=this.transform(e,s);return s=t.clientOp,t.serverOp});return new we(new ye(i),s)}transformTwoDiscreteOps(e,t){return e.noOp||t.noOp?new we(e,t):e.id===t.id?this.transformIdenticalPathOperations(e,t):new we(e,t)}transformIdenticalPathOperations(e,t){const s=this.ts.getOperationTransformationFunction(e,t);if(s)return s(e,t);throw new Error(`No function found for: (${e.type},${e.type})`)}}const Oe=(e,t)=>e.index<=t.index?new we(e,t.copy({index:t.index+1})):new we(e.copy({index:e.index+1}),t),Re=(e,t)=>e.index<=t.index?new we(e,t.copy({index:t.index+1})):new we(e.copy({index:e.index-1}),t),Me=(e,t)=>e.index<=t.index?new we(e,t.copy({index:t.index+1})):new we(e,t);class Ee{static getRangeIndexRelationship(e,t,s){return s<e?Se.Before:s>t?Se.After:s===e?Se.Start:s===t?Se.End:Se.Within}static getRangeRangeRelationship(e,t,s,i){return e===s?t===i?Ce.EqualTo:i>t?Ce.Starts:Ce.StartedBy:e>s?e>i?Ce.PrecededBy:i===t?Ce.Finishes:t<i?Ce.ContainedBy:e===i?Ce.MetBy:Ce.OverlappedBy:t<s?Ce.Precedes:i===t?Ce.FinishedBy:t>i?Ce.Contains:t===s?Ce.Meets:Ce.Overlaps}}var Se,Ce,Ie;!function(e){e[e.Before=0]="Before",e[e.Start=1]="Start",e[e.Within=2]="Within",e[e.End=3]="End",e[e.After=4]="After"}(Se||(Se={})),function(e){e[e.Precedes=0]="Precedes",e[e.PrecededBy=1]="PrecededBy",e[e.Meets=2]="Meets",e[e.MetBy=3]="MetBy",e[e.Overlaps=4]="Overlaps",e[e.OverlappedBy=5]="OverlappedBy",e[e.Starts=6]="Starts",e[e.StartedBy=7]="StartedBy",e[e.Contains=8]="Contains",e[e.ContainedBy=9]="ContainedBy",e[e.Finishes=10]="Finishes",e[e.FinishedBy=11]="FinishedBy",e[e.EqualTo=12]="EqualTo"}(Ce||(Ce={}));class _e{static isForwardMove(e){return e.fromIndex<e.toIndex}static isBackwardMoveMove(e){return e.fromIndex>e.toIndex}static isIdentityMove(e){return e.fromIndex===e.toIndex}static getMoveDirection(e){return this.isForwardMove(e)?Ie.Forward:this.isBackwardMoveMove(e)?Ie.Backward:Ie.Identity}static indexBeforeRange(e,t){return t<this.getRangeMin(e)}static indexAfterRange(e,t){return t>this.getRangeMax(e)}static indexWithinRange(e,t){return t>this.getRangeMin(e)&&t<this.getRangeMax(e)}static getRangeIndexRelationship(e,t){return Ee.getRangeIndexRelationship(this.getRangeMin(e),this.getRangeMax(e),t)}static getRangeRelationship(e,t){return Ee.getRangeRangeRelationship(this.getRangeMin(e),this.getRangeMax(e),this.getRangeMin(t),this.getRangeMax(t))}static getRangeMin(e){return Math.min(e.fromIndex,e.toIndex)}static getRangeMax(e){return Math.max(e.fromIndex,e.toIndex)}}!function(e){e[e.Forward=0]="Forward",e[e.Backward=1]="Backward",e[e.Identity=2]="Identity"}(Ie||(Ie={}));const xe=(e,t)=>{switch(_e.getMoveDirection(t)){case Ie.Forward:return function(e,t){switch(_e.getRangeIndexRelationship(t,e.index)){case Se.Before:case Se.Start:return new we(e,t.copy({fromIndex:t.fromIndex+1,toIndex:t.toIndex+1}));case Se.Within:case Se.End:return new we(e.copy({index:e.index-1}),t.copy({toIndex:t.toIndex+1}));case Se.After:return new we(e,t);default:throw new Error("Invalid range-index relationship")}}(e,t);case Ie.Backward:return function(e,t){switch(_e.getRangeIndexRelationship(t,e.index)){case Se.Before:case Se.Start:return new we(e,t.copy({fromIndex:t.fromIndex+1,toIndex:t.toIndex+1}));case Se.Within:case Se.End:return new we(e.copy({index:e.index+1}),t.copy({fromIndex:t.fromIndex+1}));case Se.After:return new we(e,t);default:throw new Error("Invalid range-index relationship")}}(e,t);case Ie.Identity:return function(e,t){switch(_e.getRangeIndexRelationship(t,e.index)){case Se.After:return new we(e,t);default:return new we(e,t.copy({fromIndex:t.fromIndex+1,toIndex:t.toIndex+1}))}}(e,t);default:throw new Error("Invalid move direction")}};const De=(e,t)=>new we(e.copy({noOp:!0}),t),Te=(e,t)=>e.index<t.index?new we(e,t.copy({index:t.index-1})):new we(e.copy({index:e.index+1}),t),je=(e,t)=>e.index===t.index?new we(e.copy({noOp:!0}),t.copy({noOp:!0})):e.index<t.index?new we(e,t.copy({index:t.index-1})):new we(e.copy({index:e.index-1}),t);class Ae extends me{constructor(e,t,s){super(e),this.id=t,this.noOp=s}}class Pe extends Ae{constructor(e,t,s,i){super(ve.ARRAY_INSERT,e,t),this.index=s,this.value=i,Object.freeze(this)}copy(e){return new Pe(n.update(this.id,e.id),n.update(this.noOp,e.noOp),n.update(this.index,e.index),n.update(this.value,e.value))}}const Ne=(e,t)=>e.index<t.index?new we(e,t.copy({index:t.index-1})):e.index===t.index?new we(e.copy({noOp:!0}),new Pe(t.id,t.noOp,t.index,t.value)):new we(e,t),qe=(e,t)=>{switch(_e.getMoveDirection(t)){case Ie.Forward:return function(e,t){switch(_e.getRangeIndexRelationship(t,e.index)){case Se.Before:return new we(e,t.copy({fromIndex:t.fromIndex-1,toIndex:t.toIndex-1}));case Se.Start:return new we(e.copy({index:t.toIndex}),t.copy({noOp:!0}));case Se.Within:case Se.End:return new we(e.copy({index:e.index-1}),t.copy({toIndex:t.toIndex-1}));case Se.After:return new we(e,t);default:throw new Error("Invalid range-index relationship")}}(e,t);case Ie.Backward:return function(e,t){switch(_e.getRangeIndexRelationship(t,e.index)){case Se.Before:return new we(e,t.copy({fromIndex:t.fromIndex-1,toIndex:t.toIndex-1}));case Se.Start:case Se.Within:return new we(e.copy({index:e.index+1}),t.copy({fromIndex:t.fromIndex-1}));case Se.End:return new we(e.copy({index:t.toIndex}),t.copy({noOp:!0}));case Se.After:return new we(e,t);default:throw new Error("Invalid range-index relationship")}}(e,t);case Ie.Identity:return function(e,t){switch(_e.getRangeIndexRelationship(t,e.index)){case Se.Before:return new we(e,t.copy({fromIndex:t.fromIndex-1,toIndex:t.toIndex-1}));case Se.Start:case Se.Within:case Se.End:return new we(e,t.copy({noOp:!0}));default:return new we(e,t)}}(e,t);default:throw new Error("Invalid move direction")}};const Ue=(e,t)=>new we(e.copy({noOp:!0}),t),ke=(e,t)=>e.index<t.index?new we(e,t):new we(e.copy({index:e.index+1}),t),Ve=(e,t)=>e.index<t.index?new we(e,t):e.index===t.index?new we(new Pe(e.id,e.noOp,e.index,e.value),t.copy({noOp:!0})):new we(e.copy({index:e.index-1}),t);class Le{static deepEquals(e,t){let s;if(isNaN(e)&&isNaN(t)&&"number"==typeof e&&"number"==typeof t)return!0;if(e===t)return!0;if("function"==typeof e&&"function"==typeof t||e instanceof Date&&t instanceof Date||e instanceof RegExp&&t instanceof RegExp||e instanceof String&&t instanceof String||e instanceof Number&&t instanceof Number)return e.toString()===t.toString();if(!(e instanceof Object&&t instanceof Object))return!1;if(e.isPrototypeOf(t)||t.isPrototypeOf(e))return!1;if(e.constructor!==t.constructor)return!1;if(e.prototype!==t.prototype)return!1;for(s in t){if(t.hasOwnProperty(s)!==e.hasOwnProperty(s))return!1;if(typeof t[s]!=typeof e[s])return!1}for(s in e){if(t.hasOwnProperty(s)!==e.hasOwnProperty(s))return!1;if(typeof t[s]!=typeof e[s])return!1;switch(typeof e[s]){case"object":case"function":if(!this.deepEquals(e[s],t[s]))return!1;break;default:if(e[s]!==t[s])return!1}}return!0}}const Fe=(e,t)=>e.index!==t.index?new we(e,t):Le.deepEquals(e.value,t.value)?new we(e.copy({noOp:!0}),t.copy({noOp:!0})):new we(e,t.copy({noOp:!0})),$e=(e,t)=>{switch(_e.getMoveDirection(t)){case Ie.Forward:return function(e,t){switch(_e.getRangeIndexRelationship(t,e.index)){case Se.Before:case Se.After:return new we(e,t);case Se.Start:return new we(e.copy({index:t.toIndex}),t);case Se.Within:case Se.End:return new we(e.copy({index:e.index-1}),t);default:throw new Error("Invalid range-index relationship")}}(e,t);case Ie.Backward:return function(e,t){switch(_e.getRangeIndexRelationship(t,e.index)){case Se.Before:case Se.After:return new we(e,t);case Se.End:return new we(e.copy({index:t.toIndex}),t);case Se.Within:case Se.Start:return new we(e.copy({index:e.index+1}),t);default:throw new Error("Invalid range-index relationship")}}(e,t);case Ie.Identity:return function(e,t){return new we(e,t)}(e,t);default:throw new Error("Invalid move direction")}};const Ge=(e,t)=>new we(e.copy({noOp:!0}),t),Je=(e,t)=>{switch(_e.getMoveDirection(e)){case Ie.Forward:return function(e,t){switch(_e.getRangeIndexRelationship(e,t.index)){case Se.Before:case Se.Start:return new we(e.copy({fromIndex:e.fromIndex+1,toIndex:e.toIndex+1}),t);case Se.Within:case Se.End:return new we(e.copy({toIndex:e.toIndex+1}),t.copy({index:t.index-1}));case Se.After:return new we(e,t);default:throw new Error("Invalid range-index relationship")}}(e,t);case Ie.Backward:return function(e,t){switch(_e.getRangeIndexRelationship(e,t.index)){case Se.Before:case Se.Start:return new we(e.copy({fromIndex:e.fromIndex+1,toIndex:e.toIndex+1}),t);case Se.Within:case Se.End:return new we(e.copy({fromIndex:e.fromIndex+1}),t.copy({index:t.index+1}));case Se.After:return new we(e,t);default:throw new Error("Invalid range-index relationship")}}(e,t);case Ie.Identity:return function(e,t){switch(_e.getRangeIndexRelationship(e,t.index)){case Se.After:return new we(e,t);default:return new we(e.copy({fromIndex:e.fromIndex+1,toIndex:e.toIndex+1}),t)}}(e,t);default:throw new Error("Invalid move direction")}};const Be=(e,t)=>{switch(_e.getMoveDirection(e)){case Ie.Forward:return function(e,t){switch(_e.getRangeIndexRelationship(e,t.index)){case Se.Before:return new we(e.copy({fromIndex:e.fromIndex-1,toIndex:e.toIndex-1}),t);case Se.Start:return new we(e.copy({noOp:!0}),t.copy({index:e.toIndex}));case Se.Within:case Se.End:return new we(e.copy({toIndex:e.toIndex-1}),t.copy({index:t.index-1}));case Se.After:return new we(e,t);default:throw new Error("Invalid range-index relationship")}}(e,t);case Ie.Backward:return function(e,t){switch(_e.getRangeIndexRelationship(e,t.index)){case Se.Before:return new we(e.copy({fromIndex:e.fromIndex-1,toIndex:e.toIndex-1}),t);case Se.Start:case Se.Within:return new we(e.copy({fromIndex:e.fromIndex-1}),t.copy({index:t.index+1}));case Se.End:return new we(e.copy({noOp:!0}),t.copy({index:e.toIndex}));case Se.After:return new we(e,t);default:throw new Error("Invalid range-index relationship")}}(e,t);case Ie.Identity:return function(e,t){switch(_e.getRangeIndexRelationship(e,t.index)){case Se.Before:return new we(e.copy({fromIndex:e.fromIndex-1,toIndex:e.toIndex-1}),t);case Se.Start:case Se.Within:case Se.End:return new we(e.copy({noOp:!0}),t);case Se.After:return new we(e,t);default:throw new Error("Invalid range-index relationship")}}(e,t);default:throw new Error("Invalid move direction")}};const He=(e,t)=>{switch(_e.getMoveDirection(e)){case Ie.Forward:return function(e,t){switch(_e.getRangeIndexRelationship(e,t.index)){case Se.Before:case Se.After:return new we(e,t);case Se.Start:return new we(e,t.copy({index:e.toIndex}));case Se.Within:case Se.End:return new we(e,t.copy({index:t.index-1}));default:throw new Error("Invalid range-index relationship")}}(e,t);case Ie.Backward:return function(e,t){switch(_e.getRangeIndexRelationship(e,t.index)){case Se.Before:case Se.After:return new we(e,t);case Se.End:return new we(e,t.copy({index:e.toIndex}));case Se.Start:case Se.Within:return new we(e,t.copy({index:t.index+1}));default:throw new Error("Invalid range-index relationship")}}(e,t);case Ie.Identity:return function(e,t){return new we(e,t)}(e,t);default:throw new Error("Invalid move direction")}};const We=(e,t)=>{const s=_e.getMoveDirection(e),i=_e.getMoveDirection(t);return s===Ie.Forward?i===Ie.Forward?function(e,t){switch(_e.getRangeRelationship(e,t)){case Ce.Precedes:case Ce.PrecededBy:return new we(e,t);case Ce.Meets:return new we(e.copy({toIndex:e.toIndex-1}),t.copy({fromIndex:t.fromIndex-1}));case Ce.MetBy:return new we(e.copy({fromIndex:e.fromIndex-1}),t.copy({toIndex:t.toIndex-1}));case Ce.Overlaps:return new we(e.copy({toIndex:e.toIndex-1}),t.copy({fromIndex:t.fromIndex-1}));case Ce.OverlappedBy:return new we(e.copy({fromIndex:e.fromIndex-1}),t.copy({toIndex:t.toIndex-1}));case Ce.Starts:case Ce.StartedBy:return new we(e.copy({fromIndex:t.toIndex}),t.copy({noOp:!0}));case Ce.Contains:return new we(e,t.copy({fromIndex:t.fromIndex-1,toIndex:t.toIndex-1}));case Ce.ContainedBy:return new we(e.copy({fromIndex:e.fromIndex-1,toIndex:e.toIndex-1}),t);case Ce.Finishes:return new we(e.copy({fromIndex:e.fromIndex-1}),t.copy({toIndex:t.toIndex-1}));case Ce.FinishedBy:return new we(e,t.copy({fromIndex:t.fromIndex-1,toIndex:t.toIndex-1}));case Ce.EqualTo:return new we(e.copy({noOp:!0}),t.copy({noOp:!0}));default:throw new Error("Invalid range-range relationship")}}(e,t):i===Ie.Backward?function(e,t){switch(_e.getRangeRelationship(e,t)){case Ce.Precedes:case Ce.PrecededBy:return new we(e,t);case Ce.Meets:return new we(e.copy({toIndex:e.toIndex+1}),t.copy({toIndex:t.toIndex-1}));case Ce.MetBy:return new we(e.copy({fromIndex:t.toIndex}),t.copy({noOp:!0}));case Ce.Overlaps:return new we(e.copy({toIndex:e.toIndex+1}),t.copy({toIndex:t.toIndex-1}));case Ce.OverlappedBy:return new we(e.copy({fromIndex:e.fromIndex+1}),t.copy({fromIndex:t.fromIndex-1}));case Ce.Starts:return new we(e.copy({fromIndex:e.fromIndex+1,toIndex:e.toIndex+1}),t);case Ce.StartedBy:return new we(e.copy({fromIndex:e.fromIndex+1}),t.copy({fromIndex:t.fromIndex-1}));case Ce.Contains:return new we(e,t.copy({fromIndex:t.fromIndex-1,toIndex:t.toIndex-1}));case Ce.ContainedBy:return new we(e.copy({fromIndex:e.fromIndex+1,toIndex:e.toIndex+1}),t);case Ce.Finishes:return new we(e.copy({fromIndex:e.fromIndex+1}),t.copy({fromIndex:t.fromIndex-1}));case Ce.FinishedBy:return new we(e,t.copy({fromIndex:t.fromIndex-1,toIndex:t.toIndex-1}));case Ce.EqualTo:return new we(e.copy({fromIndex:e.fromIndex+1}),t.copy({fromIndex:t.fromIndex-1}));default:throw new Error("Invalid range-range relationship")}}(e,t):function(e,t){switch(_e.getRangeIndexRelationship(e,t.fromIndex)){case Se.Before:case Se.After:return new we(e,t);case Se.Start:return new we(e,t.copy({fromIndex:e.toIndex,toIndex:e.toIndex}));case Se.Within:case Se.End:return new we(e,t.copy({fromIndex:t.fromIndex-1,toIndex:t.toIndex-1}));default:throw new Error("Invalid range-index relationship")}}(e,t):s===Ie.Backward?i===Ie.Forward?function(e,t){switch(_e.getRangeRelationship(e,t)){case Ce.Precedes:case Ce.PrecededBy:return new we(e,t);case Ce.Meets:return new we(e.copy({fromIndex:t.toIndex}),t.copy({noOp:!0}));case Ce.MetBy:return new we(e.copy({toIndex:e.toIndex-1}),t.copy({toIndex:t.toIndex+1}));case Ce.Overlaps:return new we(e.copy({fromIndex:e.fromIndex-1}),t.copy({fromIndex:t.fromIndex+1}));case Ce.OverlappedBy:return new we(e.copy({toIndex:e.toIndex-1}),t.copy({toIndex:t.toIndex+1}));case Ce.Starts:return new we(e.copy({fromIndex:e.fromIndex-1}),t.copy({fromIndex:t.fromIndex+1}));case Ce.StartedBy:case Ce.Contains:return new we(e,t.copy({fromIndex:t.fromIndex+1,toIndex:t.toIndex+1}));case Ce.ContainedBy:case Ce.Finishes:return new we(e.copy({fromIndex:e.fromIndex-1,toIndex:e.toIndex-1}),t);case Ce.FinishedBy:case Ce.EqualTo:return new we(e.copy({fromIndex:e.fromIndex-1}),t.copy({fromIndex:t.fromIndex+1}));default:throw new Error("Invalid range-range relationship")}}(e,t):i===Ie.Backward?function(e,t){switch(_e.getRangeRelationship(e,t)){case Ce.Precedes:case Ce.PrecededBy:return new we(e,t);case Ce.Meets:return new we(e.copy({fromIndex:e.fromIndex+1}),t.copy({toIndex:t.toIndex+1}));case Ce.MetBy:return new we(e.copy({toIndex:e.toIndex+1}),t.copy({fromIndex:t.fromIndex+1}));case Ce.Overlaps:return new we(e.copy({fromIndex:e.fromIndex+1}),t.copy({toIndex:t.toIndex+1}));case Ce.OverlappedBy:return new we(e.copy({toIndex:e.toIndex+1}),t.copy({fromIndex:t.fromIndex+1}));case Ce.Starts:return new we(e.copy({fromIndex:e.fromIndex+1,toIndex:e.toIndex+1}),t);case Ce.StartedBy:case Ce.Contains:return new we(e,t.copy({fromIndex:t.fromIndex+1,toIndex:t.toIndex+1}));case Ce.ContainedBy:return new we(e.copy({fromIndex:e.fromIndex+1,toIndex:e.toIndex+1}),t);case Ce.Finishes:case Ce.FinishedBy:return new we(e.copy({fromIndex:t.toIndex}),t.copy({noOp:!0}));case Ce.EqualTo:return new we(e.copy({noOp:!0}),t.copy({noOp:!0}));default:throw new Error("Invalid range-range relationship")}}(e,t):function(e,t){switch(_e.getRangeIndexRelationship(e,t.fromIndex)){case Se.Before:case Se.After:return new we(e,t);case Se.Start:case Se.Within:return new we(e,t.copy({fromIndex:t.fromIndex+1,toIndex:t.toIndex+1}));case Se.End:return new we(e,t.copy({fromIndex:e.toIndex,toIndex:e.toIndex}));default:throw new Error("Invalid range-index relationship")}}(e,t):i===Ie.Forward?function(e,t){switch(_e.getRangeIndexRelationship(t,e.fromIndex)){case Se.Before:case Se.After:return new we(e,t);case Se.Start:return new we(e.copy({fromIndex:t.toIndex,toIndex:t.toIndex}),t);case Se.Within:case Se.End:return new we(e.copy({fromIndex:e.fromIndex-1,toIndex:e.toIndex-1}),t);default:throw new Error("Invalid range-index relationship")}}(e,t):i===Ie.Backward?function(e,t){switch(_e.getRangeIndexRelationship(t,e.fromIndex)){case Se.Before:case Se.After:return new we(e,t);case Se.Start:case Se.Within:return new we(e.copy({fromIndex:e.fromIndex+1,toIndex:e.toIndex+1}),t);case Se.End:return new we(e.copy({fromIndex:t.toIndex,toIndex:t.toIndex}),t);default:throw new Error("Invalid range-index relationship")}}(e,t):function(e,t){return new we(e,t)}(e,t)};const ze=(e,t)=>new we(e.copy({noOp:!0}),t),Ye=(e,t)=>new we(e,t.copy({noOp:!0})),Qe=(e,t)=>new we(e,t.copy({noOp:!0})),Ke=(e,t)=>new we(e,t.copy({noOp:!0})),Xe=(e,t)=>new we(e,t.copy({noOp:!0})),Ze=(e,t)=>Le.deepEquals(e.value,t.value)?new we(e.copy({noOp:!0}),t.copy({noOp:!0})):new we(e,t.copy({noOp:!0})),et=(e,t)=>new we(e.copy({noOp:!0}),t),tt=(e,t)=>new we(e,t.copy({noOp:!0})),st=(e,t)=>e.value===t.value?new we(e.copy({noOp:!0}),e.copy({noOp:!0})):new we(e,t.copy({noOp:!0})),it=(e,t)=>new we(e,t),nt=(e,t)=>new we(e.copy({noOp:!0}),t),rt=(e,t)=>new we(e,t.copy({noOp:!0})),ot=(e,t)=>e.value===t.value?new we(e.copy({noOp:!0}),e.copy({noOp:!0})):new we(e,t.copy({noOp:!0})),at=(e,t)=>e.value===t.value?new we(e.copy({noOp:!0}),e.copy({noOp:!0})):new we(e,t.copy({noOp:!0}));class ct extends Ae{constructor(e,t,s,i){super(ve.OBJECT_SET,e,t),this.prop=s,this.value=i,Object.freeze(this)}copy(e){return new ct(n.update(this.id,e.id),n.update(this.noOp,e.noOp),n.update(this.prop,e.prop),n.update(this.value,e.value))}}const ht=(e,t)=>e.prop!==t.prop?new we(e,t):e.value!==t.value?new we(new ct(e.id,e.noOp,e.prop,e.value),t.copy({noOp:!0})):new we(e.copy({noOp:!0}),t.copy({noOp:!0})),ut=(e,t)=>{if(e.prop!==t.prop)return new we(e,t);throw new Error("Add property and set property can not target the same property")},dt=(e,t)=>{if(e.prop!==t.prop)return new we(e,t);throw new Error("Add property and Remove property can not target the same property")},lt=(e,t)=>{if(e.prop!==t.prop)return new we(e,t);throw new Error("Remove property and add property can not target the same property")};class pt extends Ae{constructor(e,t,s,i){super(ve.OBJECT_ADD,e,t),this.prop=s,this.value=i,Object.freeze(this)}copy(e){return new pt(n.update(this.id,e.id),n.update(this.noOp,e.noOp),n.update(this.prop,e.prop),n.update(this.value,e.value))}}const ft=(e,t)=>e.prop!==t.prop?new we(e,t):new we(e.copy({noOp:!0}),new pt(t.id,t.noOp,t.prop,t.value)),mt=(e,t)=>e.prop!==t.prop?new we(e,t):new we(e.copy({noOp:!0}),t.copy({noOp:!0})),gt=(e,t)=>new we(e.copy({noOp:!0}),t),vt=(e,t)=>new we(e.copy({noOp:!0}),t),yt=(e,t)=>{if(e.prop!==t.prop)return new we(e,t);throw new Error("Set property and add property can not target the same property")},wt=(e,t)=>e.prop!==t.prop?new we(e,t):e.value!==t.value?new we(e,t.copy({noOp:!0})):new we(e.copy({noOp:!0}),t.copy({noOp:!0})),bt=(e,t)=>e.prop!==t.prop?new we(e,t):new we(new pt(e.id,e.noOp,e.prop,e.value),t.copy({noOp:!0})),Ot=(e,t)=>new we(e.copy({noOp:!0}),t),Rt=(e,t)=>new we(e,t.copy({noOp:!0})),Mt=(e,t)=>new we(e,t.copy({noOp:!0})),Et=(e,t)=>new we(e,t.copy({noOp:!0})),St=(e,t)=>Le.deepEquals(e.value,t.value)?new we(e.copy({noOp:!0}),t.copy({noOp:!0})):new we(e,t.copy({noOp:!0}));class Ct{constructor(e,t,s,i,n,r){this.element=e,this.user=t,this.sessionId=s,this.local=i,this.index=n,this.value=r,this.name=Ct.NAME,Object.freeze(this)}}Ct.NAME="insert";class It{constructor(e,t,s,i,n,r){this.element=e,this.user=t,this.sessionId=s,this.local=i,this.index=n,this.oldValue=r,this.name=It.NAME,Object.freeze(this)}}It.NAME="remove";class _t{constructor(e,t,s,i,n,r){this.element=e,this.user=t,this.sessionId=s,this.local=i,this.fromIndex=n,this.toIndex=r,this.name=_t.NAME,Object.freeze(this)}}_t.NAME="reorder";class xt{constructor(e,t,s,i,n,r,o){this.element=e,this.user=t,this.sessionId=s,this.local=i,this.index=n,this.value=r,this.oldValue=o,this.name=xt.NAME,Object.freeze(this)}}xt.NAME="set";class Dt{constructor(e,t,s,i){this.element=e,this.user=t,this.sessionId=s,this.local=i,this.name=Dt.NAME,Object.freeze(this)}}Dt.NAME="value";class Tt{constructor(e,t,s,i,n,r){this.element=e,this.user=t,this.sessionId=s,this.local=i,this.key=n,this.oldValue=r,this.name=Tt.NAME,Object.freeze(this)}}Tt.NAME="remove";class jt{constructor(e,t,s,i,n,r,o){this.element=e,this.user=t,this.sessionId=s,this.local=i,this.key=n,this.value=r,this.oldValue=o,this.name=jt.NAME,Object.freeze(this)}}jt.NAME="set";class At{constructor(e,t,s,i){this.element=e,this.user=t,this.sessionId=s,this.local=i,this.name=At.NAME,Object.freeze(this)}}At.NAME="value";class Pt{constructor(e,t,s,i){this.element=e,this.user=t,this.sessionId=s,this.local=i,this.name=Pt.NAME,Object.freeze(this)}}Pt.NAME="value";class Nt{constructor(e,t,s,i){this.element=e,this.user=t,this.sessionId=s,this.local=i,this.name=Nt.NAME,Object.freeze(this)}}Nt.NAME="value";class qt{constructor(e,t,s,i){this.element=e,this.user=t,this.sessionId=s,this.local=i,this.name=qt.NAME,Object.freeze(this)}}qt.NAME="value";class Ut{constructor(e,t,s,i,n){this.element=e,this.user=t,this.sessionId=s,this.local=i,this.value=n,this.name=Ut.NAME,Object.freeze(this)}}Ut.NAME="delta";class kt{constructor(e,t,s,i,n,r){this.element=e,this.user=t,this.sessionId=s,this.local=i,this.index=n,this.value=r,this.name=kt.NAME,Object.freeze(this)}}kt.NAME="insert";class Vt{constructor(e,t,s,i,n,r){this.element=e,this.user=t,this.sessionId=s,this.local=i,this.index=n,this.value=r,this.name=Vt.NAME,Object.freeze(this)}}Vt.NAME="remove";class Lt{constructor(e,t,s,i,n,r,o){this.element=e,this.user=t,this.sessionId=s,this.local=i,this.index=n,this.deleteCount=r,this.insertValue=o,this.name=Lt.NAME,Object.freeze(this)}}Lt.NAME="splice";class Ft{constructor(e,t,s,i){this.element=e,this.user=t,this.sessionId=s,this.local=i,this.name=Ft.NAME,Object.freeze(this)}}Ft.NAME="value";class $t{constructor(e){this.src=e,this.name=$t.NAME}}$t.NAME="detached";class Gt{constructor(e,t,s,i,n,r){this.element=e,this.user=t,this.sessionId=s,this.local=i,this.relativePath=n,this.childEvent=r,this.name=Gt.NAME,Object.freeze(this)}}Gt.NAME="model_changed";class Jt{constructor(e,t,s){this.src=e,this.local=t,this.reason=s,this.name=Jt.NAME,Object.freeze(this)}}Jt.NAME="closed";class Bt{constructor(e,t,s){this.src=e,this.local=t,this.reason=s,this.name=Bt.NAME,Object.freeze(this)}}Bt.NAME="deleted";class Ht{constructor(e,t,s){this.model=e,this.permissions=t,this.changes=s,this.name=Ht.NAME,Object.freeze(this)}}Ht.NAME="permissions_changed";class Wt{constructor(e,t){this.src=e,this.version=t,this.name=Wt.NAME,Object.freeze(this)}}Wt.NAME="version_changed";class zt{constructor(e){this.src=e,this.name=zt.NAME,Object.freeze(this)}}zt.NAME="online";class Yt{constructor(e){this.src=e,this.name=Yt.NAME,Object.freeze(this)}}Yt.NAME="offline";class Qt{constructor(e){this.src=e,this.name=Qt.NAME,Object.freeze(this)}}Qt.NAME="reconnecting";class Kt{constructor(e){this.src=e,this.name=Kt.NAME,Object.freeze(this)}}Kt.NAME="resync_started";class Xt{constructor(e){this.src=e,this.name=Xt.NAME,Object.freeze(this)}}Xt.NAME="resync_completed";class Zt{constructor(e,t){this.src=e,this.message=t,this.name=Zt.NAME,Object.freeze(this)}}Zt.NAME="resync_error";class es{constructor(e,t,s){this.reference=e,this.model=t,this.element=s,this.name=es.NAME,Object.freeze(this)}}es.NAME="reference";class ts{constructor(e,t,s){this.model=e,this.sessionId=t,this.user=s,this.name=ts.NAME,Object.freeze(this)}}ts.NAME="remote_resync_started";class ss{constructor(e,t,s){this.model=e,this.sessionId=t,this.user=s,this.name=ss.NAME,Object.freeze(this)}}ss.NAME="remote_resync_completed";class is{constructor(e,t){this.src=e,this.collaborator=t,this.name=is.NAME,Object.freeze(this)}}is.NAME="collaborator_opened";class ns{constructor(e,t){this.src=e,this.collaborator=t,this.name=ns.NAME,Object.freeze(this)}}ns.NAME="collaborator_closed";class rs{constructor(e){this.src=e,this.name=rs.NAME,Object.freeze(this)}}rs.NAME="committed";class os{constructor(e){this.src=e,this.name=os.NAME,Object.freeze(this)}}os.NAME="modified";class as{constructor(e){this.modelsToDownload=e,this.name=as.NAME,Object.freeze(this)}}as.NAME="offline_models_download_started";class cs{constructor(e,t){this.modelsToDownload=e,this.trigger=t,this.name=cs.NAME,Object.freeze(this)}}cs.NAME="offline_models_download_status_changed";class hs{constructor(){this.name=hs.NAME,Object.freeze(this)}}hs.NAME="offline_models_download_stopped";class us{constructor(e){this.modelsToSync=e,this.name=us.NAME,Object.freeze(this)}}us.NAME="offline_models_sync_started";class ds{constructor(e){this.modelsToSync=e,this.name=ds.NAME,Object.freeze(this)}}ds.NAME="offline_models_sync_progress";class ls{constructor(){this.name=ls.NAME,Object.freeze(this)}}ls.NAME="offline_models_sync_completed";class ps{constructor(e,t){this.reason=e,this.code=t,this.name=ps.NAME,Object.freeze(this)}}ps.NAME="offline_models_sync_aborted";class fs{constructor(e){this.modelId=e,this.name=fs.NAME,Object.freeze(this)}}fs.NAME="offline_model_sync_started";class ms{constructor(e){this.modelId=e,this.name=ms.NAME,Object.freeze(this)}}ms.NAME="offline_model_sync_completed";class gs{constructor(e,t,s){this.modelId=e,this.message=t,this.model=s,this.name=gs.NAME,Object.freeze(this)}}gs.NAME="offline_model_sync_error";class vs{constructor(e,t,s){this.id=e,this.version=t,this.permissions=s,this.name=vs.NAME,Object.freeze(this)}}vs.NAME="offline_model_downloaded";class ys{constructor(e,t,s){this.id=e,this.version=t,this.permissions=s,this.name=ys.NAME,Object.freeze(this)}}ys.NAME="offline_model_updated";class ws{constructor(e,t,s,i,n){this.id=e,this.subscribed=t,this.available=s,this.synchronized=i,this.local=n,this.name=ws.NAME,Object.freeze(this)}}ws.NAME="offline_model_status_changed";class bs{constructor(e){this.id=e,this.name=bs.NAME,Object.freeze(this)}}bs.NAME="offline_model_deleted";class Os{constructor(e){this.id=e,this.name=Os.NAME,Object.freeze(this)}}Os.NAME="offline_model_permissions_revoked";class Rs{constructor(e,t){this.src=e,this.local=t,this.name=Rs.NAME}}Rs.NAME="detached";class Ms{constructor(e,t,s,i,n,r){this.src=e,this.local=t,this.relativePath=s,this.childEvent=i,this.sessionId=n,this.user=r,this.name=Ms.NAME,Object.freeze(this)}}Ms.NAME="node_changed";class Es{constructor(e,t,s,i,n,r){this.src=e,this.local=t,this.index=s,this.value=i,this.sessionId=n,this.user=r,this.name=Es.NAME,Object.freeze(this)}}Es.NAME="insert";class Ss{constructor(e,t,s,i,n,r){this.src=e,this.local=t,this.index=s,this.oldValue=i,this.sessionId=n,this.user=r,this.name=Ss.NAME,Object.freeze(this)}}Ss.NAME="remove";class Cs{constructor(e,t,s,i,n,r,o){this.src=e,this.local=t,this.index=s,this.value=i,this.oldValue=n,this.sessionId=r,this.user=o,this.name=Cs.NAME,Object.freeze(this)}}Cs.NAME="set";class Is{constructor(e,t,s,i,n,r){this.src=e,this.local=t,this.fromIndex=s,this.toIndex=i,this.sessionId=n,this.user=r,this.name=Is.NAME,Object.freeze(this)}}Is.NAME="reorder";class _s{constructor(e,t,s,i,n){this.src=e,this.local=t,this.value=s,this.sessionId=i,this.user=n,this.name=_s.NAME,Object.freeze(this)}}_s.NAME="value";class xs{constructor(e,t,s,i,n){this.src=e,this.local=t,this.value=s,this.sessionId=i,this.user=n,this.name=xs.NAME,Object.freeze(this)}}xs.NAME="value";class Ds{constructor(e,t,s,i,n){this.src=e,this.local=t,this.value=s,this.sessionId=i,this.user=n,this.name=Ds.NAME,Object.freeze(this)}}Ds.NAME="value";class Ts{constructor(e,t,s,i,n){this.src=e,this.local=t,this.value=s,this.sessionId=i,this.user=n,this.name=Ts.NAME,Object.freeze(this)}}Ts.NAME="delta";class js{constructor(e,t,s,i,n,r,o){this.src=e,this.local=t,this.key=s,this.value=i,this.oldValue=n,this.sessionId=r,this.user=o,this.name=js.NAME,Object.freeze(this)}}js.NAME="set";class As{constructor(e,t,s,i,n,r){this.src=e,this.local=t,this.key=s,this.oldValue=i,this.sessionId=n,this.user=r,this.name=As.NAME,Object.freeze(this)}}As.NAME="remove";class Ps{constructor(e,t,s,i,n){this.src=e,this.local=t,this.value=s,this.sessionId=i,this.user=n,this.name=Ps.NAME,Object.freeze(this)}}Ps.NAME="value";class Ns{constructor(e,t,s,i,n,r,o){this.src=e,this.local=t,this.index=s,this.deleteCount=i,this.insertValue=n,this.sessionId=r,this.user=o,this.name=Ns.NAME,Object.freeze(this)}}Ns.NAME="splice";class qs{constructor(e,t,s,i,n,r){this.src=e,this.local=t,this.index=s,this.value=i,this.sessionId=n,this.user=r,this.name=qs.NAME,Object.freeze(this)}}qs.NAME="insert";class Us{constructor(e,t,s,i,n,r){this.src=e,this.local=t,this.index=s,this.value=i,this.sessionId=n,this.user=r,this.name=Us.NAME,Object.freeze(this)}}Us.NAME="remove";class ks{constructor(e,t,s,i,n){this.src=e,this.local=t,this.value=s,this.sessionId=i,this.user=n,this.name=ks.NAME,Object.freeze(this)}}ks.NAME="value";class Vs{constructor(e,t,s,i,n){this.src=e,this.local=t,this.value=s,this.sessionId=i,this.user=n,this.name=Vs.NAME,Object.freeze(this)}}Vs.NAME="value";class Ls{static convertEvent(e,t){if(e instanceof Rs)return new $t(t.wrap(e.src));if(e instanceof Ms)return new Gt(t.wrap(e.src),e.user,e.sessionId,e.local,e.relativePath,this.convertEvent(e.childEvent,t));if(e instanceof Es)return new Ct(t.wrap(e.src),e.user,e.sessionId,e.local,e.index,t.wrap(e.value));if(e instanceof Ss)return new It(t.wrap(e.src),e.user,e.sessionId,e.local,e.index,t.wrap(e.oldValue));if(e instanceof Is)return new _t(t.wrap(e.src),e.user,e.sessionId,e.local,e.fromIndex,e.toIndex);if(e instanceof Cs)return new xt(t.wrap(e.src),e.user,e.sessionId,e.local,e.index,t.wrap(e.value),t.wrap(e.oldValue));if(e instanceof _s)return new Dt(t.wrap(e.src),e.user,e.sessionId,e.local);if(e instanceof xs)return new Pt(t.wrap(e.src),e.user,e.sessionId,e.local);if(e instanceof Ds)return new qt(t.wrap(e.src),e.user,e.sessionId,e.local);if(e instanceof Ts)return new Ut(t.wrap(e.src),e.user,e.sessionId,e.local,e.value);if(e instanceof Ps)return new At(t.wrap(e.src),e.user,e.sessionId,e.local);if(e instanceof As)return new Tt(t.wrap(e.src),e.user,e.sessionId,e.local,e.key,t.wrap(e.oldValue));if(e instanceof js)return new jt(t.wrap(e.src),e.user,e.sessionId,e.local,e.key,t.wrap(e.value),t.wrap(e.oldValue));if(e instanceof Ns)return new Lt(t.wrap(e.src),e.user,e.sessionId,e.local,e.index,e.deleteCount,e.insertValue);if(e instanceof qs)return new kt(t.wrap(e.src),e.user,e.sessionId,e.local,e.index,e.value);if(e instanceof Us)return new Vt(t.wrap(e.src),e.user,e.sessionId,e.local,e.index,e.value);if(e instanceof ks)return new Ft(t.wrap(e.src),e.user,e.sessionId,e.local);if(e instanceof Vs)return new Nt(t.wrap(e.src),e.user,e.sessionId,e.local);throw new Error("Unable to convert event: "+e.name)}}class Fs{constructor(){this.ss=new Map}put(e){const t=e.sessionId(),s=e.key();let i=this.ss.get(t);if(o.isUndefined(i)&&(i=new Map,this.ss.set(t,i)),i.has(s))throw new Error(`Reference with key "${s}" already exists for session "${t}".`);i.set(s,e)}get(e,t){const s=this.ss.get(e);return o.isUndefined(s)?void 0:s.get(t)}getAll(e){o.isUndefined(e)&&(e={});const t=[];return(o.isSet(e.sessionId)?[e.sessionId]:Array.from(this.ss.keys())).forEach(s=>{const i=this.ss.get(s);(o.isSet(e.key)?[e.key]:Array.from(i.keys())).forEach(e=>{const s=i.get(e);o.isUndefined(s)||t.push(s)})}),t}removeAll(){this.ss.clear()}remove(e,t){const s=this.ss.get(e);if(void 0!==s){const e=s.get(t);return s.delete(t),e}}removeBySession(e){this.ss.delete(e)}removeByKey(e){this.ss.forEach(t=>{t.delete(e)})}}class $s{constructor(e,t,s,i,n){this.src=e,this.oldValues=t,this.addedValues=s,this.removedValues=i,this.synthetic=n,this.name=$s.NAME,t.length>0&&(this.oldValue=t[0]),Object.freeze(this)}}$s.NAME="set";class Gs{constructor(e,t){this.src=e,this.oldValues=t,this.name=Gs.NAME,t.length>0&&(this.oldValue=t[0]),Object.freeze(this)}}Gs.NAME="cleared";class Js{constructor(e){this.src=e,this.name=Js.NAME,Object.freeze(this)}}Js.NAME="disposed";class Bs extends R{constructor(e,t,s,i,n,r,o){super(),this.ns=e,this.rs=!1,this.os=[],this.as=t,this.cs=s,this.hs=i,this.ot=n,this.rt=r,this.us=o}type(){return this.as}key(){return this.cs}source(){return this.hs}isLocal(){return this.us}user(){return this.ot}sessionId(){return this.rt}isDisposed(){return this.rs}ds(){this.rs=!0;const e=new Js(this);this.ve(e),this.removeAllListeners(),this.ns.ls(this)}value(){return this.os[0]}values(){return this.os}isSet(){return this.os.length>0}ps(e,t){const s=this.os;this.os=e;const i=this.os.filter(e=>!s.includes(e)),n=s.filter(e=>!this.os.includes(e)),r=new $s(this,s,i,n,t);this.ve(r)}ms(){const e=this.os;this.os=[];const t=new Gs(this,e);this.ve(t)}gs(e,t){Le.deepEquals(this.os,e)||this.ps(e,t)}}Bs.Events={SET:$s.NAME,CLEARED:Gs.NAME,DISPOSED:Js.NAME},Bs.Types={INDEX:"index",RANGE:"range",PROPERTY:"property",ELEMENT:"element"},Object.freeze(Bs.Events),Object.freeze(Bs.Types);class Hs{static handleSplice(e,t,s,i){return e.map(e=>e>=e?e-Math.min(e-t,s)+i:e)}static handleInsert(e,t,s){return e.map(e=>e>=t?e+s:e)}static handleReorder(e,t,s){return e.map(e=>e>=s&&e<t?e+1:e>=t&&e<s?e-1:e)}static handleRemove(e,t,s){return e.map(e=>e>t?e-Math.min(e-t,s):e)}}class Ws extends Bs{constructor(e,t,s,i,n,r){super(e,Bs.Types.INDEX,t,s,i,n,r)}vs(e,t){this.gs(Hs.handleInsert(this.os,e,t),!0)}R(e,t){this.gs(Hs.handleRemove(this.os,e,t),!0)}ys(e,t,s){this.gs(Hs.handleSplice(this.os,e,t,s),!0)}ws(e,t){this.gs(Hs.handleReorder(this.os,e,t),!0)}}class zs{static handleSplice(e,t,s,i){return e.map(e=>{const n=zs.bs(e),r=Hs.handleSplice(n,t,s,i);return zs.Os(r)})}static handleInsert(e,t,s){return e.map(e=>{const i=zs.bs(e),n=Hs.handleInsert(i,t,s);return zs.Os(n)})}static handleReorder(e,t,s){return e.map(e=>{const i=zs.bs(e),n=Hs.handleReorder(i,t,s);return zs.Os(n)})}static handleRemove(e,t,s){return e.map(e=>{const i=zs.bs(e),n=Hs.handleRemove(i,t,s);return zs.Os(n)})}static bs(e){return[e.start,e.end]}static Os(e){return{start:e[0],end:e[1]}}}class Ys extends Bs{constructor(e,t,s,i,n,r){super(e,Bs.Types.RANGE,t,s,i,n,r)}vs(e,t){this.gs(zs.handleInsert(this.os,e,t),!0)}R(e,t){this.gs(zs.handleRemove(this.os,e,t),!0)}ys(e,t,s){this.gs(zs.handleSplice(this.os,e,t,s),!0)}ws(e,t){this.gs(zs.handleReorder(this.os,e,t),!0)}}class Qs extends Bs{constructor(e,t,s,i,n,r){super(e,Bs.Types.PROPERTY,t,s,i,n,r)}Rs(e){const t=this.os.indexOf(e,0);if(t>-1){const e=this.os.slice(0);e.splice(t,1),this.ps(e,!0)}}}class Ks{constructor(e,t,s,i){this.sessionId=e,this.resourceId=t,this.valueId=s,this.key=i}}class Xs extends Ks{constructor(e,t,s,i,n,r){super(e,t,s,i),this.referenceType=n,this.values=r}}class Zs extends Ks{constructor(e,t,s,i){super(e,t,s,i)}}class ei extends Ks{constructor(e,t,s,i,n){super(e,t,s,i),this.values=n}}class ti extends Ks{constructor(e,t,s,i){super(e,t,s,i)}}class si{constructor(e,t,s,i){this.Ms=new Fs,this.Es=new Map,this.Ss=t,this.hs=e,this.Cs=s,this.Is=i}get(e,t){return this.Ms.get(e,t)}getAll(e){return this.Ms.getAll(e)}removeAll(){this.removeAllLocalReferences(),this.getAll().forEach(e=>e.ds())}addLocalReference(e){const t=e.reference().key();if(this.Es.has(t))throw new Error("Local reference already set for key: "+t);this.Es.set(t,e),this.Ms.put(e.reference())}removeLocalReference(e){const t=this.Es.get(e);void 0!==t&&t.ds()}removeAllLocalReferences(){this.Es.forEach((e,t)=>{this.removeLocalReference(t)})}getLocalReference(e){return this.Es.get(e)}handleRemoteReferenceEvent(e){if(e instanceof Xs)this._s(e);else if(e instanceof ei)this.xs(e);else if(e instanceof ti)this.Ds(e);else{if(!(e instanceof Zs))throw new Error("Invalid reference event.");this.Ts(e)}}reShare(){this.Es.forEach(e=>{e.isShared()&&e.share()})}ls(e){this.Ms.remove(e.sessionId(),e.key()),e.isLocal()&&this.Es.delete(e.key())}_s(e){const t=this.Is.getUserForSession(e.sessionId);let s;const i=e.values;if(this.js(e.referenceType),"index"===e.referenceType)s=new Ws(this,e.key,this.hs,t,e.sessionId,!1);else if("range"===e.referenceType)s=new Ys(this,e.key,this.hs,t,e.sessionId,!1);else if("element"===e.referenceType)s=new ri(this,e.key,this.hs,t,e.sessionId,!1);else{if("property"!==e.referenceType)throw new O("Invalid reference type: "+e);s=new Qs(this,e.key,this.hs,t,e.sessionId,!1)}null!==i&&this.As(s,i),this.Ms.put(s),this.Cs(s)}js(e){if(!this.Ss.includes(e))throw new Error("Invalid reference type: "+e)}Ts(e){this.Ms.remove(e.sessionId,e.key).ds()}Ds(e){this.Ms.get(e.sessionId,e.key).ms()}xs(e){const t=this.Ms.get(e.sessionId,e.key);this.As(t,e.values)}As(e,t){if(e.type()===Bs.Types.ELEMENT){const s=[];for(const e of t){const t=this.hs.Ps(e);void 0!==t&&s.push(t)}e.ps(s,!1)}else e.ps(t,!1)}}const ii={VALUE:"value",DETACHED:"detached",REFERENCE:"reference",MODEL_CHANGED:"model_changed"};Object.freeze(ii);class ni extends R{constructor(e,t,s,i,n,r){super(),this.Ns=e,this.qs=t,this.Us=s,this.ks=i;this.ns=new si(this,n,e=>{this.Vs(e)},r),this.Ns.events().pipe(Object(b.filter)(e=>this.ks.emitLocalEvents()||!e.local||e instanceof Rs)).subscribe(e=>{e instanceof Rs&&this.ns.removeAll();const t=Ls.convertEvent(e,this.Us);this.ve(t)})}model(){return this.ks}id(){return this.Ns.id()}type(){return this.Ns.type()}path(){return this.Ns.path()}parent(){const e=this.Ns.path().slice(0);e.pop();return this.ks.elementAt(e)}relativePath(){const e=this.Ns.path().slice(0);return e.length>0?e.pop():null}removeFromParent(){this.Ls();const e=this.Ns.path().slice(0);if(0===e.length)throw new Error("Can not remove the root object from the model");const t=e.pop();this.ks.elementAt(e).Fs(t)}isDetached(){return this.Ns.isDetached()}isAttached(){return!this.Ns.isDetached()}value(e){return 0===arguments.length?this.Ns.data():(this.Ls(),void this.Ns.data(e))}toJSON(){return this.Ns.toJson()}reference(e,t){return this.ns.get(e,t)}references(e){return this.ns.getAll(e)}$s(e){this.ns.handleRemoteReferenceEvent(e)}Gs(e){this.qs.sendOperationCallback(e)}Ls(){if(!this.ks.permissions().write)throw new Error("The user does not have write permissions for the model.");this.Js()}Js(){if(this.isDetached())throw Error("Can not perform actions on a detached RealTimeElement.")}Vs(e){this.ve(new es(e,this.model(),this))}}ni.Events=ii,Object.freeze(ni.Events);class ri extends Bs{constructor(e,t,s,i,n,r){super(e,Bs.Types.ELEMENT,t,s,i,n,r),this.Bs=e=>{this.Hs(e.src)}}ps(e,t){for(const e of this.values())e.removeListener(ni.Events.DETACHED,this.Bs);for(const t of e)t.addListener(ni.Events.DETACHED,this.Bs);super.ps(e,t)}ms(){for(const e of this.values())e.removeListener(ni.Events.DETACHED,this.Bs);super.ms()}Hs(e){const t=this.os.indexOf(e,0);if(t>-1){const e=this.os.slice(0);e.splice(t,1),this.ps(e,!0)}}}class oi extends Ae{constructor(e,t,s,i){super(ve.ARRAY_SET,e,t),this.index=s,this.value=i,Object.freeze(this)}copy(e){return new oi(n.update(this.id,e.id),n.update(this.noOp,e.noOp),n.update(this.index,e.index),n.update(this.value,e.value))}}class ai extends Ae{constructor(e,t,s){super(ve.ARRAY_REMOVE,e,t),this.index=s,Object.freeze(this)}copy(e){return new ai(n.update(this.id,e.id),n.update(this.noOp,e.noOp),n.update(this.index,e.index))}}class ci extends Ae{constructor(e,t,s,i){super(ve.ARRAY_REORDER,e,t),this.fromIndex=s,this.toIndex=i,Object.freeze(this)}copy(e){return new ci(n.update(this.id,e.id),n.update(this.noOp,e.noOp),n.update(this.fromIndex,e.fromIndex),n.update(this.toIndex,e.toIndex))}}class hi extends Ae{constructor(e,t,s){super(ve.ARRAY_VALUE,e,t),this.value=s,Object.freeze(this)}copy(e){return new hi(n.update(this.id,e.id),n.update(this.noOp,e.noOp),n.update(this.value,e.value))}}const ui=Object.assign(Object.assign({},ii),{INSERT:"insert",REMOVE:"remove",SET:"set",REORDER:"reorder"});Object.freeze(ui);class di extends ni{constructor(e,t,s,i,n){super(e,t,s,i,[],n),this.Ns.events().subscribe(e=>{if(e.local)if(e instanceof Es)this.Gs(new Pe(this.id(),!1,e.index,e.src.get(e.index).dataValue()));else if(e instanceof Ss)this.Gs(new ai(this.id(),!1,e.index));else if(e instanceof Is)this.Gs(new ci(this.id(),!1,e.fromIndex,e.toIndex));else if(e instanceof Cs){const t=e.index;this.Gs(new oi(this.id(),!1,t,e.src.get(t).dataValue()))}else e instanceof _s&&this.Gs(new hi(this.id(),!1,e.src.dataValue().value))})}get(e){return this.Us.wrap(this.Ns.get(e))}set(e,t){return this.Ls(),this.Us.wrap(this.Ns.set(e,t))}insert(e,t){return this.Ls(),this.Us.wrap(this.Ns.insert(e,t))}remove(e){return this.Ls(),this.Us.wrap(this.Ns.remove(e))}reorder(e,t){this.Ls(),this.Ns.reorder(e,t)}push(e){return this.Ls(),this.Us.wrap(this.Ns.push(e))}pop(){return this.Ls(),this.Us.wrap(this.Ns.pop())}unshift(e){return this.Ls(),this.Us.wrap(this.Ns.unshift(e))}shift(){return this.Ls(),this.Us.wrap(this.Ns.shift())}length(){return this.Ns.length()}some(e){return this.Ns.some((t,s)=>e(this.Us.wrap(t),s))}every(e){return this.Ns.every((t,s)=>e(this.Us.wrap(t),s))}find(e){const t=this.Ns.find((t,s)=>e(this.Us.wrap(t),s));return void 0===t?void 0:this.Us.wrap(t)}findIndex(e){return this.Ns.findIndex((t,s)=>e(this.Us.wrap(t),s))}forEach(e){this.Ns.forEach((t,s)=>{e(this.Us.wrap(t),s)})}elementAt(...e){return this.Us.wrap(this.Ns.valueAt(...e))}Fs(e){if("number"!=typeof e)throw new Error("The relative path of a child must be a number: "+typeof e);this.remove(e)}$s(e){throw new Error("Arrays to do have references yet.")}}di.Events=ui;class li extends Ae{constructor(e,t,s){super(ve.BOOLEAN_VALUE,e,t),this.value=s,Object.freeze(this)}copy(e){return new li(n.update(this.id,e.id),n.update(this.noOp,e.noOp),n.update(this.value,e.value))}}class pi extends ni{constructor(e,t,s,i,n){super(e,t,s,i,[],n),this.Ns.events().subscribe(e=>{e.local&&e instanceof xs&&this.Gs(new li(this.id(),!1,e.value))})}$s(e){throw new Error("Boolean values do not process references")}}pi.Events=ii;class fi{constructor(e,t,s){this.Ws=e,this.zs=t,this.Ys=s}createDataValue(e){const t=this.Ws();if(o.isNull(e))return{id:t,type:"null",value:null};if(o.isString(e))return{id:t,type:"string",value:e};if(o.isDate(e))return{id:t,type:"date",value:e};if(o.isArray(e)){return{id:t,type:"array",value:e.map(e=>{if(void 0===e){if("null"===this.Ys)return this.createDataValue(null);throw new O("Found an undefined value within an array. To convert undefined values in arrays to null, set the options.model.data.undefinedArrayValues option to 'null'")}return this.createDataValue(e)})}}if(o.isObject(e)){if(e.hasOwnProperty("$convergenceType")){const s=e.$convergenceType;if("date"===s){if(e.hasOwnProperty("value"))return{id:t,type:"date",value:new Date(e.value)};throw new O("Invalid convergence data type 'data': The value field missing.")}throw new O("Invalid convergence data type: "+s+" supported types are [date].")}{const s={};return Object.getOwnPropertyNames(e).forEach(t=>{const i=e[t];if(void 0===i){if("omit"!==this.zs)throw new O("Found an undefined value within an object. To simply omit undefined values within objects, set the options.model.data.undefinedArrayValues option to 'omit'")}else s[t]=this.createDataValue(i)}),{id:t,type:"object",value:s}}}if(o.isNumber(e))return{id:t,type:"number",value:e};if(o.isBoolean(e))return{id:t,type:"boolean",value:e};throw new O("Unsupported data type found within model data: "+typeof e)}}class mi{}mi.OBJECT="object",mi.ARRAY="array",mi.STRING="string",mi.NUMBER="number",mi.BOOLEAN="boolean",mi.NULL="null",mi.UNDEFINED="undefined",mi.DATE="date";class gi extends R{constructor(e,t,s,i,n){super(),this.N=t,this.Vt=n,this.Qs=e,this.ks=i,this.Ks=s,this.ks&&this.ks.Xs(this)}session(){return this.Vt}id(){return this.N}type(){return this.Qs}path(){return this.Ks()}model(){return this.ks}isDetached(){return null===this.ks}Zs(e){this.ks.ei(this),this.ks=null;const t=new Rs(this,e);this.ve(t)}data(e){return 0===arguments.length?this.ti():void this.si(e)}ii(e){this.ve(e),this.ve(new Ms(this,e.local,[],e,this.Vt.sessionId(),this.Vt.user()))}ni(){if(this.isDetached())throw Error("Can not perform actions on a detached ModelNode.")}}gi.Events={DETACHED:"detached",NODE_CHANGED:"node_changed",OPERATION:"operation"};class vi extends gi{constructor(e,t,s){super(mi.UNDEFINED,e,t,void 0,s)}dataValue(){}toJson(){}ri(e){throw new Error("Undefined values do not process operations")}ti(){}si(e){throw new Error("Can not set the delta on a Undefined type.")}}vi.Events={DETACHED:gi.Events.DETACHED};class yi extends gi{constructor(e,t,s,i){super(mi.NULL,e,t,s,i)}dataValue(){return{id:this.id(),type:"null",value:this.data()}}toJson(){return null}ri(e){throw new Error("Null values do not process operations")}ti(){return null}si(e){throw new Error("Can not set the delta on a Null type.")}}yi.Events={DETACHED:gi.Events.DETACHED};class wi extends gi{constructor(e,t,s,i){super(mi.STRING,e.id,t,s,i),this.oi=e.value}dataValue(){return{id:this.id(),type:"string",value:this.data()}}toJson(){return this.oi}splice(e,t,s){this.ai(e,t,s,!0,this.Vt.sessionId(),this.Vt.user())}insert(e,t){this.ai(e,0,t,!0,this.Vt.sessionId(),this.Vt.user())}remove(e,t){this.ai(e,t,"",!0,this.Vt.sessionId(),this.Vt.user())}length(){return this.oi.length}ri(e){const t=e.operation.type;if(t===ve.STRING_SPLICE)this.ci(e);else{if(t!==ve.STRING_VALUE)throw new Error("Invalid operation type for a String: "+e.operation.type);this.ui(e)}}si(e){this.di(e,!0,this.Vt.sessionId(),this.Vt.user())}ti(){return this.oi}ai(e,t,s,i,n,r){l.assertValidStringIndex(e,this.oi,!0,"index"),l.assertValidStringIndex(e+t,this.oi,!0);const o=this.oi.slice(e,e+t);if(this.oi=this.oi.slice(0,e)+s+this.oi.slice(e+t,this.oi.length),t>0&&0===s.length){const t=new Us(this,i,e,o,n,r);this.ii(t)}else if(0===t&&s.length>0){const t=new qs(this,i,e,s,n,r);this.ii(t)}else if(t>0&&s.length>0){const o=new Ns(this,i,e,t,s,n,r);this.ii(o)}}di(e,t,s,i){l.assertString(e),this.oi=e;const n=new ks(this,t,e,s,i);this.ii(n)}ci(e){const t=e.operation;this.ai(t.index,t.deleteCount,t.insertValue,!1,e.sessionId,e.user)}ui(e){const t=e.operation;this.di(t.value,!1,e.sessionId,e.user)}}wi.Events={INSERT:"insert",REMOVE:"remove",VALUE:"value",DETACHED:gi.Events.DETACHED,MODEL_CHANGED:gi.Events.MODEL_CHANGED};class bi extends gi{constructor(e,t,s,i,n){super(e,t,s,i,n),this.li=e=>{const t=e.relativePath.slice(0);t.unshift(this.pi.get(e.src.id()));const s=new Ms(this,e.local,t,e.childEvent,this.Vt.sessionId(),this.Vt.user());this.ve(s)},this.pi=new Map}valueAt(...e){const t=1===e.length&&Array.isArray(e[0])?e[0]:e;return 0===e.length?this:this.fi(t)}Zs(e){this.mi(e),super.Zs(e)}gi(){return Si.create(void 0,()=>null,void 0,this.Vt)}}bi.Events={NODE_CHANGED:gi.Events.NODE_CHANGED};class Oi extends bi{constructor(e,t,s,i,n){super(mi.ARRAY,e.id,t,s,i),this.vi=[],this.yi=n;for(let t=0;t<e.value.length;t++){const r=e.value[t];this.pi.set(r.id,t),this.vi.push(Si.create(r,this.wi(r.id),s,i,n))}this.vi.forEach(e=>{e.on(Oi.Events.NODE_CHANGED,this.li)})}dataValue(){const e=this.vi.map(e=>e.dataValue());return{id:this.id(),type:"array",value:e}}toJson(){const e=[];return this.forEach(t=>{e.push(t.toJson())}),e}get(e){return this.bi(e,!1),this.vi[e]}set(e,t){this.bi(e,!1);const s=this.yi.createDataValue(t);return this.Oi(e,s,!0,this.Vt.sessionId(),this.Vt.user()),this.get(e)}insert(e,t){this.bi(e,!0);const s=this.yi.createDataValue(t);return this.Ri(e,s,!0,this.Vt.sessionId(),this.Vt.user()),this.get(e)}remove(e){this.bi(e,!1);const t=this.get(e);return this.Mi(e,!0,this.Vt.sessionId(),this.Vt.user()),t}reorder(e,t){this.bi(e,!1,"fromIndex"),this.bi(t,!1,"toIndex"),this.Ei(e,t,!0,this.Vt.sessionId(),this.Vt.user())}push(e){return this.insert(this.vi.length,e)}pop(){return this.remove(this.vi.length-1)}unshift(e){return this.insert(0,e)}shift(){return this.remove(0)}length(){return this.vi.length}some(e){return this.vi.some(e)}every(e){return this.vi.every(e)}find(e){return this.vi.find(e)}findIndex(e){return this.vi.findIndex(e)}forEach(e){this.vi.forEach(e)}ri(e){const t=e.operation.type;if(t===ve.ARRAY_INSERT)this.Si(e);else if(t===ve.ARRAY_REORDER)this.Ci(e);else if(t===ve.ARRAY_REMOVE)this.Ii(e);else if(t===ve.ARRAY_SET)this.ui(e);else{if(t!==ve.ARRAY_VALUE)throw new Error("Invalid operation type for an Array: "+e.operation.type);this._i(e)}}ti(){const e=[];return this.forEach(t=>{e.push(t.data())}),e}si(e){const t=e.map(e=>this.yi.createDataValue(e));this.di(t,!0,this.Vt.sessionId(),this.Vt.user())}mi(e){this.pi.clear(),this.forEach(t=>{t.Zs(e),t.removeListener(Oi.Events.NODE_CHANGED,this.li)})}fi(e){if(0===e.length)return this;const t=e[0],s=this.vi[t];return void 0===s?this.gi():e.length>1?s.type()===mi.OBJECT||s.type()===mi.ARRAY?s.valueAt(e.slice(1,e.length)):this.gi():s}bi(e,t,s){if(e<0){throw new Error(`${s||"index"} must be >= 0: ${e}`)}if(!t&&e>=this.vi.length||t&&e>this.vi.length){throw new Error(`${s||"index"} must be ${t?"<=":"<"} the length of the array: ${e}`)}}Ri(e,t,s,i,n){this.xi(e,t),this.pi.set(t.id,e);const r=Si.create(t,this.wi(t.id),this.ks,this.Vt,this.yi);r.on(Oi.Events.NODE_CHANGED,this.li),this.vi.splice(e,0,r),this.Di(e);const o=new Es(this,s,e,r,i,n);this.ii(o)}Oi(e,t,s,i,n){this.Ti(e,t);const r=this.fi([e]);r.type()!==mi.UNDEFINED&&(r.removeListener(Oi.Events.NODE_CHANGED,this.li),r.Zs(s)),this.pi.set(t.id,e);const o=Si.create(t,this.wi(t.id),this.model(),this.Vt,this.yi);o.on(Oi.Events.NODE_CHANGED,this.li),this.vi[e]=o,this.Di(e);const a=new Cs(this,s,e,o,r,i,n);this.ii(a)}Mi(e,t,s,i){this.ji(e);const n=this.fi([e]);n.type()!==mi.UNDEFINED&&(n.removeListener(Oi.Events.NODE_CHANGED,this.li),n.Zs(t)),this.vi.splice(e,1),this.Di(e);const r=new Ss(this,t,e,n,s,i);this.ii(r)}di(e,t,s,i){l.assertArray(e,"data"),this.mi(t),this.vi=e.map((e,t)=>(this.pi.set(e.id,t),Si.create(e,this.wi(e.id),this.model(),this.Vt,this.yi))),this.vi.forEach(e=>{e.on(Oi.Events.NODE_CHANGED,this.li)});const n=new _s(this,t,this.data(),s,i);this.ii(n)}Ei(e,t,s,i,n){this.Ai(e,t);const r=this.vi[e];this.vi.splice(e,1),this.vi.splice(t,0,r),this.Di(Math.min(e,t));const o=new Is(this,s,e,t,i,n);this.ii(o)}Si(e){const t=e.operation;this.Ri(t.index,t.value,!1,e.sessionId,e.user)}Ci(e){const t=e.operation;this.Ei(t.fromIndex,t.toIndex,!1,e.sessionId,e.user)}Ii(e){const t=e.operation;this.Mi(t.index,!1,e.sessionId,e.user)}ui(e){const t=e.operation;this.Oi(t.index,t.value,!1,e.sessionId,e.user)}_i(e){const t=e.operation;this.di(t.value,!1,e.sessionId,e.user)}wi(e){return()=>{const t=this.path();return t.push(this.pi.get(e)),t}}xi(e,t){if(this.vi.length<e||e<0)throw new Error("Index out of bounds!");if(void 0===t||"function"==typeof t)throw new Error("Invalid value for insert!")}Ai(e,t){if(this.vi.length<=e||e<0||this.vi.length<=t||t<0)throw new Error("Index out of bounds!")}ji(e){if(this.vi.length<=e||e<0)throw new Error("Index out of bounds!")}Ti(e,t){if(this.vi.length<=e||e<0)throw new Error("Index out of bounds!");if(void 0===t||"function"==typeof t)throw new Error("Illegal argument!")}Di(e){for(let t=e;t<this.vi.length;t++){const e=this.vi[t];this.pi.set(e.id(),t)}}}Oi.Events={INSERT:"insert",REMOVE:"remove",SET:"set",REORDER:"reorder",VALUE:"value",DETACHED:gi.Events.DETACHED,NODE_CHANGED:bi.Events.NODE_CHANGED};class Ri extends gi{constructor(e,t,s,i){super(mi.NUMBER,e.id,t,s,i),this.oi=e.value}dataValue(){return{id:this.id(),type:"number",value:this.data()}}toJson(){return this.oi}add(e){this.Pi(e,!0,this.Vt.sessionId(),this.Vt.user())}subtract(e){this.add(-e)}increment(){this.add(1)}decrement(){this.add(-1)}ri(e){const t=e.operation.type;if(t===ve.NUMBER_DELTA)this.Ni(e);else{if(t!==ve.NUMBER_VALUE)throw new Error("Invalid operation type for a Number: "+e.operation.type);this.ui(e)}}si(e){this.Oi(e,!0,this.Vt.sessionId(),this.Vt.user())}ti(){return this.oi}Pi(e,t,s,i){if(this.qi(e),0!==e){this.oi+=e;const n=new Ts(this,t,e,s,i);this.ii(n)}}Oi(e,t,s,i){this.qi(e),this.oi=e;const n=new Ds(this,t,e,s,i);this.ii(n)}Ni(e){const t=e.operation;this.Pi(t.delta,!1,e.sessionId,e.user)}ui(e){const t=e.operation;this.Oi(t.value,!1,e.sessionId,e.user)}qi(e){if("number"!=typeof e)throw new Error("The value must be a number but was: "+typeof e);if(isNaN(e))throw new Error("The delta must not be NaN")}}Ri.Events={DELTA:"delta",VALUE:"value",DETACHED:gi.Events.DETACHED,MODEL_CHANGED:gi.Events.MODEL_CHANGED};class Mi extends gi{constructor(e,t,s,i){super(mi.BOOLEAN,e.id,t,s,i),this.oi=e.value}dataValue(){return{id:this.id(),type:"boolean",value:this.data()}}toJson(){return this.oi}ri(e){if(e.operation.type!==ve.BOOLEAN_VALUE)throw new Error("Invalid operation type for a Boolean: "+e.operation.type);this.ui(e)}si(e){this.di(e,!0,this.Vt.sessionId(),this.Vt.user())}ti(){return this.oi}di(e,t,s,i){l.assertBoolean(e),this.oi=e;const n=new xs(this,t,e,s,i);this.ii(n)}ui(e){const t=e.operation;this.di(t.value,!1,e.sessionId,e.user)}}Mi.Events={VALUE:"value",DETACHED:gi.Events.DETACHED,MODEL_CHANGED:gi.Events.MODEL_CHANGED};class Ei extends gi{constructor(e,t,s,i){super(mi.DATE,e.id,t,s,i),this.oi=e.value}dataValue(){return{id:this.id(),type:"date",value:this.data()}}toJson(){return{$convergenceType:"date",value:this.oi.toISOString()}}ri(e){if(e.operation.type!==ve.DATE_VALUE)throw new Error("Invalid operation type for a Date: "+e.operation.type);this.ui(e)}si(e){this.di(e,!0,this.Vt.sessionId(),this.Vt.user())}ti(){return this.oi}di(e,t,s,i){l.assertDate(e),this.oi=e;const n=new Vs(this,t,e,s,i);this.ii(n)}ui(e){const t=e.operation;this.di(t.value,!1,e.sessionId,e.user)}}Ei.Events={VALUE:"value",DETACHED:gi.Events.DETACHED,MODEL_CHANGED:gi.Events.MODEL_CHANGED};class Si{static create(e,t,s,i,n){if(void 0===e)return new vi(void 0,t,i);const r=e.type;if("null"===r)return new yi(e.id,t,s,i);if("string"===r)return new wi(e,t,s,i);if("array"===r)return new Oi(e,t,s,i,n);if("object"===r)return new Ci(e,t,s,i,n);if("number"===r)return new Ri(e,t,s,i);if("boolean"===r)return new Mi(e,t,s,i);if("date"===r)return new Ei(e,t,s,i);throw new Error("Invalid data type: "+r)}}class Ci extends bi{constructor(e,t,s,i,n){super(mi.OBJECT,e.id,t,s,i),this.dataValueFactory=n,this.vi=new Map,Object.getOwnPropertyNames(e.value).forEach(t=>{const i=e.value[t];this.pi.set(i.id,t),this.vi.set(t,Si.create(i,this.wi(i.id),s,this.Vt,this.dataValueFactory))}),this.vi.forEach(e=>{e.on(Ci.Events.NODE_CHANGED,this.li)})}dataValue(){const e={};return this.vi.forEach((t,s)=>{e[s]=t.dataValue()}),{id:this.id(),type:"object",value:e}}toJson(){const e={};return this.forEach((t,s)=>{e[s]=t.toJson()}),e}get(e){return l.assertString(e,"key"),this.fi([e])}set(e,t){const s=this.dataValueFactory.createDataValue(t);return this.Oi(e,s,!0,this.Vt.sessionId(),this.Vt.user()),this.get(e)}remove(e){const t=this.fi([e]);return this.Mi(e,!0,this.Vt.sessionId(),this.Vt.user()),t}keys(){const e=[];return this.vi.forEach((t,s)=>{e.push(s)}),e}hasKey(e){return this.vi.has(e)}forEach(e){this.vi.forEach((t,s)=>{e(t,s)})}ri(e){switch(e.operation.type){case ve.OBJECT_ADD:this.Ui(e);break;case ve.OBJECT_SET:this.ki(e);break;case ve.OBJECT_REMOVE:this.Vi(e);break;case ve.OBJECT_VALUE:this.ui(e);break;default:throw new Error("Invalid operation type for an Object: "+e.operation.type)}}ti(){const e={};return this.forEach((t,s)=>{e[s]=t.data()}),e}si(e){const t={};for(const s in e)e.hasOwnProperty(s)&&(t[s]=this.dataValueFactory.createDataValue(e[s]));this.di(t,!0,this.Vt.sessionId(),this.Vt.user())}fi(e){if(0===e.length)return this;const t=e[0],s=this.vi.get(t);return void 0===s?this.gi():e.length>1?s.type()===mi.OBJECT||s.type()===mi.ARRAY?s.valueAt(e.slice(1,e.length)):this.gi():s}mi(e){this.forEach(t=>{t.Zs(e),t.removeListener(Ci.Events.NODE_CHANGED,this.li)})}wi(e){return()=>{const t=this.path();return t.push(this.pi.get(e)),t}}Oi(e,t,s,i,n){l.assertString(e,"key");const r=this.fi([e]);r.type()!==mi.UNDEFINED&&(r.removeListener(Ci.Events.NODE_CHANGED,this.li),r.Zs(s));const o=Si.create(t,this.wi(t.id),this.ks,this.Vt,this.dataValueFactory);o.on(Ci.Events.NODE_CHANGED,this.li),this.vi.set(e,o),this.pi.set(o.id(),e);const a=new js(this,s,e,o,r,i,n);this.ii(a)}Mi(e,t,s,i){if(l.assertString(e,"key"),this.vi.has(e)){this.pi.delete(e);const n=this.vi.get(e);n.removeListener(Ci.Events.NODE_CHANGED,this.li),n.Zs(t),this.vi.delete(e);const r=new As(this,t,e,n,s,i);this.ii(r)}}di(e,t,s,i){this.mi(t),this.vi=new Map;for(const t in e)if(e.hasOwnProperty(t)){const s=e[t];this.pi.set(s.id,t),this.vi.set(t,Si.create(s,this.wi(s.id),this.model(),this.Vt,this.dataValueFactory))}this.vi.forEach(e=>{e.on(Ci.Events.NODE_CHANGED,this.li)});const n=new Ps(this,t,this.data(),s,i);this.ii(n)}Ui(e){const t=e.operation;this.Oi(t.prop,t.value,!1,e.sessionId,e.user)}ki(e){const t=e.operation;this.Oi(t.prop,t.value,!1,e.sessionId,e.user)}Vi(e){const t=e.operation;this.Mi(t.prop,!1,e.sessionId,e.user)}ui(e){const t=e.operation;this.di(t.value,!1,e.sessionId,e.user)}}Ci.Events={SET:"set",REMOVE:"remove",VALUE:"value",DETACHED:gi.Events.DETACHED,NODE_CHANGED:gi.Events.NODE_CHANGED,OPERATION:gi.Events.OPERATION};class Ii extends R{constructor(e,t,s,i,n){super(),this.Vt=e,this.Li=t,this.Fi=new Map,this.$i=0;const r=new fi(()=>this.Li+":"+this.$i++,i,n);this.oi=new Ci(s,()=>[],this,e,r)}root(){return this.oi}valueAt(...e){return this.oi.valueAt(...e)}setValueIdPrefix(e){this.Li=e}Ps(e){return this.Fi.get(e)}Xs(e){this.Fi.set(e.id(),e)}ei(e){this.Fi.delete(e.id())}handleModelOperationEvent(e){const t=this.Fi.get(e.operation.id);t&&t.ri(e)}valueIdPrefix(){return this.Li}}var _i;Ii.Events={DELETED:"deleted",MODIFIED:"modified"},Object.freeze(Ii.Events),function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.UNAUTHORIZED=1]="UNAUTHORIZED",e[e.DELETED=2]="DELETED",e[e.ERROR_APPLYING_OPERATION=3]="ERROR_APPLYING_OPERATION",e[e.INVALID_REFERENCE_EVENT=4]="INVALID_REFERENCE_EVENT",e[e.PERMISSION_ERROR=5]="PERMISSION_ERROR",e[e.UNEXPECTED_COMMITTED_VERSION=6]="UNEXPECTED_COMMITTED_VERSION"}(_i||(_i={}));class xi{constructor(e,t,s,i,n){this.sessionId=e,this.seqNo=t,this.contextVersion=s,this.timestamp=i,this.operation=n,Object.freeze(this)}copy(e){return e=n.getOrDefault(e,{}),new xi(n.getOrDefault(e.sessionId,this.sessionId),n.getOrDefault(e.seqNo,this.seqNo),n.getOrDefault(e.contextVersion,this.contextVersion),n.getOrDefault(e.timestamp,this.timestamp),n.getOrDefault(e.operation,this.operation))}}class Di extends R{constructor(e,t,s,i,n){super(),this.rt=e,this.Gi=s,this.Ji=t,this.Bi=[],this.Hi=[],this.Wi=i,this.zi=n,this.Yi=!1,this.Qi=[]}lastSequenceNumber(){return this.Gi}setState(e,t,s){this.Ji=e,this.Gi=t,this.Hi.length=0,this.Hi.push(...s)}contextVersion(){return this.Ji}isCommitted(){return!this.hasInflightOperation()||this.Qi.length>0}hasInflightOperation(){return this.Hi.length>0}firstInFlightOperation(){return this.Hi[0]}getInFlightOperations(){return this.Hi.slice(0)}hasNextIncomingOperation(){return 0!==this.Bi.length}getNextIncomingOperation(){return 0===this.Bi.length?null:this.Bi.shift()}hasNextRemoteReference(){return 0!==this.Bi.length}getNextRemoteReferenceSetEvent(){return 0===this.Bi.length?null:this.Bi.shift()}startBatchOperation(){if(this.Yi)throw new Error("Batch operation already in progress.");this.Qi=[],this.Yi=!0}cancelBatchOperation(){if(!this.Yi)throw new Error("Batch operation not in progress.");if(0!==this.Qi.length)throw new Error("Can not cancel a batch operation if operations have been issued.");this.Yi=!1}completeBatchOperation(){if(!this.Yi)throw new Error("Batch operation not in progress.");if(this.Yi=!1,0===this.Qi.length)throw new Error("A Batch operation must have at least one operation.");const e=new ye(this.Qi);this.Qi=[];const t=++this.Gi,s=new xi(this.rt(),t,this.Ji,new Date,e);return this.Hi.push(s),s}batchSize(){return this.Qi.length}isBatchOperationInProgress(){return this.Yi}processOutgoingOperation(e){if(this.Yi&&!(e instanceof Ae))throw new Error("Can't process a compound operation that is in progress");const t=this.transformOutgoing(this.Bi,e),s=0===this.Hi.length&&0===this.Qi.length;let i=null;if(this.Yi?this.Qi.push(t):(i=new xi(this.rt(),++this.Gi,this.Ji,new Date,t),this.Hi.push(i)),s){const e={name:Di.Events.COMMIT_STATE_CHANGED,committed:!1};this.ve(e)}return i}processOutgoingSetReference(e){for(let t=0;t<this.Bi.length&&e;t++)e=this.zi.transform(this.Bi[t].operation,e);return e}dispose(){}processAcknowledgement(e,t){if(0===this.Hi.length)throw new Error("Received an acknowledgment, but had no uncommitted operations.");if(this.Ji!==e)throw new Error(`Acknowledgement did not meet expected context version of ${this.Ji}: ${e}`);const s=this.Hi.shift();if(void 0!==t&&s.seqNo!==t)throw new Error(`Acknowledgement did not meet expected sequence number of ${s.seqNo}: ${t}`);if(this.Ji++,0===this.Hi.length&&0===this.Qi.length){const e={name:Di.Events.COMMIT_STATE_CHANGED,committed:!0};this.ve(e)}return s}processRemoteOperation(e){if(e.version!==this.Ji)throw new Error(`Invalid version of ${e.version}, expected ${this.Ji}.`);e=this.transformInflightOperations(e),e=this.transformPendingCompoundOperations(e),this.Ji++,this.Bi.push(e)}processRemoteReferenceSet(e){for(let t=0;t<this.Hi.length&&e;t++)e=this.zi.transform(this.Hi[t].operation,e);return e}transformInflightOperations(e){let t=e.operation;for(let s=0;s<this.Hi.length;s++){const i=this.Hi[s],n=this.Wi.transform(t,i.operation);t=n.serverOp,this.Hi[s]=i.copy({contextVersion:e.version+1,operation:n.clientOp})}return e.copy({operation:t})}transformPendingCompoundOperations(e){let t=e.operation;for(let e=0;e<this.Qi.length;e++){const s=this.Qi[e],i=this.Wi.transform(t,s);t=i.serverOp,this.Qi[e]=i.clientOp}return e.copy({operation:t})}transformOutgoing(e,t){let s=t;for(let t=0;t<e.length;t++){const i=e[t],n=this.Wi.transform(i.operation,s);e[t]=i.copy({operation:n.serverOp}),s=n.clientOp}return s}}Di.Events={COMMIT_STATE_CHANGED:"commit_state_changed"};class Ti{constructor(){this.Ki=new Map}wrap(e){let t=this.Ki.get(e.id());return void 0===t&&(t=this.Xi(e),this.Ki.set(e.id(),t),e.on(gi.Events.DETACHED,()=>{this.Ki.delete(e.id())})),t}}class ji extends Ae{constructor(e,t,s){super(ve.OBJECT_REMOVE,e,t),this.prop=s,Object.freeze(this)}copy(e){return new ji(n.update(this.id,e.id),n.update(this.noOp,e.noOp),n.update(this.prop,e.prop))}}class Ai extends Ae{constructor(e,t,s){super(ve.OBJECT_VALUE,e,t),this.value=s,Object.freeze(this)}copy(e){return new Ai(n.update(this.id,e.id),n.update(this.noOp,e.noOp),n.update(this.value,e.value))}}const Pi=Object.assign({SET:"set",REMOVE:"remove"},ii);Object.freeze(Pi);class Ni extends ni{constructor(e,t,s,i,n){super(e,t,s,i,[Bs.Types.PROPERTY],n),this.Ns.events().subscribe(e=>this.Zi(e))}get(e){return this.Us.wrap(this.Ns.get(e))}set(e,t){this.Ls();const s=this.Ns.hasKey(e),i=this.Ns.set(e,t),n=s?new ct(this.id(),!1,e,i.dataValue()):new pt(this.id(),!1,e,i.dataValue());return this.Gs(n),this.Us.wrap(i)}remove(e){return this.Ls(),this.Us.wrap(this.Ns.remove(e))}keys(){return this.Ns.keys()}hasKey(e){return this.Ns.hasKey(e)}forEach(e){this.Ns.forEach((t,s)=>{e(this.Us.wrap(t),s)})}elementAt(...e){return this.Us.wrap(this.Ns.valueAt(...e))}propertyReference(e){const t=this.ns.getLocalReference(e);if(void 0!==t){if(t.reference().type()!==Bs.Types.PROPERTY)throw new Error("A reference with this key already exists, but is not an index reference");return t}{const t=new Qs(this.ns,e,this,this.Ns.session().user(),this.Ns.session().sessionId(),!0),s=new Pn(t,this.qs.referenceEventCallbacks);return this.ns.addLocalReference(s),s}}Fs(e){if("string"!=typeof e)throw new Error("The relative path of a child must be a string: "+typeof e);this.remove(e)}Zi(e){e instanceof Ps?(e.local&&this.Gs(new Ai(this.id(),!1,this.Ns.dataValue().value)),this.ns.removeAll()):e instanceof As?(e.local&&this.Gs(new ji(this.id(),!1,e.key)),this.ns.getAll().forEach(t=>{t instanceof Qs&&t.Rs(e.key)})):e instanceof js&&(e.local,this.ns.getAll().forEach(t=>{t instanceof Qs&&t.Rs(e.key)}))}}Ni.Events=Pi;class qi extends ni{constructor(e,t,s,i,n){super(e,t,s,i,[],n)}handleRemoteReferenceEvent(e){throw new Error("Null values do not process references")}}qi.Events=ii;class Ui extends Ae{constructor(e,t,s){super(ve.NUMBER_VALUE,e,t),this.value=s,Object.freeze(this)}copy(e){return new Ui(n.update(this.id,e.id),n.update(this.noOp,e.noOp),n.update(this.value,e.value))}}class ki extends Ae{constructor(e,t,s){super(ve.NUMBER_DELTA,e,t),this.delta=s,Object.freeze(this)}copy(e){return new ki(n.update(this.id,e.id),n.update(this.noOp,e.noOp),n.update(this.delta,e.delta))}}const Vi=Object.assign({DELTA:"delta"},ii);Object.freeze(Vi);class Li extends ni{constructor(e,t,s,i,n){super(e,t,s,i,[],n),this.Ns.events().subscribe(e=>{e.local&&(e instanceof Ds?this.Gs(new Ui(this.id(),!1,e.value)):e instanceof Ts&&this.Gs(new ki(this.id(),!1,e.value)))})}add(e){this.Ls(),this.Ns.add(e)}subtract(e){this.Ls(),this.Ns.subtract(e)}increment(){this.Ls(),this.Ns.increment()}decrement(){this.Ls(),this.Ns.decrement()}$s(e){throw new Error("Number values do not process references")}}Li.Events=Vi;class Fi extends Ae{constructor(e,t,s){super(ve.STRING_VALUE,e,t),this.value=s,Object.freeze(this)}copy(e){return new Fi(n.update(this.id,e.id),n.update(this.noOp,e.noOp),n.update(this.value,e.value))}}const $i=Object.assign({INSERT:"insert",REMOVE:"remove",SPLICE:"splice"},ii);Object.freeze($i);class Gi extends Ae{constructor(e,t,s,i,n){super(ve.STRING_SPLICE,e,t),this.index=s,this.deleteCount=i,this.insertValue=n,Object.freeze(this)}copy(e){return new Gi(n.update(this.id,e.id),n.update(this.noOp,e.noOp),n.update(this.index,e.index),n.update(this.deleteCount,e.deleteCount),n.update(this.insertValue,e.insertValue))}}class Ji extends ni{constructor(e,t,s,i,n){super(e,t,s,i,[Bs.Types.INDEX,Bs.Types.RANGE],n),this.Ns.events().subscribe(e=>this.en(e))}insert(e,t){this.Ls(),this.tn.insert(e,t)}remove(e,t){this.Ls(),this.tn.remove(e,t)}splice(e,t,s){this.Ls(),this.tn.splice(e,t,s)}length(){return this.tn.length()}indexReference(e){const t=this.ns.getLocalReference(e);if(void 0!==t){if(t.reference().type()!==Bs.Types.INDEX)throw new Error("A reference with this key already exists, but is not an index reference");return t}{const t=new Ws(this.ns,e,this,this.Ns.session().user(),this.Ns.session().sessionId(),!0),s=new An(t,this.qs.referenceEventCallbacks);return this.ns.addLocalReference(s),s}}rangeReference(e){const t=this.ns.getLocalReference(e);if(void 0!==t){if(t.reference().type()!==Bs.Types.RANGE)throw new Error("A reference with this key already exists, but is not a range reference");return t}{const t=new Ys(this.ns,e,this,this.Ns.session().user(),this.Ns.session().sessionId(),!0),s=new Nn(t,this.qs.referenceEventCallbacks);return this.ns.addLocalReference(s),s}}en(e){e instanceof qs?(e.local&&this.Gs(new Gi(this.id(),!1,e.index,0,e.value)),this.ns.getAll().forEach(t=>{(t instanceof Ws||t instanceof Ys)&&t.vs(e.index,e.value.length)})):e instanceof Us?(e.local&&this.Gs(new Gi(this.id(),!1,e.index,e.value.length,"")),this.ns.getAll().forEach(t=>{(t instanceof Ws||t instanceof Ys)&&t.R(e.index,e.value.length)})):e instanceof Ns?(e.local&&this.Gs(new Gi(this.id(),!1,e.index,e.deleteCount,e.insertValue)),this.ns.getAll().forEach(t=>{(t instanceof Ws||t instanceof Ys)&&t.ys(e.index,e.deleteCount,e.insertValue.length)})):e instanceof ks&&(e.local&&this.Gs(new Fi(this.id(),!1,e.value)),this.ns.removeAll())}get tn(){return this.Ns}}Ji.Events=$i,Object.freeze(Ji.Events);class Bi extends ni{constructor(e,t,s,i,n){super(e,t,s,i,[],n)}path(){return null}relativePath(){return null}parent(){return null}removeFromParent(){}handleRemoteReferenceEvent(e){throw new Error("Undefined values do not process references")}setData(e){throw new Error("Can not set the delta on a Undefined type.")}}Bi.Events=ii;class Hi extends Ae{constructor(e,t,s){super(ve.DATE_VALUE,e,t),this.value=s,Object.freeze(this)}copy(e){return new Hi(n.update(this.id,e.id),n.update(this.noOp,e.noOp),n.update(this.value,e.value))}}class Wi extends ni{constructor(e,t,s,i,n){super(e,t,s,i,[],n),this.Ns.events().subscribe(e=>{e.local&&e instanceof Vs&&this.Gs(new Hi(this.id(),!1,e.value))})}$s(e){throw new Error("Date values do not process references")}}Wi.Events=ii;class zi extends Ti{constructor(e,t,s){super(),this.qs=e,this.ks=t,this.Is=s}Xi(e){switch(e.type()){case mi.ARRAY:return new di(e,this.qs,this,this.ks,this.Is);case mi.OBJECT:return new Ni(e,this.qs,this,this.ks,this.Is);case mi.BOOLEAN:return new pi(e,this.qs,this,this.ks,this.Is);case mi.NULL:return new qi(e,this.qs,this,this.ks,this.Is);case mi.NUMBER:return new Li(e,this.qs,this,this.ks,this.Is);case mi.STRING:return new Ji(e,this.qs,this,this.ks,this.Is);case mi.UNDEFINED:return new Bi(e,this.qs,this,this.ks,this.Is);case mi.DATE:return new Wi(e,this.qs,this,this.ks,this.Is);default:return null}}}class Yi{constructor(e,t,s,i){this.clientId=e,this.version=t,this.timestamp=s,this.operation=i,Object.freeze(this)}copy(e){return e=n.getOrDefault(e,{}),new Yi(n.getOrDefault(e.clientId,this.clientId),n.getOrDefault(e.version,this.version),n.getOrDefault(e.timestamp,this.timestamp),n.getOrDefault(e.operation,this.operation))}}class Qi{constructor(e,t,s,i,n){this.sessionId=e,this.user=t,this.version=s,this.timestamp=i,this.operation=n,Object.freeze(this)}}class Ki{constructor(e,t){this.user=e,this.sessionId=t,Object.freeze(this)}}const Xi={CLOSED:"closed",DELETED:"deleted",VERSION_CHANGED:"version_changed"};Object.freeze(Xi);class Zi{constructor(e,t,s,i){this.read=e,this.write=t,this.remove=s,this.manage=i,Object.freeze(this)}static fromJSON(e){return new Zi(e.read,e.write,e.remove,e.manage)}toJSON(){return{read:this.read,write:this.write,remove:this.remove,manage:this.manage}}}Zi.NONE=new Zi(!1,!1,!1,!1);class en{constructor(e,t,s,i,n,r){this.data=e,this.collectionId=t,this.modelId=s,this.created=i,this.modified=n,this.version=r,Object.freeze(this)}}function tn(e){if(e.arrayValue){const{id:t,children:s}=e.arrayValue;return{type:"array",id:t,value:z(s).map(tn)}}if(e.objectValue)return rn(e.objectValue);if(e.booleanValue){const{id:t,value:s}=e.booleanValue;return{type:"boolean",id:t,value:H(s)}}if(e.dateValue){const{id:t,value:s}=e.dateValue;return{type:"date",id:t,value:X(s)}}if(e.doubleValue){const{id:t,value:s}=e.doubleValue;return{type:"number",id:t,value:B(s)}}if(e.stringValue){const{id:t,value:s}=e.stringValue;return{type:"string",id:t,value:W(s)}}if(e.nullValue){const{id:t}=e.nullValue;return{type:"null",id:t,value:null}}throw new O("Invalid data delta type: "+JSON.stringify(e))}function sn(e){if("array"===e.type){const{id:t,value:s}=e;return{arrayValue:{id:t,children:s.map(sn)}}}if("object"===e.type){const{id:t,value:s}=e;return{objectValue:{id:t,children:h(s,sn)}}}if("boolean"===e.type){const{id:t,value:s}=e;return{booleanValue:{id:t,value:s}}}if("date"===e.type){const{id:t,value:s}=e;return{dateValue:{id:t,value:Z(s)}}}if("number"===e.type){const{id:t,value:s}=e;return{doubleValue:{id:t,value:s}}}if("null"===e.type){const{id:t}=e;return{nullValue:{id:t}}}if("string"===e.type){const{id:t,value:s}=e;return{stringValue:{id:t,value:s}}}throw new O("Invalid data delta type: "+JSON.stringify(e))}function nn(e){return{id:e.id,children:h(e.value,sn)}}function rn(e){return{type:"object",id:e.id,value:h(Y(e.children),tn)}}function on(e){return void 0===e?void 0:new Zi(H(e.read),H(e.write),H(e.remove),H(e.manage))}function an(e){const t=Y(e.data.fields);return new en(h(t,ee),e.collectionId,e.modelId,X(e.createdTime),X(e.modifiedTime),B(e.version))}function cn(e){if(null==e)return[];{const t=[];return e.forEach((e,s)=>{t.push({user:ie(s),permissions:e})}),t}}class hn{constructor(e,t){this.sn=e,this.Ve=t}get modelId(){return this.sn}getPermissions(){return this.getAllUserPermissions().then(e=>{const t=e.get(this.Ve.session().user().userId.toGuid());return void 0!==t?t:Zi.NONE})}setOverridesCollection(e){const t={setModelPermissionsRequest:{modelId:this.sn,overrideCollection:{value:e},removeAllUserPermissionsBeforeSet:!1,setUserPermissions:[],removedUserPermissions:[]}};return this.Ve.request(t).then(()=>{})}getOverridesCollection(){const e={getModelPermissionsRequest:{modelId:this.sn}};return this.Ve.request(e).then(e=>{const{getModelPermissionsResponse:t}=e;return t.overridesCollection})}getWorldPermissions(){const e={getModelPermissionsRequest:{modelId:this.sn}};return this.Ve.request(e).then(e=>{const{getModelPermissionsResponse:t}=e;return on(t.worldPermissions)})}setWorldPermissions(e){const t={setModelPermissionsRequest:{modelId:this.sn,worldPermissions:e,removeAllUserPermissionsBeforeSet:!1,setUserPermissions:[],removedUserPermissions:[]}};return this.Ve.request(t).then(()=>{})}getAllUserPermissions(){const e={getModelPermissionsRequest:{modelId:this.sn}};return this.Ve.request(e).then(e=>{const{getModelPermissionsResponse:t}=e;return function(e){const t=new J;return o.isArray(e)&&e.forEach(e=>{const s=se(e.user);t.set(s,on(e.permissions))}),t}(t.userPermissions)})}setAllUserPermissions(e){e=J.of(e);const t={setModelPermissionsRequest:{modelId:this.sn,setUserPermissions:cn(e),removeAllUserPermissionsBeforeSet:!0}};return this.Ve.request(t).then(()=>{})}getUserPermissions(e){return this.getAllUserPermissions().then(t=>t.get(e))}setUserPermissions(e,t){const s=N.of(e),i={setModelPermissionsRequest:{modelId:this.sn,worldPermissions:null,setUserPermissions:[{user:ie(s),permissions:t}],removeAllUserPermissionsBeforeSet:!1,removedUserPermissions:[]}};return this.Ve.request(i).then(()=>{})}removeUserPermissions(e){const t=N.of(e),s={setModelPermissionsRequest:{modelId:this.sn,removeAllUserPermissionsBeforeSet:!1,removedUserPermissions:[ie(t)]}};return this.Ve.request(s).then(()=>{})}}function un(e){if(e.compoundOperation)return function(e){const t=z(e.operations).map(dn);return new ye(t)}(e.compoundOperation);if(e.discreteOperation)return dn(e.discreteOperation);throw new O("Invalid operation data: "+JSON.stringify(e))}function dn(e){if(e.arrayInsertOperation){const{id:t,noOp:s,index:i,value:n}=e.arrayInsertOperation;return new Pe(t,H(s),B(i),tn(n))}if(e.arrayRemoveOperation){const{id:t,noOp:s,index:i}=e.arrayRemoveOperation;return new ai(t,H(s),B(i))}if(e.arrayMoveOperation){const{id:t,noOp:s,fromIndex:i,toIndex:n}=e.arrayMoveOperation;return new ci(t,H(s),B(i),B(n))}if(e.arrayReplaceOperation){const{id:t,noOp:s,index:i,value:n}=e.arrayReplaceOperation;return new oi(t,H(s),B(i),tn(n))}if(e.arraySetOperation){const{id:t,noOp:s,values:i}=e.arraySetOperation;return new hi(t,H(s),z(i).map(tn))}if(e.objectAddPropertyOperation){const{id:t,noOp:s,key:i,value:n}=e.objectAddPropertyOperation;return new pt(t,H(s),W(i),tn(n))}if(e.objectSetPropertyOperation){const{id:t,noOp:s,key:i,value:n}=e.objectSetPropertyOperation;return new ct(t,H(s),W(i),tn(n))}if(e.objectRemovePropertyOperation){const{id:t,noOp:s,key:i}=e.objectRemovePropertyOperation;return new ji(t,H(s),W(i))}if(e.objectSetOperation){const{id:t,noOp:s,values:i}=e.objectSetOperation;return new Ai(t,H(s),h(i,tn))}if(e.stringSpliceOperation){const{id:t,noOp:s,index:i,deleteCount:n,insertedValue:r}=e.stringSpliceOperation;return new Gi(t,H(s),B(i),B(n),W(r))}if(e.stringSetOperation){const{id:t,noOp:s,value:i}=e.stringSetOperation;return new Fi(t,H(s),W(i))}if(e.numberDeltaOperation){const{id:t,noOp:s,delta:i}=e.numberDeltaOperation;return new ki(t,H(s),B(i))}if(e.numberSetOperation){const{id:t,noOp:s,value:i}=e.numberSetOperation;return new Ui(t,H(s),B(i))}if(e.booleanSetOperation){const{id:t,noOp:s,value:i}=e.booleanSetOperation;return new li(t,H(s),H(i))}if(e.dateSetOperation){const{id:t,noOp:s,value:i}=e.dateSetOperation;return new Hi(t,H(s),X(i))}}function ln(e){if(e instanceof ye)return{compoundOperation:pn(e)};if(e instanceof Ae)return{discreteOperation:fn(e)};throw new O("Invalid operation data: "+JSON.stringify(e))}function pn(e){return{operations:e.ops.map(fn)}}function fn(e){if(e instanceof Pe){const{id:t,noOp:s,index:i,value:n}=e;return{arrayInsertOperation:{id:t,noOp:s,index:i,value:sn(n)}}}if(e instanceof ai){const{id:t,noOp:s,index:i}=e;return{arrayRemoveOperation:{id:t,noOp:s,index:i}}}if(e instanceof ci){const{id:t,noOp:s,fromIndex:i,toIndex:n}=e;return{arrayMoveOperation:{id:t,noOp:s,fromIndex:i,toIndex:n}}}if(e instanceof oi){const{id:t,noOp:s,index:i,value:n}=e;return{arrayReplaceOperation:{id:t,noOp:s,index:i,value:sn(n)}}}if(e instanceof hi){const{id:t,noOp:s,value:i}=e;return{arraySetOperation:{id:t,noOp:s,values:i.map(sn)}}}if(e instanceof pt){const{id:t,noOp:s,prop:i,value:n}=e;return{objectAddPropertyOperation:{id:t,noOp:s,key:i,value:sn(n)}}}if(e instanceof ct){const{id:t,noOp:s,prop:i,value:n}=e;return{objectSetPropertyOperation:{id:t,noOp:s,key:i,value:sn(n)}}}if(e instanceof ji){const{id:t,noOp:s,prop:i}=e;return{objectRemovePropertyOperation:{id:t,noOp:s,key:i}}}if(e instanceof Ai){const{id:t,noOp:s,value:i}=e;return{objectSetOperation:{id:t,noOp:s,values:h(i,sn)}}}if(e instanceof Gi){const{id:t,noOp:s,index:i,deleteCount:n,insertValue:r}=e;return{stringSpliceOperation:{id:t,noOp:s,index:i,deleteCount:n,insertedValue:r}}}if(e instanceof Fi){const{id:t,noOp:s,value:i}=e;return{stringSetOperation:{id:t,noOp:s,value:i}}}if(e instanceof ki){const{id:t,noOp:s,delta:i}=e;return{numberDeltaOperation:{id:t,noOp:s,delta:i}}}if(e instanceof Ui){const{id:t,noOp:s,value:i}=e;return{numberSetOperation:{id:t,noOp:s,value:i}}}if(e instanceof li){const{id:t,noOp:s,value:i}=e;return{booleanSetOperation:{id:t,noOp:s,value:i}}}if(e instanceof Hi){const{id:t,noOp:s,value:i}=e;return{dateSetOperation:{id:t,noOp:s,value:Z(i)}}}}function mn(e){if(e.indices){return{referenceType:"index",values:z(e.indices.values).map(B)}}if(e.ranges){return{referenceType:"range",values:z(e.ranges.values).map(({startIndex:e,endIndex:t})=>({start:B(e),end:B(t)}))}}if(e.properties){return{referenceType:"property",values:z(e.properties.values).map(W)}}if(e.elements){return{referenceType:"element",values:z(e.elements.values).map(W)}}}function gn(e,t){switch(e){case Bs.Types.INDEX:return{indices:{values:t}};case Bs.Types.PROPERTY:return{properties:{values:t}};case Bs.Types.RANGE:return{ranges:{values:t.map(e=>({startIndex:e.start,endIndex:e.end}))}};case Bs.Types.ELEMENT:const e=[];for(const s of t)e.push(s.id());return{elements:{values:e}};default:throw new Error("Invalid reference type")}}function vn(e){if(e instanceof ye){return{type:"compound",ops:e.ops.map(e=>vn(e))}}return e instanceof Pe?{type:"array_insert",id:e.id,noOp:e.noOp,index:e.index,value:e.value}:e instanceof oi?{type:"array_replace",id:e.id,noOp:e.noOp,index:e.index,value:e.value}:e instanceof ai?{type:"array_remove",id:e.id,noOp:e.noOp,index:e.index}:e instanceof ci?{type:"array_move",id:e.id,noOp:e.noOp,fromIndex:e.fromIndex,toIndex:e.toIndex}:e instanceof hi?{type:"array_set",id:e.id,noOp:e.noOp,value:e.value}:e instanceof pt?{type:"object_add_property",id:e.id,noOp:e.noOp,key:e.prop,value:e.value}:e instanceof ct?{type:"object_set_property",id:e.id,noOp:e.noOp,key:e.prop,value:e.value}:e instanceof ji?{type:"object_remove_property",id:e.id,noOp:e.noOp,key:e.prop}:e instanceof Ai?{type:"object_set",id:e.id,noOp:e.noOp,value:e.value}:e instanceof Gi?{type:"string_splice",id:e.id,noOp:e.noOp,index:e.index,deleteCount:e.deleteCount,insertedValue:e.insertValue}:e instanceof Fi?{type:"string_set",id:e.id,noOp:e.noOp,value:e.value}:e instanceof ki?{type:"number_delta",id:e.id,noOp:e.noOp,value:e.delta}:e instanceof Ui?{type:"number_set",id:e.id,noOp:e.noOp,value:e.value}:e instanceof li?{type:"boolean_set",id:e.id,noOp:e.noOp,value:e.value}:e instanceof Hi?{type:"date_set",id:e.id,noOp:e.noOp,value:e.value}:void 0}function yn(e){switch(e.type){case"array_insert":const t=e;return new Pe(t.id,t.noOp,t.index,t.value);case"array_remove":const s=e;return new ai(s.id,s.noOp,s.index);case"array_replace":const i=e;return new oi(i.id,i.noOp,i.index,i.value);case"array_move":const n=e;return new ci(n.id,n.noOp,n.fromIndex,n.toIndex);case"array_set":const r=e;return new hi(r.id,r.noOp,r.value);case"object_add_property":const o=e;return new pt(o.id,o.noOp,o.key,o.value);case"object_set_property":const a=e;return new ct(a.id,a.noOp,a.key,a.value);case"object_remove_property":const c=e;return new ji(c.id,c.noOp,c.key);case"object_set":const h=e;return new Ai(h.id,h.noOp,h.value);case"string_splice":const u=e;return new Gi(u.id,u.noOp,u.index,u.deleteCount,u.insertedValue);case"string_set":const d=e;return new Fi(d.id,d.noOp,d.value);case"number_delta":const l=e;return new ki(l.id,l.noOp,l.value);case"number_set":const p=e;return new Ui(p.id,p.noOp,p.value);case"boolean_set":const f=e;return new li(f.id,f.noOp,f.value);case"date_set":const m=e;return new Hi(m.id,m.noOp,m.value);case"compound":const g=e.ops.map(e=>yn(e));return new ye(g)}}class wn extends C{constructor(){super(),this.in=[],this.nn=void 0,this.rn=void 0}static resolved(e){const t=new wn;return t.resolve(e),t}resolve(e){super.resolve(e),this.nn=e,this.in.forEach(t=>t.resolve(e))}reject(e){super.reject(e),this.rn=e,this.in.forEach(t=>t.reject(e))}promise(){if(this.isPending()){const e=new I;return this.in.push(e),e.promise()}return this.isRejected()?Promise.reject(this.rn):Promise.resolve(this.nn)}}class bn{constructor(e){this.domain=e,this.name=bn.NAME,Object.freeze(this)}}bn.NAME="connected";class On{constructor(e,t,s,i){this.domain=e,this.code=t,this.authMethod=s,this.message=i,this.name=On.NAME,Object.freeze(this)}}On.NAME="connection_failed";class Rn{constructor(e,t){this.domain=e,this.delay=t,this.name=Rn.NAME,Object.freeze(this)}}Rn.NAME="connection_scheduled";class Mn{constructor(e){this.domain=e,this.name=Mn.NAME,Object.freeze(this)}}Mn.NAME="connecting";class En{constructor(e,t){this.domain=e,this.method=t,this.name=En.NAME,Object.freeze(this)}}En.NAME="authenticating";class Sn{constructor(e){this.domain=e,this.name=Sn.NAME,Object.freeze(this)}}Sn.NAME="disconnected";class Cn{constructor(e){this.domain=e,this.name=Cn.NAME,Object.freeze(this)}}Cn.NAME="interrupted";class In{constructor(e,t,s){this.domain=e,this.message=t,this.cause=s,this.name=In.NAME,Object.freeze(this)}}In.NAME="error";var _n=function(e,t,s,i){return new(s||(s=Promise))((function(n,r){function o(e){try{c(i.next(e))}catch(e){r(e)}}function a(e){try{c(i.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(o,a)}c((i=i.apply(e,t||[])).next())}))};const xn=Object.assign(Object.assign({},Xi),{MODIFIED:os.NAME,COMMITTED:rs.NAME,RESYNC_STARTED:Kt.NAME,RESYNC_COMPLETED:Xt.NAME,RESYNC_ERROR:Zt.NAME,REMOTE_RESYNC_STARTED:ts.NAME,REMOTE_RESYNC_COMPLETED:ss.NAME,OFFLINE:Yt.NAME,ONLINE:zt.NAME,RECONNECTING:Qt.NAME,COLLABORATOR_OPENED:is.NAME,COLLABORATOR_CLOSED:ns.NAME,REFERENCE:es.NAME,PERMISSIONS_CHANGED:Ht.NAME});class Dn extends R{constructor(e,t,s,i,n,r,o,a,c,h,u,d,l,p,f,m,g,y,b,O){super(),this.F=v.logger("models"),this.an=!1,this.cn=e,this.us=i,this.hn=h,this.un=u,this.sn=d,this.dn=l,this.ln=p,this.Ve=f,this.pn=g,this.mn=c,this.Is=m,this.gn=y,this.vn=n,this.yn=!1,this.wn=null,this.bn={deferred:new wn,closing:!1,waitingForServer:!1},this.ks=new Ii(this.session(),t,s,b,O),this.On=new Map,this.Rn=[...r],this.Mn=[...o],this.En=new w.BehaviorSubject(this.collaborators());this.ns=new si(this,[Bs.Types.ELEMENT],e=>this.Sn(e),this.Is),this.ln.on(Di.Events.COMMIT_STATE_CHANGED,e=>{const t=e.committed?new rs(this):new os(this);this.ve(t)});const R={onShare:this.Cn.bind(this),onUnShare:this.In.bind(this),onSet:this._n.bind(this),onClear:this.xn.bind(this)};this.qs={sendOperationCallback:e=>{const t=this.ln.processOutgoingOperation(e);this.ln.isBatchOperationInProgress()||this.Dn(t)},referenceEventCallbacks:R},this.Us=new zi(this.qs,this,this.Is),this.Tn=!0,this.jn(a),this.An=this.gn.isOfflineEnabled()}permissions(){return this.mn}permissionsManager(){return new hn(this.sn,this.Ve)}session(){return this.Ve.session()}emitLocalEvents(e){return 0===arguments.length?this.an:void(this.an=e)}collaborators(){return this.Rn.map(e=>{const t=this.Is.getUserForSession(e);return new Ki(t,e)})}resynchronizingCollaborators(){return this.Mn.map(e=>{const t=this.Is.getUserForSession(e);return new Ki(t,e)})}collaboratorsAsObservable(){return this.En.asObservable()}collectionId(){return this.dn}modelId(){return this.sn}time(){return this.un}minTime(){return this.hn}maxTime(){return this.time()}createdTime(){return this.hn}version(){return this.ln.contextVersion()}minVersion(){return 0}maxVersion(){return this.version()}isCommitted(){return this.ln.isCommitted()}root(){return this.Us.wrap(this.ks.root())}elementAt(...e){return this.Us.wrap(this.ks.valueAt(...e))}isOpen(){return this.Tn}isLocal(){return this.us}close(){if(this.F.debug("RealtimeModel.close() called: "+this.sn),this.bn.closing)return Promise.reject(new O(`The model '${this.sn}' is already closing`));if(!this.Tn)return Promise.reject(new O(`The model '${this.sn}' has already been closed`));if(null!==this.wn)return this.Pn("Close called on a resyncing model"),this.vn=!0,Promise.resolve();{this.Pn("Close called on a non-resyncing model");const e=new Jt(this,!0);return this.Nn(!0,e),this.bn.deferred.promise()}}isClosing(){return this.bn.closing||this.qn()}whenClosed(){return this.bn.deferred.promise()}startBatch(){this.ln.startBatchOperation()}endBatch(){this.completeBatch()}completeBatch(){const e=this.ln.completeBatchOperation();this.Dn(e)}batchSize(){return this.ln.batchSize()}cancelBatch(){return this.ln.cancelBatchOperation()}isBatchStarted(){return this.ln.isBatchOperationInProgress()}elementReference(e){const t=this.ns.getLocalReference(e);if(void 0!==t){if(t.reference().type()!==Bs.Types.ELEMENT)throw new Error("A reference with this key already exists, but is not an observable reference");return t}{const t=this.session(),s=new ri(this.ns,e,this,t.user(),t.sessionId(),!0),i=new jn(s,this.qs.referenceEventCallbacks);return this.ns.addLocalReference(i),i}}reference(e,t){return this.ns.get(e,t)}references(e){return this.ns.getAll(e)}subscribeOffline(){return this.gn.subscribe([this.sn])}unsubscribeOffline(){return this.gn.unsubscribe([this.sn])}isSubscribedOffline(){return this.gn.isModelSubscribed(this.sn)}Un(){return this.cn}Nn(e,t){if(this.bn.closing)throw new O(`The model '${this.sn}' is already closing.`,"already_closing");if(this.bn.closing=!0,this.bn.event=t,this.Ve.isConnected()&&e){this.Pn("Close initiated (online)"),this.bn.waitingForServer=!0;const e={closeRealTimeModelRequest:{resourceId:this.cn}};this.Ve.request(e).then(()=>{this.Pn("Closed with server"),this.bn.waitingForServer=!1,this.kn()}).catch(e=>{this.F.error("Unexpected error closing a model: "+this.sn,e),this.bn.deferred.reject(e)})}else this.Pn("Close initiated (offline)"),this.kn()}Li(){return this.ks.valueIdPrefix()}kn(){!this.bn.closing||this.bn.waitingForServer||!this.ln.isCommitted()&&this.Ve.isConnected()||this.Vn()}Ln(){if(this.bn.closing)throw new O("Can't open after resynchronization if the mode is closing: "+this.sn);this.vn=!1}Fn(){return this.vn}$n(){return{data:this.ks.root().dataValue(),lastSequenceNumber:this.ln.lastSequenceNumber(),uncommittedOperations:[...this.ln.getInFlightOperations()]}}Gn(e,t,s){const i=t.map(e=>{const t=yn(e.operation);return new Yi(e.sessionId,e.version,e.timestamp,t)}).sort((e,t)=>e.version-t.version),n=s.map(e=>{const t=yn(e.operation);return new xi(e.sessionId,e.sequenceNumber,e.contextVersion,e.timestamp,t)}).sort((e,t)=>e.contextVersion===t.contextVersion?e.seqNo-t.seqNo:e.contextVersion-t.contextVersion);let r=this.ln.contextVersion(),o=this.ln.lastSequenceNumber(),a=[];for(;n.length>0&&n[0].seqNo<=o;)n.shift();const c=()=>i.length>0&&(0===n.length||i[0].version<=n[0].contextVersion),h=()=>n.length>0&&n[0].contextVersion===r;for(;c()||h();){for(;c();){const e=i.shift();this.Jn(e.operation,e.clientId,e.version,e.timestamp),r++}for(;h();){const e=n.shift();this.Jn(e.operation,this.Ve.session().sessionId(),e.contextVersion,e.timestamp),o=e.seqNo,a.push(e)}}if(i.length>0||n.length>0)throw new Error(`Unable to apply all events while rehydrating model "${this.sn}" from offline state.`);if(r!==e)throw new Error(`Did not arrive at the proper version (${e}) when rehydrating model: ${r}`);this.ln.setState(r,o,a)}Ps(e){return this.Us.wrap(this.ks.Ps(e))}Bn(e){const{forceCloseRealTimeModel:t,remoteOperation:s,referenceShared:i,referenceSet:n,referenceCleared:r,referenceUnshared:o,operationAck:a,remoteClientOpenedModel:c,remoteClientClosedModel:h,modelPermissionsChanged:u,remoteClientResyncStarted:d,remoteClientResyncCompleted:l,modelResyncServerComplete:p}=e.message;if(t)this.Hn(t);else if(s)this.Wn(s);else if(a)this.zn(a);else if(i||n||r||o){const t=function(e){if(e.referenceShared){const{sessionId:t,key:s,references:i,valueId:n,resourceId:r}=e.referenceShared,{referenceType:o,values:a}=mn(i);return new Xs(t,r,K(n),s,o,a)}if(e.referenceSet){const{sessionId:t,key:s,references:i,valueId:n,resourceId:r}=e.referenceSet,{values:o}=mn(i);return new ei(t,r,K(n),s,o)}if(e.referenceCleared){const{sessionId:t,key:s,valueId:i,resourceId:n}=e.referenceCleared;return new ti(t,n,K(i),s)}if(e.referenceUnshared){const{sessionId:t,key:s,valueId:i,resourceId:n}=e.referenceUnshared;return new Zs(t,n,K(i),s)}}(e.message);this.$s(t)}else if(c)this.Yn(W(c.sessionId));else if(h)this.Qn(W(h.sessionId));else if(u)this.Kn(u);else if(d)this.Xn(d);else if(l)this.Zn(l);else{if(!p)throw new Error("Unexpected message"+JSON.stringify(e.message));this.er(p)}}tr(){return this.yn}sr(){this.Pn("Offline"),this.yn=!0,this.ve(new Yt(this)),this.Rn.forEach(e=>this.Qn(e)),this.Rn=[],this.wn=null,this.cn=null,this.bn.closing&&this.Vn()}ir(){this.yn=!1,this.wn={bufferedOperations:[],resyncCompleted:!1,upToDate:!1},this.us?this.nr().catch(e=>{this.F.error("An unexpected error occurred while synchronizing offline model on reconnect.",e)}):this.rr()}nr(){return _n(this,void 0,void 0,(function*(){try{const e=yield this.gn.getModelMetaData(this.sn);yield this.or(e);const t=yield this.gn.getModelCreationData(this.sn);yield this.ar(t).catch(e=>this.cr(t,e)),this.us=!1,yield this.gn.modelCreated(this.sn),this.rr()}catch(e){this.hr(e.message)}}))}cr(e,t){if(t instanceof M&&t.code!==A.MODEL_ALREADY_EXISTS){const s=t.details.fingerprint;if(e.createdTime.getTime().toString()===s)return}return Promise.reject(t)}ar(e){this.Pn("Creating offline model at the server");const t=e.userPermissions&&J.fromGuidObjectMap(e.userPermissions),s={id:e.modelId,collection:e.collection,overrideCollectionWorldPermissions:e.overrideCollectionWorldPermissions,worldPermissions:e.worldPermissions,userPermissions:t};return this.pn.ur(s,e.initialData)}or(e){return e.deleted?this.pn.remove(this.sn).catch(e=>{console.log(e)}).then(()=>this.gn.modelDeleted(this.sn)):Promise.resolve()}dr(){this.An=!1;const e=new Jt(this,!0,"The model was locally deleted");this.Nn(!0,e);const t=`The model '${this.sn}' was locally deleted while offline.`,s=new Bt(this,!0,t);this.ve(s)}rr(){this.Pn("Requesting model resynchronization"),this.ve(new Qt(this));const e={modelResyncRequest:{modelId:this.sn,contextVersion:this.ln.contextVersion()}};this.Ve.request(e).then(e=>{this.Pn("Starting model resynchronization"),this.ve(new Kt(this));const{modelResyncResponse:t}=e;this.mn=on(t.permissions),this.wn.reconnectVersion=B(t.currentVersion),this.cn=B(t.resourceId),this.pn.lr(this.sn,this.cn),this.pr()}).catch(e=>this.hr(e.message))}hr(e){this.ve(new Zt(this,e)),this.pn.hr(this.sn,e,this)}Kn(e){const t=this.mn;this.mn=on(e.permissions);const s=[];this.mn.read!==t.read&&s.push("read"),this.mn.write!==t.write&&s.push("write"),this.mn.remove!==t.remove&&s.push("remove"),this.mn.manage!==t.manage&&s.push("manage");const i=new Ht(this,this.mn,s);this.ve(i)}Xn(e){const t=W(e.sessionId);this.Mn.push(t);const s=this.Is.getUserForSession(t),i=new ts(this,t,s);this.ve(i)}Zn(e){const t=W(e.sessionId);this.Mn.push(t);const s=this.Mn.indexOf(t);s>=0&&this.Mn.splice(s,1);const i=this.Is.getUserForSession(t),n=new ss(this,t,i);this.ve(n)}Yn(e){this.Rn.push(e),this.On.set(e,[]);const t=this.Is.getUserForSession(e),s=new is(this,new Ki(t,e));this.ve(s),this.En.next(this.collaborators())}Qn(e){this.Rn=this.Rn.filter(t=>t!==e);const t=this.On.get(e);this.On.delete(e),t.forEach(e=>{e.ds()});const s=this.Is.getUserForSession(e),i=new ns(this,new Ki(s,e));this.ve(i),this.En.next(this.collaborators())}$s(e){if(null===e.valueId)this.mr(e);else{const t=this.Ps(e.valueId);if(!t)return;if(e instanceof Xs){if(e.values){let t={type:e.referenceType,valueId:e.valueId,values:e.values};t=this.ln.processRemoteReferenceSet(t),e=new Xs(e.sessionId,e.resourceId,e.valueId,e.key,e.referenceType,t.values)}}else if(e instanceof ei){const s=t.reference(e.sessionId,e.key);if(!s)return void this.F.warn("received an update for a non-existent reference.");let i={type:s.type(),valueId:e.valueId,values:e.values};i=this.ln.processRemoteReferenceSet(i),e=new ei(e.sessionId,e.resourceId,e.valueId,e.key,i.values)}if(e instanceof Zs){const s=t.reference(e.sessionId,e.key),i=this.On.get(e.sessionId).indexOf(s);this.On.get(e.sessionId).splice(i,1)}if(t.$s(e),e instanceof Xs){const s=t.reference(e.sessionId,e.key);this.On.get(e.sessionId).push(s)}}}Hn(e){if(this.isClosing())return;const t=new Jt(this,!1,e.reason);if(this.Nn(!1,t),e.reasonCode===_i.DELETED){const t=new Bt(this,!1,e.reason);this.ve(t)}else this.F.error(`The model with id '${this.sn}' was forcefully closed by the server: ${e.reason}`)}Vn(){this.Pn("Finishing close");const{deferred:e,event:t}=this.bn;this.pn.Vn(this),this.gn.isOfflineEnabled()&&this.gn.modelClosed(this),this.ks.root().Zs(!1),this.Tn=!1,this.Ve=null,this.cn=null,this.bn.closing=!1,e.resolve(),t&&this.ve(t)}zn(e){const t=B(e.version),s=B(e.sequenceNumber);let i;try{i=this.ln.processAcknowledgement(t,s)}catch(e){return void this.gr(e)}if(this.un=X(e.timestamp),this.An){const e=vn(i.operation),n={modelId:this.sn,sessionId:this.Ve.session().sessionId(),version:t,timestamp:this.un,operation:e};this.gn.processOperationAck(this.modelId(),s,n).catch(e=>{this.vr("Error storing operation ack: "+this.sn,e)})}this.kn(),this.yr()}Wn(e){if(null===this.wn||this.wn.upToDate)this.wr(e);else if(B(e.contextVersion)>this.wn.reconnectVersion)this.wn.bufferedOperations.push(e);else if(this.ln.hasInflightOperation()&&this.ln.firstInFlightOperation().sessionId===e.sessionId){const t={resourceId:e.resourceId,version:e.contextVersion,timestamp:e.timestamp};this.zn(t),this.pr()}else this.wr(e),this.pr()}wr(e){const t=new Yi(W(e.sessionId),B(e.contextVersion),X(e.timestamp),un(e.operation));this.br(t)}br(e){try{this.ln.processRemoteOperation(e)}catch(e){return void this.gr(e)}const t=this.ln.getNextIncomingOperation(),s=t.operation,i=t.clientId,n=t.version,r=t.timestamp;if(this.un=new Date(r),this.Jn(s,i,n,r),this.yr(),this.An){const e=this.ln.getInFlightOperations();this.gn.processServerOperationEvent(this.sn,t,e).catch(e=>{this.vr("Error storing remote operation: "+this.sn,e)})}}gr(e){const t=`A concurrency control error occurred within model "${this.sn}".`;this.vr(t,e);const s=new Jt(this,!1,"A concurrency control error occurred.");this.Nn(!0,s)}Jn(e,t,s,i){const n=this.Is.getUserForSession(t);if(e.type===ve.COMPOUND){e.ops.forEach(e=>{this.Or(e,n,t,s,i)})}else{const r=e;this.Or(r,n,t,s,i)}}Or(e,t,s,i,n){if(!e.noOp){const r=new Qi(s,t,i,n,e);this.Rr(r)}}pr(){if(null!==this.wn&&!this.wn.upToDate&&this.wn.reconnectVersion===this.ln.contextVersion()){this.wn.upToDate=!0,this.wn.bufferedOperations.forEach(e=>{this.wr(e)}),this.Pn("All server operations applied during resynchronization");this.ln.getInFlightOperations().forEach(e=>this.Gs(e)),this.Pn("All local operations resent during resynchronization"),this.Mr()}}Mr(){this.Pn("Requesting resynchronization completion"),this.wn.resyncCompleted=!0,this.wn.openAfterComplete=!this.vn;const e={modelResyncClientComplete:{resourceId:this.cn,open:this.wn.openAfterComplete}};this.Ve.send(e)}er(e){this.Pn("Resynchronization completed");const t=this.wn.openAfterComplete,s=t&&!this.vn;if(this.wn=null,this.ve(new Xt(this)),this.pn.Er(this.sn),s){this.Pn("Opening after reconnect");z(e.connectedClients).forEach(e=>this.Yn(e)),this.jn(z(e.references)),this.ns.reShare(),this.Pn("Online"),this.ve(new zt(this))}else this.Nn(t)}qn(){return null!==this.wn&&this.wn.resyncCompleted&&!this.wn.openAfterComplete}Pn(e){this.F.debug(`Model("${this.sn}"): ${e}`)}Rr(e){this.ks.handleModelOperationEvent(e)}Dn(e){this.An&&this.gn.processLocalOperation(this.sn,e).catch(e=>{this.vr("Error storing local operation: "+this.sn,e)}),this.Gs(e)}Gs(e){if(this.Sr()){const t={operationSubmission:{resourceId:this.cn,sequenceNumber:e.seqNo,contextVersion:e.contextVersion,operation:ln(e.operation)}};this.Ve.send(t)}}yr(){const e=new Wt(this,this.ln.contextVersion());this.ve(e)}mr(e){this.ns.handleRemoteReferenceEvent(e)}Sn(e){this.On.get(e.sessionId()).push(e),this.ve(new es(e,this))}jn(e){this.On.clear(),this.Rn.forEach(e=>{this.On.set(e,[])}),e.forEach(e=>{let t;const s=K(e.valueId);null!==s&&(t=this.Us.wrap(this.ks.Ps(s)));const{referenceType:i,values:n}=mn(e.reference),r=new Xs(e.sessionId,this.cn,s,e.key,i,n);if(void 0!==t){t.$s(r);const s=t.reference(e.sessionId,e.key);this.On.get(e.sessionId).push(s)}else this.mr(r)})}Cn(e){if(this.Sr()){const t=e.reference().source(),s=t instanceof ni?t.id():null;let i={type:e.reference().type(),valueId:s,values:e.reference().values()};void 0!==s&&(i=this.ln.processOutgoingSetReference(i));const n={shareReference:{resourceId:this.cn,key:e.reference().key(),valueId:Q(s),references:gn(e.reference().type(),i.values),version:this.ln.contextVersion()}};this.Ve.send(n)}}In(e){if(this.Sr()){const t=e.reference().source(),s=t instanceof ni?t.id():null,i={unshareReference:{resourceId:this.cn,valueId:Q(s),key:e.reference().key()}};this.Ve.send(i)}}_n(e){if(this.Sr()){const t=e.reference().source(),s=t instanceof ni?t.id():null;let i={type:e.reference().type(),valueId:s,values:e.reference().values()};if(void 0!==s&&(i=this.ln.processOutgoingSetReference(i)),i){const t={setReference:{resourceId:this.cn,key:e.reference().key(),valueId:Q(i.valueId),references:gn(e.reference().type(),i.values),version:this.ln.contextVersion()}};this.Ve.send(t)}}}xn(e){if(this.Sr()){const t=e.reference().source(),s=t instanceof ni?t.id():null,i={clearReference:{resourceId:this.cn,key:e.reference().key(),valueId:Q(s)}};this.Ve.send(i)}}Sr(){return this.Ve.isConnected()&&!this.yn&&(null===this.wn||this.wn.upToDate)}vr(e,t){this.F.error(e,t);const s=new In(this.Ve.session().domain(),e,t);this.ve(s),this.pn.Cr(s)}}Dn.Events=xn,Object.freeze(Dn.Events);class Tn extends R{constructor(e,t){super(),this.ge(e.events()),this.Ir=e,this._r=!1,this.qs=t}type(){return this.Ir.type()}key(){return this.Ir.key()}source(){return this.Ir.source()}isLocal(){return!0}user(){return this.Ir.user()}sessionId(){return this.Ir.sessionId()}isDisposed(){return this.Ir.isDisposed()}value(){return this.Ir.value()}values(){return this.Ir.values()}reference(){return this.Ir}share(){this.xr(),this.isShared()||(this.qs.onShare(this),this._r=!0)}unshare(){this.xr(),this.isShared()&&(this.qs.onUnShare(this),this._r=!1)}isShared(){return this._r}set(e){this.xr(),e instanceof Array?this.Ir.ps(e,!1):this.Ir.ps([e],!1),this.isShared()&&this.qs.onSet(this)}clear(){this.xr(),this.Ir.ms(),this.qs.onClear(this)}isSet(){return this.Ir.isSet()}dispose(){this.xr(),this.ds()}xr(){if(this.type()!==Bs.Types.ELEMENT&&this.reference().source().isDetached())throw new Error("The source model is detached")}ds(){const e=this.source();(e instanceof ni&&e.isAttached()||e instanceof Dn&&e.isOpen())&&this.unshare(),this.Ir.ds(),this.qs=null}}Tn.Events=Bs.Events;class jn extends Tn{constructor(e,t){super(e,t)}}class An extends Tn{constructor(e,t){super(e,t)}}class Pn extends Tn{constructor(e,t){super(e,t)}}class Nn extends Tn{constructor(e,t){super(e,t)}}const qn=(e,t)=>{const s=Hs.handleSplice(t.values,e.index,e.deleteCount,e.insertValue.length);return n.copy(t,{values:s})},Un=(e,t)=>null,kn=(e,t)=>{const s=zs.handleSplice(t.values,e.index,e.deleteCount,e.insertValue.length);return n.copy(t,{values:s})},Vn=(e,t)=>null,Ln=(e,t)=>e.value.getTime()===t.value.getTime()?new we(e.copy({noOp:!0}),e.copy({noOp:!0})):new we(e,t.copy({noOp:!0}));var Fn;function $n(e){return 0===e.deleteCount&&e.insertValue.length>0?Fn.Insert:e.deleteCount>0&&0===e.insertValue.length?Fn.Remove:e.deleteCount>0&&e.insertValue.length>0?Fn.Splice:Fn.NoOp}!function(e){e[e.Insert=0]="Insert",e[e.Remove=1]="Remove",e[e.Splice=2]="Splice",e[e.NoOp=3]="NoOp"}(Fn||(Fn={}));const Gn=(e,t)=>{const s=$n(e),i=$n(t);return s===Fn.NoOp||i===Fn.NoOp?new we(e,t):s===Fn.Insert&&i===Fn.Insert?function(e,t){return e.index<=t.index?new we(e,t.copy({index:t.index+e.insertValue.length})):new we(e.copy({index:e.index+t.insertValue.length}),t)}(e,t):s===Fn.Insert&&i===Fn.Remove?function(e,t){return e.index<=t.index?new we(e,t.copy({index:t.index+e.insertValue.length})):e.index>=t.index+t.deleteCount?new we(e.copy({index:e.index-t.deleteCount}),t):new we(e.copy({noOp:!0}),t.copy({deleteCount:t.deleteCount+e.insertValue.length}))}(e,t):s===Fn.Insert&&i===Fn.Splice?function(e,t){return e.index<=t.index?new we(e,t.copy({index:t.index+e.insertValue.length})):t.index+t.deleteCount>e.index?new we(e.copy({noOp:!0}),t.copy({deleteCount:t.deleteCount+e.insertValue.length})):new we(e.copy({index:e.index-t.deleteCount+t.insertValue.length}),t)}(e,t):s===Fn.Remove&&i===Fn.Insert?function(e,t){return t.index<=e.index?new we(e.copy({index:e.index+t.insertValue.length}),t):t.index>=e.index+e.deleteCount?new we(e,t.copy({index:t.index-e.deleteCount})):new we(e.copy({deleteCount:e.deleteCount+t.insertValue.length}),t.copy({noOp:!0}))}(e,t):s===Fn.Remove&&i===Fn.Remove?function(e,t){const s=t.index,i=t.index+t.deleteCount,n=e.index,r=e.index+e.deleteCount;switch(Ee.getRangeRangeRelationship(n,r,s,i)){case Ce.Precedes:return new we(e,t.copy({index:t.index-e.deleteCount}));case Ce.PrecededBy:return new we(e.copy({index:e.index-t.deleteCount}),t);case Ce.Meets:case Ce.Overlaps:{const s=e.index+e.deleteCount-t.index;return new we(e.copy({deleteCount:e.deleteCount-s}),t.copy({index:e.index,deleteCount:t.deleteCount-s}))}case Ce.MetBy:case Ce.OverlappedBy:{const s=t.index+t.deleteCount-e.index;return new we(e.copy({index:t.index,deleteCount:e.deleteCount-s}),t.copy({deleteCount:t.deleteCount-s}))}case Ce.Starts:case Ce.ContainedBy:case Ce.Finishes:return new we(e.copy({noOp:!0}),t.copy({deleteCount:t.deleteCount-e.deleteCount}));case Ce.StartedBy:case Ce.Contains:case Ce.FinishedBy:return new we(e.copy({deleteCount:e.deleteCount-t.deleteCount}),t.copy({noOp:!0}));case Ce.EqualTo:return new we(e.copy({noOp:!0}),t.copy({noOp:!0}))}}(e,t):s===Fn.Remove&&i===Fn.Splice?function(e,t){const s=t.index,i=t.index+t.deleteCount,n=e.index,r=e.index+e.deleteCount;switch(Ee.getRangeRangeRelationship(n,r,s,i)){case Ce.Precedes:return new we(e,t.copy({index:t.index-e.deleteCount}));case Ce.PrecededBy:return new we(e.copy({index:e.index-t.deleteCount+t.insertValue.length}),t);case Ce.Meets:case Ce.Overlaps:{const s=e.index+e.deleteCount-t.index;return new we(e.copy({deleteCount:e.deleteCount-s}),t.copy({index:e.index,deleteCount:t.deleteCount-s}))}case Ce.MetBy:case Ce.OverlappedBy:{const s=t.index+t.deleteCount-e.index;return new we(e.copy({index:t.index+t.insertValue.length,deleteCount:e.deleteCount-s}),t.copy({deleteCount:t.deleteCount-s}))}case Ce.Starts:case Ce.Finishes:case Ce.ContainedBy:return new we(e.copy({noOp:!0}),t.copy({deleteCount:t.deleteCount-e.deleteCount}));case Ce.StartedBy:return new we(e.copy({index:e.index+t.insertValue.length,deleteCount:e.deleteCount-t.deleteCount}),t.copy({index:e.index,deleteCount:0}));case Ce.FinishedBy:return new we(e.copy({deleteCount:e.deleteCount-t.deleteCount}),t.copy({index:e.index,deleteCount:0}));case Ce.Contains:return new we(e.copy({deleteCount:e.deleteCount-t.deleteCount+t.insertValue.length}),t.copy({noOp:!0}));case Ce.EqualTo:return new we(e.copy({noOp:!0}),t.copy({deleteCount:0}))}}(e,t):s===Fn.Splice&&i===Fn.Insert?function(e,t){return t.index<=e.index?new we(e.copy({index:e.index+t.insertValue.length}),t):e.index+e.deleteCount>t.index?new we(e.copy({deleteCount:e.deleteCount+t.insertValue.length}),t.copy({noOp:!0})):new we(e,t.copy({index:t.index-e.deleteCount+e.insertValue.length}))}(e,t):s===Fn.Splice&&i===Fn.Remove?function(e,t){const s=t.index,i=t.index+t.deleteCount,n=e.index,r=e.index+e.deleteCount;switch(Ee.getRangeRangeRelationship(n,r,s,i)){case Ce.Precedes:return new we(e,t.copy({index:t.index-e.deleteCount+e.insertValue.length}));case Ce.PrecededBy:return new we(e.copy({index:e.index-t.deleteCount}),t);case Ce.Meets:case Ce.Overlaps:{const s=e.index+e.deleteCount-t.index;return new we(e.copy({deleteCount:e.deleteCount-s}),t.copy({index:e.index+e.insertValue.length,deleteCount:t.deleteCount-s}))}case Ce.MetBy:case Ce.OverlappedBy:{const s=t.index+t.deleteCount-e.index;return new we(e.copy({index:t.index,deleteCount:e.deleteCount-s}),t.copy({deleteCount:t.deleteCount-s}))}case Ce.Starts:return new we(e.copy({deleteCount:0}),t.copy({index:t.index+e.insertValue.length,deleteCount:t.deleteCount-e.deleteCount}));case Ce.Finishes:return new we(e.copy({index:t.index,deleteCount:0}),t.copy({deleteCount:t.deleteCount-e.deleteCount}));case Ce.ContainedBy:return new we(e.copy({noOp:!0}),t.copy({deleteCount:t.deleteCount-e.deleteCount+e.insertValue.length}));case Ce.StartedBy:case Ce.FinishedBy:case Ce.Contains:return new we(e.copy({deleteCount:e.deleteCount-t.deleteCount}),t.copy({deleteCount:0}));case Ce.EqualTo:return new we(e.copy({deleteCount:0}),t.copy({noOp:!0}))}}(e,t):s===Fn.Splice&&i===Fn.Splice?function(e,t){const s=t.index,i=t.index+t.deleteCount,n=e.index,r=e.index+e.deleteCount;switch(Ee.getRangeRangeRelationship(n,r,s,i)){case Ce.Precedes:return new we(e,t.copy({index:t.index-e.deleteCount+e.insertValue.length}));case Ce.PrecededBy:return new we(e.copy({index:e.index-t.deleteCount+e.insertValue.length}),t);case Ce.Meets:case Ce.Overlaps:{const s=e.index+e.deleteCount-t.index;return new we(e.copy({deleteCount:e.deleteCount-s}),t.copy({index:e.index+e.insertValue.length,deleteCount:t.deleteCount-s}))}case Ce.MetBy:case Ce.OverlappedBy:{const s=t.index+t.deleteCount-e.index;return new we(e.copy({index:t.index+t.insertValue.length,deleteCount:e.deleteCount-s}),t.copy({deleteCount:t.deleteCount-s}))}case Ce.Starts:return new we(e.copy({deleteCount:0}),t.copy({index:t.index+e.insertValue.length,deleteCount:t.deleteCount-e.deleteCount}));case Ce.ContainedBy:return new we(e.copy({noOp:!0}),t.copy({deleteCount:t.deleteCount-e.deleteCount+e.insertValue.length}));case Ce.Finishes:return new we(e.copy({index:t.index+t.insertValue.length,deleteCount:0}),t.copy({deleteCount:t.deleteCount-e.deleteCount}));case Ce.StartedBy:return new we(e.copy({index:e.index+t.insertValue.length,deleteCount:e.deleteCount-t.deleteCount}),t.copy({deleteCount:0}));case Ce.Contains:return new we(e.copy({deleteCount:e.deleteCount-t.deleteCount+t.insertValue.length}),t.copy({noOp:!0}));case Ce.FinishedBy:return new we(e.copy({deleteCount:e.deleteCount-t.deleteCount}),t.copy({deleteCount:0,index:e.index+e.insertValue.length}));case Ce.EqualTo:return new we(e.copy({deleteCount:0}),t.copy({index:t.index+e.insertValue.length,deleteCount:0}))}}(e,t):void 0};class Jn{constructor(){this.Dr={},this.Tr={},this.registerOtf(ve.STRING_SPLICE,ve.STRING_SPLICE,Gn),this.registerOtf(ve.STRING_SPLICE,ve.STRING_VALUE,et),this.registerOtf(ve.STRING_VALUE,ve.STRING_SPLICE,tt),this.registerOtf(ve.STRING_VALUE,ve.STRING_VALUE,st),this.registerOtf(ve.OBJECT_ADD,ve.OBJECT_ADD,ht),this.registerOtf(ve.OBJECT_ADD,ve.OBJECT_SET,ut),this.registerOtf(ve.OBJECT_ADD,ve.OBJECT_REMOVE,dt),this.registerOtf(ve.OBJECT_ADD,ve.OBJECT_VALUE,gt),this.registerOtf(ve.OBJECT_REMOVE,ve.OBJECT_ADD,lt),this.registerOtf(ve.OBJECT_REMOVE,ve.OBJECT_SET,ft),this.registerOtf(ve.OBJECT_REMOVE,ve.OBJECT_REMOVE,mt),this.registerOtf(ve.OBJECT_REMOVE,ve.OBJECT_VALUE,vt),this.registerOtf(ve.OBJECT_SET,ve.OBJECT_ADD,yt),this.registerOtf(ve.OBJECT_SET,ve.OBJECT_SET,wt),this.registerOtf(ve.OBJECT_SET,ve.OBJECT_REMOVE,bt),this.registerOtf(ve.OBJECT_SET,ve.OBJECT_VALUE,Ot),this.registerOtf(ve.OBJECT_VALUE,ve.OBJECT_ADD,Rt),this.registerOtf(ve.OBJECT_VALUE,ve.OBJECT_SET,Mt),this.registerOtf(ve.OBJECT_VALUE,ve.OBJECT_REMOVE,Et),this.registerOtf(ve.OBJECT_VALUE,ve.OBJECT_VALUE,St),this.registerOtf(ve.ARRAY_INSERT,ve.ARRAY_INSERT,Oe),this.registerOtf(ve.ARRAY_INSERT,ve.ARRAY_REMOVE,Re),this.registerOtf(ve.ARRAY_INSERT,ve.ARRAY_SET,Me),this.registerOtf(ve.ARRAY_INSERT,ve.ARRAY_REORDER,xe),this.registerOtf(ve.ARRAY_INSERT,ve.ARRAY_VALUE,De),this.registerOtf(ve.ARRAY_REMOVE,ve.ARRAY_INSERT,Te),this.registerOtf(ve.ARRAY_REMOVE,ve.ARRAY_REMOVE,je),this.registerOtf(ve.ARRAY_REMOVE,ve.ARRAY_SET,Ne),this.registerOtf(ve.ARRAY_REMOVE,ve.ARRAY_REORDER,qe),this.registerOtf(ve.ARRAY_REMOVE,ve.ARRAY_VALUE,Ue),this.registerOtf(ve.ARRAY_SET,ve.ARRAY_INSERT,ke),this.registerOtf(ve.ARRAY_SET,ve.ARRAY_REMOVE,Ve),this.registerOtf(ve.ARRAY_SET,ve.ARRAY_SET,Fe),this.registerOtf(ve.ARRAY_SET,ve.ARRAY_REORDER,$e),this.registerOtf(ve.ARRAY_SET,ve.ARRAY_VALUE,Ge),this.registerOtf(ve.ARRAY_REORDER,ve.ARRAY_INSERT,Je),this.registerOtf(ve.ARRAY_REORDER,ve.ARRAY_REMOVE,Be),this.registerOtf(ve.ARRAY_REORDER,ve.ARRAY_SET,He),this.registerOtf(ve.ARRAY_REORDER,ve.ARRAY_REORDER,We),this.registerOtf(ve.ARRAY_REORDER,ve.ARRAY_VALUE,ze),this.registerOtf(ve.ARRAY_VALUE,ve.ARRAY_INSERT,Ye),this.registerOtf(ve.ARRAY_VALUE,ve.ARRAY_REMOVE,Qe),this.registerOtf(ve.ARRAY_VALUE,ve.ARRAY_SET,Ke),this.registerOtf(ve.ARRAY_VALUE,ve.ARRAY_REORDER,Xe),this.registerOtf(ve.ARRAY_VALUE,ve.ARRAY_VALUE,Ze),this.registerOtf(ve.NUMBER_DELTA,ve.NUMBER_DELTA,it),this.registerOtf(ve.NUMBER_DELTA,ve.NUMBER_VALUE,nt),this.registerOtf(ve.NUMBER_VALUE,ve.NUMBER_DELTA,rt),this.registerOtf(ve.NUMBER_VALUE,ve.NUMBER_VALUE,ot),this.registerOtf(ve.BOOLEAN_VALUE,ve.BOOLEAN_VALUE,at),this.registerOtf(ve.DATE_VALUE,ve.DATE_VALUE,Ln),this.registerRtf(Bs.Types.INDEX,ve.STRING_SPLICE,qn),this.registerRtf(Bs.Types.INDEX,ve.STRING_VALUE,Un),this.registerRtf(Bs.Types.RANGE,ve.STRING_SPLICE,kn),this.registerRtf(Bs.Types.RANGE,ve.STRING_VALUE,Vn)}registerOtf(e,t,s){const i=e+t;if(this.Dr[i])throw new Error("Function already registered for "+e+", "+t);this.Dr[i]=s}registerRtf(e,t,s){const i=t+e;if(this.Tr[i])throw new Error("Function already registered for "+t+", "+e);this.Tr[i]=s}getOperationTransformationFunction(e,t){const s=e.type+t.type;return this.Dr[s]}getReferenceTransformationFunction(e,t){const s=e.type+t.type;return this.Tr[s]}}class Bn{constructor(e){this.ts=e}transform(e,t){return e instanceof ye?this.transformCompoundOperation(e,t):this.transformDiscreteOperation(e,t)}transformCompoundOperation(e,t){let s=t;for(let t=0;t<e.ops.length&&s;t++)s=this.transform(e.ops[t],s);return s}transformDiscreteOperation(e,t){return e.noOp?t:e.id===t.valueId?this.transformWithIdenticalPathOperation(e,t):t}transformWithIdenticalPathOperation(e,t){const s=this.ts.getReferenceTransformationFunction(e,t);if(s)return s(e,t);throw new Error(`No function found for: (${e.type},${t.type})`)}}class Hn extends R{constructor(e,t,s){super(),this.Ns=e,this.Us=t,this.ks=s,this.Ns.events().subscribe(e=>{const t=Ls.convertEvent(e,this.Us);this.ve(t)})}id(){return this.Ns.id()}type(){return this.Ns.type()}path(){return this.Ns.path()}relativePath(){const e=this.Ns.path().slice(0);return e.length>0?e.pop():null}parent(){const e=this.Ns.path().slice(0);e.pop();return this.ks.elementAt(e)}isAttached(){return!this.Ns.isDetached()}isDetached(){return this.Ns.isDetached()}value(){return this.Ns.data()}toJSON(){return this.Ns.toJson()}model(){return this.ks}}Hn.Events=ii;class Wn extends Hn{constructor(e,t,s){super(e,t,s)}get(e){return this.Us.wrap(this.Ns.get(e))}length(){return this.Ns.length()}forEach(e){this.Ns.forEach((t,s)=>{e(this.Us.wrap(t),s)})}elementAt(...e){return this.Us.wrap(this.Ns.valueAt(...e))}}Wn.Events=ui;class zn extends Hn{constructor(e,t,s){super(e,t,s)}}zn.Events=ii;class Yn extends Hn{constructor(e,t,s){super(e,t,s)}get(e){return this.Us.wrap(this.Ns.get(e))}keys(){return this.Ns.keys()}hasKey(e){return this.Ns.hasKey(e)}forEach(e){this.Ns.forEach((t,s)=>{e(this.Us.wrap(t),s)})}elementAt(...e){return this.Us.wrap(this.Ns.valueAt(...e))}}Yn.Events=Pi;class Qn extends Hn{constructor(e,t,s){super(e,t,s)}}Qn.Events=ii;class Kn extends Hn{constructor(e,t,s){super(e,t,s)}}Kn.Events=Vi;class Xn extends Hn{constructor(e,t,s){super(e,t,s)}length(){return this.Ns.length()}}Xn.Events=$i;class Zn extends Hn{constructor(e,t,s){super(e,t,s)}}Zn.Events=ii;class er extends Hn{constructor(e,t,s){super(e,t,s)}}er.Events=ii;class tr extends Ti{constructor(e){super(),this.ks=e}Xi(e){switch(e.type()){case mi.ARRAY:return new Wn(e,this,this.ks);case mi.OBJECT:return new Yn(e,this,this.ks);case mi.BOOLEAN:return new zn(e,this,this.ks);case mi.NULL:return new Qn(e,this,this.ks);case mi.NUMBER:return new Kn(e,this,this.ks);case mi.STRING:return new Xn(e,this,this.ks);case mi.UNDEFINED:return new Zn(e,this,this.ks);case mi.DATE:return new er(e,this,this.ks);default:return null}}}class sr{constructor(e,t,s,i,n,r){this.modelId=e,this.version=t,this.timestamp=s,this.user=i,this.sessionId=n,this.operation=r,Object.freeze(this)}}class ir{constructor(e){this.type=e}}class nr extends ir{constructor(e){super(ve.COMPOUND),this.ops=e,Object.freeze(this)}inverse(){return new nr(this.ops.map(e=>e.inverse()))}}class rr extends ir{constructor(e,t,s){super(e),this.id=t,this.noOp=s}}class or extends rr{constructor(e,t,s,i){super(ve.ARRAY_REMOVE,e,t),this.index=s,this.oldValue=i,Object.freeze(this)}inverse(){return new ar(this.id,this.noOp,this.index,this.oldValue)}}class ar extends rr{constructor(e,t,s,i){super(ve.ARRAY_INSERT,e,t),this.index=s,this.value=i,Object.freeze(this)}inverse(){return new or(this.id,this.noOp,this.index,this.value)}}class cr extends rr{constructor(e,t,s,i){super(ve.ARRAY_REORDER,e,t),this.fromIndex=s,this.toIndex=i,Object.freeze(this)}inverse(){return new cr(this.id,this.noOp,this.toIndex,this.fromIndex)}}class hr extends rr{constructor(e,t,s,i,n){super(ve.ARRAY_SET,e,t),this.index=s,this.value=i,this.oldValue=n,Object.freeze(this)}inverse(){return new hr(this.id,this.noOp,this.index,this.oldValue,this.value)}}class ur extends rr{constructor(e,t,s,i){super(ve.ARRAY_VALUE,e,t),this.value=s,this.oldValue=i,Object.freeze(this)}inverse(){return new ur(this.id,this.noOp,this.oldValue,this.value)}}class dr extends rr{constructor(e,t,s,i){super(ve.OBJECT_REMOVE,e,t),this.prop=s,this.oldValue=i,Object.freeze(this)}inverse(){return new lr(this.id,this.noOp,this.prop,this.oldValue)}}class lr extends rr{constructor(e,t,s,i){super(ve.OBJECT_ADD,e,t),this.prop=s,this.value=i,Object.freeze(this)}inverse(){return new dr(this.id,this.noOp,this.prop,this.value)}}class pr extends rr{constructor(e,t,s,i,n){super(ve.OBJECT_SET,e,t),this.prop=s,this.value=i,this.oldValue=n,Object.freeze(this)}inverse(){return new pr(this.id,this.noOp,this.prop,this.oldValue,this.value)}}class fr extends rr{constructor(e,t,s,i){super(ve.OBJECT_VALUE,e,t),this.value=s,this.oldValue=i,Object.freeze(this)}inverse(){return new fr(this.id,this.noOp,this.oldValue,this.value)}}class mr extends rr{constructor(e,t,s,i,n,r){super(ve.STRING_SPLICE,e,t),this.index=s,this.deletedValue=i,this.deleteCount=n,this.insertValue=r,Object.freeze(this)}inverse(){return new mr(this.id,this.noOp,this.index,this.insertValue,this.insertValue.length,this.deletedValue)}}class gr extends rr{constructor(e,t,s,i){super(ve.STRING_VALUE,e,t),this.value=s,this.oldValue=i,Object.freeze(this)}inverse(){return new gr(this.id,this.noOp,this.oldValue,this.value)}}class vr extends rr{constructor(e,t,s){super(ve.NUMBER_DELTA,e,t),this.delta=s,Object.freeze(this)}inverse(){return new vr(this.id,this.noOp,-this.delta)}}class yr extends rr{constructor(e,t,s,i){super(ve.NUMBER_VALUE,e,t),this.value=s,this.oldValue=i,Object.freeze(this)}inverse(){return new yr(this.id,this.noOp,this.oldValue,this.value)}}class wr extends rr{constructor(e,t,s,i){super(ve.BOOLEAN_VALUE,e,t),this.value=s,this.oldValue=i,Object.freeze(this)}inverse(){return new wr(this.id,this.noOp,this.oldValue,this.value)}}class br extends rr{constructor(e,t,s,i){super(ve.DATE_VALUE,e,t),this.value=s,this.oldValue=i,Object.freeze(this)}inverse(){return new br(this.id,this.noOp,this.oldValue,this.value)}}function Or(e,t){let s;if(e.operation.compoundOperation)s=function(e){const t=z(e.operations).map(Rr);return new nr(t)}(e.operation.compoundOperation);else{if(!e.operation.discreteOperation)throw new O("Invalid model operation: "+JSON.stringify(e));s=Rr(e.operation.discreteOperation)}return new sr(e.modelId,B(e.version),X(e.timestamp),t.getUserForSession(e.sessionId),e.sessionId,s)}function Rr(e){if(e.arrayInsertOperation){const{id:t,noOp:s,index:i,value:n}=e.arrayInsertOperation;return new ar(t,H(s),B(i),tn(n))}if(e.arrayRemoveOperation){const{id:t,noOp:s,index:i,oldValue:n}=e.arrayRemoveOperation,r=s?void 0:tn(n);return new or(t,H(s),B(i),r)}if(e.arrayMoveOperation){const{id:t,noOp:s,fromIndex:i,toIndex:n}=e.arrayMoveOperation;return new cr(t,H(s),B(i),B(n))}if(e.arrayReplaceOperation){const{id:t,noOp:s,index:i,value:n,oldValue:r}=e.arrayReplaceOperation,o=s?void 0:tn(r);return new hr(t,H(s),B(i),tn(n),o)}if(e.arraySetOperation){const{id:t,noOp:s,values:i,oldValues:n}=e.arraySetOperation,r=s?void 0:z(n).map(tn);return new ur(t,H(s),z(i).map(tn),r)}if(e.objectAddPropertyOperation){const{id:t,noOp:s,key:i,value:n}=e.objectAddPropertyOperation;return new lr(t,H(s),W(i),tn(n))}if(e.objectSetPropertyOperation){const{id:t,noOp:s,key:i,value:n,oldValue:r}=e.objectSetPropertyOperation,o=s?void 0:tn(r);return new pr(t,H(s),W(i),tn(n),o)}if(e.objectRemovePropertyOperation){const{id:t,noOp:s,key:i,oldValue:n}=e.objectSetPropertyOperation,r=s?void 0:tn(n);return new dr(t,H(s),W(i),r)}if(e.objectSetOperation){const{id:t,noOp:s,values:i,oldValues:n}=e.objectSetOperation,r=s?void 0:h(Y(n),tn);return new fr(t,H(s),h(Y(i),tn),r)}if(e.stringSpliceOperation){const{id:t,noOp:s,index:i,deletedValue:n,insertedValue:r}=e.stringSpliceOperation;return new mr(t,H(s),B(i),W(n),W(n).length,W(r))}if(e.stringSetOperation){const{id:t,noOp:s,value:i,oldValue:n}=e.stringSetOperation,r=s?void 0:W(n);return new gr(t,H(s),W(i),r)}if(e.numberDeltaOperation){const{id:t,noOp:s,delta:i}=e.numberDeltaOperation;return new vr(t,H(s),B(i))}if(e.numberSetOperation){const{id:t,noOp:s,value:i,oldValue:n}=e.numberSetOperation,r=s?void 0:B(n);return new yr(t,H(s),B(i),r)}if(e.booleanSetOperation){const{id:t,noOp:s,value:i,oldValue:n}=e.booleanSetOperation,r=s?void 0:H(n);return new wr(t,H(s),H(i),r)}if(e.dateSetOperation){const{id:t,noOp:s,value:i,oldValue:n}=e.dateSetOperation,r=s?void 0:X(n);return new br(t,H(s),X(i),r)}}const Mr=Object.assign(Object.assign({},Xi),{TARGET_VERSION_CHANGED:"target_changed",TRANSITION_START:"transition_start",TRANSITION_END:"transition_end"});Object.freeze(Mr);class Er{constructor(e,t,s,i,n,r,o,a,c){this.Vt=a,this.Ve=o,this.Is=c,this.sn=n,this.dn=r,this.ks=new Ii(this.session(),null,e,"error","error"),this.Us=new tr(this),this.jr=t,this.Ar=t,this.Pr=t,this.Nr=s,this.qr=s,this.hn=i,this.Ur=[]}session(){return this.Vt}collectionId(){return this.dn}modelId(){return this.sn}time(){return this.Nr}minTime(){return this.createdTime()}maxTime(){return this.qr}createdTime(){return this.hn}version(){return this.jr}minVersion(){return 0}maxVersion(){return this.Pr}targetVersion(){return this.Ar}isTransitioning(){return this.Ar===this.jr}root(){return this.Us.wrap(this.ks.root())}elementAt(...e){return this.Us.wrap(this.ks.valueAt(...e))}playTo(e){if(e<0)throw new Error("Version must be >= 0: "+e);if(e>this.Pr)throw new Error("Version must be <= maxVersion: "+e);let t,s,i=null;if(e===this.Ar)return Promise.resolve();e>this.Ar?(t=this.Ar+1,s=e,i=!0):(t=e,s=this.Ar,i=!1),this.Ar=e;const n={historicalOperationsRequest:{modelId:this.sn,first:t,last:s}},r={forward:i,completed:!1,operations:null};return this.Ur.push(r),this.Ve.request(n).then(e=>{const{historicalOperationsResponse:s}=e;r.completed=!0,r.operations=z(s.operations).map(e=>Or(e,this.Is)),r.forward||1===t||(r.precedingOp=r.operations.shift()),this.kr()})}playToTime(e){const t={modelGetVersionAtTimeRequest:{modelId:this.sn,targetTime:Z(e)}};return this.Ve.request(t).then(e=>{const{modelGetVersionAtTimeResponse:t}=e,s=B(t.versionAtTime);return this.playTo(s)})}forward(e=1){if(e<1)throw new Error("delta must be > 0");if(this.Ar+e>this.Pr)throw new Error(`Cannot move forward by ${e}, because that would exceed the model's maxVersion.`);const t=this.Ar+e;return this.playTo(t)}backward(e=1){if(e<1)throw new Error("delta must be > 0");if(this.Ar-e<0)throw new Error(`Cannot move backward by ${e}, because that would move beyond version 0.`);const t=this.Ar-e;return this.playTo(t)}kr(){if(0===this.Ur.length)throw new Error("There are no operation requests to process");for(;this.Ur.length>0&&this.Ur[0].completed;){const e=this.Ur[0];this.Vr(e.operations,e.forward,e.precedingOp),this.Ur.shift()}}Vr(e,t,s){if(t)e.forEach(e=>{if(e.operation.type===ve.COMPOUND){e.operation.ops.forEach(t=>{this.Lr(e,t,!1)})}else this.Lr(e,e.operation,!1)});else{const t=e.reverse();t.forEach((e,i)=>{const n=i===t.length-1?s:t[i+1];if(e.operation.type===ve.COMPOUND){e.operation.ops.reverse().forEach(t=>{this.Lr(e,t,!0,n)})}else this.Lr(e,e.operation,!0,n)})}}Lr(e,t,s,i){if(!t.noOp){const i=s?t.inverse():t;this.ks.handleModelOperationEvent(new Qi(e.sessionId,e.user,e.version,e.timestamp,i))}if(s)if(2===e.version)this.jr=1,this.Nr=this.hn;else{if(void 0===i)throw new Error("no preceding operation was supplied to _playDiscreteOp");this.jr=i.version,this.Nr=i.timestamp}else this.jr=e.version,this.Nr=new Date(e.timestamp)}}Er.Events=Mr;var Sr=function(e,t,s,i){return new(s||(s=Promise))((function(n,r){function o(e){try{c(i.next(e))}catch(e){r(e)}}function a(e){try{c(i.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(o,a)}c((i=i.apply(e,t||[])).next())}))};const Cr={OFFLINE_MODEL_SYNC_STARTED:"offline_model_sync_started",OFFLINE_MODEL_SYNC_COMPLETED:"offline_model_sync_completed",OFFLINE_MODEL_SYNC_ERROR:"offline_model_sync_error",OFFLINE_MODEL_STATUS_CHANGED:"offline_model_status_changed",OFFLINE_MODEL_UPDATED:"offline_model_updated",OFFLINE_MODEL_DELETED:"offline_model_deleted",OFFLINE_MODEL_PERMISSIONS_REVOKED:"offline_model_permissions_revoked",OFFLINE_MODELS_DOWNLOAD_PENDING:"offline_models_download_pending",OFFLINE_MODELS_DOWNLOAD_PROGRESS:"offline_models_download_progress",OFFLINE_MODELS_DOWNLOAD_COMPLETED:"offline_models_download_completed",OFFLINE_MODELS_SYNC_STARTED:"offline_models_sync_started",OFFLINE_MODELS_SYNC_PROGRESS:"offline_models_sync_progress",OFFLINE_MODELS_SYNC_COMPLETED:"offline_models_sync_completed",OFFLINE_MODELS_SYNC_ABORTED:"offline_models_sync_aborted"};Object.freeze(Cr);class Ir extends R{constructor(e,t,s,i,n){super(),this.Fr=new Map,this.$r=new Map,this.Gr=new Map,this.Jr=new Map,this.sr=()=>{this.$r.forEach(e=>{e.sr(),this.Jr.has(e.modelId())&&this.Jr.delete(e.modelId())}),this.Jr.forEach(e=>{e.resyncModel&&(e.resyncModel.sr(),e.resyncModel.Nn(!1))}),this.Jr.clear(),this.Br.length=0,null!==this.Hr&&(this.Hr.resolve(),this.Hr=null),null!==this.Wr&&(this.ve(new ps("Convergence went offline during the sync","offline")),this.Wr.resolve(),this.Wr=null),this.zr.setOffline(),this.Gr.clear(),this.Yr()},this.ir=()=>{this.$r.forEach(e=>{this.Qr(e)}),0!==this.Jr.size&&(this.Wr=new I),this.zr.isOfflineEnabled()&&(this.Hr=new wn,this.zr.ready().then(()=>this.Kr()).catch(e=>this.F.error("Error resynchronizing models after reconnect",e)))},this.Ve=e,this.Is=t,this.Ve.messages().subscribe(e=>this.Bn(e)),this.Xr=0,this.Zr=new Map,this.Ve.on(fe.Events.INTERRUPTED,this.sr),this.Ve.on(fe.Events.DISCONNECTED,this.sr),this.Ve.on(fe.Events.CONNECTED,this.ir),this.Br=[],this.Wr=null,this.Hr=null,this.zr=s,this.ge(s.events()),this.Ys=n,this.zs=i,this.eo=new de(32,de.AlphaNumeric),this.F=v.logger("models")}session(){return this.Ve.session()}isResyncing(){return null!==this.Wr}query(e){l.assertNonEmptyString(e,"query");const t={modelsQueryRequest:{query:e}};return this.Ve.request(t).then(e=>{const{modelsQueryResponse:t}=e,s=z(t.models).map(an),i=B(t.offset),n=B(t.totalResults);return new S(s,i,n)})}isOpen(e){return l.assertNonEmptyString(e,"id"),this.$r.has(e)}isOpening(e){return l.assertNonEmptyString(e,"id"),this.Fr.has(e)}open(e){return l.assertNonEmptyString(e,"id"),this.to(e)}openAutoCreate(e){if(l.isNotSet(e))throw new O("'options' is a required parameter");if(""===e.id)throw new O("'options.id' can not be an empty string");return l.nonEmptyString(e.collection)?this.to(void 0,e):Promise.reject(new Error("options.collection must be a non-null, non empty string."))}create(e){if(l.isNotSet(e))throw new O("'options' is a required parameter");return l.nonEmptyString(e.collection)?this.so(e):Promise.reject(new Error("options.collection must be a non-null, non empty string."))}remove(e){return Sr(this,void 0,void 0,(function*(){if(l.assertNonEmptyString(e,"id"),null!==this.Hr&&(yield this.Hr.promise()),this.Jr.has(e)){const t=this.Jr.get(e);if("delete"===t.action)return Promise.reject(new Error("The model has already been deleted locally and resynchronization is in process."));t.inProgress?(this.F.debug(`Removing model "${e}" the is resynchronizing. Waiting for resynchronization to complete before removing`),yield t.done.promise()):t.action="delete"}if(this.$r.get(e)){const t=this.$r.get(e);t.dr(),yield t.whenClosed()}if(this.zr.isOfflineEnabled()&&(yield this.zr.getModelMetaData(e).then(t=>{if(t)return this.zr.markModelForDeletion(e)}).catch(e=>{this.F.error("Could not mark model for deletion",e)})),!this.Ve.isConnected()&&!this.zr.isOfflineEnabled())throw new O("Can not delete a model while not connected and without offline support enabled.");if(this.Ve.isConnected())return this.io(e)}))}history(e){l.assertNonEmptyString(e,"id");const t={historicalDataRequest:{modelId:e}};return this.Ve.request(t).then(t=>{const{historicalDataResponse:s}=t;return new Er(rn(s.data),B(s.version),X(s.modifiedTime),X(s.createdTime),e,s.collectionId,this.Ve,this.session(),this.Is)})}permissions(e){return l.assertNonEmptyString(e,"id"),new hn(e,this.Ve)}subscribeOffline(e){const t=o.isArray(e)?e:[e];return this.zr.subscribe(t)}unsubscribeOffline(e){const t=o.isArray(e)?e:[e];return this.zr.unsubscribe(t)}setOfflineSubscription(e){return this.zr.setSubscriptions(e)}getOfflineSubscriptions(){return Sr(this,void 0,void 0,(function*(){yield this.zr.ready();const e=yield this.zr.getSubscribedModelIds();return Array.from(e)}))}getOfflineModelMetaData(){return Sr(this,void 0,void 0,(function*(){return yield this.zr.ready(),this.zr.getAllModelMetaData()}))}ur(e,t){return Sr(this,void 0,void 0,(function*(){const s=e.collection;if(this.Ve.isConnected()){const i=cn(e.userPermissions&&J.of(e.userPermissions)),n=t||this.no(e),r={createRealTimeModelRequest:{collectionId:s,modelId:Q(e.id),data:nn(n),overrideWorldPermissions:e.overrideCollectionWorldPermissions,worldPermissions:e.worldPermissions,userPermissions:i}};return this.Ve.request(r).then(e=>{const{createRealTimeModelResponse:t}=e;return t.modelId})}if(this.zr.isOfflineEnabled()){const s=e.id||this.eo.nextString(),i=t||this.no(e),n=e.userPermissions&&J.of(e.userPermissions).toGuidObjectMap(),r={modelId:s,collection:e.collection,initialData:i,createdTime:new Date,valueIdPrefix:"@",overrideCollectionWorldPermissions:e.overrideCollectionWorldPermissions,worldPermissions:e.worldPermissions,userPermissions:n};if(yield this.zr.createOfflineModel(r),this.Ve.isConnected()){const e=this.Jr.size>0||this.Br.length>0;this.ro(s,"resync"),e||this.Yr()}return s}throw new O("Can not create a model while not connected and without offline support enabled.")}))}Vn(e){const t=e.modelId();this.F.debug("Model closed: "+e.modelId()),this.$r.has(t)&&this.$r.delete(t);const s=e.Un();null!==s&&this.Gr.delete(s)}lr(e,t){this.oo(e,t)}Er(e){this.ve(new ms(e)),this.F.debug(`Resync completed for model: "${e}"`);this.Jr.get(e).done.resolve(),this.Jr.delete(e),this.Yr()}hr(e,t,s){this.F.debug(`Resync error for model: "${e}"... ${t}`);const i=new gs(e,t,s);this.ve(i);this.Jr.get(e).ready.reject(new Error(t)),this.Er(e)}Cr(e){this.ve(e),this.Ve.session().domain().Cr(e)}ds(){this.$r.forEach(e=>e.close().catch(e=>this.F.error(e)))}oo(e,t){this.F.debug(`Registering resource id: {modelId: "${e}", resourceId: ${t}}`),this.Gr.set(t,e)}to(e,t){return Sr(this,void 0,void 0,(function*(){if(void 0===e&&void 0===t)throw new Error("Internal error, id or options must be defined.");if(null!==this.Hr&&(yield this.Hr.promise()),o.isNotSet(e)&&(e=t.id),e&&this.$r.has(e)){const s=this.$r.get(e);return s.isClosing()?s.whenClosed().then(()=>this.Tn(e,t)):(this.F.debug(`Opening model '${e}' that is already open`),Promise.resolve(s))}if(e&&this.Fr.has(e))return this.F.debug(`Opening model '${e}' that is already opening`),this.Fr.get(e).promise();const s=this.Jr.get(e);return s&&s.resyncModel?(this.F.debug(`Opening model '${e}' that is resyncing`),s.resyncModel.isClosing()?s.resyncModel.whenClosed().then(()=>this.Tn(e,t)):(s.resyncModel.Ln(),Promise.resolve(s.resyncModel))):this.Tn(e,t)}))}Tn(e,t){const s=t?this.Xr++:void 0;void 0!==t&&this.Zr.set(s,t);const i=new I;let n;void 0!==e&&this.Fr.set(e,i),n=this.Ve.isConnected()?this.ao(e,s):this.zr.isOfflineEnabled()?this.co(e,s):Promise.reject(new O("Can not open a model while not online and without offline enabled."));const r=n.then(t=>(this.ho(e,s),this.$r.set(t.modelId(),t),t.tr()&&this.Ve.isConnected()&&this.Qr(t),t)).catch(t=>(this.ho(e,s),Promise.reject(t)));return i.resolveFromPromise(r),i.promise()}Qr(e){this.ro(e.modelId(),"resync",e),e.ir()}ro(e,t,s){const i={modelId:e,action:t,inProgress:void 0!==s,done:new wn,ready:void 0!==s?wn.resolved():new wn,resyncModel:s||null};this.Jr.set(e,i),i.inProgress||this.Br.push(i)}ho(e,t){void 0!==e&&this.Fr.delete(e),void 0!==t&&this.Zr.delete(t)}ao(e,t){return o.isString(e)&&this.zr.isOfflineEnabled()?(this.F.debug(`Opening model '${e}' while online`),this.uo(e,t)):this.do(e,t)}uo(e,t){return Sr(this,void 0,void 0,(function*(){const s=this.Br.findIndex(t=>t.modelId===e);if(s>=0){const[e]=this.Br.splice(s,1);yield this.po(e.modelId)}if(!this.Jr.has(e))return this.do(e,t);{const s=this.Jr.get(e);if(yield s.ready.promise(),"resync"===s.action)return s.resyncModel;this.do(e,t)}}))}do(e,t){const s={openRealTimeModelRequest:{modelId:Q(e),autoCreateId:Q(t)}};return this.Ve.request(s).then(e=>{const{openRealTimeModelResponse:t}=e,s=rn(t.data),i=this.fo(B(t.resourceId),W(t.modelId),W(t.collection),!1,!1,B(t.version),0,X(t.createdTime),X(t.modifiedTime),W(t.valueIdPrefix),z(t.connectedClients),z(t.resyncingClients),z(t.references),on(t.permissions),s);return this.oo(i.modelId(),B(t.resourceId)),this.zr.isOfflineEnabled()?this.zr.storeOpenModelOffline(i).then(()=>(this.zr.modelOpened(i,0),i)):i})}co(e,t){return Sr(this,void 0,void 0,(function*(){o.isUndefined(e)&&(e=this.eo.nextString()),this.F.debug(`Opening model '${e}' while offline`);const s=yield this.zr.getOfflineModelState(e);if(o.isSet(s)){const t=yield this.zr.claimValueIdPrefix(e),i=this.mo(s,t,!1);return Promise.resolve(i)}if(this.Zr.has(t)){const s=this.Zr.get(t),i=this.vo(e,s),n=i.$n(),r=s.userPermissions&&J.of(s.userPermissions).toGuidObjectMap(),o={modelId:e,collection:s.collection,initialData:n.data,createdTime:new Date,valueIdPrefix:"@",overrideCollectionWorldPermissions:s.overrideCollectionWorldPermissions,worldPermissions:s.worldPermissions,userPermissions:r};return this.zr.createOfflineModel(o).then(()=>i)}return Promise.reject(new Error("Model not available offline, and not auto create options were provided"))}))}mo(e,t,s){this.F.debug(`Creating model '${e.modelId}' from offline state`);const i=this.fo(null,e.modelId,e.collection,e.local,s,e.snapshot.version,e.snapshot.sequenceNumber,e.createdTime,e.modifiedTime,`${t.prefix}-${t.increment}`,[],[],[],e.permissions,e.snapshot.data);i.sr(),i.Gn(e.version,e.snapshot.serverOperations,e.snapshot.localOperations);const n=e.version-e.snapshot.version+(e.lastSequenceNumber-e.snapshot.sequenceNumber);return this.zr.modelOpened(i,n),i}io(e){this.F.debug(`Removing model online: "${e}"`);const t={deleteRealtimeModelRequest:{modelId:e}};return this.Ve.request(t).then(()=>this.yo(e)).catch(t=>(t instanceof O&&t.code===A.REQUEST_TIMEOUT||this.yo(e),Promise.reject(t)))}yo(e){return this.zr.isOfflineEnabled()?this.zr.getModelMetaData(e).then(t=>{if(t)return this.zr.modelDeleted(e)}).catch(t=>{this.ve(new In(this.Ve.session().domain(),`There was an error removing the model with id '${e}' from the offline store: ${t.message}`)),this.F.error("Error removing model from offline store.",t)}):Promise.resolve()}vo(e,t){this.F.debug(`Creating new offline model '${e}' using auto-create options.`);const s=this.no(t),i=new Date,n=new Zi(!0,!0,!0,!0),r=this.fo(null,e,t.collection,!0,!1,1,0,i,i,"0",[],[],[],n,s);return r.sr(),this.zr.modelOpened(r,0),r}fo(e,t,s,i,n,r,o,a,c,h,u,d,l,p,f){const m=new be(new Jn),g=new Bn(new Jn),v=new Di(()=>this.Ve.session().sessionId(),r,o,m,g);return new Dn(e,h,f,i,n,u,d,l,p,a,c,t,s,v,this.Ve,this.Is,this,this.zr,this.zs,this.Ys)}Bn(e){const t=e.message,s=function(e){const t=function(e){return e.forceCloseRealTimeModel||e.remoteOperation||e.referenceShared||e.referenceSet||e.referenceCleared||e.referenceUnshared||e.operationAck||e.remoteClientOpenedModel||e.remoteClientClosedModel||e.modelPermissionsChanged||e.remoteClientResyncStarted||e.remoteClientResyncCompleted||e.modelResyncServerComplete||null}(e);return null!==t?B(t.resourceId):null}(t);if(null!==s){const i=this.wo(s);i?i.Bn(e):this.F.warn("Received a message for a model that is not open or resynchronizing: "+JSON.stringify(t))}else t.modelAutoCreateConfigRequest&&this.bo(t.modelAutoCreateConfigRequest,e.callback)}wo(e){const t=this.Gr.get(e);if(void 0===t)return null;const s=this.$r.get(t);if(void 0!==s)return s;const i=this.Jr.get(t);return void 0!==i?i.resyncModel?i.resyncModel:(this.F.warn("Received a message for model that is resyncing but not ready: "+t),null):null}bo(e,t){const s=e.autoCreateId||0;if(this.Zr.has(s)){const e=this.Zr.get(s);this.Zr.delete(s);const i=this.no(e),n=cn(e.userPermissions&&J.of(e.userPermissions)),r={modelAutoCreateConfigResponse:{data:nn(i),ephemeral:e.ephemeral,collection:e.collection,overridePermissions:e.overrideCollectionWorldPermissions,worldPermissions:e.worldPermissions,userPermissions:n}};t.reply(r)}else{const e="Received a request for an auto create id that was not expected: "+s;this.F.error(e),t.expectedError("unknown_model",e)}}no(e){let t=e.data;o.isFunction(t)?t=t():o.isNotSet(t)&&(t={}),t=Object.assign({},t);const s=new _r;return new fi(()=>s.id(),this.zs,this.Ys).createDataValue(t)}Kr(){return Sr(this,void 0,void 0,(function*(){this.Ve.isConnected()&&(yield this.Oo()),this.Ve.isConnected()&&(yield this.zr.setOnline())}))}Oo(){return Sr(this,void 0,void 0,(function*(){null===this.Wr&&(this.Wr=new I);const e=yield this.zr.getModelsRequiringSync();this.ve(new us(e.length)),e.forEach(e=>{this.$r.has(e.modelId)||this.Fr.has(e.modelId)||this.Jr.has(e.modelId)||this.ro(e.modelId,e.available?"resync":"delete")});const t=this.Wr.promise();return null!==this.Hr&&(this.Hr.resolve(),this.Hr=null),this.Yr(),t}))}Yr(){if(!this.Ve.isConnected())return;const e=Array.from(this.Jr.values()).filter(e=>e.inProgress);if(this.F.debug("Checking resync status"),this.F.debug(()=>{const t=e.map(e=>e.modelId);return`In Progress Resync Models (${e.length}): ${JSON.stringify(t)}`}),this.F.debug(()=>{const e=this.Br.map(e=>e.modelId);return`Queued Resync Models (${this.Br.length}): ${JSON.stringify(e)}`}),null===this.Hr&&this.ve(new ds(e.length+this.Br.length)),0===e.length)if(0===this.Br.length)null!==this.Hr?(this.F.debug("Resync queue is empty, but waiting for offline sync to start."),this.Hr.promise().then(()=>this.Yr())):null!==this.Wr&&(this.F.debug("Resync queue is empty, completing resync process"),this.ve(new ls),this.Wr.resolve(),this.Wr=null);else{const e=this.Br.pop();this.po(e.modelId).catch(e=>{this.F.error("Error resyncing models",e)})}}po(e){return Sr(this,void 0,void 0,(function*(){this.F.debug(`Initiating sync for model: "${e}"`);const t=this.Jr.get(e);if(this.ve(new fs(t.modelId)),"resync"!==t.action)return this.Ro(t.modelId).then(()=>t.ready.resolve()).catch(t=>(this.hr(e,t.message),Promise.reject(new Error(t.message))));{const s=yield this.zr.getOfflineModelState(t.modelId);if(!o.isSet(s)){const t=`The state for model "${e}" could not be found to resynchronize the model`;return this.hr(e,t),Promise.reject(new Error(t))}{const e=yield this.zr.claimValueIdPrefix(t.modelId),i=this.Mo(s,e);t.resyncModel=i,t.ready.resolve()}}}))}Ro(e){return this.F.debug(`Deleting resync model from the server: "${e}"`),this.io(e).then(()=>this.Er(e)).catch(t=>t instanceof M&&"model_not_found"===t.code?(this.Er(e),Promise.resolve()):Promise.reject(t))}Mo(e,t){this.F.debug("Creating and resynchronizing model: "+e.modelId);const s=this.mo(e,t,!0);return s.ir(),s}so(e){return Sr(this,void 0,void 0,(function*(){if(this.$r.has(e.id)){const t=`A model with id '${e.id}' is open locally.`;return Promise.reject(new O(t))}if(null!==this.Hr&&(yield this.Hr.promise()),this.Jr.has(e.id)){const t=this.Jr.get(e.id);if("resync"===t.action){const t=`A model with id '${e.id}' is resynchronizing.`;return Promise.reject(new O(t))}yield t.ready}return this.ur(e)}))}}Ir.Events=Cr;class _r{constructor(){this.Eo="@",this.N=0}id(){return this.Eo+":"+this.N++}}class xr{constructor(e,t,s,i,n){this.activity=e,this.user=t,this.sessionId=s,this.local=i,this.So=d(n),Object.freeze(this)}get state(){return d(this.So)}clone(e={}){return new xr(void 0!==e.activity?e.activity:this.activity,void 0!==e.user?e.user:this.user,void 0!==e.sessionId?e.sessionId:this.sessionId,void 0!==e.local?e.local:this.local,void 0!==e.state?e.state:this.state)}}class Dr{constructor(e,t,s,i,n){this.activity=e,this.user=t,this.sessionId=s,this.local=i,this.participant=n,this.name=Dr.EVENT_NAME,Object.freeze(this)}}Dr.EVENT_NAME="session_joined";class Tr{constructor(e,t,s,i){this.activity=e,this.user=t,this.sessionId=s,this.local=i,this.name=Tr.EVENT_NAME,Object.freeze(this)}}Tr.EVENT_NAME="session_left";class jr{constructor(e,t,s,i,n,r,o){this.activity=e,this.user=t,this.sessionId=s,this.local=i,this.key=n,this.value=r,this.oldValue=o,this.name=jr.EVENT_NAME,Object.freeze(this)}}jr.EVENT_NAME="state_set";class Ar{constructor(e,t,s,i,n,r){this.activity=e,this.user=t,this.sessionId=s,this.local=i,this.key=n,this.oldValue=r,this.name=Ar.EVENT_NAME,Object.freeze(this)}}Ar.EVENT_NAME="state_removed";class Pr{constructor(e,t,s,i,n){this.activity=e,this.user=t,this.sessionId=s,this.local=i,this.oldValues=n,this.name=Pr.EVENT_NAME,Object.freeze(this)}}Pr.EVENT_NAME="state_cleared";class Nr{constructor(e,t,s,i,n,r,o,a){this.activity=e,this.user=t,this.sessionId=s,this.local=i,this.values=n,this.complete=r,this.removed=o,this.oldValues=a,this.name=Nr.EVENT_NAME,Object.freeze(this)}}Nr.EVENT_NAME="state_delta";class qr{constructor(e,t,s,i){this.activity=e,this.user=t,this.sessionId=s,this.local=i,this.name=qr.EVENT_NAME,Object.freeze(this)}}qr.EVENT_NAME="left";class Ur{static userPermissions(e){const t=[];return e instanceof J?e.forEach((e,s)=>{t.push(Ur.toUserPermissionEntry(s,e))}):o.isMap(e)?e.forEach((e,s)=>{s=N.of(s),t.push(Ur.toUserPermissionEntry(s,e))}):o.isObject(e)&&u(e,(e,s)=>{const i=N.of(e);t.push(Ur.toUserPermissionEntry(i,s))}),t}static toGroupPermissionsProto(e){const t={};return(o.isMap(e)||o.isObject(e))&&G.coerceToMap(e).forEach((e,s)=>{t[s]=e}),t}static toUserPermissionEntry(e,t){return{user:ie(e),permissions:t}}}class kr{constructor(e){this.Ve=e}resolveSessionPermissions(){this.Ve.session().assertOnline();const e={resolvePermissionsForConnectedSessionRequest:{target:this.Co()}};return this.Ve.request(e).then(e=>{const{resolvePermissionsForConnectedSessionResponse:t}=e;return new Set(z(t.permissions))})}getPermissions(){this.Ve.session().assertOnline();const e={getPermissionsRequest:{target:this.Co()}};return this.Ve.request(e).then(e=>{const{getPermissionsResponse:t}=e,s=new Set(z(t.world)),i=this.Io(z(t.user));return{worldPermissions:s,groupPermissions:G.coerceToMap(h(Y(t.group),e=>new Set(z(e.values)))),userPermissions:i}})}addWorldPermissions(e){this.Ve.session().assertOnline();const t={addPermissionsRequest:{target:this.Co(),world:Array.from(e)}};return this.Ve.request(t).then(()=>{})}removeWorldPermissions(e){this.Ve.session().assertOnline();const t={removePermissionsRequest:{target:this.Co(),world:Array.from(e)}};return this.Ve.request(t).then(()=>{})}setWorldPermissions(e){this.Ve.session().assertOnline();const t={setPermissionsRequest:{target:this.Co(),world:{permissions:Array.from(e)}}};return this.Ve.request(t).then(()=>{})}getWorldPermissions(){return this.Ve.session().assertOnline(),this.getPermissions().then(e=>e.worldPermissions)}addUserPermissions(e){this.Ve.session().assertOnline();const t=J.of(e),s={addPermissionsRequest:{target:this.Co(),user:this._o(t)}};return this.Ve.request(s).then(()=>{})}removeUserPermissions(e){this.Ve.session().assertOnline();const t=J.of(e),s={removePermissionsRequest:{target:this.Co(),user:this._o(t)}};return this.Ve.request(s).then(()=>{})}setUserPermissions(e,t=!1){this.Ve.session().assertOnline();const s=J.of(e),i={setPermissionsRequest:{target:this.Co(),user:{permissions:this._o(s),replaceAll:t}}};return this.Ve.request(i).then(()=>{})}getAllUserPermissions(){return this.Ve.session().assertOnline(),this.getPermissions().then(e=>e.userPermissions)}getUserPermissions(e){return this.Ve.session().assertOnline(),this.getPermissions().then(t=>t.userPermissions.get(N.normal(e))||new Set)}addGroupPermissions(e){this.Ve.session().assertOnline();let t=this.xo(e);const s={addPermissionsRequest:{target:this.Co(),group:t}};return this.Ve.request(s).then(()=>{})}removeGroupPermissions(e){this.Ve.session().assertOnline();let t=this.xo(e);const s={removePermissionsRequest:{target:this.Co(),group:t}};return this.Ve.request(s).then(()=>{})}setGroupPermissions(e,t=!1){this.Ve.session().assertOnline();let s=this.xo(e);const i={setPermissionsRequest:{target:this.Co(),group:{permissions:s,replaceAll:t}}};return this.Ve.request(i).then(()=>{})}getAllGroupPermissions(){return this.Ve.session().assertOnline(),this.getPermissions().then(e=>e.groupPermissions)}getGroupPermissions(e){return this.Ve.session().assertOnline(),this.getPermissions().then(t=>t.groupPermissions.get(e)||new Set)}_o(e){const t=[];return e.forEach((e,s)=>{t.push({user:ie(s),permissions:Array.from(e)})}),t}Io(e){const t=new J;return e.forEach(e=>{const s=se(e.user);let i=new Set(z(e.permissions));t.set(s,i)}),t}xo(e){return h(G.coerceToObject(e),e=>({values:Array.from(e)}))}}class Vr extends kr{constructor(e,t,s){super(s),this.Do={activity:{type:e,id:t}}}type(){return this.Do.activity.type}id(){return this.Do.activity.id}Co(){return this.Do}}class Lr{constructor(e,t,s,i,n){this.activity=e,this.user=t,this.sessionId=s,this.local=i,this.reason=n,this.name=Lr.EVENT_NAME,Object.freeze(this)}}Lr.EVENT_NAME="force_leave";class Fr{constructor(e,t,s,i){this.activity=e,this.user=t,this.sessionId=s,this.local=i,this.name=Fr.EVENT_NAME,Object.freeze(this)}}Fr.EVENT_NAME="deleted";class $r extends R{constructor(e,t,s,i){super(),this.ir=()=>{this.se.debug(()=>`Activity '${this.N}' is online`);const e=this.To?new Map:this.jo.state,t=new I;this.Ao(t,e)},this.sr=()=>{this.se.debug(()=>`Activity '${this.N}' is offline`),this.Po(e=>{var t;for(const[s,i]of e)if(s!==(null===(t=this.jo)||void 0===t?void 0:t.sessionId)){e.delete(s);const t=new Tr(this,i.user,i.sessionId,!1);this.ve(t)}})},this.Is=s,this.as=e,this.N=t,this.No=null,this.qo=new Vr(e,t,i),this.Uo=new w.BehaviorSubject(new Map),this.ko=!0,this.Ve=i,this.se=v.logger("activities.activity"),this.Vo=null,this.To=!1,this.Ve.on(fe.Events.INTERRUPTED,this.sr),this.Ve.on(fe.Events.DISCONNECTED,this.sr),this.Ve.on(fe.Events.CONNECTED,this.ir),this.Lo=this.Ve.messages().subscribe(e=>{const t=e.message;t.activitySessionJoined&&B(t.activitySessionJoined.resourceId)===this.No?this.Fo(t.activitySessionJoined):t.activitySessionLeft&&B(t.activitySessionLeft.resourceId)===this.No?this.$o(t.activitySessionLeft):t.activityStateUpdated&&B(t.activityStateUpdated.resourceId)===this.No?this.Go(t.activityStateUpdated):t.activityDeleted&&B(t.activityDeleted.resourceId)===this.No?this.Jo(t.activityDeleted):t.activityForceLeave&&B(t.activityForceLeave.resourceId)===this.No&&this.Bo(t.activityForceLeave)})}session(){return this.Ve.session()}type(){return this.as}id(){return this.N}createdTime(){return this.Ho}isEphemeral(){return this.Wo}permissions(){return this.qo}leave(){return this.isJoined()?this.Ve.isConnected()?this.Ve.request({activityLeaveRequest:{resourceId:this.No}}).then(()=>{this.zo()}):(this.zo(),Promise.resolve()):Promise.reject(new O("The activity was not joined: "+this.N))}isJoined(){return this.ko}state(){return this.To?new Map:this.jo.state}setState(){if(this.Yo(),this.isJoined()){let e;if(1===arguments.length?e=G.coerceToMap(arguments[0]):2===arguments.length&&(e=new Map,e.set(arguments[0],arguments[1])),e.size>0){this.Qo(e,!1,[]);const t=new Map,s=this.state();e.forEach((e,i)=>{t.set(i,s.get(i)),s.set(i,e)}),this.Ko(e=>e.clone({state:s}));const i=this.Ve.session(),n=new Nr(this,i.user(),i.sessionId(),!0,e,!1,[],t);this.ve(n),e.forEach((e,s)=>{const n=t.get(s),r=new jr(this,i.user(),i.sessionId(),!0,s,e,n);this.ve(r)})}}}removeState(e){if(this.Yo(),this.isJoined()&&(o.isString(e)&&(e=[e]),e.length>0)){this.Qo(null,!1,e);const t=this.state(),s=new Map;e.forEach(e=>{s.set(e,t.get(e)),t.delete(e)}),this.Ko(e=>e.clone({state:t}));const i=this.Ve.session(),n=new Nr(this,i.user(),i.sessionId(),!0,new Map,!1,e,s);this.ve(n),e.forEach(e=>{const t=s.get(e),n=new Ar(this,i.user(),i.sessionId(),!0,e,t);this.ve(n)})}}clearState(){if(this.Yo(),this.isJoined()&&this.jo.state.size>0){this.Qo(new Map,!0,null);const e=this.state();this.Ko(e=>e.clone({state:new Map}));const t=this.Ve.session(),s=new Nr(this,t.user(),t.sessionId(),!0,new Map,!0,[],e);this.ve(s);const i=new Pr(this,t.user(),t.sessionId(),!0,e);this.ve(i)}}participant(e){return this.Uo.getValue().get(e)}participants(){return Array.from(this.Uo.getValue().values())}participantsAsObservable(){return this.Uo.asObservable().pipe(Object(b.map)(e=>Array.from(e.values())))}Xo(e){if(null===this.Vo){e=e||{},e=Object.assign({lurk:!1},e);const t=new I,s=e.state?G.coerceToMap(e.state):new Map;this.To=e.lurk,this.Zo=e.autoCreate||null,this.Ve.isConnected()?this.Ao(t,s):this.ea(t,s),this.Vo=t.promise()}}ta(){return this.Vo}zo(){this.ko=!1,this.No=null;const e=this.Ve.session().user(),t=this.Ve.session().sessionId(),s=new qr(this,e,t,!0);this.ve(s),this.Lo.unsubscribe(),this.ye()}Fo(e){const t=this.Is.getUserForSession(e.sessionId),s=h(Y(e.state),ee),i=new xr(this,t,e.sessionId,!1,G.objectToMap(s));this.Po(e=>e.set(i.sessionId,i)),this.sa(i)}sa(e){const t=new Dr(this,e.user,e.sessionId,!1,e);this.ve(t)}$o(e){const t=this.Uo.getValue().get(e.sessionId);this.ia(t),this.Po(e=>e.delete(t.sessionId))}ia(e){const t=new Tr(this,e.user,e.sessionId,e.local);this.ve(t)}Yo(){if(this.To)throw new O("Can not mutate local activity state when lurking.")}Go(e){const t=W(e.sessionId),s=G.objectToMap(Y(e.set)),i=H(e.complete),n=z(e.removed);i?0===s.size?this.na(t):this.ra(t,s):(n.length>0&&this.oa(t,n),s.size>0&&this.aa(t,s))}Jo(e){const t=new Fr(this,this.Ve.session().user(),this.Ve.session().sessionId(),!0);this.ve(t),this.zo()}Bo(e){const t=new Lr(this,this.Ve.session().user(),this.Ve.session().sessionId(),!0,W(e.reason));this.ve(t),this.zo()}aa(e,t){const s=this.Is.getUserForSession(e),i=new Map;t.forEach((e,t)=>{const s=ee(e);i.set(t,s)});const n=new Map;this.Po(t=>{const s=t.get(e),r=new Map(s.state);i.forEach((e,t)=>{n.set(t,r.get(t)),r.set(t,e)}),t.set(e,s.clone({state:r}))});const r=new Nr(this,s,e,!0,i,!1,[],n);this.ve(r),i.forEach((t,i)=>{const r=n.get(i),o=new jr(this,s,e,!1,i,t,r);this.ve(o)})}ra(e,t){const s=this.Is.getUserForSession(e),i=new Map;Object.keys(t).forEach(e=>{const s=ee(t[e]);i.set(e,s)});const n=this.Uo.getValue().get(e).state;this.Po(t=>{const s=t.get(e);t.set(e,s.clone({state:i}))});const r=[];n.forEach((e,t)=>{i.has(t)||r.push(t)});const o=new Nr(this,s,e,!0,i,!1,r,n);this.ve(o),r.forEach(t=>{const i=n.get(t),r=new Ar(this,s,e,!1,t,i);this.ve(r)}),i.forEach((t,i)=>{const r=n.get(i),o=new jr(this,s,e,!1,i,t,r);this.ve(o)})}na(e){const t=this.Is.getUserForSession(e),s=this.Uo.getValue().get(e).state;this.Po(t=>{const s=t.get(e),i=new Map;t.set(e,s.clone({state:i}))});const i=new Nr(this,t,e,!0,new Map,!0,[],s);this.ve(i);const n=new Pr(this,t,e,!1,s);this.ve(n)}oa(e,t){const s=this.Is.getUserForSession(e),i=new Map;this.Po(s=>{const n=s.get(e),r=new Map(n.state);t.forEach(e=>{i.set(e,r.get(e)),r.delete(e)}),s.set(e,n.clone({state:r}))});const n=new Nr(this,s,e,!0,new Map,!1,t,i);this.ve(n),t.forEach(t=>{const n=i.get(t),r=new Ar(this,s,e,!1,t,n);this.ve(r)})}Po(e){const t=new Map(this.Uo.getValue());e(t),this.Uo.next(t)}Ko(e){this.Po(t=>{this.jo=e(this.jo),t.set(this.jo.sessionId,this.jo)})}Ao(e,t){let s;if(this.Zo){s={worldPermissions:this.Zo.worldPermissions||[],userPermissions:Ur.userPermissions(this.Zo.userPermissions),groupPermissions:Ur.toGroupPermissionsProto(this.Zo.groupPermissions),ephemeral:this.Zo.ephemeral}}const i=h(G.mapToObject(t),te),n={activityJoinRequest:{activityType:this.as,activityId:this.N,lurk:this.To,state:i,autoCreateData:s}};this.No=null,this.Ve.request(n).then(t=>{const s=t.activityJoinResponse,i=this.Ve.session().sessionId();this.No=B(s.resourceId),this.Wo=H(s.ephemeral),this.Ho=X(s.created);const n=new Map,r=Y(s.state);if(u(r,e=>{const t=r[e]||{},s=this.Is.getUserForSession(e),o=e===i,a=h(Y(t.state),ee),c=G.objectToMap(a),u=new xr(this,s,e,o,c);n.set(e,u)}),void 0!==this.jo){this.ia(this.jo);const e=n.get(i),t=e.clone({state:this.jo.state});this.ca(e.state,this.jo.state),n.set(i,t)}this.jo=n.get(i),this.Uo.next(n),n.forEach(e=>this.sa(e)),e.resolve()}).catch(t=>{e.reject(t)})}ca(e,t){const s=[];e.forEach((e,i)=>{t.has(i)||s.push(i)});const i=new Map;t.forEach((t,s)=>{Le.deepEquals(!e.get(s),t)||i.set(s,t)}),(s.length>0||i.size>0)&&this.Qo(i,!1,s)}ea(e,t){this.ko=!0;const s=this.Ve.session();this.jo=new xr(void 0,s.user(),s.sessionId(),!0,t);const i=new Map;i.set(this.jo.sessionId,this.jo),this.Uo.next(i),e.resolve()}Qo(e,t,s){const i=null!==e?h(G.mapToObject(e),te):{},n=null!==s?s:[];if(this.Ve.isConnected()){const e={activityUpdateState:{resourceId:this.No,set:i,complete:t,removed:n}};this.Ve.send(e)}}}$r.Events={SESSION_JOINED:Dr.EVENT_NAME,SESSION_LEFT:Tr.EVENT_NAME,STATE_SET:jr.EVENT_NAME,STATE_CLEARED:Pr.EVENT_NAME,STATE_REMOVED:Ar.EVENT_NAME,STATE_DELTA:Nr.EVENT_NAME,LEFT:qr.EVENT_NAME,DELETED:qr.EVENT_NAME,FORCE_LEAVE:Lr.EVENT_NAME},Object.freeze($r.Events);class Gr extends R{constructor(e,t){super(),this.se=v.logger("activities.service"),this.Ve=e,this.Is=t,this.ha=new Map}session(){return this.Ve.session()}create(e){l.assertNonEmptyString(e.activityType,"options.activityType");const t=e.worldPermissions||[],s=Ur.userPermissions(e.userPermissions),i=Ur.toGroupPermissionsProto(e.groupPermissions),n={activityCreateRequest:{activityId:e.activityId,activityType:e.activityType,worldPermissions:t,userPermissions:s,groupPermissions:i}};return this.Ve.request(n).then(()=>{})}remove(e,t){l.assertNonEmptyString(t,"activityType");const s={activityDeleteRequest:{activityId:e,activityType:t}};return this.Ve.request(s).then(()=>{})}join(e,t,s){let i=this.ha.get(Gr.ua(e,t));if(void 0===i){i=new $r(e,t,this.Is,this.Ve),this.ha.set(Gr.ua(e,t),i);const n=i.events().pipe(Object(b.filter)(e=>e.name===qr.EVENT_NAME),Object(b.tap)(()=>this.da(e,t)));i.Xo(s),i.ta().then(()=>(this.ge(n),Promise.resolve(i))).catch(e=>(this.ha.delete(t),Promise.reject(e)))}return i.ta().then(()=>i)}joined(){return new Map(this.ha)}isJoined(e,t){return this.ha.has(Gr.ua(e,t))}da(e,t){this.ha.delete(Gr.ua(e,t))}static ua(e,t){return`${e}/${t}`}}class Jr{constructor(e,t,s){this.user=e,this.available=t,this.So=d(s),Object.freeze(this)}get state(){return d(this.So)}}class Br{constructor(e,t){this.user=e,this.available=t,this.name=Br.NAME,Object.freeze(this)}}Br.NAME="availability_changed";class Hr{constructor(e){this.user=e,this.name=Hr.NAME,Object.freeze(this)}}Hr.NAME="state_cleared";class Wr{constructor(e,t){this.user=e,this.keys=t,this.name=Wr.NAME,Object.freeze(this)}}Wr.NAME="state_removed";class zr{constructor(e,t){this.user=e,this.state=t,this.name=zr.NAME,Object.freeze(this)}}zr.NAME="state_set";class Yr extends R{constructor(e){super(),this.la=e,this.ge(e.events())}get user(){return this.la.user()}get available(){return this.la.isAvailable()}get state(){return this.la.state()}asObservable(){return this.la.asObservable()}unsubscribe(){null!==this.la&&this.la.unsubscribe(this),this.la=null}}Yr.Events={STATE_SET:zr.NAME,STATE_REMOVED:Wr.NAME,STATE_CLEARED:Hr.NAME,AVAILABILITY_CHANGED:Br.NAME};class Qr extends R{constructor(e,t,s){super(),this.pa=new Jr(e.user,e.available,e.state),this.fa=[],this.ma=s,this.ga(t),this.va=new w.BehaviorSubject(this.pa)}user(){return this.pa.user}isAvailable(){return this.pa.available}state(){return this.pa.state}asObservable(){return this.va.asObservable()}subscribe(){const e=new Yr(this);return this.fa.push(e),e}unsubscribe(e){this.fa=this.fa.filter(t=>t!==e),0===this.fa.length&&(this.ya.unsubscribe(),this.va.complete(),this.ma(this.user().userId))}availability(e,t=!0){this.pa=new Jr(this.pa.user,e,this.pa.state);const s=new Br(this.pa.user,e);this.ve(s),t&&this.va.next(this.pa)}set(e,t=!0){const s=this.pa.state;e.forEach((e,t)=>s.set(t,d(e))),this.pa=new Jr(this.pa.user,this.pa.available,s);const i=new zr(this.pa.user,s);this.ve(i),t&&this.va.next(this.pa)}remove(e,t=!0){const s=this.pa.state;e.forEach(e=>s.delete(e)),this.pa=new Jr(this.pa.user,this.pa.available,s);const i=new Wr(this.pa.user,e);this.ve(i),t&&this.va.next(this.pa)}clear(e=!0){this.pa=new Jr(this.pa.user,this.pa.available,new Map);const t=new Hr(this.pa.user);this.ve(t),e&&this.va.next(this.pa)}hasKey(e){return this.pa.state.has(e)}ir(e){this.availability(e.available,!1),this.clear(!1),this.set(e.state),this.va.next(e)}ga(e){this.ya&&this.ya.unsubscribe(),this.ya=e.subscribe(e=>this.Bn(e))}sr(){this.availability(!1,!1)}Bn(e){const t=e.message;if(t.presenceAvailabilityChanged){const{available:e}=t.presenceAvailabilityChanged;this.availability(H(e))}else if(t.presenceStateSet){const{state:e}=t.presenceStateSet,s=G.objectToMap(h(Y(e),ee));this.set(s)}else if(t.presenceStateCleared)this.clear();else if(t.presenceStateRemoved){const{keys:e}=t.presenceStateRemoved;this.remove(z(e))}}}class Kr extends R{constructor(e,t,s){super(),this.se=v.logger("connection"),this.ir=()=>{const e=this.session().user(),t=this.wa(e.userId);this.ba.ga(t);const s=[];this.Oa.forEach(e=>{s.push(e.user().userId)}),this.Ra(s).then(e=>{e.forEach(e=>{const t=this.Ma(e.user.userId);t&&t.ir(e)})}).catch(e=>{this.se.error("Error resubscribing to presence",e)})},this.sr=()=>{this.ba.sr(),this.Oa.forEach(e=>{e.sr()})},this.Ve=e,this.Is=t,this.Oa=new Map,this.Ea=this.Ve.messages().pipe(Object(b.share)());const i=void 0!==s?s:new q(P.ANONYMOUS,""),n=this.wa(i.userId),r=new Jr(i,!1,new Map);this.ba=new Qr(r,n,()=>{}),this.Sa=this.ba.subscribe(),this.ge(this.Sa.events()),this.Ve.on(fe.Events.INTERRUPTED,this.sr),this.Ve.on(fe.Events.DISCONNECTED,this.sr),this.Ve.on(fe.Events.CONNECTED,this.ir)}session(){return this.Ve.session()}isAvailable(){return this.Sa.available}setState(){let e;if(1===arguments.length)e=G.objectToMap(arguments[0]);else if(2===arguments.length)e=new Map,e.set(arguments[0],arguments[1]);else if(0===arguments.length)return;if(this.ba.set(e),this.Ve.isConnected()){const t={presenceSetState:{state:h(G.mapToObject(e),te)}};this.Ve.send(t)}}removeState(e){const t=("string"==typeof e?[e]:e).filter(e=>this.ba.hasKey(e));if(t.length>0&&(this.ba.remove(t),this.Ve.isConnected())){const e={presenceRemoveState:{keys:t}};this.Ve.send(e)}}clearState(){if(this.ba.clear(),this.Ve.isConnected()){const e={presenceClearState:{}};this.Ve.send(e)}}state(){return this.Sa.state}presence(e){return this.Ve.session().assertOnline(),Array.isArray(e)?this.Ca(e.map(N.toDomainUserId)):this.Ca([N.toDomainUserId(e)]).then(e=>e[0])}subscribe(e){const t=Array.isArray(e)?e.map(N.toDomainUserId):[N.toDomainUserId(e)];return this.Ia(t).then(()=>{const s=t.map(e=>this.Oa.get(e.toGuid()).subscribe());return Array.isArray(e)?s:s[0]})}_a(e){this.ba.clear(!1),this.ba.set(e)}Ca(e){const t={presenceRequest:{users:e.map(ie)}};return this.Ve.request(t).then(e=>{const{userPresences:t}=e.presenceResponse;return z(t).map(e=>this.xa(e))})}wa(e){return this.Ea.pipe(Object(b.filter)(t=>{const s=t.message,i=s.presenceAvailabilityChanged&&s.presenceAvailabilityChanged.user||s.presenceStateSet&&s.presenceStateSet.user||s.presenceStateRemoved&&s.presenceStateRemoved.user||s.presenceStateCleared&&s.presenceStateCleared.user;return i&&se(i).equals(e)}))}Ia(e){const t=e.filter(e=>void 0===this.Oa.get(e.toGuid()));return t.length>0?this.Ra(t).then(e=>{e.forEach(e=>{const t=e.user.userId.toGuid(),s=this.wa(e.user.userId),i=new Qr(e,s,e=>this.Da(e));this.Oa.set(t,i)})}):Promise.resolve()}Ra(e){const t={presenceSubscribeRequest:{users:e.map(ie)}};return this.Ve.request(t).then(e=>{const{userPresences:t}=e.presenceSubscribeResponse;return z(t).map(e=>this.xa(e))})}Da(e){if(this.Ve.isConnected()){const t={presenceUnsubscribe:{users:[ie(e)]}};this.Ve.send(t)}const t=e.toGuid();this.Oa.delete(t)}xa(e){const t=se(e.user);let s=this.Is.getUser(t);s||(s=new q(t.userType,t.username));const i=H(e.available),n=G.objectToMap(h(Y(e.state),ee));return new Jr(s,i,n)}Ma(e){return e.equals(this.ba.user().userId)?this.ba:this.Oa.get(e.toGuid())}}Kr.Events={STATE_SET:zr.NAME,STATE_REMOVED:Wr.NAME,STATE_CLEARED:Hr.NAME,AVAILABILITY_CHANGED:Br.NAME},Object.freeze(Kr.Events);class Xr{constructor(e,t,s,i){this.chatId=e,this.eventNumber=t,this.timestamp=s,this.user=i}}class Zr{constructor(e){this.chatId=e,this.name=Zr.NAME,Object.freeze(this)}}Zr.NAME="joined";class eo{constructor(e){this.chatId=e,this.name=eo.NAME,Object.freeze(this)}}eo.NAME="left";class to extends Xr{constructor(e,t,s,i,n){super(e,t,s,i),this.message=n,this.name=to.NAME,Object.freeze(this)}}to.NAME="message";class so extends Xr{constructor(e,t,s,i,n){super(e,t,s,i),this.chatName=n,this.name=so.NAME,Object.freeze(this)}}so.NAME="name_changed";class io{constructor(e){this.chatId=e,this.name=io.NAME,Object.freeze(this)}}io.NAME="removed";class no extends Xr{constructor(e,t,s,i,n){super(e,t,s,i),this.topic=n,this.name=no.NAME,Object.freeze(this)}}no.NAME="topic_changed";class ro extends Xr{constructor(e,t,s,i,n){super(e,t,s,i),this.addedUser=n,this.name=ro.NAME,Object.freeze(this)}}ro.NAME="user_added";class oo extends Xr{constructor(e,t,s,i){super(e,t,s,i),this.name=oo.NAME,Object.freeze(this)}}oo.NAME="user_joined";class ao extends Xr{constructor(e,t,s,i){super(e,t,s,i),this.name=ao.NAME,Object.freeze(this)}}ao.NAME="user_left";class co extends Xr{constructor(e,t,s,i,n){super(e,t,s,i),this.removedUser=n,this.name=co.NAME,Object.freeze(this)}}co.NAME="user_removed";class ho{constructor(e,t,s){this.chatId=e,this.maxSeenEventNumber=t,this.user=s,this.name=ho.NAME,Object.freeze(this)}}ho.NAME="events_seen";class uo{constructor(e,t,s,i,n){this.type=e,this.chatId=t,this.eventNumber=s,this.timestamp=i,this.user=n}}uo.TYPES={CREATED:"created",MESSAGE:"message",USER_JOINED:"user_joined",USER_LEFT:"user_left",USER_ADDED:"user_added",USER_REMOVED:"user_removed",NAME_CHANGED:"name_changed",TOPIC_CHANGED:"topic_changed"},n.make(uo.TYPES);class lo extends uo{constructor(e,t,s,i,r,o,a){super(lo.TYPE,e,t,s,i),this.name=r,this.topic=o,this.members=a,n.make(this)}}lo.TYPE=uo.TYPES.CREATED;class po extends uo{constructor(e,t,s,i,r){super(po.TYPE,e,t,s,i),this.message=r,n.make(this)}}po.TYPE=uo.TYPES.MESSAGE;class fo extends uo{constructor(e,t,s,i,r){super(fo.TYPE,e,t,s,i),this.addedUser=r,n.make(this)}}fo.TYPE=uo.TYPES.USER_ADDED;class mo extends uo{constructor(e,t,s,i,r){super(mo.TYPE,e,t,s,i),this.removedUser=r,n.make(this)}}mo.TYPE=uo.TYPES.USER_REMOVED;class go extends uo{constructor(e,t,s,i){super(go.TYPE,e,t,s,i),n.make(this)}}go.TYPE=uo.TYPES.USER_JOINED;class vo extends uo{constructor(e,t,s,i){super(vo.TYPE,e,t,s,i),n.make(this)}}vo.TYPE=uo.TYPES.USER_LEFT;class yo extends uo{constructor(e,t,s,i,r){super(yo.TYPE,e,t,s,i),this.name=r,n.make(this)}}yo.TYPE=uo.TYPES.NAME_CHANGED;class wo extends uo{constructor(e,t,s,i,r){super(wo.TYPE,e,t,s,i),this.topic=r,n.make(this)}}wo.TYPE=uo.TYPES.TOPIC_CHANGED;var bo;function Oo(e,t,s){let i=-1;const n=e.user().userId,r=z(s.members).map(e=>{const s=se(e.user);s.equals(n)&&(i=B(e.maxSeenEventNumber));return{user:t.getUser(s),maxSeenEventNumber:B(e.maxSeenEventNumber)}});return{chatId:s.id,chatType:s.chatType,membership:s.membership,name:W(s.name),topic:W(s.topic),createdTime:X(s.createdTime),lastEventTime:X(s.lastEventTime),lastEventNumber:B(s.lastEventNumber),maxSeenEventNumber:i,members:r,joined:void 0!==r.find(e=>e.user.userId.equals(n))}}!function(e){e.DIRECT="direct",e.CHANNEL="channel",e.ROOM="room"}(bo||(bo={}));class Ro extends kr{constructor(e,t){super(t),this.Do={chat:{id:e}}}id(){return this.Do.activity.id}Co(){return this.Do}}const Mo={MESSAGE:to.NAME,USER_JOINED:oo.NAME,USER_LEFT:ao.NAME,USER_ADDED:ro.NAME,USER_REMOVED:co.NAME};Object.freeze(Mo);class Eo extends R{constructor(e,t,s,i){super(),this.Ve=e,this.Is=t,this.Ta=i,s.subscribe(e=>{this.ja(e),this.ve(e)})}session(){return this.Ve.session()}info(){return Object.assign({},this.Ta)}isJoined(){return this.Ta.joined}send(e){return this.Ve.session().assertOnline(),this.Aa(),this.Ve.request({publishChatMessageRequest:{chatId:this.Ta.chatId,message:e}}).then(e=>{const{publishChatMessageResponse:t}=e;return{eventNumber:B(t.eventNumber),timestamp:X(t.timestamp)}})}setName(e){return this.Ve.session().assertOnline(),this.Aa(),this.Ve.request({setChatNameRequest:{chatId:this.Ta.chatId,name:e}}).then(()=>{})}setTopic(e){return this.Ve.session().assertOnline(),this.Aa(),this.Ve.request({setChatTopicRequest:{chatId:this.Ta.chatId,topic:e}}).then(()=>{})}markSeen(e){return this.Ve.session().assertOnline(),this.Aa(),this.Ve.request({markChatEventsSeenRequest:{chatId:this.Ta.chatId,eventNumber:e}}).then(()=>{})}getHistory(e){return this.Ve.session().assertOnline(),this.Aa(),this.Ve.request({getChatHistoryRequest:{chatId:this.Ta.chatId,startEvent:Q(e.startEvent),limit:Q(e.limit),forward:Q(e.forward),eventFilter:e.eventFilter}}).then(e=>{const t=e.getChatHistoryResponse,s=z(t.data).map(e=>class{static toChatHistoryEntry(e,t){if(e.created){const{chatId:s,eventNumber:i,timestamp:n,user:r,name:o,topic:a,members:c}=e.created,h=z(c).map(e=>t.getUser(se(e)));return new lo(s,B(i),X(n),t.getUser(se(r)),o,a,h)}if(e.message){const{chatId:s,eventNumber:i,timestamp:n,user:r,message:o}=e.message;return new po(s,B(i),X(n),t.getUser(se(r)),o)}if(e.userAdded){const{chatId:s,eventNumber:i,timestamp:n,user:r,addedUser:o}=e.userAdded;return new fo(s,B(i),X(n),t.getUser(se(r)),t.getUser(se(o)))}if(e.userRemoved){const{chatId:s,eventNumber:i,timestamp:n,user:r,removedUser:o}=e.userRemoved;return new mo(s,B(i),X(n),t.getUser(se(r)),t.getUser(se(o)))}if(e.userJoined){const{chatId:s,eventNumber:i,timestamp:n,user:r}=e.userJoined;return new go(s,B(i),X(n),t.getUser(se(r)))}if(e.userLeft){const{chatId:s,eventNumber:i,timestamp:n,user:r}=e.userLeft;return new vo(s,B(i),X(n),t.getUser(se(r)))}if(e.topicChanged){const{chatId:s,eventNumber:i,timestamp:n,user:r,topic:o}=e.topicChanged;return new wo(s,B(i),X(n),t.getUser(se(r)),W(o))}if(e.nameChanged){const{chatId:s,eventNumber:i,timestamp:n,user:r,name:o}=e.nameChanged;return new yo(s,B(i),X(n),t.getUser(se(r)),W(o))}throw new O("Invalid chat event: "+JSON.stringify(e))}}.toChatHistoryEntry(e,this.Is));return new S(s,B(t.startIndex),B(t.totalResults))})}permissions(){return new Ro(this.Ta.chatId,this.Ve)}Pa(e){this.Ta=Oo(this.Ve.session(),this.Is,e)}Xo(){return this.Ve.request({joinChatRequest:{chatId:this.Ta.chatId}}).then(e=>{const{joinChatResponse:t}=e;this.Pa(t.chatInfo)})}Aa(){if(!this.isJoined()){const e="Chat channel not joined: "+this.Ta.chatId;throw new O(e,A.CHAT_NOT_JOINED)}}ja(e){if(e instanceof Xr&&(this.Ta=Object.assign(Object.assign({},this.Ta),{lastEventNumber:e.eventNumber,lastEventTime:e.timestamp})),e instanceof oo||e instanceof ro){const t=e instanceof oo?e.user:e.addedUser,s=this.Ta.members.slice(0),i={user:t,maxSeenEventNumber:-1};s.push(i),e.user.username===this.session().user().username&&(this.Ta=Object.assign(Object.assign({},this.Ta),{joined:!0})),this.Ta=Object.assign(Object.assign({},this.Ta),{members:s})}else if(e instanceof ao||e instanceof co){const t=e instanceof ao?e.user:e.removedUser;this.session().user().userId.equals(t.userId)&&(this.Ta=Object.assign(Object.assign({},this.Ta),{joined:!1}));const s=this.Ta.members.filter(e=>!e.user.userId.equals(t.userId));this.Ta=Object.assign(Object.assign({},this.Ta),{members:s})}else if(e instanceof so)this.Ta=Object.assign(Object.assign({},this.Ta),{name:e.chatName});else if(e instanceof no)this.Ta=Object.assign(Object.assign({},this.Ta),{topic:e.topic});else if(e instanceof ho){const t=this.Ta.members.slice(0),s=t.findIndex(t=>t.user.userId.equals(e.user.userId));if(s>=0){const i=t[s];if(i){const n=Object.assign(Object.assign({},i),{eventNumber:e.maxSeenEventNumber});t[s]=n,this.Ta=Object.assign(Object.assign({},this.Ta),{members:t}),this.session().user().userId.equals(i.user.userId)&&(this.Ta=Object.assign(Object.assign({},this.Ta),{maxSeenEventNumber:e.maxSeenEventNumber}))}}}n.make(this.Ta)}}Eo.Events=Mo;class So extends Eo{constructor(e,t,s,i){super(e,t,s,i)}info(){const e=super.info(),t=this.session().user().userId,s=e.members.filter(e=>!e.user.userId.equals(t));return Object.assign(Object.assign({},e),{otherUsers:s})}}class Co extends Eo{constructor(e,t,s,i){super(e,t,s,i)}info(){return super.info()}leave(){return this.Ve.session().assertOnline(),this.Aa(),this.Ve.request({leaveChatRequest:{chatId:this.Ta.chatId}}).then(()=>{})}remove(e){return this.Ve.session().assertOnline(),this.Aa(),this.Ve.request({removeUserFromChatRequest:{chatId:this.Ta.chatId,userToRemove:ie(N.toDomainUserId(e))}}).then(()=>{})}}class Io extends Co{constructor(e,t,s,i){super(e,t,s,i)}add(e){return this.Ve.session().assertOnline(),this.Aa(),this.Ve.request({addUserToChatRequest:{chatId:this.Ta.chatId,userToAdd:ie(N.toDomainUserId(e))}}).then(()=>{})}}class _o extends Co{constructor(e,t,s,i){super(e,t,s,i),this.ir=()=>{this.Xo().catch(e=>console.log(e))},this.sr=()=>{this.Ta=Object.assign(Object.assign({},this.Ta),{joined:!1})},e.on(fe.Events.INTERRUPTED,this.sr),e.on(fe.Events.DISCONNECTED,this.sr),e.on(fe.Events.CONNECTED,this.ir)}}const xo={MESSAGE:to.NAME,USER_JOINED:oo.NAME,USER_LEFT:ao.NAME,USER_ADDED:ro.NAME,USER_REMOVED:co.NAME,CHANNEL_JOINED:Zr.NAME,CHANNEL_LEFT:eo.NAME};Object.freeze(xo);class Do extends R{constructor(e,t){super(),this.Ve=e,this.Is=t,this.Ea=this.Ve.messages().pipe(Object(b.filter)(e=>function(e){return!!(e.remoteChatMessage||e.userJoinedChat||e.userLeftChat||e.userAddedToChat||e.userRemovedFromChat||e.chatRemoved||e.chatNameChanged||e.chatTopicChanged||e.chatEventsMarkedSeen)}(e.message)),Object(b.map)(e=>function(e,t){if(e.userJoinedChat){const s=e.userJoinedChat;return new oo(s.chatId,B(s.eventNumber),X(s.timestamp),t.getUser(se(s.user)))}if(e.userLeftChat){const s=e.userLeftChat;return new ao(s.chatId,B(s.eventNumber),X(s.timestamp),t.getUser(se(s.user)))}if(e.userAddedToChat){const s=e.userAddedToChat;return new ro(s.chatId,B(s.eventNumber),X(s.timestamp),t.getUser(se(s.user)),t.getUser(se(s.addedUser)))}if(e.userRemovedFromChat){const s=e.userRemovedFromChat;return new co(s.chatId,B(s.eventNumber),X(s.timestamp),t.getUser(se(s.user)),t.getUser(se(s.removedUser)))}if(e.chatRemoved){const t=e.chatRemoved;return new io(t.chatId)}if(e.chatNameChanged){const s=e.chatNameChanged;return new so(s.chatId,B(s.eventNumber),X(s.timestamp),t.getUser(se(s.user)),W(s.name))}if(e.chatTopicChanged){const s=e.chatTopicChanged;return new no(s.chatId,B(s.eventNumber),X(s.timestamp),t.getUser(se(s.user)),W(s.topic))}if(e.remoteChatMessage){const s=e.remoteChatMessage;return new to(s.chatId,B(s.eventNumber),X(s.timestamp),t.getUser(se(s.user)),W(s.message))}if(e.chatEventsMarkedSeen){const s=e.chatEventsMarkedSeen;return new ho(s.chatId,B(s.eventNumber),t.getUser(se(s.user)))}throw new O("Invalid chat event")}(e.message,this.Is)),Object(b.tap)(e=>{if(e instanceof oo&&e.user.username===this.session().user().username){const t=new Zr(e.chatId);this.ve(t)}else if(e instanceof ao&&e.user.username===this.session().user().username){const t=new eo(e.chatId);this.ve(t)}}),Object(b.share)()),this.ge(this.Ea)}static Na(e){if(o.isString(e))return[e];if(o.isArray(e))return e;throw new O("chatIds must be a string or string array: "+e)}session(){return this.Ve.session()}search(e){return this.session().assertOnline(),this.Ve.request({chatsSearchRequest:{searchTerm:e.searchTerm,searchFields:e.searchFields,types:e.types,membership:e.membership,limit:te(e.limit),offset:te(e.offset)}}).then(e=>{const{chatsSearchResponse:t}=e,s=z(t.data).map(e=>Oo(this.Ve.session(),this.Is,e));return new S(s,B(t.startIndex),B(t.totalResults))})}exists(e){let t=Do.Na(e);return this.session().assertOnline(),this.Ve.request({chatsExistRequest:{chatIds:t}}).then(t=>{const{chatsExistResponse:s}=t,i=z(s.exists);return o.isString(e)?H(i[0]):o.isArray(e)?new Map(e.map((e,t)=>[e,H(i[t])])):void 0})}get(e){let t=Do.Na(e);return this.session().assertOnline(),this.Ve.request({getChatsRequest:{chatIds:t}}).then(t=>{const{getChatsResponse:s}=t,i=z(s.chatInfo).map(e=>{const t=Oo(this.Ve.session(),this.Is,e);return this.qa(t)});return o.isString(e)?i[0]:o.isArray(e)?new Map(i.map(e=>[e.info().chatId,e])):void 0})}joined(){return this.session().isConnected()?this.Ve.request({getJoinedChatsRequest:{}}).then(e=>{const{getJoinedChatsResponse:t}=e;return z(t.chatInfo).map(e=>Oo(this.Ve.session(),this.Is,e))}):Promise.resolve([])}create(e){if(!e)throw new Error("create options must be supplied");if("channel"!==e.type&&"room"!==e.type)throw new Error("type must be 'channel' or 'room': "+e.type);if("public"!==e.membership&&"private"!==e.membership)throw new Error("membership must be 'public' or 'private': "+e.membership);if("room"===e.type&&"private"===e.membership)throw new Error("membership must be 'public' for a 'room': "+e.membership);void 0!==e.id&&l.assertNonEmptyString(e.id,"id"),this.session().assertOnline();const{id:t,type:s,name:i,topic:n,membership:r,members:o}=e,a=(o||[]).map(e=>ie(e instanceof N?e:N.normal(e)));return this.Ve.request({createChatRequest:{chatId:Q(t),chatType:s,membership:r,name:i,topic:n,members:a}}).then(e=>{const{createChatResponse:t}=e;return t.chatId}).catch(s=>s instanceof M&&"chat_already_exists"===s.code&&e.ignoreExistsError?Promise.resolve(t):Promise.reject(s))}remove(e){return l.assertNonEmptyString(e,"chatId"),this.session().assertOnline(),this.Ve.request({removeChatRequest:{chatId:e}}).then(()=>{})}join(e){return l.assertNonEmptyString(e,"chatId"),this.session().assertOnline(),this.Ve.request({joinChatRequest:{chatId:e}}).then(e=>{const{joinChatResponse:t}=e,s=Oo(this.Ve.session(),this.Is,t.chatInfo);return this.qa(s)})}leave(e){return l.assertNonEmptyString(e,"chatId"),this.session().assertOnline(),this.Ve.request({leaveChatRequest:{chatId:e}}).then(()=>{})}direct(e){this.session().assertOnline();const{directIds:t,single:s}=this.processDirectChatArgs(e),i=t.map(e=>({values:e.map(e=>ie(e instanceof N?e:N.normal(e)))}));return this.Ve.request({getDirectChatsRequest:{userLists:i}}).then(e=>{const{getDirectChatsResponse:t}=e,i=z(t.chatInfo).map(e=>{const t=Oo(this.Ve.session(),this.Is,e);return this.qa(t)});return s?i[0]:i})}permissions(e){return new Ro(e,this.Ve)}processDirectChatArgs(e){let t,s=!0;if("string"==typeof e||e instanceof N)t=[[e]];else{if(!Array.isArray(e))throw new O("users must be a string, DomainUserId, or an Array");{if(0===e.length)throw new O("users can not be an empty array");const i=Array.isArray(e[0]);if(i!==e.every(e=>Array.isArray(e)))throw new O("When passing an array, all elements must be single usernames / DomainUserIds or they must all be arrays.");i?(t=e,s=!1):t=[e]}}return{directIds:t,single:s}}qa(e){const t=this.Ea.pipe(Object(b.filter)(t=>t.chatId===e.chatId));switch(e.chatType){case bo.DIRECT:return new So(this.Ve,this.Is,t,e);case bo.CHANNEL:return new Io(this.Ve,this.Is,t,e);case bo.ROOM:return new _o(this.Ve,this.Is,t,e);default:throw new Error("Invalid chat chat type: "+e.chatType)}}}Do.Events=xo;var To=function(e,t,s,i){return new(s||(s=Promise))((function(n,r){function o(e){try{c(i.next(e))}catch(e){r(e)}}function a(e){try{c(i.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(o,a)}c((i=i.apply(e,t||[])).next())}))};class jo{constructor(e,t){this.Ua=new Map,this.Rn=new Map,e.messages().subscribe(e=>{e.message.identityCacheUpdate&&this.ka(e.message.identityCacheUpdate)}),this.Va=t,this.F=v.logger("identity")}init(){return To(this,void 0,void 0,(function*(){if(this.Va.isEnabled()){(yield this.Va.identityStore().getUsers()).forEach(e=>{this.Ua.set(e.userId.toGuid(),e)});(yield this.Va.identityStore().getSessions()).forEach((e,t)=>{const s=this.Ua.get(e.toGuid());this.Rn.set(t,s)})}}))}getUserForSession(e){return this.Rn.get(e)}getUser(e){return this.Ua.get(e.toGuid())}ka(e){z(e.users).forEach(e=>{const t=V(e);this.Ua.set(t.userId.toGuid(),t),this.Va.isEnabled()&&this.Va.identityStore().putUser(t).catch(e=>this.F.error("Error storing user",e))}),u(Y(e.sessions),(e,t)=>{const s=ne(t.userType),i=W(t.username),n=this.Ua.get(N.guid(s,i));this.Rn.set(e,n),this.Va.isEnabled()&&this.Va.identityStore().putSession(e,n.userId).catch(e=>this.F.error("Error storing session",e))})}}class Ao{constructor(e){Ao.validate(e);const t={timeout:Ao.DEFAULT_CONNECTION_TIMEOUT,connectionRequestTimeout:Ao.DEFAULT_CONNECTION_REQUEST_TIMEOUT},{timeout:s,connectionRequestTimeout:i}=Object.assign(Object.assign({},t),e.connection);this.connectionTimeout=s,this.connectionRequestTimeout=i;const n={autoReconnect:Ao.DEFAULT_AUTO_RECONNECT,autoReconnectOnInitial:Ao.DEFAULT_AUTO_RECONNECT_ON_INITIAL,reconnectIntervals:Ao.DEFAULT_RECONNECT_INTERVALS,fallbackAuth:{jwt:null,password:null,anonymous:null}},{autoReconnect:r,autoReconnectOnInitial:a,reconnectIntervals:c,fallbackAuth:h}=Object.assign(Object.assign({},n),e.reconnect);this.autoReconnect=r,this.autoReconnectOnInitial=a,this.reconnectIntervals=c,this.fallbackAuth=null,o.isFunction(h)&&(this.fallbackAuth=h);const u={defaultRequestTimeout:Ao.DEFAULT_REQUEST_TIMEOUT,heartbeat:{enabled:Ao.DEFAULT_HEARTBEAT_ENABLED,pingInterval:Ao.DEFAULT_PING_INTERVAL,pongTimeout:Ao.DEFAULT_PONG_TIMEOUT}},{defaultRequestTimeout:d,heartbeat:l}=Object.assign(Object.assign({},u),e.protocol);this.defaultRequestTimeout=d,this.heartbeatEnabled=void 0!==l.enabled?l.enabled:Ao.DEFAULT_HEARTBEAT_ENABLED,this.pingInterval=void 0!==l.pingInterval?l.pingInterval:Ao.DEFAULT_PING_INTERVAL,this.pongTimeout=void 0!==l.pongTimeout?l.pongTimeout:Ao.DEFAULT_PONG_TIMEOUT;const p={factory:Ao.DEFAULT_WEBSOCKET_FACTORY,constructor:Ao.DEFAULT_WEBSOCKET_CONSTRUCTOR},f=Object.assign(Object.assign({},p),e.webSocket);this.webSocketFactory=f.factory||null,this.webSocketClass=f.class||null;const m=Object.assign({},e.offline);this.storageAdapter=m.storage||null,this.offlineStorageEnabled=null!==this.storageAdapter,this.offlineModelOperationSnapshotInterval=m.modelSnapshotInterval||100;const{data:g}=e.models||{},v=Object.assign(Object.assign({},Ao.DEFAULT_MODEL_DATA_OPTIONS),g);this.modelDataUndefinedObjectValues=v.undefinedObjectValues,this.modelDataUndefinedArrayValues=v.undefinedArrayValues}static validate(e){let t=!1;try{t=2===WebSocket.CLOSING}catch(e){}if(!(t||e.webSocket&&e.webSocket.class)){throw new O("Convergence depends on the WebSockets API. If Convergence is not being run in a browser, you must set the 'webSocket.class' property in the connection options.","websockets_not_supported")}}getOptions(){return{connection:{timeout:this.connectionTimeout,connectionRequestTimeout:this.connectionRequestTimeout},protocol:{defaultRequestTimeout:this.defaultRequestTimeout,heartbeat:{enabled:this.heartbeatEnabled,pingInterval:this.pingInterval,pongTimeout:this.pongTimeout}},reconnect:{autoReconnect:this.autoReconnect,autoReconnectOnInitial:this.autoReconnectOnInitial,reconnectIntervals:this.reconnectIntervals,fallbackAuth:this.fallbackAuth},offline:{storage:this.storageAdapter},webSocket:{factory:this.webSocketFactory,class:this.webSocketClass}}}}Ao.DEFAULT_CONNECTION_TIMEOUT=5,Ao.DEFAULT_CONNECTION_REQUEST_TIMEOUT=10,Ao.DEFAULT_AUTO_RECONNECT=!0,Ao.DEFAULT_AUTO_RECONNECT_ON_INITIAL=!0,Ao.DEFAULT_RECONNECT_INTERVALS=[0,5,10,20,30],Ao.DEFAULT_REQUEST_TIMEOUT=10,Ao.DEFAULT_HEARTBEAT_ENABLED=!0,Ao.DEFAULT_PING_INTERVAL=5,Ao.DEFAULT_PONG_TIMEOUT=10,Ao.DEFAULT_WEBSOCKET_FACTORY=null,Ao.DEFAULT_WEBSOCKET_CONSTRUCTOR=null,Ao.DEFAULT_MODEL_DATA_OPTIONS={undefinedObjectValues:"error",undefinedArrayValues:"error"};class Po{constructor(){this.F=v.logger("storage"),this.Va=null}configure(e){if(this.F.debug("Initializing storage engine: "+e.adapterId()),!e)throw new Error("storage must be specified");this.Va=e}openStore(e,t,s){return this.Va.initialize(e,t,s)}isEnabled(){return null!==this.Va}isInitialized(){return null!==this.Va&&this.Va.isInitialized()}dispose(){if(!this.isInitialized())throw new Error("Can not disposed a storage adapter that is not initialized");if(this.isDisposed())throw new Error("Already disposed");this.Va.dispose()}isDisposed(){return null!==this.Va&&this.Va.isDisposed()}modelStore(){return this.Va.modelStore()}identityStore(){return this.Va.identityStore()}}var No=function(e,t,s,i){return new(s||(s=Promise))((function(n,r){function o(e){try{c(i.next(e))}catch(e){r(e)}}function a(e){try{c(i.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(o,a)}c((i=i.apply(e,t||[])).next())}))};class qo extends R{constructor(e,t,s){super(),this.F=v.logger("models.offline"),this.La=e=>{this.Fa(e.src)},this.$a=e=>{this.Fa(e.src)},this.Ve=e,this.Va=s,this.Ga=new Map,this.$r=new Map,this.Ja=new wn,this.Ba=t,this.Ha=!1,this.Wa=!1,this.za=0,this.Ve.messages().subscribe(e=>{const t=e.message;t.modelOfflineUpdated&&this.Ya(t.modelOfflineUpdated)})}static Qa(e,t){const s=vn(t.operation);return{sessionId:t.sessionId,modelId:e,sequenceNumber:t.seqNo,contextVersion:t.contextVersion,timestamp:t.timestamp,operation:s}}init(){return No(this,void 0,void 0,(function*(){this.F.debug("Initializing offline model manager");try{yield this.Ka(),this.Xa(!1),this.Ja.resolve()}catch(e){throw this.Ja.reject(e),e}}))}isOfflineEnabled(){return this.Va.isEnabled()}ready(){return this.Ja.promise()}setOnline(){return this.Ha=!0,this.Za()}setOffline(){this.Ha=!1,this.Wa&&this.ec()}modelOpened(e,t){const s={model:e,opsSinceSnapshot:t};this.$r.set(e.modelId(),s),this.Ga.has(e.modelId())||(this.Ga.set(e.modelId(),{subscribed:!1,available:!0,deleted:!1,uncommited:!e.isCommitted(),created:e.isLocal(),version:e.version(),permissions:e.permissions()}),this.tc(e.modelId())),e.on(Dn.Events.MODIFIED,this.$a),e.on(Dn.Events.COMMITTED,this.La)}modelClosed(e){this.$r.delete(e.modelId()),this.sc(e.modelId()).catch(e=>this.F.error("Error cleaning up model after close",e)),e.off(Dn.Events.MODIFIED,this.$a),e.off(Dn.Events.COMMITTED,this.La)}isModelSubscribed(e){return this.Ga.has(e)&&this.Ga.get(e).subscribed}getSubscribedModelIds(){return new Set(this.Ga.keys())}getModelsRequiringSync(){return this.Va.modelStore().getModelsRequiringSync()}subscribe(e){const t=e.filter(e=>!this.isModelSubscribed(e));return this.ic(t,[],!1)}unsubscribe(e){return No(this,void 0,void 0,(function*(){const t=e.filter(e=>this.isModelSubscribed(e));return this.ic([],t,!1)}))}setSubscriptions(e){const t=e.filter(e=>this.isModelSubscribed(e)),s=Array.from(this.nc()).filter(t=>!e.includes(t));return this.ic(t,s,!0)}getModelCreationData(e){return this.Va.modelStore().getModelCreationData(e)}modelCreated(e){return this.Va.modelStore().completeModelCreation(e).then(()=>{const t=this.Ga.get(e);return t&&(t.created=!1),this.sc(e)})}createOfflineModel(e){return this.Va.modelStore().initiateModelCreation(e).then(t=>{this.Ga.set(e.modelId,{subscribed:!1,available:!0,uncommited:!1,deleted:t.deleted,created:!0,version:0}),this.tc(e.modelId)})}getOfflineModelState(e){return this.Va.modelStore().getModelState(e)}claimValueIdPrefix(e){return this.Va.modelStore().claimValueIdPrefix(e)}getModelMetaData(e){return this.Va.modelStore().getModelMetaData(e)}getAllModelMetaData(){return this.Va.modelStore().getAllModelMetaData()}processLocalOperation(e,t){const s=qo.Qa(e,t),i=this.Ga.get(e);return i&&(i.uncommited=!0),this.Va.modelStore().processLocalOperation(s).then(()=>this.rc(e))}processOperationAck(e,t,s){const i=this.Ga.get(e),n=this.$r.get(e);return i&&n&&(i.uncommited=!n.model.isCommitted()),this.Va.modelStore().processOperationAck(e,t,s)}processServerOperationEvent(e,t,s){const i=vn(t.operation),n={modelId:e,sessionId:t.clientId,version:t.version,timestamp:t.timestamp,operation:i},r=s.map(t=>qo.Qa(e,t));return this.Va.modelStore().processServerOperation(n,r).then(()=>this.rc(e))}markModelForDeletion(e){return this.Va.modelStore().initiateModelDeletion(e).then(()=>this.sc(e))}modelDeleted(e){return this.Va.modelStore().completeModelDeletion(e).then(()=>this.sc(e))}storeOpenModelOffline(e){const t=this.oc(e),s=e.version(),i={modelId:e.modelId(),collection:e.collectionId(),valueIdPrefix:{prefix:e.Li(),increment:0},version:s,lastSequenceNumber:t.sequenceNumber,createdTime:e.createdTime(),modifiedTime:e.time(),local:e.isLocal(),permissions:e.permissions(),snapshot:t};return this.Va.modelStore().setModelState(i)}Za(){this.Xa(!1);const e=[];return this.Ga.forEach((t,s)=>{e.push({modelId:s,currentPermissions:t.permissions?t.permissions.toJSON():void 0,currentVersion:t.version?t.version:0})}),this.ac(e,[],!0)}Ka(){return No(this,void 0,void 0,(function*(){const e=yield this.Va.modelStore().getAllModelMetaData();for(const t of e){const e={version:t.details?t.details.version:0,permissions:t.details?Zi.fromJSON(t.details.permissions):void 0,available:t.available,subscribed:t.subscribed,created:t.created,deleted:t.deleted,uncommited:t.uncommitted};this.Ga.set(t.modelId,e),yield this.sc(t.modelId)}}))}ic(e,t,s,i=!1){return No(this,void 0,void 0,(function*(){if(s&&0!==t.length)return Promise.reject(new O("Unsubscribe must be empty when setting all subscriptions"));e.forEach(e=>this.cc(e)),e.forEach(e=>this.tc(e)),t.forEach(e=>this.hc(e));const n=t.filter(e=>this.uc(e));let r,o;n.forEach(e=>this.Ga.delete(e)),t.forEach(e=>this.tc(e)),this.Xa(!1),s?(r=[],this.Ga.forEach((e,t)=>{e.subscribed&&r.push(t)}),o=[]):(r=e,o=t);const a=r.map(e=>{if(this.$r.has(e)){const t=this.$r.get(e);return{modelId:e,version:t.model.version(),permissions:t.model.permissions().toJSON()}}return{modelId:e,version:0}}),c=this.Va.modelStore();return yield c.updateSubscriptions(e,t),yield c.deleteModels(n),i?void 0:this.ac(a,o,s)}))}cc(e){const t=this.Ga.get(e);if(t)t.subscribed=!0;else{const t={version:0,subscribed:!0,available:!1,created:!1,deleted:!1,uncommited:!1};this.Ga.set(e,t)}}hc(e){const t=this.Ga.get(e);t&&(t.subscribed=!1)}uc(e){const t=this.Ga.get(e);return!(void 0===t||t.subscribed||t.created||t.uncommited||t.deleted||this.$r.has(e))}ac(e,t,s){const i=s||e.length>0||t.length>0;if(this.Ha&&i){const i={modelOfflineSubscriptionChange:{subscribe:e,unsubscribe:t,all:s}};return this.Ve.request(i).then(()=>{})}return Promise.resolve()}Ya(e){const t=W(e.modelId);this.$r.has(t)||(H(e.deleted)?this.dc(t):H(e.permissionRevoked)?this.lc(t):e.initial?this.pc(t,e):e.updated&&this.fc(t,e))}fc(e,t){if(this.isModelSubscribed(e)){const{model:s,permissions:i}=t.updated,n=s?{version:B(s.version),createdTime:X(s.createdTime),modifiedTime:X(s.modifiedTime),data:rn(s.data)}:void 0,r=on(i),o={modelId:e,dataUpdate:n,permissionsUpdate:r};this.Va.modelStore().processOfflineModelUpdate(o).catch(e=>{this.vr("Could not update offline model after download.",e)}).then(()=>{const t=this.Ga.get(e);if(t&&t.available){n&&this.Ga.set(e,{version:B(s.version),permissions:r,available:!0,subscribed:!0,created:!1,uncommited:!1,deleted:!1});const t=r?Zi.fromJSON(r):null,i=n?n.version:null;this.ve(new ys(e,i,t))}})}}pc(e,t){if(this.isModelSubscribed(e)){const{collection:s,model:i,permissions:n,valueIdPrefix:r}=t.initial,o=on(n),a=B(i.version),c={modelId:e,collection:s,valueIdPrefix:{prefix:r,increment:0},version:a,lastSequenceNumber:0,createdTime:X(i.createdTime),modifiedTime:X(i.modifiedTime),local:!1,permissions:o,snapshot:{version:B(i.version),sequenceNumber:0,data:rn(i.data),serverOperations:[],localOperations:[]}};this.Va.modelStore().setModelState(c).catch(e=>this.vr("Could not store offline model after download.",e)).then(()=>{this.Ga.set(e,{version:a,permissions:o,available:!0,subscribed:!0,uncommited:!1,created:!1,deleted:!1}),this.ve(new vs(e,a,o)),this.tc(e),this.Xa(!0)})}}lc(e){this.ic([],[e],!1,!0).then(()=>this.sc(e)).then(()=>{const t=new Os(e);this.ve(t),this.tc(e),this.Xa(!1)}).catch(e=>this.vr("Could not delete offline model after permissions revoked.",e))}dc(e){this.ic([],[e],!1,!0).then(()=>this.sc(e)).then(()=>{const t=new bs(e);this.ve(t),this.tc(e),this.Xa(!1)}).catch(e=>this.vr("Could not delete offline model after permissions revoked.",e))}tc(e){const t=this.Ga.get(e),s=t?new ws(e,t.subscribed,t.available,!t.uncommited,t.created):new ws(e,!1,!1,!1,!1);this.ve(s)}rc(e){return No(this,void 0,void 0,(function*(){if(this.$r.has(e)){let{model:t,opsSinceSnapshot:s}=this.$r.get(e);if(s++,s>=this.Ba){const i=this.oc(t);yield this.Va.modelStore().snapshotModel(e,i.version,i.sequenceNumber,i.data).then(()=>{s=0}).catch(e=>this.F.error("Error snapshotting model",e))}this.$r.set(e,{model:t,opsSinceSnapshot:s})}}))}oc(e){const t=e.$n(),s=t.uncommittedOperations.map(t=>qo.Qa(e.modelId(),t));return{version:e.version(),sequenceNumber:t.lastSequenceNumber,data:t.data,localOperations:s,serverOperations:[]}}Xa(e){const t=this.mc(),s=t>0;this.za!==t&&this.gc(e,t),this.Ha&&(this.Wa&&!s?this.ec():!this.Wa&&s&&this.vc(t))}vc(e){this.Wa=!0,this.ve(new as(e))}ec(){this.Wa=!1,this.ve(new hs)}gc(e,t){const s=e?"download":"subscription_changed";this.ve(new cs(t,s)),this.za=t}mc(){let e=0;return this.Ga.forEach(t=>{t.available||e++}),e}nc(){const e=new Set;return this.Ga.forEach((t,s)=>{t.subscribed&&e.add(s)}),e}sc(e){return No(this,void 0,void 0,(function*(){this.uc(e)&&(yield this.Va.modelStore().deleteModels([e]),this.Ga.delete(e),this.tc(e))}))}Fa(e){if(!e.isLocal()){const t=this.Ga.get(e.modelId());t?(t.uncommited=!e.isCommitted(),this.tc(e.modelId())):this.F.warn(`Offline entry not found for open model (${e.modelId()}) handling commit state changed`)}}vr(e,t){this.ve(new In(this.Ve.session().domain(),e,t))}}var Uo=function(e,t,s,i){return new(s||(s=Promise))((function(n,r){function o(e){try{c(i.next(e))}catch(e){r(e)}}function a(e){try{c(i.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(o,a)}c((i=i.apply(e,t||[])).next())}))};class ko extends R{constructor(e,t){super(),this.F=v.logger("domain"),l.assertString(e,"url");const s=/^(https?|wss?):\/{2}(.+)\/(.+)\/(.+)/.exec(e.trim());if(!s||5!==s.length)throw new Error("Invalid url: "+e);this.es=s[3],this.Zt=s[4],this.Dt=new Ao(t||{}),this.rs=!1,this.yc=!1,this.Ve=new fe(e,this,this.Dt),this.Va=new Po,this.Is=new jo(this.Ve,this.Va),this.zr=new qo(this.Ve,this.Dt.offlineModelOperationSnapshotInterval,this.Va),this.pn=new Ir(this.Ve,this.Is,this.zr,this.Dt.modelDataUndefinedObjectValues,this.Dt.modelDataUndefinedArrayValues),this.wc=new F(this.Ve),this.bc=new Gr(this.Ve,this.Is),this.Oc=new Kr(this.Ve,this.Is,void 0),this.Rc=new Do(this.Ve,this.Is),this.Mc(),this.Dt.storageAdapter&&(this.F.debug("options.offline.storage is set, configuring offline storage"),this.Va.configure(this.Dt.storageAdapter))}static Ec(e){return void 0===e?()=>Promise.resolve(void 0):"function"==typeof e?e:()=>Promise.resolve(e)}url(){return this.Ve.url()}options(){return this.Dt.getOptions()}namespace(){return this.es}id(){return this.Zt}session(){return this.Ve.session()}models(){return this.pn}identity(){return this.wc}activities(){return this.bc}presence(){return this.Oc}chat(){return this.Rc}serverTime(){return this.Ve.request({serverTimeRequest:{}}).then(e=>{const{serverTime:t}=e.serverTimeResponse;return X(t)})}dispose(){return this.rs=!0,void 0!==this.pn&&this.pn.ds(),this.Ve.isConnected()?this.Ve.disconnect():Promise.resolve()}isDisposed(){return this.rs}connectWithPassword(e){const t=ko.Ec(e);return this.Ve.connectWithPassword(t).then(()=>this.Sc(this.Ve.session().user().username))}connectAnonymously(e){const t=ko.Ec(e);return this.Ve.connectAnonymously(t).then(()=>this.Sc(this.Ve.session().user().username))}connectWithJwt(e){const t=ko.Ec(e);return this.Ve.connectWithJwt(t).then(()=>this.Sc(this.Ve.session().user().username))}reconnect(e){if(e=e||this.Ve.session().reconnectToken(),o.isSet(e)){const t=ko.Ec(e);return this.Ve.connectWithReconnectToken(t).then(()=>this.Sc(this.Ve.session().user().username))}return Promise.reject(new Error("No reconnect token was provided, and there is not one in memory"))}initializeOffline(e){const t=ko.Ec(e);if(o.isNotSet(e))throw new Error("An username must be provided to initialize the domain offline.");if(o.isNotSet(this.Dt.storageAdapter))throw new Error("'options.offline.storage' must be set to initialize the domain offline.");return t().then(e=>this.Sc(e))}disconnect(){return this.Ve.isDisconnected()?Promise.resolve():this.Ve.disconnect()}isDisconnected(){return this.Ve.isDisconnected()}isConnected(){return this.Ve.isConnected()}Cr(e){this.ve(e)}Cc(e){return this.Ve.connectWithJwt(e).then(()=>{})}Ic(e){return this.Ve.connectWithReconnectToken(e).then(()=>{})}_c(e){return this.Ve.connectAnonymously(e).then(()=>{})}Mc(){this.Ve.on(fe.Events.CONNECTION_SCHEDULED,e=>this.ve(new Rn(this,e.delay))),this.Ve.on(fe.Events.CONNECTING,()=>this.ve(new Mn(this))),this.Ve.on(fe.Events.AUTHENTICATING,e=>this.ve(new En(this,e.method))),this.Ve.on(fe.Events.CONNECTED,e=>{this.ve(new bn(this)),this.xc(e)}),this.Ve.on(fe.Events.CONNECTION_FAILED,e=>{this.ve(new On(this,e.code,e.authMethod,e.details))}),this.Ve.on(fe.Events.INTERRUPTED,()=>{this.ve(new Cn(this))}),this.Ve.on(fe.Events.DISCONNECTED,()=>{this.ve(new Sn(this))}),this.Ve.on(fe.Events.ERROR,e=>this.ve(new In(this,e.error.message)))}Sc(e){return this.yc?Promise.resolve():(this.F.debug("Initializing domain"),this.Dt.storageAdapter?(this.F.debug("options.offline.storage is set, opening offline storage"),this.Va.openStore(this.es,this.Zt,e).then(()=>Uo(this,void 0,void 0,(function*(){this.yc=!0,yield this.zr.init(),yield this.Is.init()})))):(this.yc=!0,Promise.resolve()))}xc(e){const t=h(Y(e.state),ee);this.Oc._a(G.objectToMap(t))}}ko.Events={CONNECTION_SCHEDULED:Rn.NAME,CONNECTING:Mn.NAME,AUTHENTICATING:En.NAME,CONNECTED:bn.NAME,CONNECTION_FAILED:On.NAME,INTERRUPTED:Cn.NAME,DISCONNECTED:Sn.NAME,ERROR:In.NAME},Object.freeze(ko.Events);class Vo{static connect(e,t,s,i,n){return Vo.connectWithPassword(e,{username:t,password:s},i,n)}static connectWithPassword(e,t,s,i){const n=Vo.Dc(e,s,i);return n.connectWithPassword(t).then(()=>n)}static connectAnonymously(e,t,s,i){const n=Vo.Dc(e,s,i);return n.connectAnonymously(t).then(()=>n)}static connectWithJwt(e,t,s,i){const n=Vo.Dc(e,s,i);return n.connectWithJwt(t).then(()=>n)}static reconnect(e,t,s,i){const n=Vo.Dc(e,s,i);return n.reconnect(t).then(()=>n)}static configureLogging(e){v.configure(e)}static Dc(e,t,s){const i=new ko(e,t);return"object"==typeof s&&s.Oe(()=>i.dispose()),i}}const Lo=Vo.connect,Fo=Vo.connectWithPassword,$o=Vo.connectAnonymously,Go=Vo.connectWithJwt,Jo=Vo.reconnect,Bo=Vo.configureLogging;function Ho(e){return new Promise((t,s)=>{e.onsuccess=()=>{t(e.result)},e.onerror=()=>{s(e.error)}})}function Wo(e){return Ho(e).then(()=>{})}function zo(e){return new Promise((t,s)=>{e.oncomplete=()=>{t()},e.onerror=()=>{s(e.error)},e.onabort=()=>{s(e.error)}})}class Yo{constructor(e){this.Tc=e}static deleteFromIndex(e,t,s){return this.jc(e,t,e=>{e.delete()},s)}static Ac(e,t,s){const i=[],n=e.openCursor(t,s);return Yo.Pc(n,e=>i.push(e.value)).then(()=>i)}static jc(e,t,s,i,n){let r;if(null===t)r=e.openCursor(i,n);else{r=e.index(t).openCursor(i,n)}return Yo.Pc(r,s)}static Pc(e,t){return new Promise((s,i)=>{e.onsuccess=e=>{const i=e.target.result;i?(t(i),i.continue()):s()},e.onerror=()=>{i(e.error)}})}Nc(e,t){return this.qc([e],"readwrite",e=>t(e[0]))}Uc(e,t){return this.qc([e],"readonly",e=>t(e[0]))}kc(e,t){return this.qc(e,"readwrite",t)}Vc(e,t){return this.qc(e,"readonly",t)}qc(e,t,s){const i=this.Tc.transaction(e,t),n=s(e.map(e=>i.objectStore(e))).catch(e=>(i.abort(),Promise.reject(e)));return Promise.all([n,zo(i)]).then(([e,t])=>e)}put(e,t){return this.Nc(e,e=>Wo(e.put(t)))}add(e,t){return this.Nc(e,e=>Wo(e.add(t)))}Lc(e,t){const s=[];return this.Fc(e,null,e=>{s.push(e)},t).then(()=>s)}$c(e,t,s){const i=[];return this.Fc(e,t,e=>{i.push(e)},s).then(()=>i)}Fc(e,t,s,i,n){const r=e=>{s(e.value)};return this.Uc(e,e=>Yo.jc(e,t,r,i,n))}Gc(e,t,s,i){return this.Jc(e,t,e=>{e.delete()},s,i)}Jc(e,t,s,i,n){return this.Nc(e,e=>Yo.jc(e,t,s,i,n))}}const Qo={Store:"ModelCreation",Fields:{ModelId:"modelId"},Indices:{ModelId:"ModelCreation.modelId"}},Ko={Store:"ModelMetaData",Fields:{ModelId:"modelId",Subscribed:"subscribed",Created:"created",Deleted:"deleted",SyncRequired:"syncRequired",Uncommitted:"uncommitted"},Indices:{ModelId:"ModelMetaData.modelId",Created:"ModelMetaData.created",Deleted:"ModelMetaData.deleted",Uncommitted:"ModelMetaData.uncommitted",SyncRequired:"ModelMetaData.syncRequired",Subscribed:"ModelMetaData.subscribed"}},Xo={Store:"ModelData",Fields:{ModelId:"modelId"},Indices:{ModelId:"ModelData.modelId"}},Zo={Store:"ModelServerOperation",Fields:{ModelId:"modelId",Version:"version"},Indices:{ModelId:"ModelServerOperation.modelId",ModelId_Version:"ModelServerOperation.modelId_version"}},ea={Store:"ModelLocalOperation",Fields:{ModelId:"modelId",SequenceNumber:"sequenceNumber"},Indices:{ModelId:"ModelLocalOperation.modelId",ModelId_SequenceNumber:"ModelLocalOperation.modelId_sequenceNumber"}},ta={Store:"DomainUser",Fields:{Username:"username",UserType:"userType"},Indices:{UserType_Username:"DomainUser.userType_username"}},sa={Store:"Session",Fields:{SessionId:"sessionId",Username:"username",UserType:"userType"},Indices:{UserType_Username:"DomainUser.userType_username",SessionId:"Session.sessionId"}};var ia=function(e,t,s,i){return new(s||(s=Promise))((function(n,r){function o(e){try{c(i.next(e))}catch(e){r(e)}}function a(e){try{c(i.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(o,a)}c((i=i.apply(e,t||[])).next())}))};class na extends Yo{static Bc(e,t){return Yo.deleteFromIndex(e,Zo.Indices.ModelId,IDBKeyRange.only(t))}static Hc(e,t){return Yo.deleteFromIndex(e,ea.Indices.ModelId,IDBKeyRange.only(t))}static Wc(e,t){return ia(this,void 0,void 0,(function*(){for(const s of t)yield Wo(e.add(s))}))}static zc(e,t){return ia(this,void 0,void 0,(function*(){for(const s of t)yield Wo(e.add(s))}))}static Yc(e){const t={modelId:e.modelId,subscribed:1===e.subscribed,available:1===e.available,deleted:1===e.deleted,created:1===e.created,uncommitted:1===e.uncommitted,syncRequired:1===e.syncRequired};return e.details&&(t.details={collection:e.details.collection,valueIdPrefix:e.details.valueIdPrefix,version:e.details.version,lastSequenceNumber:e.details.lastSequenceNumber,createdTime:e.details.createdTime,modifiedTime:e.details.modifiedTime,permissions:new Zi(e.details.permissions.read,e.details.permissions.write,e.details.permissions.remove,e.details.permissions.manage),snapshotVersion:e.details.snapshotVersion,snapshotSequenceNumber:e.details.snapshotSequenceNumber}),t}static Qc(e,t,s,i,n){return ia(this,void 0,void 0,(function*(){const r=yield Ho(t.get(e.modelId)),o={prefix:e.valueIdPrefix.prefix,increment:e.valueIdPrefix.increment||0},a={modelId:e.modelId,available:1,details:{collection:e.collection,valueIdPrefix:o,createdTime:e.createdTime,modifiedTime:e.modifiedTime,permissions:{read:e.permissions.read,write:e.permissions.write,remove:e.permissions.remove,manage:e.permissions.manage},lastSequenceNumber:e.lastSequenceNumber,version:e.version,snapshotVersion:e.snapshot.version,snapshotSequenceNumber:e.snapshot.sequenceNumber}};e.local&&(a.created=1),a.available=1,e.snapshot.localOperations.length>0?a.uncommitted=1:delete a.uncommitted,r&&(a.subscribed=r.subscribed,a.deleted=r.deleted),na.Kc(a),yield Wo(t.put(a));const c={modelId:e.modelId,data:e.snapshot.data};return yield Wo(s.put(c)),yield na.Bc(n,a.modelId),yield na.Hc(i,a.modelId),yield na.Wc(i,e.snapshot.localOperations),yield na.zc(n,e.snapshot.serverOperations),na.Yc(a)}))}static Xc(e,t){return ia(this,void 0,void 0,(function*(){for(const s of e){const e=yield Ho(t.get(s));e&&(delete e.subscribed,na.Kc(e),yield t.put(e))}}))}static Zc(e,t,s,i,n,r){return ia(this,void 0,void 0,(function*(){yield t.delete(e),yield s.delete(e),yield i.delete(e),yield na.Bc(r,e),yield na.Hc(n,e)}))}static eh(e,t){return ia(this,void 0,void 0,(function*(){for(const s of e){const e=yield Ho(t.get(s));let i;void 0!==e?(i=e,i.subscribed=1):i={modelId:s,subscribed:1},yield Wo(t.put(i))}}))}static Kc(e){1===e.deleted||1===e.created||1===e.uncommitted?e.syncRequired=1:delete e.syncRequired}initiateModelCreation(e){const t=[Qo.Store,Ko.Store,Xo.Store,ea.Store,Zo.Store];return this.kc(t,([t,s,i,n,r])=>ia(this,void 0,void 0,(function*(){const a=e.modelId,c=yield Ho(s.get(a));if(o.isSet(c)&&c.available)return Promise.reject(new O("An offline model with the specified id already exists: "+a));yield Wo(t.put(e));const h=new Zi(!0,!0,!0,!0),u={modelId:a,collection:e.collection,valueIdPrefix:{prefix:e.valueIdPrefix,increment:0},version:1,lastSequenceNumber:0,createdTime:e.createdTime,modifiedTime:e.createdTime,permissions:h,local:!0,snapshot:{version:1,sequenceNumber:0,data:e.initialData,localOperations:[],serverOperations:[]}};return na.Qc(u,s,i,n,r)})))}getModelCreationData(e){return this.Uc(Qo.Store,t=>ia(this,void 0,void 0,(function*(){return Ho(t.get(e)).then(e=>e||null)})))}completeModelCreation(e){const t=[Qo.Store,Ko.Store];return this.kc(t,([t,s])=>ia(this,void 0,void 0,(function*(){if(!(yield Ho(t.get(e))))throw new O("Can't complete model creation for a model that was created.");yield Wo(t.delete(e));const i=yield Ho(s.get(e));i.available=1,delete i.created,na.Kc(i),yield Wo(s.put(i))})))}initiateModelDeletion(e){const t=[Qo.Store,Ko.Store,Xo.Store,ea.Store,Zo.Store];return this.kc(t,([t,s,i,n,r])=>ia(this,void 0,void 0,(function*(){const o=yield Ho(s.get(e));if(!o)throw new O(`Can't delete model '${e}' because it doesn't exist.`);delete o.details,delete o.subscribed,delete o.available,delete o.uncommitted,1===o.created?delete o.created:o.deleted=1,na.Kc(o),yield Wo(s.put(o)),yield Wo(t.delete(e)),yield na.Hc(n,e),yield na.Bc(r,e),yield Wo(i.delete(e))})))}completeModelDeletion(e){const t=[Ko.Store];return this.kc(t,([t])=>ia(this,void 0,void 0,(function*(){const s=yield Ho(t.get(e));s&&(delete s.deleted,na.Kc(s),yield Wo(t.put(s)))})))}deleteModels(e){const t=[Qo.Store,Ko.Store,Xo.Store,ea.Store,Zo.Store];return this.kc(t,([t,s,i,n,r])=>ia(this,void 0,void 0,(function*(){for(let o of e)yield na.Zc(o,t,s,i,n,r)})))}modelMetaDataExists(e){if(null==e)throw new O("modelId must be defined");return this.Uc(Ko.Store,t=>Ho(t.index(Ko.Indices.ModelId).count(e)).then(e=>e>0))}getModelMetaData(e){return this.Uc(Ko.Store,t=>ia(this,void 0,void 0,(function*(){const s=yield Ho(t.get(e));return s?na.Yc(s):null})))}getAllModelMetaData(){return this.Lc(Ko.Store).then(e=>e.map(na.Yc))}getModelsRequiringSync(){return this.$c(Ko.Store,Ko.Indices.SyncRequired).then(e=>e.map(na.Yc))}getSubscribedModels(){const e=Ko.Store;return this.Uc(e,e=>ia(this,void 0,void 0,(function*(){const t=e.index(Ko.Indices.Subscribed);return(yield Yo.Ac(t)).map(na.Yc)})))}updateSubscriptions(e,t){const s=[Ko.Store];return this.kc(s,([s])=>ia(this,void 0,void 0,(function*(){yield na.Xc(t,s),yield na.eh(e,s)})))}setModelState(e){const t=[Ko.Store,Xo.Store,ea.Store,Zo.Store];return this.kc(t,([t,s,i,n])=>ia(this,void 0,void 0,(function*(){yield na.Qc(e,t,s,i,n)})))}getModelState(e){if(null==e)return Promise.reject(new O("modelId must be defined"));const t=[Ko.Store,Xo.Store,ea.Store,Zo.Store];return this.Vc(t,([t,s,i,n])=>ia(this,void 0,void 0,(function*(){const r=yield Ho(t.get(e)),o=yield Ho(s.get(e));if(r&&o){const t=i.index(ea.Indices.ModelId),s=yield Yo.Ac(t,e),a=n.index(Zo.Indices.ModelId),c=yield Yo.Ac(a,e),h={version:r.details.snapshotVersion,sequenceNumber:r.details.snapshotSequenceNumber,data:o.data,localOperations:s,serverOperations:c},u=r.details.version,d=r.details.lastSequenceNumber;return{modelId:r.modelId,collection:r.details.collection,createdTime:r.details.createdTime,modifiedTime:r.details.modifiedTime,version:u,lastSequenceNumber:d,valueIdPrefix:Object.assign({},r.details.valueIdPrefix),permissions:new Zi(r.details.permissions.read,r.details.permissions.write,r.details.permissions.remove,r.details.permissions.manage),local:1===r.created,snapshot:h}}return null})))}processOfflineModelUpdate(e){const t=[Ko.Store,Xo.Store,Zo.Store];return this.kc(t,([t,s,i])=>ia(this,void 0,void 0,(function*(){const{modelId:n,dataUpdate:r,permissionsUpdate:o}=e,a=yield Ho(t.get(n));if(void 0!==a){if(a.uncommitted)throw new O(`A model update was received for an model ('${n}')with uncommitted operations.`);if(yield na.Bc(i,n),r){a.details.version=r.version,a.details.createdTime=r.createdTime,a.details.modifiedTime=r.modifiedTime,a.details.snapshotSequenceNumber=a.details.lastSequenceNumber,a.details.snapshotVersion=r.version;const e={modelId:n,data:r.data};yield Wo(s.put(e))}return o&&(a.details.permissions=o),Wo(t.put(a))}})))}processServerOperation(e,t){if(!e)return Promise.reject(new O("serverOp was undefined."));if(!Array.isArray(t))return Promise.reject(new O("localOps was not an array."));if(!t.every(t=>t.modelId===e.modelId))return Promise.reject(new O("localOp modelId did not match the serverOp modelId."));const s=[Ko.Store,Zo.Store,ea.Store];return this.kc(s,([s,i,n])=>ia(this,void 0,void 0,(function*(){const r=yield Ho(s.get(e.modelId));if(!r)throw new O(`Model meta data for model '${e.modelId}' not found when processing a server operation.`);if(!r.details)throw new O(`Can't store server operation for Model '${e.modelId}' because the model details are missing from storage.`);r.details.version=e.version+1,r.details.modifiedTime=e.timestamp,yield Wo(i.add(e)),yield na.Hc(n,e.modelId),yield na.Wc(n,t),yield Wo(s.put(r))})))}processLocalOperation(e){if(!e)return Promise.reject(new O("localOp is required."));const t=[Ko.Store,ea.Store];return this.kc(t,([t,s])=>ia(this,void 0,void 0,(function*(){const i=yield Ho(t.get(e.modelId));if(!i)throw new O(`Model meta data not found for '${e.modelId}' while processing local operation.`);if(!i.details)throw new O(`Model details not found for '${e.modelId}' while processing local operation.`);i.uncommitted=1,i.details.lastSequenceNumber=e.sequenceNumber,na.Kc(i),yield Wo(s.add(e)),yield Wo(t.put(i))})))}processOperationAck(e,t,s){const i=[ea.Store,Zo.Store,Ko.Store];return this.kc(i,([i,n,r])=>ia(this,void 0,void 0,(function*(){const o=yield Ho(r.get(e));if(!o)throw new O(`Model meta data not found for '${e}' while processing operation acknowledgement.`);if(!o.details)throw new O(`Model details not found for '${e}' while processing operation acknowledgement.`);o.details.version=s.version+1,o.details.modifiedTime=s.timestamp,yield Wo(i.delete([e,t])),yield Wo(n.add(s));const a=i.index(ea.Indices.ModelId);(yield Ho(a.count(e)).then(e=>e>0))?o.uncommitted=1:delete o.uncommitted,na.Kc(o),yield Wo(r.put(o))})))}snapshotModel(e,t,s,i){if(!i)return Promise.reject(new O("modelData must be defined"));const n=[Ko.Store,Xo.Store,Zo.Store];return this.kc(n,([n,r,o])=>ia(this,void 0,void 0,(function*(){const a=yield Ho(n.get(e));if(!a)throw new O(`Model meta data not found for '${e}' while snapshotting model.`);if(!a.available)throw new O(`Model '${e}' is not available locally.`);a.details.snapshotVersion=t,a.details.snapshotSequenceNumber=s,yield Wo(n.put(a));const c={modelId:e,data:i};yield Wo(r.put(c)),yield na.Bc(o,e)})))}claimValueIdPrefix(e){return this.Nc(Ko.Store,t=>ia(this,void 0,void 0,(function*(){const s=yield Ho(t.get(e));if(!s||!s.details)throw new O("The specified model is not available offline: "+e);const i=Object.assign({},s.details.valueIdPrefix);return s.details.valueIdPrefix.increment=s.details.valueIdPrefix.increment+1,yield Wo(t.put(s)),i})))}}var ra=function(e,t,s,i){return new(s||(s=Promise))((function(n,r){function o(e){try{c(i.next(e))}catch(e){r(e)}}function a(e){try{c(i.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(o,a)}c((i=i.apply(e,t||[])).next())}))};class oa extends Yo{putUser(e){const t=ta.Store;return this.Nc(t,t=>ra(this,void 0,void 0,(function*(){const s={userType:e.userId.userType,username:e.userId.username,displayName:e.displayName,firstName:e.firstName,lastName:e.lastName,email:e.email};yield Wo(t.put(s))})))}getUsers(){return ra(this,void 0,void 0,(function*(){const e=ta.Store;return(yield this.Lc(e)).map(e=>new q(e.userType,e.username,e.firstName,e.lastName,e.displayName,e.email))}))}putSession(e,t){const s=sa.Store;return this.Nc(s,s=>ra(this,void 0,void 0,(function*(){const i={sessionId:e,userType:t.userType,username:t.username};yield Wo(s.put(i))})))}getSessions(){return ra(this,void 0,void 0,(function*(){const e=sa.Store,t=yield this.Lc(e),s=new Map;return t.forEach(e=>{s.set(e.sessionId,new N(e.userType,e.username))}),s}))}}class aa{constructor(){this.Tc=null,this.rs=!1}adapterId(){return"Indexed DB Storage"}initialize(e,t,s){if(!e)throw new Error("namespace must be a non-empty string");if(!t)throw new Error("domain must be a non-empty string");if(!s)throw new Error("username must be a non-empty string");const i=`${aa.th}:${e}/${t}/${s}`,n=indexedDB.open(i,aa.sh);let r=!0;return n.onupgradeneeded=()=>{const e=n.result,t=n.result.version;r=1===t,class{static upgrade(e,t){switch(t){case 1:(class{static upgrade(e){e.createObjectStore(Qo.Store,{keyPath:Qo.Fields.ModelId}).createIndex(Qo.Indices.ModelId,Qo.Fields.ModelId,{unique:!0});const t=e.createObjectStore(Ko.Store,{keyPath:Ko.Fields.ModelId});t.createIndex(Ko.Indices.ModelId,Ko.Fields.ModelId,{unique:!0}),t.createIndex(Ko.Indices.Created,Ko.Fields.Created,{unique:!1}),t.createIndex(Ko.Indices.Deleted,Ko.Fields.Deleted,{unique:!1}),t.createIndex(Ko.Indices.Uncommitted,Ko.Fields.Uncommitted,{unique:!1}),t.createIndex(Ko.Indices.SyncRequired,Ko.Fields.SyncRequired,{unique:!1}),t.createIndex(Ko.Indices.Subscribed,Ko.Fields.Subscribed,{unique:!1});e.createObjectStore(Xo.Store,{keyPath:Xo.Fields.ModelId}).createIndex(Xo.Indices.ModelId,Xo.Fields.ModelId,{unique:!0});const s=e.createObjectStore(Zo.Store,{keyPath:[Zo.Fields.ModelId,Zo.Fields.Version]});s.createIndex(Zo.Indices.ModelId,Zo.Fields.ModelId,{unique:!1}),s.createIndex(Zo.Indices.ModelId_Version,[Zo.Fields.ModelId,Zo.Fields.Version],{unique:!0});const i=e.createObjectStore(ea.Store,{keyPath:[ea.Fields.ModelId,ea.Fields.SequenceNumber]});i.createIndex(ea.Indices.ModelId,ea.Fields.ModelId,{unique:!1}),i.createIndex(ea.Indices.ModelId_SequenceNumber,[ea.Fields.ModelId,ea.Fields.SequenceNumber],{unique:!0});e.createObjectStore(ta.Store,{keyPath:[ta.Fields.UserType,ta.Fields.Username]}).createIndex(ta.Indices.UserType_Username,[ta.Fields.UserType,ta.Fields.Username],{unique:!0});const n=e.createObjectStore(sa.Store,{keyPath:[sa.Fields.SessionId]});n.createIndex(sa.Indices.UserType_Username,[sa.Fields.UserType,sa.Fields.Username],{unique:!1}),n.createIndex(sa.Indices.SessionId,[sa.Fields.SessionId],{unique:!0})}}).upgrade(e)}}}.upgrade(e,t)},Ho(n).then(e=>{this.Tc=e,this.ih=new na(this.Tc),this.nh=new oa(this.Tc)})}isInitialized(){return null!==this.Tc}modelStore(){return this.ih}identityStore(){return this.nh}destroy(){const e=this.Tc.name;this.dispose(),indexedDB.deleteDatabase(e)}dispose(){if(!this.isInitialized())throw new Error("Can not disposed a storage adapter that is not initialized");if(this.isDisposed())throw new Error("Already disposed");this.Tc.close(),this.Tc=null,this.rs=!0}isDisposed(){return this.rs}}aa.th="convergence.offline.storage",aa.sh=1;t.default=Vo}]);
//# sourceMappingURL=convergence.global.min.js.map